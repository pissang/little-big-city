!function(t){var e={};function r(n){if(e[n])return e[n].exports;var i=e[n]={i:n,l:!1,exports:{}};return t[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}r.m=t,r.c=e,r.d=function(t,e,n){r.o(t,e)||Object.defineProperty(t,e,{configurable:!1,enumerable:!0,get:n})},r.r=function(t){Object.defineProperty(t,"__esModule",{value:!0})},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=68)}([function(t,e,r){"use strict";(function(t){var n,i=r(67),o={supportWebGL:function(){if(null==n)try{var t=document.createElement("canvas");if(!(t.getContext("webgl")||t.getContext("experimental-webgl")))throw new Error}catch(t){n=!1}return n}};o.Int8Array="undefined"==typeof Int8Array?Array:Int8Array,o.Uint8Array="undefined"==typeof Uint8Array?Array:Uint8Array,o.Uint16Array="undefined"==typeof Uint16Array?Array:Uint16Array,o.Uint32Array="undefined"==typeof Uint32Array?Array:Uint32Array,o.Int16Array="undefined"==typeof Int16Array?Array:Int16Array,o.Float32Array="undefined"==typeof Float32Array?Array:Float32Array,o.Float64Array="undefined"==typeof Float64Array?Array:Float64Array;var a={};"undefined"!=typeof window?a=window:void 0!==t&&(a=t),o.requestAnimationFrame=a.requestAnimationFrame||a.msRequestAnimationFrame||a.mozRequestAnimationFrame||a.webkitRequestAnimationFrame||function(t){setTimeout(t,16)},o.createCanvas=function(){return document.createElement("canvas")},o.createImage=function(){return new a.Image},o.request={get:i.a.get},o.addEventListener=function(t,e,r,n){t.addEventListener(e,r,n)},o.removeEventListener=function(t,e,r){t.removeEventListener(e,r)},e.a=o}).call(this,r(3))},function(t,e,r){"use strict";var n=r(5),i=r(49),o=r(14),a=r(106),s=r(10);function h(t){return t}function u(t,e){for(var r=0;r<t.length;++r)e[r]=255&t.charCodeAt(r);return e}e.newBlob=function(t,r){e.checkSupport("blob");try{return new Blob([t],{type:r})}catch(e){try{var n=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);return n.append(t),n.getBlob(r)}catch(t){throw new Error("Bug : can't construct the Blob.")}}};var l={stringifyByChunk:function(t,e,r){var n=[],i=0,o=t.length;if(o<=r)return String.fromCharCode.apply(null,t);for(;i<o;)"array"===e||"nodebuffer"===e?n.push(String.fromCharCode.apply(null,t.slice(i,Math.min(i+r,o)))):n.push(String.fromCharCode.apply(null,t.subarray(i,Math.min(i+r,o)))),i+=r;return n.join("")},stringifyByChar:function(t){for(var e="",r=0;r<t.length;r++)e+=String.fromCharCode(t[r]);return e},applyCanBeUsed:{uint8array:function(){try{return n.uint8array&&1===String.fromCharCode.apply(null,new Uint8Array(1)).length}catch(t){return!1}}(),nodebuffer:function(){try{return n.nodebuffer&&1===String.fromCharCode.apply(null,o.allocBuffer(1)).length}catch(t){return!1}}()}};function c(t){var r=65536,n=e.getTypeOf(t),i=!0;if("uint8array"===n?i=l.applyCanBeUsed.uint8array:"nodebuffer"===n&&(i=l.applyCanBeUsed.nodebuffer),i)for(;r>1;)try{return l.stringifyByChunk(t,n,r)}catch(t){r=Math.floor(r/2)}return l.stringifyByChar(t)}function f(t,e){for(var r=0;r<t.length;r++)e[r]=t[r];return e}e.applyFromCharCode=c;var d={};d.string={string:h,array:function(t){return u(t,new Array(t.length))},arraybuffer:function(t){return d.string.uint8array(t).buffer},uint8array:function(t){return u(t,new Uint8Array(t.length))},nodebuffer:function(t){return u(t,o.allocBuffer(t.length))}},d.array={string:c,array:h,arraybuffer:function(t){return new Uint8Array(t).buffer},uint8array:function(t){return new Uint8Array(t)},nodebuffer:function(t){return o.newBufferFrom(t)}},d.arraybuffer={string:function(t){return c(new Uint8Array(t))},array:function(t){return f(new Uint8Array(t),new Array(t.byteLength))},arraybuffer:h,uint8array:function(t){return new Uint8Array(t)},nodebuffer:function(t){return o.newBufferFrom(new Uint8Array(t))}},d.uint8array={string:c,array:function(t){return f(t,new Array(t.length))},arraybuffer:function(t){return t.buffer},uint8array:h,nodebuffer:function(t){return o.newBufferFrom(t)}},d.nodebuffer={string:c,array:function(t){return f(t,new Array(t.length))},arraybuffer:function(t){return d.nodebuffer.uint8array(t).buffer},uint8array:function(t){return f(t,new Uint8Array(t.length))},nodebuffer:h},e.transformTo=function(t,r){if(r||(r=""),!t)return r;e.checkSupport(t);var n=e.getTypeOf(r);return d[n][t](r)},e.getTypeOf=function(t){return"string"==typeof t?"string":"[object Array]"===Object.prototype.toString.call(t)?"array":n.nodebuffer&&o.isBuffer(t)?"nodebuffer":n.uint8array&&t instanceof Uint8Array?"uint8array":n.arraybuffer&&t instanceof ArrayBuffer?"arraybuffer":void 0},e.checkSupport=function(t){if(!n[t.toLowerCase()])throw new Error(t+" is not supported by this platform")},e.MAX_VALUE_16BITS=65535,e.MAX_VALUE_32BITS=-1,e.pretty=function(t){var e,r,n="";for(r=0;r<(t||"").length;r++)n+="\\x"+((e=t.charCodeAt(r))<16?"0":"")+e.toString(16).toUpperCase();return n},e.delay=function(t,e,r){a(function(){t.apply(r||null,e||[])})},e.inherits=function(t,e){var r=function(){};r.prototype=e.prototype,t.prototype=new r},e.extend=function(){var t,e,r={};for(t=0;t<arguments.length;t++)for(e in arguments[t])arguments[t].hasOwnProperty(e)&&void 0===r[e]&&(r[e]=arguments[t][e]);return r},e.prepareContent=function(t,r,o,a,h){return s.Promise.resolve(r).then(function(t){return n.blob&&(t instanceof Blob||-1!==["[object File]","[object Blob]"].indexOf(Object.prototype.toString.call(t)))&&"undefined"!=typeof FileReader?new s.Promise(function(e,r){var n=new FileReader;n.onload=function(t){e(t.target.result)},n.onerror=function(t){r(t.target.error)},n.readAsArrayBuffer(t)}):t}).then(function(r){var l,c=e.getTypeOf(r);return c?("arraybuffer"===c?r=e.transformTo("uint8array",r):"string"===c&&(h?r=i.decode(r):o&&!0!==a&&(r=u(l=r,n.uint8array?new Uint8Array(l.length):new Array(l.length)))),r):s.Promise.reject(new Error("Can't read the data of '"+t+"'. Is it in a supported JavaScript type (String, Blob, ArrayBuffer, etc) ?"))})}},function(t,e,r){"use strict";function n(t){this.name=t||"default",this.streamInfo={},this.generatedError=null,this.extraStreamInfo={},this.isPaused=!0,this.isFinished=!1,this.isLocked=!1,this._listeners={data:[],end:[],error:[]},this.previous=null}n.prototype={push:function(t){this.emit("data",t)},end:function(){if(this.isFinished)return!1;this.flush();try{this.emit("end"),this.cleanUp(),this.isFinished=!0}catch(t){this.emit("error",t)}return!0},error:function(t){return!this.isFinished&&(this.isPaused?this.generatedError=t:(this.isFinished=!0,this.emit("error",t),this.previous&&this.previous.error(t),this.cleanUp()),!0)},on:function(t,e){return this._listeners[t].push(e),this},cleanUp:function(){this.streamInfo=this.generatedError=this.extraStreamInfo=null,this._listeners=[]},emit:function(t,e){if(this._listeners[t])for(var r=0;r<this._listeners[t].length;r++)this._listeners[t][r].call(this,e)},pipe:function(t){return t.registerPrevious(this)},registerPrevious:function(t){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.streamInfo=t.streamInfo,this.mergeStreamInfo(),this.previous=t;var e=this;return t.on("data",function(t){e.processChunk(t)}),t.on("end",function(){e.end()}),t.on("error",function(t){e.error(t)}),this},pause:function(){return!this.isPaused&&!this.isFinished&&(this.isPaused=!0,this.previous&&this.previous.pause(),!0)},resume:function(){if(!this.isPaused||this.isFinished)return!1;this.isPaused=!1;var t=!1;return this.generatedError&&(this.error(this.generatedError),t=!0),this.previous&&this.previous.resume(),!t},flush:function(){},processChunk:function(t){this.push(t)},withStreamInfo:function(t,e){return this.extraStreamInfo[t]=e,this.mergeStreamInfo(),this},mergeStreamInfo:function(){for(var t in this.extraStreamInfo)this.extraStreamInfo.hasOwnProperty(t)&&(this.streamInfo[t]=this.extraStreamInfo[t])},lock:function(){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.isLocked=!0,this.previous&&this.previous.lock()},toString:function(){var t="Worker "+this.name;return this.previous?this.previous+" -> "+t:t}},t.exports=n},function(t,e){var r;r=function(){return this}();try{r=r||Function("return this")()||(0,eval)("this")}catch(t){"object"==typeof window&&(r=window)}t.exports=r},function(t,e,r){"use strict";var n="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Int32Array;function i(t,e){return Object.prototype.hasOwnProperty.call(t,e)}e.assign=function(t){for(var e=Array.prototype.slice.call(arguments,1);e.length;){var r=e.shift();if(r){if("object"!=typeof r)throw new TypeError(r+"must be non-object");for(var n in r)i(r,n)&&(t[n]=r[n])}}return t},e.shrinkBuf=function(t,e){return t.length===e?t:t.subarray?t.subarray(0,e):(t.length=e,t)};var o={arraySet:function(t,e,r,n,i){if(e.subarray&&t.subarray)t.set(e.subarray(r,r+n),i);else for(var o=0;o<n;o++)t[i+o]=e[r+o]},flattenChunks:function(t){var e,r,n,i,o,a;for(n=0,e=0,r=t.length;e<r;e++)n+=t[e].length;for(a=new Uint8Array(n),i=0,e=0,r=t.length;e<r;e++)o=t[e],a.set(o,i),i+=o.length;return a}},a={arraySet:function(t,e,r,n,i){for(var o=0;o<n;o++)t[i+o]=e[r+o]},flattenChunks:function(t){return[].concat.apply([],t)}};e.setTyped=function(t){t?(e.Buf8=Uint8Array,e.Buf16=Uint16Array,e.Buf32=Int32Array,e.assign(e,o)):(e.Buf8=Array,e.Buf16=Array,e.Buf32=Array,e.assign(e,a))},e.setTyped(n)},function(t,e,r){"use strict";(function(t){if(e.base64=!0,e.array=!0,e.string=!0,e.arraybuffer="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof Uint8Array,e.nodebuffer=void 0!==t,e.uint8array="undefined"!=typeof Uint8Array,"undefined"==typeof ArrayBuffer)e.blob=!1;else{var n=new ArrayBuffer(0);try{e.blob=0===new Blob([n],{type:"application/zip"}).size}catch(t){try{var i=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder);i.append(n),e.blob=0===i.getBlob("application/zip").size}catch(t){e.blob=!1}}}try{e.nodestream=!!r(56).Readable}catch(t){e.nodestream=!1}}).call(this,r(12).Buffer)},function(t,e){var r,n,i=t.exports={};function o(){throw new Error("setTimeout has not been defined")}function a(){throw new Error("clearTimeout has not been defined")}function s(t){if(r===setTimeout)return setTimeout(t,0);if((r===o||!r)&&setTimeout)return r=setTimeout,setTimeout(t,0);try{return r(t,0)}catch(e){try{return r.call(null,t,0)}catch(e){return r.call(this,t,0)}}}!function(){try{r="function"==typeof setTimeout?setTimeout:o}catch(t){r=o}try{n="function"==typeof clearTimeout?clearTimeout:a}catch(t){n=a}}();var h,u=[],l=!1,c=-1;function f(){l&&h&&(l=!1,h.length?u=h.concat(u):c=-1,u.length&&d())}function d(){if(!l){var t=s(f);l=!0;for(var e=u.length;e;){for(h=u,u=[];++c<e;)h&&h[c].run();c=-1,e=u.length}h=null,l=!1,function(t){if(n===clearTimeout)return clearTimeout(t);if((n===a||!n)&&clearTimeout)return n=clearTimeout,clearTimeout(t);try{n(t)}catch(e){try{return n.call(null,t)}catch(e){return n.call(this,t)}}}(t)}}function p(t,e){this.fun=t,this.array=e}function m(){}i.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)e[r-1]=arguments[r];u.push(new p(t,e)),1!==u.length||l||s(d)},p.prototype.run=function(){this.fun.apply(null,this.array)},i.title="browser",i.browser=!0,i.env={},i.argv=[],i.version="",i.versions={},i.on=m,i.addListener=m,i.once=m,i.off=m,i.removeListener=m,i.removeAllListeners=m,i.emit=m,i.prependListener=m,i.prependOnceListener=m,i.listeners=function(t){return[]},i.binding=function(t){throw new Error("process.binding is not supported")},i.cwd=function(){return"/"},i.chdir=function(t){throw new Error("process.chdir is not supported")},i.umask=function(){return 0}},function(t,e,r){"use strict";var n=r(16),i=Object.keys||function(t){var e=[];for(var r in t)e.push(r);return e};t.exports=c;var o=r(11);o.inherits=r(8);var a=r(55),s=r(23);o.inherits(c,a);for(var h=i(s.prototype),u=0;u<h.length;u++){var l=h[u];c.prototype[l]||(c.prototype[l]=s.prototype[l])}function c(t){if(!(this instanceof c))return new c(t);a.call(this,t),s.call(this,t),t&&!1===t.readable&&(this.readable=!1),t&&!1===t.writable&&(this.writable=!1),this.allowHalfOpen=!0,t&&!1===t.allowHalfOpen&&(this.allowHalfOpen=!1),this.once("end",f)}function f(){this.allowHalfOpen||this._writableState.ended||n.nextTick(d,this)}function d(t){t.end()}Object.defineProperty(c.prototype,"destroyed",{get:function(){return void 0!==this._readableState&&void 0!==this._writableState&&(this._readableState.destroyed&&this._writableState.destroyed)},set:function(t){void 0!==this._readableState&&void 0!==this._writableState&&(this._readableState.destroyed=t,this._writableState.destroyed=t)}}),c.prototype._destroy=function(t,e){this.push(null),this.end(),n.nextTick(e,t)}},function(t,e){"function"==typeof Object.create?t.exports=function(t,e){t.super_=e,t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}})}:t.exports=function(t,e){t.super_=e;var r=function(){};r.prototype=e.prototype,t.prototype=new r,t.prototype.constructor=t}},function(t,e,r){"use strict";for(var n=r(1),i=r(5),o=r(14),a=r(2),s=new Array(256),h=0;h<256;h++)s[h]=h>=252?6:h>=248?5:h>=240?4:h>=224?3:h>=192?2:1;s[254]=s[254]=1;function u(){a.call(this,"utf-8 decode"),this.leftOver=null}function l(){a.call(this,"utf-8 encode")}e.utf8encode=function(t){return i.nodebuffer?o.newBufferFrom(t,"utf-8"):function(t){var e,r,n,o,a,s=t.length,h=0;for(o=0;o<s;o++)55296==(64512&(r=t.charCodeAt(o)))&&o+1<s&&56320==(64512&(n=t.charCodeAt(o+1)))&&(r=65536+(r-55296<<10)+(n-56320),o++),h+=r<128?1:r<2048?2:r<65536?3:4;for(e=i.uint8array?new Uint8Array(h):new Array(h),a=0,o=0;a<h;o++)55296==(64512&(r=t.charCodeAt(o)))&&o+1<s&&56320==(64512&(n=t.charCodeAt(o+1)))&&(r=65536+(r-55296<<10)+(n-56320),o++),r<128?e[a++]=r:r<2048?(e[a++]=192|r>>>6,e[a++]=128|63&r):r<65536?(e[a++]=224|r>>>12,e[a++]=128|r>>>6&63,e[a++]=128|63&r):(e[a++]=240|r>>>18,e[a++]=128|r>>>12&63,e[a++]=128|r>>>6&63,e[a++]=128|63&r);return e}(t)},e.utf8decode=function(t){return i.nodebuffer?n.transformTo("nodebuffer",t).toString("utf-8"):function(t){var e,r,i,o,a=t.length,h=new Array(2*a);for(r=0,e=0;e<a;)if((i=t[e++])<128)h[r++]=i;else if((o=s[i])>4)h[r++]=65533,e+=o-1;else{for(i&=2===o?31:3===o?15:7;o>1&&e<a;)i=i<<6|63&t[e++],o--;o>1?h[r++]=65533:i<65536?h[r++]=i:(i-=65536,h[r++]=55296|i>>10&1023,h[r++]=56320|1023&i)}return h.length!==r&&(h.subarray?h=h.subarray(0,r):h.length=r),n.applyFromCharCode(h)}(t=n.transformTo(i.uint8array?"uint8array":"array",t))},n.inherits(u,a),u.prototype.processChunk=function(t){var r=n.transformTo(i.uint8array?"uint8array":"array",t.data);if(this.leftOver&&this.leftOver.length){if(i.uint8array){var o=r;(r=new Uint8Array(o.length+this.leftOver.length)).set(this.leftOver,0),r.set(o,this.leftOver.length)}else r=this.leftOver.concat(r);this.leftOver=null}var a=function(t,e){var r;for((e=e||t.length)>t.length&&(e=t.length),r=e-1;r>=0&&128==(192&t[r]);)r--;return r<0?e:0===r?e:r+s[t[r]]>e?r:e}(r),h=r;a!==r.length&&(i.uint8array?(h=r.subarray(0,a),this.leftOver=r.subarray(a,r.length)):(h=r.slice(0,a),this.leftOver=r.slice(a,r.length))),this.push({data:e.utf8decode(h),meta:t.meta})},u.prototype.flush=function(){this.leftOver&&this.leftOver.length&&(this.push({data:e.utf8decode(this.leftOver),meta:{}}),this.leftOver=null)},e.Utf8DecodeWorker=u,n.inherits(l,a),l.prototype.processChunk=function(t){this.push({data:e.utf8encode(t.data),meta:t.meta})},e.Utf8EncodeWorker=l},function(t,e,r){"use strict";var n=null;n="undefined"!=typeof Promise?Promise:r(92),t.exports={Promise:n}},function(t,e,r){(function(t){function r(t){return Object.prototype.toString.call(t)}e.isArray=function(t){return Array.isArray?Array.isArray(t):"[object Array]"===r(t)},e.isBoolean=function(t){return"boolean"==typeof t},e.isNull=function(t){return null===t},e.isNullOrUndefined=function(t){return null==t},e.isNumber=function(t){return"number"==typeof t},e.isString=function(t){return"string"==typeof t},e.isSymbol=function(t){return"symbol"==typeof t},e.isUndefined=function(t){return void 0===t},e.isRegExp=function(t){return"[object RegExp]"===r(t)},e.isObject=function(t){return"object"==typeof t&&null!==t},e.isDate=function(t){return"[object Date]"===r(t)},e.isError=function(t){return"[object Error]"===r(t)||t instanceof Error},e.isFunction=function(t){return"function"==typeof t},e.isPrimitive=function(t){return null===t||"boolean"==typeof t||"number"==typeof t||"string"==typeof t||"symbol"==typeof t||void 0===t},e.isBuffer=t.isBuffer}).call(this,r(12).Buffer)},function(t,e,r){"use strict";(function(t){
/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <feross@feross.org> <http://feross.org>
 * @license  MIT
 */
var n=r(119),i=r(118),o=r(57);function a(){return h.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function s(t,e){if(a()<e)throw new RangeError("Invalid typed array length");return h.TYPED_ARRAY_SUPPORT?(t=new Uint8Array(e)).__proto__=h.prototype:(null===t&&(t=new h(e)),t.length=e),t}function h(t,e,r){if(!(h.TYPED_ARRAY_SUPPORT||this instanceof h))return new h(t,e,r);if("number"==typeof t){if("string"==typeof e)throw new Error("If encoding is specified then the first argument must be a string");return c(this,t)}return u(this,t,e,r)}function u(t,e,r,n){if("number"==typeof e)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&e instanceof ArrayBuffer?function(t,e,r,n){if(e.byteLength,r<0||e.byteLength<r)throw new RangeError("'offset' is out of bounds");if(e.byteLength<r+(n||0))throw new RangeError("'length' is out of bounds");e=void 0===r&&void 0===n?new Uint8Array(e):void 0===n?new Uint8Array(e,r):new Uint8Array(e,r,n);h.TYPED_ARRAY_SUPPORT?(t=e).__proto__=h.prototype:t=f(t,e);return t}(t,e,r,n):"string"==typeof e?function(t,e,r){"string"==typeof r&&""!==r||(r="utf8");if(!h.isEncoding(r))throw new TypeError('"encoding" must be a valid string encoding');var n=0|p(e,r),i=(t=s(t,n)).write(e,r);i!==n&&(t=t.slice(0,i));return t}(t,e,r):function(t,e){if(h.isBuffer(e)){var r=0|d(e.length);return 0===(t=s(t,r)).length?t:(e.copy(t,0,0,r),t)}if(e){if("undefined"!=typeof ArrayBuffer&&e.buffer instanceof ArrayBuffer||"length"in e)return"number"!=typeof e.length||(n=e.length)!=n?s(t,0):f(t,e);if("Buffer"===e.type&&o(e.data))return f(t,e.data)}var n;throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(t,e)}function l(t){if("number"!=typeof t)throw new TypeError('"size" argument must be a number');if(t<0)throw new RangeError('"size" argument must not be negative')}function c(t,e){if(l(e),t=s(t,e<0?0:0|d(e)),!h.TYPED_ARRAY_SUPPORT)for(var r=0;r<e;++r)t[r]=0;return t}function f(t,e){var r=e.length<0?0:0|d(e.length);t=s(t,r);for(var n=0;n<r;n+=1)t[n]=255&e[n];return t}function d(t){if(t>=a())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+a().toString(16)+" bytes");return 0|t}function p(t,e){if(h.isBuffer(t))return t.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(t)||t instanceof ArrayBuffer))return t.byteLength;"string"!=typeof t&&(t=""+t);var r=t.length;if(0===r)return 0;for(var n=!1;;)switch(e){case"ascii":case"latin1":case"binary":return r;case"utf8":case"utf-8":case void 0:return U(t).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*r;case"hex":return r>>>1;case"base64":return H(t).length;default:if(n)return U(t).length;e=(""+e).toLowerCase(),n=!0}}function m(t,e,r){var n=t[e];t[e]=t[r],t[r]=n}function g(t,e,r,n,i){if(0===t.length)return-1;if("string"==typeof r?(n=r,r=0):r>2147483647?r=2147483647:r<-2147483648&&(r=-2147483648),r=+r,isNaN(r)&&(r=i?0:t.length-1),r<0&&(r=t.length+r),r>=t.length){if(i)return-1;r=t.length-1}else if(r<0){if(!i)return-1;r=0}if("string"==typeof e&&(e=h.from(e,n)),h.isBuffer(e))return 0===e.length?-1:_(t,e,r,n,i);if("number"==typeof e)return e&=255,h.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?i?Uint8Array.prototype.indexOf.call(t,e,r):Uint8Array.prototype.lastIndexOf.call(t,e,r):_(t,[e],r,n,i);throw new TypeError("val must be string, number or Buffer")}function _(t,e,r,n,i){var o,a=1,s=t.length,h=e.length;if(void 0!==n&&("ucs2"===(n=String(n).toLowerCase())||"ucs-2"===n||"utf16le"===n||"utf-16le"===n)){if(t.length<2||e.length<2)return-1;a=2,s/=2,h/=2,r/=2}function u(t,e){return 1===a?t[e]:t.readUInt16BE(e*a)}if(i){var l=-1;for(o=r;o<s;o++)if(u(t,o)===u(e,-1===l?0:o-l)){if(-1===l&&(l=o),o-l+1===h)return l*a}else-1!==l&&(o-=o-l),l=-1}else for(r+h>s&&(r=s-h),o=r;o>=0;o--){for(var c=!0,f=0;f<h;f++)if(u(t,o+f)!==u(e,f)){c=!1;break}if(c)return o}return-1}function y(t,e,r,n){r=Number(r)||0;var i=t.length-r;n?(n=Number(n))>i&&(n=i):n=i;var o=e.length;if(o%2!=0)throw new TypeError("Invalid hex string");n>o/2&&(n=o/2);for(var a=0;a<n;++a){var s=parseInt(e.substr(2*a,2),16);if(isNaN(s))return a;t[r+a]=s}return a}function v(t,e,r,n){return j(U(e,t.length-r),t,r,n)}function x(t,e,r,n){return j(function(t){for(var e=[],r=0;r<t.length;++r)e.push(255&t.charCodeAt(r));return e}(e),t,r,n)}function b(t,e,r,n){return x(t,e,r,n)}function w(t,e,r,n){return j(H(e),t,r,n)}function T(t,e,r,n){return j(function(t,e){for(var r,n,i,o=[],a=0;a<t.length&&!((e-=2)<0);++a)r=t.charCodeAt(a),n=r>>8,i=r%256,o.push(i),o.push(n);return o}(e,t.length-r),t,r,n)}function E(t,e,r){return 0===e&&r===t.length?n.fromByteArray(t):n.fromByteArray(t.slice(e,r))}function C(t,e,r){r=Math.min(t.length,r);for(var n=[],i=e;i<r;){var o,a,s,h,u=t[i],l=null,c=u>239?4:u>223?3:u>191?2:1;if(i+c<=r)switch(c){case 1:u<128&&(l=u);break;case 2:128==(192&(o=t[i+1]))&&(h=(31&u)<<6|63&o)>127&&(l=h);break;case 3:o=t[i+1],a=t[i+2],128==(192&o)&&128==(192&a)&&(h=(15&u)<<12|(63&o)<<6|63&a)>2047&&(h<55296||h>57343)&&(l=h);break;case 4:o=t[i+1],a=t[i+2],s=t[i+3],128==(192&o)&&128==(192&a)&&128==(192&s)&&(h=(15&u)<<18|(63&o)<<12|(63&a)<<6|63&s)>65535&&h<1114112&&(l=h)}null===l?(l=65533,c=1):l>65535&&(l-=65536,n.push(l>>>10&1023|55296),l=56320|1023&l),n.push(l),i+=c}return function(t){var e=t.length;if(e<=S)return String.fromCharCode.apply(String,t);var r="",n=0;for(;n<e;)r+=String.fromCharCode.apply(String,t.slice(n,n+=S));return r}(n)}e.Buffer=h,e.SlowBuffer=function(t){+t!=t&&(t=0);return h.alloc(+t)},e.INSPECT_MAX_BYTES=50,h.TYPED_ARRAY_SUPPORT=void 0!==t.TYPED_ARRAY_SUPPORT?t.TYPED_ARRAY_SUPPORT:function(){try{var t=new Uint8Array(1);return t.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===t.foo()&&"function"==typeof t.subarray&&0===t.subarray(1,1).byteLength}catch(t){return!1}}(),e.kMaxLength=a(),h.poolSize=8192,h._augment=function(t){return t.__proto__=h.prototype,t},h.from=function(t,e,r){return u(null,t,e,r)},h.TYPED_ARRAY_SUPPORT&&(h.prototype.__proto__=Uint8Array.prototype,h.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&h[Symbol.species]===h&&Object.defineProperty(h,Symbol.species,{value:null,configurable:!0})),h.alloc=function(t,e,r){return function(t,e,r,n){return l(e),e<=0?s(t,e):void 0!==r?"string"==typeof n?s(t,e).fill(r,n):s(t,e).fill(r):s(t,e)}(null,t,e,r)},h.allocUnsafe=function(t){return c(null,t)},h.allocUnsafeSlow=function(t){return c(null,t)},h.isBuffer=function(t){return!(null==t||!t._isBuffer)},h.compare=function(t,e){if(!h.isBuffer(t)||!h.isBuffer(e))throw new TypeError("Arguments must be Buffers");if(t===e)return 0;for(var r=t.length,n=e.length,i=0,o=Math.min(r,n);i<o;++i)if(t[i]!==e[i]){r=t[i],n=e[i];break}return r<n?-1:n<r?1:0},h.isEncoding=function(t){switch(String(t).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},h.concat=function(t,e){if(!o(t))throw new TypeError('"list" argument must be an Array of Buffers');if(0===t.length)return h.alloc(0);var r;if(void 0===e)for(e=0,r=0;r<t.length;++r)e+=t[r].length;var n=h.allocUnsafe(e),i=0;for(r=0;r<t.length;++r){var a=t[r];if(!h.isBuffer(a))throw new TypeError('"list" argument must be an Array of Buffers');a.copy(n,i),i+=a.length}return n},h.byteLength=p,h.prototype._isBuffer=!0,h.prototype.swap16=function(){var t=this.length;if(t%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var e=0;e<t;e+=2)m(this,e,e+1);return this},h.prototype.swap32=function(){var t=this.length;if(t%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var e=0;e<t;e+=4)m(this,e,e+3),m(this,e+1,e+2);return this},h.prototype.swap64=function(){var t=this.length;if(t%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var e=0;e<t;e+=8)m(this,e,e+7),m(this,e+1,e+6),m(this,e+2,e+5),m(this,e+3,e+4);return this},h.prototype.toString=function(){var t=0|this.length;return 0===t?"":0===arguments.length?C(this,0,t):function(t,e,r){var n=!1;if((void 0===e||e<0)&&(e=0),e>this.length)return"";if((void 0===r||r>this.length)&&(r=this.length),r<=0)return"";if((r>>>=0)<=(e>>>=0))return"";for(t||(t="utf8");;)switch(t){case"hex":return P(this,e,r);case"utf8":case"utf-8":return C(this,e,r);case"ascii":return A(this,e,r);case"latin1":case"binary":return M(this,e,r);case"base64":return E(this,e,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return R(this,e,r);default:if(n)throw new TypeError("Unknown encoding: "+t);t=(t+"").toLowerCase(),n=!0}}.apply(this,arguments)},h.prototype.equals=function(t){if(!h.isBuffer(t))throw new TypeError("Argument must be a Buffer");return this===t||0===h.compare(this,t)},h.prototype.inspect=function(){var t="",r=e.INSPECT_MAX_BYTES;return this.length>0&&(t=this.toString("hex",0,r).match(/.{2}/g).join(" "),this.length>r&&(t+=" ... ")),"<Buffer "+t+">"},h.prototype.compare=function(t,e,r,n,i){if(!h.isBuffer(t))throw new TypeError("Argument must be a Buffer");if(void 0===e&&(e=0),void 0===r&&(r=t?t.length:0),void 0===n&&(n=0),void 0===i&&(i=this.length),e<0||r>t.length||n<0||i>this.length)throw new RangeError("out of range index");if(n>=i&&e>=r)return 0;if(n>=i)return-1;if(e>=r)return 1;if(e>>>=0,r>>>=0,n>>>=0,i>>>=0,this===t)return 0;for(var o=i-n,a=r-e,s=Math.min(o,a),u=this.slice(n,i),l=t.slice(e,r),c=0;c<s;++c)if(u[c]!==l[c]){o=u[c],a=l[c];break}return o<a?-1:a<o?1:0},h.prototype.includes=function(t,e,r){return-1!==this.indexOf(t,e,r)},h.prototype.indexOf=function(t,e,r){return g(this,t,e,r,!0)},h.prototype.lastIndexOf=function(t,e,r){return g(this,t,e,r,!1)},h.prototype.write=function(t,e,r,n){if(void 0===e)n="utf8",r=this.length,e=0;else if(void 0===r&&"string"==typeof e)n=e,r=this.length,e=0;else{if(!isFinite(e))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");e|=0,isFinite(r)?(r|=0,void 0===n&&(n="utf8")):(n=r,r=void 0)}var i=this.length-e;if((void 0===r||r>i)&&(r=i),t.length>0&&(r<0||e<0)||e>this.length)throw new RangeError("Attempt to write outside buffer bounds");n||(n="utf8");for(var o=!1;;)switch(n){case"hex":return y(this,t,e,r);case"utf8":case"utf-8":return v(this,t,e,r);case"ascii":return x(this,t,e,r);case"latin1":case"binary":return b(this,t,e,r);case"base64":return w(this,t,e,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return T(this,t,e,r);default:if(o)throw new TypeError("Unknown encoding: "+n);n=(""+n).toLowerCase(),o=!0}},h.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var S=4096;function A(t,e,r){var n="";r=Math.min(t.length,r);for(var i=e;i<r;++i)n+=String.fromCharCode(127&t[i]);return n}function M(t,e,r){var n="";r=Math.min(t.length,r);for(var i=e;i<r;++i)n+=String.fromCharCode(t[i]);return n}function P(t,e,r){var n=t.length;(!e||e<0)&&(e=0),(!r||r<0||r>n)&&(r=n);for(var i="",o=e;o<r;++o)i+=z(t[o]);return i}function R(t,e,r){for(var n=t.slice(e,r),i="",o=0;o<n.length;o+=2)i+=String.fromCharCode(n[o]+256*n[o+1]);return i}function L(t,e,r){if(t%1!=0||t<0)throw new RangeError("offset is not uint");if(t+e>r)throw new RangeError("Trying to access beyond buffer length")}function O(t,e,r,n,i,o){if(!h.isBuffer(t))throw new TypeError('"buffer" argument must be a Buffer instance');if(e>i||e<o)throw new RangeError('"value" argument is out of bounds');if(r+n>t.length)throw new RangeError("Index out of range")}function k(t,e,r,n){e<0&&(e=65535+e+1);for(var i=0,o=Math.min(t.length-r,2);i<o;++i)t[r+i]=(e&255<<8*(n?i:1-i))>>>8*(n?i:1-i)}function D(t,e,r,n){e<0&&(e=4294967295+e+1);for(var i=0,o=Math.min(t.length-r,4);i<o;++i)t[r+i]=e>>>8*(n?i:3-i)&255}function I(t,e,r,n,i,o){if(r+n>t.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("Index out of range")}function N(t,e,r,n,o){return o||I(t,0,r,4),i.write(t,e,r,n,23,4),r+4}function F(t,e,r,n,o){return o||I(t,0,r,8),i.write(t,e,r,n,52,8),r+8}h.prototype.slice=function(t,e){var r,n=this.length;if(t=~~t,e=void 0===e?n:~~e,t<0?(t+=n)<0&&(t=0):t>n&&(t=n),e<0?(e+=n)<0&&(e=0):e>n&&(e=n),e<t&&(e=t),h.TYPED_ARRAY_SUPPORT)(r=this.subarray(t,e)).__proto__=h.prototype;else{var i=e-t;r=new h(i,void 0);for(var o=0;o<i;++o)r[o]=this[o+t]}return r},h.prototype.readUIntLE=function(t,e,r){t|=0,e|=0,r||L(t,e,this.length);for(var n=this[t],i=1,o=0;++o<e&&(i*=256);)n+=this[t+o]*i;return n},h.prototype.readUIntBE=function(t,e,r){t|=0,e|=0,r||L(t,e,this.length);for(var n=this[t+--e],i=1;e>0&&(i*=256);)n+=this[t+--e]*i;return n},h.prototype.readUInt8=function(t,e){return e||L(t,1,this.length),this[t]},h.prototype.readUInt16LE=function(t,e){return e||L(t,2,this.length),this[t]|this[t+1]<<8},h.prototype.readUInt16BE=function(t,e){return e||L(t,2,this.length),this[t]<<8|this[t+1]},h.prototype.readUInt32LE=function(t,e){return e||L(t,4,this.length),(this[t]|this[t+1]<<8|this[t+2]<<16)+16777216*this[t+3]},h.prototype.readUInt32BE=function(t,e){return e||L(t,4,this.length),16777216*this[t]+(this[t+1]<<16|this[t+2]<<8|this[t+3])},h.prototype.readIntLE=function(t,e,r){t|=0,e|=0,r||L(t,e,this.length);for(var n=this[t],i=1,o=0;++o<e&&(i*=256);)n+=this[t+o]*i;return n>=(i*=128)&&(n-=Math.pow(2,8*e)),n},h.prototype.readIntBE=function(t,e,r){t|=0,e|=0,r||L(t,e,this.length);for(var n=e,i=1,o=this[t+--n];n>0&&(i*=256);)o+=this[t+--n]*i;return o>=(i*=128)&&(o-=Math.pow(2,8*e)),o},h.prototype.readInt8=function(t,e){return e||L(t,1,this.length),128&this[t]?-1*(255-this[t]+1):this[t]},h.prototype.readInt16LE=function(t,e){e||L(t,2,this.length);var r=this[t]|this[t+1]<<8;return 32768&r?4294901760|r:r},h.prototype.readInt16BE=function(t,e){e||L(t,2,this.length);var r=this[t+1]|this[t]<<8;return 32768&r?4294901760|r:r},h.prototype.readInt32LE=function(t,e){return e||L(t,4,this.length),this[t]|this[t+1]<<8|this[t+2]<<16|this[t+3]<<24},h.prototype.readInt32BE=function(t,e){return e||L(t,4,this.length),this[t]<<24|this[t+1]<<16|this[t+2]<<8|this[t+3]},h.prototype.readFloatLE=function(t,e){return e||L(t,4,this.length),i.read(this,t,!0,23,4)},h.prototype.readFloatBE=function(t,e){return e||L(t,4,this.length),i.read(this,t,!1,23,4)},h.prototype.readDoubleLE=function(t,e){return e||L(t,8,this.length),i.read(this,t,!0,52,8)},h.prototype.readDoubleBE=function(t,e){return e||L(t,8,this.length),i.read(this,t,!1,52,8)},h.prototype.writeUIntLE=function(t,e,r,n){(t=+t,e|=0,r|=0,n)||O(this,t,e,r,Math.pow(2,8*r)-1,0);var i=1,o=0;for(this[e]=255&t;++o<r&&(i*=256);)this[e+o]=t/i&255;return e+r},h.prototype.writeUIntBE=function(t,e,r,n){(t=+t,e|=0,r|=0,n)||O(this,t,e,r,Math.pow(2,8*r)-1,0);var i=r-1,o=1;for(this[e+i]=255&t;--i>=0&&(o*=256);)this[e+i]=t/o&255;return e+r},h.prototype.writeUInt8=function(t,e,r){return t=+t,e|=0,r||O(this,t,e,1,255,0),h.TYPED_ARRAY_SUPPORT||(t=Math.floor(t)),this[e]=255&t,e+1},h.prototype.writeUInt16LE=function(t,e,r){return t=+t,e|=0,r||O(this,t,e,2,65535,0),h.TYPED_ARRAY_SUPPORT?(this[e]=255&t,this[e+1]=t>>>8):k(this,t,e,!0),e+2},h.prototype.writeUInt16BE=function(t,e,r){return t=+t,e|=0,r||O(this,t,e,2,65535,0),h.TYPED_ARRAY_SUPPORT?(this[e]=t>>>8,this[e+1]=255&t):k(this,t,e,!1),e+2},h.prototype.writeUInt32LE=function(t,e,r){return t=+t,e|=0,r||O(this,t,e,4,4294967295,0),h.TYPED_ARRAY_SUPPORT?(this[e+3]=t>>>24,this[e+2]=t>>>16,this[e+1]=t>>>8,this[e]=255&t):D(this,t,e,!0),e+4},h.prototype.writeUInt32BE=function(t,e,r){return t=+t,e|=0,r||O(this,t,e,4,4294967295,0),h.TYPED_ARRAY_SUPPORT?(this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=255&t):D(this,t,e,!1),e+4},h.prototype.writeIntLE=function(t,e,r,n){if(t=+t,e|=0,!n){var i=Math.pow(2,8*r-1);O(this,t,e,r,i-1,-i)}var o=0,a=1,s=0;for(this[e]=255&t;++o<r&&(a*=256);)t<0&&0===s&&0!==this[e+o-1]&&(s=1),this[e+o]=(t/a>>0)-s&255;return e+r},h.prototype.writeIntBE=function(t,e,r,n){if(t=+t,e|=0,!n){var i=Math.pow(2,8*r-1);O(this,t,e,r,i-1,-i)}var o=r-1,a=1,s=0;for(this[e+o]=255&t;--o>=0&&(a*=256);)t<0&&0===s&&0!==this[e+o+1]&&(s=1),this[e+o]=(t/a>>0)-s&255;return e+r},h.prototype.writeInt8=function(t,e,r){return t=+t,e|=0,r||O(this,t,e,1,127,-128),h.TYPED_ARRAY_SUPPORT||(t=Math.floor(t)),t<0&&(t=255+t+1),this[e]=255&t,e+1},h.prototype.writeInt16LE=function(t,e,r){return t=+t,e|=0,r||O(this,t,e,2,32767,-32768),h.TYPED_ARRAY_SUPPORT?(this[e]=255&t,this[e+1]=t>>>8):k(this,t,e,!0),e+2},h.prototype.writeInt16BE=function(t,e,r){return t=+t,e|=0,r||O(this,t,e,2,32767,-32768),h.TYPED_ARRAY_SUPPORT?(this[e]=t>>>8,this[e+1]=255&t):k(this,t,e,!1),e+2},h.prototype.writeInt32LE=function(t,e,r){return t=+t,e|=0,r||O(this,t,e,4,2147483647,-2147483648),h.TYPED_ARRAY_SUPPORT?(this[e]=255&t,this[e+1]=t>>>8,this[e+2]=t>>>16,this[e+3]=t>>>24):D(this,t,e,!0),e+4},h.prototype.writeInt32BE=function(t,e,r){return t=+t,e|=0,r||O(this,t,e,4,2147483647,-2147483648),t<0&&(t=4294967295+t+1),h.TYPED_ARRAY_SUPPORT?(this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=255&t):D(this,t,e,!1),e+4},h.prototype.writeFloatLE=function(t,e,r){return N(this,t,e,!0,r)},h.prototype.writeFloatBE=function(t,e,r){return N(this,t,e,!1,r)},h.prototype.writeDoubleLE=function(t,e,r){return F(this,t,e,!0,r)},h.prototype.writeDoubleBE=function(t,e,r){return F(this,t,e,!1,r)},h.prototype.copy=function(t,e,r,n){if(r||(r=0),n||0===n||(n=this.length),e>=t.length&&(e=t.length),e||(e=0),n>0&&n<r&&(n=r),n===r)return 0;if(0===t.length||0===this.length)return 0;if(e<0)throw new RangeError("targetStart out of bounds");if(r<0||r>=this.length)throw new RangeError("sourceStart out of bounds");if(n<0)throw new RangeError("sourceEnd out of bounds");n>this.length&&(n=this.length),t.length-e<n-r&&(n=t.length-e+r);var i,o=n-r;if(this===t&&r<e&&e<n)for(i=o-1;i>=0;--i)t[i+e]=this[i+r];else if(o<1e3||!h.TYPED_ARRAY_SUPPORT)for(i=0;i<o;++i)t[i+e]=this[i+r];else Uint8Array.prototype.set.call(t,this.subarray(r,r+o),e);return o},h.prototype.fill=function(t,e,r,n){if("string"==typeof t){if("string"==typeof e?(n=e,e=0,r=this.length):"string"==typeof r&&(n=r,r=this.length),1===t.length){var i=t.charCodeAt(0);i<256&&(t=i)}if(void 0!==n&&"string"!=typeof n)throw new TypeError("encoding must be a string");if("string"==typeof n&&!h.isEncoding(n))throw new TypeError("Unknown encoding: "+n)}else"number"==typeof t&&(t&=255);if(e<0||this.length<e||this.length<r)throw new RangeError("Out of range index");if(r<=e)return this;var o;if(e>>>=0,r=void 0===r?this.length:r>>>0,t||(t=0),"number"==typeof t)for(o=e;o<r;++o)this[o]=t;else{var a=h.isBuffer(t)?t:U(new h(t,n).toString()),s=a.length;for(o=0;o<r-e;++o)this[o+e]=a[o%s]}return this};var B=/[^+\/0-9A-Za-z-_]/g;function z(t){return t<16?"0"+t.toString(16):t.toString(16)}function U(t,e){var r;e=e||1/0;for(var n=t.length,i=null,o=[],a=0;a<n;++a){if((r=t.charCodeAt(a))>55295&&r<57344){if(!i){if(r>56319){(e-=3)>-1&&o.push(239,191,189);continue}if(a+1===n){(e-=3)>-1&&o.push(239,191,189);continue}i=r;continue}if(r<56320){(e-=3)>-1&&o.push(239,191,189),i=r;continue}r=65536+(i-55296<<10|r-56320)}else i&&(e-=3)>-1&&o.push(239,191,189);if(i=null,r<128){if((e-=1)<0)break;o.push(r)}else if(r<2048){if((e-=2)<0)break;o.push(r>>6|192,63&r|128)}else if(r<65536){if((e-=3)<0)break;o.push(r>>12|224,r>>6&63|128,63&r|128)}else{if(!(r<1114112))throw new Error("Invalid code point");if((e-=4)<0)break;o.push(r>>18|240,r>>12&63|128,r>>6&63|128,63&r|128)}}return o}function H(t){return n.toByteArray(function(t){if((t=function(t){return t.trim?t.trim():t.replace(/^\s+|\s+$/g,"")}(t).replace(B,"")).length<2)return"";for(;t.length%4!=0;)t+="=";return t}(t))}function j(t,e,r,n){for(var i=0;i<n&&!(i+r>=e.length||i>=t.length);++i)e[i+r]=t[i];return i}}).call(this,r(3))},function(t,e){var r=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=r)},function(t,e,r){"use strict";(function(e){t.exports={isNode:void 0!==e,newBufferFrom:function(t,r){return new e(t,r)},allocBuffer:function(t){return e.alloc?e.alloc(t):new e(t)},isBuffer:function(t){return e.isBuffer(t)},isStream:function(t){return t&&"function"==typeof t.on&&"function"==typeof t.pause&&"function"==typeof t.resume}}}).call(this,r(12).Buffer)},function(t,e,r){var n=r(12),i=n.Buffer;function o(t,e){for(var r in t)e[r]=t[r]}function a(t,e,r){return i(t,e,r)}i.from&&i.alloc&&i.allocUnsafe&&i.allocUnsafeSlow?t.exports=n:(o(n,e),e.Buffer=a),o(i,a),a.from=function(t,e,r){if("number"==typeof t)throw new TypeError("Argument must not be a number");return i(t,e,r)},a.alloc=function(t,e,r){if("number"!=typeof t)throw new TypeError("Argument must be a number");var n=i(t);return void 0!==e?"string"==typeof r?n.fill(e,r):n.fill(e):n.fill(0),n},a.allocUnsafe=function(t){if("number"!=typeof t)throw new TypeError("Argument must be a number");return i(t)},a.allocUnsafeSlow=function(t){if("number"!=typeof t)throw new TypeError("Argument must be a number");return n.SlowBuffer(t)}},function(t,e,r){"use strict";(function(e){!e.version||0===e.version.indexOf("v0.")||0===e.version.indexOf("v1.")&&0!==e.version.indexOf("v1.8.")?t.exports={nextTick:function(t,r,n,i){if("function"!=typeof t)throw new TypeError('"callback" argument must be a function');var o,a,s=arguments.length;switch(s){case 0:case 1:return e.nextTick(t);case 2:return e.nextTick(function(){t.call(null,r)});case 3:return e.nextTick(function(){t.call(null,r,n)});case 4:return e.nextTick(function(){t.call(null,r,n,i)});default:for(o=new Array(s-1),a=0;a<o.length;)o[a++]=arguments[a];return e.nextTick(function(){t.apply(null,o)})}}}:t.exports=e}).call(this,r(6))},function(t,e,r){"use strict";function n(t,e,r){r=r||2;var n,s,h,u,l,d,m,g=e&&e.length,_=g?e[0]*r:t.length,y=i(t,0,_,r,!0),v=[];if(!y)return v;if(g&&(y=function(t,e,r,n){var a,s,h,u,l,d=[];for(a=0,s=e.length;a<s;a++)h=e[a]*n,u=a<s-1?e[a+1]*n:t.length,(l=i(t,h,u,n,!1))===l.next&&(l.steiner=!0),d.push(p(l));for(d.sort(c),a=0;a<d.length;a++)f(d[a],r),r=o(r,r.next);return r}(t,e,y,r)),t.length>80*r){n=h=t[0],s=u=t[1];for(var x=r;x<_;x+=r)l=t[x],d=t[x+1],l<n&&(n=l),d<s&&(s=d),l>h&&(h=l),d>u&&(u=d);m=0!==(m=Math.max(h-n,u-s))?1/m:0}return a(y,v,r,n,s,m),v}function i(t,e,r,n,i){var o,a;if(i===C(t,e,r,n)>0)for(o=e;o<r;o+=n)a=w(o,t[o],t[o+1],a);else for(o=r-n;o>=e;o-=n)a=w(o,t[o],t[o+1],a);return a&&y(a,a.next)&&(T(a),a=a.next),a}function o(t,e){if(!t)return t;e||(e=t);var r,n=t;do{if(r=!1,n.steiner||!y(n,n.next)&&0!==_(n.prev,n,n.next))n=n.next;else{if(T(n),(n=e=n.prev)===n.next)break;r=!0}}while(r||n!==e);return e}function a(t,e,r,n,i,c,f){if(t){!f&&c&&function(t,e,r,n){var i=t;do{null===i.z&&(i.z=d(i.x,i.y,e,r,n)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next}while(i!==t);i.prevZ.nextZ=null,i.prevZ=null,function(t){var e,r,n,i,o,a,s,h,u=1;do{for(r=t,t=null,o=null,a=0;r;){for(a++,n=r,s=0,e=0;e<u&&(s++,n=n.nextZ);e++);for(h=u;s>0||h>0&&n;)0!==s&&(0===h||!n||r.z<=n.z)?(i=r,r=r.nextZ,s--):(i=n,n=n.nextZ,h--),o?o.nextZ=i:t=i,i.prevZ=o,o=i;r=n}o.nextZ=null,u*=2}while(a>1)}(i)}(t,n,i,c);for(var p,m,g=t;t.prev!==t.next;)if(p=t.prev,m=t.next,c?h(t,n,i,c):s(t))e.push(p.i/r),e.push(t.i/r),e.push(m.i/r),T(t),t=m.next,g=m.next;else if((t=m)===g){f?1===f?a(t=u(t,e,r),e,r,n,i,c,2):2===f&&l(t,e,r,n,i,c):a(o(t),e,r,n,i,c,1);break}}}function s(t){var e=t.prev,r=t,n=t.next;if(_(e,r,n)>=0)return!1;for(var i=t.next.next;i!==t.prev;){if(m(e.x,e.y,r.x,r.y,n.x,n.y,i.x,i.y)&&_(i.prev,i,i.next)>=0)return!1;i=i.next}return!0}function h(t,e,r,n){var i=t.prev,o=t,a=t.next;if(_(i,o,a)>=0)return!1;for(var s=i.x<o.x?i.x<a.x?i.x:a.x:o.x<a.x?o.x:a.x,h=i.y<o.y?i.y<a.y?i.y:a.y:o.y<a.y?o.y:a.y,u=i.x>o.x?i.x>a.x?i.x:a.x:o.x>a.x?o.x:a.x,l=i.y>o.y?i.y>a.y?i.y:a.y:o.y>a.y?o.y:a.y,c=d(s,h,e,r,n),f=d(u,l,e,r,n),p=t.prevZ,g=t.nextZ;p&&p.z>=c&&g&&g.z<=f;){if(p!==t.prev&&p!==t.next&&m(i.x,i.y,o.x,o.y,a.x,a.y,p.x,p.y)&&_(p.prev,p,p.next)>=0)return!1;if(p=p.prevZ,g!==t.prev&&g!==t.next&&m(i.x,i.y,o.x,o.y,a.x,a.y,g.x,g.y)&&_(g.prev,g,g.next)>=0)return!1;g=g.nextZ}for(;p&&p.z>=c;){if(p!==t.prev&&p!==t.next&&m(i.x,i.y,o.x,o.y,a.x,a.y,p.x,p.y)&&_(p.prev,p,p.next)>=0)return!1;p=p.prevZ}for(;g&&g.z<=f;){if(g!==t.prev&&g!==t.next&&m(i.x,i.y,o.x,o.y,a.x,a.y,g.x,g.y)&&_(g.prev,g,g.next)>=0)return!1;g=g.nextZ}return!0}function u(t,e,r){var n=t;do{var i=n.prev,o=n.next.next;!y(i,o)&&v(i,n,n.next,o)&&x(i,o)&&x(o,i)&&(e.push(i.i/r),e.push(n.i/r),e.push(o.i/r),T(n),T(n.next),n=t=o),n=n.next}while(n!==t);return n}function l(t,e,r,n,i,s){var h=t;do{for(var u=h.next.next;u!==h.prev;){if(h.i!==u.i&&g(h,u)){var l=b(h,u);return h=o(h,h.next),l=o(l,l.next),a(h,e,r,n,i,s),void a(l,e,r,n,i,s)}u=u.next}h=h.next}while(h!==t)}function c(t,e){return t.x-e.x}function f(t,e){if(e=function(t,e){var r,n=e,i=t.x,o=t.y,a=-1/0;do{if(o<=n.y&&o>=n.next.y&&n.next.y!==n.y){var s=n.x+(o-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(s<=i&&s>a){if(a=s,s===i){if(o===n.y)return n;if(o===n.next.y)return n.next}r=n.x<n.next.x?n:n.next}}n=n.next}while(n!==e);if(!r)return null;if(i===a)return r.prev;var h,u=r,l=r.x,c=r.y,f=1/0;n=r.next;for(;n!==u;)i>=n.x&&n.x>=l&&i!==n.x&&m(o<c?i:a,o,l,c,o<c?a:i,o,n.x,n.y)&&((h=Math.abs(o-n.y)/(i-n.x))<f||h===f&&n.x>r.x)&&x(n,t)&&(r=n,f=h),n=n.next;return r}(t,e)){var r=b(e,t);o(r,r.next)}}function d(t,e,r,n,i){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-r)*i)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-n)*i)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function p(t){var e=t,r=t;do{e.x<r.x&&(r=e),e=e.next}while(e!==t);return r}function m(t,e,r,n,i,o,a,s){return(i-a)*(e-s)-(t-a)*(o-s)>=0&&(t-a)*(n-s)-(r-a)*(e-s)>=0&&(r-a)*(o-s)-(i-a)*(n-s)>=0}function g(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var r=t;do{if(r.i!==t.i&&r.next.i!==t.i&&r.i!==e.i&&r.next.i!==e.i&&v(r,r.next,t,e))return!0;r=r.next}while(r!==t);return!1}(t,e)&&x(t,e)&&x(e,t)&&function(t,e){var r=t,n=!1,i=(t.x+e.x)/2,o=(t.y+e.y)/2;do{r.y>o!=r.next.y>o&&r.next.y!==r.y&&i<(r.next.x-r.x)*(o-r.y)/(r.next.y-r.y)+r.x&&(n=!n),r=r.next}while(r!==t);return n}(t,e)}function _(t,e,r){return(e.y-t.y)*(r.x-e.x)-(e.x-t.x)*(r.y-e.y)}function y(t,e){return t.x===e.x&&t.y===e.y}function v(t,e,r,n){return!!(y(t,e)&&y(r,n)||y(t,n)&&y(r,e))||_(t,e,r)>0!=_(t,e,n)>0&&_(r,n,t)>0!=_(r,n,e)>0}function x(t,e){return _(t.prev,t,t.next)<0?_(t,e,t.next)>=0&&_(t,t.prev,e)>=0:_(t,e,t.prev)<0||_(t,t.next,e)<0}function b(t,e){var r=new E(t.i,t.x,t.y),n=new E(e.i,e.x,e.y),i=t.next,o=e.prev;return t.next=e,e.prev=t,r.next=i,i.prev=r,n.next=r,r.prev=n,o.next=n,n.prev=o,n}function w(t,e,r,n){var i=new E(t,e,r);return n?(i.next=n.next,i.prev=n,n.next.prev=i,n.next=i):(i.prev=i,i.next=i),i}function T(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function E(t,e,r){this.i=t,this.x=e,this.y=r,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function C(t,e,r,n){for(var i=0,o=e,a=r-n;o<r;o+=n)i+=(t[a]-t[o])*(t[o+1]+t[a+1]),a=o;return i}t.exports=n,t.exports.default=n,n.deviation=function(t,e,r,n){var i=e&&e.length,o=i?e[0]*r:t.length,a=Math.abs(C(t,0,o,r));if(i)for(var s=0,h=e.length;s<h;s++){var u=e[s]*r,l=s<h-1?e[s+1]*r:t.length;a-=Math.abs(C(t,u,l,r))}var c=0;for(s=0;s<n.length;s+=3){var f=n[s]*r,d=n[s+1]*r,p=n[s+2]*r;c+=Math.abs((t[f]-t[p])*(t[d+1]-t[f+1])-(t[f]-t[d])*(t[p+1]-t[f+1]))}return 0===a&&0===c?0:Math.abs((c-a)/a)},n.flatten=function(t){for(var e=t[0][0].length,r={vertices:[],holes:[],dimensions:e},n=0,i=0;i<t.length;i++){for(var o=0;o<t[i].length;o++)for(var a=0;a<e;a++)r.vertices.push(t[i][o][a]);i>0&&(n+=t[i-1].length,r.holes.push(n))}return r}},function(t,e,r){"use strict";t.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},function(t,e,r){"use strict";var n=r(1);var i=function(){for(var t,e=[],r=0;r<256;r++){t=r;for(var n=0;n<8;n++)t=1&t?3988292384^t>>>1:t>>>1;e[r]=t}return e}();t.exports=function(t,e){return void 0!==t&&t.length?"string"!==n.getTypeOf(t)?function(t,e,r,n){var o=i,a=n+r;t^=-1;for(var s=n;s<a;s++)t=t>>>8^o[255&(t^e[s])];return-1^t}(0|e,t,t.length,0):function(t,e,r,n){var o=i,a=n+r;t^=-1;for(var s=n;s<a;s++)t=t>>>8^o[255&(t^e.charCodeAt(s))];return-1^t}(0|e,t,t.length,0):0}},function(t,e,r){"use strict";var n=r(10),i=r(42),o=r(41),a=r(40);o=r(41);function s(t,e,r,n,i){this.compressedSize=t,this.uncompressedSize=e,this.crc32=r,this.compression=n,this.compressedContent=i}s.prototype={getContentWorker:function(){var t=new i(n.Promise.resolve(this.compressedContent)).pipe(this.compression.uncompressWorker()).pipe(new o("data_length")),e=this;return t.on("end",function(){if(this.streamInfo.data_length!==e.uncompressedSize)throw new Error("Bug : uncompressed data size mismatch")}),t},getCompressedWorker:function(){return new i(n.Promise.resolve(this.compressedContent)).withStreamInfo("compressedSize",this.compressedSize).withStreamInfo("uncompressedSize",this.uncompressedSize).withStreamInfo("crc32",this.crc32).withStreamInfo("compression",this.compression)}},s.createWorkerFrom=function(t,e,r){return t.pipe(new a).pipe(new o("uncompressedSize")).pipe(e.compressWorker(r)).pipe(new o("compressedSize")).withStreamInfo("compression",e)},t.exports=s},function(t,e,r){t.exports=!r(46)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(t,e){t.exports=function(t){return"object"==typeof t?null!==t:"function"==typeof t}},function(t,e,r){"use strict";(function(e,n,i){var o=r(16);function a(t){var e=this;this.next=null,this.entry=null,this.finish=function(){!function(t,e,r){var n=t.entry;t.entry=null;for(;n;){var i=n.callback;e.pendingcb--,i(r),n=n.next}e.corkedRequestsFree?e.corkedRequestsFree.next=t:e.corkedRequestsFree=t}(e,t)}}t.exports=y;var s,h=!e.browser&&["v0.10","v0.9."].indexOf(e.version.slice(0,5))>-1?n:o.nextTick;y.WritableState=_;var u=r(11);u.inherits=r(8);var l={deprecate:r(112)},c=r(54),f=r(15).Buffer,d=i.Uint8Array||function(){};var p,m=r(53);function g(){}function _(t,e){s=s||r(7),t=t||{};var n=e instanceof s;this.objectMode=!!t.objectMode,n&&(this.objectMode=this.objectMode||!!t.writableObjectMode);var i=t.highWaterMark,u=t.writableHighWaterMark,l=this.objectMode?16:16384;this.highWaterMark=i||0===i?i:n&&(u||0===u)?u:l,this.highWaterMark=Math.floor(this.highWaterMark),this.finalCalled=!1,this.needDrain=!1,this.ending=!1,this.ended=!1,this.finished=!1,this.destroyed=!1;var c=!1===t.decodeStrings;this.decodeStrings=!c,this.defaultEncoding=t.defaultEncoding||"utf8",this.length=0,this.writing=!1,this.corked=0,this.sync=!0,this.bufferProcessing=!1,this.onwrite=function(t){!function(t,e){var r=t._writableState,n=r.sync,i=r.writecb;if(function(t){t.writing=!1,t.writecb=null,t.length-=t.writelen,t.writelen=0}(r),e)!function(t,e,r,n,i){--e.pendingcb,r?(o.nextTick(i,n),o.nextTick(E,t,e),t._writableState.errorEmitted=!0,t.emit("error",n)):(i(n),t._writableState.errorEmitted=!0,t.emit("error",n),E(t,e))}(t,r,n,e,i);else{var a=w(r);a||r.corked||r.bufferProcessing||!r.bufferedRequest||b(t,r),n?h(x,t,r,a,i):x(t,r,a,i)}}(e,t)},this.writecb=null,this.writelen=0,this.bufferedRequest=null,this.lastBufferedRequest=null,this.pendingcb=0,this.prefinished=!1,this.errorEmitted=!1,this.bufferedRequestCount=0,this.corkedRequestsFree=new a(this)}function y(t){if(s=s||r(7),!(p.call(y,this)||this instanceof s))return new y(t);this._writableState=new _(t,this),this.writable=!0,t&&("function"==typeof t.write&&(this._write=t.write),"function"==typeof t.writev&&(this._writev=t.writev),"function"==typeof t.destroy&&(this._destroy=t.destroy),"function"==typeof t.final&&(this._final=t.final)),c.call(this)}function v(t,e,r,n,i,o,a){e.writelen=n,e.writecb=a,e.writing=!0,e.sync=!0,r?t._writev(i,e.onwrite):t._write(i,o,e.onwrite),e.sync=!1}function x(t,e,r,n){r||function(t,e){0===e.length&&e.needDrain&&(e.needDrain=!1,t.emit("drain"))}(t,e),e.pendingcb--,n(),E(t,e)}function b(t,e){e.bufferProcessing=!0;var r=e.bufferedRequest;if(t._writev&&r&&r.next){var n=e.bufferedRequestCount,i=new Array(n),o=e.corkedRequestsFree;o.entry=r;for(var s=0,h=!0;r;)i[s]=r,r.isBuf||(h=!1),r=r.next,s+=1;i.allBuffers=h,v(t,e,!0,e.length,i,"",o.finish),e.pendingcb++,e.lastBufferedRequest=null,o.next?(e.corkedRequestsFree=o.next,o.next=null):e.corkedRequestsFree=new a(e),e.bufferedRequestCount=0}else{for(;r;){var u=r.chunk,l=r.encoding,c=r.callback;if(v(t,e,!1,e.objectMode?1:u.length,u,l,c),r=r.next,e.bufferedRequestCount--,e.writing)break}null===r&&(e.lastBufferedRequest=null)}e.bufferedRequest=r,e.bufferProcessing=!1}function w(t){return t.ending&&0===t.length&&null===t.bufferedRequest&&!t.finished&&!t.writing}function T(t,e){t._final(function(r){e.pendingcb--,r&&t.emit("error",r),e.prefinished=!0,t.emit("prefinish"),E(t,e)})}function E(t,e){var r=w(e);return r&&(!function(t,e){e.prefinished||e.finalCalled||("function"==typeof t._final?(e.pendingcb++,e.finalCalled=!0,o.nextTick(T,t,e)):(e.prefinished=!0,t.emit("prefinish")))}(t,e),0===e.pendingcb&&(e.finished=!0,t.emit("finish"))),r}u.inherits(y,c),_.prototype.getBuffer=function(){for(var t=this.bufferedRequest,e=[];t;)e.push(t),t=t.next;return e},function(){try{Object.defineProperty(_.prototype,"buffer",{get:l.deprecate(function(){return this.getBuffer()},"_writableState.buffer is deprecated. Use _writableState.getBuffer instead.","DEP0003")})}catch(t){}}(),"function"==typeof Symbol&&Symbol.hasInstance&&"function"==typeof Function.prototype[Symbol.hasInstance]?(p=Function.prototype[Symbol.hasInstance],Object.defineProperty(y,Symbol.hasInstance,{value:function(t){return!!p.call(this,t)||this===y&&(t&&t._writableState instanceof _)}})):p=function(t){return t instanceof this},y.prototype.pipe=function(){this.emit("error",new Error("Cannot pipe, not readable"))},y.prototype.write=function(t,e,r){var n,i=this._writableState,a=!1,s=!i.objectMode&&(n=t,f.isBuffer(n)||n instanceof d);return s&&!f.isBuffer(t)&&(t=function(t){return f.from(t)}(t)),"function"==typeof e&&(r=e,e=null),s?e="buffer":e||(e=i.defaultEncoding),"function"!=typeof r&&(r=g),i.ended?function(t,e){var r=new Error("write after end");t.emit("error",r),o.nextTick(e,r)}(this,r):(s||function(t,e,r,n){var i=!0,a=!1;return null===r?a=new TypeError("May not write null values to stream"):"string"==typeof r||void 0===r||e.objectMode||(a=new TypeError("Invalid non-string/buffer chunk")),a&&(t.emit("error",a),o.nextTick(n,a),i=!1),i}(this,i,t,r))&&(i.pendingcb++,a=function(t,e,r,n,i,o){if(!r){var a=function(t,e,r){t.objectMode||!1===t.decodeStrings||"string"!=typeof e||(e=f.from(e,r));return e}(e,n,i);n!==a&&(r=!0,i="buffer",n=a)}var s=e.objectMode?1:n.length;e.length+=s;var h=e.length<e.highWaterMark;h||(e.needDrain=!0);if(e.writing||e.corked){var u=e.lastBufferedRequest;e.lastBufferedRequest={chunk:n,encoding:i,isBuf:r,callback:o,next:null},u?u.next=e.lastBufferedRequest:e.bufferedRequest=e.lastBufferedRequest,e.bufferedRequestCount+=1}else v(t,e,!1,s,n,i,o);return h}(this,i,s,t,e,r)),a},y.prototype.cork=function(){this._writableState.corked++},y.prototype.uncork=function(){var t=this._writableState;t.corked&&(t.corked--,t.writing||t.corked||t.finished||t.bufferProcessing||!t.bufferedRequest||b(this,t))},y.prototype.setDefaultEncoding=function(t){if("string"==typeof t&&(t=t.toLowerCase()),!(["hex","utf8","utf-8","ascii","binary","base64","ucs2","ucs-2","utf16le","utf-16le","raw"].indexOf((t+"").toLowerCase())>-1))throw new TypeError("Unknown encoding: "+t);return this._writableState.defaultEncoding=t,this},y.prototype._write=function(t,e,r){r(new Error("_write() is not implemented"))},y.prototype._writev=null,y.prototype.end=function(t,e,r){var n=this._writableState;"function"==typeof t?(r=t,t=null,e=null):"function"==typeof e&&(r=e,e=null),null!==t&&void 0!==t&&this.write(t,e),n.corked&&(n.corked=1,this.uncork()),n.ending||n.finished||function(t,e,r){e.ending=!0,E(t,e),r&&(e.finished?o.nextTick(r):t.once("finish",r));e.ended=!0,t.writable=!1}(this,n,r)},Object.defineProperty(y.prototype,"destroyed",{get:function(){return void 0!==this._writableState&&this._writableState.destroyed},set:function(t){this._writableState&&(this._writableState.destroyed=t)}}),y.prototype.destroy=m.destroy,y.prototype._undestroy=m.undestroy,y.prototype._destroy=function(t,e){this.end(),e(t)}}).call(this,r(6),r(52).setImmediate,r(3))},function(t,e,r){(e=t.exports=r(55)).Stream=e,e.Readable=e,e.Writable=r(23),e.Duplex=r(7),e.Transform=r(50),e.PassThrough=r(111)},function(t,e){function r(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function n(t){return"function"==typeof t}function i(t){return"object"==typeof t&&null!==t}function o(t){return void 0===t}t.exports=r,r.EventEmitter=r,r.prototype._events=void 0,r.prototype._maxListeners=void 0,r.defaultMaxListeners=10,r.prototype.setMaxListeners=function(t){if("number"!=typeof t||t<0||isNaN(t))throw TypeError("n must be a positive number");return this._maxListeners=t,this},r.prototype.emit=function(t){var e,r,a,s,h,u;if(this._events||(this._events={}),"error"===t&&(!this._events.error||i(this._events.error)&&!this._events.error.length)){if((e=arguments[1])instanceof Error)throw e;var l=new Error('Uncaught, unspecified "error" event. ('+e+")");throw l.context=e,l}if(o(r=this._events[t]))return!1;if(n(r))switch(arguments.length){case 1:r.call(this);break;case 2:r.call(this,arguments[1]);break;case 3:r.call(this,arguments[1],arguments[2]);break;default:s=Array.prototype.slice.call(arguments,1),r.apply(this,s)}else if(i(r))for(s=Array.prototype.slice.call(arguments,1),a=(u=r.slice()).length,h=0;h<a;h++)u[h].apply(this,s);return!0},r.prototype.addListener=function(t,e){var a;if(!n(e))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",t,n(e.listener)?e.listener:e),this._events[t]?i(this._events[t])?this._events[t].push(e):this._events[t]=[this._events[t],e]:this._events[t]=e,i(this._events[t])&&!this._events[t].warned&&(a=o(this._maxListeners)?r.defaultMaxListeners:this._maxListeners)&&a>0&&this._events[t].length>a&&(this._events[t].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[t].length),"function"==typeof console.trace&&console.trace()),this},r.prototype.on=r.prototype.addListener,r.prototype.once=function(t,e){if(!n(e))throw TypeError("listener must be a function");var r=!1;function i(){this.removeListener(t,i),r||(r=!0,e.apply(this,arguments))}return i.listener=e,this.on(t,i),this},r.prototype.removeListener=function(t,e){var r,o,a,s;if(!n(e))throw TypeError("listener must be a function");if(!this._events||!this._events[t])return this;if(a=(r=this._events[t]).length,o=-1,r===e||n(r.listener)&&r.listener===e)delete this._events[t],this._events.removeListener&&this.emit("removeListener",t,e);else if(i(r)){for(s=a;s-- >0;)if(r[s]===e||r[s].listener&&r[s].listener===e){o=s;break}if(o<0)return this;1===r.length?(r.length=0,delete this._events[t]):r.splice(o,1),this._events.removeListener&&this.emit("removeListener",t,e)}return this},r.prototype.removeAllListeners=function(t){var e,r;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[t]&&delete this._events[t],this;if(0===arguments.length){for(e in this._events)"removeListener"!==e&&this.removeAllListeners(e);return this.removeAllListeners("removeListener"),this._events={},this}if(n(r=this._events[t]))this.removeListener(t,r);else if(r)for(;r.length;)this.removeListener(t,r[r.length-1]);return delete this._events[t],this},r.prototype.listeners=function(t){return this._events&&this._events[t]?n(this._events[t])?[this._events[t]]:this._events[t].slice():[]},r.prototype.listenerCount=function(t){if(this._events){var e=this._events[t];if(n(e))return 1;if(e)return e.length}return 0},r.listenerCount=function(t,e){return t.listenerCount(e)}},function(t,e,r){(function(n){function i(){var t;try{t=e.storage.debug}catch(t){}return!t&&void 0!==n&&"env"in n&&(t=n.env.DEBUG),t}(e=t.exports=r(122)).log=function(){return"object"==typeof console&&console.log&&Function.prototype.apply.call(console.log,console,arguments)},e.formatArgs=function(t){var r=this.useColors;if(t[0]=(r?"%c":"")+this.namespace+(r?" %c":" ")+t[0]+(r?"%c ":" ")+"+"+e.humanize(this.diff),!r)return;var n="color: "+this.color;t.splice(1,0,n,"color: inherit");var i=0,o=0;t[0].replace(/%[a-zA-Z%]/g,function(t){"%%"!==t&&"%c"===t&&(o=++i)}),t.splice(o,0,n)},e.save=function(t){try{null==t?e.storage.removeItem("debug"):e.storage.debug=t}catch(t){}},e.load=i,e.useColors=function(){if("undefined"!=typeof window&&window.process&&"renderer"===window.process.type)return!0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},e.storage="undefined"!=typeof chrome&&void 0!==chrome.storage?chrome.storage.local:function(){try{return window.localStorage}catch(t){}}(),e.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],e.formatters.j=function(t){try{return JSON.stringify(t)}catch(t){return"[UnexpectedJSONParseError]: "+t.message}},e.enable(i())}).call(this,r(6))},function(t,e){t.exports=function(t,e,r){var n=e[0],i=e[1],o=e[2],a=r[0],s=r[1],h=r[2];return t[0]=i*h-o*s,t[1]=o*a-n*h,t[2]=n*s-i*a,t}},function(t,e){t.exports=function(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t}},function(t,e,r){"use strict";var n=r(31);function i(t){n.call(this,t)}r(1).inherits(i,n),i.prototype.readData=function(t){if(this.checkOffset(t),0===t)return new Uint8Array(0);var e=this.data.subarray(this.zero+this.index,this.zero+this.index+t);return this.index+=t,e},t.exports=i},function(t,e,r){"use strict";var n=r(1);function i(t){this.data=t,this.length=t.length,this.index=0,this.zero=0}i.prototype={checkOffset:function(t){this.checkIndex(this.index+t)},checkIndex:function(t){if(this.length<this.zero+t||t<0)throw new Error("End of data reached (data length = "+this.length+", asked index = "+t+"). Corrupted zip ?")},setIndex:function(t){this.checkIndex(t),this.index=t},skip:function(t){this.setIndex(this.index+t)},byteAt:function(t){},readInt:function(t){var e,r=0;for(this.checkOffset(t),e=this.index+t-1;e>=this.index;e--)r=(r<<8)+this.byteAt(e);return this.index+=t,r},readString:function(t){return n.transformTo("string",this.readData(t))},readData:function(t){},lastIndexOfSignature:function(t){},readAndCheckSignature:function(t){},readDate:function(){var t=this.readInt(4);return new Date(Date.UTC(1980+(t>>25&127),(t>>21&15)-1,t>>16&31,t>>11&31,t>>5&63,(31&t)<<1))}},t.exports=i},function(t,e,r){"use strict";var n=r(30);function i(t){n.call(this,t);for(var e=0;e<this.data.length;e++)t[e]=255&t[e]}r(1).inherits(i,n),i.prototype.byteAt=function(t){return this.data[this.zero+t]},i.prototype.lastIndexOfSignature=function(t){for(var e=t.charCodeAt(0),r=t.charCodeAt(1),n=t.charCodeAt(2),i=t.charCodeAt(3),o=this.length-4;o>=0;--o)if(this.data[o]===e&&this.data[o+1]===r&&this.data[o+2]===n&&this.data[o+3]===i)return o-this.zero;return-1},i.prototype.readAndCheckSignature=function(t){var e=t.charCodeAt(0),r=t.charCodeAt(1),n=t.charCodeAt(2),i=t.charCodeAt(3),o=this.readData(4);return e===o[0]&&r===o[1]&&n===o[2]&&i===o[3]},i.prototype.readData=function(t){if(this.checkOffset(t),0===t)return[];var e=this.data.slice(this.zero+this.index,this.zero+this.index+t);return this.index+=t,e},t.exports=i},function(t,e,r){"use strict";var n=r(1),i=r(5),o=r(31),a=r(72),s=r(71),h=r(29);t.exports=function(t){var e=n.getTypeOf(t);return n.checkSupport(e),"string"!==e||i.uint8array?"nodebuffer"===e?new s(t):i.uint8array?new h(n.transformTo("uint8array",t)):new o(n.transformTo("array",t)):new a(t)}},function(t,e,r){"use strict";e.LOCAL_FILE_HEADER="PK",e.CENTRAL_FILE_HEADER="PK",e.CENTRAL_DIRECTORY_END="PK",e.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK",e.ZIP64_CENTRAL_DIRECTORY_END="PK",e.DATA_DESCRIPTOR="PK\b"},function(t,e,r){"use strict";t.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},function(t,e,r){"use strict";t.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},function(t,e,r){"use strict";var n=r(4),i=!0,o=!0;try{String.fromCharCode.apply(null,[0])}catch(t){i=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(t){o=!1}for(var a=new n.Buf8(256),s=0;s<256;s++)a[s]=s>=252?6:s>=248?5:s>=240?4:s>=224?3:s>=192?2:1;function h(t,e){if(e<65537&&(t.subarray&&o||!t.subarray&&i))return String.fromCharCode.apply(null,n.shrinkBuf(t,e));for(var r="",a=0;a<e;a++)r+=String.fromCharCode(t[a]);return r}a[254]=a[254]=1,e.string2buf=function(t){var e,r,i,o,a,s=t.length,h=0;for(o=0;o<s;o++)55296==(64512&(r=t.charCodeAt(o)))&&o+1<s&&56320==(64512&(i=t.charCodeAt(o+1)))&&(r=65536+(r-55296<<10)+(i-56320),o++),h+=r<128?1:r<2048?2:r<65536?3:4;for(e=new n.Buf8(h),a=0,o=0;a<h;o++)55296==(64512&(r=t.charCodeAt(o)))&&o+1<s&&56320==(64512&(i=t.charCodeAt(o+1)))&&(r=65536+(r-55296<<10)+(i-56320),o++),r<128?e[a++]=r:r<2048?(e[a++]=192|r>>>6,e[a++]=128|63&r):r<65536?(e[a++]=224|r>>>12,e[a++]=128|r>>>6&63,e[a++]=128|63&r):(e[a++]=240|r>>>18,e[a++]=128|r>>>12&63,e[a++]=128|r>>>6&63,e[a++]=128|63&r);return e},e.buf2binstring=function(t){return h(t,t.length)},e.binstring2buf=function(t){for(var e=new n.Buf8(t.length),r=0,i=e.length;r<i;r++)e[r]=t.charCodeAt(r);return e},e.buf2string=function(t,e){var r,n,i,o,s=e||t.length,u=new Array(2*s);for(n=0,r=0;r<s;)if((i=t[r++])<128)u[n++]=i;else if((o=a[i])>4)u[n++]=65533,r+=o-1;else{for(i&=2===o?31:3===o?15:7;o>1&&r<s;)i=i<<6|63&t[r++],o--;o>1?u[n++]=65533:i<65536?u[n++]=i:(i-=65536,u[n++]=55296|i>>10&1023,u[n++]=56320|1023&i)}return h(u,n)},e.utf8border=function(t,e){var r;for((e=e||t.length)>t.length&&(e=t.length),r=e-1;r>=0&&128==(192&t[r]);)r--;return r<0?e:0===r?e:r+a[t[r]]>e?r:e}},function(t,e,r){"use strict";var n=function(){for(var t,e=[],r=0;r<256;r++){t=r;for(var n=0;n<8;n++)t=1&t?3988292384^t>>>1:t>>>1;e[r]=t}return e}();t.exports=function(t,e,r,i){var o=n,a=i+r;t^=-1;for(var s=i;s<a;s++)t=t>>>8^o[255&(t^e[s])];return-1^t}},function(t,e,r){"use strict";t.exports=function(t,e,r,n){for(var i=65535&t|0,o=t>>>16&65535|0,a=0;0!==r;){r-=a=r>2e3?2e3:r;do{o=o+(i=i+e[n++]|0)|0}while(--a);i%=65521,o%=65521}return i|o<<16|0}},function(t,e,r){"use strict";var n=r(2);e.STORE={magic:"\0\0",compressWorker:function(t){return new n("STORE compression")},uncompressWorker:function(){return new n("STORE decompression")}},e.DEFLATE=r(86)},function(t,e,r){"use strict";var n=r(2),i=r(19);function o(){n.call(this,"Crc32Probe"),this.withStreamInfo("crc32",0)}r(1).inherits(o,n),o.prototype.processChunk=function(t){this.streamInfo.crc32=i(t.data,this.streamInfo.crc32||0),this.push(t)},t.exports=o},function(t,e,r){"use strict";var n=r(1),i=r(2);function o(t){i.call(this,"DataLengthProbe for "+t),this.propName=t,this.withStreamInfo(t,0)}n.inherits(o,i),o.prototype.processChunk=function(t){if(t){var e=this.streamInfo[this.propName]||0;this.streamInfo[this.propName]=e+t.data.length}i.prototype.processChunk.call(this,t)},t.exports=o},function(t,e,r){"use strict";var n=r(1),i=r(2);function o(t){i.call(this,"DataWorker");var e=this;this.dataIsReady=!1,this.index=0,this.max=0,this.data=null,this.type="",this._tickScheduled=!1,t.then(function(t){e.dataIsReady=!0,e.data=t,e.max=t&&t.length||0,e.type=n.getTypeOf(t),e.isPaused||e._tickAndRepeat()},function(t){e.error(t)})}n.inherits(o,i),o.prototype.cleanUp=function(){i.prototype.cleanUp.call(this),this.data=null},o.prototype.resume=function(){return!!i.prototype.resume.call(this)&&(!this._tickScheduled&&this.dataIsReady&&(this._tickScheduled=!0,n.delay(this._tickAndRepeat,[],this)),!0)},o.prototype._tickAndRepeat=function(){this._tickScheduled=!1,this.isPaused||this.isFinished||(this._tick(),this.isFinished||(n.delay(this._tickAndRepeat,[],this),this._tickScheduled=!0))},o.prototype._tick=function(){if(this.isPaused||this.isFinished)return!1;var t=null,e=Math.min(this.max,this.index+16384);if(this.index>=this.max)return this.end();switch(this.type){case"string":t=this.data.substring(this.index,e);break;case"uint8array":t=this.data.subarray(this.index,e);break;case"array":case"nodebuffer":t=this.data.slice(this.index,e)}return this.index=e,this.push({data:t,meta:{percent:this.max?this.index/this.max*100:0}})},t.exports=o},function(t,e,r){"use strict";e.base64=!1,e.binary=!1,e.dir=!1,e.createFolders=!0,e.date=null,e.compression=null,e.compressionOptions=null,e.comment=null,e.unixPermissions=null,e.dosPermissions=null},function(t,e,r){"use strict";(function(e){var n=r(1),i=r(90),o=r(2),a=r(49),s=r(5),h=r(10),u=null;if(s.nodestream)try{u=r(89)}catch(t){}function l(t,r){return new h.Promise(function(i,o){var s=[],h=t._internalType,u=t._outputType,l=t._mimeType;t.on("data",function(t,e){s.push(t),r&&r(e)}).on("error",function(t){s=[],o(t)}).on("end",function(){try{var t=function(t,e,r){switch(t){case"blob":return n.newBlob(n.transformTo("arraybuffer",e),r);case"base64":return a.encode(e);default:return n.transformTo(t,e)}}(u,function(t,r){var n,i=0,o=null,a=0;for(n=0;n<r.length;n++)a+=r[n].length;switch(t){case"string":return r.join("");case"array":return Array.prototype.concat.apply([],r);case"uint8array":for(o=new Uint8Array(a),n=0;n<r.length;n++)o.set(r[n],i),i+=r[n].length;return o;case"nodebuffer":return e.concat(r);default:throw new Error("concat : unsupported type '"+t+"'")}}(h,s),l);i(t)}catch(t){o(t)}s=[]}).resume()})}function c(t,e,r){var a=e;switch(e){case"blob":case"arraybuffer":a="uint8array";break;case"base64":a="string"}try{this._internalType=a,this._outputType=e,this._mimeType=r,n.checkSupport(a),this._worker=t.pipe(new i(a)),t.lock()}catch(t){this._worker=new o("error"),this._worker.error(t)}}c.prototype={accumulate:function(t){return l(this,t)},on:function(t,e){var r=this;return"data"===t?this._worker.on(t,function(t){e.call(r,t.data,t.meta)}):this._worker.on(t,function(){n.delay(e,arguments,r)}),this},resume:function(){return n.delay(this._worker.resume,[],this._worker),this},pause:function(){return this._worker.pause(),this},toNodejsStream:function(t){if(n.checkSupport("nodestream"),"nodebuffer"!==this._outputType)throw new Error(this._outputType+" is not supported by this method");return new u(this,{objectMode:"nodebuffer"!==this._outputType},t)}},t.exports=c}).call(this,r(12).Buffer)},function(t,e,r){var n=r(22),i=r(13).document,o=n(i)&&n(i.createElement);t.exports=function(t){return o?i.createElement(t):{}}},function(t,e){t.exports=function(t){try{return!!t()}catch(t){return!0}}},function(t,e,r){var n=r(103);t.exports=function(t,e,r){if(n(t),void 0===e)return t;switch(r){case 1:return function(r){return t.call(e,r)};case 2:return function(r,n){return t.call(e,r,n)};case 3:return function(r,n,i){return t.call(e,r,n,i)}}return function(){return t.apply(e,arguments)}}},function(t,e){var r=t.exports={version:"2.3.0"};"number"==typeof __e&&(__e=r)},function(t,e,r){"use strict";var n=r(1),i=r(5),o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";e.encode=function(t){for(var e,r,i,a,s,h,u,l=[],c=0,f=t.length,d=f,p="string"!==n.getTypeOf(t);c<t.length;)d=f-c,p?(e=t[c++],r=c<f?t[c++]:0,i=c<f?t[c++]:0):(e=t.charCodeAt(c++),r=c<f?t.charCodeAt(c++):0,i=c<f?t.charCodeAt(c++):0),a=e>>2,s=(3&e)<<4|r>>4,h=d>1?(15&r)<<2|i>>6:64,u=d>2?63&i:64,l.push(o.charAt(a)+o.charAt(s)+o.charAt(h)+o.charAt(u));return l.join("")},e.decode=function(t){var e,r,n,a,s,h,u=0,l=0;if("data:"===t.substr(0,"data:".length))throw new Error("Invalid base64 input, it looks like a data url.");var c,f=3*(t=t.replace(/[^A-Za-z0-9\+\/\=]/g,"")).length/4;if(t.charAt(t.length-1)===o.charAt(64)&&f--,t.charAt(t.length-2)===o.charAt(64)&&f--,f%1!=0)throw new Error("Invalid base64 input, bad content length.");for(c=i.uint8array?new Uint8Array(0|f):new Array(0|f);u<t.length;)e=o.indexOf(t.charAt(u++))<<2|(a=o.indexOf(t.charAt(u++)))>>4,r=(15&a)<<4|(s=o.indexOf(t.charAt(u++)))>>2,n=(3&s)<<6|(h=o.indexOf(t.charAt(u++))),c[l++]=e,64!==s&&(c[l++]=r),64!==h&&(c[l++]=n);return c}},function(t,e,r){"use strict";t.exports=o;var n=r(7),i=r(11);function o(t){if(!(this instanceof o))return new o(t);n.call(this,t),this._transformState={afterTransform:function(t,e){var r=this._transformState;r.transforming=!1;var n=r.writecb;if(!n)return this.emit("error",new Error("write callback called multiple times"));r.writechunk=null,r.writecb=null,null!=e&&this.push(e),n(t);var i=this._readableState;i.reading=!1,(i.needReadable||i.length<i.highWaterMark)&&this._read(i.highWaterMark)}.bind(this),needTransform:!1,transforming:!1,writecb:null,writechunk:null,writeencoding:null},this._readableState.needReadable=!0,this._readableState.sync=!1,t&&("function"==typeof t.transform&&(this._transform=t.transform),"function"==typeof t.flush&&(this._flush=t.flush)),this.on("prefinish",a)}function a(){var t=this;"function"==typeof this._flush?this._flush(function(e,r){s(t,e,r)}):s(this,null,null)}function s(t,e,r){if(e)return t.emit("error",e);if(null!=r&&t.push(r),t._writableState.length)throw new Error("Calling transform done when ws.length != 0");if(t._transformState.transforming)throw new Error("Calling transform done when still transforming");return t.push(null)}i.inherits=r(8),i.inherits(o,n),o.prototype.push=function(t,e){return this._transformState.needTransform=!1,n.prototype.push.call(this,t,e)},o.prototype._transform=function(t,e,r){throw new Error("_transform() is not implemented")},o.prototype._write=function(t,e,r){var n=this._transformState;if(n.writecb=r,n.writechunk=t,n.writeencoding=e,!n.transforming){var i=this._readableState;(n.needTransform||i.needReadable||i.length<i.highWaterMark)&&this._read(i.highWaterMark)}},o.prototype._read=function(t){var e=this._transformState;null!==e.writechunk&&e.writecb&&!e.transforming?(e.transforming=!0,this._transform(e.writechunk,e.writeencoding,e.afterTransform)):e.needTransform=!0},o.prototype._destroy=function(t,e){var r=this;n.prototype._destroy.call(this,t,function(t){e(t),r.emit("close")})}},function(t,e,r){"use strict";var n=r(15).Buffer,i=n.isEncoding||function(t){switch((t=""+t)&&t.toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":case"raw":return!0;default:return!1}};function o(t){var e;switch(this.encoding=function(t){var e=function(t){if(!t)return"utf8";for(var e;;)switch(t){case"utf8":case"utf-8":return"utf8";case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return"utf16le";case"latin1":case"binary":return"latin1";case"base64":case"ascii":case"hex":return t;default:if(e)return;t=(""+t).toLowerCase(),e=!0}}(t);if("string"!=typeof e&&(n.isEncoding===i||!i(t)))throw new Error("Unknown encoding: "+t);return e||t}(t),this.encoding){case"utf16le":this.text=h,this.end=u,e=4;break;case"utf8":this.fillLast=s,e=4;break;case"base64":this.text=l,this.end=c,e=3;break;default:return this.write=f,void(this.end=d)}this.lastNeed=0,this.lastTotal=0,this.lastChar=n.allocUnsafe(e)}function a(t){return t<=127?0:t>>5==6?2:t>>4==14?3:t>>3==30?4:-1}function s(t){var e=this.lastTotal-this.lastNeed,r=function(t,e,r){if(128!=(192&e[0]))return t.lastNeed=0,"".repeat(r);if(t.lastNeed>1&&e.length>1){if(128!=(192&e[1]))return t.lastNeed=1,"".repeat(r+1);if(t.lastNeed>2&&e.length>2&&128!=(192&e[2]))return t.lastNeed=2,"".repeat(r+2)}}(this,t,e);return void 0!==r?r:this.lastNeed<=t.length?(t.copy(this.lastChar,e,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal)):(t.copy(this.lastChar,e,0,t.length),void(this.lastNeed-=t.length))}function h(t,e){if((t.length-e)%2==0){var r=t.toString("utf16le",e);if(r){var n=r.charCodeAt(r.length-1);if(n>=55296&&n<=56319)return this.lastNeed=2,this.lastTotal=4,this.lastChar[0]=t[t.length-2],this.lastChar[1]=t[t.length-1],r.slice(0,-1)}return r}return this.lastNeed=1,this.lastTotal=2,this.lastChar[0]=t[t.length-1],t.toString("utf16le",e,t.length-1)}function u(t){var e=t&&t.length?this.write(t):"";if(this.lastNeed){var r=this.lastTotal-this.lastNeed;return e+this.lastChar.toString("utf16le",0,r)}return e}function l(t,e){var r=(t.length-e)%3;return 0===r?t.toString("base64",e):(this.lastNeed=3-r,this.lastTotal=3,1===r?this.lastChar[0]=t[t.length-1]:(this.lastChar[0]=t[t.length-2],this.lastChar[1]=t[t.length-1]),t.toString("base64",e,t.length-r))}function c(t){var e=t&&t.length?this.write(t):"";return this.lastNeed?e+this.lastChar.toString("base64",0,3-this.lastNeed):e}function f(t){return t.toString(this.encoding)}function d(t){return t&&t.length?this.write(t):""}e.StringDecoder=o,o.prototype.write=function(t){if(0===t.length)return"";var e,r;if(this.lastNeed){if(void 0===(e=this.fillLast(t)))return"";r=this.lastNeed,this.lastNeed=0}else r=0;return r<t.length?e?e+this.text(t,r):this.text(t,r):e||""},o.prototype.end=function(t){var e=t&&t.length?this.write(t):"";return this.lastNeed?e+"".repeat(this.lastTotal-this.lastNeed):e},o.prototype.text=function(t,e){var r=function(t,e,r){var n=e.length-1;if(n<r)return 0;var i=a(e[n]);if(i>=0)return i>0&&(t.lastNeed=i-1),i;if(--n<r)return 0;if((i=a(e[n]))>=0)return i>0&&(t.lastNeed=i-2),i;if(--n<r)return 0;if((i=a(e[n]))>=0)return i>0&&(2===i?i=0:t.lastNeed=i-3),i;return 0}(this,t,e);if(!this.lastNeed)return t.toString("utf8",e);this.lastTotal=r;var n=t.length-(r-this.lastNeed);return t.copy(this.lastChar,0,n),t.toString("utf8",e,n)},o.prototype.fillLast=function(t){if(this.lastNeed<=t.length)return t.copy(this.lastChar,this.lastTotal-this.lastNeed,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal);t.copy(this.lastChar,this.lastTotal-this.lastNeed,0,t.length),this.lastNeed-=t.length}},function(t,e,r){(function(t){var n=Function.prototype.apply;function i(t,e){this._id=t,this._clearFn=e}e.setTimeout=function(){return new i(n.call(setTimeout,window,arguments),clearTimeout)},e.setInterval=function(){return new i(n.call(setInterval,window,arguments),clearInterval)},e.clearTimeout=e.clearInterval=function(t){t&&t.close()},i.prototype.unref=i.prototype.ref=function(){},i.prototype.close=function(){this._clearFn.call(window,this._id)},e.enroll=function(t,e){clearTimeout(t._idleTimeoutId),t._idleTimeout=e},e.unenroll=function(t){clearTimeout(t._idleTimeoutId),t._idleTimeout=-1},e._unrefActive=e.active=function(t){clearTimeout(t._idleTimeoutId);var e=t._idleTimeout;e>=0&&(t._idleTimeoutId=setTimeout(function(){t._onTimeout&&t._onTimeout()},e))},r(113),e.setImmediate="undefined"!=typeof self&&self.setImmediate||void 0!==t&&t.setImmediate||this&&this.setImmediate,e.clearImmediate="undefined"!=typeof self&&self.clearImmediate||void 0!==t&&t.clearImmediate||this&&this.clearImmediate}).call(this,r(3))},function(t,e,r){"use strict";var n=r(16);function i(t,e){t.emit("error",e)}t.exports={destroy:function(t,e){var r=this,o=this._readableState&&this._readableState.destroyed,a=this._writableState&&this._writableState.destroyed;return o||a?(e?e(t):!t||this._writableState&&this._writableState.errorEmitted||n.nextTick(i,this,t),this):(this._readableState&&(this._readableState.destroyed=!0),this._writableState&&(this._writableState.destroyed=!0),this._destroy(t||null,function(t){!e&&t?(n.nextTick(i,r,t),r._writableState&&(r._writableState.errorEmitted=!0)):e&&e(t)}),this)},undestroy:function(){this._readableState&&(this._readableState.destroyed=!1,this._readableState.reading=!1,this._readableState.ended=!1,this._readableState.endEmitted=!1),this._writableState&&(this._writableState.destroyed=!1,this._writableState.ended=!1,this._writableState.ending=!1,this._writableState.finished=!1,this._writableState.errorEmitted=!1)}}},function(t,e,r){t.exports=r(25).EventEmitter},function(t,e,r){"use strict";(function(e,n){var i=r(16);t.exports=v;var o,a=r(57);v.ReadableState=y;r(25).EventEmitter;var s=function(t,e){return t.listeners(e).length},h=r(54),u=r(15).Buffer,l=e.Uint8Array||function(){};var c=r(11);c.inherits=r(8);var f=r(116),d=void 0;d=f&&f.debuglog?f.debuglog("stream"):function(){};var p,m=r(115),g=r(53);c.inherits(v,h);var _=["error","close","destroy","pause","resume"];function y(t,e){o=o||r(7),t=t||{};var n=e instanceof o;this.objectMode=!!t.objectMode,n&&(this.objectMode=this.objectMode||!!t.readableObjectMode);var i=t.highWaterMark,a=t.readableHighWaterMark,s=this.objectMode?16:16384;this.highWaterMark=i||0===i?i:n&&(a||0===a)?a:s,this.highWaterMark=Math.floor(this.highWaterMark),this.buffer=new m,this.length=0,this.pipes=null,this.pipesCount=0,this.flowing=null,this.ended=!1,this.endEmitted=!1,this.reading=!1,this.sync=!0,this.needReadable=!1,this.emittedReadable=!1,this.readableListening=!1,this.resumeScheduled=!1,this.destroyed=!1,this.defaultEncoding=t.defaultEncoding||"utf8",this.awaitDrain=0,this.readingMore=!1,this.decoder=null,this.encoding=null,t.encoding&&(p||(p=r(51).StringDecoder),this.decoder=new p(t.encoding),this.encoding=t.encoding)}function v(t){if(o=o||r(7),!(this instanceof v))return new v(t);this._readableState=new y(t,this),this.readable=!0,t&&("function"==typeof t.read&&(this._read=t.read),"function"==typeof t.destroy&&(this._destroy=t.destroy)),h.call(this)}function x(t,e,r,n,i){var o,a=t._readableState;null===e?(a.reading=!1,function(t,e){if(e.ended)return;if(e.decoder){var r=e.decoder.end();r&&r.length&&(e.buffer.push(r),e.length+=e.objectMode?1:r.length)}e.ended=!0,E(t)}(t,a)):(i||(o=function(t,e){var r;n=e,u.isBuffer(n)||n instanceof l||"string"==typeof e||void 0===e||t.objectMode||(r=new TypeError("Invalid non-string/buffer chunk"));var n;return r}(a,e)),o?t.emit("error",o):a.objectMode||e&&e.length>0?("string"==typeof e||a.objectMode||Object.getPrototypeOf(e)===u.prototype||(e=function(t){return u.from(t)}(e)),n?a.endEmitted?t.emit("error",new Error("stream.unshift() after end event")):b(t,a,e,!0):a.ended?t.emit("error",new Error("stream.push() after EOF")):(a.reading=!1,a.decoder&&!r?(e=a.decoder.write(e),a.objectMode||0!==e.length?b(t,a,e,!1):S(t,a)):b(t,a,e,!1))):n||(a.reading=!1));return function(t){return!t.ended&&(t.needReadable||t.length<t.highWaterMark||0===t.length)}(a)}function b(t,e,r,n){e.flowing&&0===e.length&&!e.sync?(t.emit("data",r),t.read(0)):(e.length+=e.objectMode?1:r.length,n?e.buffer.unshift(r):e.buffer.push(r),e.needReadable&&E(t)),S(t,e)}Object.defineProperty(v.prototype,"destroyed",{get:function(){return void 0!==this._readableState&&this._readableState.destroyed},set:function(t){this._readableState&&(this._readableState.destroyed=t)}}),v.prototype.destroy=g.destroy,v.prototype._undestroy=g.undestroy,v.prototype._destroy=function(t,e){this.push(null),e(t)},v.prototype.push=function(t,e){var r,n=this._readableState;return n.objectMode?r=!0:"string"==typeof t&&((e=e||n.defaultEncoding)!==n.encoding&&(t=u.from(t,e),e=""),r=!0),x(this,t,e,!1,r)},v.prototype.unshift=function(t){return x(this,t,null,!0,!1)},v.prototype.isPaused=function(){return!1===this._readableState.flowing},v.prototype.setEncoding=function(t){return p||(p=r(51).StringDecoder),this._readableState.decoder=new p(t),this._readableState.encoding=t,this};var w=8388608;function T(t,e){return t<=0||0===e.length&&e.ended?0:e.objectMode?1:t!=t?e.flowing&&e.length?e.buffer.head.data.length:e.length:(t>e.highWaterMark&&(e.highWaterMark=function(t){return t>=w?t=w:(t--,t|=t>>>1,t|=t>>>2,t|=t>>>4,t|=t>>>8,t|=t>>>16,t++),t}(t)),t<=e.length?t:e.ended?e.length:(e.needReadable=!0,0))}function E(t){var e=t._readableState;e.needReadable=!1,e.emittedReadable||(d("emitReadable",e.flowing),e.emittedReadable=!0,e.sync?i.nextTick(C,t):C(t))}function C(t){d("emit readable"),t.emit("readable"),R(t)}function S(t,e){e.readingMore||(e.readingMore=!0,i.nextTick(A,t,e))}function A(t,e){for(var r=e.length;!e.reading&&!e.flowing&&!e.ended&&e.length<e.highWaterMark&&(d("maybeReadMore read 0"),t.read(0),r!==e.length);)r=e.length;e.readingMore=!1}function M(t){d("readable nexttick read 0"),t.read(0)}function P(t,e){e.reading||(d("resume read 0"),t.read(0)),e.resumeScheduled=!1,e.awaitDrain=0,t.emit("resume"),R(t),e.flowing&&!e.reading&&t.read(0)}function R(t){var e=t._readableState;for(d("flow",e.flowing);e.flowing&&null!==t.read(););}function L(t,e){return 0===e.length?null:(e.objectMode?r=e.buffer.shift():!t||t>=e.length?(r=e.decoder?e.buffer.join(""):1===e.buffer.length?e.buffer.head.data:e.buffer.concat(e.length),e.buffer.clear()):r=function(t,e,r){var n;t<e.head.data.length?(n=e.head.data.slice(0,t),e.head.data=e.head.data.slice(t)):n=t===e.head.data.length?e.shift():r?function(t,e){var r=e.head,n=1,i=r.data;t-=i.length;for(;r=r.next;){var o=r.data,a=t>o.length?o.length:t;if(a===o.length?i+=o:i+=o.slice(0,t),0===(t-=a)){a===o.length?(++n,r.next?e.head=r.next:e.head=e.tail=null):(e.head=r,r.data=o.slice(a));break}++n}return e.length-=n,i}(t,e):function(t,e){var r=u.allocUnsafe(t),n=e.head,i=1;n.data.copy(r),t-=n.data.length;for(;n=n.next;){var o=n.data,a=t>o.length?o.length:t;if(o.copy(r,r.length-t,0,a),0===(t-=a)){a===o.length?(++i,n.next?e.head=n.next:e.head=e.tail=null):(e.head=n,n.data=o.slice(a));break}++i}return e.length-=i,r}(t,e);return n}(t,e.buffer,e.decoder),r);var r}function O(t){var e=t._readableState;if(e.length>0)throw new Error('"endReadable()" called on non-empty stream');e.endEmitted||(e.ended=!0,i.nextTick(k,e,t))}function k(t,e){t.endEmitted||0!==t.length||(t.endEmitted=!0,e.readable=!1,e.emit("end"))}function D(t,e){for(var r=0,n=t.length;r<n;r++)if(t[r]===e)return r;return-1}v.prototype.read=function(t){d("read",t),t=parseInt(t,10);var e=this._readableState,r=t;if(0!==t&&(e.emittedReadable=!1),0===t&&e.needReadable&&(e.length>=e.highWaterMark||e.ended))return d("read: emitReadable",e.length,e.ended),0===e.length&&e.ended?O(this):E(this),null;if(0===(t=T(t,e))&&e.ended)return 0===e.length&&O(this),null;var n,i=e.needReadable;return d("need readable",i),(0===e.length||e.length-t<e.highWaterMark)&&d("length less than watermark",i=!0),e.ended||e.reading?d("reading or ended",i=!1):i&&(d("do read"),e.reading=!0,e.sync=!0,0===e.length&&(e.needReadable=!0),this._read(e.highWaterMark),e.sync=!1,e.reading||(t=T(r,e))),null===(n=t>0?L(t,e):null)?(e.needReadable=!0,t=0):e.length-=t,0===e.length&&(e.ended||(e.needReadable=!0),r!==t&&e.ended&&O(this)),null!==n&&this.emit("data",n),n},v.prototype._read=function(t){this.emit("error",new Error("_read() is not implemented"))},v.prototype.pipe=function(t,e){var r=this,o=this._readableState;switch(o.pipesCount){case 0:o.pipes=t;break;case 1:o.pipes=[o.pipes,t];break;default:o.pipes.push(t)}o.pipesCount+=1,d("pipe count=%d opts=%j",o.pipesCount,e);var h=(!e||!1!==e.end)&&t!==n.stdout&&t!==n.stderr?l:v;function u(e,n){d("onunpipe"),e===r&&n&&!1===n.hasUnpiped&&(n.hasUnpiped=!0,d("cleanup"),t.removeListener("close",_),t.removeListener("finish",y),t.removeListener("drain",c),t.removeListener("error",g),t.removeListener("unpipe",u),r.removeListener("end",l),r.removeListener("end",v),r.removeListener("data",m),f=!0,!o.awaitDrain||t._writableState&&!t._writableState.needDrain||c())}function l(){d("onend"),t.end()}o.endEmitted?i.nextTick(h):r.once("end",h),t.on("unpipe",u);var c=function(t){return function(){var e=t._readableState;d("pipeOnDrain",e.awaitDrain),e.awaitDrain&&e.awaitDrain--,0===e.awaitDrain&&s(t,"data")&&(e.flowing=!0,R(t))}}(r);t.on("drain",c);var f=!1;var p=!1;function m(e){d("ondata"),p=!1,!1!==t.write(e)||p||((1===o.pipesCount&&o.pipes===t||o.pipesCount>1&&-1!==D(o.pipes,t))&&!f&&(d("false write response, pause",r._readableState.awaitDrain),r._readableState.awaitDrain++,p=!0),r.pause())}function g(e){d("onerror",e),v(),t.removeListener("error",g),0===s(t,"error")&&t.emit("error",e)}function _(){t.removeListener("finish",y),v()}function y(){d("onfinish"),t.removeListener("close",_),v()}function v(){d("unpipe"),r.unpipe(t)}return r.on("data",m),function(t,e,r){if("function"==typeof t.prependListener)return t.prependListener(e,r);t._events&&t._events[e]?a(t._events[e])?t._events[e].unshift(r):t._events[e]=[r,t._events[e]]:t.on(e,r)}(t,"error",g),t.once("close",_),t.once("finish",y),t.emit("pipe",r),o.flowing||(d("pipe resume"),r.resume()),t},v.prototype.unpipe=function(t){var e=this._readableState,r={hasUnpiped:!1};if(0===e.pipesCount)return this;if(1===e.pipesCount)return t&&t!==e.pipes?this:(t||(t=e.pipes),e.pipes=null,e.pipesCount=0,e.flowing=!1,t&&t.emit("unpipe",this,r),this);if(!t){var n=e.pipes,i=e.pipesCount;e.pipes=null,e.pipesCount=0,e.flowing=!1;for(var o=0;o<i;o++)n[o].emit("unpipe",this,r);return this}var a=D(e.pipes,t);return-1===a?this:(e.pipes.splice(a,1),e.pipesCount-=1,1===e.pipesCount&&(e.pipes=e.pipes[0]),t.emit("unpipe",this,r),this)},v.prototype.on=function(t,e){var r=h.prototype.on.call(this,t,e);if("data"===t)!1!==this._readableState.flowing&&this.resume();else if("readable"===t){var n=this._readableState;n.endEmitted||n.readableListening||(n.readableListening=n.needReadable=!0,n.emittedReadable=!1,n.reading?n.length&&E(this):i.nextTick(M,this))}return r},v.prototype.addListener=v.prototype.on,v.prototype.resume=function(){var t=this._readableState;return t.flowing||(d("resume"),t.flowing=!0,function(t,e){e.resumeScheduled||(e.resumeScheduled=!0,i.nextTick(P,t,e))}(this,t)),this},v.prototype.pause=function(){return d("call pause flowing=%j",this._readableState.flowing),!1!==this._readableState.flowing&&(d("pause"),this._readableState.flowing=!1,this.emit("pause")),this},v.prototype.wrap=function(t){var e=this,r=this._readableState,n=!1;for(var i in t.on("end",function(){if(d("wrapped end"),r.decoder&&!r.ended){var t=r.decoder.end();t&&t.length&&e.push(t)}e.push(null)}),t.on("data",function(i){(d("wrapped data"),r.decoder&&(i=r.decoder.write(i)),!r.objectMode||null!==i&&void 0!==i)&&((r.objectMode||i&&i.length)&&(e.push(i)||(n=!0,t.pause())))}),t)void 0===this[i]&&"function"==typeof t[i]&&(this[i]=function(e){return function(){return t[e].apply(t,arguments)}}(i));for(var o=0;o<_.length;o++)t.on(_[o],this.emit.bind(this,_[o]));return this._read=function(e){d("wrapped _read",e),n&&(n=!1,t.resume())},this},v._fromList=L}).call(this,r(3),r(6))},function(t,e,r){t.exports=r(117)},function(t,e){var r={}.toString;t.exports=Array.isArray||function(t){return"[object Array]"==r.call(t)}},function(t,e){t.exports=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}},function(t,e){t.exports=function(t,e){var r=e[0],n=e[1],i=e[2],o=r*r+n*n+i*i;o>0&&(o=1/Math.sqrt(o),t[0]=e[0]*o,t[1]=e[1]*o,t[2]=e[2]*o);return t}},function(t,e,r){"use strict";var n=r(148);function i(t,e,r,n,i){this.properties={},this.extent=r,this.type=0,this._pbf=t,this._geometry=-1,this._keys=n,this._values=i,t.readFields(o,this,e)}function o(t,e,r){1==t?e.id=r.readVarint():2==t?function(t,e){var r=t.readVarint()+t.pos;for(;t.pos<r;){var n=e._keys[t.readVarint()],i=e._values[t.readVarint()];e.properties[n]=i}}(r,e):3==t?e.type=r.readVarint():4==t&&(e._geometry=r.pos)}function a(t){for(var e,r,n=0,i=0,o=t.length,a=o-1;i<o;a=i++)e=t[i],n+=((r=t[a]).x-e.x)*(e.y+r.y);return n}t.exports=i,i.types=["Unknown","Point","LineString","Polygon"],i.prototype.loadGeometry=function(){var t=this._pbf;t.pos=this._geometry;for(var e,r=t.readVarint()+t.pos,i=1,o=0,a=0,s=0,h=[];t.pos<r;){if(o<=0){var u=t.readVarint();i=7&u,o=u>>3}if(o--,1===i||2===i)a+=t.readSVarint(),s+=t.readSVarint(),1===i&&(e&&h.push(e),e=[]),e.push(new n(a,s));else{if(7!==i)throw new Error("unknown command "+i);e&&e.push(e[0].clone())}}return e&&h.push(e),h},i.prototype.bbox=function(){var t=this._pbf;t.pos=this._geometry;for(var e=t.readVarint()+t.pos,r=1,n=0,i=0,o=0,a=1/0,s=-1/0,h=1/0,u=-1/0;t.pos<e;){if(n<=0){var l=t.readVarint();r=7&l,n=l>>3}if(n--,1===r||2===r)i+=t.readSVarint(),o+=t.readSVarint(),i<a&&(a=i),i>s&&(s=i),o<h&&(h=o),o>u&&(u=o);else if(7!==r)throw new Error("unknown command "+r)}return[a,h,s,u]},i.prototype.toGeoJSON=function(t,e,r){var n,o,s=this.extent*Math.pow(2,r),h=this.extent*t,u=this.extent*e,l=this.loadGeometry(),c=i.types[this.type];function f(t){for(var e=0;e<t.length;e++){var r=t[e],n=180-360*(r.y+u)/s;t[e]=[360*(r.x+h)/s-180,360/Math.PI*Math.atan(Math.exp(n*Math.PI/180))-90]}}switch(this.type){case 1:var d=[];for(n=0;n<l.length;n++)d[n]=l[n][0];f(l=d);break;case 2:for(n=0;n<l.length;n++)f(l[n]);break;case 3:for(l=function(t){var e=t.length;if(e<=1)return[t];for(var r,n,i=[],o=0;o<e;o++){var s=a(t[o]);0!==s&&(void 0===n&&(n=s<0),n===s<0?(r&&i.push(r),r=[t[o]]):r.push(t[o]))}r&&i.push(r);return i}(l),n=0;n<l.length;n++)for(o=0;o<l[n].length;o++)f(l[n][o])}1===l.length?l=l[0]:c="Multi"+c;var p={type:"Feature",geometry:{type:c,coordinates:l},properties:this.properties};return"id"in this&&(p.id=this.id),p}},function(t,e,r){"use strict";var n=r(60);function i(t,e){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=t,this._keys=[],this._values=[],this._features=[],t.readFields(o,this,e),this.length=this._features.length}function o(t,e,r){15===t?e.version=r.readVarint():1===t?e.name=r.readString():5===t?e.extent=r.readVarint():2===t?e._features.push(r.pos):3===t?e._keys.push(r.readString()):4===t&&e._values.push(function(t){var e=null,r=t.readVarint()+t.pos;for(;t.pos<r;){var n=t.readVarint()>>3;e=1===n?t.readString():2===n?t.readFloat():3===n?t.readDouble():4===n?t.readVarint64():5===n?t.readVarint():6===n?t.readSVarint():7===n?t.readBoolean():null}return e}(r))}t.exports=i,i.prototype.feature=function(t){if(t<0||t>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[t];var e=this._pbf.readVarint()+this._pbf.pos;return new n(this._pbf,e,this.extent,this._keys,this._values)}},function(t,e,r){"use strict";function n(){if(!(this instanceof n))return new n;if(arguments.length)throw new Error("The constructor with parameters has been removed in JSZip 3.0, please check the upgrade guide.");this.files={},this.comment=null,this.root="",this.clone=function(){var t=new n;for(var e in this)"function"!=typeof this[e]&&(t[e]=this[e]);return t}}n.prototype=r(120),n.prototype.loadAsync=r(74),n.support=r(5),n.defaults=r(43),n.version="3.1.5",n.loadAsync=function(t,e){return(new n).loadAsync(t,e)},n.external=r(10),t.exports=n},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=new o.default(t);return r.build(),r.collectFaces(e.skipTriangulation)};var n,i=r(138),o=(n=i)&&n.__esModule?n:{default:n};t.exports=e.default},function(t,e,r){"use strict";t.exports=_;var n,i=r(144),o=r(142),a=r(139),s=(n="function"==typeof Symbol?function(t){return Symbol(t)}:function(t){return"_"+t})("max"),h=n("length"),u=n("lengthCalculator"),l=n("allowStale"),c=n("maxAge"),f=n("dispose"),d=n("noDisposeOnSet"),p=n("lruList"),m=n("cache");function g(){return 1}function _(t){if(!(this instanceof _))return new _(t);"number"==typeof t&&(t={max:t}),t||(t={});var e=this[s]=t.max;(!e||"number"!=typeof e||e<=0)&&(this[s]=1/0);var r=t.length||g;"function"!=typeof r&&(r=g),this[u]=r,this[l]=t.stale||!1,this[c]=t.maxAge||0,this[f]=t.dispose,this[d]=t.noDisposeOnSet||!1,this.reset()}function y(t,e,r,n){var i=r.value;x(t,i)&&(w(t,r),t[l]||(i=void 0)),i&&e.call(n,i.value,i.key,t)}function v(t,e,r){var n=t[m].get(e);if(n){var i=n.value;x(t,i)?(w(t,n),t[l]||(i=void 0)):r&&t[p].unshiftNode(n),i&&(i=i.value)}return i}function x(t,e){if(!e||!e.maxAge&&!t[c])return!1;var r=Date.now()-e.now;return e.maxAge?r>e.maxAge:t[c]&&r>t[c]}function b(t){if(t[h]>t[s])for(var e=t[p].tail;t[h]>t[s]&&null!==e;){var r=e.prev;w(t,e),e=r}}function w(t,e){if(e){var r=e.value;t[f]&&t[f](r.key,r.value),t[h]-=r.length,t[m].delete(r.key),t[p].removeNode(e)}}Object.defineProperty(_.prototype,"max",{set:function(t){(!t||"number"!=typeof t||t<=0)&&(t=1/0),this[s]=t,b(this)},get:function(){return this[s]},enumerable:!0}),Object.defineProperty(_.prototype,"allowStale",{set:function(t){this[l]=!!t},get:function(){return this[l]},enumerable:!0}),Object.defineProperty(_.prototype,"maxAge",{set:function(t){(!t||"number"!=typeof t||t<0)&&(t=0),this[c]=t,b(this)},get:function(){return this[c]},enumerable:!0}),Object.defineProperty(_.prototype,"lengthCalculator",{set:function(t){"function"!=typeof t&&(t=g),t!==this[u]&&(this[u]=t,this[h]=0,this[p].forEach(function(t){t.length=this[u](t.value,t.key),this[h]+=t.length},this)),b(this)},get:function(){return this[u]},enumerable:!0}),Object.defineProperty(_.prototype,"length",{get:function(){return this[h]},enumerable:!0}),Object.defineProperty(_.prototype,"itemCount",{get:function(){return this[p].length},enumerable:!0}),_.prototype.rforEach=function(t,e){e=e||this;for(var r=this[p].tail;null!==r;){var n=r.prev;y(this,t,r,e),r=n}},_.prototype.forEach=function(t,e){e=e||this;for(var r=this[p].head;null!==r;){var n=r.next;y(this,t,r,e),r=n}},_.prototype.keys=function(){return this[p].toArray().map(function(t){return t.key},this)},_.prototype.values=function(){return this[p].toArray().map(function(t){return t.value},this)},_.prototype.reset=function(){this[f]&&this[p]&&this[p].length&&this[p].forEach(function(t){this[f](t.key,t.value)},this),this[m]=new i,this[p]=new a,this[h]=0},_.prototype.dump=function(){return this[p].map(function(t){if(!x(this,t))return{k:t.key,v:t.value,e:t.now+(t.maxAge||0)}},this).toArray().filter(function(t){return t})},_.prototype.dumpLru=function(){return this[p]},_.prototype.inspect=function(t,e){var r="LRUCache {",n=!1;this[l]&&(r+="\n  allowStale: true",n=!0);var i=this[s];i&&i!==1/0&&(n&&(r+=","),r+="\n  max: "+o.inspect(i,e),n=!0);var a=this[c];a&&(n&&(r+=","),r+="\n  maxAge: "+o.inspect(a,e),n=!0);var f=this[u];f&&f!==g&&(n&&(r+=","),r+="\n  length: "+o.inspect(this[h],e),n=!0);var d=!1;return this[p].forEach(function(t){d?r+=",\n  ":(n&&(r+=",\n"),d=!0,r+="\n  ");var i=o.inspect(t.key).split("\n").join("\n  "),s={value:t.value};t.maxAge!==a&&(s.maxAge=t.maxAge),f!==g&&(s.length=t.length),x(this,t)&&(s.stale=!0),s=o.inspect(s,e).split("\n").join("\n  "),r+=i+" => "+s}),(d||n)&&(r+="\n"),r+="}"},_.prototype.set=function(t,e,r){var n=(r=r||this[c])?Date.now():0,i=this[u](e,t);if(this[m].has(t)){if(i>this[s])return w(this,this[m].get(t)),!1;var o=this[m].get(t).value;return this[f]&&(this[d]||this[f](t,o.value)),o.now=n,o.maxAge=r,o.value=e,this[h]+=i-o.length,o.length=i,this.get(t),b(this),!0}var a=new function(t,e,r,n,i){this.key=t,this.value=e,this.length=r,this.now=n,this.maxAge=i||0}(t,e,i,n,r);return a.length>this[s]?(this[f]&&this[f](t,e),!1):(this[h]+=a.length,this[p].unshift(a),this[m].set(t,this[p].head),b(this),!0)},_.prototype.has=function(t){return!!this[m].has(t)&&!x(this,this[m].get(t).value)},_.prototype.get=function(t){return v(this,t,!0)},_.prototype.peek=function(t){return v(this,t,!1)},_.prototype.pop=function(){var t=this[p].tail;return t?(w(this,t),t.value):null},_.prototype.del=function(t){w(this,this[m].get(t))},_.prototype.load=function(t){this.reset();for(var e=Date.now(),r=t.length-1;r>=0;r--){var n=t[r],i=n.e||0;if(0===i)this.set(n.k,n.v);else{var o=i-e;o>0&&this.set(n.k,n.v,o)}}},_.prototype.prune=function(){var t=this;this[m].forEach(function(e,r){v(t,r,!1)})}},function(t,e,r){"use strict";t.exports=i;var n=r(147);function i(t){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(t)?t:new Uint8Array(t||0),this.pos=0,this.type=0,this.length=this.buf.length}i.Varint=0,i.Fixed64=1,i.Bytes=2,i.Fixed32=5;function o(t){return t.type===i.Bytes?t.readVarint()+t.pos:t.pos+1}function a(t,e,r){return r?4294967296*e+(t>>>0):4294967296*(e>>>0)+(t>>>0)}function s(t,e,r){var n=e<=16383?1:e<=2097151?2:e<=268435455?3:Math.ceil(Math.log(e)/(7*Math.LN2));r.realloc(n);for(var i=r.pos-1;i>=t;i--)r.buf[i+n]=r.buf[i]}function h(t,e){for(var r=0;r<t.length;r++)e.writeVarint(t[r])}function u(t,e){for(var r=0;r<t.length;r++)e.writeSVarint(t[r])}function l(t,e){for(var r=0;r<t.length;r++)e.writeFloat(t[r])}function c(t,e){for(var r=0;r<t.length;r++)e.writeDouble(t[r])}function f(t,e){for(var r=0;r<t.length;r++)e.writeBoolean(t[r])}function d(t,e){for(var r=0;r<t.length;r++)e.writeFixed32(t[r])}function p(t,e){for(var r=0;r<t.length;r++)e.writeSFixed32(t[r])}function m(t,e){for(var r=0;r<t.length;r++)e.writeFixed64(t[r])}function g(t,e){for(var r=0;r<t.length;r++)e.writeSFixed64(t[r])}function _(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16)+16777216*t[e+3]}function y(t,e,r){t[r]=e,t[r+1]=e>>>8,t[r+2]=e>>>16,t[r+3]=e>>>24}function v(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16)+(t[e+3]<<24)}i.prototype={destroy:function(){this.buf=null},readFields:function(t,e,r){for(r=r||this.length;this.pos<r;){var n=this.readVarint(),i=n>>3,o=this.pos;this.type=7&n,t(i,e,this),this.pos===o&&this.skip(n)}return e},readMessage:function(t,e){return this.readFields(t,e,this.readVarint()+this.pos)},readFixed32:function(){var t=_(this.buf,this.pos);return this.pos+=4,t},readSFixed32:function(){var t=v(this.buf,this.pos);return this.pos+=4,t},readFixed64:function(){var t=_(this.buf,this.pos)+4294967296*_(this.buf,this.pos+4);return this.pos+=8,t},readSFixed64:function(){var t=_(this.buf,this.pos)+4294967296*v(this.buf,this.pos+4);return this.pos+=8,t},readFloat:function(){var t=n.read(this.buf,this.pos,!0,23,4);return this.pos+=4,t},readDouble:function(){var t=n.read(this.buf,this.pos,!0,52,8);return this.pos+=8,t},readVarint:function(t){var e,r,n=this.buf;return e=127&(r=n[this.pos++]),r<128?e:(e|=(127&(r=n[this.pos++]))<<7,r<128?e:(e|=(127&(r=n[this.pos++]))<<14,r<128?e:(e|=(127&(r=n[this.pos++]))<<21,r<128?e:function(t,e,r){var n,i,o=r.buf;if(i=o[r.pos++],n=(112&i)>>4,i<128)return a(t,n,e);if(i=o[r.pos++],n|=(127&i)<<3,i<128)return a(t,n,e);if(i=o[r.pos++],n|=(127&i)<<10,i<128)return a(t,n,e);if(i=o[r.pos++],n|=(127&i)<<17,i<128)return a(t,n,e);if(i=o[r.pos++],n|=(127&i)<<24,i<128)return a(t,n,e);if(i=o[r.pos++],n|=(1&i)<<31,i<128)return a(t,n,e);throw new Error("Expected varint not more than 10 bytes")}(e|=(15&(r=n[this.pos]))<<28,t,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var t=this.readVarint();return t%2==1?(t+1)/-2:t/2},readBoolean:function(){return Boolean(this.readVarint())},readString:function(){var t=this.readVarint()+this.pos,e=function(t,e,r){var n="",i=e;for(;i<r;){var o,a,s,h=t[i],u=null,l=h>239?4:h>223?3:h>191?2:1;if(i+l>r)break;1===l?h<128&&(u=h):2===l?128==(192&(o=t[i+1]))&&(u=(31&h)<<6|63&o)<=127&&(u=null):3===l?(o=t[i+1],a=t[i+2],128==(192&o)&&128==(192&a)&&((u=(15&h)<<12|(63&o)<<6|63&a)<=2047||u>=55296&&u<=57343)&&(u=null)):4===l&&(o=t[i+1],a=t[i+2],s=t[i+3],128==(192&o)&&128==(192&a)&&128==(192&s)&&((u=(15&h)<<18|(63&o)<<12|(63&a)<<6|63&s)<=65535||u>=1114112)&&(u=null)),null===u?(u=65533,l=1):u>65535&&(u-=65536,n+=String.fromCharCode(u>>>10&1023|55296),u=56320|1023&u),n+=String.fromCharCode(u),i+=l}return n}(this.buf,this.pos,t);return this.pos=t,e},readBytes:function(){var t=this.readVarint()+this.pos,e=this.buf.subarray(this.pos,t);return this.pos=t,e},readPackedVarint:function(t,e){var r=o(this);for(t=t||[];this.pos<r;)t.push(this.readVarint(e));return t},readPackedSVarint:function(t){var e=o(this);for(t=t||[];this.pos<e;)t.push(this.readSVarint());return t},readPackedBoolean:function(t){var e=o(this);for(t=t||[];this.pos<e;)t.push(this.readBoolean());return t},readPackedFloat:function(t){var e=o(this);for(t=t||[];this.pos<e;)t.push(this.readFloat());return t},readPackedDouble:function(t){var e=o(this);for(t=t||[];this.pos<e;)t.push(this.readDouble());return t},readPackedFixed32:function(t){var e=o(this);for(t=t||[];this.pos<e;)t.push(this.readFixed32());return t},readPackedSFixed32:function(t){var e=o(this);for(t=t||[];this.pos<e;)t.push(this.readSFixed32());return t},readPackedFixed64:function(t){var e=o(this);for(t=t||[];this.pos<e;)t.push(this.readFixed64());return t},readPackedSFixed64:function(t){var e=o(this);for(t=t||[];this.pos<e;)t.push(this.readSFixed64());return t},skip:function(t){var e=7&t;if(e===i.Varint)for(;this.buf[this.pos++]>127;);else if(e===i.Bytes)this.pos=this.readVarint()+this.pos;else if(e===i.Fixed32)this.pos+=4;else{if(e!==i.Fixed64)throw new Error("Unimplemented type: "+e);this.pos+=8}},writeTag:function(t,e){this.writeVarint(t<<3|e)},realloc:function(t){for(var e=this.length||16;e<this.pos+t;)e*=2;if(e!==this.length){var r=new Uint8Array(e);r.set(this.buf),this.buf=r,this.length=e}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(t){this.realloc(4),y(this.buf,t,this.pos),this.pos+=4},writeSFixed32:function(t){this.realloc(4),y(this.buf,t,this.pos),this.pos+=4},writeFixed64:function(t){this.realloc(8),y(this.buf,-1&t,this.pos),y(this.buf,Math.floor(t*(1/4294967296)),this.pos+4),this.pos+=8},writeSFixed64:function(t){this.realloc(8),y(this.buf,-1&t,this.pos),y(this.buf,Math.floor(t*(1/4294967296)),this.pos+4),this.pos+=8},writeVarint:function(t){(t=+t||0)>268435455||t<0?function(t,e){var r,n;t>=0?(r=t%4294967296|0,n=t/4294967296|0):(n=~(-t/4294967296),4294967295^(r=~(-t%4294967296))?r=r+1|0:(r=0,n=n+1|0));if(t>=0x10000000000000000||t<-0x10000000000000000)throw new Error("Given varint doesn't fit into 10 bytes");e.realloc(10),function(t,e,r){r.buf[r.pos++]=127&t|128,t>>>=7,r.buf[r.pos++]=127&t|128,t>>>=7,r.buf[r.pos++]=127&t|128,t>>>=7,r.buf[r.pos++]=127&t|128,t>>>=7,r.buf[r.pos]=127&t}(r,0,e),function(t,e){var r=(7&t)<<4;if(e.buf[e.pos++]|=r|((t>>>=3)?128:0),!t)return;if(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),!t)return;if(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),!t)return;if(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),!t)return;if(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),!t)return;e.buf[e.pos++]=127&t}(n,e)}(t,this):(this.realloc(4),this.buf[this.pos++]=127&t|(t>127?128:0),t<=127||(this.buf[this.pos++]=127&(t>>>=7)|(t>127?128:0),t<=127||(this.buf[this.pos++]=127&(t>>>=7)|(t>127?128:0),t<=127||(this.buf[this.pos++]=t>>>7&127))))},writeSVarint:function(t){this.writeVarint(t<0?2*-t-1:2*t)},writeBoolean:function(t){this.writeVarint(Boolean(t))},writeString:function(t){t=String(t),this.realloc(4*t.length),this.pos++;var e=this.pos;this.pos=function(t,e,r){for(var n,i,o=0;o<e.length;o++){if((n=e.charCodeAt(o))>55295&&n<57344){if(!i){n>56319||o+1===e.length?(t[r++]=239,t[r++]=191,t[r++]=189):i=n;continue}if(n<56320){t[r++]=239,t[r++]=191,t[r++]=189,i=n;continue}n=i-55296<<10|n-56320|65536,i=null}else i&&(t[r++]=239,t[r++]=191,t[r++]=189,i=null);n<128?t[r++]=n:(n<2048?t[r++]=n>>6|192:(n<65536?t[r++]=n>>12|224:(t[r++]=n>>18|240,t[r++]=n>>12&63|128),t[r++]=n>>6&63|128),t[r++]=63&n|128)}return r}(this.buf,t,this.pos);var r=this.pos-e;r>=128&&s(e,r,this),this.pos=e-1,this.writeVarint(r),this.pos+=r},writeFloat:function(t){this.realloc(4),n.write(this.buf,t,this.pos,!0,23,4),this.pos+=4},writeDouble:function(t){this.realloc(8),n.write(this.buf,t,this.pos,!0,52,8),this.pos+=8},writeBytes:function(t){var e=t.length;this.writeVarint(e),this.realloc(e);for(var r=0;r<e;r++)this.buf[this.pos++]=t[r]},writeRawMessage:function(t,e){this.pos++;var r=this.pos;t(e,this);var n=this.pos-r;n>=128&&s(r,n,this),this.pos=r-1,this.writeVarint(n),this.pos+=n},writeMessage:function(t,e,r){this.writeTag(t,i.Bytes),this.writeRawMessage(e,r)},writePackedVarint:function(t,e){this.writeMessage(t,h,e)},writePackedSVarint:function(t,e){this.writeMessage(t,u,e)},writePackedBoolean:function(t,e){this.writeMessage(t,f,e)},writePackedFloat:function(t,e){this.writeMessage(t,l,e)},writePackedDouble:function(t,e){this.writeMessage(t,c,e)},writePackedFixed32:function(t,e){this.writeMessage(t,d,e)},writePackedSFixed32:function(t,e){this.writeMessage(t,p,e)},writePackedFixed64:function(t,e){this.writeMessage(t,m,e)},writePackedSFixed64:function(t,e){this.writeMessage(t,g,e)},writeBytesField:function(t,e){this.writeTag(t,i.Bytes),this.writeBytes(e)},writeFixed32Field:function(t,e){this.writeTag(t,i.Fixed32),this.writeFixed32(e)},writeSFixed32Field:function(t,e){this.writeTag(t,i.Fixed32),this.writeSFixed32(e)},writeFixed64Field:function(t,e){this.writeTag(t,i.Fixed64),this.writeFixed64(e)},writeSFixed64Field:function(t,e){this.writeTag(t,i.Fixed64),this.writeSFixed64(e)},writeVarintField:function(t,e){this.writeTag(t,i.Varint),this.writeVarint(e)},writeSVarintField:function(t,e){this.writeTag(t,i.Varint),this.writeSVarint(e)},writeStringField:function(t,e){this.writeTag(t,i.Bytes),this.writeString(e)},writeFloatField:function(t,e){this.writeTag(t,i.Fixed32),this.writeFloat(e)},writeDoubleField:function(t,e){this.writeTag(t,i.Fixed64),this.writeDouble(e)},writeBooleanField:function(t,e){this.writeVarintField(t,Boolean(e))}}},function(t,e,r){t.exports.VectorTile=r(149),t.exports.VectorTileFeature=r(60),t.exports.VectorTileLayer=r(61)},function(t,e,r){"use strict";e.a={get:function(t){var e=new XMLHttpRequest;e.open("get",t.url),e.responseType=t.responseType||"text",t.onprogress&&(e.onprogress=function(e){if(e.lengthComputable){var r=e.loaded/e.total;t.onprogress(r,e.loaded,e.total)}else t.onprogress(null)}),e.onload=function(r){e.status>=400?t.onerror&&t.onerror():t.onload&&t.onload(e.response)},t.onerror&&(e.onerror=t.onerror),e.send(null)}}},function(t,e,r){"use strict";r.r(e);var n=r(17),i=r.n(n);function o(t,e){const r=e[0],n=e[1],i=Math.sqrt(r*r+n*n);return t[0]=r/i,t[1]=n/i,t}function a(t,e,r,n){return t[0]=e[0]+r[0]*n,t[1]=e[1]+r[1]*n,t[2]=e[2]+r[2]*n,t}function s(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t}function h(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t}function u(t,e){const r=e[0],n=e[1],i=e[2],o=Math.sqrt(r*r+n*n+i*i);return t[0]=r/o,t[1]=n/o,t[2]=i/o,t}const l=[];function c(t,e,r,n){const i=(s=r,(o=e)[0]*s[0]+o[1]*s[1]+o[2]*s[2]);var o,s;const h=Math.acos(i)*n;return a(l,r,e,-i),function(t,e){const r=e[0],n=e[1],i=e[2],o=Math.sqrt(r*r+n*n+i*i);t[0]=r/o,t[1]=n/o,t[2]=i/o}(l,l),function(t,e,r){t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r}(t,e,Math.cos(h)),a(t,t,l,Math.sin(h)),t}function f(t,e,r){if(r-e<3)return 0;let n=0;for(let i=2*(r-1),o=2*e;o<2*r;){const e=t[i],r=t[i+1],a=t[o],s=t[o+1];i=o,o+=2,n+=e*s-a*r}return n}function d(t,e,r=2){return i()(t,e,r)}const p=[],m=[],g=[];function _(t,e,r,n,i,a,h,u){const l=null!=h;let c=i,f=null;l&&(f=new Uint32Array(n-r));for(let i=r;i<n;i++){const y=i===n-1?r:i+1,v=i===r?n-1:i-1,x=t[2*v],b=t[2*v+1],w=t[2*i],T=t[2*i+1],E=t[2*y],C=t[2*y+1];if(p[0]=w-x,p[1]=T-b,m[0]=E-w,m[1]=C-T,o(p,p),o(m,m),l&&(f[i]=c),u||i!==r)if(u||i!==n-1){s(g,m,p);const t=g[1];g[1]=-g[0],g[0]=t,o(g,g);const r=(_=m,(d=g)[0]*_[0]+d[1]*_[1]),n=Math.sqrt(1-r*r),i=a*Math.min(10,1/n);if(l&&1/n>h&&a*r<0){const t=w+g[0]*a,r=T+g[1]*a,i=Math.acos(n)/2,o=Math.tan(i)*Math.abs(a);e[2*c]=t+g[1]*o,e[2*c+1]=r-g[0]*o,e[2*++c]=t-g[1]*o,e[2*c+1]=r+g[0]*o,c++}else e[2*c]=w+g[0]*i,e[2*c+1]=T+g[1]*i,c++}else g[0]=p[1],g[1]=-p[0],o(g,g),e[2*c]=w+g[0]*a,e[2*c+1]=T+g[1]*a,c++;else g[0]=m[1],g[1]=-m[0],o(g,g),e[2*c]=w+g[0]*a,e[2*c+1]=T+g[1]*a,c++}var d,_;return f}function y(t,e,r,n,i){const o=null!=n?[]:new Float32Array(t.length);if(_(t,o,0,e&&e.length?e[0]:t.length/2,0,r,n,i),e)for(let a=0;a<e.length;a++){const s=e[a];_(t,o,s,e[a+1]||t.length/2,null!=n?o.length/2:s,r,n,i)}return o}function v(t,e,r,n){for(let i=0;i<Math.floor((n-r)/2);i++)for(let o=0;o<e;o++){const a=(i+r)*e+o,s=(n-i-1)*e+o,h=t[a];t[a]=t[s],t[s]=h}return t}function x(t,e){let r=t.length/2,n=0,i=e&&e.length?e[0]:r;f(t,n,i)>0&&v(t,2,n,i);for(let o=1;o<(e?e.length:0)+1;o++)f(t,n=e[o-1],i=e[o]||r)<0&&v(t,2,n,i)}function b(t){t.depth=t.depth||1,t.bevelSize=t.bevelSize||0,t.bevelSegments=null==t.bevelSegments?2:t.bevelSegments,t.smoothSide=t.smoothSide||!1,t.smoothBevel=t.smoothBevel||!1,"number"==typeof t.depth&&(t.bevelSize=Math.min(t.bevelSegments>0?t.bevelSize:0,t.depth/2)),t.bevelSize>0||(t.bevelSegments=0),t.bevelSegments=Math.round(t.bevelSegments);const e=t.boundingRect;if(t.translate=t.translate||[0,0],t.scale=t.scale||[1,1],t.fitRect){let r=null==t.fitRect.x?e.x||0:t.fitRect.x,n=null==t.fitRect.y?e.y||0:t.fitRect.y,i=t.fitRect.width,o=t.fitRect.height;null==i?null!=o?i=o/e.height*e.width:(i=e.width,o=e.height):null==o&&(o=i/e.width*e.height),t.scale=[i/e.width,o/e.height],t.translate=[(r-e.x)*t.scale[0],(n-e.y)*t.scale[1]]}}const w=[[0,0],[1,0],[1,1],[0,0],[1,1],[0,1]];function T(t,{vertices:e,topVertices:r,depth:n,rect:i},o,a,s,h){const u=a-o,l=h.smoothSide?1:2,f=u*l,d=h.smoothBevel?1:2,p=Math.min(n/2,h.bevelSize),m=h.bevelSegments,g=s.vertex,_=Math.max(i.width,i.height);if(p>0){const i=[0,0,1],a=[],h=[0,0,-1],y=[];let v=0,x=new Float32Array(u);for(let b=0;b<2;b++){const T=0===b?n-p:p;for(let n=0;n<=m*d;n++){let E,C,S=0;for(let A=0;A<u;A++){for(let g=0;g<l;g++){let l=2*((A+g)%u+o);a[0]=e[l]-r[l],a[1]=e[l+1]-r[l+1],a[2]=0;const v=Math.sqrt(a[0]*a[0]+a[1]*a[1]);a[0]/=v,a[1]/=v;const w=(Math.floor(n/d)+n%d)/m;0===b?c(y,i,a,w):c(y,a,h,w);const M=0===b?w:1-w,P=p*Math.sin(M*Math.PI/2),R=v*Math.cos(M*Math.PI/2),L=p*v/Math.sqrt(P*P+R*R),O=y[0]*L+r[l],k=y[1]*L+r[l+1],D=y[2]*L+T;if(t.position[3*s.vertex]=O,t.position[3*s.vertex+1]=k,t.position[3*s.vertex+2]=D,(A>0||g>0)&&(S+=Math.sqrt((E-O)*(E-O)+(C-k)*(C-k))),n>0||b>0){let e=3*(s.vertex-f),r=t.position[e],n=t.position[e+1],i=t.position[e+2];x[A]+=Math.sqrt((r-O)*(r-O)+(n-k)*(n-k)+(i-D)*(i-D))}t.uv[2*s.vertex]=S/_,t.uv[2*s.vertex+1]=x[A]/_,E=O,C=k,s.vertex++}if(d>1&&n%d||1===d&&n>=1)for(let e=0;e<6;e++){const r=(w[e][0]+A*l)%f,n=w[e][1]+v;t.indices[s.index++]=(n-1)*f+r+g}}v++}}}else for(let r=0;r<2;r++){const i=0===r?n-p:p;let a,h,c=0;for(let r=0;r<u;r++)for(let n=0;n<l;n++){const l=2*((r+n)%u+o),f=e[l],d=e[l+1];t.position[3*s.vertex]=f,t.position[3*s.vertex+1]=d,t.position[3*s.vertex+2]=i,(r>0||n>0)&&(c+=Math.sqrt((a-f)*(a-f)+(h-d)*(h-d))),t.uv[2*s.vertex]=c/_,t.uv[2*s.vertex+1]=i/_,a=f,h=d,s.vertex++}}const y=p>0?m*d+1:1;for(let e=0;e<u;e++)for(let r=0;r<6;r++){const n=(w[r][0]+e*l)%f,i=w[r][1]+y;t.indices[s.index++]=(i-1)*f+n+g}}function E({indices:t,vertices:e,topVertices:r,rect:n,depth:i},o,a,s){if(e.length<=4)return;const h=a.vertex,u=t.length;for(let e=0;e<u;e++)o.indices[a.index++]=h+t[e];const l=Math.max(n.width,n.height);for(let t=0;t<2;t++)for(let e=0;e<r.length;e+=2){const s=r[e],h=r[e+1];o.position[3*a.vertex]=s,o.position[3*a.vertex+1]=h,o.position[3*a.vertex+2]=(1-t)*i,o.uv[2*a.vertex]=(s-n.x)/l,o.uv[2*a.vertex+1]=(h-n.y)/l,a.vertex++}const c=e.length/2;for(let e=0;e<u;e+=3)for(let r=0;r<3;r++)o.indices[a.index++]=h+c+t[e+2-r]}function C(t,e){let r=0,n=0;for(let i=0;i<t.length;i++){const{indices:o,vertices:a,holes:s,depth:h}=t[i],u=a.length/2,l=Math.min(h/2,e.bevelSize)>0?e.bevelSegments:0;r+=2*o.length,n+=2*u;const c=2+2*l;let f=0,d=0;for(let t=0;t<(s?s.length:0)+1;t++){0===t?d=s&&s.length?s[0]:u:(f=s[t-1],d=s[t]||u),r+=6*(d-f)*(c-1);const i=(d-f)*(e.smoothSide?1:2);n+=i*c+(e.smoothBevel?0:l*i*2)}}const i={position:new Float32Array(3*n),indices:new(n>65535?Uint32Array:Uint16Array)(r),uv:new Float32Array(2*n)},o={vertex:0,index:0};for(let e=0;e<t.length;e++)E(t[e],i,o);for(let r=0;r<t.length;r++){const{holes:n,vertices:a}=t[r],s=a.length/2;let h=0,u=n&&n.length?n[0]:s;if(T(i,t[r],h,u,o,e),n)for(let a=0;a<n.length;a++)h=n[a],u=n[a+1]||s,T(i,t[r],h,u,o,e)}for(let t=0;t<i.uv.length;t++){const e=i.uv[t];e>0&&Math.round(e)===e?i.uv[t]=1:i.uv[t]=e%1}return i.normal=function(t,e){function r(t,e,r,n){t[0]=e,t[1]=r,t[2]=n}const n=[],i=[],o=[],a=[],s=[],l=[],c=t.length,f=new Float32Array(e.length);for(let u=0;u<c;){const c=3*t[u++],w=3*t[u++],T=3*t[u++];r(n,e[c],e[c+1],e[c+2]),r(i,e[w],e[w+1],e[w+2]),r(o,e[T],e[T+1],e[T+2]),h(a,n,i),h(s,i,o),d=l,m=s,g=(p=a)[0],_=p[1],y=p[2],v=m[0],x=m[1],b=m[2],d[0]=_*b-y*x,d[1]=y*v-g*b,d[2]=g*x-_*v;for(let t=0;t<3;t++)f[c+t]=f[c+t]+l[t],f[w+t]=f[w+t]+l[t],f[T+t]=f[T+t]+l[t]}for(var d,p,m,g,_,y,v,x,b,w=0;w<f.length;)r(l,f[w],f[w+1],f[w+2]),u(l,l),f[w++]=l[0],f[w++]=l[1],f[w++]=l[2];return f}(i.indices,i.position),i.boundingRect=t[0]&&t[0].rect,i}function S(t,e,r){const n=r.lineWidth,i=t.length,o=new Float32Array(2*i),a=r.translate||[0,0],s=r.scale||[1,1];for(let e=0,r=0;e<i;e++)o[r++]=t[e][0]*s[0]+a[0],o[r++]=t[e][1]*s[1]+a[1];f(o,0,i)<0&&v(o,2,0,i);const h=[],u=[],l=r.miterLimit,c=_(o,u,0,i,0,-n/2,l,!1);v(o,2,0,i);const d=_(o,h,0,i,0,-n/2,l,!1),p=(h.length+u.length)/2,m=new Float32Array(2*p);let g=0;const x=u.length/2;for(let t=0;t<u.length;t++)m[g++]=u[t];for(let t=0;t<h.length;t++)m[g++]=h[t];const b=new(p>65535?Uint32Array:Uint16Array)(3*(2*(i-1)+(p-2*i)));let w=0;for(let t=0;t<i-1;t++){const e=t+1;b[w++]=x-1-c[t],b[w++]=x-1-c[t]-1,b[w++]=d[t]+1+x,b[w++]=x-1-c[t],b[w++]=d[t]+1+x,b[w++]=d[t]+x,d[e]-d[t]==2?(b[w++]=d[t]+2+x,b[w++]=d[t]+1+x,b[w++]=x-c[e]-1):c[e]-c[t]==2&&(b[w++]=d[e]+x,b[w++]=x-1-(c[t]+1),b[w++]=x-1-(c[t]+2))}const T=r.bevelSize>0?y(m,[],r.bevelSize,null,!0):m,E=r.boundingRect;return{vertices:m,indices:b,topVertices:T,rect:{x:E.x*s[0]+a[0],y:E.y*s[1]+a[1],width:E.width*s[0],height:E.height*s[1]},depth:"function"==typeof r.depth?r.depth(e):r.depth,holes:[]}}function A(t,e){const r=[];for(let n=0;n<t.length;n++){const i=t[n],o=[],a=i.length;let s=i[a-1][0],h=i[a-1][1],u=0;for(let t=0;t<a;t++){let r=i[t][0],n=i[t][1];const a=r-s,l=n-h;(u+=Math.sqrt(a*a+l*l))>e&&(o.push(i[t]),u=0),s=r,h=n}o.length>=3&&r.push(o)}return r.length>0?r:null}function M(t,e,r){for(let n=0;n<t.length;n++)e[0]=Math.min(t[n][0],e[0]),e[1]=Math.min(t[n][1],e[1]),r[0]=Math.max(t[n][0],r[0]),r[1]=Math.max(t[n][1],r[1])}function P(t,e){e=Object.assign({},e);const r=[],n=[],o=[],a=[],s=[1/0,1/0],h=[-1/0,-1/0];for(let e=0;e<t.features.length;e++){const i=t.features[e].geometry;if(i&&i.coordinates)switch(i.type){case"LineString":r.push(i.coordinates),o.push(e),M(i.coordinates,s,h);break;case"MultiLineString":for(let t=0;t<i.coordinates.length;t++)r.push(i.coordinates[t]),o.push(e),M(i.coordinates[t],s,h);break;case"Polygon":n.push(i.coordinates),a.push(e),M(i.coordinates[0],s,h);break;case"MultiPolygon":for(let t=0;t<i.coordinates.length;t++)n.push(i.coordinates[t]),a.push(e),M(i.coordinates[t][0],s,h)}}e.boundingRect=e.boundingRect||{x:s[0],y:s[1],width:h[0]-s[0],height:h[1]-s[1]};const u=e.depth;return{polyline:function(t,e){e=Object.assign({},e);const r=[1/0,1/0],n=[-1/0,-1/0];for(let e=0;e<t.length;e++)M(t[e],r,n);e.boundingRect=e.boundingRect||{x:r[0],y:r[1],width:n[0]-r[0],height:n[1]-r[1]},b(e),null==e.lineWidth&&(e.lineWidth=1),null==e.miterLimit&&(e.miterLimit=2);const i=[];for(let r=0;r<t.length;r++)i.push(S(t[r],r,e));return C(i,e)}(r,Object.assign(e,{depth:function(e){return"function"==typeof u?u(t.features[o[e]]):u}})),polygon:function(t,e){e=Object.assign({},e);const r=[1/0,1/0],n=[-1/0,-1/0];for(let e=0;e<t.length;e++)M(t[e][0],r,n);e.boundingRect=e.boundingRect||{x:r[0],y:r[1],width:n[0]-r[0],height:n[1]-r[1]},b(e);const o=[],a=e.translate||[0,0],s=e.scale||[1,1],h=e.boundingRect,u={x:h.x*s[0]+a[0],y:h.y*s[1]+a[1],width:h.width*s[0],height:h.height*s[1]},l=Math.min(h.width,h.height)/1e5;for(let r=0;r<t.length;r++){const n=A(t[r],l);if(!n)continue;const{vertices:h,holes:c,dimensions:f}=i.a.flatten(n);for(let t=0;t<h.length;)h[t]=h[t++]*s[0]+a[0],h[t]=h[t++]*s[1]+a[1];if(x(h,c),2!==f)throw new Error("Only 2D polygon points are supported");const p=e.bevelSize>0?y(h,c,e.bevelSize,null,!0):h,m=d(p,c,f);o.push({indices:m,vertices:h,topVertices:p,holes:c,rect:u,depth:"function"==typeof e.depth?e.depth(r):e.depth})}return C(o,e)}(n,Object.assign(e,{depth:function(e){return"function"==typeof u?u(t.features[a[e]]):u}}))}}var R,L=Array,O=Math.random,k={};k.create=function(){var t=new L(3);return t[0]=0,t[1]=0,t[2]=0,t},k.clone=function(t){var e=new L(3);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},k.fromValues=function(t,e,r){var n=new L(3);return n[0]=t,n[1]=e,n[2]=r,n},k.copy=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},k.set=function(t,e,r,n){return t[0]=e,t[1]=r,t[2]=n,t},k.add=function(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t},k.subtract=function(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t},k.sub=k.subtract,k.multiply=function(t,e,r){return t[0]=e[0]*r[0],t[1]=e[1]*r[1],t[2]=e[2]*r[2],t},k.mul=k.multiply,k.divide=function(t,e,r){return t[0]=e[0]/r[0],t[1]=e[1]/r[1],t[2]=e[2]/r[2],t},k.div=k.divide,k.min=function(t,e,r){return t[0]=Math.min(e[0],r[0]),t[1]=Math.min(e[1],r[1]),t[2]=Math.min(e[2],r[2]),t},k.max=function(t,e,r){return t[0]=Math.max(e[0],r[0]),t[1]=Math.max(e[1],r[1]),t[2]=Math.max(e[2],r[2]),t},k.scale=function(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t},k.scaleAndAdd=function(t,e,r,n){return t[0]=e[0]+r[0]*n,t[1]=e[1]+r[1]*n,t[2]=e[2]+r[2]*n,t},k.distance=function(t,e){var r=e[0]-t[0],n=e[1]-t[1],i=e[2]-t[2];return Math.sqrt(r*r+n*n+i*i)},k.dist=k.distance,k.squaredDistance=function(t,e){var r=e[0]-t[0],n=e[1]-t[1],i=e[2]-t[2];return r*r+n*n+i*i},k.sqrDist=k.squaredDistance,k.length=function(t){var e=t[0],r=t[1],n=t[2];return Math.sqrt(e*e+r*r+n*n)},k.len=k.length,k.squaredLength=function(t){var e=t[0],r=t[1],n=t[2];return e*e+r*r+n*n},k.sqrLen=k.squaredLength,k.negate=function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t},k.inverse=function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t},k.normalize=function(t,e){var r=e[0],n=e[1],i=e[2],o=r*r+n*n+i*i;return o>0&&(o=1/Math.sqrt(o),t[0]=e[0]*o,t[1]=e[1]*o,t[2]=e[2]*o),t},k.dot=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]},k.cross=function(t,e,r){var n=e[0],i=e[1],o=e[2],a=r[0],s=r[1],h=r[2];return t[0]=i*h-o*s,t[1]=o*a-n*h,t[2]=n*s-i*a,t},k.lerp=function(t,e,r,n){var i=e[0],o=e[1],a=e[2];return t[0]=i+n*(r[0]-i),t[1]=o+n*(r[1]-o),t[2]=a+n*(r[2]-a),t},k.random=function(t,e){e=e||1;var r=2*O()*Math.PI,n=2*O()-1,i=Math.sqrt(1-n*n)*e;return t[0]=Math.cos(r)*i,t[1]=Math.sin(r)*i,t[2]=n*e,t},k.transformMat4=function(t,e,r){var n=e[0],i=e[1],o=e[2],a=r[3]*n+r[7]*i+r[11]*o+r[15];return a=a||1,t[0]=(r[0]*n+r[4]*i+r[8]*o+r[12])/a,t[1]=(r[1]*n+r[5]*i+r[9]*o+r[13])/a,t[2]=(r[2]*n+r[6]*i+r[10]*o+r[14])/a,t},k.transformMat3=function(t,e,r){var n=e[0],i=e[1],o=e[2];return t[0]=n*r[0]+i*r[3]+o*r[6],t[1]=n*r[1]+i*r[4]+o*r[7],t[2]=n*r[2]+i*r[5]+o*r[8],t},k.transformQuat=function(t,e,r){var n=e[0],i=e[1],o=e[2],a=r[0],s=r[1],h=r[2],u=r[3],l=u*n+s*o-h*i,c=u*i+h*n-a*o,f=u*o+a*i-s*n,d=-a*n-s*i-h*o;return t[0]=l*u+d*-a+c*-h-f*-s,t[1]=c*u+d*-s+f*-a-l*-h,t[2]=f*u+d*-h+l*-s-c*-a,t},k.rotateX=function(t,e,r,n){var i=[],o=[];return i[0]=e[0]-r[0],i[1]=e[1]-r[1],i[2]=e[2]-r[2],o[0]=i[0],o[1]=i[1]*Math.cos(n)-i[2]*Math.sin(n),o[2]=i[1]*Math.sin(n)+i[2]*Math.cos(n),t[0]=o[0]+r[0],t[1]=o[1]+r[1],t[2]=o[2]+r[2],t},k.rotateY=function(t,e,r,n){var i=[],o=[];return i[0]=e[0]-r[0],i[1]=e[1]-r[1],i[2]=e[2]-r[2],o[0]=i[2]*Math.sin(n)+i[0]*Math.cos(n),o[1]=i[1],o[2]=i[2]*Math.cos(n)-i[0]*Math.sin(n),t[0]=o[0]+r[0],t[1]=o[1]+r[1],t[2]=o[2]+r[2],t},k.rotateZ=function(t,e,r,n){var i=[],o=[];return i[0]=e[0]-r[0],i[1]=e[1]-r[1],i[2]=e[2]-r[2],o[0]=i[0]*Math.cos(n)-i[1]*Math.sin(n),o[1]=i[0]*Math.sin(n)+i[1]*Math.cos(n),o[2]=i[2],t[0]=o[0]+r[0],t[1]=o[1]+r[1],t[2]=o[2]+r[2],t},k.forEach=(R=k.create(),function(t,e,r,n,i,o){var a,s;for(e||(e=3),r||(r=0),s=n?Math.min(n*e+r,t.length):t.length,a=r;a<s;a+=e)R[0]=t[a],R[1]=t[a+1],R[2]=t[a+2],i(R,R,o),t[a]=R[0],t[a+1]=R[1],t[a+2]=R[2];return t}),k.angle=function(t,e){var r=k.fromValues(t[0],t[1],t[2]),n=k.fromValues(e[0],e[1],e[2]);k.normalize(r,r),k.normalize(n,n);var i=k.dot(r,n);return i>1?0:Math.acos(i)};var D=k,I=function(t,e,r){t=t||0,e=e||0,r=r||0,this.array=D.fromValues(t,e,r),this._dirty=!0};I.prototype={constructor:I,add:function(t){return D.add(this.array,this.array,t.array),this._dirty=!0,this},set:function(t,e,r){return this.array[0]=t,this.array[1]=e,this.array[2]=r,this._dirty=!0,this},setArray:function(t){return this.array[0]=t[0],this.array[1]=t[1],this.array[2]=t[2],this._dirty=!0,this},clone:function(){return new I(this.x,this.y,this.z)},copy:function(t){return D.copy(this.array,t.array),this._dirty=!0,this},cross:function(t,e){return D.cross(this.array,t.array,e.array),this._dirty=!0,this},dist:function(t){return D.dist(this.array,t.array)},distance:function(t){return D.distance(this.array,t.array)},div:function(t){return D.div(this.array,this.array,t.array),this._dirty=!0,this},divide:function(t){return D.divide(this.array,this.array,t.array),this._dirty=!0,this},dot:function(t){return D.dot(this.array,t.array)},len:function(){return D.len(this.array)},length:function(){return D.length(this.array)},lerp:function(t,e,r){return D.lerp(this.array,t.array,e.array,r),this._dirty=!0,this},min:function(t){return D.min(this.array,this.array,t.array),this._dirty=!0,this},max:function(t){return D.max(this.array,this.array,t.array),this._dirty=!0,this},mul:function(t){return D.mul(this.array,this.array,t.array),this._dirty=!0,this},multiply:function(t){return D.multiply(this.array,this.array,t.array),this._dirty=!0,this},negate:function(){return D.negate(this.array,this.array),this._dirty=!0,this},normalize:function(){return D.normalize(this.array,this.array),this._dirty=!0,this},random:function(t){return D.random(this.array,t),this._dirty=!0,this},scale:function(t){return D.scale(this.array,this.array,t),this._dirty=!0,this},scaleAndAdd:function(t,e){return D.scaleAndAdd(this.array,this.array,t.array,e),this._dirty=!0,this},sqrDist:function(t){return D.sqrDist(this.array,t.array)},squaredDistance:function(t){return D.squaredDistance(this.array,t.array)},sqrLen:function(){return D.sqrLen(this.array)},squaredLength:function(){return D.squaredLength(this.array)},sub:function(t){return D.sub(this.array,this.array,t.array),this._dirty=!0,this},subtract:function(t){return D.subtract(this.array,this.array,t.array),this._dirty=!0,this},transformMat3:function(t){return D.transformMat3(this.array,this.array,t.array),this._dirty=!0,this},transformMat4:function(t){return D.transformMat4(this.array,this.array,t.array),this._dirty=!0,this},transformQuat:function(t){return D.transformQuat(this.array,this.array,t.array),this._dirty=!0,this},applyProjection:function(t){var e=this.array;if(0===(t=t.array)[15]){var r=-1/e[2];e[0]=t[0]*e[0]*r,e[1]=t[5]*e[1]*r,e[2]=(t[10]*e[2]+t[14])*r}else e[0]=t[0]*e[0]+t[12],e[1]=t[5]*e[1]+t[13],e[2]=t[10]*e[2]+t[14];return this._dirty=!0,this},eulerFromQuat:function(t,e){I.eulerFromQuat(this,t,e)},eulerFromMat3:function(t,e){I.eulerFromMat3(this,t,e)},toString:function(){return"["+Array.prototype.join.call(this.array,",")+"]"},toArray:function(){return Array.prototype.slice.call(this.array)}};var N=Object.defineProperty;if(N){var F=I.prototype;N(F,"x",{get:function(){return this.array[0]},set:function(t){this.array[0]=t,this._dirty=!0}}),N(F,"y",{get:function(){return this.array[1]},set:function(t){this.array[1]=t,this._dirty=!0}}),N(F,"z",{get:function(){return this.array[2]},set:function(t){this.array[2]=t,this._dirty=!0}})}function B(t,e,r){return t<e?e:t>r?r:t}I.add=function(t,e,r){return D.add(t.array,e.array,r.array),t._dirty=!0,t},I.set=function(t,e,r,n){D.set(t.array,e,r,n),t._dirty=!0},I.copy=function(t,e){return D.copy(t.array,e.array),t._dirty=!0,t},I.cross=function(t,e,r){return D.cross(t.array,e.array,r.array),t._dirty=!0,t},I.distance=I.dist=function(t,e){return D.distance(t.array,e.array)},I.divide=I.div=function(t,e,r){return D.divide(t.array,e.array,r.array),t._dirty=!0,t},I.dot=function(t,e){return D.dot(t.array,e.array)},I.len=function(t){return D.length(t.array)},I.lerp=function(t,e,r,n){return D.lerp(t.array,e.array,r.array,n),t._dirty=!0,t},I.min=function(t,e,r){return D.min(t.array,e.array,r.array),t._dirty=!0,t},I.max=function(t,e,r){return D.max(t.array,e.array,r.array),t._dirty=!0,t},I.multiply=I.mul=function(t,e,r){return D.multiply(t.array,e.array,r.array),t._dirty=!0,t},I.negate=function(t,e){return D.negate(t.array,e.array),t._dirty=!0,t},I.normalize=function(t,e){return D.normalize(t.array,e.array),t._dirty=!0,t},I.random=function(t,e){return D.random(t.array,e),t._dirty=!0,t},I.scale=function(t,e,r){return D.scale(t.array,e.array,r),t._dirty=!0,t},I.scaleAndAdd=function(t,e,r,n){return D.scaleAndAdd(t.array,e.array,r.array,n),t._dirty=!0,t},I.squaredDistance=I.sqrDist=function(t,e){return D.sqrDist(t.array,e.array)},I.squaredLength=I.sqrLen=function(t){return D.sqrLen(t.array)},I.subtract=I.sub=function(t,e,r){return D.subtract(t.array,e.array,r.array),t._dirty=!0,t},I.transformMat3=function(t,e,r){return D.transformMat3(t.array,e.array,r.array),t._dirty=!0,t},I.transformMat4=function(t,e,r){return D.transformMat4(t.array,e.array,r.array),t._dirty=!0,t},I.transformQuat=function(t,e,r){return D.transformQuat(t.array,e.array,r.array),t._dirty=!0,t};var z=Math.atan2,U=Math.asin,H=Math.abs;I.eulerFromQuat=function(t,e,r){t._dirty=!0,e=e.array;var n=t.array,i=e[0],o=e[1],a=e[2],s=e[3],h=i*i,u=o*o,l=a*a,c=s*s;switch(r=(r||"XYZ").toUpperCase()){case"XYZ":n[0]=z(2*(i*s-o*a),c-h-u+l),n[1]=U(B(2*(i*a+o*s),-1,1)),n[2]=z(2*(a*s-i*o),c+h-u-l);break;case"YXZ":n[0]=U(B(2*(i*s-o*a),-1,1)),n[1]=z(2*(i*a+o*s),c-h-u+l),n[2]=z(2*(i*o+a*s),c-h+u-l);break;case"ZXY":n[0]=U(B(2*(i*s+o*a),-1,1)),n[1]=z(2*(o*s-a*i),c-h-u+l),n[2]=z(2*(a*s-i*o),c-h+u-l);break;case"ZYX":n[0]=z(2*(i*s+a*o),c-h-u+l),n[1]=U(B(2*(o*s-i*a),-1,1)),n[2]=z(2*(i*o+a*s),c+h-u-l);break;case"YZX":n[0]=z(2*(i*s-a*o),c-h+u-l),n[1]=z(2*(o*s-i*a),c+h-u-l),n[2]=U(B(2*(i*o+a*s),-1,1));break;case"XZY":n[0]=z(2*(i*s+o*a),c-h+u-l),n[1]=z(2*(i*a+o*s),c+h-u-l),n[2]=U(B(2*(a*s-i*o),-1,1));break;default:console.warn("Unkown order: "+r)}return t},I.eulerFromMat3=function(t,e,r){var n=e.array,i=n[0],o=n[3],a=n[6],s=n[1],h=n[4],u=n[7],l=n[2],c=n[5],f=n[8],d=t.array;switch(r=(r||"XYZ").toUpperCase()){case"XYZ":d[1]=U(B(a,-1,1)),H(a)<.99999?(d[0]=z(-u,f),d[2]=z(-o,i)):(d[0]=z(c,h),d[2]=0);break;case"YXZ":d[0]=U(-B(u,-1,1)),H(u)<.99999?(d[1]=z(a,f),d[2]=z(s,h)):(d[1]=z(-l,i),d[2]=0);break;case"ZXY":d[0]=U(B(c,-1,1)),H(c)<.99999?(d[1]=z(-l,f),d[2]=z(-o,h)):(d[1]=0,d[2]=z(s,i));break;case"ZYX":d[1]=U(-B(l,-1,1)),H(l)<.99999?(d[0]=z(c,f),d[2]=z(s,i)):(d[0]=0,d[2]=z(-o,h));break;case"YZX":d[2]=U(B(s,-1,1)),H(s)<.99999?(d[0]=z(-u,h),d[1]=z(-l,i)):(d[0]=0,d[1]=z(a,f));break;case"XZY":d[2]=U(-B(o,-1,1)),H(o)<.99999?(d[0]=z(c,h),d[1]=z(a,i)):(d[0]=z(-u,f),d[1]=0);break;default:console.warn("Unkown order: "+r)}return t._dirty=!0,t},Object.defineProperties(I,{POSITIVE_X:{get:function(){return new I(1,0,0)}},NEGATIVE_X:{get:function(){return new I(-1,0,0)}},POSITIVE_Y:{get:function(){return new I(0,1,0)}},NEGATIVE_Y:{get:function(){return new I(0,-1,0)}},POSITIVE_Z:{get:function(){return new I(0,0,1)}},NEGATIVE_Z:{get:function(){return new I(0,0,-1)}},UP:{get:function(){return new I(0,1,0)}},ZERO:{get:function(){return new I}}});var j=I,G=r(0),V={create:function(){var t=new L(16);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},clone:function(t){var e=new L(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},identity:function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},transpose:function(t,e){if(t===e){var r=e[1],n=e[2],i=e[3],o=e[6],a=e[7],s=e[11];t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=r,t[6]=e[9],t[7]=e[13],t[8]=n,t[9]=o,t[11]=e[14],t[12]=i,t[13]=a,t[14]=s}else t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15];return t},invert:function(t,e){var r=e[0],n=e[1],i=e[2],o=e[3],a=e[4],s=e[5],h=e[6],u=e[7],l=e[8],c=e[9],f=e[10],d=e[11],p=e[12],m=e[13],g=e[14],_=e[15],y=r*s-n*a,v=r*h-i*a,x=r*u-o*a,b=n*h-i*s,w=n*u-o*s,T=i*u-o*h,E=l*m-c*p,C=l*g-f*p,S=l*_-d*p,A=c*g-f*m,M=c*_-d*m,P=f*_-d*g,R=y*P-v*M+x*A+b*S-w*C+T*E;return R?(R=1/R,t[0]=(s*P-h*M+u*A)*R,t[1]=(i*M-n*P-o*A)*R,t[2]=(m*T-g*w+_*b)*R,t[3]=(f*w-c*T-d*b)*R,t[4]=(h*S-a*P-u*C)*R,t[5]=(r*P-i*S+o*C)*R,t[6]=(g*x-p*T-_*v)*R,t[7]=(l*T-f*x+d*v)*R,t[8]=(a*M-s*S+u*E)*R,t[9]=(n*S-r*M-o*E)*R,t[10]=(p*w-m*x+_*y)*R,t[11]=(c*x-l*w-d*y)*R,t[12]=(s*C-a*A-h*E)*R,t[13]=(r*A-n*C+i*E)*R,t[14]=(m*v-p*b-g*y)*R,t[15]=(l*b-c*v+f*y)*R,t):null},adjoint:function(t,e){var r=e[0],n=e[1],i=e[2],o=e[3],a=e[4],s=e[5],h=e[6],u=e[7],l=e[8],c=e[9],f=e[10],d=e[11],p=e[12],m=e[13],g=e[14],_=e[15];return t[0]=s*(f*_-d*g)-c*(h*_-u*g)+m*(h*d-u*f),t[1]=-(n*(f*_-d*g)-c*(i*_-o*g)+m*(i*d-o*f)),t[2]=n*(h*_-u*g)-s*(i*_-o*g)+m*(i*u-o*h),t[3]=-(n*(h*d-u*f)-s*(i*d-o*f)+c*(i*u-o*h)),t[4]=-(a*(f*_-d*g)-l*(h*_-u*g)+p*(h*d-u*f)),t[5]=r*(f*_-d*g)-l*(i*_-o*g)+p*(i*d-o*f),t[6]=-(r*(h*_-u*g)-a*(i*_-o*g)+p*(i*u-o*h)),t[7]=r*(h*d-u*f)-a*(i*d-o*f)+l*(i*u-o*h),t[8]=a*(c*_-d*m)-l*(s*_-u*m)+p*(s*d-u*c),t[9]=-(r*(c*_-d*m)-l*(n*_-o*m)+p*(n*d-o*c)),t[10]=r*(s*_-u*m)-a*(n*_-o*m)+p*(n*u-o*s),t[11]=-(r*(s*d-u*c)-a*(n*d-o*c)+l*(n*u-o*s)),t[12]=-(a*(c*g-f*m)-l*(s*g-h*m)+p*(s*f-h*c)),t[13]=r*(c*g-f*m)-l*(n*g-i*m)+p*(n*f-i*c),t[14]=-(r*(s*g-h*m)-a*(n*g-i*m)+p*(n*h-i*s)),t[15]=r*(s*f-h*c)-a*(n*f-i*c)+l*(n*h-i*s),t},determinant:function(t){var e=t[0],r=t[1],n=t[2],i=t[3],o=t[4],a=t[5],s=t[6],h=t[7],u=t[8],l=t[9],c=t[10],f=t[11],d=t[12],p=t[13],m=t[14],g=t[15];return(e*a-r*o)*(c*g-f*m)-(e*s-n*o)*(l*g-f*p)+(e*h-i*o)*(l*m-c*p)+(r*s-n*a)*(u*g-f*d)-(r*h-i*a)*(u*m-c*d)+(n*h-i*s)*(u*p-l*d)},multiply:function(t,e,r){var n=e[0],i=e[1],o=e[2],a=e[3],s=e[4],h=e[5],u=e[6],l=e[7],c=e[8],f=e[9],d=e[10],p=e[11],m=e[12],g=e[13],_=e[14],y=e[15],v=r[0],x=r[1],b=r[2],w=r[3];return t[0]=v*n+x*s+b*c+w*m,t[1]=v*i+x*h+b*f+w*g,t[2]=v*o+x*u+b*d+w*_,t[3]=v*a+x*l+b*p+w*y,v=r[4],x=r[5],b=r[6],w=r[7],t[4]=v*n+x*s+b*c+w*m,t[5]=v*i+x*h+b*f+w*g,t[6]=v*o+x*u+b*d+w*_,t[7]=v*a+x*l+b*p+w*y,v=r[8],x=r[9],b=r[10],w=r[11],t[8]=v*n+x*s+b*c+w*m,t[9]=v*i+x*h+b*f+w*g,t[10]=v*o+x*u+b*d+w*_,t[11]=v*a+x*l+b*p+w*y,v=r[12],x=r[13],b=r[14],w=r[15],t[12]=v*n+x*s+b*c+w*m,t[13]=v*i+x*h+b*f+w*g,t[14]=v*o+x*u+b*d+w*_,t[15]=v*a+x*l+b*p+w*y,t},multiplyAffine:function(t,e,r){var n=e[0],i=e[1],o=e[2],a=e[4],s=e[5],h=e[6],u=e[8],l=e[9],c=e[10],f=e[12],d=e[13],p=e[14],m=r[0],g=r[1],_=r[2];return t[0]=m*n+g*a+_*u,t[1]=m*i+g*s+_*l,t[2]=m*o+g*h+_*c,m=r[4],g=r[5],_=r[6],t[4]=m*n+g*a+_*u,t[5]=m*i+g*s+_*l,t[6]=m*o+g*h+_*c,m=r[8],g=r[9],_=r[10],t[8]=m*n+g*a+_*u,t[9]=m*i+g*s+_*l,t[10]=m*o+g*h+_*c,m=r[12],g=r[13],_=r[14],t[12]=m*n+g*a+_*u+f,t[13]=m*i+g*s+_*l+d,t[14]=m*o+g*h+_*c+p,t}};V.mul=V.multiply,V.mulAffine=V.multiplyAffine,V.translate=function(t,e,r){var n,i,o,a,s,h,u,l,c,f,d,p,m=r[0],g=r[1],_=r[2];return e===t?(t[12]=e[0]*m+e[4]*g+e[8]*_+e[12],t[13]=e[1]*m+e[5]*g+e[9]*_+e[13],t[14]=e[2]*m+e[6]*g+e[10]*_+e[14],t[15]=e[3]*m+e[7]*g+e[11]*_+e[15]):(n=e[0],i=e[1],o=e[2],a=e[3],s=e[4],h=e[5],u=e[6],l=e[7],c=e[8],f=e[9],d=e[10],p=e[11],t[0]=n,t[1]=i,t[2]=o,t[3]=a,t[4]=s,t[5]=h,t[6]=u,t[7]=l,t[8]=c,t[9]=f,t[10]=d,t[11]=p,t[12]=n*m+s*g+c*_+e[12],t[13]=i*m+h*g+f*_+e[13],t[14]=o*m+u*g+d*_+e[14],t[15]=a*m+l*g+p*_+e[15]),t},V.scale=function(t,e,r){var n=r[0],i=r[1],o=r[2];return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*i,t[5]=e[5]*i,t[6]=e[6]*i,t[7]=e[7]*i,t[8]=e[8]*o,t[9]=e[9]*o,t[10]=e[10]*o,t[11]=e[11]*o,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},V.rotate=function(t,e,r,n){var i,o,a,s,h,u,l,c,f,d,p,m,g,_,y,v,x,b,w,T,E,C,S,A,M=n[0],P=n[1],R=n[2],L=Math.sqrt(M*M+P*P+R*R);return Math.abs(L)<1e-6?null:(M*=L=1/L,P*=L,R*=L,i=Math.sin(r),a=1-(o=Math.cos(r)),s=e[0],h=e[1],u=e[2],l=e[3],c=e[4],f=e[5],d=e[6],p=e[7],m=e[8],g=e[9],_=e[10],y=e[11],v=M*M*a+o,x=P*M*a+R*i,b=R*M*a-P*i,w=M*P*a-R*i,T=P*P*a+o,E=R*P*a+M*i,C=M*R*a+P*i,S=P*R*a-M*i,A=R*R*a+o,t[0]=s*v+c*x+m*b,t[1]=h*v+f*x+g*b,t[2]=u*v+d*x+_*b,t[3]=l*v+p*x+y*b,t[4]=s*w+c*T+m*E,t[5]=h*w+f*T+g*E,t[6]=u*w+d*T+_*E,t[7]=l*w+p*T+y*E,t[8]=s*C+c*S+m*A,t[9]=h*C+f*S+g*A,t[10]=u*C+d*S+_*A,t[11]=l*C+p*S+y*A,e!==t&&(t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t)},V.rotateX=function(t,e,r){var n=Math.sin(r),i=Math.cos(r),o=e[4],a=e[5],s=e[6],h=e[7],u=e[8],l=e[9],c=e[10],f=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=o*i+u*n,t[5]=a*i+l*n,t[6]=s*i+c*n,t[7]=h*i+f*n,t[8]=u*i-o*n,t[9]=l*i-a*n,t[10]=c*i-s*n,t[11]=f*i-h*n,t},V.rotateY=function(t,e,r){var n=Math.sin(r),i=Math.cos(r),o=e[0],a=e[1],s=e[2],h=e[3],u=e[8],l=e[9],c=e[10],f=e[11];return e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=o*i-u*n,t[1]=a*i-l*n,t[2]=s*i-c*n,t[3]=h*i-f*n,t[8]=o*n+u*i,t[9]=a*n+l*i,t[10]=s*n+c*i,t[11]=h*n+f*i,t},V.rotateZ=function(t,e,r){var n=Math.sin(r),i=Math.cos(r),o=e[0],a=e[1],s=e[2],h=e[3],u=e[4],l=e[5],c=e[6],f=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=o*i+u*n,t[1]=a*i+l*n,t[2]=s*i+c*n,t[3]=h*i+f*n,t[4]=u*i-o*n,t[5]=l*i-a*n,t[6]=c*i-s*n,t[7]=f*i-h*n,t},V.fromRotationTranslation=function(t,e,r){var n=e[0],i=e[1],o=e[2],a=e[3],s=n+n,h=i+i,u=o+o,l=n*s,c=n*h,f=n*u,d=i*h,p=i*u,m=o*u,g=a*s,_=a*h,y=a*u;return t[0]=1-(d+m),t[1]=c+y,t[2]=f-_,t[3]=0,t[4]=c-y,t[5]=1-(l+m),t[6]=p+g,t[7]=0,t[8]=f+_,t[9]=p-g,t[10]=1-(l+d),t[11]=0,t[12]=r[0],t[13]=r[1],t[14]=r[2],t[15]=1,t},V.fromQuat=function(t,e){var r=e[0],n=e[1],i=e[2],o=e[3],a=r+r,s=n+n,h=i+i,u=r*a,l=n*a,c=n*s,f=i*a,d=i*s,p=i*h,m=o*a,g=o*s,_=o*h;return t[0]=1-c-p,t[1]=l+_,t[2]=f-g,t[3]=0,t[4]=l-_,t[5]=1-u-p,t[6]=d+m,t[7]=0,t[8]=f+g,t[9]=d-m,t[10]=1-u-c,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},V.frustum=function(t,e,r,n,i,o,a){var s=1/(r-e),h=1/(i-n),u=1/(o-a);return t[0]=2*o*s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*o*h,t[6]=0,t[7]=0,t[8]=(r+e)*s,t[9]=(i+n)*h,t[10]=(a+o)*u,t[11]=-1,t[12]=0,t[13]=0,t[14]=a*o*2*u,t[15]=0,t},V.perspective=function(t,e,r,n,i){var o=1/Math.tan(e/2),a=1/(n-i);return t[0]=o/r,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=o,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=(i+n)*a,t[11]=-1,t[12]=0,t[13]=0,t[14]=2*i*n*a,t[15]=0,t},V.ortho=function(t,e,r,n,i,o,a){var s=1/(e-r),h=1/(n-i),u=1/(o-a);return t[0]=-2*s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*h,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*u,t[11]=0,t[12]=(e+r)*s,t[13]=(i+n)*h,t[14]=(a+o)*u,t[15]=1,t},V.lookAt=function(t,e,r,n){var i,o,a,s,h,u,l,c,f,d,p=e[0],m=e[1],g=e[2],_=n[0],y=n[1],v=n[2],x=r[0],b=r[1],w=r[2];return Math.abs(p-x)<1e-6&&Math.abs(m-b)<1e-6&&Math.abs(g-w)<1e-6?V.identity(t):(l=p-x,c=m-b,f=g-w,i=y*(f*=d=1/Math.sqrt(l*l+c*c+f*f))-v*(c*=d),o=v*(l*=d)-_*f,a=_*c-y*l,(d=Math.sqrt(i*i+o*o+a*a))?(i*=d=1/d,o*=d,a*=d):(i=0,o=0,a=0),s=c*a-f*o,h=f*i-l*a,u=l*o-c*i,(d=Math.sqrt(s*s+h*h+u*u))?(s*=d=1/d,h*=d,u*=d):(s=0,h=0,u=0),t[0]=i,t[1]=s,t[2]=l,t[3]=0,t[4]=o,t[5]=h,t[6]=c,t[7]=0,t[8]=a,t[9]=u,t[10]=f,t[11]=0,t[12]=-(i*p+o*m+a*g),t[13]=-(s*p+h*m+u*g),t[14]=-(l*p+c*m+f*g),t[15]=1,t)},V.frob=function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+Math.pow(t[6],2)+Math.pow(t[7],2)+Math.pow(t[8],2)+Math.pow(t[9],2)+Math.pow(t[10],2)+Math.pow(t[11],2)+Math.pow(t[12],2)+Math.pow(t[13],2)+Math.pow(t[14],2)+Math.pow(t[15],2))};var W,Z,X,q,Y,J,K=V,Q=D.set,$=D.copy,tt=function(t,e){this.min=t||new j(1/0,1/0,1/0),this.max=e||new j(-1/0,-1/0,-1/0),this.vertices=null};tt.prototype={constructor:tt,updateFromVertices:function(t){if(t.length>0){var e=this.min,r=this.max,n=e.array,i=r.array;$(n,t[0]),$(i,t[0]);for(var o=1;o<t.length;o++){var a=t[o];a[0]<n[0]&&(n[0]=a[0]),a[1]<n[1]&&(n[1]=a[1]),a[2]<n[2]&&(n[2]=a[2]),a[0]>i[0]&&(i[0]=a[0]),a[1]>i[1]&&(i[1]=a[1]),a[2]>i[2]&&(i[2]=a[2])}e._dirty=!0,r._dirty=!0}},union:function(t){var e=this.min,r=this.max;return D.min(e.array,e.array,t.min.array),D.max(r.array,r.array,t.max.array),e._dirty=!0,r._dirty=!0,this},intersection:function(t){var e=this.min,r=this.max;return D.max(e.array,e.array,t.min.array),D.min(r.array,r.array,t.max.array),e._dirty=!0,r._dirty=!0,this},intersectBoundingBox:function(t){var e=this.min.array,r=this.max.array,n=t.min.array,i=t.max.array;return!(e[0]>i[0]||e[1]>i[1]||e[2]>i[2]||r[0]<n[0]||r[1]<n[1]||r[2]<n[2])},containBoundingBox:function(t){var e=this.min.array,r=this.max.array,n=t.min.array,i=t.max.array;return e[0]<=n[0]&&e[1]<=n[1]&&e[2]<=n[2]&&r[0]>=i[0]&&r[1]>=i[1]&&r[2]>=i[2]},containPoint:function(t){var e=this.min.array,r=this.max.array,n=t.array;return e[0]<=n[0]&&e[1]<=n[1]&&e[2]<=n[2]&&r[0]>=n[0]&&r[1]>=n[1]&&r[2]>=n[2]},isFinite:function(){var t=this.min.array,e=this.max.array;return isFinite(t[0])&&isFinite(t[1])&&isFinite(t[2])&&isFinite(e[0])&&isFinite(e[1])&&isFinite(e[2])},applyTransform:function(t){this.transformFrom(this,t)},transformFrom:(W=D.create(),Z=D.create(),X=D.create(),q=D.create(),Y=D.create(),J=D.create(),function(t,e){var r=t.min.array,n=t.max.array,i=e.array;return W[0]=i[0]*r[0],W[1]=i[1]*r[0],W[2]=i[2]*r[0],Z[0]=i[0]*n[0],Z[1]=i[1]*n[0],Z[2]=i[2]*n[0],X[0]=i[4]*r[1],X[1]=i[5]*r[1],X[2]=i[6]*r[1],q[0]=i[4]*n[1],q[1]=i[5]*n[1],q[2]=i[6]*n[1],Y[0]=i[8]*r[2],Y[1]=i[9]*r[2],Y[2]=i[10]*r[2],J[0]=i[8]*n[2],J[1]=i[9]*n[2],J[2]=i[10]*n[2],r=this.min.array,n=this.max.array,r[0]=Math.min(W[0],Z[0])+Math.min(X[0],q[0])+Math.min(Y[0],J[0])+i[12],r[1]=Math.min(W[1],Z[1])+Math.min(X[1],q[1])+Math.min(Y[1],J[1])+i[13],r[2]=Math.min(W[2],Z[2])+Math.min(X[2],q[2])+Math.min(Y[2],J[2])+i[14],n[0]=Math.max(W[0],Z[0])+Math.max(X[0],q[0])+Math.max(Y[0],J[0])+i[12],n[1]=Math.max(W[1],Z[1])+Math.max(X[1],q[1])+Math.max(Y[1],J[1])+i[13],n[2]=Math.max(W[2],Z[2])+Math.max(X[2],q[2])+Math.max(Y[2],J[2])+i[14],this.min._dirty=!0,this.max._dirty=!0,this}),applyProjection:function(t){var e=this.min.array,r=this.max.array,n=t.array,i=e[0],o=e[1],a=e[2],s=r[0],h=r[1],u=e[2],l=r[0],c=r[1],f=r[2];if(1===n[15])e[0]=n[0]*i+n[12],e[1]=n[5]*o+n[13],r[2]=n[10]*a+n[14],r[0]=n[0]*l+n[12],r[1]=n[5]*c+n[13],e[2]=n[10]*f+n[14];else{var d=-1/a;e[0]=n[0]*i*d,e[1]=n[5]*o*d,r[2]=(n[10]*a+n[14])*d,d=-1/u,r[0]=n[0]*s*d,r[1]=n[5]*h*d,d=-1/f,e[2]=(n[10]*f+n[14])*d}return this.min._dirty=!0,this.max._dirty=!0,this},updateVertices:function(){var t=this.vertices;if(!t){t=[];for(var e=0;e<8;e++)t[e]=D.fromValues(0,0,0);this.vertices=t}var r=this.min.array,n=this.max.array;return Q(t[0],r[0],r[1],r[2]),Q(t[1],r[0],n[1],r[2]),Q(t[2],n[0],r[1],r[2]),Q(t[3],n[0],n[1],r[2]),Q(t[4],r[0],r[1],n[2]),Q(t[5],r[0],n[1],n[2]),Q(t[6],n[0],r[1],n[2]),Q(t[7],n[0],n[1],n[2]),this},copy:function(t){var e=this.min,r=this.max;return $(e.array,t.min.array),$(r.array,t.max.array),e._dirty=!0,r._dirty=!0,this},clone:function(){var t=new tt;return t.copy(this),t}};var et=tt;function rt(t,e,r){"object"==typeof e&&(r=e,e=null);var n,i=this;if(!(t instanceof Function))for(var o in n=[],t)t.hasOwnProperty(o)&&n.push(o);var a=function(e){if(i.apply(this,arguments),t instanceof Function?nt(this,t.call(this,e)):function(t,e,r){for(var n=0;n<r.length;n++){var i=r[n];t[i]=e[i]}}(this,t,n),this.constructor===a)for(var r=a.__initializers__,o=0;o<r.length;o++)r[o].apply(this,arguments)};a.__super__=i,i.__initializers__?a.__initializers__=i.__initializers__.slice():a.__initializers__=[],e&&a.__initializers__.push(e);var s=function(){};return s.prototype=i.prototype,a.prototype=new s,a.prototype.constructor=a,nt(a.prototype,r),a.extend=i.extend,a.derive=i.extend,a}function nt(t,e){if(e)for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])}var it={extend:rt,derive:rt};var ot={trigger:function(t){if(this.hasOwnProperty("__handlers__")&&this.__handlers__.hasOwnProperty(t)){var e=this.__handlers__[t],r=e.length,n=-1,i=arguments;switch(i.length){case 1:for(;++n<r;)e[n].action.call(e[n].context);return;case 2:for(;++n<r;)e[n].action.call(e[n].context,i[1]);return;case 3:for(;++n<r;)e[n].action.call(e[n].context,i[1],i[2]);return;case 4:for(;++n<r;)e[n].action.call(e[n].context,i[1],i[2],i[3]);return;case 5:for(;++n<r;)e[n].action.call(e[n].context,i[1],i[2],i[3],i[4]);return;default:for(;++n<r;)e[n].action.apply(e[n].context,Array.prototype.slice.call(i,1));return}}},on:function(t,e,r){if(t&&e){var n=this.__handlers__||(this.__handlers__={});if(n[t]){if(this.has(t,e))return}else n[t]=[];var i=new function(t,e){this.action=t,this.context=e}(e,r||this);return n[t].push(i),this}},once:function(t,e,r){if(t&&e){var n=this;return this.on(t,function r(){n.off(t,r),e.apply(this,arguments)},r)}},before:function(t,e,r){if(t&&e)return t="before"+t,this.on(t,e,r)},after:function(t,e,r){if(t&&e)return t="after"+t,this.on(t,e,r)},success:function(t,e){return this.once("success",t,e)},error:function(t,e){return this.once("error",t,e)},off:function(t,e){var r=this.__handlers__||(this.__handlers__={});if(e){if(r[t]){for(var n=r[t],i=[],o=0;o<n.length;o++)e&&n[o].action!==e&&i.push(n[o]);r[t]=i}return this}r[t]=[]},has:function(t,e){var r=this.__handlers__;if(!r||!r[t])return!1;for(var n=r[t],i=0;i<n.length;i++)if(n[i].action===e)return!0}},at=0,st=Array.prototype.forEach,ht={genGUID:function(){return++at},relative2absolute:function(t,e){if(!e||t.match(/^\//))return t;for(var r=t.split("/"),n=e.split("/"),i=r[0];"."===i||".."===i;)".."===i&&n.pop(),r.shift(),i=r[0];return n.join("/")+"/"+r.join("/")},extend:function(t,e){if(e)for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);return t},defaults:function(t,e){if(e)for(var r in e)void 0===t[r]&&(t[r]=e[r]);return t},extendWithPropList:function(t,e,r){if(e)for(var n=0;n<r.length;n++){var i=r[n];t[i]=e[i]}return t},defaultsWithPropList:function(t,e,r){if(e)for(var n=0;n<r.length;n++){var i=r[n];null==t[i]&&(t[i]=e[i])}return t},each:function(t,e,r){if(t&&e)if(t.forEach&&t.forEach===st)t.forEach(e,r);else if(t.length===+t.length)for(var n=0,i=t.length;n<i;n++)e.call(r,t[n],n,t);else for(var o in t)t.hasOwnProperty(o)&&e.call(r,t[o],o,t)},isObject:function(t){return t===Object(t)},isArray:function(t){return Array.isArray(t)},isArrayLike:function(t){return!!t&&t.length===+t.length},clone:function(t){if(ht.isObject(t)){if(ht.isArray(t))return t.slice();if(ht.isArrayLike(t)){for(var e=new t.constructor(t.length),r=0;r<t.length;r++)e[r]=t[r];return e}return ht.extend({},t)}return t}},ut=ht,lt=function(){this.__uid__=ut.genGUID()};lt.__initializers__=[function(t){ut.extend(this,t)}],ut.extend(lt,it),ut.extend(lt.prototype,ot);var ct=lt,ft={DEPTH_BUFFER_BIT:256,STENCIL_BUFFER_BIT:1024,COLOR_BUFFER_BIT:16384,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,ZERO:0,ONE:1,SRC_COLOR:768,ONE_MINUS_SRC_COLOR:769,SRC_ALPHA:770,ONE_MINUS_SRC_ALPHA:771,DST_ALPHA:772,ONE_MINUS_DST_ALPHA:773,DST_COLOR:774,ONE_MINUS_DST_COLOR:775,SRC_ALPHA_SATURATE:776,FUNC_ADD:32774,BLEND_EQUATION:32777,BLEND_EQUATION_RGB:32777,BLEND_EQUATION_ALPHA:34877,FUNC_SUBTRACT:32778,FUNC_REVERSE_SUBTRACT:32779,BLEND_DST_RGB:32968,BLEND_SRC_RGB:32969,BLEND_DST_ALPHA:32970,BLEND_SRC_ALPHA:32971,CONSTANT_COLOR:32769,ONE_MINUS_CONSTANT_COLOR:32770,CONSTANT_ALPHA:32771,ONE_MINUS_CONSTANT_ALPHA:32772,BLEND_COLOR:32773,ARRAY_BUFFER:34962,ELEMENT_ARRAY_BUFFER:34963,ARRAY_BUFFER_BINDING:34964,ELEMENT_ARRAY_BUFFER_BINDING:34965,STREAM_DRAW:35040,STATIC_DRAW:35044,DYNAMIC_DRAW:35048,BUFFER_SIZE:34660,BUFFER_USAGE:34661,CURRENT_VERTEX_ATTRIB:34342,FRONT:1028,BACK:1029,FRONT_AND_BACK:1032,CULL_FACE:2884,BLEND:3042,DITHER:3024,STENCIL_TEST:2960,DEPTH_TEST:2929,SCISSOR_TEST:3089,POLYGON_OFFSET_FILL:32823,SAMPLE_ALPHA_TO_COVERAGE:32926,SAMPLE_COVERAGE:32928,NO_ERROR:0,INVALID_ENUM:1280,INVALID_VALUE:1281,INVALID_OPERATION:1282,OUT_OF_MEMORY:1285,CW:2304,CCW:2305,LINE_WIDTH:2849,ALIASED_POINT_SIZE_RANGE:33901,ALIASED_LINE_WIDTH_RANGE:33902,CULL_FACE_MODE:2885,FRONT_FACE:2886,DEPTH_RANGE:2928,DEPTH_WRITEMASK:2930,DEPTH_CLEAR_VALUE:2931,DEPTH_FUNC:2932,STENCIL_CLEAR_VALUE:2961,STENCIL_FUNC:2962,STENCIL_FAIL:2964,STENCIL_PASS_DEPTH_FAIL:2965,STENCIL_PASS_DEPTH_PASS:2966,STENCIL_REF:2967,STENCIL_VALUE_MASK:2963,STENCIL_WRITEMASK:2968,STENCIL_BACK_FUNC:34816,STENCIL_BACK_FAIL:34817,STENCIL_BACK_PASS_DEPTH_FAIL:34818,STENCIL_BACK_PASS_DEPTH_PASS:34819,STENCIL_BACK_REF:36003,STENCIL_BACK_VALUE_MASK:36004,STENCIL_BACK_WRITEMASK:36005,VIEWPORT:2978,SCISSOR_BOX:3088,COLOR_CLEAR_VALUE:3106,COLOR_WRITEMASK:3107,UNPACK_ALIGNMENT:3317,PACK_ALIGNMENT:3333,MAX_TEXTURE_SIZE:3379,MAX_VIEWPORT_DIMS:3386,SUBPIXEL_BITS:3408,RED_BITS:3410,GREEN_BITS:3411,BLUE_BITS:3412,ALPHA_BITS:3413,DEPTH_BITS:3414,STENCIL_BITS:3415,POLYGON_OFFSET_UNITS:10752,POLYGON_OFFSET_FACTOR:32824,TEXTURE_BINDING_2D:32873,SAMPLE_BUFFERS:32936,SAMPLES:32937,SAMPLE_COVERAGE_VALUE:32938,SAMPLE_COVERAGE_INVERT:32939,COMPRESSED_TEXTURE_FORMATS:34467,DONT_CARE:4352,FASTEST:4353,NICEST:4354,GENERATE_MIPMAP_HINT:33170,BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,DEPTH_COMPONENT:6402,ALPHA:6406,RGB:6407,RGBA:6408,LUMINANCE:6409,LUMINANCE_ALPHA:6410,UNSIGNED_SHORT_4_4_4_4:32819,UNSIGNED_SHORT_5_5_5_1:32820,UNSIGNED_SHORT_5_6_5:33635,FRAGMENT_SHADER:35632,VERTEX_SHADER:35633,MAX_VERTEX_ATTRIBS:34921,MAX_VERTEX_UNIFORM_VECTORS:36347,MAX_VARYING_VECTORS:36348,MAX_COMBINED_TEXTURE_IMAGE_UNITS:35661,MAX_VERTEX_TEXTURE_IMAGE_UNITS:35660,MAX_TEXTURE_IMAGE_UNITS:34930,MAX_FRAGMENT_UNIFORM_VECTORS:36349,SHADER_TYPE:35663,DELETE_STATUS:35712,LINK_STATUS:35714,VALIDATE_STATUS:35715,ATTACHED_SHADERS:35717,ACTIVE_UNIFORMS:35718,ACTIVE_ATTRIBUTES:35721,SHADING_LANGUAGE_VERSION:35724,CURRENT_PROGRAM:35725,NEVER:512,LESS:513,EQUAL:514,LEQUAL:515,GREATER:516,NOTEQUAL:517,GEQUAL:518,ALWAYS:519,KEEP:7680,REPLACE:7681,INCR:7682,DECR:7683,INVERT:5386,INCR_WRAP:34055,DECR_WRAP:34056,VENDOR:7936,RENDERER:7937,VERSION:7938,NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987,TEXTURE_MAG_FILTER:10240,TEXTURE_MIN_FILTER:10241,TEXTURE_WRAP_S:10242,TEXTURE_WRAP_T:10243,TEXTURE_2D:3553,TEXTURE:5890,TEXTURE_CUBE_MAP:34067,TEXTURE_BINDING_CUBE_MAP:34068,TEXTURE_CUBE_MAP_POSITIVE_X:34069,TEXTURE_CUBE_MAP_NEGATIVE_X:34070,TEXTURE_CUBE_MAP_POSITIVE_Y:34071,TEXTURE_CUBE_MAP_NEGATIVE_Y:34072,TEXTURE_CUBE_MAP_POSITIVE_Z:34073,TEXTURE_CUBE_MAP_NEGATIVE_Z:34074,MAX_CUBE_MAP_TEXTURE_SIZE:34076,TEXTURE0:33984,TEXTURE1:33985,TEXTURE2:33986,TEXTURE3:33987,TEXTURE4:33988,TEXTURE5:33989,TEXTURE6:33990,TEXTURE7:33991,TEXTURE8:33992,TEXTURE9:33993,TEXTURE10:33994,TEXTURE11:33995,TEXTURE12:33996,TEXTURE13:33997,TEXTURE14:33998,TEXTURE15:33999,TEXTURE16:34e3,TEXTURE17:34001,TEXTURE18:34002,TEXTURE19:34003,TEXTURE20:34004,TEXTURE21:34005,TEXTURE22:34006,TEXTURE23:34007,TEXTURE24:34008,TEXTURE25:34009,TEXTURE26:34010,TEXTURE27:34011,TEXTURE28:34012,TEXTURE29:34013,TEXTURE30:34014,TEXTURE31:34015,ACTIVE_TEXTURE:34016,REPEAT:10497,CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,INT_VEC2:35667,INT_VEC3:35668,INT_VEC4:35669,BOOL:35670,BOOL_VEC2:35671,BOOL_VEC3:35672,BOOL_VEC4:35673,FLOAT_MAT2:35674,FLOAT_MAT3:35675,FLOAT_MAT4:35676,SAMPLER_2D:35678,SAMPLER_CUBE:35680,VERTEX_ATTRIB_ARRAY_ENABLED:34338,VERTEX_ATTRIB_ARRAY_SIZE:34339,VERTEX_ATTRIB_ARRAY_STRIDE:34340,VERTEX_ATTRIB_ARRAY_TYPE:34341,VERTEX_ATTRIB_ARRAY_NORMALIZED:34922,VERTEX_ATTRIB_ARRAY_POINTER:34373,VERTEX_ATTRIB_ARRAY_BUFFER_BINDING:34975,COMPILE_STATUS:35713,LOW_FLOAT:36336,MEDIUM_FLOAT:36337,HIGH_FLOAT:36338,LOW_INT:36339,MEDIUM_INT:36340,HIGH_INT:36341,FRAMEBUFFER:36160,RENDERBUFFER:36161,RGBA4:32854,RGB5_A1:32855,RGB565:36194,DEPTH_COMPONENT16:33189,STENCIL_INDEX:6401,STENCIL_INDEX8:36168,DEPTH_STENCIL:34041,RENDERBUFFER_WIDTH:36162,RENDERBUFFER_HEIGHT:36163,RENDERBUFFER_INTERNAL_FORMAT:36164,RENDERBUFFER_RED_SIZE:36176,RENDERBUFFER_GREEN_SIZE:36177,RENDERBUFFER_BLUE_SIZE:36178,RENDERBUFFER_ALPHA_SIZE:36179,RENDERBUFFER_DEPTH_SIZE:36180,RENDERBUFFER_STENCIL_SIZE:36181,FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE:36048,FRAMEBUFFER_ATTACHMENT_OBJECT_NAME:36049,FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL:36050,FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE:36051,COLOR_ATTACHMENT0:36064,DEPTH_ATTACHMENT:36096,STENCIL_ATTACHMENT:36128,DEPTH_STENCIL_ATTACHMENT:33306,NONE:0,FRAMEBUFFER_COMPLETE:36053,FRAMEBUFFER_INCOMPLETE_ATTACHMENT:36054,FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:36055,FRAMEBUFFER_INCOMPLETE_DIMENSIONS:36057,FRAMEBUFFER_UNSUPPORTED:36061,FRAMEBUFFER_BINDING:36006,RENDERBUFFER_BINDING:36007,MAX_RENDERBUFFER_SIZE:34024,INVALID_FRAMEBUFFER_OPERATION:1286,UNPACK_FLIP_Y_WEBGL:37440,UNPACK_PREMULTIPLY_ALPHA_WEBGL:37441,CONTEXT_LOST_WEBGL:37442,UNPACK_COLORSPACE_CONVERSION_WEBGL:37443,BROWSER_DEFAULT_WEBGL:37444},dt=function(){this._contextId=0,this._caches=[],this._context={}};(dt.prototype={use:function(t,e){var r=this._caches;r[t]||(r[t]={},e&&(r[t]=e())),this._contextId=t,this._context=r[t]},put:function(t,e){this._context[t]=e},get:function(t){return this._context[t]},dirty:function(t){var e="__dt__"+(t=t||"");this.put(e,!0)},dirtyAll:function(t){for(var e="__dt__"+(t=t||""),r=this._caches,n=0;n<r.length;n++)r[n]&&(r[n][e]=!0)},fresh:function(t){var e="__dt__"+(t=t||"");this.put(e,!1)},freshAll:function(t){for(var e="__dt__"+(t=t||""),r=this._caches,n=0;n<r.length;n++)r[n]&&(r[n][e]=!1)},isDirty:function(t){var e="__dt__"+(t=t||""),r=this._context;return!r.hasOwnProperty(e)||!0===r[e]},deleteContext:function(t){delete this._caches[t],this._context={}},delete:function(t){delete this._context[t]},clearAll:function(){this._caches={}},getContext:function(){return this._context},eachContext:function(t,e){Object.keys(this._caches).forEach(function(r){t&&t.call(e,r)})},miss:function(t){return!this._context.hasOwnProperty(t)}}).constructor=dt;var pt=dt;function mt(t){return{byte:G.a.Int8Array,ubyte:G.a.Uint8Array,short:G.a.Int16Array,ushort:G.a.Uint16Array}[t]||G.a.Float32Array}function gt(t){return"attr_"+t}function _t(t,e,r,n){switch(this.name=t,this.type=e,this.size=r,this.semantic=n||"",this.value=null,r){case 1:this.get=function(t){return this.value[t]},this.set=function(t,e){this.value[t]=e},this.copy=function(t,e){this.value[t]=this.value[t]};break;case 2:this.get=function(t,e){var r=this.value;return e[0]=r[2*t],e[1]=r[2*t+1],e},this.set=function(t,e){var r=this.value;r[2*t]=e[0],r[2*t+1]=e[1]},this.copy=function(t,e){var r=this.value;e*=2,r[t*=2]=r[e],r[t+1]=r[e+1]};break;case 3:this.get=function(t,e){var r=3*t,n=this.value;return e[0]=n[r],e[1]=n[r+1],e[2]=n[r+2],e},this.set=function(t,e){var r=3*t,n=this.value;n[r]=e[0],n[r+1]=e[1],n[r+2]=e[2]},this.copy=function(t,e){var r=this.value;e*=3,r[t*=3]=r[e],r[t+1]=r[e+1],r[t+2]=r[e+2]};break;case 4:this.get=function(t,e){var r=this.value,n=4*t;return e[0]=r[n],e[1]=r[n+1],e[2]=r[n+2],e[3]=r[n+3],e},this.set=function(t,e){var r=this.value,n=4*t;r[n]=e[0],r[n+1]=e[1],r[n+2]=e[2],r[n+3]=e[3]},this.copy=function(t,e){var r=this.value;e*=4,r[t*=4]=r[e],r[t+1]=r[e+1],r[t+2]=r[e+2],r[t+3]=r[e+3]}}}function yt(t,e,r,n,i){this.name=t,this.type=e,this.buffer=r,this.size=n,this.semantic=i,this.symbol="",this.needsRemove=!1}function vt(t){this.buffer=t,this.count=0}_t.prototype.init=function(t){if(!this.value||this.value.length!=t*this.size){var e=mt(this.type);this.value=new e(t*this.size)}},_t.prototype.fromArray=function(t){var e,r=mt(this.type);if(t[0]&&t[0].length){var n=0,i=this.size;e=new r(t.length*i);for(var o=0;o<t.length;o++)for(var a=0;a<i;a++)e[n++]=t[o][a]}else e=new r(t);this.value=e},_t.prototype.clone=function(t){var e=new _t(this.name,this.type,this.size,this.semantic);return t&&console.warn("todo"),e};var xt=ct.extend(function(){return{attributes:{},indices:null,dynamic:!0,_enabledAttributes:null,__used:0}},function(){this._cache=new pt,this._attributeList=Object.keys(this.attributes),this.__vaoCache={}},{mainAttribute:"",pick:null,pickByRay:null,dirty:function(){for(var t=this.getEnabledAttributes(),e=0;e<t.length;e++)this.dirtyAttribute(t[e]);this.dirtyIndices(),this._enabledAttributes=null,this._cache.dirty("any")},dirtyIndices:function(){this._cache.dirtyAll("indices")},dirtyAttribute:function(t){this._cache.dirtyAll(gt(t)),this._cache.dirtyAll("attributes")},getTriangleIndices:function(t,e){if(t<this.triangleCount&&t>=0){e||(e=[]);var r=this.indices;return e[0]=r[3*t],e[1]=r[3*t+1],e[2]=r[3*t+2],e}},setTriangleIndices:function(t,e){var r=this.indices;r[3*t]=e[0],r[3*t+1]=e[1],r[3*t+2]=e[2]},isUseIndices:function(){return!!this.indices},initIndicesFromArray:function(t){var e,r=this.vertexCount>65535?G.a.Uint32Array:G.a.Uint16Array;if(t[0]&&t[0].length){var n=0;e=new r(3*t.length);for(var i=0;i<t.length;i++)for(var o=0;o<3;o++)e[n++]=t[i][o]}else e=new r(t);this.indices=e},createAttribute:function(t,e,r,n){var i=new _t(t,e,r,n);return this.attributes[t]&&this.removeAttribute(t),this.attributes[t]=i,this._attributeList.push(t),i},removeAttribute:function(t){var e=this._attributeList,r=e.indexOf(t);return r>=0&&(e.splice(r,1),delete this.attributes[t],!0)},getAttribute:function(t){return this.attributes[t]},getEnabledAttributes:function(){var t=this._enabledAttributes,e=this._attributeList;if(t)return t;for(var r=[],n=this.vertexCount,i=0;i<e.length;i++){var o=e[i],a=this.attributes[o];a.value&&a.value.length===n*a.size&&r.push(o)}return this._enabledAttributes=r,r},getBufferChunks:function(t){var e=this._cache;e.use(t.__uid__);var r=e.isDirty("attributes"),n=e.isDirty("indices");if(r||n){this._updateBuffer(t.gl,r,n);for(var i=this.getEnabledAttributes(),o=0;o<i.length;o++)e.fresh(gt(i[o]));e.fresh("attributes"),e.fresh("indices")}return e.fresh("any"),e.get("chunks")},_updateBuffer:function(t,e,r){var n=this._cache,i=n.get("chunks"),o=!1;i||((i=[])[0]={attributeBuffers:[],indicesBuffer:null},n.put("chunks",i),o=!0);var a=i[0],s=a.attributeBuffers,h=a.indicesBuffer;if(e||o){var u=this.getEnabledAttributes(),l={};if(!o)for(var c=0;c<s.length;c++)l[s[c].name]=s[c];for(var f=0;f<u.length;f++){var d,p,m=u[f],g=this.attributes[m];o||(d=l[m]),p=d?d.buffer:t.createBuffer(),n.isDirty(gt(m))&&(t.bindBuffer(t.ARRAY_BUFFER,p),t.bufferData(t.ARRAY_BUFFER,g.value,this.dynamic?ft.DYNAMIC_DRAW:ft.STATIC_DRAW)),s[f]=new yt(m,g.type,p,g.size,g.semantic)}for(c=f;c<s.length;c++)t.deleteBuffer(s[c].buffer);s.length=f}this.isUseIndices()&&(r||o)&&(h||(h=new vt(t.createBuffer()),a.indicesBuffer=h),h.count=this.indices.length,t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,h.buffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.indices,this.dynamic?ft.DYNAMIC_DRAW:ft.STATIC_DRAW))},dispose:function(t){var e=this._cache;e.use(t.__uid__);var r=e.get("chunks");if(r)for(var n=0;n<r.length;n++){for(var i=r[n],o=0;o<i.attributeBuffers.length;o++){var a=i.attributeBuffers[o];t.gl.deleteBuffer(a.buffer)}i.indicesBuffer&&t.gl.deleteBuffer(i.indicesBuffer.buffer)}if(this.__vaoCache){var s=t.getGLExtension("OES_vertex_array_object");for(var h in this.__vaoCache){var u=this.__vaoCache[h].vao;u&&s.deleteVertexArrayOES(u)}}this.__vaoCache={},e.deleteContext(t.__uid__)}});Object.defineProperty&&(Object.defineProperty(xt.prototype,"vertexCount",{enumerable:!1,get:function(){var t=this.attributes[this.mainAttribute];return t||(t=this.attributes[this._attributeList[0]]),t&&t.value?t.value.length/t.size:0}}),Object.defineProperty(xt.prototype,"triangleCount",{enumerable:!1,get:function(){var t=this.indices;return t?t.length/3:0}})),xt.STATIC_DRAW=ft.STATIC_DRAW,xt.DYNAMIC_DRAW=ft.DYNAMIC_DRAW,xt.STREAM_DRAW=ft.STREAM_DRAW,xt.AttributeBuffer=yt,xt.IndicesBuffer=vt,xt.Attribute=_t;var bt=xt,wt=D.create,Tt=D.add,Et=D.set,Ct=bt.Attribute,St=bt.extend(function(){return{attributes:{position:new Ct("position","float",3,"POSITION"),texcoord0:new Ct("texcoord0","float",2,"TEXCOORD_0"),texcoord1:new Ct("texcoord1","float",2,"TEXCOORD_1"),normal:new Ct("normal","float",3,"NORMAL"),tangent:new Ct("tangent","float",4,"TANGENT"),color:new Ct("color","float",4,"COLOR"),weight:new Ct("weight","float",3,"WEIGHT"),joint:new Ct("joint","float",4,"JOINT"),barycentric:new Ct("barycentric","float",3,null)},boundingBox:null}},{mainAttribute:"position",updateBoundingBox:function(){var t=this.boundingBox;t||(t=this.boundingBox=new et);var e=this.attributes.position.value;if(e&&e.length){var r=t.min,n=t.max,i=r.array,o=n.array;D.set(i,e[0],e[1],e[2]),D.set(o,e[0],e[1],e[2]);for(var a=3;a<e.length;){var s=e[a++],h=e[a++],u=e[a++];s<i[0]&&(i[0]=s),h<i[1]&&(i[1]=h),u<i[2]&&(i[2]=u),s>o[0]&&(o[0]=s),h>o[1]&&(o[1]=h),u>o[2]&&(o[2]=u)}r._dirty=!0,n._dirty=!0}},generateVertexNormals:function(){if(this.vertexCount){var t=this.indices,e=this.attributes,r=e.position.value,n=e.normal.value;if(n&&n.length===r.length)for(var i=0;i<n.length;i++)n[i]=0;else n=e.normal.value=new G.a.Float32Array(r.length);for(var o,a,s,h=wt(),u=wt(),l=wt(),c=wt(),f=wt(),d=wt(),p=t?t.length:this.vertexCount,m=0;m<p;){t?(o=t[m++],a=t[m++],s=t[m++]):(o=m++,a=m++,s=m++),Et(h,r[3*o],r[3*o+1],r[3*o+2]),Et(u,r[3*a],r[3*a+1],r[3*a+2]),Et(l,r[3*s],r[3*s+1],r[3*s+2]),D.sub(c,h,u),D.sub(f,u,l),D.cross(d,c,f);for(i=0;i<3;i++)n[3*o+i]=n[3*o+i]+d[i],n[3*a+i]=n[3*a+i]+d[i],n[3*s+i]=n[3*s+i]+d[i]}for(i=0;i<n.length;)Et(d,n[i],n[i+1],n[i+2]),D.normalize(d,d),n[i++]=d[0],n[i++]=d[1],n[i++]=d[2];this.dirty()}},generateFaceNormals:function(){if(this.vertexCount){this.isUniqueVertex()||this.generateUniqueVertex();var t=this.indices,e=this.attributes,r=e.position.value,n=e.normal.value,i=wt(),o=wt(),a=wt(),s=wt(),h=wt(),u=wt();n||(n=e.normal.value=new Float32Array(r.length));for(var l,c,f,d=t?t.length:this.vertexCount,p=0;p<d;){t?(l=t[p++],c=t[p++],f=t[p++]):(l=p++,c=p++,f=p++),Et(i,r[3*l],r[3*l+1],r[3*l+2]),Et(o,r[3*c],r[3*c+1],r[3*c+2]),Et(a,r[3*f],r[3*f+1],r[3*f+2]),D.sub(s,i,o),D.sub(h,o,a),D.cross(u,s,h),D.normalize(u,u);for(var m=0;m<3;m++)n[3*l+m]=u[m],n[3*c+m]=u[m],n[3*f+m]=u[m]}this.dirty()}},generateTangents:function(){if(this.vertexCount){var t=this.vertexCount,e=this.attributes;e.tangent.value||(e.tangent.value=new Float32Array(4*t));var r=e.texcoord0.value,n=e.position.value,i=e.tangent.value,o=e.normal.value;if(r){for(var a=[],s=[],h=0;h<t;h++)a[h]=[0,0,0],s[h]=[0,0,0];var u,l,c,f=[0,0,0],d=[0,0,0],p=this.indices,m=p?p.length:this.vertexCount;for(h=0;h<m;){p?(u=p[h++],l=p[h++],c=p[h++]):(u=h++,l=h++,c=h++);var g=r[2*u],_=r[2*l],y=r[2*c],v=r[2*u+1],x=r[2*l+1],b=r[2*c+1],w=n[3*u],T=n[3*l],E=n[3*c],C=n[3*u+1],S=n[3*l+1],A=n[3*c+1],M=n[3*u+2],P=T-w,R=E-w,L=S-C,O=A-C,k=n[3*l+2]-M,I=n[3*c+2]-M,N=_-g,F=y-g,B=x-v,z=b-v,U=1/(N*z-B*F);f[0]=(z*P-B*R)*U,f[1]=(z*L-B*O)*U,f[2]=(z*k-B*I)*U,d[0]=(N*R-F*P)*U,d[1]=(N*O-F*L)*U,d[2]=(N*I-F*k)*U,Tt(a[u],a[u],f),Tt(a[l],a[l],f),Tt(a[c],a[c],f),Tt(s[u],s[u],d),Tt(s[l],s[l],d),Tt(s[c],s[c],d)}var H=wt(),j=wt(),G=wt();for(h=0;h<t;h++){G[0]=o[3*h],G[1]=o[3*h+1],G[2]=o[3*h+2];var V=a[h];D.scale(H,G,D.dot(G,V)),D.sub(H,V,H),D.normalize(H,H),D.cross(j,G,V),i[4*h]=H[0],i[4*h+1]=H[1],i[4*h+2]=H[2],i[4*h+3]=D.dot(j,s[h])<0?-1:1}this.dirty()}else console.warn("Geometry without texcoords can't generate tangents.")}},isUniqueVertex:function(){return!this.isUseIndices()||this.vertexCount===this.indices.length},generateUniqueVertex:function(){if(this.vertexCount&&this.indices){this.indices.length>65535&&(this.indices=new G.a.Uint32Array(this.indices));for(var t=this.attributes,e=this.indices,r=this.getEnabledAttributes(),n={},i=0;i<r.length;i++){n[h=r[i]]=t[h].value,t[h].init(this.indices.length)}for(var o=0,a=0;a<e.length;a++){var s=e[a];for(i=0;i<r.length;i++)for(var h,u=t[h=r[i]].value,l=t[h].size,c=0;c<l;c++)u[o*l+c]=n[h][s*l+c];e[a]=o,o++}this.dirty()}},generateBarycentric:function(){if(this.vertexCount){this.isUniqueVertex()||this.generateUniqueVertex();var t=this.attributes,e=t.barycentric.value,r=this.indices;if(!e||e.length!==3*r.length){e=t.barycentric.value=new Float32Array(3*r.length);for(var n=0;n<(r?r.length:this.vertexCount/3);)for(var i=0;i<3;i++){e[3*(r?r[n++]:3*n+i)+i]=1}this.dirty()}}},applyTransform:function(t){var e=this.attributes,r=e.position.value,n=e.normal.value,i=e.tangent.value;t=t.array;var o=K.create();K.invert(o,t),K.transpose(o,o);var a=D.transformMat4,s=D.forEach;s(r,3,0,null,a,t),n&&s(n,3,0,null,a,o),i&&s(i,4,0,null,a,o),this.boundingBox&&this.updateBoundingBox()},dispose:function(t){var e=this._cache;e.use(t.__uid__);var r=e.get("chunks");if(r)for(var n=0;n<r.length;n++){for(var i=r[n],o=0;o<i.attributeBuffers.length;o++){var a=i.attributeBuffers[o];t.gl.deleteBuffer(a.buffer)}i.indicesBuffer&&t.gl.deleteBuffer(i.indicesBuffer.buffer)}if(this.__vaoCache){var s=t.getGLExtension("OES_vertex_array_object");for(var h in this.__vaoCache){var u=this.__vaoCache[h].vao;u&&s.deleteVertexArrayOES(u)}}this.__vaoCache={},e.deleteContext(t.__uid__)}});St.STATIC_DRAW=bt.STATIC_DRAW,St.DYNAMIC_DRAW=bt.DYNAMIC_DRAW,St.STREAM_DRAW=bt.STREAM_DRAW,St.AttributeBuffer=bt.AttributeBuffer,St.IndicesBuffer=bt.IndicesBuffer,St.Attribute=Ct;var At=St,Mt={linear:function(t){return t},quadraticIn:function(t){return t*t},quadraticOut:function(t){return t*(2-t)},quadraticInOut:function(t){return(t*=2)<1?.5*t*t:-.5*(--t*(t-2)-1)},cubicIn:function(t){return t*t*t},cubicOut:function(t){return--t*t*t+1},cubicInOut:function(t){return(t*=2)<1?.5*t*t*t:.5*((t-=2)*t*t+2)},quarticIn:function(t){return t*t*t*t},quarticOut:function(t){return 1- --t*t*t*t},quarticInOut:function(t){return(t*=2)<1?.5*t*t*t*t:-.5*((t-=2)*t*t*t-2)},quinticIn:function(t){return t*t*t*t*t},quinticOut:function(t){return--t*t*t*t*t+1},quinticInOut:function(t){return(t*=2)<1?.5*t*t*t*t*t:.5*((t-=2)*t*t*t*t+2)},sinusoidalIn:function(t){return 1-Math.cos(t*Math.PI/2)},sinusoidalOut:function(t){return Math.sin(t*Math.PI/2)},sinusoidalInOut:function(t){return.5*(1-Math.cos(Math.PI*t))},exponentialIn:function(t){return 0===t?0:Math.pow(1024,t-1)},exponentialOut:function(t){return 1===t?1:1-Math.pow(2,-10*t)},exponentialInOut:function(t){return 0===t?0:1===t?1:(t*=2)<1?.5*Math.pow(1024,t-1):.5*(2-Math.pow(2,-10*(t-1)))},circularIn:function(t){return 1-Math.sqrt(1-t*t)},circularOut:function(t){return Math.sqrt(1- --t*t)},circularInOut:function(t){return(t*=2)<1?-.5*(Math.sqrt(1-t*t)-1):.5*(Math.sqrt(1-(t-=2)*t)+1)},elasticIn:function(t){var e,r=.1;return 0===t?0:1===t?1:(!r||r<1?(r=1,e=.1):e=.4*Math.asin(1/r)/(2*Math.PI),-r*Math.pow(2,10*(t-=1))*Math.sin((t-e)*(2*Math.PI)/.4))},elasticOut:function(t){var e,r=.1;return 0===t?0:1===t?1:(!r||r<1?(r=1,e=.1):e=.4*Math.asin(1/r)/(2*Math.PI),r*Math.pow(2,-10*t)*Math.sin((t-e)*(2*Math.PI)/.4)+1)},elasticInOut:function(t){var e,r=.1;return 0===t?0:1===t?1:(!r||r<1?(r=1,e=.1):e=.4*Math.asin(1/r)/(2*Math.PI),(t*=2)<1?r*Math.pow(2,10*(t-=1))*Math.sin((t-e)*(2*Math.PI)/.4)*-.5:r*Math.pow(2,-10*(t-=1))*Math.sin((t-e)*(2*Math.PI)/.4)*.5+1)},backIn:function(t){var e=1.70158;return t*t*((e+1)*t-e)},backOut:function(t){var e=1.70158;return--t*t*((e+1)*t+e)+1},backInOut:function(t){var e=2.5949095;return(t*=2)<1?t*t*((e+1)*t-e)*.5:.5*((t-=2)*t*((e+1)*t+e)+2)},bounceIn:function(t){return 1-Mt.bounceOut(1-t)},bounceOut:function(t){return t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375},bounceInOut:function(t){return t<.5?.5*Mt.bounceIn(2*t):.5*Mt.bounceOut(2*t-1)+.5}},Pt=Mt;function Rt(){}var Lt=function(t){t=t||{},this.name=t.name||"",this.target=t.target,this.life=t.life||1e3,this.delay=t.delay||0,this.gap=t.gap||0,this.playbackRate=t.playbackRate||1,this._initialized=!1,this._elapsedTime=0,this._loop=null!=t.loop&&t.loop,this.setLoop(this._loop),null!=t.easing&&this.setEasing(t.easing),this.onframe=t.onframe||Rt,this.onfinish=t.onfinish||Rt,this.onrestart=t.onrestart||Rt,this._paused=!1};(Lt.prototype={gap:0,life:0,delay:0,setLoop:function(t){this._loop=t,t&&(this._loopRemained="number"==typeof t?t:1/0)},setEasing:function(t){"string"==typeof t&&(t=Pt[t]),this.easing=t},step:function(t,e,r){if(this._initialized||(this._startTime=t+this.delay,this._initialized=!0),null!=this._currentTime&&(e=t-this._currentTime),this._currentTime=t,this._paused)return"paused";if(!(t<this._startTime)){this._elapse(t,e);var n,i=Math.min(this._elapsedTime/this.life,1);if(!(i<0))return n=this.easing?this.easing(i):i,r||this.fire("frame",n),1===i?this._loop&&this._loopRemained>0?(this._restartInLoop(t),this._loopRemained--,"restart"):(this._needsRemove=!0,"finish"):null}},setTime:function(t){return this.step(t+this._startTime)},restart:function(t){var e=0;t&&(this._elapse(t),e=this._elapsedTime%this.life),t=t||Date.now(),this._startTime=t-e+this.delay,this._elapsedTime=0,this._needsRemove=!1,this._paused=!1},getElapsedTime:function(){return this._elapsedTime},_restartInLoop:function(t){this._startTime=t+this.gap,this._elapsedTime=0},_elapse:function(t,e){this._elapsedTime+=e*this.playbackRate},fire:function(t,e){var r="on"+t;this[r]&&this[r](this.target,e)},clone:function(){var t=new this.constructor;return t.name=this.name,t._loop=this._loop,t._loopRemained=this._loopRemained,t.life=this.life,t.gap=this.gap,t.delay=this.delay,t},pause:function(){this._paused=!0},resume:function(){this._paused=!1}}).constructor=Lt;var Ot=Lt,kt=Array.prototype.slice;function Dt(t,e){return t[e]}function It(t,e,r){t[e]=r}function Nt(t,e,r){return(e-t)*r+t}function Ft(t){return void 0!==t&&("string"!=typeof t&&"number"==typeof t.length)}function Bt(t){if(Ft(t)){var e=t.length;if(Ft(t[0])){for(var r=[],n=0;n<e;n++)r.push(kt.call(t[n]));return r}return kt.call(t)}return t}function zt(t,e,r,n,i,o,a){var s=.5*(r-t),h=.5*(n-e);return(2*(e-r)+s+h)*a+(-3*(e-r)-2*s-h)*o+s*i+e}function Ut(t,e,r){var n=t.length,i=e.length;if(n!==i)if(n>i)t.length=i;else for(var o=n;o<i;o++)t.push(1===r?e[o]:kt.call(e[o]));var a=t[0]&&t[0].length;for(o=0;o<t.length;o++)if(1===r)isNaN(t[o])&&(t[o]=e[o]);else for(var s=0;s<a;s++)isNaN(t[o][s])&&(t[o][s]=e[o][s])}function Ht(t,e,r){if(t===e)return!0;var n=t.length;if(n!==e.length)return!1;if(1===r){for(var i=0;i<n;i++)if(t[i]!==e[i])return!1}else{var o=t[0].length;for(i=0;i<n;i++)for(var a=0;a<o;a++)if(t[i][a]!==e[i][a])return!1}return!0}function jt(t,e,r,n,i,o,a){var s=t._getter,h=t._setter,u="spline"===e,l=n.length;if(l){var c=n[0].value,f=Ft(c),d=f&&Ft(c[0])?2:1;n.sort(function(t,e){return t.time-e.time});for(var p=[],m=[],g=[],_=n[0].value,y=!0,v=0;v<l;v++){p.push(n[v].time/a);var x=n[v].value;f&&Ht(x,_,d)||!f&&x===_||(y=!1),_=x,m.push(x),g.push(n[v].easing)}if(!y){var b=m[l-1];for(v=0;v<l-1;v++)f?Ut(m[v],b,d):isNaN(m[v])&&!isNaN(b)&&(m[v]=b);f&&Ut(s(t._target,i),b,d);var w,T,E,C,S,A,M=0,P=0,R=new Ot({target:t._target,life:a,loop:t._loop,delay:t._delay,onframe:function(t,e){if(e<P){for(w=Math.min(M+1,l-1),v=w;v>=0&&!(p[v]<=e);v--);v=Math.min(v,l-2)}else{for(v=M;v<l&&!(p[v]>e);v++);v=Math.min(v-1,l-2)}M=v,P=e;var r=p[v+1]-p[v];0!==r&&(T=(e-p[v])/r,T=Math.max(Math.min(1,T),0),T=g[v+1](T),u?(C=m[v],E=m[0===v?v:v-1],S=m[v>l-2?l-1:v+1],A=m[v>l-3?l-1:v+2],o?h(t,i,o(s(t,i),E,C,S,A,T)):f?function(t,e,r,n,i,o,a,s,h){var u=t.length;if(1==h)for(var l=0;l<u;l++)s[l]=zt(t[l],e[l],r[l],n[l],i,o,a);else{var c=t[0].length;for(l=0;l<u;l++)for(var f=0;f<c;f++)s[l][f]=zt(t[l][f],e[l][f],r[l][f],n[l][f],i,o,a)}}(E,C,S,A,T,T*T,T*T*T,s(t,i),d):h(t,i,zt(E,C,S,A,T,T*T,T*T*T))):o?h(t,i,o(s(t,i),m[v],m[v+1],T)):f?function(t,e,r,n,i){var o=t.length;if(1==i)for(var a=0;a<o;a++)n[a]=Nt(t[a],e[a],r);else{var s=t[0].length;for(a=0;a<o;a++)for(var h=0;h<s;h++)n[a][h]=Nt(t[a][h],e[a][h],r)}}(m[v],m[v+1],T,s(t,i),d):h(t,i,Nt(m[v],m[v+1],T)))},onfinish:r});return e&&"spline"!==e&&R.setEasing(e),R}}}function Gt(t,e,r,n,i){this._tracks={},this._target=t,this._loop=e||!1,this._getter=r||Dt,this._setter=n||It,this._interpolater=i||null,this._delay=0,this._doneList=[],this._onframeList=[],this._clipList=[],this._maxTime=0,this._lastKFTime=0}function Vt(t){return t}Gt.prototype={constructor:Gt,when:function(t,e,r){for(var n in this._maxTime=Math.max(t,this._maxTime),r=("function"==typeof r?r:Pt[r])||Vt,e)this._tracks[n]||(this._tracks[n]=[],0!==t&&this._tracks[n].push({time:0,value:Bt(this._getter(this._target,n)),easing:r})),this._tracks[n].push({time:parseInt(t),value:e[n],easing:r});return this},then:function(t,e,r){return this.when(t+this._lastKFTime,e,r),this._lastKFTime+=t,this},during:function(t){return this._onframeList.push(t),this},_doneCallback:function(){this._tracks={},this._clipList.length=0;for(var t=this._doneList,e=t.length,r=0;r<e;r++)t[r].call(this)},start:function(t){var e,r=this,n=0,i=function(){0===--n&&r._doneCallback()},o=0;for(var a in this._tracks){var s=jt(this,t,i,this._tracks[a],a,r._interpolater,r._maxTime);s&&(o=Math.max(o,s.life),this._clipList.push(s),n++,this.animation&&this.animation.addClip(s),e=s)}if(e){var h=e.onframe;e.onframe=function(t,e){h(t,e);for(var n=0;n<r._onframeList.length;n++)r._onframeList[n](t,e)}}return n||this._doneCallback(),this},stop:function(){for(var t=0;t<this._clipList.length;t++){var e=this._clipList[t];this.animation.removeClip(e)}this._clipList=[]},delay:function(t){return this._delay=t,this},done:function(t){return t&&this._doneList.push(t),this},getClips:function(){return this._clipList}};var Wt=Gt,Zt=function(t,e){return t.position<e.position},Xt=function(t){t=t||{},Ot.call(this,t),this.output=t.output||null,this.inputs=t.inputs||[],this.position=0,this._cacheKey=0,this._cachePosition=-1/0,this.inputs.sort(Zt)};(Xt.prototype=new Ot).constructor=Xt,Xt.prototype.addInput=function(t,e,r){var n={position:t,clip:e,offset:r||0};if(this.life=Math.max(e.life,this.life),!this.inputs.length)return this.inputs.push(n),n;var i=this.inputs.length;if(this.inputs[0].position>t)this.inputs.unshift(n);else if(this.inputs[i-1].position<=t)this.inputs.push(n);else{var o=this._findKey(t);this.inputs.splice(o,n)}return n},Xt.prototype.step=function(t,e,r){var n=Ot.prototype.step.call(this,t);return"finish"!==n&&this.setTime(this.getElapsedTime()),r||"paused"===n||this.fire("frame"),n},Xt.prototype.setTime=function(t){var e=this.position,r=this.inputs,n=r.length,i=r[0].position,o=r[n-1].position;if(e<=i||e>=o){var a=e<=i?r[0]:r[n-1],s=a.clip,h=a.offset;s.setTime((t+h)%s.life),s.output instanceof Ot?this.output.copy(s.output):this.output.copy(s)}else{var u=this._findKey(e),l=r[u],c=r[u+1],f=l.clip,d=c.clip;f.setTime((t+l.offset)%f.life),d.setTime((t+c.offset)%d.life);var p=(this.position-l.position)/(c.position-l.position),m=f.output instanceof Ot?f.output:f,g=d.output instanceof Ot?d.output:d;this.output.blend1D(m,g,p)}},Xt.prototype.clone=function(t){var e=Ot.prototype.clone.call(this);e.output=this.output.clone();for(var r=0;r<this.inputs.length;r++){var n=t?this.inputs[r].clip.clone(!0):this.inputs[r].clip;e.addInput(this.inputs[r].position,n,this.inputs[r].offset)}return e},Xt.prototype._findKey=function(t){var e=-1,r=this.inputs,n=r.length;if(this._cachePosition<t)for(var i=this._cacheKey;i<n-1;i++)t>=r[i].position&&t<r[i+1].position&&(e=i);else for(i=Math.min(n-2,this._cacheKey);i>=0;i--)t>=r[i].position&&t<r[i+1].position&&(e=i);return e>=0&&(this._cacheKey=e,this._cachePosition=t),e};var qt=1/1048576;function Yt(t,e,r,n){var i,o,a,s,h,u,l,c,f,d,p=t[e][0],m=t[e][1],g=t[r][0],_=t[r][1],y=t[n][0],v=t[n][1],x=Math.abs(m-_),b=Math.abs(_-v);if(x<qt&&b<qt)throw new Error("Eek! Coincident points!");return x<qt?o=(s=-(y-g)/(v-_))*((i=(g+p)/2)-(u=(g+y)/2))+(c=(_+v)/2):b<qt?o=(a=-(g-p)/(_-m))*((i=(y+g)/2)-(h=(p+g)/2))+(l=(m+_)/2):(i=((a=-(g-p)/(_-m))*(h=(p+g)/2)-(s=-(y-g)/(v-_))*(u=(g+y)/2)+(c=(_+v)/2)-(l=(m+_)/2))/(a-s),o=x>b?a*(i-h)+l:s*(i-u)+c),{i:e,j:r,k:n,x:i,y:o,r:(f=g-i)*f+(d=_-o)*d}}function Jt(t){var e,r,n,i,o,a;for(r=t.length;r;)for(i=t[--r],n=t[--r],e=r;e;)if(a=t[--e],n===(o=t[--e])&&i===a||n===a&&i===o){t.splice(r,2),t.splice(e,2);break}}var Kt={triangulate:function(t,e){var r,n,i,o,a,s,h,u,l,c,f,d,p=t.length;if(p<3)return[];if(t=t.slice(0),e)for(r=p;r--;)t[r]=t[r][e];for(i=new Array(p),r=p;r--;)i[r]=r;for(i.sort(function(e,r){var n=t[r][0]-t[e][0];return 0!==n?n:e-r}),o=function(t){var e,r,n,i,o,a,s=Number.POSITIVE_INFINITY,h=Number.POSITIVE_INFINITY,u=Number.NEGATIVE_INFINITY,l=Number.NEGATIVE_INFINITY;for(e=t.length;e--;)t[e][0]<s&&(s=t[e][0]),t[e][0]>u&&(u=t[e][0]),t[e][1]<h&&(h=t[e][1]),t[e][1]>l&&(l=t[e][1]);return n=l-h,[[(o=s+.5*(r=u-s))-20*(i=Math.max(r,n)),(a=h+.5*n)-i],[o,a+20*i],[o+20*i,a-i]]}(t),t.push(o[0],o[1],o[2]),a=[Yt(t,p+0,p+1,p+2)],s=[],h=[],r=i.length;r--;h.length=0){for(d=i[r],n=a.length;n--;)(u=t[d][0]-a[n].x)>0&&u*u>a[n].r?(s.push(a[n]),a.splice(n,1)):u*u+(l=t[d][1]-a[n].y)*l-a[n].r>qt||(h.push(a[n].i,a[n].j,a[n].j,a[n].k,a[n].k,a[n].i),a.splice(n,1));for(Jt(h),n=h.length;n;)f=h[--n],c=h[--n],a.push(Yt(t,c,f,d))}for(r=a.length;r--;)s.push(a[r]);for(a.length=0,r=s.length;r--;)s[r].i<p&&s[r].j<p&&s[r].k<p&&a.push(s[r].i,s[r].j,s[r].k);return a},contains:function(t,e){if(e[0]<t[0][0]&&e[0]<t[1][0]&&e[0]<t[2][0]||e[0]>t[0][0]&&e[0]>t[1][0]&&e[0]>t[2][0]||e[1]<t[0][1]&&e[1]<t[1][1]&&e[1]<t[2][1]||e[1]>t[0][1]&&e[1]>t[1][1]&&e[1]>t[2][1])return null;var r=t[1][0]-t[0][0],n=t[2][0]-t[0][0],i=t[1][1]-t[0][1],o=t[2][1]-t[0][1],a=r*o-n*i;if(0===a)return null;var s=(o*(e[0]-t[0][0])-n*(e[1]-t[0][1]))/a,h=(r*(e[1]-t[0][1])-i*(e[0]-t[0][0]))/a;return s<0||h<0||s+h>1?null:[s,h]}},Qt={create:function(){var t=new L(2);return t[0]=0,t[1]=0,t},clone:function(t){var e=new L(2);return e[0]=t[0],e[1]=t[1],e},fromValues:function(t,e){var r=new L(2);return r[0]=t,r[1]=e,r},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t},set:function(t,e,r){return t[0]=e,t[1]=r,t},add:function(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t},subtract:function(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t}};Qt.sub=Qt.subtract,Qt.multiply=function(t,e,r){return t[0]=e[0]*r[0],t[1]=e[1]*r[1],t},Qt.mul=Qt.multiply,Qt.divide=function(t,e,r){return t[0]=e[0]/r[0],t[1]=e[1]/r[1],t},Qt.div=Qt.divide,Qt.min=function(t,e,r){return t[0]=Math.min(e[0],r[0]),t[1]=Math.min(e[1],r[1]),t},Qt.max=function(t,e,r){return t[0]=Math.max(e[0],r[0]),t[1]=Math.max(e[1],r[1]),t},Qt.scale=function(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t},Qt.scaleAndAdd=function(t,e,r,n){return t[0]=e[0]+r[0]*n,t[1]=e[1]+r[1]*n,t},Qt.distance=function(t,e){var r=e[0]-t[0],n=e[1]-t[1];return Math.sqrt(r*r+n*n)},Qt.dist=Qt.distance,Qt.squaredDistance=function(t,e){var r=e[0]-t[0],n=e[1]-t[1];return r*r+n*n},Qt.sqrDist=Qt.squaredDistance,Qt.length=function(t){var e=t[0],r=t[1];return Math.sqrt(e*e+r*r)},Qt.len=Qt.length,Qt.squaredLength=function(t){var e=t[0],r=t[1];return e*e+r*r},Qt.sqrLen=Qt.squaredLength,Qt.negate=function(t,e){return t[0]=-e[0],t[1]=-e[1],t},Qt.inverse=function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t},Qt.normalize=function(t,e){var r=e[0],n=e[1],i=r*r+n*n;return i>0&&(i=1/Math.sqrt(i),t[0]=e[0]*i,t[1]=e[1]*i),t},Qt.dot=function(t,e){return t[0]*e[0]+t[1]*e[1]},Qt.cross=function(t,e,r){var n=e[0]*r[1]-e[1]*r[0];return t[0]=t[1]=0,t[2]=n,t},Qt.lerp=function(t,e,r,n){var i=e[0],o=e[1];return t[0]=i+n*(r[0]-i),t[1]=o+n*(r[1]-o),t},Qt.random=function(t,e){e=e||1;var r=2*GLMAT_RANDOM()*Math.PI;return t[0]=Math.cos(r)*e,t[1]=Math.sin(r)*e,t},Qt.transformMat2=function(t,e,r){var n=e[0],i=e[1];return t[0]=r[0]*n+r[2]*i,t[1]=r[1]*n+r[3]*i,t},Qt.transformMat2d=function(t,e,r){var n=e[0],i=e[1];return t[0]=r[0]*n+r[2]*i+r[4],t[1]=r[1]*n+r[3]*i+r[5],t},Qt.transformMat3=function(t,e,r){var n=e[0],i=e[1];return t[0]=r[0]*n+r[3]*i+r[6],t[1]=r[1]*n+r[4]*i+r[7],t},Qt.transformMat4=function(t,e,r){var n=e[0],i=e[1];return t[0]=r[0]*n+r[4]*i+r[12],t[1]=r[1]*n+r[5]*i+r[13],t},Qt.forEach=function(){var t=Qt.create();return function(e,r,n,i,o,a){var s,h;for(r||(r=2),n||(n=0),h=i?Math.min(i*r+n,e.length):e.length,s=n;s<h;s+=r)t[0]=e[s],t[1]=e[s+1],o(t,t,a),e[s]=t[0],e[s+1]=t[1];return e}}();var $t=Qt,te=function(t,e){t=t||0,e=e||0,this.array=$t.fromValues(t,e),this._dirty=!0};if(te.prototype={constructor:te,add:function(t){return $t.add(this.array,this.array,t.array),this._dirty=!0,this},set:function(t,e){return this.array[0]=t,this.array[1]=e,this._dirty=!0,this},setArray:function(t){return this.array[0]=t[0],this.array[1]=t[1],this._dirty=!0,this},clone:function(){return new te(this.x,this.y)},copy:function(t){return $t.copy(this.array,t.array),this._dirty=!0,this},cross:function(t,e){return $t.cross(t.array,this.array,e.array),t._dirty=!0,this},dist:function(t){return $t.dist(this.array,t.array)},distance:function(t){return $t.distance(this.array,t.array)},div:function(t){return $t.div(this.array,this.array,t.array),this._dirty=!0,this},divide:function(t){return $t.divide(this.array,this.array,t.array),this._dirty=!0,this},dot:function(t){return $t.dot(this.array,t.array)},len:function(){return $t.len(this.array)},length:function(){return $t.length(this.array)},lerp:function(t,e,r){return $t.lerp(this.array,t.array,e.array,r),this._dirty=!0,this},min:function(t){return $t.min(this.array,this.array,t.array),this._dirty=!0,this},max:function(t){return $t.max(this.array,this.array,t.array),this._dirty=!0,this},mul:function(t){return $t.mul(this.array,this.array,t.array),this._dirty=!0,this},multiply:function(t){return $t.multiply(this.array,this.array,t.array),this._dirty=!0,this},negate:function(){return $t.negate(this.array,this.array),this._dirty=!0,this},normalize:function(){return $t.normalize(this.array,this.array),this._dirty=!0,this},random:function(t){return $t.random(this.array,t),this._dirty=!0,this},scale:function(t){return $t.scale(this.array,this.array,t),this._dirty=!0,this},scaleAndAdd:function(t,e){return $t.scaleAndAdd(this.array,this.array,t.array,e),this._dirty=!0,this},sqrDist:function(t){return $t.sqrDist(this.array,t.array)},squaredDistance:function(t){return $t.squaredDistance(this.array,t.array)},sqrLen:function(){return $t.sqrLen(this.array)},squaredLength:function(){return $t.squaredLength(this.array)},sub:function(t){return $t.sub(this.array,this.array,t.array),this._dirty=!0,this},subtract:function(t){return $t.subtract(this.array,this.array,t.array),this._dirty=!0,this},transformMat2:function(t){return $t.transformMat2(this.array,this.array,t.array),this._dirty=!0,this},transformMat2d:function(t){return $t.transformMat2d(this.array,this.array,t.array),this._dirty=!0,this},transformMat3:function(t){return $t.transformMat3(this.array,this.array,t.array),this._dirty=!0,this},transformMat4:function(t){return $t.transformMat4(this.array,this.array,t.array),this._dirty=!0,this},toString:function(){return"["+Array.prototype.join.call(this.array,",")+"]"},toArray:function(){return Array.prototype.slice.call(this.array)}},Object.defineProperty){var ee=te.prototype;Object.defineProperty(ee,"x",{get:function(){return this.array[0]},set:function(t){this.array[0]=t,this._dirty=!0}}),Object.defineProperty(ee,"y",{get:function(){return this.array[1]},set:function(t){this.array[1]=t,this._dirty=!0}})}te.add=function(t,e,r){return $t.add(t.array,e.array,r.array),t._dirty=!0,t},te.set=function(t,e,r){return $t.set(t.array,e,r),t._dirty=!0,t},te.copy=function(t,e){return $t.copy(t.array,e.array),t._dirty=!0,t},te.cross=function(t,e,r){return $t.cross(t.array,e.array,r.array),t._dirty=!0,t},te.distance=te.dist=function(t,e){return $t.distance(t.array,e.array)},te.divide=te.div=function(t,e,r){return $t.divide(t.array,e.array,r.array),t._dirty=!0,t},te.dot=function(t,e){return $t.dot(t.array,e.array)},te.len=function(t){return $t.length(t.array)},te.lerp=function(t,e,r,n){return $t.lerp(t.array,e.array,r.array,n),t._dirty=!0,t},te.min=function(t,e,r){return $t.min(t.array,e.array,r.array),t._dirty=!0,t},te.max=function(t,e,r){return $t.max(t.array,e.array,r.array),t._dirty=!0,t},te.multiply=te.mul=function(t,e,r){return $t.multiply(t.array,e.array,r.array),t._dirty=!0,t},te.negate=function(t,e){return $t.negate(t.array,e.array),t._dirty=!0,t},te.normalize=function(t,e){return $t.normalize(t.array,e.array),t._dirty=!0,t},te.random=function(t,e){return $t.random(t.array,e),t._dirty=!0,t},te.scale=function(t,e,r){return $t.scale(t.array,e.array,r),t._dirty=!0,t},te.scaleAndAdd=function(t,e,r,n){return $t.scaleAndAdd(t.array,e.array,r.array,n),t._dirty=!0,t},te.squaredDistance=te.sqrDist=function(t,e){return $t.sqrDist(t.array,e.array)},te.squaredLength=te.sqrLen=function(t){return $t.sqrLen(t.array)},te.subtract=te.sub=function(t,e,r){return $t.subtract(t.array,e.array,r.array),t._dirty=!0,t},te.transformMat2=function(t,e,r){return $t.transformMat2(t.array,e.array,r.array),t._dirty=!0,t},te.transformMat2d=function(t,e,r){return $t.transformMat2d(t.array,e.array,r.array),t._dirty=!0,t},te.transformMat3=function(t,e,r){return $t.transformMat3(t.array,e.array,r.array),t._dirty=!0,t},te.transformMat4=function(t,e,r){return $t.transformMat4(t.array,e.array,r.array),t._dirty=!0,t};var re=te,ne=function(t){t=t||{},Ot.call(this,t),this.output=t.output||null,this.inputs=t.inputs||[],this.position=new re,this._cacheTriangle=null,this._triangles=[],this._updateTriangles()};(ne.prototype=new Ot).constructor=ne,ne.prototype.addInput=function(t,e,r){var n={position:t,clip:e,offset:r||0};return this.inputs.push(n),this.life=Math.max(e.life,this.life),this._updateTriangles(),n},ne.prototype._updateTriangles=function(){var t=this.inputs.map(function(t){return t.position});this._triangles=Kt.triangulate(t,"array")},ne.prototype.step=function(t,e,r){var n=Ot.prototype.step.call(this,t);return"finish"!==n&&this.setTime(this.getElapsedTime()),r||"paused"===n||this.fire("frame"),n},ne.prototype.setTime=function(t){var e=this._findTriangle(this.position);if(e){var r=e[1],n=e[2],i=e[0],o=this.inputs[i.indices[0]],a=this.inputs[i.indices[1]],s=this.inputs[i.indices[2]],h=o.clip,u=a.clip,l=s.clip;h.setTime((t+o.offset)%h.life),u.setTime((t+a.offset)%u.life),l.setTime((t+s.offset)%l.life);var c=h.output instanceof Ot?h.output:h,f=u.output instanceof Ot?u.output:u,d=l.output instanceof Ot?l.output:l;this.output.blend2D(c,f,d,r,n)}},ne.prototype.clone=function(t){var e=Ot.prototype.clone.call(this);e.output=this.output.clone();for(var r=0;r<this.inputs.length;r++){var n=t?this.inputs[r].clip.clone(!0):this.inputs[r].clip;e.addInput(this.inputs[r].position,n,this.inputs[r].offset)}return e},ne.prototype._findTriangle=function(t){if(this._cacheTriangle&&(r=Kt.contains(this._cacheTriangle.vertices,t.array)))return[this._cacheTriangle,r[0],r[1]];for(var e=0;e<this._triangles.length;e++){var r,n=this._triangles[e];if(r=Kt.contains(n.vertices,this.position.array))return this._cacheTriangle=n,[n,r[0],r[1]]}};var ie={create:function(){var t=new L(4);return t[0]=0,t[1]=0,t[2]=0,t[3]=0,t},clone:function(t){var e=new L(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},fromValues:function(t,e,r,n){var i=new L(4);return i[0]=t,i[1]=e,i[2]=r,i[3]=n,i},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},set:function(t,e,r,n,i){return t[0]=e,t[1]=r,t[2]=n,t[3]=i,t},add:function(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t[3]=e[3]+r[3],t},subtract:function(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t[3]=e[3]-r[3],t}};ie.sub=ie.subtract,ie.multiply=function(t,e,r){return t[0]=e[0]*r[0],t[1]=e[1]*r[1],t[2]=e[2]*r[2],t[3]=e[3]*r[3],t},ie.mul=ie.multiply,ie.divide=function(t,e,r){return t[0]=e[0]/r[0],t[1]=e[1]/r[1],t[2]=e[2]/r[2],t[3]=e[3]/r[3],t},ie.div=ie.divide,ie.min=function(t,e,r){return t[0]=Math.min(e[0],r[0]),t[1]=Math.min(e[1],r[1]),t[2]=Math.min(e[2],r[2]),t[3]=Math.min(e[3],r[3]),t},ie.max=function(t,e,r){return t[0]=Math.max(e[0],r[0]),t[1]=Math.max(e[1],r[1]),t[2]=Math.max(e[2],r[2]),t[3]=Math.max(e[3],r[3]),t},ie.scale=function(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t},ie.scaleAndAdd=function(t,e,r,n){return t[0]=e[0]+r[0]*n,t[1]=e[1]+r[1]*n,t[2]=e[2]+r[2]*n,t[3]=e[3]+r[3]*n,t},ie.distance=function(t,e){var r=e[0]-t[0],n=e[1]-t[1],i=e[2]-t[2],o=e[3]-t[3];return Math.sqrt(r*r+n*n+i*i+o*o)},ie.dist=ie.distance,ie.squaredDistance=function(t,e){var r=e[0]-t[0],n=e[1]-t[1],i=e[2]-t[2],o=e[3]-t[3];return r*r+n*n+i*i+o*o},ie.sqrDist=ie.squaredDistance,ie.length=function(t){var e=t[0],r=t[1],n=t[2],i=t[3];return Math.sqrt(e*e+r*r+n*n+i*i)},ie.len=ie.length,ie.squaredLength=function(t){var e=t[0],r=t[1],n=t[2],i=t[3];return e*e+r*r+n*n+i*i},ie.sqrLen=ie.squaredLength,ie.negate=function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t},ie.inverse=function(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t[3]=1/e[3],t},ie.normalize=function(t,e){var r=e[0],n=e[1],i=e[2],o=e[3],a=r*r+n*n+i*i+o*o;return a>0&&(a=1/Math.sqrt(a),t[0]=e[0]*a,t[1]=e[1]*a,t[2]=e[2]*a,t[3]=e[3]*a),t},ie.dot=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]},ie.lerp=function(t,e,r,n){var i=e[0],o=e[1],a=e[2],s=e[3];return t[0]=i+n*(r[0]-i),t[1]=o+n*(r[1]-o),t[2]=a+n*(r[2]-a),t[3]=s+n*(r[3]-s),t},ie.random=function(t,e){return e=e||1,t[0]=O(),t[1]=O(),t[2]=O(),t[3]=O(),ie.normalize(t,t),ie.scale(t,t,e),t},ie.transformMat4=function(t,e,r){var n=e[0],i=e[1],o=e[2],a=e[3];return t[0]=r[0]*n+r[4]*i+r[8]*o+r[12]*a,t[1]=r[1]*n+r[5]*i+r[9]*o+r[13]*a,t[2]=r[2]*n+r[6]*i+r[10]*o+r[14]*a,t[3]=r[3]*n+r[7]*i+r[11]*o+r[15]*a,t},ie.transformQuat=function(t,e,r){var n=e[0],i=e[1],o=e[2],a=r[0],s=r[1],h=r[2],u=r[3],l=u*n+s*o-h*i,c=u*i+h*n-a*o,f=u*o+a*i-s*n,d=-a*n-s*i-h*o;return t[0]=l*u+d*-a+c*-h-f*-s,t[1]=c*u+d*-s+f*-a-l*-h,t[2]=f*u+d*-h+l*-s-c*-a,t},ie.forEach=function(){var t=ie.create();return function(e,r,n,i,o,a){var s,h;for(r||(r=4),n||(n=0),h=i?Math.min(i*r+n,e.length):e.length,s=n;s<h;s+=r)t[0]=e[s],t[1]=e[s+1],t[2]=e[s+2],t[3]=e[s+3],o(t,t,a),e[s]=t[0],e[s+1]=t[1],e[s+2]=t[2],e[s+3]=t[3];return e}}();var oe=ie,ae={create:function(){var t=new L(9);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},fromMat4:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t},clone:function(t){var e=new L(9);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},identity:function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},transpose:function(t,e){if(t===e){var r=e[1],n=e[2],i=e[5];t[1]=e[3],t[2]=e[6],t[3]=r,t[5]=e[7],t[6]=n,t[7]=i}else t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8];return t},invert:function(t,e){var r=e[0],n=e[1],i=e[2],o=e[3],a=e[4],s=e[5],h=e[6],u=e[7],l=e[8],c=l*a-s*u,f=-l*o+s*h,d=u*o-a*h,p=r*c+n*f+i*d;return p?(p=1/p,t[0]=c*p,t[1]=(-l*n+i*u)*p,t[2]=(s*n-i*a)*p,t[3]=f*p,t[4]=(l*r-i*h)*p,t[5]=(-s*r+i*o)*p,t[6]=d*p,t[7]=(-u*r+n*h)*p,t[8]=(a*r-n*o)*p,t):null},adjoint:function(t,e){var r=e[0],n=e[1],i=e[2],o=e[3],a=e[4],s=e[5],h=e[6],u=e[7],l=e[8];return t[0]=a*l-s*u,t[1]=i*u-n*l,t[2]=n*s-i*a,t[3]=s*h-o*l,t[4]=r*l-i*h,t[5]=i*o-r*s,t[6]=o*u-a*h,t[7]=n*h-r*u,t[8]=r*a-n*o,t},determinant:function(t){var e=t[0],r=t[1],n=t[2],i=t[3],o=t[4],a=t[5],s=t[6],h=t[7],u=t[8];return e*(u*o-a*h)+r*(-u*i+a*s)+n*(h*i-o*s)},multiply:function(t,e,r){var n=e[0],i=e[1],o=e[2],a=e[3],s=e[4],h=e[5],u=e[6],l=e[7],c=e[8],f=r[0],d=r[1],p=r[2],m=r[3],g=r[4],_=r[5],y=r[6],v=r[7],x=r[8];return t[0]=f*n+d*a+p*u,t[1]=f*i+d*s+p*l,t[2]=f*o+d*h+p*c,t[3]=m*n+g*a+_*u,t[4]=m*i+g*s+_*l,t[5]=m*o+g*h+_*c,t[6]=y*n+v*a+x*u,t[7]=y*i+v*s+x*l,t[8]=y*o+v*h+x*c,t}};ae.mul=ae.multiply,ae.translate=function(t,e,r){var n=e[0],i=e[1],o=e[2],a=e[3],s=e[4],h=e[5],u=e[6],l=e[7],c=e[8],f=r[0],d=r[1];return t[0]=n,t[1]=i,t[2]=o,t[3]=a,t[4]=s,t[5]=h,t[6]=f*n+d*a+u,t[7]=f*i+d*s+l,t[8]=f*o+d*h+c,t},ae.rotate=function(t,e,r){var n=e[0],i=e[1],o=e[2],a=e[3],s=e[4],h=e[5],u=e[6],l=e[7],c=e[8],f=Math.sin(r),d=Math.cos(r);return t[0]=d*n+f*a,t[1]=d*i+f*s,t[2]=d*o+f*h,t[3]=d*a-f*n,t[4]=d*s-f*i,t[5]=d*h-f*o,t[6]=u,t[7]=l,t[8]=c,t},ae.scale=function(t,e,r){var n=r[0],i=r[1];return t[0]=n*e[0],t[1]=n*e[1],t[2]=n*e[2],t[3]=i*e[3],t[4]=i*e[4],t[5]=i*e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},ae.fromMat2d=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=0,t[3]=e[2],t[4]=e[3],t[5]=0,t[6]=e[4],t[7]=e[5],t[8]=1,t},ae.fromQuat=function(t,e){var r=e[0],n=e[1],i=e[2],o=e[3],a=r+r,s=n+n,h=i+i,u=r*a,l=n*a,c=n*s,f=i*a,d=i*s,p=i*h,m=o*a,g=o*s,_=o*h;return t[0]=1-c-p,t[3]=l-_,t[6]=f+g,t[1]=l+_,t[4]=1-u-p,t[7]=d-m,t[2]=f-g,t[5]=d+m,t[8]=1-u-c,t},ae.normalFromMat4=function(t,e){var r=e[0],n=e[1],i=e[2],o=e[3],a=e[4],s=e[5],h=e[6],u=e[7],l=e[8],c=e[9],f=e[10],d=e[11],p=e[12],m=e[13],g=e[14],_=e[15],y=r*s-n*a,v=r*h-i*a,x=r*u-o*a,b=n*h-i*s,w=n*u-o*s,T=i*u-o*h,E=l*m-c*p,C=l*g-f*p,S=l*_-d*p,A=c*g-f*m,M=c*_-d*m,P=f*_-d*g,R=y*P-v*M+x*A+b*S-w*C+T*E;return R?(R=1/R,t[0]=(s*P-h*M+u*A)*R,t[1]=(h*S-a*P-u*C)*R,t[2]=(a*M-s*S+u*E)*R,t[3]=(i*M-n*P-o*A)*R,t[4]=(r*P-i*S+o*C)*R,t[5]=(n*S-r*M-o*E)*R,t[6]=(m*T-g*w+_*b)*R,t[7]=(g*x-p*T-_*v)*R,t[8]=(p*w-m*x+_*y)*R,t):null},ae.frob=function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+Math.pow(t[6],2)+Math.pow(t[7],2)+Math.pow(t[8],2))};var se,he,ue,le,ce=ae,fe={};fe.create=function(){var t=new L(4);return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t},fe.rotationTo=(se=D.create(),he=D.fromValues(1,0,0),ue=D.fromValues(0,1,0),function(t,e,r){var n=D.dot(e,r);return n<-.999999?(D.cross(se,he,e),D.length(se)<1e-6&&D.cross(se,ue,e),D.normalize(se,se),fe.setAxisAngle(t,se,Math.PI),t):n>.999999?(t[0]=0,t[1]=0,t[2]=0,t[3]=1,t):(D.cross(se,e,r),t[0]=se[0],t[1]=se[1],t[2]=se[2],t[3]=1+n,fe.normalize(t,t))}),fe.setAxes=(le=ce.create(),function(t,e,r,n){return le[0]=r[0],le[3]=r[1],le[6]=r[2],le[1]=n[0],le[4]=n[1],le[7]=n[2],le[2]=-e[0],le[5]=-e[1],le[8]=-e[2],fe.normalize(t,fe.fromMat3(t,le))}),fe.clone=oe.clone,fe.fromValues=oe.fromValues,fe.copy=oe.copy,fe.set=oe.set,fe.identity=function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t},fe.setAxisAngle=function(t,e,r){r*=.5;var n=Math.sin(r);return t[0]=n*e[0],t[1]=n*e[1],t[2]=n*e[2],t[3]=Math.cos(r),t},fe.add=oe.add,fe.multiply=function(t,e,r){var n=e[0],i=e[1],o=e[2],a=e[3],s=r[0],h=r[1],u=r[2],l=r[3];return t[0]=n*l+a*s+i*u-o*h,t[1]=i*l+a*h+o*s-n*u,t[2]=o*l+a*u+n*h-i*s,t[3]=a*l-n*s-i*h-o*u,t},fe.mul=fe.multiply,fe.scale=oe.scale,fe.rotateX=function(t,e,r){r*=.5;var n=e[0],i=e[1],o=e[2],a=e[3],s=Math.sin(r),h=Math.cos(r);return t[0]=n*h+a*s,t[1]=i*h+o*s,t[2]=o*h-i*s,t[3]=a*h-n*s,t},fe.rotateY=function(t,e,r){r*=.5;var n=e[0],i=e[1],o=e[2],a=e[3],s=Math.sin(r),h=Math.cos(r);return t[0]=n*h-o*s,t[1]=i*h+a*s,t[2]=o*h+n*s,t[3]=a*h-i*s,t},fe.rotateZ=function(t,e,r){r*=.5;var n=e[0],i=e[1],o=e[2],a=e[3],s=Math.sin(r),h=Math.cos(r);return t[0]=n*h+i*s,t[1]=i*h-n*s,t[2]=o*h+a*s,t[3]=a*h-o*s,t},fe.calculateW=function(t,e){var r=e[0],n=e[1],i=e[2];return t[0]=r,t[1]=n,t[2]=i,t[3]=Math.sqrt(Math.abs(1-r*r-n*n-i*i)),t},fe.dot=oe.dot,fe.lerp=oe.lerp,fe.slerp=function(t,e,r,n){var i,o,a,s,h,u=e[0],l=e[1],c=e[2],f=e[3],d=r[0],p=r[1],m=r[2],g=r[3];return(o=u*d+l*p+c*m+f*g)<0&&(o=-o,d=-d,p=-p,m=-m,g=-g),1-o>1e-6?(i=Math.acos(o),a=Math.sin(i),s=Math.sin((1-n)*i)/a,h=Math.sin(n*i)/a):(s=1-n,h=n),t[0]=s*u+h*d,t[1]=s*l+h*p,t[2]=s*c+h*m,t[3]=s*f+h*g,t},fe.invert=function(t,e){var r=e[0],n=e[1],i=e[2],o=e[3],a=r*r+n*n+i*i+o*o,s=a?1/a:0;return t[0]=-r*s,t[1]=-n*s,t[2]=-i*s,t[3]=o*s,t},fe.conjugate=function(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t},fe.length=oe.length,fe.len=fe.length,fe.squaredLength=oe.squaredLength,fe.sqrLen=fe.squaredLength,fe.normalize=oe.normalize,fe.fromMat3=function(t,e){var r,n=e[0]+e[4]+e[8];if(n>0)r=Math.sqrt(n+1),t[3]=.5*r,r=.5/r,t[0]=(e[5]-e[7])*r,t[1]=(e[6]-e[2])*r,t[2]=(e[1]-e[3])*r;else{var i=0;e[4]>e[0]&&(i=1),e[8]>e[3*i+i]&&(i=2);var o=(i+1)%3,a=(i+2)%3;r=Math.sqrt(e[3*i+i]-e[3*o+o]-e[3*a+a]+1),t[i]=.5*r,r=.5/r,t[3]=(e[3*o+a]-e[3*a+o])*r,t[o]=(e[3*o+i]+e[3*i+o])*r,t[a]=(e[3*a+i]+e[3*i+a])*r}return t};var de=fe;function pe(t,e,r,n,i,o){var a=e[i],s=e[i+1],h=e[i+2];return t[0]=a+n*(r[o]-a),t[1]=s+n*(r[o+1]-s),t[2]=h+n*(r[o+2]-h),t}var me,ge,_e=function(t){t=t||{},this.name=t.name||"",this.target=t.target||null,this.position=D.create(),this.rotation=de.create(),this.scale=D.fromValues(1,1,1),this.channels={time:null,position:null,rotation:null,scale:null},this._cacheKey=0,this._cacheTime=0};_e.prototype.setTime=function(t){if(this.channels.time){var e,r,n,i,o,a,s,h,u,l,c,f,d,p,m,g,_,y,v,x=this.channels,b=x.time.length,w=-1;if(1===b)return x.rotation&&de.copy(this.rotation,x.rotation),x.position&&D.copy(this.position,x.position),void(x.scale&&D.copy(this.scale,x.scale));if(t<=x.time[0])t=x.time[0],w=0;else if(t>=x.time[b-1])t=x.time[b-1],w=b-2;else if(t<this._cacheTime){for(var T=Math.min(b-1,this._cacheKey+1);T>=0;T--)if(x.time[T-1]<=t&&x.time[T]>t){w=T-1;break}}else for(T=this._cacheKey;T<b-1;T++)if(x.time[T]<=t&&x.time[T+1]>t){w=T;break}if(w>-1){this._cacheKey=w,this._cacheTime=t;var E=w,C=w+1,S=x.time[E],A=x.time[C]-S,M=0===A?0:(t-S)/A;x.rotation&&(e=this.rotation,r=x.rotation,n=x.rotation,i=M,a=4*C,f=r[0+(o=4*E)],d=r[1+o],p=r[2+o],m=r[3+o],g=n[0+a],_=n[1+a],y=n[2+a],v=n[3+a],(h=f*g+d*_+p*y+m*v)<0&&(h=-h,g=-g,_=-_,y=-y,v=-v),1-h>1e-6?(s=Math.acos(h),u=Math.sin(s),l=Math.sin((1-i)*s)/u,c=Math.sin(i*s)/u):(l=1-i,c=i),e[0]=l*f+c*g,e[1]=l*d+c*_,e[2]=l*p+c*y,e[3]=l*m+c*v),x.position&&pe(this.position,x.position,x.position,M,3*E,3*C),x.scale&&pe(this.scale,x.scale,x.scale,M,3*E,3*C)}w===b-2&&(this._cacheKey=0,this._cacheTime=0),this.updateTarget()}},_e.prototype.updateTarget=function(){var t=this.channels;this.target&&(t.position&&this.target.position.setArray(this.position),t.rotation&&this.target.rotation.setArray(this.rotation),t.scale&&this.target.scale.setArray(this.scale))},_e.prototype.getMaxTime=function(){return this.channels.time[this.channels.time.length-1]},_e.prototype.getSubTrack=function(t,e){var r=new _e({name:this.name}),n=this.channels.time[0];t=Math.min(Math.max(t,n),this.life),e=Math.min(Math.max(e,n),this.life);var i=this._findRange(t),o=this._findRange(e),a=o[0]-i[0]+1;0===i[1]&&0===o[1]&&(a-=1),this.channels.rotation&&(r.channels.rotation=new Float32Array(4*a)),this.channels.position&&(r.channels.position=new Float32Array(3*a)),this.channels.scale&&(r.channels.scale=new Float32Array(3*a)),this.channels.time&&(r.channels.time=new Float32Array(a)),this.setTime(t);for(var s=0;s<3;s++)r.channels.rotation[s]=this.rotation[s],r.channels.position[s]=this.position[s],r.channels.scale[s]=this.scale[s];r.channels.time[0]=0,r.channels.rotation[3]=this.rotation[3];for(s=1;s<a-1;s++){for(var h,u=0;u<3;u++)h=i[0]+s,r.channels.rotation[4*s+u]=this.channels.rotation[4*h+u],r.channels.position[3*s+u]=this.channels.position[3*h+u],r.channels.scale[3*s+u]=this.channels.scale[3*h+u];r.channels.time[s]=this.channels.time[h]-t,r.channels.rotation[4*s+3]=this.channels.rotation[4*h+3]}this.setTime(e);for(s=0;s<3;s++)r.channels.rotation[4*(a-1)+s]=this.rotation[s],r.channels.position[3*(a-1)+s]=this.position[s],r.channels.scale[3*(a-1)+s]=this.scale[s];return r.channels.time[a-1]=e-t,r.channels.rotation[4*(a-1)+3]=this.rotation[3],r.life=e-t,r},_e.prototype._findRange=function(t){for(var e=this.channels,r=e.time.length,n=-1,i=0;i<r-1;i++)e.time[i]<=t&&e.time[i+1]>t&&(n=i);var o=0;if(n>=0){var a=e.time[n];o=(t-a)/(e.time[n+1]-a)}return[n,o]},_e.prototype.blend1D=function(t,e,r){D.lerp(this.position,t.position,e.position,r),D.lerp(this.scale,t.scale,e.scale,r),de.slerp(this.rotation,t.rotation,e.rotation,r)},_e.prototype.blend2D=(me=de.create(),ge=de.create(),function(t,e,r,n,i){var o=1-n-i;this.position[0]=t.position[0]*o+e.position[0]*n+r.position[0]*i,this.position[1]=t.position[1]*o+e.position[1]*n+r.position[1]*i,this.position[2]=t.position[2]*o+e.position[2]*n+r.position[2]*i,this.scale[0]=t.scale[0]*o+e.scale[0]*n+r.scale[0]*i,this.scale[1]=t.scale[1]*o+e.scale[1]*n+r.scale[1]*i,this.scale[2]=t.scale[2]*o+e.scale[2]*n+r.scale[2]*i;var a=n+i;0===a?de.copy(this.rotation,t.rotation):(de.slerp(me,t.rotation,e.rotation,a),de.slerp(ge,t.rotation,r.rotation,a),de.slerp(this.rotation,me,ge,i/a))}),_e.prototype.additiveBlend=function(t,e){D.add(this.position,t.position,e.position),D.add(this.scale,t.scale,e.scale),de.multiply(this.rotation,e.rotation,t.rotation)},_e.prototype.subtractiveBlend=function(t,e){D.sub(this.position,t.position,e.position),D.sub(this.scale,t.scale,e.scale),de.invert(this.rotation,e.rotation),de.multiply(this.rotation,this.rotation,t.rotation)},_e.prototype.clone=function(){var t=_e.prototype.clone.call(this);return t.channels={time:this.channels.time||null,position:this.channels.position||null,rotation:this.channels.rotation||null,scale:this.channels.scale||null},D.copy(t.position,this.position),de.copy(t.rotation,this.rotation),D.copy(t.scale,this.scale),t.target=this.target,t.updateTarget(),t};var ye=_e,ve=ct.extend(function(){return{stage:null,_clips:[],_running:!1,_time:0,_paused:!1,_pausedTime:0}},{addAnimator:function(t){t.animation=this;for(var e=t.getClips(),r=0;r<e.length;r++)this.addClip(e[r])},addClip:function(t){this._clips.indexOf(t)<0&&this._clips.push(t)},removeClip:function(t){var e=this._clips.indexOf(t);e>=0&&this._clips.splice(e,1)},removeAnimator:function(t){for(var e=t.getClips(),r=0;r<e.length;r++)this.removeClip(e[r]);t.animation=null},_update:function(){for(var t=Date.now()-this._pausedTime,e=t-this._time,r=this._clips,n=r.length,i=[],o=[],a=0;a<n;a++){var s=r[a],h=s.step(t,e,!1);h&&(i.push(h),o.push(s))}for(a=0;a<n;)r[a]._needsRemove?(r[a]=r[n-1],r.pop(),n--):a++;n=i.length;for(a=0;a<n;a++)o[a].fire(i[a]);this._time=t,this.trigger("frame",e),this.stage&&this.stage.render&&this.stage.render()},start:function(){var t=this;this._running=!0,this._time=Date.now(),this._pausedTime=0;var e=G.a.requestAnimationFrame;e(function r(){t._running&&(e(r),t._paused||t._update())})},stop:function(){this._running=!1},pause:function(){this._paused||(this._pauseStart=Date.now(),this._paused=!0)},resume:function(){this._paused&&(this._pausedTime+=Date.now()-this._pauseStart,this._paused=!1)},removeClipsAll:function(){this._clips=[]},animate:function(t,e){var r=new Wt(t,(e=e||{}).loop,e.getter,e.setter,e.interpolater);return r.animation=this,r}}),xe=function(t){t=t||{},Ot.call(this,t),this.tracks=t.tracks||[],this.calcLifeFromTracks()};(xe.prototype=Object.create(Ot.prototype)).constructor=xe,xe.prototype.step=function(t,e,r){var n=Ot.prototype.step.call(this,t,e,!0);if("finish"!==n){t=this.getElapsedTime();this._range&&(t=this._range[0]+t),this.setTime(t)}return r||"paused"===n||this.fire("frame"),n},xe.prototype.setRange=function(t){this.calcLifeFromTracks(),this._range=t,t&&(t[1]=Math.min(t[1],this.life),t[0]=Math.min(t[0],this.life),this.life=t[1]-t[0])},xe.prototype.setTime=function(t){for(var e=0;e<this.tracks.length;e++)this.tracks[e].setTime(t)},xe.prototype.calcLifeFromTracks=function(){this.life=0;for(var t=0;t<this.tracks.length;t++)this.life=Math.max(this.life,this.tracks[t].getMaxTime())},xe.prototype.addTrack=function(t){this.tracks.push(t),this.calcLifeFromTracks()},xe.prototype.removeTarck=function(t){var e=this.tracks.indexOf(t);e>=0&&this.tracks.splice(e,1)},xe.prototype.getSubClip=function(t,e,r){for(var n=new xe({name:this.name}),i=0;i<this.tracks.length;i++){var o=this.tracks[i].getSubTrack(t,e);n.addTrack(o)}return void 0!==r&&n.setLoop(r),n.life=e-t,n},xe.prototype.blend1D=function(t,e,r){for(var n=0;n<this.tracks.length;n++){var i=t.tracks[n],o=e.tracks[n];this.tracks[n].blend1D(i,o,r)}},xe.prototype.additiveBlend=function(t,e){for(var r=0;r<this.tracks.length;r++){var n=t.tracks[r],i=e.tracks[r];this.tracks[r].additiveBlend(n,i)}},xe.prototype.subtractiveBlend=function(t,e){for(var r=0;r<this.tracks.length;r++){var n=t.tracks[r],i=e.tracks[r];this.tracks[r].subtractiveBlend(n,i)}},xe.prototype.blend2D=function(t,e,r,n,i){for(var o=0;o<this.tracks.length;o++){var a=t.tracks[o],s=e.tracks[o],h=r.tracks[o];this.tracks[o].blend2D(a,s,h,n,i)}},xe.prototype.copy=function(t){for(var e=0;e<this.tracks.length;e++){var r=t.tracks[e],n=this.tracks[e];D.copy(n.position,r.position),D.copy(n.scale,r.scale),de.copy(n.rotation,r.rotation)}},xe.prototype.clone=function(){for(var t=Ot.prototype.clone.call(this),e=0;e<this.tracks.length;e++)t.addTrack(this.tracks[e].clone());return t.life=this.life,t};var be=xe;function we(){this._fullfilled=!1,this._rejected=!1}function Te(t,e){var r=new we;return G.a.request.get({url:t,responseType:e,onload:function(t){r.resolve(t)},onerror:function(t){r.reject(t)}}),r}we.prototype.resolve=function(t){this._fullfilled=!0,this._rejected=!1,this.trigger("success",t)},we.prototype.reject=function(t){this._rejected=!0,this._fullfilled=!1,this.trigger("error",t)},we.prototype.isFullfilled=function(){return this._fullfilled},we.prototype.isRejected=function(){return this._rejected},we.prototype.isSettled=function(){return this._fullfilled||this._rejected},ut.extend(we.prototype,ot),we.makeRequestTask=function(t,e){if("string"==typeof t)return Te(t,e);if(t.url){var r=t;return Te(r.url,r.responseType)}if(Array.isArray(t)){var n=[];return t.forEach(function(t){var e,r;"string"==typeof t?e=t:Object(t)===t&&(e=t.url,r=t.responseType),n.push(Te(e,r))}),n}},we.makeTask=function(){return new we},ut.extend(we.prototype,ot);var Ee=we,Ce=function(){Ee.apply(this,arguments),this._tasks=[],this._fulfilledNumber=0,this._rejectedNumber=0},Se=function(){};Se.prototype=Ee.prototype,(Ce.prototype=new Se).constructor=Ce,Ce.prototype.all=function(t){var e=0,r=this,n=[];return this._tasks=t,this._fulfilledNumber=0,this._rejectedNumber=0,ut.each(t,function(t,i){t&&t.once&&(e++,t.once("success",function(o){e--,r._fulfilledNumber++,t._fulfilled=!0,t._rejected=!1,n[i]=o,0===e&&r.resolve(n)}),t.once("error",function(){r._rejectedNumber++,t._fulfilled=!1,t._rejected=!0,r.reject(t)}))}),0===e?(setTimeout(function(){r.resolve(n)}),this):this},Ce.prototype.allSettled=function(t){var e=0,r=this,n=[];return 0===t.length?(setTimeout(function(){r.trigger("success",n)}),this):(this._tasks=t,ut.each(t,function(t,i){t&&t.once&&(e++,t.once("success",function(o){e--,r._fulfilledNumber++,t._fulfilled=!0,t._rejected=!1,n[i]=o,0===e&&r.resolve(n)}),t.once("error",function(o){e--,r._rejectedNumber++,t._fulfilled=!1,t._rejected=!0,n[i]=null,0===e&&r.resolve(n)}))}),this)},Ce.prototype.getFulfilledNumber=function(t){if(t){for(var e=0,r=0;r<this._tasks.length;r++){var n=this._tasks[r];n instanceof Ce?e+=n.getFulfilledNumber(t):n._fulfilled&&(e+=1)}return e}return this._fulfilledNumber},Ce.prototype.getRejectedNumber=function(t){if(t){for(var e=0,r=0;r<this._tasks.length;r++){var n=this._tasks[r];n instanceof Ce?e+=n.getRejectedNumber(t):n._rejected&&(e+=1)}return e}return this._rejectedNumber},Ce.prototype.getSettledNumber=function(t){if(t){for(var e=0,r=0;r<this._tasks.length;r++){var n=this._tasks[r];n instanceof Ce?e+=n.getSettledNumber(t):(n._rejected||n._fulfilled)&&(e+=1)}return e}return this._fulfilledNumber+this._rejectedNumber},Ce.prototype.getTaskNumber=function(t){if(t){for(var e=0,r=0;r<this._tasks.length;r++){var n=this._tasks[r];e+=n instanceof Ce?n.getTaskNumber(t):1}return e}return this._tasks.length};var Ae,Me=function(t,e,r,n){t=t||0,e=e||0,r=r||0,n=void 0===n?1:n,this.array=de.fromValues(t,e,r,n),this._dirty=!0};Me.prototype={constructor:Me,add:function(t){return de.add(this.array,this.array,t.array),this._dirty=!0,this},calculateW:function(){return de.calculateW(this.array,this.array),this._dirty=!0,this},set:function(t,e,r,n){return this.array[0]=t,this.array[1]=e,this.array[2]=r,this.array[3]=n,this._dirty=!0,this},setArray:function(t){return this.array[0]=t[0],this.array[1]=t[1],this.array[2]=t[2],this.array[3]=t[3],this._dirty=!0,this},clone:function(){return new Me(this.x,this.y,this.z,this.w)},conjugate:function(){return de.conjugate(this.array,this.array),this._dirty=!0,this},copy:function(t){return de.copy(this.array,t.array),this._dirty=!0,this},dot:function(t){return de.dot(this.array,t.array)},fromMat3:function(t){return de.fromMat3(this.array,t.array),this._dirty=!0,this},fromMat4:(Ae=ce.create(),function(t){return ce.fromMat4(Ae,t.array),ce.transpose(Ae,Ae),de.fromMat3(this.array,Ae),this._dirty=!0,this}),identity:function(){return de.identity(this.array),this._dirty=!0,this},invert:function(){return de.invert(this.array,this.array),this._dirty=!0,this},len:function(){return de.len(this.array)},length:function(){return de.length(this.array)},lerp:function(t,e,r){return de.lerp(this.array,t.array,e.array,r),this._dirty=!0,this},mul:function(t){return de.mul(this.array,this.array,t.array),this._dirty=!0,this},mulLeft:function(t){return de.multiply(this.array,t.array,this.array),this._dirty=!0,this},multiply:function(t){return de.multiply(this.array,this.array,t.array),this._dirty=!0,this},multiplyLeft:function(t){return de.multiply(this.array,t.array,this.array),this._dirty=!0,this},normalize:function(){return de.normalize(this.array,this.array),this._dirty=!0,this},rotateX:function(t){return de.rotateX(this.array,this.array,t),this._dirty=!0,this},rotateY:function(t){return de.rotateY(this.array,this.array,t),this._dirty=!0,this},rotateZ:function(t){return de.rotateZ(this.array,this.array,t),this._dirty=!0,this},rotationTo:function(t,e){return de.rotationTo(this.array,t.array,e.array),this._dirty=!0,this},setAxes:function(t,e,r){return de.setAxes(this.array,t.array,e.array,r.array),this._dirty=!0,this},setAxisAngle:function(t,e){return de.setAxisAngle(this.array,t.array,e),this._dirty=!0,this},slerp:function(t,e,r){return de.slerp(this.array,t.array,e.array,r),this._dirty=!0,this},sqrLen:function(){return de.sqrLen(this.array)},squaredLength:function(){return de.squaredLength(this.array)},fromEuler:function(t,e){return Me.fromEuler(this,t,e)},toString:function(){return"["+Array.prototype.join.call(this.array,",")+"]"},toArray:function(){return Array.prototype.slice.call(this.array)}};var Pe=Object.defineProperty;if(Pe){var Re=Me.prototype;Pe(Re,"x",{get:function(){return this.array[0]},set:function(t){this.array[0]=t,this._dirty=!0}}),Pe(Re,"y",{get:function(){return this.array[1]},set:function(t){this.array[1]=t,this._dirty=!0}}),Pe(Re,"z",{get:function(){return this.array[2]},set:function(t){this.array[2]=t,this._dirty=!0}}),Pe(Re,"w",{get:function(){return this.array[3]},set:function(t){this.array[3]=t,this._dirty=!0}})}Me.add=function(t,e,r){return de.add(t.array,e.array,r.array),t._dirty=!0,t},Me.set=function(t,e,r,n,i){de.set(t.array,e,r,n,i),t._dirty=!0},Me.copy=function(t,e){return de.copy(t.array,e.array),t._dirty=!0,t},Me.calculateW=function(t,e){return de.calculateW(t.array,e.array),t._dirty=!0,t},Me.conjugate=function(t,e){return de.conjugate(t.array,e.array),t._dirty=!0,t},Me.identity=function(t){return de.identity(t.array),t._dirty=!0,t},Me.invert=function(t,e){return de.invert(t.array,e.array),t._dirty=!0,t},Me.dot=function(t,e){return de.dot(t.array,e.array)},Me.len=function(t){return de.length(t.array)},Me.lerp=function(t,e,r,n){return de.lerp(t.array,e.array,r.array,n),t._dirty=!0,t},Me.slerp=function(t,e,r,n){return de.slerp(t.array,e.array,r.array,n),t._dirty=!0,t},Me.multiply=Me.mul=function(t,e,r){return de.multiply(t.array,e.array,r.array),t._dirty=!0,t},Me.rotateX=function(t,e,r){return de.rotateX(t.array,e.array,r),t._dirty=!0,t},Me.rotateY=function(t,e,r){return de.rotateY(t.array,e.array,r),t._dirty=!0,t},Me.rotateZ=function(t,e,r){return de.rotateZ(t.array,e.array,r),t._dirty=!0,t},Me.setAxisAngle=function(t,e,r){return de.setAxisAngle(t.array,e.array,r),t._dirty=!0,t},Me.normalize=function(t,e){return de.normalize(t.array,e.array),t._dirty=!0,t},Me.squaredLength=Me.sqrLen=function(t){return de.sqrLen(t.array)},Me.fromMat3=function(t,e){return de.fromMat3(t.array,e.array),t._dirty=!0,t},Me.setAxes=function(t,e,r,n){return de.setAxes(t.array,e.array,r.array,n.array),t._dirty=!0,t},Me.rotationTo=function(t,e,r){return de.rotationTo(t.array,e.array,r.array),t._dirty=!0,t},Me.fromEuler=function(t,e,r){t._dirty=!0,e=e.array;var n=t.array,i=Math.cos(e[0]/2),o=Math.cos(e[1]/2),a=Math.cos(e[2]/2),s=Math.sin(e[0]/2),h=Math.sin(e[1]/2),u=Math.sin(e[2]/2);switch(r=(r||"XYZ").toUpperCase()){case"XYZ":n[0]=s*o*a+i*h*u,n[1]=i*h*a-s*o*u,n[2]=i*o*u+s*h*a,n[3]=i*o*a-s*h*u;break;case"YXZ":n[0]=s*o*a+i*h*u,n[1]=i*h*a-s*o*u,n[2]=i*o*u-s*h*a,n[3]=i*o*a+s*h*u;break;case"ZXY":n[0]=s*o*a-i*h*u,n[1]=i*h*a+s*o*u,n[2]=i*o*u+s*h*a,n[3]=i*o*a-s*h*u;break;case"ZYX":n[0]=s*o*a-i*h*u,n[1]=i*h*a+s*o*u,n[2]=i*o*u-s*h*a,n[3]=i*o*a+s*h*u;break;case"YZX":n[0]=s*o*a+i*h*u,n[1]=i*h*a+s*o*u,n[2]=i*o*u-s*h*a,n[3]=i*o*a-s*h*u;break;case"XZY":n[0]=s*o*a-i*h*u,n[1]=i*h*a-s*o*u,n[2]=i*o*u+s*h*a,n[3]=i*o*a+s*h*u}};var Le=Me,Oe=function(){this._axisX=new j,this._axisY=new j,this._axisZ=new j,this.array=K.create(),this._dirty=!0};Oe.prototype={constructor:Oe,setArray:function(t){for(var e=0;e<this.array.length;e++)this.array[e]=t[e];return this._dirty=!0,this},adjoint:function(){return K.adjoint(this.array,this.array),this._dirty=!0,this},clone:function(){return(new Oe).copy(this)},copy:function(t){return K.copy(this.array,t.array),this._dirty=!0,this},determinant:function(){return K.determinant(this.array)},fromQuat:function(t){return K.fromQuat(this.array,t.array),this._dirty=!0,this},fromRotationTranslation:function(t,e){return K.fromRotationTranslation(this.array,t.array,e.array),this._dirty=!0,this},fromMat2d:function(t){return Oe.fromMat2d(this,t),this},frustum:function(t,e,r,n,i,o){return K.frustum(this.array,t,e,r,n,i,o),this._dirty=!0,this},identity:function(){return K.identity(this.array),this._dirty=!0,this},invert:function(){return K.invert(this.array,this.array),this._dirty=!0,this},lookAt:function(t,e,r){return K.lookAt(this.array,t.array,e.array,r.array),this._dirty=!0,this},mul:function(t){return K.mul(this.array,this.array,t.array),this._dirty=!0,this},mulLeft:function(t){return K.mul(this.array,t.array,this.array),this._dirty=!0,this},multiply:function(t){return K.multiply(this.array,this.array,t.array),this._dirty=!0,this},multiplyLeft:function(t){return K.multiply(this.array,t.array,this.array),this._dirty=!0,this},ortho:function(t,e,r,n,i,o){return K.ortho(this.array,t,e,r,n,i,o),this._dirty=!0,this},perspective:function(t,e,r,n){return K.perspective(this.array,t,e,r,n),this._dirty=!0,this},rotate:function(t,e){return K.rotate(this.array,this.array,t,e.array),this._dirty=!0,this},rotateX:function(t){return K.rotateX(this.array,this.array,t),this._dirty=!0,this},rotateY:function(t){return K.rotateY(this.array,this.array,t),this._dirty=!0,this},rotateZ:function(t){return K.rotateZ(this.array,this.array,t),this._dirty=!0,this},scale:function(t){return K.scale(this.array,this.array,t.array),this._dirty=!0,this},translate:function(t){return K.translate(this.array,this.array,t.array),this._dirty=!0,this},transpose:function(){return K.transpose(this.array,this.array),this._dirty=!0,this},decomposeMatrix:function(){var t=D.create(),e=D.create(),r=D.create(),n=ce.create();return function(i,o,a){var s=this.array;D.set(t,s[0],s[1],s[2]),D.set(e,s[4],s[5],s[6]),D.set(r,s[8],s[9],s[10]);var h=D.length(t),u=D.length(e),l=D.length(r);this.determinant()<0&&(h=-h),i&&i.set(h,u,l),a.set(s[12],s[13],s[14]),ce.fromMat4(n,s),n[0]/=h,n[1]/=h,n[2]/=h,n[3]/=u,n[4]/=u,n[5]/=u,n[6]/=l,n[7]/=l,n[8]/=l,de.fromMat3(o.array,n),de.normalize(o.array,o.array),o._dirty=!0,a._dirty=!0}}(),toString:function(){return"["+Array.prototype.join.call(this.array,",")+"]"},toArray:function(){return Array.prototype.slice.call(this.array)}};var ke=Object.defineProperty;if(ke){var De=Oe.prototype;ke(De,"z",{get:function(){var t=this.array;return this._axisZ.set(t[8],t[9],t[10]),this._axisZ},set:function(t){var e=this.array;t=t.array,e[8]=t[0],e[9]=t[1],e[10]=t[2],this._dirty=!0}}),ke(De,"y",{get:function(){var t=this.array;return this._axisY.set(t[4],t[5],t[6]),this._axisY},set:function(t){var e=this.array;t=t.array,e[4]=t[0],e[5]=t[1],e[6]=t[2],this._dirty=!0}}),ke(De,"x",{get:function(){var t=this.array;return this._axisX.set(t[0],t[1],t[2]),this._axisX},set:function(t){var e=this.array;t=t.array,e[0]=t[0],e[1]=t[1],e[2]=t[2],this._dirty=!0}})}Oe.adjoint=function(t,e){return K.adjoint(t.array,e.array),t._dirty=!0,t},Oe.copy=function(t,e){return K.copy(t.array,e.array),t._dirty=!0,t},Oe.determinant=function(t){return K.determinant(t.array)},Oe.identity=function(t){return K.identity(t.array),t._dirty=!0,t},Oe.ortho=function(t,e,r,n,i,o,a){return K.ortho(t.array,e,r,n,i,o,a),t._dirty=!0,t},Oe.perspective=function(t,e,r,n,i){return K.perspective(t.array,e,r,n,i),t._dirty=!0,t},Oe.lookAt=function(t,e,r,n){return K.lookAt(t.array,e.array,r.array,n.array),t._dirty=!0,t},Oe.invert=function(t,e){return K.invert(t.array,e.array),t._dirty=!0,t},Oe.multiply=Oe.mul=function(t,e,r){return K.mul(t.array,e.array,r.array),t._dirty=!0,t},Oe.fromQuat=function(t,e){return K.fromQuat(t.array,e.array),t._dirty=!0,t},Oe.fromRotationTranslation=function(t,e,r){return K.fromRotationTranslation(t.array,e.array,r.array),t._dirty=!0,t},Oe.fromMat2d=function(t,e){t._dirty=!0;e=e.array;return(t=t.array)[0]=e[0],t[4]=e[2],t[12]=e[4],t[1]=e[1],t[5]=e[3],t[13]=e[5],t},Oe.rotate=function(t,e,r,n){return K.rotate(t.array,e.array,r,n.array),t._dirty=!0,t},Oe.rotateX=function(t,e,r){return K.rotateX(t.array,e.array,r),t._dirty=!0,t},Oe.rotateY=function(t,e,r){return K.rotateY(t.array,e.array,r),t._dirty=!0,t},Oe.rotateZ=function(t,e,r){return K.rotateZ(t.array,e.array,r),t._dirty=!0,t},Oe.scale=function(t,e,r){return K.scale(t.array,e.array,r.array),t._dirty=!0,t},Oe.transpose=function(t,e){return K.transpose(t.array,e.array),t._dirty=!0,t},Oe.translate=function(t,e,r){return K.translate(t.array,e.array,r.array),t._dirty=!0,t};var Ie,Ne,Fe,Be,ze,Ue,He,je,Ge=Oe,Ve=0,We=ct.extend({name:"",position:null,rotation:null,scale:null,worldTransform:null,localTransform:null,autoUpdateLocalTransform:!0,_parent:null,_scene:null,_needsUpdateWorldTransform:!0,_inIterating:!1,__depth:0},function(){this.name||(this.name=(this.type||"NODE")+"_"+Ve++),this.position||(this.position=new j),this.rotation||(this.rotation=new Le),this.scale||(this.scale=new j(1,1,1)),this.worldTransform=new Ge,this.localTransform=new Ge,this._children=[]},{target:null,invisible:!1,isSkinnedMesh:function(){return!1},isRenderable:function(){return!1},setName:function(t){var e=this._scene;if(e){var r=e._nodeRepository;delete r[this.name],r[t]=this}this.name=t},add:function(t){var e=t._parent;if(e!==this){e&&e.remove(t),t._parent=this,this._children.push(t);var r=this._scene;r&&r!==t.scene&&t.traverse(this._addSelfToScene,this),t._needsUpdateWorldTransform=!0}},remove:function(t){var e=this._children,r=e.indexOf(t);r<0||(e.splice(r,1),t._parent=null,this._scene&&t.traverse(this._removeSelfFromScene,this))},removeAll:function(){for(var t=this._children,e=0;e<t.length;e++)t[e]._parent=null,this._scene&&t[e].traverse(this._removeSelfFromScene,this);this._children=[]},getScene:function(){return this._scene},getParent:function(){return this._parent},_removeSelfFromScene:function(t){t._scene.removeFromScene(t),t._scene=null},_addSelfToScene:function(t){this._scene.addToScene(t),t._scene=this._scene},isAncestor:function(t){for(var e=t._parent;e;){if(e===this)return!0;e=e._parent}return!1},children:function(){return this._children.slice()},childAt:function(t){return this._children[t]},getChildByName:function(t){for(var e=this._children,r=0;r<e.length;r++)if(e[r].name===t)return e[r]},getDescendantByName:function(t){for(var e=this._children,r=0;r<e.length;r++){var n=e[r];if(n.name===t)return n;var i=n.getDescendantByName(t);if(i)return i}},queryNode:function(t){if(t){for(var e=t.split("/"),r=this,n=0;n<e.length;n++){var i=e[n];if(i){for(var o=!1,a=r._children,s=0;s<a.length;s++){var h=a[s];if(h.name===i){r=h,o=!0;break}}if(!o)return}}return r}},getPath:function(t){if(!this._parent)return"/";for(var e=this._parent,r=this.name;e._parent&&(r=e.name+"/"+r,e._parent!=t);)e=e._parent;return!e._parent&&t?null:r},traverse:function(t,e){t.call(e,this);for(var r=this._children,n=0,i=r.length;n<i;n++)r[n].traverse(t,e)},eachChild:function(t,e){for(var r=this._children,n=0,i=r.length;n<i;n++){var o=r[n];t.call(e,o,n)}},setLocalTransform:function(t){K.copy(this.localTransform.array,t.array),this.decomposeLocalTransform()},decomposeLocalTransform:function(t){var e=t?null:this.scale;this.localTransform.decomposeMatrix(e,this.rotation,this.position)},setWorldTransform:function(t){K.copy(this.worldTransform.array,t.array),this.decomposeWorldTransform()},decomposeWorldTransform:(Be=K.create(),function(t){var e=this.localTransform,r=this.worldTransform;this._parent?(K.invert(Be,this._parent.worldTransform.array),K.multiply(e.array,Be,r.array)):K.copy(e.array,r.array);var n=t?null:this.scale;e.decomposeMatrix(n,this.rotation,this.position)}),transformNeedsUpdate:function(){return this.position._dirty||this.rotation._dirty||this.scale._dirty},updateLocalTransform:function(){var t=this.position,e=this.rotation,r=this.scale;if(this.transformNeedsUpdate()){var n=this.localTransform.array;K.fromRotationTranslation(n,e.array,t.array),K.scale(n,n,r.array),e._dirty=!1,r._dirty=!1,t._dirty=!1,this._needsUpdateWorldTransform=!0}},_updateWorldTransformTopDown:function(){var t=this.localTransform.array,e=this.worldTransform.array;this._parent?K.multiplyAffine(e,this._parent.worldTransform.array,t):K.copy(e,t)},updateWorldTransform:function(){for(var t=this;t&&t.getParent()&&t.getParent().transformNeedsUpdate();)t=t.getParent();t.update()},update:function(t){this.autoUpdateLocalTransform?this.updateLocalTransform():t=!0,(t||this._needsUpdateWorldTransform)&&(this._updateWorldTransformTopDown(),t=!0,this._needsUpdateWorldTransform=!1);for(var e=this._children,r=0,n=e.length;r<n;r++)e[r].update(t)},getBoundingBox:function(){function t(t){return!t.invisible&&t.geometry}var e=new et,r=new Ge,n=new Ge;return function(i,o){return o=o||new et,i=i||t,this._parent?Ge.invert(n,this._parent.worldTransform):Ge.identity(n),this.traverse(function(t){t.geometry&&t.geometry.boundingBox&&(e.copy(t.geometry.boundingBox),Ge.multiply(r,n,t.worldTransform),e.applyTransform(r),o.union(e))},this,t),o}}(),getWorldPosition:function(t){this.transformNeedsUpdate()&&this.updateWorldTransform();var e=this.worldTransform.array;if(t){var r=t.array;return r[0]=e[12],r[1]=e[13],r[2]=e[14],t}return new j(e[12],e[13],e[14])},clone:function(){var t=new this.constructor,e=this._children;t.setName(this.name),t.position.copy(this.position),t.rotation.copy(this.rotation),t.scale.copy(this.scale);for(var r=0;r<e.length;r++)t.add(e[r].clone());return t},rotateAround:(Ne=new j,Fe=new Ge,function(t,e,r){Ne.copy(this.position).subtract(t);var n=this.localTransform;n.identity(),n.translate(t),n.rotate(r,e),Fe.fromRotationTranslation(this.rotation,Ne),n.multiply(Fe),n.scale(this.scale),this.decomposeLocalTransform(),this._needsUpdateWorldTransform=!0}),lookAt:(Ie=new Ge,function(t,e){Ie.lookAt(this.position,t,e||this.localTransform.y).invert(),this.setLocalTransform(Ie),this.target=t})}),Ze=function(t,e){this.normal=t||new j(0,1,0),this.distance=e||0};Ze.prototype={constructor:Ze,distanceToPoint:function(t){return D.dot(t.array,this.normal.array)-this.distance},projectPoint:function(t,e){e||(e=new j);var r=this.distanceToPoint(t);return D.scaleAndAdd(e.array,t.array,this.normal.array,-r),e._dirty=!0,e},normalize:function(){var t=1/D.len(this.normal.array);D.scale(this.normal.array,t),this.distance*=t},intersectFrustum:function(t){for(var e=t.vertices,r=this.normal.array,n=D.dot(e[0].array,r)>this.distance,i=1;i<8;i++)if(D.dot(e[i].array,r)>this.distance!=n)return!0},intersectLine:(je=D.create(),function(t,e,r){var n=this.distanceToPoint(t),i=this.distanceToPoint(e);if(n>0&&i>0||n<0&&i<0)return null;var o=this.normal.array,a=this.distance,s=t.array;D.sub(je,e.array,t.array),D.normalize(je,je);var h=D.dot(o,je);if(0===h)return null;r||(r=new j);var u=(D.dot(o,s)-a)/h;return D.scaleAndAdd(r.array,s,je,-u),r._dirty=!0,r}),applyTransform:(ze=K.create(),Ue=oe.create(),He=oe.create(),He[3]=1,function(t){t=t.array,D.scale(He,this.normal.array,this.distance),oe.transformMat4(He,He,t),this.distance=D.dot(He,this.normal.array),K.invert(ze,t),K.transpose(ze,ze),Ue[3]=0,D.copy(Ue,this.normal.array),oe.transformMat4(Ue,Ue,ze),D.copy(this.normal.array,Ue)}),copy:function(t){D.copy(this.normal.array,t.normal.array),this.normal._dirty=!0,this.distance=t.distance},clone:function(){var t=new Ze;return t.copy(this),t}};var Xe,qe=Ze,Ye=D.set,Je=D.copy,Ke=D.transformMat4,Qe=Math.min,$e=Math.max,tr=function(){this.planes=[];for(var t=0;t<6;t++)this.planes.push(new qe);this.boundingBox=new et,this.vertices=[];for(t=0;t<8;t++)this.vertices[t]=D.fromValues(0,0,0)};tr.prototype={setFromProjection:function(t){var e=this.planes,r=t.array,n=r[0],i=r[1],o=r[2],a=r[3],s=r[4],h=r[5],u=r[6],l=r[7],c=r[8],f=r[9],d=r[10],p=r[11],m=r[12],g=r[13],_=r[14],y=r[15];Ye(e[0].normal.array,a-n,l-s,p-c),e[0].distance=-(y-m),e[0].normalize(),Ye(e[1].normal.array,a+n,l+s,p+c),e[1].distance=-(y+m),e[1].normalize(),Ye(e[2].normal.array,a+i,l+h,p+f),e[2].distance=-(y+g),e[2].normalize(),Ye(e[3].normal.array,a-i,l-h,p-f),e[3].distance=-(y-g),e[3].normalize(),Ye(e[4].normal.array,a-o,l-u,p-d),e[4].distance=-(y-_),e[4].normalize(),Ye(e[5].normal.array,a+o,l+u,p+d),e[5].distance=-(y+_),e[5].normalize();var v=this.boundingBox,x=this.vertices;if(0===y){var b=h/n,w=-_/(d-1),T=-_/(d+1),E=-T/h,C=-w/h;v.min.set(-E*b,-E,T),v.max.set(E*b,E,w),Ye(x[0],-E*b,-E,T),Ye(x[1],-E*b,E,T),Ye(x[2],E*b,-E,T),Ye(x[3],E*b,E,T),Ye(x[4],-C*b,-C,w),Ye(x[5],-C*b,C,w),Ye(x[6],C*b,-C,w),Ye(x[7],C*b,C,w)}else{var S=(-1-m)/n,A=(1-m)/n,M=(1-g)/h,P=(-1-g)/h,R=(-1-_)/d,L=(1-_)/d;v.min.set(Math.min(S,A),Math.min(P,M),Math.min(L,R)),v.max.set(Math.max(A,S),Math.max(M,P),Math.max(R,L));var O=v.min.array,k=v.max.array;Ye(x[0],O[0],O[1],O[2]),Ye(x[1],O[0],k[1],O[2]),Ye(x[2],k[0],O[1],O[2]),Ye(x[3],k[0],k[1],O[2]),Ye(x[4],O[0],O[1],k[2]),Ye(x[5],O[0],k[1],k[2]),Ye(x[6],k[0],O[1],k[2]),Ye(x[7],k[0],k[1],k[2])}},getTransformedBoundingBox:(Xe=D.create(),function(t,e){var r=this.vertices,n=e.array,i=t.min,o=t.max,a=i.array,s=o.array,h=r[0];Ke(Xe,h,n),Je(a,Xe),Je(s,Xe);for(var u=1;u<8;u++)h=r[u],Ke(Xe,h,n),a[0]=Qe(Xe[0],a[0]),a[1]=Qe(Xe[1],a[1]),a[2]=Qe(Xe[2],a[2]),s[0]=$e(Xe[0],s[0]),s[1]=$e(Xe[1],s[1]),s[2]=$e(Xe[2],s[2]);return i._dirty=!0,o._dirty=!0,t})};var er,rr,nr,ir,or=tr,ar=function(t,e){this.origin=t||new j,this.direction=e||new j};ar.prototype={constructor:ar,intersectPlane:function(t,e){var r=t.normal.array,n=t.distance,i=this.origin.array,o=this.direction.array,a=D.dot(r,o);if(0===a)return null;e||(e=new j);var s=(D.dot(r,i)-n)/a;return D.scaleAndAdd(e.array,i,o,-s),e._dirty=!0,e},mirrorAgainstPlane:function(t){var e=D.dot(t.normal.array,this.direction.array);D.scaleAndAdd(this.direction.array,this.direction.array,t.normal.array,2*-e),this.direction._dirty=!0},distanceToPoint:function(){var t=D.create();return function(e){D.sub(t,e,this.origin.array);var r=D.dot(t,this.direction.array);if(r<0)return D.distance(this.origin.array,e);var n=D.lenSquared(t);return Math.sqrt(n-r*r)}}(),intersectSphere:function(){var t=D.create();return function(e,r,n){var i=this.origin.array,o=this.direction.array;e=e.array,D.sub(t,e,i);var a=D.dot(t,o),s=D.squaredLength(t)-a*a,h=r*r;if(!(s>h)){var u=Math.sqrt(h-s),l=a-u,c=a+u;return n||(n=new j),l<0?c<0?null:(D.scaleAndAdd(n.array,i,o,c),n):(D.scaleAndAdd(n.array,i,o,l),n)}}}(),intersectBoundingBox:function(t,e){var r,n,i,o,a,s,h=this.direction.array,u=this.origin.array,l=t.min.array,c=t.max.array,f=1/h[0],d=1/h[1],p=1/h[2];if(f>=0?(r=(l[0]-u[0])*f,n=(c[0]-u[0])*f):(n=(l[0]-u[0])*f,r=(c[0]-u[0])*f),d>=0?(i=(l[1]-u[1])*d,o=(c[1]-u[1])*d):(o=(l[1]-u[1])*d,i=(c[1]-u[1])*d),r>o||i>n)return null;if((i>r||r!=r)&&(r=i),(o<n||n!=n)&&(n=o),p>=0?(a=(l[2]-u[2])*p,s=(c[2]-u[2])*p):(s=(l[2]-u[2])*p,a=(c[2]-u[2])*p),r>s||a>n)return null;if((a>r||r!=r)&&(r=a),(s<n||n!=n)&&(n=s),n<0)return null;var m=r>=0?r:n;return e||(e=new j),D.scaleAndAdd(e.array,u,h,m),e},intersectTriangle:(er=D.create(),rr=D.create(),nr=D.create(),ir=D.create(),function(t,e,r,n,i,o){var a=this.direction.array,s=this.origin.array;t=t.array,e=e.array,r=r.array,D.sub(er,e,t),D.sub(rr,r,t),D.cross(ir,rr,a);var h=D.dot(er,ir);if(n){if(h>-1e-5)return null}else if(h>-1e-5&&h<1e-5)return null;D.sub(nr,s,t);var u=D.dot(ir,nr)/h;if(u<0||u>1)return null;D.cross(ir,er,nr);var l=D.dot(a,ir)/h;if(l<0||l>1||u+l>1)return null;D.cross(ir,er,rr);var c=-D.dot(nr,ir)/h;return c<0?null:(i||(i=new j),o&&j.set(o,1-u-l,u,l),D.scaleAndAdd(i.array,s,a,c),i)}),applyTransform:function(t){j.add(this.direction,this.direction,this.origin),j.transformMat4(this.origin,this.origin,t),j.transformMat4(this.direction,this.direction,t),j.sub(this.direction,this.direction,this.origin),j.normalize(this.direction,this.direction)},copy:function(t){j.copy(this.origin,t.origin),j.copy(this.direction,t.direction)},clone:function(){var t=new ar;return t.copy(this),t}};var sr,hr=ar,ur=We.extend(function(){return{projectionMatrix:new Ge,invProjectionMatrix:new Ge,viewMatrix:new Ge,frustum:new or}},function(){this.update(!0)},{update:function(t){We.prototype.update.call(this,t),Ge.invert(this.viewMatrix,this.worldTransform),this.updateProjectionMatrix(),Ge.invert(this.invProjectionMatrix,this.projectionMatrix),this.frustum.setFromProjection(this.projectionMatrix)},setViewMatrix:function(t){Ge.copy(this.viewMatrix,t),Ge.invert(this.worldTransform,t),this.decomposeWorldTransform()},decomposeProjectionMatrix:function(){},setProjectionMatrix:function(t){Ge.copy(this.projectionMatrix,t),Ge.invert(this.invProjectionMatrix,t),this.decomposeProjectionMatrix()},updateProjectionMatrix:function(){},castRay:(sr=oe.create(),function(t,e){var r=void 0!==e?e:new hr,n=t.array[0],i=t.array[1];return oe.set(sr,n,i,-1,1),oe.transformMat4(sr,sr,this.invProjectionMatrix.array),oe.transformMat4(sr,sr,this.worldTransform.array),D.scale(r.origin.array,sr,1/sr[3]),oe.set(sr,n,i,1,1),oe.transformMat4(sr,sr,this.invProjectionMatrix.array),oe.transformMat4(sr,sr,this.worldTransform.array),D.scale(sr,sr,1/sr[3]),D.sub(r.direction.array,sr,r.origin.array),D.normalize(r.direction.array,r.direction.array),r.direction._dirty=!0,r.origin._dirty=!0,r})}),lr=ur.extend({left:-1,right:1,near:-1,far:1,top:1,bottom:-1},{updateProjectionMatrix:function(){this.projectionMatrix.ortho(this.left,this.right,this.bottom,this.top,this.near,this.far)},decomposeProjectionMatrix:function(){var t=this.projectionMatrix.array;this.left=(-1-t[12])/t[0],this.right=(1-t[12])/t[0],this.top=(1-t[13])/t[5],this.bottom=(-1-t[13])/t[5],this.near=-(-1-t[14])/t[10],this.far=-(1-t[14])/t[10]},clone:function(){var t=ur.prototype.clone.call(this);return t.left=this.left,t.right=this.right,t.near=this.near,t.far=this.far,t.top=this.top,t.bottom=this.bottom,t}}),cr=ur.extend({fov:50,aspect:1,near:.1,far:2e3},{updateProjectionMatrix:function(){var t=this.fov/180*Math.PI;this.projectionMatrix.perspective(t,this.aspect,this.near,this.far)},decomposeProjectionMatrix:function(){var t=this.projectionMatrix.array,e=2*Math.atan(1/t[5]);this.fov=e/Math.PI*180,this.aspect=t[5]/t[0],this.near=t[14]/(t[10]-1),this.far=t[14]/(t[10]+1)},clone:function(){var t=ur.prototype.clone.call(this);return t.fov=this.fov,t.aspect=this.aspect,t.near=this.near,t.far=this.far,t}}),fr=ct.extend(function(){return{name:"",inputLinks:{},outputLinks:{},_prevOutputTextures:{},_outputTextures:{},_outputReferences:{},_rendering:!1,_rendered:!1,_compositor:null}},{updateParameter:function(t,e){var r,n,i=this.outputs[t],o=i.parameters,a=i._parametersCopy;if(a||(a=i._parametersCopy={}),o)for(var s in o)"width"!==s&&"height"!==s&&(a[s]=o[s]);return r=o.width instanceof Function?o.width.call(this,e):o.width,n=o.height instanceof Function?o.height.call(this,e):o.height,a.width===r&&a.height===n||this._outputTextures[t]&&this._outputTextures[t].dispose(e.gl),a.width=r,a.height=n,a},setParameter:function(t,e){},getParameter:function(t){},setParameters:function(t){for(var e in t)this.setParameter(e,t[e])},render:function(){},getOutput:function(t,e){if(null==e)return e=t,this._outputTextures[e];var r=this.outputs[e];return r?this._rendered?r.outputLastFrame?this._prevOutputTextures[e]:this._outputTextures[e]:this._rendering?(this._prevOutputTextures[e]||(this._prevOutputTextures[e]=this._compositor.allocateTexture(r.parameters||{})),this._prevOutputTextures[e]):(this.render(t),this._outputTextures[e]):void 0},removeReference:function(t){(this._outputReferences[t]--,0===this._outputReferences[t])&&(this.outputs[t].keepLastFrame?(this._prevOutputTextures[t]&&this._compositor.releaseTexture(this._prevOutputTextures[t]),this._prevOutputTextures[t]=this._outputTextures[t]):this._compositor.releaseTexture(this._outputTextures[t]))},link:function(t,e,r){this.inputLinks[t]={node:e,pin:r},e.outputLinks[r]||(e.outputLinks[r]=[]),e.outputLinks[r].push({node:this,pin:t}),this.pass.material.enableTexture(t)},clear:function(){this.inputLinks={},this.outputLinks={}},updateReference:function(t){if(!this._rendering){for(var e in this._rendering=!0,this.inputLinks){var r=this.inputLinks[e];r.node.updateReference(r.pin)}this._rendering=!1}t&&this._outputReferences[t]++},beforeFrame:function(){for(var t in this._rendered=!1,this.outputLinks)this._outputReferences[t]=0},afterFrame:function(){for(var t in this.outputLinks){if(this._outputReferences[t]>0)this.outputs[t].keepLastFrame?(this._prevOutputTextures[t]&&this._compositor.releaseTexture(this._prevOutputTextures[t]),this._prevOutputTextures[t]=this._outputTextures[t]):this._compositor.releaseTexture(this._outputTextures[t])}}}),dr=ct.extend(function(){return{nodes:[]}},{dirty:function(){this._dirty=!0},addNode:function(t){this.nodes.indexOf(t)>=0||(this.nodes.push(t),this._dirty=!0)},removeNode:function(t){"string"==typeof t&&(t=this.getNodeByName(t));var e=this.nodes.indexOf(t);e>=0&&(this.nodes.splice(e,1),this._dirty=!0)},getNodeByName:function(t){for(var e=0;e<this.nodes.length;e++)if(this.nodes[e].name===t)return this.nodes[e]},update:function(){for(var t=0;t<this.nodes.length;t++)this.nodes[t].clear();for(t=0;t<this.nodes.length;t++){var e=this.nodes[t];if(e.inputs)for(var r in e.inputs)if(e.inputs[r])if(!e.pass||e.pass.material.isUniformEnabled(r)){var n=e.inputs[r],i=this.findPin(n);i?e.link(r,i.node,i.pin):"string"==typeof n?console.warn("Node "+n+" not exist"):console.warn("Pin of "+n.node+"."+n.pin+" not exist")}else console.warn("Pin "+e.name+"."+r+" not used.")}},findPin:function(t){var e;if(("string"==typeof t||t instanceof fr)&&(t={node:t}),"string"==typeof t.node)for(var r=0;r<this.nodes.length;r++){var n=this.nodes[r];n.name===t.node&&(e=n)}else e=t.node;if(e){var i=t.pin;if(i||e.outputs&&(i=Object.keys(e.outputs)[0]),e.outputs[i])return{node:e,pin:i}}}}),pr=ct.extend({width:512,height:512,type:ft.UNSIGNED_BYTE,format:ft.RGBA,wrapS:ft.REPEAT,wrapT:ft.REPEAT,minFilter:ft.LINEAR_MIPMAP_LINEAR,magFilter:ft.LINEAR,useMipmap:!0,anisotropic:1,flipY:!0,sRGB:!0,unpackAlignment:4,premultiplyAlpha:!1,dynamic:!1,NPOT:!1,__used:0},function(){this._cache=new pt},{getWebGLTexture:function(t){var e=t.gl,r=this._cache;return r.use(t.__uid__),r.miss("webgl_texture")&&r.put("webgl_texture",e.createTexture()),this.dynamic?this.update(t):r.isDirty()&&(this.update(t),r.fresh()),r.get("webgl_texture")},bind:function(){},unbind:function(){},dirty:function(){this._cache&&this._cache.dirtyAll()},update:function(t){},updateCommon:function(t){var e=t.gl;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,this.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.premultiplyAlpha),e.pixelStorei(e.UNPACK_ALIGNMENT,this.unpackAlignment),this.format===ft.DEPTH_COMPONENT&&(this.useMipmap=!1);var r=t.getGLExtension("EXT_sRGB");this.format!==pr.SRGB||r||(this.format=pr.RGB),this.format!==pr.SRGB_ALPHA||r||(this.format=pr.RGBA),this.NPOT=!this.isPowerOfTwo()},getAvailableWrapS:function(){return this.NPOT?ft.CLAMP_TO_EDGE:this.wrapS},getAvailableWrapT:function(){return this.NPOT?ft.CLAMP_TO_EDGE:this.wrapT},getAvailableMinFilter:function(){var t=this.minFilter;return this.NPOT||!this.useMipmap?t===ft.NEAREST_MIPMAP_NEAREST||t===ft.NEAREST_MIPMAP_LINEAR?ft.NEAREST:t===ft.LINEAR_MIPMAP_LINEAR||t===ft.LINEAR_MIPMAP_NEAREST?ft.LINEAR:t:t},getAvailableMagFilter:function(){return this.magFilter},nextHighestPowerOfTwo:function(t){--t;for(var e=1;e<32;e<<=1)t|=t>>e;return t+1},dispose:function(t){var e=this._cache;e.use(t.__uid__);var r=e.get("webgl_texture");r&&t.gl.deleteTexture(r),e.deleteContext(t.__uid__)},isRenderable:function(){},isPowerOfTwo:function(){}});Object.defineProperty(pr.prototype,"width",{get:function(){return this._width},set:function(t){this._width=t}}),Object.defineProperty(pr.prototype,"height",{get:function(){return this._height},set:function(t){this._height=t}}),pr.BYTE=ft.BYTE,pr.UNSIGNED_BYTE=ft.UNSIGNED_BYTE,pr.SHORT=ft.SHORT,pr.UNSIGNED_SHORT=ft.UNSIGNED_SHORT,pr.INT=ft.INT,pr.UNSIGNED_INT=ft.UNSIGNED_INT,pr.FLOAT=ft.FLOAT,pr.HALF_FLOAT=36193,pr.UNSIGNED_INT_24_8_WEBGL=34042,pr.DEPTH_COMPONENT=ft.DEPTH_COMPONENT,pr.DEPTH_STENCIL=ft.DEPTH_STENCIL,pr.ALPHA=ft.ALPHA,pr.RGB=ft.RGB,pr.RGBA=ft.RGBA,pr.LUMINANCE=ft.LUMINANCE,pr.LUMINANCE_ALPHA=ft.LUMINANCE_ALPHA,pr.SRGB=35904,pr.SRGB_ALPHA=35906,pr.COMPRESSED_RGB_S3TC_DXT1_EXT=33776,pr.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777,pr.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778,pr.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779,pr.NEAREST=ft.NEAREST,pr.LINEAR=ft.LINEAR,pr.NEAREST_MIPMAP_NEAREST=ft.NEAREST_MIPMAP_NEAREST,pr.LINEAR_MIPMAP_NEAREST=ft.LINEAR_MIPMAP_NEAREST,pr.NEAREST_MIPMAP_LINEAR=ft.NEAREST_MIPMAP_LINEAR,pr.LINEAR_MIPMAP_LINEAR=ft.LINEAR_MIPMAP_LINEAR,pr.REPEAT=ft.REPEAT,pr.CLAMP_TO_EDGE=ft.CLAMP_TO_EDGE,pr.MIRRORED_REPEAT=ft.MIRRORED_REPEAT;var mr=pr,gr={isPowerOfTwo:function(t){return 0==(t&t-1)},nextPowerOfTwo:function(t){return t--,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,++t},nearestPowerOfTwo:function(t){return Math.pow(2,Math.round(Math.log(t)/Math.LN2))}},_r=gr,yr=_r.isPowerOfTwo;function vr(t){return Math.pow(2,Math.round(Math.log(t)/Math.LN2))}var xr=mr.extend(function(){return{image:null,pixels:null,mipmaps:[],convertToPOT:!1}},{textureType:"texture2D",update:function(t){var e=t.gl;e.bindTexture(e.TEXTURE_2D,this._cache.get("webgl_texture")),this.updateCommon(t);var r=this.format,n=this.type,i=!(!this.convertToPOT||this.mipmaps.length||!this.image||this.wrapS!==mr.REPEAT&&this.wrapT!==mr.REPEAT||!this.NPOT);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,i?this.wrapS:this.getAvailableWrapS()),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,i?this.wrapT:this.getAvailableWrapT()),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,i?this.magFilter:this.getAvailableMagFilter()),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,i?this.minFilter:this.getAvailableMinFilter());var o=t.getGLExtension("EXT_texture_filter_anisotropic");(o&&this.anisotropic>1&&e.texParameterf(e.TEXTURE_2D,o.TEXTURE_MAX_ANISOTROPY_EXT,this.anisotropic),36193===n)&&(t.getGLExtension("OES_texture_half_float")||(n=ft.FLOAT));if(this.mipmaps.length)for(var a=this.width,s=this.height,h=0;h<this.mipmaps.length;h++){var u=this.mipmaps[h];this._updateTextureData(e,u,h,a,s,r,n,!1),a/=2,s/=2}else this._updateTextureData(e,this,0,this.width,this.height,r,n,i),!this.useMipmap||this.NPOT&&!i||e.generateMipmap(e.TEXTURE_2D);e.bindTexture(e.TEXTURE_2D,null)},_updateTextureData:function(t,e,r,n,i,o,a,s){if(e.image){var h=e.image;s&&(this._potCanvas=function(t,e){var r=vr(t.width),n=vr(t.height);return(e=e||document.createElement("canvas")).width=r,e.height=n,e.getContext("2d").drawImage(t.image,0,0,r,n),e}(this,this._potCanvas),h=this._potCanvas),t.texImage2D(t.TEXTURE_2D,r,o,o,a,h)}else o<=mr.COMPRESSED_RGBA_S3TC_DXT5_EXT&&o>=mr.COMPRESSED_RGB_S3TC_DXT1_EXT?t.compressedTexImage2D(t.TEXTURE_2D,r,o,n,i,0,e.pixels):t.texImage2D(t.TEXTURE_2D,r,o,n,i,0,o,a,e.pixels)},generateMipmap:function(t){var e=t.gl;this.useMipmap&&!this.NPOT&&(e.bindTexture(e.TEXTURE_2D,this._cache.get("webgl_texture")),e.generateMipmap(e.TEXTURE_2D))},isPowerOfTwo:function(){return yr(this.width)&&yr(this.height)},isRenderable:function(){return this.image?"CANVAS"===this.image.nodeName||"VIDEO"===this.image.nodeName||this.image.complete:!(!this.width||!this.height)},bind:function(t){t.gl.bindTexture(t.gl.TEXTURE_2D,this.getWebGLTexture(t))},unbind:function(t){t.gl.bindTexture(t.gl.TEXTURE_2D,null)},load:function(t,e){var r=G.a.createImage();e&&(r.crossOrigin=e);var n=this;return r.onload=function(){n.dirty(),n.trigger("success",n)},r.onerror=function(){n.trigger("error",n)},r.src=t,this.image=r,this}});Object.defineProperty(xr.prototype,"width",{get:function(){return this.image?this.image.width:this._width},set:function(t){this.image?console.warn("Texture from image can't set width"):(this._width!==t&&this.dirty(),this._width=t)}}),Object.defineProperty(xr.prototype,"height",{get:function(){return this.image?this.image.height:this._height},set:function(t){this.image?console.warn("Texture from image can't set height"):(this._height!==t&&this.dirty(),this._height=t)}});var br=xr,wr=function(){this._pool={},this._allocatedTextures=[]};wr.prototype={constructor:wr,get:function(t){var e=Cr(t);this._pool.hasOwnProperty(e)||(this._pool[e]=[]);var r=this._pool[e];if(!r.length){var n=new br(t);return this._allocatedTextures.push(n),n}return r.pop()},put:function(t){var e=Cr(t);this._pool.hasOwnProperty(e)||(this._pool[e]=[]),this._pool[e].push(t)},clear:function(t){for(var e=0;e<this._allocatedTextures.length;e++)this._allocatedTextures[e].dispose(t);this._pool={},this._allocatedTextures=[]}};var Tr={width:512,height:512,type:ft.UNSIGNED_BYTE,format:ft.RGBA,wrapS:ft.CLAMP_TO_EDGE,wrapT:ft.CLAMP_TO_EDGE,minFilter:ft.LINEAR_MIPMAP_LINEAR,magFilter:ft.LINEAR,useMipmap:!0,anisotropic:1,flipY:!0,unpackAlignment:4,premultiplyAlpha:!1},Er=Object.keys(Tr);function Cr(t){ut.defaultsWithPropList(t,Tr,Er),function(t){var e=(r=t.width,n=t.height,0==(r&r-1)&&0==(n&n-1));var r,n;t.format===ft.DEPTH_COMPONENT&&(t.useMipmap=!1);e&&t.useMipmap||(t.minFilter==ft.NEAREST_MIPMAP_NEAREST||t.minFilter==ft.NEAREST_MIPMAP_LINEAR?t.minFilter=ft.NEAREST:t.minFilter!=ft.LINEAR_MIPMAP_LINEAR&&t.minFilter!=ft.LINEAR_MIPMAP_NEAREST||(t.minFilter=ft.LINEAR));e||(t.wrapS=ft.CLAMP_TO_EDGE,t.wrapT=ft.CLAMP_TO_EDGE)}(t);for(var e="",r=0;r<Er.length;r++){e+=t[Er[r]].toString()}return e}var Sr=wr,Ar=ft.FRAMEBUFFER,Mr=ft.RENDERBUFFER,Pr=ft.DEPTH_ATTACHMENT,Rr=ft.COLOR_ATTACHMENT0,Lr=ct.extend({depthBuffer:!0,viewport:null,_width:0,_height:0,_textures:null,_boundRenderer:null},function(){this._cache=new pt,this._textures={}},{getTextureWidth:function(){return this._width},getTextureHeight:function(){return this._height},bind:function(t){if(t.__currentFrameBuffer){if(t.__currentFrameBuffer===this)return;console.warn("Renderer already bound with another framebuffer. Unbind it first")}t.__currentFrameBuffer=this;var e=t.gl;e.bindFramebuffer(Ar,this._getFrameBufferGL(t)),this._boundRenderer=t;var r=this._cache;r.put("viewport",t.viewport);var n,i,o=!1;for(var a in this._textures){o=!0;var s=this._textures[a];s&&(n=s.texture.width,i=s.texture.height,this._doAttach(t,s.texture,a,s.target))}this._width=n,this._height=i,!o&&this.depthBuffer&&console.error("Must attach texture before bind, or renderbuffer may have incorrect width and height."),this.viewport?t.setViewport(this.viewport):t.setViewport(0,0,n,i,1);var h=r.get("attached_textures");if(h)for(var a in h)if(!this._textures[a]){var u=h[a];this._doDetach(e,a,u)}if(!r.get("depthtexture_attached")&&this.depthBuffer){r.miss("renderbuffer")&&r.put("renderbuffer",e.createRenderbuffer());var l=r.get("renderbuffer");n===r.get("renderbuffer_width")&&i===r.get("renderbuffer_height")||(e.bindRenderbuffer(Mr,l),e.renderbufferStorage(Mr,e.DEPTH_COMPONENT16,n,i),r.put("renderbuffer_width",n),r.put("renderbuffer_height",i),e.bindRenderbuffer(Mr,null)),r.get("renderbuffer_attached")||(e.framebufferRenderbuffer(Ar,Pr,Mr,l),r.put("renderbuffer_attached",!0))}},unbind:function(t){t.__currentFrameBuffer=null,t.gl.bindFramebuffer(Ar,null),this._boundRenderer=null,this._cache.use(t.__uid__);var e=this._cache.get("viewport");e&&t.setViewport(e),this.updateMipmap(t)},updateMipmap:function(t){var e=t.gl;for(var r in this._textures){var n=this._textures[r];if(n){var i=n.texture;if(!i.NPOT&&i.useMipmap&&i.minFilter===mr.LINEAR_MIPMAP_LINEAR){var o="textureCube"===i.textureType?ft.TEXTURE_CUBE_MAP:ft.TEXTURE_2D;e.bindTexture(o,i.getWebGLTexture(t)),e.generateMipmap(o),e.bindTexture(o,null)}}}},checkStatus:function(t){return t.checkFramebufferStatus(Ar)},_getFrameBufferGL:function(t){var e=this._cache;return e.use(t.__uid__),e.miss("framebuffer")&&e.put("framebuffer",t.gl.createFramebuffer()),e.get("framebuffer")},attach:function(t,e,r){if(!t.width)throw new Error("The texture attached to color buffer is not a valid.");e=e||Rr,r=r||ft.TEXTURE_2D;var n,i=this._boundRenderer;if(i&&i.gl){var o=this._cache;o.use(i.__uid__),n=o.get("attached_textures")}var a=this._textures[e];if(!a||a.target!==r||a.texture!==t||!n||null==n[e]){var s=!0;i&&(s=this._doAttach(i,t,e,r),this.viewport||i.setViewport(0,0,t.width,t.height,1)),s&&(this._textures[e]=this._textures[e]||{},this._textures[e].texture=t,this._textures[e].target=r)}},_doAttach:function(t,e,r,n){var i=t.gl,o=e.getWebGLTexture(t),a=this._cache.get("attached_textures");if(a&&a[r]){var s=a[r];if(s.texture===e&&s.target===n)return}var h=!0;if(((r=+r)===Pr||r===ft.DEPTH_STENCIL_ATTACHMENT)&&(t.getGLExtension("WEBGL_depth_texture")||(console.error("Depth texture is not supported by the browser"),h=!1),e.format!==ft.DEPTH_COMPONENT&&e.format!==ft.DEPTH_STENCIL&&(console.error("The texture attached to depth buffer is not a valid."),h=!1),h)){var u=this._cache.get("renderbuffer");u&&(i.framebufferRenderbuffer(Ar,Pr,Mr,null),i.deleteRenderbuffer(u),this._cache.put("renderbuffer",!1)),this._cache.put("renderbuffer_attached",!1),this._cache.put("depthtexture_attached",!0)}return i.framebufferTexture2D(Ar,r,n,o,0),a||(a={},this._cache.put("attached_textures",a)),a[r]=a[r]||{},a[r].texture=e,a[r].target=n,h},_doDetach:function(t,e,r){t.framebufferTexture2D(Ar,e,r,null,0);var n=this._cache.get("attached_textures");n&&n[e]&&(n[e]=null),e!==Pr&&e!==ft.DEPTH_STENCIL_ATTACHMENT||this._cache.put("depthtexture_attached",!1)},detach:function(t,e){(this._textures[t]=null,this._boundRenderer)&&(this._cache.use(this._boundRenderer.__uid__),this._doDetach(this._boundRenderer.gl,t,e))},dispose:function(t){var e=t.gl,r=this._cache;r.use(t.__uid__);var n=r.get("renderbuffer");n&&e.deleteRenderbuffer(n);var i=r.get("framebuffer");i&&e.deleteFramebuffer(i),r.deleteContext(t.__uid__),this._textures={}}});Lr.DEPTH_ATTACHMENT=Pr,Lr.COLOR_ATTACHMENT0=Rr,Lr.STENCIL_ATTACHMENT=ft.STENCIL_ATTACHMENT,Lr.DEPTH_STENCIL_ATTACHMENT=ft.DEPTH_STENCIL_ATTACHMENT;var Or=Lr,kr=dr.extend(function(){return{_outputs:[],_texturePool:new Sr,_frameBuffer:new Or({depthBuffer:!1})}},{addNode:function(t){dr.prototype.addNode.call(this,t),t._compositor=this},render:function(t,e){if(this._dirty){this.update(),this._dirty=!1,this._outputs.length=0;for(var r=0;r<this.nodes.length;r++)this.nodes[r].outputs||this._outputs.push(this.nodes[r])}for(r=0;r<this.nodes.length;r++)this.nodes[r].beforeFrame();for(r=0;r<this._outputs.length;r++)this._outputs[r].updateReference();for(r=0;r<this._outputs.length;r++)this._outputs[r].render(t,e);for(r=0;r<this.nodes.length;r++)this.nodes[r].afterFrame()},allocateTexture:function(t){return this._texturePool.get(t)},releaseTexture:function(t){this._texturePool.put(t)},getFrameBuffer:function(){return this._frameBuffer},dispose:function(t){this._texturePool.clear(t)}}),Dr=fr.extend({name:"scene",scene:null,camera:null,autoUpdateScene:!0,preZ:!1},function(){this.frameBuffer=new Or},{render:function(t){this._rendering=!0;var e,r=t.gl;if(this.trigger("beforerender"),this.outputs){var n=this.frameBuffer;for(var i in this.outputs){var o=this.updateParameter(i,t),a=this.outputs[i],s=this._compositor.allocateTexture(o);this._outputTextures[i]=s,"string"==typeof(l=a.attachment||r.COLOR_ATTACHMENT0)&&(l=r[l]),n.attach(s,l)}n.bind(t);var h=t.getGLExtension("EXT_draw_buffers");if(h){var u=[];for(var l in this.outputs)(l=parseInt(l))>=r.COLOR_ATTACHMENT0&&l<=r.COLOR_ATTACHMENT0+8&&u.push(l);h.drawBuffersEXT(u)}t.saveClear(),t.clearBit=ft.DEPTH_BUFFER_BIT|ft.COLOR_BUFFER_BIT,e=t.render(this.scene,this.camera,!this.autoUpdateScene,this.preZ),t.restoreClear(),n.unbind(t)}else e=t.render(this.scene,this.camera,!this.autoUpdateScene,this.preZ);this.trigger("afterrender",e),this._rendering=!1,this._rendered=!0}}),Ir=fr.extend(function(){return{texture:null,outputs:{color:{}}}},function(){},{getOutput:function(t,e){return this.texture},beforeFrame:function(){},afterFrame:function(){}}),Nr=At.extend({dynamic:!1,widthSegments:1,heightSegments:1},function(){this.build()},{build:function(){for(var t=this.heightSegments,e=this.widthSegments,r=this.attributes,n=[],i=[],o=[],a=[],s=0;s<=t;s++)for(var h=s/t,u=0;u<=e;u++){var l=u/e;if(n.push([2*l-1,2*h-1,0]),i&&i.push([l,h]),o&&o.push([0,0,1]),u<e&&s<t){var c=u+s*(e+1);a.push([c,c+1,c+e+1]),a.push([c+e+1,c+1,c+e+2])}}r.position.fromArray(n),r.texcoord0.fromArray(i),r.normal.fromArray(o),this.initIndicesFromArray(a),this.boundingBox=new et,this.boundingBox.min.set(-1,-1,0),this.boundingBox.max.set(1,1,0)}}),Fr=/uniform\s+(bool|float|int|vec2|vec3|vec4|ivec2|ivec3|ivec4|mat2|mat3|mat4|sampler2D|samplerCube)\s+([\s\S]*?);/g,Br=/attribute\s+(float|int|vec2|vec3|vec4)\s+([\s\S]*?);/g,zr=/#define\s+(\w+)?(\s+[\d-.]+)?\s*;?\s*\n/g,Ur={bool:"1i",int:"1i",sampler2D:"t",samplerCube:"t",float:"1f",vec2:"2f",vec3:"3f",vec4:"4f",ivec2:"2i",ivec3:"3i",ivec4:"4i",mat2:"m2",mat3:"m3",mat4:"m4"};function Hr(t){for(var e=[],r=0;r<t;r++)e[r]=0;return e}var jr={bool:function(){return!0},int:function(){return 0},float:function(){return 0},sampler2D:function(){return null},samplerCube:function(){return null},vec2:function(){return Hr(2)},vec3:function(){return Hr(3)},vec4:function(){return Hr(4)},ivec2:function(){return Hr(2)},ivec3:function(){return Hr(3)},ivec4:function(){return Hr(4)},mat2:function(){return Hr(4)},mat3:function(){return Hr(9)},mat4:function(){return Hr(16)},array:function(){return[]}},Gr=["POSITION","NORMAL","BINORMAL","TANGENT","TEXCOORD","TEXCOORD_0","TEXCOORD_1","COLOR","JOINT","WEIGHT"],Vr=["SKIN_MATRIX","VIEWPORT_SIZE","VIEWPORT","DEVICEPIXELRATIO","WINDOW_SIZE","NEAR","FAR","TIME"],Wr=["WORLD","VIEW","PROJECTION","WORLDVIEW","VIEWPROJECTION","WORLDVIEWPROJECTION","WORLDINVERSE","VIEWINVERSE","PROJECTIONINVERSE","WORLDVIEWINVERSE","VIEWPROJECTIONINVERSE","WORLDVIEWPROJECTIONINVERSE","WORLDTRANSPOSE","VIEWTRANSPOSE","PROJECTIONTRANSPOSE","WORLDVIEWTRANSPOSE","VIEWPROJECTIONTRANSPOSE","WORLDVIEWPROJECTIONTRANSPOSE","WORLDINVERSETRANSPOSE","VIEWINVERSETRANSPOSE","PROJECTIONINVERSETRANSPOSE","WORLDVIEWINVERSETRANSPOSE","VIEWPROJECTIONINVERSETRANSPOSE","WORLDVIEWPROJECTIONINVERSETRANSPOSE"],Zr={vec4:4,vec3:3,vec2:2,float:1},Xr={},qr={};function Yr(t){return t.replace(/[ \t]*\/\/.*\n/g,"").replace(/[ \t]*\/\*[\s\S]*?\*\//g,"")}function Jr(){console.error("Wrong uniform/attributes syntax")}function Kr(t,e){for(var r=/[,=\(\):]/,n=e.replace(/:\s*\[\s*(.*)\s*\]/g,"="+t+"($1)").replace(/\s+/g,"").split(/(?=[,=\(\):])/g),i=[],o=0;o<n.length;o++)n[o].match(r)?i.push(n[o].charAt(0),n[o].slice(1)):i.push(n[o]);var a,s=0,h={},u=null;function l(t){t||Jr();var e=t.match(/\[(.*?)\]/);a=t.replace(/\[(.*?)\]/,""),h[a]={},e&&(h[a].isArray=!0,h[a].arraySize=e[1])}l((n=i)[0]);for(o=1;o<n.length;o++){var c=n[o];if(c)if("="!==c)if(":"!==c)if(","!==c)if(")"!==c)if("("!==c)if(c.indexOf("vec")>=0){if(1!==s&&4!==s){Jr();break}s=2,u=[]}else if(1!==s)if(4!==s)l(c),s=0;else{var f=c;Gr.indexOf(f)>=0||Vr.indexOf(f)>=0||Wr.indexOf(f)>=0?h[a].semantic=f:"ignore"===f||"unconfigurable"===f?h[a].ignore=!0:h[a].value="bool"===t?"true"===f:parseFloat(f)}else h[a].value="bool"===t?"true"===c:parseFloat(c),u=null;else{if(2!==s){Jr();break}if(!(u instanceof Array)){Jr();break}u.push(+n[++o])}else h[a].value=new G.a.Float32Array(u),u=null,s=5;else if(2===s){if(!(u instanceof Array)){Jr();break}u.push(+n[++o])}else s=5;else s=4;else{if(0!==s&&3!==s){Jr();break}s=1}}return h}function Qr(t,e){"object"==typeof t&&(e=t.fragment,t=t.vertex),t=Yr(t),e=Yr(e),this._shaderID=function(t,e){var r="vertex:"+t+"fragment:"+e;if(Xr[r])return Xr[r];var n=ut.genGUID();return Xr[r]=n,qr[n]={vertex:t,fragment:e},n}(t,e),this._vertexCode=Qr.parseImport(t),this._fragmentCode=Qr.parseImport(e),this.attributeSemantics={},this.matrixSemantics={},this.uniformSemantics={},this.matrixSemanticKeys=[],this.uniformTemplates={},this.attributes={},this.textures={},this.vertexDefines={},this.fragmentDefines={},this._parseAttributes(),this._parseUniforms(),this._parseDefines()}Qr.prototype={constructor:Qr,createUniforms:function(){var t={};for(var e in this.uniformTemplates){var r=this.uniformTemplates[e];t[e]={type:r.type,value:r.value()}}return t},_parseImport:function(){this._vertexCode=Qr.parseImport(this.vertex),this._fragmentCode=Qr.parseImport(this.fragment)},_addSemanticUniform:function(t,e,r){if(Gr.indexOf(r)>=0)this.attributeSemantics[r]={symbol:t,type:e};else if(Wr.indexOf(r)>=0){var n=!1,i=r;r.match(/TRANSPOSE$/)&&(n=!0,i=r.slice(0,-9)),this.matrixSemantics[r]={symbol:t,type:e,isTranspose:n,semanticNoTranspose:i}}else Vr.indexOf(r)>=0&&(this.uniformSemantics[r]={symbol:t,type:e})},_addMaterialUniform:function(t,e,r,n,i,o){o[t]={type:r,value:i?jr.array:n||jr[e],semantic:null}},_parseUniforms:function(){var t={},e=this,r="vertex";function n(t){return null!=t?function(){return t}:null}function i(i,o,a){var s=Kr(o,a),h=[];for(var u in s){var l=s[u],c=l.semantic,f=u,d=Ur[o],p=n(s[u].value);s[u].isArray&&(f+="["+s[u].arraySize+"]",d+="v"),h.push(f),e._uniformList.push(u),l.ignore||("sampler2D"!==o&&"samplerCube"!==o||(e.textures[u]={shaderType:r,type:o}),c?e._addSemanticUniform(u,d,c):e._addMaterialUniform(u,o,d,p,s[u].isArray,t))}return h.length>0?"uniform "+o+" "+h.join(",")+";\n":""}this._uniformList=[],this._vertexCode=this._vertexCode.replace(Fr,i),r="fragment",this._fragmentCode=this._fragmentCode.replace(Fr,i),e.matrixSemanticKeys=Object.keys(this.matrixSemantics),this.uniformTemplates=t},_parseAttributes:function(){var t={},e=this;this._vertexCode=this._vertexCode.replace(Br,function(r,n,i){var o=Kr(n,i),a=Zr[n]||1,s=[];for(var h in o){var u=o[h].semantic;if(t[h]={type:"float",size:a,semantic:u||null},u){if(Gr.indexOf(u)<0)throw new Error('Unkown semantic "'+u+'"');e.attributeSemantics[u]={symbol:h,type:n}}s.push(h)}return"attribute "+n+" "+s.join(",")+";\n"}),this.attributes=t},_parseDefines:function(){var t=this,e="vertex";function r(r,n,i){var o="vertex"===e?t.vertexDefines:t.fragmentDefines;return o[n]||(o[n]="false"!==i&&("true"===i||(i?isNaN(parseFloat(i))?i.trim():parseFloat(i):null))),""}this._vertexCode=this._vertexCode.replace(zr,r),e="fragment",this._fragmentCode=this._fragmentCode.replace(zr,r)},clone:function(){var t=qr[this._shaderID];return new Qr(t.vertex,t.fragment)}},Object.defineProperty&&(Object.defineProperty(Qr.prototype,"shaderID",{get:function(){return this._shaderID}}),Object.defineProperty(Qr.prototype,"vertex",{get:function(){return this._vertexCode}}),Object.defineProperty(Qr.prototype,"fragment",{get:function(){return this._fragmentCode}}),Object.defineProperty(Qr.prototype,"uniforms",{get:function(){return this._uniformList}}));var $r=/(@import)\s*([0-9a-zA-Z_\-\.]*)/g;Qr.parseImport=function(t){return t=t.replace($r,function(t,e,r){return(t=Qr.source(r))?Qr.parseImport(t):(console.error('Shader chunk "'+r+'" not existed in library'),"")})};var tn=/(@export)\s*([0-9a-zA-Z_\-\.]*)\s*\n([\s\S]*?)@end/g;Qr.import=function(t){t.replace(tn,function(t,e,r,n){if(n=n.replace(/(^[\s\t\xa0\u3000]+)|([\u3000\xa0\s\t]+\x24)/g,"")){for(var i,o=r.split("."),a=Qr.codes,s=0;s<o.length-1;)a[i=o[s++]]||(a[i]={}),a=a[i];a[i=o[s]]=n}return n})},Qr.codes={},Qr.source=function(t){for(var e=t.split("."),r=Qr.codes,n=0;r&&n<e.length;){r=r[e[n++]]}return"string"!=typeof r?(console.error('Shader "'+t+'" not existed in library'),""):r};var en=Qr,rn=function(){this.head=null,this.tail=null,this._length=0};rn.prototype.insert=function(t){var e=new rn.Entry(t);return this.insertEntry(e),e},rn.prototype.insertAt=function(t,e){if(!(t<0)){for(var r=this.head,n=0;r&&n!=t;)r=r.next,n++;if(r){var i=new rn.Entry(e),o=r.prev;o?(o.next=i,i.prev=o):this.head=i,i.next=r,r.prev=i}else this.insert(e)}},rn.prototype.insertBeforeEntry=function(t,e){var r=new rn.Entry(t),n=e.prev;n?(n.next=r,r.prev=n):this.head=r,r.next=e,e.prev=r,this._length++},rn.prototype.insertEntry=function(t){this.head?(this.tail.next=t,t.prev=this.tail,this.tail=t):this.head=this.tail=t,this._length++},rn.prototype.remove=function(t){var e=t.prev,r=t.next;e?e.next=r:this.head=r,r?r.prev=e:this.tail=e,t.next=t.prev=null,this._length--},rn.prototype.removeAt=function(t){if(!(t<0)){for(var e=this.head,r=0;e&&r!=t;)e=e.next,r++;return e?(this.remove(e),e.value):void 0}},rn.prototype.getHead=function(){if(this.head)return this.head.value},rn.prototype.getTail=function(){if(this.tail)return this.tail.value},rn.prototype.getAt=function(t){if(!(t<0)){for(var e=this.head,r=0;e&&r!=t;)e=e.next,r++;return e.value}},rn.prototype.indexOf=function(t){for(var e=this.head,r=0;e;){if(e.value===t)return r;e=e.next,r++}},rn.prototype.length=function(){return this._length},rn.prototype.isEmpty=function(){return 0===this._length},rn.prototype.forEach=function(t,e){for(var r=this.head,n=0,i=void 0!==e;r;)i?t.call(e,r.value,n):t(r.value,n),r=r.next,n++},rn.prototype.clear=function(){this.tail=this.head=null,this._length=0},rn.Entry=function(t){this.value=t,this.next=null,this.prev=null};var nn=rn,on=function(t){this._list=new nn,this._map={},this._maxSize=t||10};on.prototype.setMaxSize=function(t){this._maxSize=t},on.prototype.put=function(t,e){if(!this._map.hasOwnProperty(t)){var r=this._list.length();if(r>=this._maxSize&&r>0){var n=this._list.head;this._list.remove(n),delete this._map[n.key]}var i=this._list.insert(e);i.key=t,this._map[t]=i}},on.prototype.get=function(t){var e=this._map[t];if(this._map.hasOwnProperty(t))return e!==this._list.tail&&(this._list.remove(e),this._list.insertEntry(e)),e.value},on.prototype.remove=function(t){var e=this._map[t];void 0!==e&&(delete this._map[t],this._list.remove(e))},on.prototype.clear=function(){this._list.clear(),this._map={}};var an=on,sn={},hn={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function un(t){return(t=Math.round(t))<0?0:t>255?255:t}function ln(t){return t<0?0:t>1?1:t}function cn(t){return t.length&&"%"===t.charAt(t.length-1)?un(parseFloat(t)/100*255):un(parseInt(t,10))}function fn(t){return t.length&&"%"===t.charAt(t.length-1)?ln(parseFloat(t)/100):ln(parseFloat(t))}function dn(t,e,r){return r<0?r+=1:r>1&&(r-=1),6*r<1?t+(e-t)*r*6:2*r<1?e:3*r<2?t+(e-t)*(2/3-r)*6:t}function pn(t,e,r){return t+(e-t)*r}function mn(t,e,r,n,i){return t[0]=e,t[1]=r,t[2]=n,t[3]=i,t}function gn(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}var _n=new an(20),yn=null;function vn(t,e){yn&&gn(yn,e),yn=_n.put(t,yn||e.slice())}function xn(t,e){var r=(parseFloat(t[0])%360+360)%360/360,n=fn(t[1]),i=fn(t[2]),o=i<=.5?i*(n+1):i+n-i*n,a=2*i-o;return mn(e=e||[],un(255*dn(a,o,r+1/3)),un(255*dn(a,o,r)),un(255*dn(a,o,r-1/3)),1),4===t.length&&(e[3]=t[3]),e}sn.parse=function(t,e){if(t){e=e||[];var r=_n.get(t);if(r)return gn(e,r);var n,i=(t+="").replace(/ /g,"").toLowerCase();if(i in hn)return gn(e,hn[i]),vn(t,e),e;if("#"===i.charAt(0))return 4===i.length?(n=parseInt(i.substr(1),16))>=0&&n<=4095?(mn(e,(3840&n)>>4|(3840&n)>>8,240&n|(240&n)>>4,15&n|(15&n)<<4,1),vn(t,e),e):void mn(e,0,0,0,1):7===i.length?(n=parseInt(i.substr(1),16))>=0&&n<=16777215?(mn(e,(16711680&n)>>16,(65280&n)>>8,255&n,1),vn(t,e),e):void mn(e,0,0,0,1):void 0;var o=i.indexOf("("),a=i.indexOf(")");if(-1!==o&&a+1===i.length){var s=i.substr(0,o),h=i.substr(o+1,a-(o+1)).split(","),u=1;switch(s){case"rgba":if(4!==h.length)return void mn(e,0,0,0,1);u=fn(h.pop());case"rgb":return 3!==h.length?void mn(e,0,0,0,1):(mn(e,cn(h[0]),cn(h[1]),cn(h[2]),u),vn(t,e),e);case"hsla":return 4!==h.length?void mn(e,0,0,0,1):(h[3]=fn(h[3]),xn(h,e),vn(t,e),e);case"hsl":return 3!==h.length?void mn(e,0,0,0,1):(xn(h,e),vn(t,e),e);default:return}}mn(e,0,0,0,1)}},sn.parseToFloat=function(t,e){if(e=sn.parse(t,e))return e[0]/=255,e[1]/=255,e[2]/=255,e},sn.lift=function(t,e){var r=sn.parse(t);if(r){for(var n=0;n<3;n++)r[n]=e<0?r[n]*(1-e)|0:(255-r[n])*e+r[n]|0;return sn.stringify(r,4===r.length?"rgba":"rgb")}},sn.toHex=function(t){var e=sn.parse(t);if(e)return((1<<24)+(e[0]<<16)+(e[1]<<8)+ +e[2]).toString(16).slice(1)},sn.fastLerp=function(t,e,r){if(e&&e.length&&t>=0&&t<=1){r=r||[];var n=t*(e.length-1),i=Math.floor(n),o=Math.ceil(n),a=e[i],s=e[o],h=n-i;return r[0]=un(pn(a[0],s[0],h)),r[1]=un(pn(a[1],s[1],h)),r[2]=un(pn(a[2],s[2],h)),r[3]=ln(pn(a[3],s[3],h)),r}},sn.fastMapToColor=sn.fastLerp,sn.lerp=function(t,e,r){if(e&&e.length&&t>=0&&t<=1){var n=t*(e.length-1),i=Math.floor(n),o=Math.ceil(n),a=sn.parse(e[i]),s=sn.parse(e[o]),h=n-i,u=sn.stringify([un(pn(a[0],s[0],h)),un(pn(a[1],s[1],h)),un(pn(a[2],s[2],h)),ln(pn(a[3],s[3],h))],"rgba");return r?{color:u,leftIndex:i,rightIndex:o,value:n}:u}},sn.mapToColor=sn.lerp,sn.modifyHSL=function(t,e,r,n){if(t=sn.parse(t))return t=function(t){if(t){var e,r,n=t[0]/255,i=t[1]/255,o=t[2]/255,a=Math.min(n,i,o),s=Math.max(n,i,o),h=s-a,u=(s+a)/2;if(0===h)e=0,r=0;else{r=u<.5?h/(s+a):h/(2-s-a);var l=((s-n)/6+h/2)/h,c=((s-i)/6+h/2)/h,f=((s-o)/6+h/2)/h;n===s?e=f-c:i===s?e=1/3+l-f:o===s&&(e=2/3+c-l),e<0&&(e+=1),e>1&&(e-=1)}var d=[360*e,r,u];return null!=t[3]&&d.push(t[3]),d}}(t),null!=e&&(t[0]=(i=e,(i=Math.round(i))<0?0:i>360?360:i)),null!=r&&(t[1]=fn(r)),null!=n&&(t[2]=fn(n)),sn.stringify(xn(t),"rgba");var i},sn.modifyAlpha=function(t,e){if((t=sn.parse(t))&&null!=e)return t[3]=ln(e),sn.stringify(t,"rgba")},sn.stringify=function(t,e){if(t&&t.length){var r=t[0]+","+t[1]+","+t[2];return"rgba"!==e&&"hsva"!==e&&"hsla"!==e||(r+=","+t[3]),e+"("+r+")"}};var bn=sn,wn=bn.parseToFloat,Tn={};function En(t){var e=Object.keys(t);e.sort();for(var r=[],n=0;n<e.length;n++){var i=e[n],o=t[i];null===o?r.push(i):r.push(i+" "+o.toString())}return r.join("\n")}var Cn,Sn=ct.extend(function(){return{name:"",depthTest:!0,depthMask:!0,transparent:!1,blend:null,autoUpdateTextureStatus:!0,uniforms:{},vertexDefines:{},fragmentDefines:{},_textureStatus:{},_enabledUniforms:null}},function(){this.name||(this.name="MATERIAL_"+this.__uid__),this.shader&&this.attachShader(this.shader,!0)},{precision:"highp",setUniform:function(t,e){void 0===e&&console.warn('Uniform value "'+t+'" is undefined');var r=this.uniforms[t];r&&("string"==typeof e&&(e=wn(e)||e),r.value=e,this.autoUpdateTextureStatus&&"t"===r.type&&(e?this.enableTexture(t):this.disableTexture(t)))},setUniforms:function(t){for(var e in t){var r=t[e];this.setUniform(e,r)}},isUniformEnabled:function(t){return this._enabledUniforms.indexOf(t)>=0},getEnabledUniforms:function(){return this._enabledUniforms},getTextureUniforms:function(){return this._textureUniforms},set:function(t,e){if("object"==typeof t)for(var r in t){var n=t[r];this.setUniform(r,n)}else this.setUniform(t,e)},get:function(t){var e=this.uniforms[t];if(e)return e.value},attachShader:function(t,e){var r=this.uniforms;this.uniforms=t.createUniforms(),this.shader=t;var n=this.uniforms;this._enabledUniforms=Object.keys(n),this._enabledUniforms.sort(),this._textureUniforms=this._enabledUniforms.filter(function(t){var e=this.uniforms[t].type;return"t"===e||"tv"===e},this);var i=this.vertexDefines,o=this.fragmentDefines;if(this.vertexDefines=ut.clone(t.vertexDefines),this.fragmentDefines=ut.clone(t.fragmentDefines),e){for(var a in r)n[a]&&(n[a].value=r[a].value);ut.defaults(this.vertexDefines,i),ut.defaults(this.fragmentDefines,o)}var s={};for(var h in t.textures)s[h]={shaderType:t.textures[h].shaderType,type:t.textures[h].type,enabled:!(!e||!this._textureStatus[h])&&this._textureStatus[h].enabled};this._textureStatus=s,this._programKey=""},clone:function(){var t=new this.constructor({name:this.name,shader:this.shader});for(var e in this.uniforms)t.uniforms[e].value=this.uniforms[e].value;return t.depthTest=this.depthTest,t.depthMask=this.depthMask,t.transparent=this.transparent,t.blend=this.blend,t.vertexDefines=ut.clone(this.vertexDefines),t.fragmentDefines=ut.clone(this.fragmentDefines),t.enableTexture(this.getEnabledTextures()),t.precision=this.precision,t},define:function(t,e,r){var n=this.vertexDefines,i=this.fragmentDefines;"vertex"!==t&&"fragment"!==t&&"both"!==t&&arguments.length<3&&(r=e,e=t,t="both"),r=null!=r?r:null,"vertex"!==t&&"both"!==t||n[e]!==r&&(n[e]=r,this._programKey=""),"fragment"!==t&&"both"!==t||i[e]!==r&&(i[e]=r,"both"!==t&&(this._programKey=""))},undefine:function(t,e){"vertex"!==t&&"fragment"!==t&&"both"!==t&&arguments.length<2&&(e=t,t="both"),"vertex"!==t&&"both"!==t||this.isDefined("vertex",e)&&(delete this.vertexDefines[e],this._programKey=""),"fragment"!==t&&"both"!==t||this.isDefined("fragment",e)&&(delete this.fragmentDefines[e],"both"!==t&&(this._programKey=""))},isDefined:function(t,e){switch(t){case"vertex":return void 0!==this.vertexDefines[e];case"fragment":return void 0!==this.fragmentDefines[e]}},getDefine:function(t,e){switch(t){case"vertex":return this.vertexDefines[e];case"fragment":return this.fragmentDefines[e]}},enableTexture:function(t){if(Array.isArray(t))for(var e=0;e<t.length;e++)this.enableTexture(t[e]);else{var r=this._textureStatus[t];if(r)r.enabled||(r.enabled=!0,this._programKey="")}},enableTexturesAll:function(){var t=this._textureStatus;for(var e in t)t[e].enabled=!0;this._programKey=""},disableTexture:function(t){if(Array.isArray(t))for(var e=0;e<t.length;e++)this.disableTexture(t[e]);else{var r=this._textureStatus[t];if(r)!r.enabled||(r.enabled=!1,this._programKey="")}},disableTexturesAll:function(){var t=this._textureStatus;for(var e in t)t[e].enabled=!1;this._programKey=""},isTextureEnabled:function(t){var e=this._textureStatus;return!!e[t]&&e[t].enabled},getEnabledTextures:function(){var t=[],e=this._textureStatus;for(var r in e)e[r].enabled&&t.push(r);return t},dirtyDefines:function(){this._programKey=""},getProgramKey:function(){return this._programKey||(this._programKey=function(t,e,r){r.sort();for(var n=[],i=0;i<r.length;i++){var o=r[i];n.push(o)}var a=En(t)+"\n"+En(e)+"\n"+n.join("\n");if(Tn[a])return Tn[a];var s=ut.genGUID();return Tn[a]=s,s}(this.vertexDefines,this.fragmentDefines,this.getEnabledTextures())),this._programKey}}),An=We.extend({material:null,geometry:null,mode:ft.TRIANGLES,_renderInfo:null},{__program:null,lightGroup:0,renderOrder:0,culling:!0,cullFace:ft.BACK,frontFace:ft.CCW,frustumCulling:!0,receiveShadow:!0,castShadow:!0,ignorePicking:!1,ignorePreZ:!1,ignoreGBuffer:!1,isRenderable:function(){return this.geometry&&this.material&&this.material.shader&&!this.invisible&&this.geometry.vertexCount>0},beforeRender:function(t){},afterRender:function(t,e){},getBoundingBox:function(t,e){return e=We.prototype.getBoundingBox.call(this,t,e),this.geometry&&this.geometry.boundingBox&&e.union(this.geometry.boundingBox),e},clone:(Cn=["castShadow","receiveShadow","mode","culling","cullFace","frontFace","frustumCulling","renderOrder","lineWidth","ignorePicking","ignorePreZ","ignoreGBuffer"],function(){var t=We.prototype.clone.call(this);t.geometry=this.geometry,t.material=this.material;for(var e=0;e<Cn.length;e++){var r=Cn[e];t[r]!==this[r]&&(t[r]=this[r])}return t})});An.POINTS=ft.POINTS,An.LINES=ft.LINES,An.LINE_LOOP=ft.LINE_LOOP,An.LINE_STRIP=ft.LINE_STRIP,An.TRIANGLES=ft.TRIANGLES,An.TRIANGLE_STRIP=ft.TRIANGLE_STRIP,An.TRIANGLE_FAN=ft.TRIANGLE_FAN,An.BACK=ft.BACK,An.FRONT=ft.FRONT,An.FRONT_AND_BACK=ft.FRONT_AND_BACK,An.CW=ft.CW,An.CCW=ft.CCW;var Mn=An,Pn=Mn.extend({skeleton:null,joints:null,useSkinMatricesTexture:!1},function(){this.joints||(this.joints=[])},{isSkinnedMesh:function(){return!!(this.skeleton&&this.joints&&this.joints.length>0)},clone:function(){var t=Mn.prototype.clone.call(this);return t.skeleton=this.skeleton,this.joints&&(t.joints=this.joints.slice()),t}});Pn.POINTS=ft.POINTS,Pn.LINES=ft.LINES,Pn.LINE_LOOP=ft.LINE_LOOP,Pn.LINE_STRIP=ft.LINE_STRIP,Pn.TRIANGLES=ft.TRIANGLES,Pn.TRIANGLE_STRIP=ft.TRIANGLE_STRIP,Pn.TRIANGLE_FAN=ft.TRIANGLE_FAN,Pn.BACK=ft.BACK,Pn.FRONT=ft.FRONT,Pn.FRONT_AND_BACK=ft.FRONT_AND_BACK,Pn.CW=ft.CW,Pn.CCW=ft.CCW;var Rn=Pn;en.import("\n@export clay.compositor.vertex\nuniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\nattribute vec3 position : POSITION;\nattribute vec2 texcoord : TEXCOORD_0;\nvarying vec2 v_Texcoord;\nvoid main()\n{\n v_Texcoord = texcoord;\n gl_Position = worldViewProjection * vec4(position, 1.0);\n}\n@end");var Ln=new Nr,On=new Rn({geometry:Ln,frustumCulling:!1}),kn=new lr,Dn=ct.extend(function(){return{fragment:"",outputs:null,material:null,blendWithPrevious:!1,clearColor:!1,clearDepth:!0}},function(){var t=new en(en.source("clay.compositor.vertex"),this.fragment),e=new Sn({shader:t});e.enableTexturesAll(),this.material=e},{setUniform:function(t,e){this.material.setUniform(t,e)},getUniform:function(t){var e=this.material.uniforms[t];if(e)return e.value},attachOutput:function(t,e){this.outputs||(this.outputs={}),e=e||ft.COLOR_ATTACHMENT0,this.outputs[e]=t},detachOutput:function(t){for(var e in this.outputs)this.outputs[e]===t&&(this.outputs[e]=null)},bind:function(t,e){if(this.outputs)for(var r in this.outputs){var n=this.outputs[r];n&&e.attach(n,r)}e&&e.bind(t)},unbind:function(t,e){e.unbind(t)},render:function(t,e){var r=t.gl;if(e){this.bind(t,e);var n=t.getGLExtension("EXT_draw_buffers");if(n&&this.outputs){var i=[];for(var o in this.outputs)(o=+o)>=r.COLOR_ATTACHMENT0&&o<=r.COLOR_ATTACHMENT0+8&&i.push(o);n.drawBuffersEXT(i)}}this.trigger("beforerender",this,t);var a=this.clearDepth?r.DEPTH_BUFFER_BIT:0;if(r.depthMask(!0),this.clearColor){a|=r.COLOR_BUFFER_BIT,r.colorMask(!0,!0,!0,!0);var s=this.clearColor;Array.isArray(s)&&r.clearColor(s[0],s[1],s[2],s[3])}r.clear(a),this.blendWithPrevious?(r.enable(r.BLEND),this.material.transparent=!0):(r.disable(r.BLEND),this.material.transparent=!1),this.renderQuad(t),this.trigger("afterrender",this,t),e&&this.unbind(t,e)},renderQuad:function(t){On.material=this.material,t.renderPass([On],kn)},dispose:function(t){}}),In=fr.extend(function(){return{name:"",inputs:{},outputs:null,shader:"",inputLinks:{},outputLinks:{},pass:null,_prevOutputTextures:{},_outputTextures:{},_outputReferences:{},_rendering:!1,_rendered:!1,_compositor:null}},function(){var t=new Dn({fragment:this.shader});this.pass=t},{render:function(t,e){this.trigger("beforerender",t),this._rendering=!0;var r=t.gl;for(var n in this.inputLinks){var i=(c=this.inputLinks[n]).node.getOutput(t,c.pin);this.pass.setUniform(n,i)}if(this.outputs){this.pass.outputs={};var o={};for(var a in this.outputs){var s=this.updateParameter(a,t);isNaN(s.width)&&this.updateParameter(a,t);var h=this.outputs[a],u=this._compositor.allocateTexture(s);this._outputTextures[a]=u,"string"==typeof(l=h.attachment||r.COLOR_ATTACHMENT0)&&(l=r[l]),o[l]=u}for(var l in this._compositor.getFrameBuffer().bind(t),o)this._compositor.getFrameBuffer().attach(o[l],l);this.pass.render(t),this._compositor.getFrameBuffer().updateMipmap(t)}else this.pass.outputs=null,this._compositor.getFrameBuffer().unbind(t),this.pass.render(t,e);for(var n in this.inputLinks){var c;(c=this.inputLinks[n]).node.removeReference(c.pin)}this._rendering=!1,this._rendered=!0,this.trigger("afterrender",t)},updateParameter:function(t,e){var r,n,i=this.outputs[t],o=i.parameters,a=i._parametersCopy;if(a||(a=i._parametersCopy={}),o)for(var s in o)"width"!==s&&"height"!==s&&(a[s]=o[s]);return r="function"==typeof o.width?o.width.call(this,e):o.width,n="function"==typeof o.height?o.height.call(this,e):o.height,r=Math.ceil(r),n=Math.ceil(n),a.width===r&&a.height===n||this._outputTextures[t]&&this._outputTextures[t].dispose(e),a.width=r,a.height=n,a},setParameter:function(t,e){this.pass.setUniform(t,e)},getParameter:function(t){return this.pass.getUniform(t)},setParameters:function(t){for(var e in t)this.setParameter(e,t[e])},define:function(t,e){this.pass.material.define("fragment",t,e)},undefine:function(t){this.pass.material.undefine("fragment",t)},removeReference:function(t){(this._outputReferences[t]--,0===this._outputReferences[t])&&(this.outputs[t].keepLastFrame?(this._prevOutputTextures[t]&&this._compositor.releaseTexture(this._prevOutputTextures[t]),this._prevOutputTextures[t]=this._outputTextures[t]):this._compositor.releaseTexture(this._outputTextures[t]))},clear:function(){fr.prototype.clear.call(this),this.pass.material.disableTexturesAll()}}),Nn=_r.isPowerOfTwo,Fn=["px","nx","py","ny","pz","nz"],Bn=mr.extend(function(){return{image:{px:null,nx:null,py:null,ny:null,pz:null,nz:null},pixels:{px:null,nx:null,py:null,ny:null,pz:null,nz:null},mipmaps:[]}},{textureType:"textureCube",update:function(t){var e=t.gl;e.bindTexture(e.TEXTURE_CUBE_MAP,this._cache.get("webgl_texture")),this.updateCommon(t);var r=this.format,n=this.type;e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_S,this.getAvailableWrapS()),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_T,this.getAvailableWrapT()),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MAG_FILTER,this.getAvailableMagFilter()),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MIN_FILTER,this.getAvailableMinFilter());var i=t.getGLExtension("EXT_texture_filter_anisotropic");(i&&this.anisotropic>1&&e.texParameterf(e.TEXTURE_CUBE_MAP,i.TEXTURE_MAX_ANISOTROPY_EXT,this.anisotropic),36193===n)&&(t.getGLExtension("OES_texture_half_float")||(n=ft.FLOAT));if(this.mipmaps.length)for(var o=this.width,a=this.height,s=0;s<this.mipmaps.length;s++){var h=this.mipmaps[s];this._updateTextureData(e,h,s,o,a,r,n),o/=2,a/=2}else this._updateTextureData(e,this,0,this.width,this.height,r,n),!this.NPOT&&this.useMipmap&&e.generateMipmap(e.TEXTURE_CUBE_MAP);e.bindTexture(e.TEXTURE_CUBE_MAP,null)},_updateTextureData:function(t,e,r,n,i,o,a){for(var s=0;s<6;s++){var h=Fn[s],u=e.image&&e.image[h];u?t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+s,r,o,o,a,u):t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+s,r,o,n,i,0,o,a,e.pixels&&e.pixels[h])}},generateMipmap:function(t){var e=t.gl;this.useMipmap&&!this.NPOT&&(e.bindTexture(e.TEXTURE_CUBE_MAP,this._cache.get("webgl_texture")),e.generateMipmap(e.TEXTURE_CUBE_MAP))},bind:function(t){t.gl.bindTexture(t.gl.TEXTURE_CUBE_MAP,this.getWebGLTexture(t))},unbind:function(t){t.gl.bindTexture(t.gl.TEXTURE_CUBE_MAP,null)},isPowerOfTwo:function(){return this.image.px?Nn(this.image.px.width)&&Nn(this.image.px.height):Nn(this.width)&&Nn(this.height)},isRenderable:function(){return this.image.px?zn(this.image.px)&&zn(this.image.nx)&&zn(this.image.py)&&zn(this.image.ny)&&zn(this.image.pz)&&zn(this.image.nz):!(!this.width||!this.height)},load:function(t,e){var r=0,n=this;return ut.each(t,function(t,i){var o=G.a.createImage();e&&(o.crossOrigin=e),o.onload=function(){0===--r&&(n.dirty(),n.trigger("success",n))},o.onerror=function(){r--},r++,o.src=t,n.image[i]=o}),this}});function zn(t){return"CANVAS"===t.nodeName||"VIDEO"===t.nodeName||t.complete}Object.defineProperty(Bn.prototype,"width",{get:function(){return this.image&&this.image.px?this.image.px.width:this._width},set:function(t){this.image&&this.image.px?console.warn("Texture from image can't set width"):(this._width!==t&&this.dirty(),this._width=t)}}),Object.defineProperty(Bn.prototype,"height",{get:function(){return this.image&&this.image.px?this.image.px.height:this._height},set:function(t){this.image&&this.image.px?console.warn("Texture from image can't set height"):(this._height!==t&&this.dirty(),this._height=t)}});var Un=Bn,Hn="@export clay.compositor.coloradjust\nvarying vec2 v_Texcoord;\nuniform sampler2D texture;\nuniform float brightness : 0.0;\nuniform float contrast : 1.0;\nuniform float exposure : 0.0;\nuniform float gamma : 1.0;\nuniform float saturation : 1.0;\nconst vec3 w = vec3(0.2125, 0.7154, 0.0721);\nvoid main()\n{\n vec4 tex = texture2D( texture, v_Texcoord);\n vec3 color = clamp(tex.rgb + vec3(brightness), 0.0, 1.0);\n color = clamp( (color-vec3(0.5))*contrast+vec3(0.5), 0.0, 1.0);\n color = clamp( color * pow(2.0, exposure), 0.0, 1.0);\n color = clamp( pow(color, vec3(gamma)), 0.0, 1.0);\n float luminance = dot( color, w );\n color = mix(vec3(luminance), color, saturation);\n gl_FragColor = vec4(color, tex.a);\n}\n@end\n@export clay.compositor.brightness\nvarying vec2 v_Texcoord;\nuniform sampler2D texture;\nuniform float brightness : 0.0;\nvoid main()\n{\n vec4 tex = texture2D( texture, v_Texcoord);\n vec3 color = tex.rgb + vec3(brightness);\n gl_FragColor = vec4(color, tex.a);\n}\n@end\n@export clay.compositor.contrast\nvarying vec2 v_Texcoord;\nuniform sampler2D texture;\nuniform float contrast : 1.0;\nvoid main()\n{\n vec4 tex = texture2D( texture, v_Texcoord);\n vec3 color = (tex.rgb-vec3(0.5))*contrast+vec3(0.5);\n gl_FragColor = vec4(color, tex.a);\n}\n@end\n@export clay.compositor.exposure\nvarying vec2 v_Texcoord;\nuniform sampler2D texture;\nuniform float exposure : 0.0;\nvoid main()\n{\n vec4 tex = texture2D(texture, v_Texcoord);\n vec3 color = tex.rgb * pow(2.0, exposure);\n gl_FragColor = vec4(color, tex.a);\n}\n@end\n@export clay.compositor.gamma\nvarying vec2 v_Texcoord;\nuniform sampler2D texture;\nuniform float gamma : 1.0;\nvoid main()\n{\n vec4 tex = texture2D(texture, v_Texcoord);\n vec3 color = pow(tex.rgb, vec3(gamma));\n gl_FragColor = vec4(color, tex.a);\n}\n@end\n@export clay.compositor.saturation\nvarying vec2 v_Texcoord;\nuniform sampler2D texture;\nuniform float saturation : 1.0;\nconst vec3 w = vec3(0.2125, 0.7154, 0.0721);\nvoid main()\n{\n vec4 tex = texture2D(texture, v_Texcoord);\n vec3 color = tex.rgb;\n float luminance = dot(color, w);\n color = mix(vec3(luminance), color, saturation);\n gl_FragColor = vec4(color, tex.a);\n}\n@end",jn="@export clay.compositor.kernel.gaussian_9\nfloat gaussianKernel[9];\ngaussianKernel[0] = 0.07;\ngaussianKernel[1] = 0.09;\ngaussianKernel[2] = 0.12;\ngaussianKernel[3] = 0.14;\ngaussianKernel[4] = 0.16;\ngaussianKernel[5] = 0.14;\ngaussianKernel[6] = 0.12;\ngaussianKernel[7] = 0.09;\ngaussianKernel[8] = 0.07;\n@end\n@export clay.compositor.kernel.gaussian_13\nfloat gaussianKernel[13];\ngaussianKernel[0] = 0.02;\ngaussianKernel[1] = 0.03;\ngaussianKernel[2] = 0.06;\ngaussianKernel[3] = 0.08;\ngaussianKernel[4] = 0.11;\ngaussianKernel[5] = 0.13;\ngaussianKernel[6] = 0.14;\ngaussianKernel[7] = 0.13;\ngaussianKernel[8] = 0.11;\ngaussianKernel[9] = 0.08;\ngaussianKernel[10] = 0.06;\ngaussianKernel[11] = 0.03;\ngaussianKernel[12] = 0.02;\n@end\n@export clay.compositor.gaussian_blur\n#define SHADER_NAME gaussian_blur\nuniform sampler2D texture;varying vec2 v_Texcoord;\nuniform float blurSize : 2.0;\nuniform vec2 textureSize : [512.0, 512.0];\nuniform float blurDir : 0.0;\n@import clay.util.rgbm\n@import clay.util.clamp_sample\nvoid main (void)\n{\n @import clay.compositor.kernel.gaussian_9\n vec2 off = blurSize / textureSize;\n off *= vec2(1.0 - blurDir, blurDir);\n vec4 sum = vec4(0.0);\n float weightAll = 0.0;\n for (int i = 0; i < 9; i++) {\n float w = gaussianKernel[i];\n vec4 texel = decodeHDR(clampSample(texture, v_Texcoord + float(i - 4) * off));\n sum += texel * w;\n weightAll += w;\n }\n gl_FragColor = encodeHDR(sum / max(weightAll, 0.01));\n}\n@end\n",Gn="@export clay.compositor.hdr.log_lum\nvarying vec2 v_Texcoord;\nuniform sampler2D texture;\nconst vec3 w = vec3(0.2125, 0.7154, 0.0721);\n@import clay.util.rgbm\nvoid main()\n{\n vec4 tex = decodeHDR(texture2D(texture, v_Texcoord));\n float luminance = dot(tex.rgb, w);\n luminance = log(luminance + 0.001);\n gl_FragColor = encodeHDR(vec4(vec3(luminance), 1.0));\n}\n@end\n@export clay.compositor.hdr.lum_adaption\nvarying vec2 v_Texcoord;\nuniform sampler2D adaptedLum;\nuniform sampler2D currentLum;\nuniform float frameTime : 0.02;\n@import clay.util.rgbm\nvoid main()\n{\n float fAdaptedLum = decodeHDR(texture2D(adaptedLum, vec2(0.5, 0.5))).r;\n float fCurrentLum = exp(encodeHDR(texture2D(currentLum, vec2(0.5, 0.5))).r);\n fAdaptedLum += (fCurrentLum - fAdaptedLum) * (1.0 - pow(0.98, 30.0 * frameTime));\n gl_FragColor = encodeHDR(vec4(vec3(fAdaptedLum), 1.0));\n}\n@end\n@export clay.compositor.lum\nvarying vec2 v_Texcoord;\nuniform sampler2D texture;\nconst vec3 w = vec3(0.2125, 0.7154, 0.0721);\nvoid main()\n{\n vec4 tex = texture2D( texture, v_Texcoord );\n float luminance = dot(tex.rgb, w);\n gl_FragColor = vec4(vec3(luminance), 1.0);\n}\n@end",Vn="\n@export clay.compositor.lut\nvarying vec2 v_Texcoord;\nuniform sampler2D texture;\nuniform sampler2D lookup;\nvoid main()\n{\n vec4 tex = texture2D(texture, v_Texcoord);\n float blueColor = tex.b * 63.0;\n vec2 quad1;\n quad1.y = floor(floor(blueColor) / 8.0);\n quad1.x = floor(blueColor) - (quad1.y * 8.0);\n vec2 quad2;\n quad2.y = floor(ceil(blueColor) / 8.0);\n quad2.x = ceil(blueColor) - (quad2.y * 8.0);\n vec2 texPos1;\n texPos1.x = (quad1.x * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * tex.r);\n texPos1.y = (quad1.y * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * tex.g);\n vec2 texPos2;\n texPos2.x = (quad2.x * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * tex.r);\n texPos2.y = (quad2.y * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * tex.g);\n vec4 newColor1 = texture2D(lookup, texPos1);\n vec4 newColor2 = texture2D(lookup, texPos2);\n vec4 newColor = mix(newColor1, newColor2, fract(blueColor));\n gl_FragColor = vec4(newColor.rgb, tex.w);\n}\n@end",Wn="@export clay.compositor.vignette\n#define OUTPUT_ALPHA\nvarying vec2 v_Texcoord;\nuniform sampler2D texture;\nuniform float darkness: 1;\nuniform float offset: 1;\n@import clay.util.rgbm\nvoid main()\n{\n vec4 texel = decodeHDR(texture2D(texture, v_Texcoord));\n gl_FragColor.rgb = texel.rgb;\n vec2 uv = (v_Texcoord - vec2(0.5)) * vec2(offset);\n gl_FragColor = encodeHDR(vec4(mix(texel.rgb, vec3(1.0 - darkness), dot(uv, uv)), texel.a));\n}\n@end",Zn="@export clay.compositor.output\n#define OUTPUT_ALPHA\nvarying vec2 v_Texcoord;\nuniform sampler2D texture;\n@import clay.util.rgbm\nvoid main()\n{\n vec4 tex = decodeHDR(texture2D(texture, v_Texcoord));\n gl_FragColor.rgb = tex.rgb;\n#ifdef OUTPUT_ALPHA\n gl_FragColor.a = tex.a;\n#else\n gl_FragColor.a = 1.0;\n#endif\n gl_FragColor = encodeHDR(gl_FragColor);\n#ifdef PREMULTIPLY_ALPHA\n gl_FragColor.rgb *= gl_FragColor.a;\n#endif\n}\n@end",Xn="@export clay.compositor.bright\nuniform sampler2D texture;\nuniform float threshold : 1;\nuniform float scale : 1.0;\nuniform vec2 textureSize: [512, 512];\nvarying vec2 v_Texcoord;\nconst vec3 lumWeight = vec3(0.2125, 0.7154, 0.0721);\n@import clay.util.rgbm\nvec4 median(vec4 a, vec4 b, vec4 c)\n{\n return a + b + c - min(min(a, b), c) - max(max(a, b), c);\n}\nvoid main()\n{\n vec4 texel = decodeHDR(texture2D(texture, v_Texcoord));\n#ifdef ANTI_FLICKER\n vec3 d = 1.0 / textureSize.xyx * vec3(1.0, 1.0, 0.0);\n vec4 s1 = decodeHDR(texture2D(texture, v_Texcoord - d.xz));\n vec4 s2 = decodeHDR(texture2D(texture, v_Texcoord + d.xz));\n vec4 s3 = decodeHDR(texture2D(texture, v_Texcoord - d.zy));\n vec4 s4 = decodeHDR(texture2D(texture, v_Texcoord + d.zy));\n texel = median(median(texel, s1, s2), s3, s4);\n#endif\n float lum = dot(texel.rgb , lumWeight);\n vec4 color;\n if (lum > threshold && texel.a > 0.0)\n {\n color = vec4(texel.rgb * scale, texel.a * scale);\n }\n else\n {\n color = vec4(0.0);\n }\n gl_FragColor = encodeHDR(color);\n}\n@end\n",qn="@export clay.compositor.downsample\nuniform sampler2D texture;\nuniform vec2 textureSize : [512, 512];\nvarying vec2 v_Texcoord;\n@import clay.util.rgbm\nfloat brightness(vec3 c)\n{\n return max(max(c.r, c.g), c.b);\n}\n@import clay.util.clamp_sample\nvoid main()\n{\n vec4 d = vec4(-1.0, -1.0, 1.0, 1.0) / textureSize.xyxy;\n#ifdef ANTI_FLICKER\n vec3 s1 = decodeHDR(clampSample(texture, v_Texcoord + d.xy)).rgb;\n vec3 s2 = decodeHDR(clampSample(texture, v_Texcoord + d.zy)).rgb;\n vec3 s3 = decodeHDR(clampSample(texture, v_Texcoord + d.xw)).rgb;\n vec3 s4 = decodeHDR(clampSample(texture, v_Texcoord + d.zw)).rgb;\n float s1w = 1.0 / (brightness(s1) + 1.0);\n float s2w = 1.0 / (brightness(s2) + 1.0);\n float s3w = 1.0 / (brightness(s3) + 1.0);\n float s4w = 1.0 / (brightness(s4) + 1.0);\n float oneDivideSum = 1.0 / (s1w + s2w + s3w + s4w);\n vec4 color = vec4(\n (s1 * s1w + s2 * s2w + s3 * s3w + s4 * s4w) * oneDivideSum,\n 1.0\n );\n#else\n vec4 color = decodeHDR(clampSample(texture, v_Texcoord + d.xy));\n color += decodeHDR(clampSample(texture, v_Texcoord + d.zy));\n color += decodeHDR(clampSample(texture, v_Texcoord + d.xw));\n color += decodeHDR(clampSample(texture, v_Texcoord + d.zw));\n color *= 0.25;\n#endif\n gl_FragColor = encodeHDR(color);\n}\n@end",Yn="\n@export clay.compositor.upsample\n#define HIGH_QUALITY\nuniform sampler2D texture;\nuniform vec2 textureSize : [512, 512];\nuniform float sampleScale: 0.5;\nvarying vec2 v_Texcoord;\n@import clay.util.rgbm\n@import clay.util.clamp_sample\nvoid main()\n{\n#ifdef HIGH_QUALITY\n vec4 d = vec4(1.0, 1.0, -1.0, 0.0) / textureSize.xyxy * sampleScale;\n vec4 s;\n s = decodeHDR(clampSample(texture, v_Texcoord - d.xy));\n s += decodeHDR(clampSample(texture, v_Texcoord - d.wy)) * 2.0;\n s += decodeHDR(clampSample(texture, v_Texcoord - d.zy));\n s += decodeHDR(clampSample(texture, v_Texcoord + d.zw)) * 2.0;\n s += decodeHDR(clampSample(texture, v_Texcoord )) * 4.0;\n s += decodeHDR(clampSample(texture, v_Texcoord + d.xw)) * 2.0;\n s += decodeHDR(clampSample(texture, v_Texcoord + d.zy));\n s += decodeHDR(clampSample(texture, v_Texcoord + d.wy)) * 2.0;\n s += decodeHDR(clampSample(texture, v_Texcoord + d.xy));\n gl_FragColor = encodeHDR(s / 16.0);\n#else\n vec4 d = vec4(-1.0, -1.0, +1.0, +1.0) / textureSize.xyxy;\n vec4 s;\n s = decodeHDR(clampSample(texture, v_Texcoord + d.xy));\n s += decodeHDR(clampSample(texture, v_Texcoord + d.zy));\n s += decodeHDR(clampSample(texture, v_Texcoord + d.xw));\n s += decodeHDR(clampSample(texture, v_Texcoord + d.zw));\n gl_FragColor = encodeHDR(s / 4.0);\n#endif\n}\n@end",Jn="@export clay.compositor.hdr.composite\n#define TONEMAPPING\nuniform sampler2D texture;\n#ifdef BLOOM_ENABLED\nuniform sampler2D bloom;\n#endif\n#ifdef LENSFLARE_ENABLED\nuniform sampler2D lensflare;\nuniform sampler2D lensdirt;\n#endif\n#ifdef LUM_ENABLED\nuniform sampler2D lum;\n#endif\n#ifdef LUT_ENABLED\nuniform sampler2D lut;\n#endif\n#ifdef COLOR_CORRECTION\nuniform float brightness : 0.0;\nuniform float contrast : 1.0;\nuniform float saturation : 1.0;\n#endif\n#ifdef VIGNETTE\nuniform float vignetteDarkness: 1.0;\nuniform float vignetteOffset: 1.0;\n#endif\nuniform float exposure : 1.0;\nuniform float bloomIntensity : 0.25;\nuniform float lensflareIntensity : 1;\nvarying vec2 v_Texcoord;\n@import clay.util.srgb\nvec3 ACESToneMapping(vec3 color)\n{\n const float A = 2.51;\n const float B = 0.03;\n const float C = 2.43;\n const float D = 0.59;\n const float E = 0.14;\n return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nfloat eyeAdaption(float fLum)\n{\n return mix(0.2, fLum, 0.5);\n}\n#ifdef LUT_ENABLED\nvec3 lutTransform(vec3 color) {\n float blueColor = color.b * 63.0;\n vec2 quad1;\n quad1.y = floor(floor(blueColor) / 8.0);\n quad1.x = floor(blueColor) - (quad1.y * 8.0);\n vec2 quad2;\n quad2.y = floor(ceil(blueColor) / 8.0);\n quad2.x = ceil(blueColor) - (quad2.y * 8.0);\n vec2 texPos1;\n texPos1.x = (quad1.x * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * color.r);\n texPos1.y = (quad1.y * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * color.g);\n vec2 texPos2;\n texPos2.x = (quad2.x * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * color.r);\n texPos2.y = (quad2.y * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * color.g);\n vec4 newColor1 = texture2D(lut, texPos1);\n vec4 newColor2 = texture2D(lut, texPos2);\n vec4 newColor = mix(newColor1, newColor2, fract(blueColor));\n return newColor.rgb;\n}\n#endif\n@import clay.util.rgbm\nvoid main()\n{\n vec4 texel = vec4(0.0);\n vec4 originalTexel = vec4(0.0);\n#ifdef TEXTURE_ENABLED\n texel = decodeHDR(texture2D(texture, v_Texcoord));\n originalTexel = texel;\n#endif\n#ifdef BLOOM_ENABLED\n vec4 bloomTexel = decodeHDR(texture2D(bloom, v_Texcoord));\n texel.rgb += bloomTexel.rgb * bloomIntensity;\n texel.a += bloomTexel.a * bloomIntensity;\n#endif\n#ifdef LENSFLARE_ENABLED\n texel += decodeHDR(texture2D(lensflare, v_Texcoord)) * texture2D(lensdirt, v_Texcoord) * lensflareIntensity;\n#endif\n texel.a = min(texel.a, 1.0);\n#ifdef LUM_ENABLED\n float fLum = texture2D(lum, vec2(0.5, 0.5)).r;\n float adaptedLumDest = 3.0 / (max(0.1, 1.0 + 10.0*eyeAdaption(fLum)));\n float exposureBias = adaptedLumDest * exposure;\n#else\n float exposureBias = exposure;\n#endif\n#ifdef TONEMAPPING\n texel.rgb *= exposureBias;\n texel.rgb = ACESToneMapping(texel.rgb);\n#endif\n texel = linearTosRGB(texel);\n#ifdef LUT_ENABLED\n texel.rgb = lutTransform(clamp(texel.rgb,vec3(0.0),vec3(1.0)));\n#endif\n#ifdef COLOR_CORRECTION\n texel.rgb = clamp(texel.rgb + vec3(brightness), 0.0, 1.0);\n texel.rgb = clamp((texel.rgb - vec3(0.5))*contrast+vec3(0.5), 0.0, 1.0);\n float lum = dot(texel.rgb, vec3(0.2125, 0.7154, 0.0721));\n texel.rgb = mix(vec3(lum), texel.rgb, saturation);\n#endif\n#ifdef VIGNETTE\n vec2 uv = (v_Texcoord - vec2(0.5)) * vec2(vignetteOffset);\n texel.rgb = mix(texel.rgb, vec3(1.0 - vignetteDarkness), dot(uv, uv));\n#endif\n gl_FragColor = encodeHDR(texel);\n#ifdef DEBUG\n #if DEBUG == 1\n gl_FragColor = encodeHDR(decodeHDR(texture2D(texture, v_Texcoord)));\n #elif DEBUG == 2\n gl_FragColor = encodeHDR(decodeHDR(texture2D(bloom, v_Texcoord)) * bloomIntensity);\n #elif DEBUG == 3\n gl_FragColor = encodeHDR(decodeHDR(texture2D(lensflare, v_Texcoord) * lensflareIntensity));\n #endif\n#endif\n if (originalTexel.a <= 0.01 && gl_FragColor.a > 1e-5) {\n gl_FragColor.a = dot(gl_FragColor.rgb, vec3(0.2125, 0.7154, 0.0721));\n }\n#ifdef PREMULTIPLY_ALPHA\n gl_FragColor.rgb *= gl_FragColor.a;\n#endif\n}\n@end",Kn="@export clay.compositor.lensflare\n#define SAMPLE_NUMBER 8\nuniform sampler2D texture;\nuniform sampler2D lenscolor;\nuniform vec2 textureSize : [512, 512];\nuniform float dispersal : 0.3;\nuniform float haloWidth : 0.4;\nuniform float distortion : 1.0;\nvarying vec2 v_Texcoord;\n@import clay.util.rgbm\nvec4 textureDistorted(\n in vec2 texcoord,\n in vec2 direction,\n in vec3 distortion\n) {\n return vec4(\n decodeHDR(texture2D(texture, texcoord + direction * distortion.r)).r,\n decodeHDR(texture2D(texture, texcoord + direction * distortion.g)).g,\n decodeHDR(texture2D(texture, texcoord + direction * distortion.b)).b,\n 1.0\n );\n}\nvoid main()\n{\n vec2 texcoord = -v_Texcoord + vec2(1.0); vec2 textureOffset = 1.0 / textureSize;\n vec2 ghostVec = (vec2(0.5) - texcoord) * dispersal;\n vec2 haloVec = normalize(ghostVec) * haloWidth;\n vec3 distortion = vec3(-textureOffset.x * distortion, 0.0, textureOffset.x * distortion);\n vec4 result = vec4(0.0);\n for (int i = 0; i < SAMPLE_NUMBER; i++)\n {\n vec2 offset = fract(texcoord + ghostVec * float(i));\n float weight = length(vec2(0.5) - offset) / length(vec2(0.5));\n weight = pow(1.0 - weight, 10.0);\n result += textureDistorted(offset, normalize(ghostVec), distortion) * weight;\n }\n result *= texture2D(lenscolor, vec2(length(vec2(0.5) - texcoord)) / length(vec2(0.5)));\n float weight = length(vec2(0.5) - fract(texcoord + haloVec)) / length(vec2(0.5));\n weight = pow(1.0 - weight, 10.0);\n vec2 offset = fract(texcoord + haloVec);\n result += textureDistorted(offset, normalize(ghostVec), distortion) * weight;\n gl_FragColor = result;\n}\n@end",Qn="@export clay.compositor.blend\n#define SHADER_NAME blend\n#ifdef TEXTURE1_ENABLED\nuniform sampler2D texture1;\nuniform float weight1 : 1.0;\n#endif\n#ifdef TEXTURE2_ENABLED\nuniform sampler2D texture2;\nuniform float weight2 : 1.0;\n#endif\n#ifdef TEXTURE3_ENABLED\nuniform sampler2D texture3;\nuniform float weight3 : 1.0;\n#endif\n#ifdef TEXTURE4_ENABLED\nuniform sampler2D texture4;\nuniform float weight4 : 1.0;\n#endif\n#ifdef TEXTURE5_ENABLED\nuniform sampler2D texture5;\nuniform float weight5 : 1.0;\n#endif\n#ifdef TEXTURE6_ENABLED\nuniform sampler2D texture6;\nuniform float weight6 : 1.0;\n#endif\nvarying vec2 v_Texcoord;\n@import clay.util.rgbm\nvoid main()\n{\n vec4 tex = vec4(0.0);\n#ifdef TEXTURE1_ENABLED\n tex += decodeHDR(texture2D(texture1, v_Texcoord)) * weight1;\n#endif\n#ifdef TEXTURE2_ENABLED\n tex += decodeHDR(texture2D(texture2, v_Texcoord)) * weight2;\n#endif\n#ifdef TEXTURE3_ENABLED\n tex += decodeHDR(texture2D(texture3, v_Texcoord)) * weight3;\n#endif\n#ifdef TEXTURE4_ENABLED\n tex += decodeHDR(texture2D(texture4, v_Texcoord)) * weight4;\n#endif\n#ifdef TEXTURE5_ENABLED\n tex += decodeHDR(texture2D(texture5, v_Texcoord)) * weight5;\n#endif\n#ifdef TEXTURE6_ENABLED\n tex += decodeHDR(texture2D(texture6, v_Texcoord)) * weight6;\n#endif\n gl_FragColor = encodeHDR(tex);\n}\n@end",$n="@export clay.compositor.fxaa\nuniform sampler2D texture;\nuniform vec4 viewport : VIEWPORT;\nvarying vec2 v_Texcoord;\n#define FXAA_REDUCE_MIN (1.0/128.0)\n#define FXAA_REDUCE_MUL (1.0/8.0)\n#define FXAA_SPAN_MAX 8.0\n@import clay.util.rgbm\nvoid main()\n{\n vec2 resolution = 1.0 / viewport.zw;\n vec3 rgbNW = decodeHDR( texture2D( texture, ( gl_FragCoord.xy + vec2( -1.0, -1.0 ) ) * resolution ) ).xyz;\n vec3 rgbNE = decodeHDR( texture2D( texture, ( gl_FragCoord.xy + vec2( 1.0, -1.0 ) ) * resolution ) ).xyz;\n vec3 rgbSW = decodeHDR( texture2D( texture, ( gl_FragCoord.xy + vec2( -1.0, 1.0 ) ) * resolution ) ).xyz;\n vec3 rgbSE = decodeHDR( texture2D( texture, ( gl_FragCoord.xy + vec2( 1.0, 1.0 ) ) * resolution ) ).xyz;\n vec4 rgbaM = decodeHDR( texture2D( texture, gl_FragCoord.xy * resolution ) );\n vec3 rgbM = rgbaM.xyz;\n float opacity = rgbaM.w;\n vec3 luma = vec3( 0.299, 0.587, 0.114 );\n float lumaNW = dot( rgbNW, luma );\n float lumaNE = dot( rgbNE, luma );\n float lumaSW = dot( rgbSW, luma );\n float lumaSE = dot( rgbSE, luma );\n float lumaM = dot( rgbM, luma );\n float lumaMin = min( lumaM, min( min( lumaNW, lumaNE ), min( lumaSW, lumaSE ) ) );\n float lumaMax = max( lumaM, max( max( lumaNW, lumaNE) , max( lumaSW, lumaSE ) ) );\n vec2 dir;\n dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\n dir.y = ((lumaNW + lumaSW) - (lumaNE + lumaSE));\n float dirReduce = max( ( lumaNW + lumaNE + lumaSW + lumaSE ) * ( 0.25 * FXAA_REDUCE_MUL ), FXAA_REDUCE_MIN );\n float rcpDirMin = 1.0 / ( min( abs( dir.x ), abs( dir.y ) ) + dirReduce );\n dir = min( vec2( FXAA_SPAN_MAX, FXAA_SPAN_MAX),\n max( vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX),\n dir * rcpDirMin)) * resolution;\n vec3 rgbA = decodeHDR( texture2D( texture, gl_FragCoord.xy * resolution + dir * ( 1.0 / 3.0 - 0.5 ) ) ).xyz;\n rgbA += decodeHDR( texture2D( texture, gl_FragCoord.xy * resolution + dir * ( 2.0 / 3.0 - 0.5 ) ) ).xyz;\n rgbA *= 0.5;\n vec3 rgbB = decodeHDR( texture2D( texture, gl_FragCoord.xy * resolution + dir * -0.5 ) ).xyz;\n rgbB += decodeHDR( texture2D( texture, gl_FragCoord.xy * resolution + dir * 0.5 ) ).xyz;\n rgbB *= 0.25;\n rgbB += rgbA * 0.5;\n float lumaB = dot( rgbB, luma );\n if ( ( lumaB < lumaMin ) || ( lumaB > lumaMax ) )\n {\n gl_FragColor = vec4( rgbA, opacity );\n }\n else {\n gl_FragColor = vec4( rgbB, opacity );\n }\n}\n@end";function ti(t){t.import(Hn),t.import(jn),t.import(Gn),t.import(Vn),t.import(Wn),t.import(Zn),t.import(Xn),t.import(qn),t.import(Yn),t.import(Jn),t.import(Kn),t.import(Qn),t.import($n)}ti(en);var ei=/^#source\((.*?)\)/;function ri(t,e,r){var n,i,o,a,s=t.type||"filter";if("filter"===s){var h=t.shader.trim(),u=ei.exec(h);if(u?n=en.source(u[1].trim()):"#"===h.charAt(0)&&(n=e.shaders[h.substr(1)]),n||(n=h),!n)return}if(t.inputs)for(var l in i={},t.inputs)"string"==typeof t.inputs[l]?i[l]=t.inputs[l]:i[l]={node:t.inputs[l].node,pin:t.inputs[l].pin};if(t.outputs)for(var l in o={},t.outputs){var c=t.outputs[l];o[l]={},null!=c.attachment&&(o[l].attachment=c.attachment),null!=c.keepLastFrame&&(o[l].keepLastFrame=c.keepLastFrame),null!=c.outputLastFrame&&(o[l].outputLastFrame=c.outputLastFrame),c.parameters&&(o[l].parameters=oi(c.parameters))}if(a="scene"===s?new Dr({name:t.name,scene:r.scene,camera:r.camera,outputs:o}):"texture"===s?new Ir({name:t.name,outputs:o}):new In({name:t.name,shader:n,inputs:i,outputs:o})){if(t.parameters)for(var l in t.parameters){"string"==typeof(f=t.parameters[l])?"#"===(f=f.trim()).charAt(0)?f=e.textures[f.substr(1)]:a.on("beforerender",ai(l,si(f))):"function"==typeof f&&a.on("beforerender",f),a.setParameter(l,f)}if(t.defines&&a.pass)for(var l in t.defines){var f=t.defines[l];a.pass.material.define("fragment",l,f)}}return a}function ni(t,e){return t}function ii(t,e){return e}function oi(t){var e={};if(!t)return e;["type","minFilter","magFilter","wrapS","wrapT","flipY","useMipmap"].forEach(function(r){var n=t[r];null!=n&&("string"==typeof n&&(n=mr[n]),e[r]=n)});var r=t.scale||1;return["width","height"].forEach(function(n){if(null!=t[n]){var i=t[n];"string"==typeof i?(i=i.trim(),e[n]=(o=si(i),a=(a=r)||1,function(t){var e=t.getDevicePixelRatio(),r=t.getWidth()*a,n=t.getHeight()*a;return o(r,n,e)})):e[n]=i}var o,a}),e.width||(e.width=ni),e.height||(e.height=ii),null!=t.useMipmap&&(e.useMipmap=t.useMipmap),e}function ai(t,e){return function(r){var n=r.getDevicePixelRatio(),i=r.getWidth(),o=r.getHeight(),a=e(i,o,n);this.setParameter(t,a)}}function si(t){var e=/^expr\((.*)\)$/.exec(t);if(e)try{var r=new Function("width","height","dpr","return "+e[1]);return r(1,1),r}catch(t){throw new Error("Invalid expression.")}}var hi=function(t,e){var r=new kr;e=e||{};var n={textures:{},parameters:{}};for(var i in t.parameters){var o=t.parameters[i];n.parameters[i]=oi(o)}return function(t,e,r,n){if(t.textures){var i={},o=0,a=!1,s=r.textureRootPath;ut.each(t.textures,function(t,e){var r,h=t.path,u=oi(t.parameters);if(Array.isArray(h)&&6===h.length)s&&(h=h.map(function(t){return ut.relative2absolute(t,s)})),r=new Un(u);else{if("string"!=typeof h)return;s&&(h=ut.relative2absolute(h,s)),r=new br(u)}r.load(h),o++,r.once("success",function(){i[e]=r,0==--o&&(n(i),a=!0)})}),0!==o||a||n(i)}else n({})}(t,0,e,function(i){n.textures=i,function(i,o){for(var a=0;a<t.nodes.length;a++){var s=ri(t.nodes[a],n,e);s&&r.addNode(s)}}()}),r},ui=hi,li=["OES_texture_float","OES_texture_half_float","OES_texture_float_linear","OES_texture_half_float_linear","OES_standard_derivatives","OES_vertex_array_object","OES_element_index_uint","WEBGL_compressed_texture_s3tc","WEBGL_depth_texture","EXT_texture_filter_anisotropic","EXT_shader_texture_lod","WEBGL_draw_buffers","EXT_frag_depth","EXT_sRGB"],ci=["MAX_TEXTURE_SIZE","MAX_CUBE_MAP_TEXTURE_SIZE"];var fi=function(t){for(var e={},r={},n=0;n<li.length;n++)o(li[n]);for(n=0;n<ci.length;n++){var i=ci[n];r[i]=t.getParameter(t[i])}function o(r){var n=t.getExtension(r);n||(n=t.getExtension("MOZ_"+r)),n||(n=t.getExtension("WEBKIT_"+r)),e[r]=n}this.getExtension=function(t){return t in e||o(t),e[t]},this.getParameter=function(t){return r[t]},this.getMaxJointNumber=function(){return 15}},di=r(67);function pi(t){var e=document.createElement("canvas");e.width=e.height=1;var r=e.getContext("2d");return r.fillStyle=t||"#000",r.fillRect(0,0,1,1),e}en.import("@export clay.deferred.gbuffer.vertex\nuniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\nattribute vec3 position : POSITION;\n#if defined(SECOND_PASS) || defined(FIRST_PASS)\nattribute vec2 texcoord : TEXCOORD_0;\nuniform vec2 uvRepeat;\nuniform vec2 uvOffset;\nvarying vec2 v_Texcoord;\n#endif\n#ifdef FIRST_PASS\nuniform mat4 worldInverseTranspose : WORLDINVERSETRANSPOSE;\nuniform mat4 world : WORLD;\nvarying vec3 v_Normal;\nattribute vec3 normal : NORMAL;\nattribute vec4 tangent : TANGENT;\nvarying vec3 v_Tangent;\nvarying vec3 v_Bitangent;\nvarying vec3 v_WorldPosition;\n#endif\n@import clay.chunk.skinning_header\n#ifdef THIRD_PASS\nuniform mat4 prevWorldViewProjection;\nvarying vec4 v_ViewPosition;\nvarying vec4 v_PrevViewPosition;\n#ifdef SKINNING\n#ifdef USE_SKIN_MATRICES_TEXTURE\nuniform sampler2D prevSkinMatricesTexture;\nmat4 getPrevSkinMatrix(float idx) {\n return getSkinMatrix(prevSkinMatricesTexture, idx);\n}\n#else\nuniform mat4 prevSkinMatrix[JOINT_COUNT];\nmat4 getPrevSkinMatrix(float idx) {\n return prevSkinMatrix[int(idx)];\n}\n#endif\n#endif\n#endif\nvoid main()\n{\n vec3 skinnedPosition = position;\n vec3 prevSkinnedPosition = position;\n#ifdef FIRST_PASS\n vec3 skinnedNormal = normal;\n vec3 skinnedTangent = tangent.xyz;\n bool hasTangent = dot(tangent, tangent) > 0.0;\n#endif\n#ifdef SKINNING\n @import clay.chunk.skin_matrix\n skinnedPosition = (skinMatrixWS * vec4(position, 1.0)).xyz;\n #ifdef FIRST_PASS\n skinnedNormal = (skinMatrixWS * vec4(normal, 0.0)).xyz;\n if (hasTangent) {\n skinnedTangent = (skinMatrixWS * vec4(tangent.xyz, 0.0)).xyz;\n }\n #endif\n #ifdef THIRD_PASS\n {\n mat4 prevSkinMatrixWS = getPrevSkinMatrix(joint.x) * weight.x;\n if (weight.y > 1e-4) { prevSkinMatrixWS += getPrevSkinMatrix(joint.y) * weight.y; }\n if (weight.z > 1e-4) { prevSkinMatrixWS += getPrevSkinMatrix(joint.z) * weight.z; }\n float weightW = 1.0-weight.x-weight.y-weight.z;\n if (weightW > 1e-4) { prevSkinMatrixWS += getPrevSkinMatrix(joint.w) * weightW; }\n prevSkinnedPosition = (prevSkinMatrixWS * vec4(position, 1.0)).xyz;\n }\n #endif\n#endif\n#if defined(SECOND_PASS) || defined(FIRST_PASS)\n v_Texcoord = texcoord * uvRepeat + uvOffset;\n#endif\n#ifdef FIRST_PASS\n v_Normal = normalize((worldInverseTranspose * vec4(skinnedNormal, 0.0)).xyz);\n if (hasTangent) {\n v_Tangent = normalize((worldInverseTranspose * vec4(skinnedTangent, 0.0)).xyz);\n v_Bitangent = normalize(cross(v_Normal, v_Tangent) * tangent.w);\n }\n v_WorldPosition = (world * vec4(skinnedPosition, 1.0)).xyz;\n#endif\n#ifdef THIRD_PASS\n v_ViewPosition = worldViewProjection * vec4(skinnedPosition, 1.0);\n v_PrevViewPosition = prevWorldViewProjection * vec4(prevSkinnedPosition, 1.0);\n#endif\n gl_Position = worldViewProjection * vec4(skinnedPosition, 1.0);\n}\n@end\n@export clay.deferred.gbuffer1.fragment\nuniform mat4 viewInverse : VIEWINVERSE;\nuniform float glossiness;\nvarying vec2 v_Texcoord;\nvarying vec3 v_Normal;\nvarying vec3 v_WorldPosition;\nuniform sampler2D normalMap;\nuniform sampler2D diffuseMap;\nvarying vec3 v_Tangent;\nvarying vec3 v_Bitangent;\nuniform sampler2D roughGlossMap;\nuniform bool useRoughGlossMap;\nuniform bool useRoughness;\nuniform bool doubleSided;\nuniform float alphaCutoff: 0.0;\nuniform float alpha: 1.0;\nuniform int roughGlossChannel: 0;\nfloat indexingTexel(in vec4 texel, in int idx) {\n if (idx == 3) return texel.a;\n else if (idx == 1) return texel.g;\n else if (idx == 2) return texel.b;\n else return texel.r;\n}\nvoid main()\n{\n vec3 N = v_Normal;\n if (doubleSided) {\n vec3 eyePos = viewInverse[3].xyz;\n vec3 V = eyePos - v_WorldPosition;\n if (dot(N, V) < 0.0) {\n N = -N;\n }\n }\n if (alphaCutoff > 0.0) {\n float a = texture2D(diffuseMap, v_Texcoord).a * alpha;\n if (a < alphaCutoff) {\n discard;\n }\n }\n if (dot(v_Tangent, v_Tangent) > 0.0) {\n vec3 normalTexel = texture2D(normalMap, v_Texcoord).xyz;\n if (dot(normalTexel, normalTexel) > 0.0) { N = normalTexel * 2.0 - 1.0;\n mat3 tbn = mat3(v_Tangent, v_Bitangent, v_Normal);\n N = normalize(tbn * N);\n }\n }\n gl_FragColor.rgb = (N + 1.0) * 0.5;\n float g = glossiness;\n if (useRoughGlossMap) {\n float g2 = indexingTexel(texture2D(roughGlossMap, v_Texcoord), roughGlossChannel);\n if (useRoughness) {\n g2 = 1.0 - g2;\n }\n g = clamp(g2 + (g - 0.5) * 2.0, 0.0, 1.0);\n }\n gl_FragColor.a = g + 0.005;\n}\n@end\n@export clay.deferred.gbuffer2.fragment\nuniform sampler2D diffuseMap;\nuniform sampler2D metalnessMap;\nuniform vec3 color;\nuniform float metalness;\nuniform bool useMetalnessMap;\nuniform bool linear;\nuniform float alphaCutoff: 0.0;\nuniform float alpha: 1.0;\nvarying vec2 v_Texcoord;\n@import clay.util.srgb\nvoid main()\n{\n float m = metalness;\n if (useMetalnessMap) {\n vec4 metalnessTexel = texture2D(metalnessMap, v_Texcoord);\n m = clamp(metalnessTexel.r + (m * 2.0 - 1.0), 0.0, 1.0);\n }\n vec4 texel = texture2D(diffuseMap, v_Texcoord);\n if (linear) {\n texel = sRGBToLinear(texel);\n }\n if (alphaCutoff > 0.0) {\n float a = texel.a * alpha;\n if (a < alphaCutoff) {\n discard;\n }\n }\n gl_FragColor.rgb = texel.rgb * color;\n gl_FragColor.a = m + 0.005;\n}\n@end\n@export clay.deferred.gbuffer3.fragment\nuniform bool firstRender;\nvarying vec4 v_ViewPosition;\nvarying vec4 v_PrevViewPosition;\nvoid main()\n{\n vec2 a = v_ViewPosition.xy / v_ViewPosition.w;\n vec2 b = v_PrevViewPosition.xy / v_PrevViewPosition.w;\n if (firstRender) {\n gl_FragColor = vec4(0.0);\n }\n else {\n gl_FragColor = vec4((a - b) * 0.5 + 0.5, 0.0, 1.0);\n }\n}\n@end\n@export clay.deferred.gbuffer.debug\n@import clay.deferred.chunk.light_head\nuniform sampler2D gBufferTexture4;\nuniform int debug: 0;\nvoid main ()\n{\n @import clay.deferred.chunk.gbuffer_read\n if (debug == 0) {\n gl_FragColor = vec4(N, 1.0);\n }\n else if (debug == 1) {\n gl_FragColor = vec4(vec3(z), 1.0);\n }\n else if (debug == 2) {\n gl_FragColor = vec4(position, 1.0);\n }\n else if (debug == 3) {\n gl_FragColor = vec4(vec3(glossiness), 1.0);\n }\n else if (debug == 4) {\n gl_FragColor = vec4(vec3(metalness), 1.0);\n }\n else if (debug == 5) {\n gl_FragColor = vec4(albedo, 1.0);\n }\n else {\n vec4 color = texture2D(gBufferTexture4, uv);\n color.rg -= 0.5;\n color.rg *= 2.0;\n gl_FragColor = color;\n }\n}\n@end"),en.import("@export clay.deferred.chunk.light_head\nuniform sampler2D gBufferTexture1;\nuniform sampler2D gBufferTexture2;\nuniform sampler2D gBufferTexture3;\nuniform vec2 windowSize: WINDOW_SIZE;\nuniform vec4 viewport: VIEWPORT;\nuniform mat4 viewProjectionInv;\n#ifdef DEPTH_ENCODED\n@import clay.util.decode_float\n#endif\n@end\n@export clay.deferred.chunk.gbuffer_read\n vec2 uv = gl_FragCoord.xy / windowSize;\n vec2 uv2 = (gl_FragCoord.xy - viewport.xy) / viewport.zw;\n vec4 texel1 = texture2D(gBufferTexture1, uv);\n vec4 texel3 = texture2D(gBufferTexture3, uv);\n if (dot(texel1.rgb, vec3(1.0)) == 0.0) {\n discard;\n }\n float glossiness = texel1.a;\n float metalness = texel3.a;\n vec3 N = texel1.rgb * 2.0 - 1.0;\n float z = texture2D(gBufferTexture2, uv).r * 2.0 - 1.0;\n vec2 xy = uv2 * 2.0 - 1.0;\n vec4 projectedPos = vec4(xy, z, 1.0);\n vec4 p4 = viewProjectionInv * projectedPos;\n vec3 position = p4.xyz / p4.w;\n vec3 albedo = texel3.rgb;\n vec3 diffuseColor = albedo * (1.0 - metalness);\n vec3 specularColor = mix(vec3(0.04), albedo, metalness);\n@end\n@export clay.deferred.chunk.light_equation\nfloat D_Phong(in float g, in float ndh) {\n float a = pow(8192.0, g);\n return (a + 2.0) / 8.0 * pow(ndh, a);\n}\nfloat D_GGX(in float g, in float ndh) {\n float r = 1.0 - g;\n float a = r * r;\n float tmp = ndh * ndh * (a - 1.0) + 1.0;\n return a / (3.1415926 * tmp * tmp);\n}\nvec3 F_Schlick(in float ndv, vec3 spec) {\n return spec + (1.0 - spec) * pow(1.0 - ndv, 5.0);\n}\nvec3 lightEquation(\n in vec3 lightColor, in vec3 diffuseColor, in vec3 specularColor,\n in float ndl, in float ndh, in float ndv, in float g\n)\n{\n return ndl * lightColor\n * (diffuseColor + D_Phong(g, ndh) * F_Schlick(ndv, specularColor));\n}\n@end");var mi=ct.extend(function(){var t={minFilter:mr.NEAREST,magFilter:mr.NEAREST,wrapS:mr.CLAMP_TO_EDGE,wrapT:mr.CLAMP_TO_EDGE};return{enableTargetTexture1:!0,enableTargetTexture2:!0,enableTargetTexture3:!0,enableTargetTexture4:!1,renderTransparent:!1,_gBufferRenderList:[],_gBufferTex1:new br(Object.assign({type:mr.HALF_FLOAT},t)),_gBufferTex2:new br(Object.assign({format:mr.DEPTH_STENCIL,type:mr.UNSIGNED_INT_24_8_WEBGL},t)),_gBufferTex3:new br(t),_gBufferTex4:new br(Object.assign({type:mr.HALF_FLOAT},t)),_defaultNormalMap:new br({image:pi("#000")}),_defaultRoughnessMap:new br({image:pi("#fff")}),_defaultMetalnessMap:new br({image:pi("#fff")}),_defaultDiffuseMap:new br({image:pi("#fff")}),_frameBuffer:new Or,_gBufferMaterial1:new Sn({shader:new en(en.source("clay.deferred.gbuffer.vertex"),en.source("clay.deferred.gbuffer1.fragment")),vertexDefines:{FIRST_PASS:null},fragmentDefines:{FIRST_PASS:null}}),_gBufferMaterial2:new Sn({shader:new en(en.source("clay.deferred.gbuffer.vertex"),en.source("clay.deferred.gbuffer2.fragment")),vertexDefines:{SECOND_PASS:null},fragmentDefines:{SECOND_PASS:null}}),_gBufferMaterial3:new Sn({shader:new en(en.source("clay.deferred.gbuffer.vertex"),en.source("clay.deferred.gbuffer3.fragment")),vertexDefines:{THIRD_PASS:null},fragmentDefines:{THIRD_PASS:null}}),_debugPass:new Dn({fragment:en.source("clay.deferred.gbuffer.debug")})}},{resize:function(t,e){this._gBufferTex1.width===t&&this._gBufferTex1.height===e||(this._gBufferTex1.width=t,this._gBufferTex1.height=e,this._gBufferTex2.width=t,this._gBufferTex2.height=e,this._gBufferTex3.width=t,this._gBufferTex3.height=e,this._gBufferTex4.width=t,this._gBufferTex4.height=e)},setViewport:function(t,e,r,n,i){var o;o="object"==typeof t?t:{x:t,y:e,width:r,height:n,devicePixelRatio:i||1},this._frameBuffer.viewport=o},getViewport:function(){return this._frameBuffer.viewport?this._frameBuffer.viewport:{x:0,y:0,width:this._gBufferTex1.width,height:this._gBufferTex1.height,devicePixelRatio:1}},update:function(t,e,r,n){n=n||{};for(var i=t.gl,o=this._frameBuffer,a=o.viewport,s=e.updateRenderList(r,!0),h=s.opaque,u=s.transparent,l=0,c=this._gBufferRenderList,f=0;f<h.length;f++)h[f].ignoreGBuffer||(c[l++]=h[f]);if(this.renderTransparent)for(f=0;f<u.length;f++)u[f].ignoreGBuffer||(c[l++]=u[f]);c.length=l,i.clearColor(0,0,0,0),i.depthMask(!0),i.colorMask(!0,!0,!0,!0),i.disable(i.BLEND);var d,p,m=this.enableTargetTexture1,g=this.enableTargetTexture2,_=this.enableTargetTexture3,y=this.enableTargetTexture4;function v(){if(a){var t=a.devicePixelRatio;i.enable(i.SCISSOR_TEST),i.scissor(a.x*t,a.y*t,a.width*t,a.height*t)}i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),a&&i.disable(i.SCISSOR_TEST)}function x(t,e){return t.material!==e.material}if(m||_||y||(console.warn("Can't disable targetTexture1, targetTexture3, targetTexture4 both"),m=!0),g&&o.attach(n.targetTexture2||this._gBufferTex2,t.gl.DEPTH_STENCIL_ATTACHMENT),t.bindSceneRendering(e),m){o.attach(n.targetTexture1||this._gBufferTex1),o.bind(t),v();var b=this._gBufferMaterial1,w={getMaterial:function(){return b},getUniform:(d=this._defaultNormalMap,this._defaultRoughnessMap,p=this._defaultDiffuseMap,function(t,e,r){var n=t.material;if("doubleSided"===r)return n.isDefined("fragment","DOUBLE_SIDED");if("uvRepeat"===r||"uvOffset"===r||"alpha"===r)return n.get(r);if("normalMap"===r)return n.get(r)||d;if("diffuseMap"===r)return n.get(r)||p;if("alphaCutoff"===r)return n.isDefined("fragment","ALPHA_TEST")&&n.get("alphaCutoff")||0;var i=n.isDefined("fragment","USE_ROUGHNESS"),o=i?n.get("roughnessMap"):n.get("glossinessMap");switch(r){case"glossiness":return i?1-n.get("roughness"):n.get("glossiness");case"roughGlossMap":return o;case"useRoughGlossMap":return!!o;case"useRoughness":return i;case"roughGlossChannel":return i?n.getDefine("fragment","ROUGHNESS_CHANNEL"):n.getDefine("fragment","GLOSSINESS_CHANNEL")}}),isMaterialChanged:x,sortCompare:t.opaqueSortCompare};t.renderPass(c,r,w)}if(_){o.attach(n.targetTexture3||this._gBufferTex3),o.bind(t),v();var T=this._gBufferMaterial2;w={getMaterial:function(){return T},getUniform:function(t,e){return function(r,n,i){var o=r.material;switch(i){case"color":case"uvRepeat":case"uvOffset":case"alpha":return o.get(i);case"metalness":return o.get("metalness")||0;case"diffuseMap":return o.get(i)||t;case"metalnessMap":return o.get(i)||e;case"useMetalnessMap":return!!o.get("metalnessMap");case"linear":return o.isDefined("SRGB_DECODE");case"alphaCutoff":return o.isDefined("fragment","ALPHA_TEST")&&o.get("alphaCutoff")||0}}}(this._defaultDiffuseMap,this._defaultMetalnessMap),isMaterialChanged:x,sortCompare:t.opaqueSortCompare};t.renderPass(c,r,w)}if(y){o.bind(t),o.attach(n.targetTexture4||this._gBufferTex4),v(),r.update();var E=this._gBufferMaterial3,C=K.create();K.multiply(C,r.projectionMatrix.array,r.viewMatrix.array);w={getMaterial:function(){return E},afterRender:function(t,e){var r=e.isSkinnedMesh();if(r){var n=e.skeleton,i=e.joints;if(i.length>t.getMaxJointNumber()){var o=n.getSubSkinMatricesTexture(e.__uid__,i),a=e.__prevSkinMatricesTexture;if(a||(a=e.__prevSkinMatricesTexture=new br({type:mr.FLOAT,minFilter:mr.NEAREST,magFilter:mr.NEAREST,useMipmap:!1,flipY:!1})),a.pixels&&a.pixels.length===o.pixels.length)for(var s=0;s<o.pixels.length;s++)a.pixels[s]=o.pixels[s];else a.pixels=new Float32Array(o.pixels);a.width=o.width,a.height=o.height}else{var h=n.getSubSkinMatrices(e.__uid__,i);e.__prevSkinMatricesArray&&e.__prevSkinMatricesArray.length===h.length||(e.__prevSkinMatricesArray=new Float32Array(h.length)),e.__prevSkinMatricesArray.set(h)}}e.__prevWorldViewProjection=e.__prevWorldViewProjection||K.create(),r?K.copy(e.__prevWorldViewProjection,C):K.multiply(e.__prevWorldViewProjection,C,e.worldTransform.array)},getUniform:function(t,e,r){return"prevWorldViewProjection"===r?t.__prevWorldViewProjection:"prevSkinMatrix"===r?t.__prevSkinMatricesArray:"prevSkinMatricesTexture"===r?t.__prevSkinMatricesTexture:"firstRender"===r?!t.__prevWorldViewProjection:e.get(r)},isMaterialChanged:function(){return!0},sortCompare:t.opaqueSortCompare};t.renderPass(c,r,w)}t.bindSceneRendering(null),o.unbind(t)},renderDebug:function(t,e,r,n){var i={normal:0,depth:1,position:2,glossiness:3,metalness:4,albedo:5,velocity:6};null==i[r]&&(console.warn('Unkown type "'+r+'"'),r="normal"),t.saveClear(),t.saveViewport(),t.clearBit=t.gl.DEPTH_BUFFER_BIT,n&&t.setViewport(n);var o=new Ge;Ge.multiply(o,e.worldTransform,e.invProjectionMatrix);var a=this._debugPass;a.setUniform("viewportSize",[t.getWidth(),t.getHeight()]),a.setUniform("gBufferTexture1",this._gBufferTex1),a.setUniform("gBufferTexture2",this._gBufferTex2),a.setUniform("gBufferTexture3",this._gBufferTex3),a.setUniform("gBufferTexture4",this._gBufferTex4),a.setUniform("debug",i[r]),a.setUniform("viewProjectionInv",o.array),a.render(t),t.restoreViewport(),t.restoreClear()},getTargetTexture1:function(){return this._gBufferTex1},getTargetTexture2:function(){return this._gBufferTex2},getTargetTexture3:function(){return this._gBufferTex3},getTargetTexture4:function(){return this._gBufferTex4},dispose:function(t){this._gBufferTex1.dispose(t),this._gBufferTex2.dispose(t),this._gBufferTex3.dispose(t),this._defaultNormalMap.dispose(t),this._defaultRoughnessMap.dispose(t),this._defaultMetalnessMap.dispose(t),this._defaultDiffuseMap.dispose(t),this._frameBuffer.dispose(t)}}),gi=At.extend({dynamic:!1,widthSegments:40,heightSegments:20,phiStart:0,phiLength:2*Math.PI,thetaStart:0,thetaLength:Math.PI,radius:1},function(){this.build()},{build:function(){var t=this.heightSegments,e=this.widthSegments,r=this.attributes.position,n=this.attributes.texcoord0,i=this.attributes.normal,o=(e+1)*(t+1);r.init(o),n.init(o),i.init(o);var a,s,h,u,l,c,f,d,p,m,g,_=o>65535?Uint32Array:Uint16Array,y=this.indices=new _(e*t*6),v=this.radius,x=this.phiStart,b=this.phiLength,w=this.thetaStart,T=this.thetaLength,E=[],C=[],S=0,A=1/(v=this.radius);for(f=0;f<=t;f++)for(c=0;c<=e;c++)u=c/e,l=f/t,a=-v*Math.cos(x+u*b)*Math.sin(w+l*T),s=v*Math.cos(w+l*T),h=v*Math.sin(x+u*b)*Math.sin(w+l*T),E[0]=a,E[1]=s,E[2]=h,C[0]=u,C[1]=l,r.set(S,E),n.set(S,C),E[0]*=A,E[1]*=A,E[2]*=A,i.set(S,E),S++;var M=e+1,P=0;for(f=0;f<t;f++)for(c=0;c<e;c++)p=f*M+c,d=f*M+c+1,g=(f+1)*M+c+1,m=(f+1)*M+c,y[P++]=d,y[P++]=p,y[P++]=g,y[P++]=p,y[P++]=m,y[P++]=g;this.boundingBox=new et,this.boundingBox.max.set(v,v,v),this.boundingBox.min.set(-v,-v,-v)}}),_i=At.extend({dynamic:!1,topRadius:0,bottomRadius:1,height:2,capSegments:20,heightSegments:1},function(){this.build()},{build:function(){var t=[],e=[],r=[];t.length=0,e.length=0,r.length=0;for(var n=2*Math.PI/this.capSegments,i=[],o=[],a=this.topRadius,s=this.bottomRadius,h=this.height/2,u=D.fromValues(0,h,0),l=D.fromValues(0,-h,0),c=0;c<this.capSegments;c++){var f=c*n,d=a*Math.sin(f),p=a*Math.cos(f);i.push(D.fromValues(d,h,p)),d=s*Math.sin(f),p=s*Math.cos(f),o.push(D.fromValues(d,-h,p))}t.push(u),e.push($t.fromValues(0,1));var m=this.capSegments;for(c=0;c<m;c++)t.push(i[c]),e.push($t.fromValues(c/m,0)),r.push([0,c+1,(c+1)%m+1]);var g=t.length;t.push(l),e.push($t.fromValues(0,1));for(c=0;c<m;c++)t.push(o[c]),e.push($t.fromValues(c/m,0)),r.push([g,g+((c+1)%m+1),g+c+1]);g=t.length;var _=this.heightSegments;for(c=0;c<m;c++)for(var y=0;y<_+1;y++){var v=y/_;t.push(D.lerp(D.create(),i[c],o[c],v)),e.push($t.fromValues(c/m,v))}for(c=0;c<m;c++)for(y=0;y<_;y++){var x=c*(_+1)+y,b=(c+1)%m*(_+1)+y,w=(c+1)%m*(_+1)+y+1,T=c*(_+1)+y+1;r.push([g+b,g+x,g+T]),r.push([g+T,g+w,g+b])}this.attributes.position.fromArray(t),this.attributes.texcoord0.fromArray(e),this.initIndicesFromArray(r),this.generateVertexNormals(),this.boundingBox=new et;var E=Math.max(this.topRadius,this.bottomRadius);this.boundingBox.min.set(-E,-this.height/2,-E),this.boundingBox.max.set(E,this.height/2,E)}}),yi=At.extend({dynamic:!1,radius:1,height:2,capSegments:50,heightSegments:1},function(){this.build()},{build:function(){var t=new _i({topRadius:this.radius,bottomRadius:this.radius,capSegments:this.capSegments,heightSegments:this.heightSegments,height:this.height});this.attributes.position.value=t.attributes.position.value,this.attributes.normal.value=t.attributes.normal.value,this.attributes.texcoord0.value=t.attributes.texcoord0.value,this.indices=t.indices,this.boundingBox=t.boundingBox}}),vi="@export clay.prez.vertex\nuniform mat4 WVP : WORLDVIEWPROJECTION;\nattribute vec3 pos : POSITION;\nattribute vec2 uv : TEXCOORD_0;\n@import clay.chunk.skinning_header\nvarying vec2 v_Texcoord;\nvoid main()\n{\n vec3 P = pos;\n#ifdef SKINNING\n @import clay.chunk.skin_matrix\n P = (skinMatrixWS * vec4(pos, 1.0)).xyz;\n#endif\n gl_Position = WVP * vec4(P, 1.0);\n v_Texcoord = uv;\n}\n@end\n@export clay.prez.fragment\nuniform sampler2D alphaMap;\nuniform float alphaCutoff: 0.0;\nvarying vec2 v_Texcoord;\nvoid main()\n{\n if (alphaCutoff > 0.0) {\n if (texture2D(alphaMap, v_Texcoord).a <= alphaCutoff) {\n discard;\n }\n }\n gl_FragColor = vec4(0.0,0.0,0.0,1.0);\n}\n@end",xi="\n@export clay.util.rand\nhighp float rand(vec2 uv) {\n const highp float a = 12.9898, b = 78.233, c = 43758.5453;\n highp float dt = dot(uv.xy, vec2(a,b)), sn = mod(dt, 3.141592653589793);\n return fract(sin(sn) * c);\n}\n@end\n@export clay.util.calculate_attenuation\nuniform float attenuationFactor : 5.0;\nfloat lightAttenuation(float dist, float range)\n{\n float attenuation = 1.0;\n attenuation = dist*dist/(range*range+1.0);\n float att_s = attenuationFactor;\n attenuation = 1.0/(attenuation*att_s+1.0);\n att_s = 1.0/(att_s+1.0);\n attenuation = attenuation - att_s;\n attenuation /= 1.0 - att_s;\n return clamp(attenuation, 0.0, 1.0);\n}\n@end\n@export clay.util.edge_factor\n#ifdef SUPPORT_STANDARD_DERIVATIVES\nfloat edgeFactor(float width)\n{\n vec3 d = fwidth(v_Barycentric);\n vec3 a3 = smoothstep(vec3(0.0), d * width, v_Barycentric);\n return min(min(a3.x, a3.y), a3.z);\n}\n#else\nfloat edgeFactor(float width)\n{\n return 1.0;\n}\n#endif\n@end\n@export clay.util.encode_float\nvec4 encodeFloat(const in float depth)\n{\n const vec4 bitShifts = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);\n const vec4 bit_mask = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);\n vec4 res = fract(depth * bitShifts);\n res -= res.xxyz * bit_mask;\n return res;\n}\n@end\n@export clay.util.decode_float\nfloat decodeFloat(const in vec4 color)\n{\n const vec4 bitShifts = vec4(1.0/(256.0*256.0*256.0), 1.0/(256.0*256.0), 1.0/256.0, 1.0);\n return dot(color, bitShifts);\n}\n@end\n@export clay.util.float\n@import clay.util.encode_float\n@import clay.util.decode_float\n@end\n@export clay.util.rgbm_decode\nvec3 RGBMDecode(vec4 rgbm, float range) {\n return range * rgbm.rgb * rgbm.a;\n}\n@end\n@export clay.util.rgbm_encode\nvec4 RGBMEncode(vec3 color, float range) {\n if (dot(color, color) == 0.0) {\n return vec4(0.0);\n }\n vec4 rgbm;\n color /= range;\n rgbm.a = clamp(max(max(color.r, color.g), max(color.b, 1e-6)), 0.0, 1.0);\n rgbm.a = ceil(rgbm.a * 255.0) / 255.0;\n rgbm.rgb = color / rgbm.a;\n return rgbm;\n}\n@end\n@export clay.util.rgbm\n@import clay.util.rgbm_decode\n@import clay.util.rgbm_encode\nvec4 decodeHDR(vec4 color)\n{\n#if defined(RGBM_DECODE) || defined(RGBM)\n return vec4(RGBMDecode(color, 8.12), 1.0);\n#else\n return color;\n#endif\n}\nvec4 encodeHDR(vec4 color)\n{\n#if defined(RGBM_ENCODE) || defined(RGBM)\n return RGBMEncode(color.xyz, 8.12);\n#else\n return color;\n#endif\n}\n@end\n@export clay.util.srgb\nvec4 sRGBToLinear(in vec4 value) {\n return vec4(mix(pow(value.rgb * 0.9478672986 + vec3(0.0521327014), vec3(2.4)), value.rgb * 0.0773993808, vec3(lessThanEqual(value.rgb, vec3(0.04045)))), value.w);\n}\nvec4 linearTosRGB(in vec4 value) {\n return vec4(mix(pow(value.rgb, vec3(0.41666)) * 1.055 - vec3(0.055), value.rgb * 12.92, vec3(lessThanEqual(value.rgb, vec3(0.0031308)))), value.w);\n}\n@end\n@export clay.chunk.skinning_header\n#ifdef SKINNING\nattribute vec3 weight : WEIGHT;\nattribute vec4 joint : JOINT;\n#ifdef USE_SKIN_MATRICES_TEXTURE\nuniform sampler2D skinMatricesTexture : ignore;\nuniform float skinMatricesTextureSize: ignore;\nmat4 getSkinMatrix(sampler2D tex, float idx) {\n float j = idx * 4.0;\n float x = mod(j, skinMatricesTextureSize);\n float y = floor(j / skinMatricesTextureSize) + 0.5;\n vec2 scale = vec2(skinMatricesTextureSize);\n return mat4(\n texture2D(tex, vec2(x + 0.5, y) / scale),\n texture2D(tex, vec2(x + 1.5, y) / scale),\n texture2D(tex, vec2(x + 2.5, y) / scale),\n texture2D(tex, vec2(x + 3.5, y) / scale)\n );\n}\nmat4 getSkinMatrix(float idx) {\n return getSkinMatrix(skinMatricesTexture, idx);\n}\n#else\nuniform mat4 skinMatrix[JOINT_COUNT] : SKIN_MATRIX;\nmat4 getSkinMatrix(float idx) {\n return skinMatrix[int(idx)];\n}\n#endif\n#endif\n@end\n@export clay.chunk.skin_matrix\nmat4 skinMatrixWS = getSkinMatrix(joint.x) * weight.x;\nif (weight.y > 1e-4)\n{\n skinMatrixWS += getSkinMatrix(joint.y) * weight.y;\n}\nif (weight.z > 1e-4)\n{\n skinMatrixWS += getSkinMatrix(joint.z) * weight.z;\n}\nfloat weightW = 1.0-weight.x-weight.y-weight.z;\nif (weightW > 1e-4)\n{\n skinMatrixWS += getSkinMatrix(joint.w) * weightW;\n}\n@end\n@export clay.util.parallax_correct\nvec3 parallaxCorrect(in vec3 dir, in vec3 pos, in vec3 boxMin, in vec3 boxMax) {\n vec3 first = (boxMax - pos) / dir;\n vec3 second = (boxMin - pos) / dir;\n vec3 further = max(first, second);\n float dist = min(further.x, min(further.y, further.z));\n vec3 fixedPos = pos + dir * dist;\n vec3 boxCenter = (boxMax + boxMin) * 0.5;\n return normalize(fixedPos - boxCenter);\n}\n@end\n@export clay.util.clamp_sample\nvec4 clampSample(const in sampler2D texture, const in vec2 coord)\n{\n#ifdef STEREO\n float eye = step(0.5, coord.x) * 0.5;\n vec2 coordClamped = clamp(coord, vec2(eye, 0.0), vec2(0.5 + eye, 1.0));\n#else\n vec2 coordClamped = clamp(coord, vec2(0.0), vec2(1.0));\n#endif\n return texture2D(texture, coordClamped);\n}\n@end\n@export clay.util.ACES\nvec3 ACESToneMapping(vec3 color)\n{\n const float A = 2.51;\n const float B = 0.03;\n const float C = 2.43;\n const float D = 0.59;\n const float E = 0.14;\n return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\n@end";en.import(vi),en.import(xi),en.import("@export clay.deferred.light_volume.vertex\nuniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\nattribute vec3 position : POSITION;\nvarying vec3 v_Position;\nvoid main()\n{\n gl_Position = worldViewProjection * vec4(position, 1.0);\n v_Position = position;\n}\n@end"),en.import("@export clay.deferred.spot_light\n@import clay.deferred.chunk.light_head\n@import clay.deferred.chunk.light_equation\n@import clay.util.calculate_attenuation\nuniform vec3 lightPosition;\nuniform vec3 lightDirection;\nuniform vec3 lightColor;\nuniform float umbraAngleCosine;\nuniform float penumbraAngleCosine;\nuniform float lightRange;\nuniform float falloffFactor;\nuniform vec3 eyePosition;\n#ifdef SHADOWMAP_ENABLED\nuniform sampler2D lightShadowMap;\nuniform mat4 lightMatrix;\nuniform float lightShadowMapSize;\n#endif\n@import clay.plugin.shadow_map_common\nvoid main()\n{\n @import clay.deferred.chunk.gbuffer_read\n vec3 L = lightPosition - position;\n vec3 V = normalize(eyePosition - position);\n float dist = length(L);\n L /= dist;\n float attenuation = lightAttenuation(dist, lightRange);\n float c = dot(-normalize(lightDirection), L);\n float falloff = clamp((c - umbraAngleCosine) / (penumbraAngleCosine - umbraAngleCosine), 0.0, 1.0);\n falloff = pow(falloff, falloffFactor);\n vec3 H = normalize(L + V);\n float ndl = clamp(dot(N, L), 0.0, 1.0);\n float ndh = clamp(dot(N, H), 0.0, 1.0);\n float ndv = clamp(dot(N, V), 0.0, 1.0);\n gl_FragColor.rgb = (1.0 - falloff) * attenuation * lightEquation(\n lightColor, diffuseColor, specularColor, ndl, ndh, ndv, glossiness\n );\n#ifdef SHADOWMAP_ENABLED\n float shadowContrib = computeShadowContrib(\n lightShadowMap, lightMatrix, position, lightShadowMapSize\n );\n gl_FragColor.rgb *= shadowContrib;\n#endif\n gl_FragColor.a = 1.0;\n}\n@end\n"),en.import("@export clay.deferred.directional_light\n@import clay.deferred.chunk.light_head\n@import clay.deferred.chunk.light_equation\nuniform vec3 lightDirection;\nuniform vec3 lightColor;\nuniform vec3 eyePosition;\n#ifdef SHADOWMAP_ENABLED\nuniform sampler2D lightShadowMap;\nuniform float lightShadowMapSize;\nuniform mat4 lightMatrices[SHADOW_CASCADE];\nuniform float shadowCascadeClipsNear[SHADOW_CASCADE];\nuniform float shadowCascadeClipsFar[SHADOW_CASCADE];\n#endif\n@import clay.plugin.shadow_map_common\nvoid main()\n{\n @import clay.deferred.chunk.gbuffer_read\n vec3 L = -normalize(lightDirection);\n vec3 V = normalize(eyePosition - position);\n vec3 H = normalize(L + V);\n float ndl = clamp(dot(N, L), 0.0, 1.0);\n float ndh = clamp(dot(N, H), 0.0, 1.0);\n float ndv = clamp(dot(N, V), 0.0, 1.0);\n gl_FragColor.rgb = lightEquation(\n lightColor, diffuseColor, specularColor, ndl, ndh, ndv, glossiness\n );\n#ifdef SHADOWMAP_ENABLED\n float shadowContrib = 1.0;\n for (int _idx_ = 0; _idx_ < SHADOW_CASCADE; _idx_++) {{\n if (\n z >= shadowCascadeClipsNear[_idx_] &&\n z <= shadowCascadeClipsFar[_idx_]\n ) {\n shadowContrib = computeShadowContrib(\n lightShadowMap, lightMatrices[_idx_], position, lightShadowMapSize,\n vec2(1.0 / float(SHADOW_CASCADE), 1.0),\n vec2(float(_idx_) / float(SHADOW_CASCADE), 0.0)\n );\n }\n }}\n gl_FragColor.rgb *= shadowContrib;\n#endif\n gl_FragColor.a = 1.0;\n}\n@end\n"),en.import("@export clay.deferred.ambient_light\nuniform sampler2D gBufferTexture1;\nuniform sampler2D gBufferTexture3;\nuniform vec3 lightColor;\nuniform vec2 windowSize: WINDOW_SIZE;\nvoid main()\n{\n vec2 uv = gl_FragCoord.xy / windowSize;\n vec4 texel1 = texture2D(gBufferTexture1, uv);\n if (dot(texel1.rgb, vec3(1.0)) == 0.0) {\n discard;\n }\n vec3 albedo = texture2D(gBufferTexture3, uv).rgb;\n gl_FragColor.rgb = lightColor * albedo;\n gl_FragColor.a = 1.0;\n}\n@end"),en.import("@export clay.deferred.ambient_sh_light\nuniform sampler2D gBufferTexture1;\nuniform sampler2D gBufferTexture3;\nuniform vec3 lightColor;\nuniform vec3 lightCoefficients[9];\nuniform vec2 windowSize: WINDOW_SIZE;\nvec3 calcAmbientSHLight(vec3 N) {\n return lightCoefficients[0]\n + lightCoefficients[1] * N.x\n + lightCoefficients[2] * N.y\n + lightCoefficients[3] * N.z\n + lightCoefficients[4] * N.x * N.z\n + lightCoefficients[5] * N.z * N.y\n + lightCoefficients[6] * N.y * N.x\n + lightCoefficients[7] * (3.0 * N.z * N.z - 1.0)\n + lightCoefficients[8] * (N.x * N.x - N.y * N.y);\n}\nvoid main()\n{\n vec2 uv = gl_FragCoord.xy / windowSize;\n vec4 texel1 = texture2D(gBufferTexture1, uv);\n if (dot(texel1.rgb, vec3(1.0)) == 0.0) {\n discard;\n }\n vec3 N = texel1.rgb * 2.0 - 1.0;\n vec3 albedo = texture2D(gBufferTexture3, uv).rgb;\n gl_FragColor.rgb = lightColor * albedo * calcAmbientSHLight(N);\n gl_FragColor.a = 1.0;\n}\n@end"),en.import("@export clay.deferred.ambient_cubemap_light\n@import clay.deferred.chunk.light_head\nuniform vec3 lightColor;\nuniform samplerCube lightCubemap;\nuniform sampler2D brdfLookup;\nuniform vec3 eyePosition;\n@import clay.util.rgbm\nvoid main()\n{\n @import clay.deferred.chunk.gbuffer_read\n vec3 V = normalize(eyePosition - position);\n vec3 L = reflect(-V, N);\n float ndv = clamp(dot(N, V), 0.0, 1.0);\n float rough = clamp(1.0 - glossiness, 0.0, 1.0);\n float bias = rough * 5.0;\n vec2 brdfParam = texture2D(brdfLookup, vec2(rough, ndv)).xy;\n vec3 envWeight = specularColor * brdfParam.x + brdfParam.y;\n vec3 envTexel = RGBMDecode(textureCubeLodEXT(lightCubemap, L, bias), 8.12);\n gl_FragColor.rgb = lightColor * envTexel * envWeight;\n gl_FragColor.a = 1.0;\n}\n@end"),en.import("@export clay.deferred.point_light\n@import clay.deferred.chunk.light_head\n@import clay.util.calculate_attenuation\n@import clay.deferred.chunk.light_equation\nuniform vec3 lightPosition;\nuniform vec3 lightColor;\nuniform float lightRange;\nuniform vec3 eyePosition;\n#ifdef SHADOWMAP_ENABLED\nuniform samplerCube lightShadowMap;\nuniform float lightShadowMapSize;\n#endif\nvarying vec3 v_Position;\n@import clay.plugin.shadow_map_common\nvoid main()\n{\n @import clay.deferred.chunk.gbuffer_read\n vec3 L = lightPosition - position;\n vec3 V = normalize(eyePosition - position);\n float dist = length(L);\n L /= dist;\n vec3 H = normalize(L + V);\n float ndl = clamp(dot(N, L), 0.0, 1.0);\n float ndh = clamp(dot(N, H), 0.0, 1.0);\n float ndv = clamp(dot(N, V), 0.0, 1.0);\n float attenuation = lightAttenuation(dist, lightRange);\n gl_FragColor.rgb = attenuation * lightEquation(\n lightColor, diffuseColor, specularColor, ndl, ndh, ndv, glossiness\n );\n#ifdef SHADOWMAP_ENABLED\n float shadowContrib = computeShadowContribOmni(\n lightShadowMap, -L * dist, lightRange\n );\n gl_FragColor.rgb *= clamp(shadowContrib, 0.0, 1.0);\n#endif\n gl_FragColor.a = 1.0;\n}\n@end"),en.import("@export clay.deferred.sphere_light\n@import clay.deferred.chunk.light_head\n@import clay.util.calculate_attenuation\n@import clay.deferred.chunk.light_equation\nuniform vec3 lightPosition;\nuniform vec3 lightColor;\nuniform float lightRange;\nuniform float lightRadius;\nuniform vec3 eyePosition;\nvarying vec3 v_Position;\nvoid main()\n{\n @import clay.deferred.chunk.gbuffer_read\n vec3 L = lightPosition - position;\n vec3 V = normalize(eyePosition - position);\n float dist = length(L);\n vec3 R = reflect(V, N);\n float tmp = dot(L, R);\n vec3 cToR = tmp * R - L;\n float d = length(cToR);\n L = L + cToR * clamp(lightRadius / d, 0.0, 1.0);\n L = normalize(L);\n vec3 H = normalize(L + V);\n float ndl = clamp(dot(N, L), 0.0, 1.0);\n float ndh = clamp(dot(N, H), 0.0, 1.0);\n float ndv = clamp(dot(N, V), 0.0, 1.0);\n float attenuation = lightAttenuation(dist, lightRange);\n gl_FragColor.rgb = lightColor * ndl * attenuation;\n glossiness = clamp(glossiness - lightRadius / 2.0 / dist, 0.0, 1.0);\n gl_FragColor.rgb = attenuation * lightEquation(\n lightColor, diffuseColor, specularColor, ndl, ndh, ndv, glossiness\n );\n gl_FragColor.a = 1.0;\n}\n@end"),en.import("@export clay.deferred.tube_light\n@import clay.deferred.chunk.light_head\n@import clay.util.calculate_attenuation\n@import clay.deferred.chunk.light_equation\nuniform vec3 lightPosition;\nuniform vec3 lightColor;\nuniform float lightRange;\nuniform vec3 lightExtend;\nuniform vec3 eyePosition;\nvarying vec3 v_Position;\nvoid main()\n{\n @import clay.deferred.chunk.gbuffer_read\n vec3 L = lightPosition - position;\n vec3 V = normalize(eyePosition - position);\n vec3 R = reflect(V, N);\n vec3 L0 = lightPosition - lightExtend - position;\n vec3 L1 = lightPosition + lightExtend - position;\n vec3 LD = L1 - L0;\n float len0 = length(L0);\n float len1 = length(L1);\n float irra = 2.0 * clamp(dot(N, L0) / (2.0 * len0) + dot(N, L1) / (2.0 * len1), 0.0, 1.0);\n float LDDotR = dot(R, LD);\n float t = (LDDotR * dot(R, L0) - dot(L0, LD)) / (dot(LD, LD) - LDDotR * LDDotR);\n t = clamp(t, 0.0, 1.0);\n L = L0 + t * LD;\n float dist = length(L);\n L /= dist;\n vec3 H = normalize(L + V);\n float ndh = clamp(dot(N, H), 0.0, 1.0);\n float ndv = clamp(dot(N, V), 0.0, 1.0);\n glossiness = clamp(glossiness - 0.0 / 2.0 / dist, 0.0, 1.0);\n gl_FragColor.rgb = lightColor * irra * lightAttenuation(dist, lightRange)\n * (diffuseColor + D_Phong(glossiness, ndh) * F_Schlick(ndv, specularColor));\n gl_FragColor.a = 1.0;\n}\n@end"),en.import(vi);var bi,wi=ct.extend(function(){var t=en.source("clay.compositor.vertex"),e=en.source("clay.deferred.light_volume.vertex"),r=new en(t,en.source("clay.deferred.directional_light")),n=function(t){t.blendEquation(t.FUNC_ADD),t.blendFuncSeparate(t.ONE,t.ONE,t.ONE,t.ONE)},i=function(t){return new Sn({shader:t,blend:n,transparent:!0,depthMask:!1})},o=function(t){return new en(e,en.source("clay.deferred."+t))},a=new _i({capSegments:10}),s=new Ge;s.rotateX(Math.PI/2).translate(new j(0,-1,0)),a.applyTransform(s);var h=new yi({capSegments:10});return s.identity().rotateZ(Math.PI/2),h.applyTransform(s),{shadowMapPass:null,autoResize:!0,_createLightPassMat:i,_gBuffer:new mi,_lightAccumFrameBuffer:new Or,_lightAccumTex:new br({type:mr.HALF_FLOAT,minFilter:mr.NEAREST,magFilter:mr.NEAREST}),_fullQuadPass:new Dn({blendWithPrevious:!0}),_directionalLightMat:i(r),_ambientMat:i(new en(t,en.source("clay.deferred.ambient_light"))),_ambientSHMat:i(new en(t,en.source("clay.deferred.ambient_sh_light"))),_ambientCubemapMat:i(new en(t,en.source("clay.deferred.ambient_cubemap_light"))),_spotLightShader:o("spot_light"),_pointLightShader:o("point_light"),_sphereLightShader:o("sphere_light"),_tubeLightShader:o("tube_light"),_lightSphereGeo:new gi({widthSegments:10,heightSegements:10}),_lightConeGeo:a,_lightCylinderGeo:h,_outputPass:new Dn({fragment:en.source("clay.compositor.output")})}},{render:function(t,e,r,n){(n=n||{}).renderToTarget=n.renderToTarget||!1,n.notUpdateShadow=n.notUpdateShadow||!1,n.notUpdateScene=n.notUpdateScene||!1,n.notUpdateScene||e.update(!1,!0),e.updateLights(),r.update(!0);var i=t.getDevicePixelRatio();!this.autoResize||t.getWidth()*i===this._lightAccumTex.width&&t.getHeight()*i===this._lightAccumTex.height||this.resize(t.getWidth()*i,t.getHeight()*i),this._gBuffer.update(t,e,r),this._accumulateLightBuffer(t,e,r,!n.notUpdateShadow),n.renderToTarget||(this._outputPass.setUniform("texture",this._lightAccumTex),this._outputPass.render(t))},getTargetTexture:function(){return this._lightAccumTex},getTargetFrameBuffer:function(){return this._lightAccumFrameBuffer},getGBuffer:function(){return this._gBuffer},setViewport:function(t,e,r,n,i){this._gBuffer.setViewport(t,e,r,n,i),this._lightAccumFrameBuffer.viewport=this._gBuffer.getViewport()},resize:function(t,e){this._lightAccumTex.width=t,this._lightAccumTex.height=e,this._gBuffer.resize(t,e)},_accumulateLightBuffer:function(t,e,r,n){for(var i=t.gl,o=this._lightAccumTex,a=this._lightAccumFrameBuffer,s=r.getWorldPosition().array,h=0;h<e.lights.length;h++)e.lights[h].invisible||this._updateLightProxy(e.lights[h]);var u=this.shadowMapPass;u&&n&&(i.clearColor(1,1,1,1),this._prepareLightShadow(t,e,r)),this.trigger("beforelightaccumulate",t,e,r,n),a.attach(o),a.bind(t);var l=t.clearColor,c=a.viewport;if(c){var f=c.devicePixelRatio;i.enable(i.SCISSOR_TEST),i.scissor(c.x*f,c.y*f,c.width*f,c.height*f)}i.clearColor(l[0],l[1],l[2],l[3]),i.clear(i.COLOR_BUFFER_BIT),i.enable(i.BLEND),c&&i.disable(i.SCISSOR_TEST),this.trigger("startlightaccumulate",t,e,r);var d=new Ge;Ge.multiply(d,r.worldTransform,r.invProjectionMatrix);var p=[];for(h=0;h<e.lights.length;h++){var m=e.lights[h];if(!m.invisible){var g=m.uniformTemplates,_=m.volumeMesh||m.__volumeMesh;if(_){var y=_.material;_.castShadow=!1;var v=!1;switch(m.type){case"POINT_LIGHT":y.setUniform("lightColor",g.pointLightColor.value(m)),y.setUniform("lightRange",g.pointLightRange.value(m)),y.setUniform("lightPosition",g.pointLightPosition.value(m));break;case"SPOT_LIGHT":y.setUniform("lightPosition",g.spotLightPosition.value(m)),y.setUniform("lightColor",g.spotLightColor.value(m)),y.setUniform("lightRange",g.spotLightRange.value(m)),y.setUniform("lightDirection",g.spotLightDirection.value(m)),y.setUniform("umbraAngleCosine",g.spotLightUmbraAngleCosine.value(m)),y.setUniform("penumbraAngleCosine",g.spotLightPenumbraAngleCosine.value(m)),y.setUniform("falloffFactor",g.spotLightFalloffFactor.value(m));break;case"SPHERE_LIGHT":y.setUniform("lightColor",g.sphereLightColor.value(m)),y.setUniform("lightRange",g.sphereLightRange.value(m)),y.setUniform("lightRadius",g.sphereLightRadius.value(m)),y.setUniform("lightPosition",g.sphereLightPosition.value(m));break;case"TUBE_LIGHT":y.setUniform("lightColor",g.tubeLightColor.value(m)),y.setUniform("lightRange",g.tubeLightRange.value(m)),y.setUniform("lightExtend",g.tubeLightExtend.value(m)),y.setUniform("lightPosition",g.tubeLightPosition.value(m));break;default:v=!0}if(v)continue;y.setUniform("eyePosition",s),y.setUniform("viewProjectionInv",d.array),y.setUniform("gBufferTexture1",this._gBuffer.getTargetTexture1()),y.setUniform("gBufferTexture2",this._gBuffer.getTargetTexture2()),y.setUniform("gBufferTexture3",this._gBuffer.getTargetTexture3()),p.push(_)}else{var x=this._fullQuadPass;v=!1;switch(m.type){case"AMBIENT_LIGHT":x.material=this._ambientMat,x.material.setUniform("lightColor",g.ambientLightColor.value(m));break;case"AMBIENT_SH_LIGHT":x.material=this._ambientSHMat,x.material.setUniform("lightColor",g.ambientSHLightColor.value(m)),x.material.setUniform("lightCoefficients",g.ambientSHLightCoefficients.value(m));break;case"AMBIENT_CUBEMAP_LIGHT":x.material=this._ambientCubemapMat,x.material.setUniform("lightColor",g.ambientCubemapLightColor.value(m)),x.material.setUniform("lightCubemap",g.ambientCubemapLightCubemap.value(m)),x.material.setUniform("brdfLookup",g.ambientCubemapLightBRDFLookup.value(m));break;case"DIRECTIONAL_LIGHT":var b=u&&m.castShadow;x.material=this._directionalLightMat,x.material[b?"define":"undefine"]("fragment","SHADOWMAP_ENABLED"),b&&x.material.define("fragment","SHADOW_CASCADE",m.shadowCascade),x.material.setUniform("lightColor",g.directionalLightColor.value(m)),x.material.setUniform("lightDirection",g.directionalLightDirection.value(m));break;default:v=!0}if(v)continue;var w=x.material;w.setUniform("eyePosition",s),w.setUniform("viewProjectionInv",d.array),w.setUniform("gBufferTexture1",this._gBuffer.getTargetTexture1()),w.setUniform("gBufferTexture2",this._gBuffer.getTargetTexture2()),w.setUniform("gBufferTexture3",this._gBuffer.getTargetTexture3()),u&&m.castShadow&&(w.setUniform("lightShadowMap",m.__shadowMap),w.setUniform("lightMatrices",m.__lightMatrices),w.setUniform("shadowCascadeClipsNear",m.__cascadeClipsNear),w.setUniform("shadowCascadeClipsFar",m.__cascadeClipsFar),w.setUniform("lightShadowMapSize",m.shadowResolution)),x.renderQuad(t)}}}this._renderVolumeMeshList(t,e,r,p),this.trigger("lightaccumulate",t,e,r),a.unbind(t),this.trigger("afterlightaccumulate",t,e,r)},_prepareLightShadow:(bi=new Ge,function(t,e,r){for(var n=0;n<e.lights.length;n++){var i=e.lights[n],o=i.volumeMesh||i.__volumeMesh;if(i.castShadow&&!i.invisible)switch(i.type){case"POINT_LIGHT":case"SPOT_LIGHT":if(Ge.multiply(bi,r.viewMatrix,o.worldTransform),e.isFrustumCulled(o,r,bi.array))continue;this._prepareSingleLightShadow(t,e,r,i,o.material);break;case"DIRECTIONAL_LIGHT":this._prepareSingleLightShadow(t,e,r,i,null)}}}),_prepareSingleLightShadow:function(t,e,r,n,i){switch(n.type){case"POINT_LIGHT":var o=[];this.shadowMapPass.renderPointLightShadow(t,e,n,o),i.setUniform("lightShadowMap",o[0]),i.setUniform("lightShadowMapSize",n.shadowResolution);break;case"SPOT_LIGHT":o=[];var a=[];this.shadowMapPass.renderSpotLightShadow(t,e,n,a,o),i.setUniform("lightShadowMap",o[0]),i.setUniform("lightMatrix",a[0]),i.setUniform("lightShadowMapSize",n.shadowResolution);break;case"DIRECTIONAL_LIGHT":o=[],a=[];var s=[];this.shadowMapPass.renderDirectionalLightShadow(t,e,r,n,s,a,o);var h=s.slice(),u=s.slice();h.pop(),u.shift(),h.reverse(),u.reverse(),a.reverse(),n.__cascadeClipsNear=h,n.__cascadeClipsFar=u,n.__shadowMap=o[0],n.__lightMatrices=a}},_updateLightProxy:function(t){var e;if(t.volumeMesh)e=t.volumeMesh;else switch(t.type){case"POINT_LIGHT":case"SPHERE_LIGHT":var r="SPHERE_LIGHT"===t.type?this._sphereLightShader:this._pointLightShader;t.__volumeMesh||(t.__volumeMesh=new Rn({material:this._createLightPassMat(r),geometry:this._lightSphereGeo,culling:!1})),e=t.__volumeMesh;var n=t.range+(t.radius||0);e.scale.set(n,n,n);break;case"SPOT_LIGHT":t.__volumeMesh=t.__volumeMesh||new Rn({material:this._createLightPassMat(this._spotLightShader),geometry:this._lightConeGeo,culling:!1}),e=t.__volumeMesh;var i=Math.tan(t.penumbraAngle*Math.PI/180),o=t.range;e.scale.set(i*o,i*o,o/2);break;case"TUBE_LIGHT":t.__volumeMesh=t.__volumeMesh||new Rn({material:this._createLightPassMat(this._tubeLightShader),geometry:this._lightCylinderGeo,culling:!1}),e=t.__volumeMesh;o=t.range;e.scale.set(t.length/2+o,o,o)}if(e){e.update(),Ge.multiply(e.worldTransform,t.worldTransform,e.worldTransform);var a=this.shadowMapPass&&t.castShadow;e.material[a?"define":"undefine"]("fragment","SHADOWMAP_ENABLED")}},_renderVolumeMeshList:function(){var t=new Ge,e=new Sn({shader:new en(en.source("clay.prez.vertex"),en.source("clay.prez.fragment"))});function r(){return e}return function(e,n,i,o){var a=e.gl;a.depthFunc(a.LEQUAL);for(var s=0;s<o.length;s++){var h=o[s];Ge.multiply(t,i.viewMatrix,h.worldTransform),n.isFrustumCulled(h,i,t.array)||(a.colorMask(!1,!1,!1,!1),a.depthMask(!0),a.clear(a.DEPTH_BUFFER_BIT),e.renderPass([h],i,{getMaterial:r}),a.colorMask(!0,!0,!0,!0),h.material.depthMask=!0,e.renderPass([h],i))}a.depthFunc(a.LESS)}}(),dispose:function(t){this._gBuffer.dispose(t),this._lightAccumFrameBuffer.dispose(t),this._lightAccumTex.dispose(t),this._lightConeGeo.dispose(t),this._lightCylinderGeo.dispose(t),this._lightSphereGeo.dispose(t),this._fullQuadPass.dispose(t),this._outputPass.dispose(t),this._directionalLightMat.dispose(t),this.shadowMapPass.dispose(t)}}),Ti={create:function(){var t=new L(4);return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t},clone:function(t){var e=new L(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},identity:function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t},transpose:function(t,e){if(t===e){var r=e[1];t[1]=e[2],t[2]=r}else t[0]=e[0],t[1]=e[2],t[2]=e[1],t[3]=e[3];return t},invert:function(t,e){var r=e[0],n=e[1],i=e[2],o=e[3],a=r*o-i*n;return a?(a=1/a,t[0]=o*a,t[1]=-n*a,t[2]=-i*a,t[3]=r*a,t):null},adjoint:function(t,e){var r=e[0];return t[0]=e[3],t[1]=-e[1],t[2]=-e[2],t[3]=r,t},determinant:function(t){return t[0]*t[3]-t[2]*t[1]},multiply:function(t,e,r){var n=e[0],i=e[1],o=e[2],a=e[3],s=r[0],h=r[1],u=r[2],l=r[3];return t[0]=n*s+o*h,t[1]=i*s+a*h,t[2]=n*u+o*l,t[3]=i*u+a*l,t}};Ti.mul=Ti.multiply,Ti.rotate=function(t,e,r){var n=e[0],i=e[1],o=e[2],a=e[3],s=Math.sin(r),h=Math.cos(r);return t[0]=n*h+o*s,t[1]=i*h+a*s,t[2]=n*-s+o*h,t[3]=i*-s+a*h,t},Ti.scale=function(t,e,r){var n=e[0],i=e[1],o=e[2],a=e[3],s=r[0],h=r[1];return t[0]=n*s,t[1]=i*s,t[2]=o*h,t[3]=a*h,t},Ti.frob=function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2))},Ti.LDU=function(t,e,r,n){return t[2]=n[2]/n[0],r[0]=n[0],r[1]=n[1],r[3]=n[3]-t[2]*r[1],[t,e,r]};var Ei=Ti,Ci={create:function(){var t=new L(6);return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t},clone:function(t){var e=new L(6);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t},identity:function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t},invert:function(t,e){var r=e[0],n=e[1],i=e[2],o=e[3],a=e[4],s=e[5],h=r*o-n*i;return h?(h=1/h,t[0]=o*h,t[1]=-n*h,t[2]=-i*h,t[3]=r*h,t[4]=(i*s-o*a)*h,t[5]=(n*a-r*s)*h,t):null},determinant:function(t){return t[0]*t[3]-t[1]*t[2]},multiply:function(t,e,r){var n=e[0],i=e[1],o=e[2],a=e[3],s=e[4],h=e[5],u=r[0],l=r[1],c=r[2],f=r[3],d=r[4],p=r[5];return t[0]=n*u+o*l,t[1]=i*u+a*l,t[2]=n*c+o*f,t[3]=i*c+a*f,t[4]=n*d+o*p+s,t[5]=i*d+a*p+h,t}};Ci.mul=Ci.multiply,Ci.rotate=function(t,e,r){var n=e[0],i=e[1],o=e[2],a=e[3],s=e[4],h=e[5],u=Math.sin(r),l=Math.cos(r);return t[0]=n*l+o*u,t[1]=i*l+a*u,t[2]=n*-u+o*l,t[3]=i*-u+a*l,t[4]=s,t[5]=h,t},Ci.scale=function(t,e,r){var n=e[0],i=e[1],o=e[2],a=e[3],s=e[4],h=e[5],u=r[0],l=r[1];return t[0]=n*u,t[1]=i*u,t[2]=o*l,t[3]=a*l,t[4]=s,t[5]=h,t},Ci.translate=function(t,e,r){var n=e[0],i=e[1],o=e[2],a=e[3],s=e[4],h=e[5],u=r[0],l=r[1];return t[0]=n,t[1]=i,t[2]=o,t[3]=a,t[4]=n*u+o*l+s,t[5]=i*u+a*l+h,t},Ci.frob=function(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+1)};var Si=Ci,Ai=new Ge;function Mi(t,e,r){Ai.identity();var n=new Nr({widthSegments:e,heightSegments:r});switch(t){case"px":Ge.translate(Ai,Ai,j.POSITIVE_X),Ge.rotateY(Ai,Ai,Math.PI/2);break;case"nx":Ge.translate(Ai,Ai,j.NEGATIVE_X),Ge.rotateY(Ai,Ai,-Math.PI/2);break;case"py":Ge.translate(Ai,Ai,j.POSITIVE_Y),Ge.rotateX(Ai,Ai,-Math.PI/2);break;case"ny":Ge.translate(Ai,Ai,j.NEGATIVE_Y),Ge.rotateX(Ai,Ai,Math.PI/2);break;case"pz":Ge.translate(Ai,Ai,j.POSITIVE_Z);break;case"nz":Ge.translate(Ai,Ai,j.NEGATIVE_Z),Ge.rotateY(Ai,Ai,Math.PI)}return n.applyTransform(Ai),n}var Pi=At.extend({dynamic:!1,widthSegments:1,heightSegments:1,depthSegments:1,inside:!1},function(){this.build()},{build:function(){var t={px:Mi("px",this.depthSegments,this.heightSegments),nx:Mi("nx",this.depthSegments,this.heightSegments),py:Mi("py",this.widthSegments,this.depthSegments),ny:Mi("ny",this.widthSegments,this.depthSegments),pz:Mi("pz",this.widthSegments,this.heightSegments),nz:Mi("nz",this.widthSegments,this.heightSegments)},e=["position","texcoord0","normal"],r=0,n=0;for(var i in t)r+=t[i].vertexCount,n+=t[i].indices.length;for(var o=0;o<e.length;o++)this.attributes[e[o]].init(r);this.indices=new G.a.Uint16Array(n);var a=0,s=0;for(var i in t){var h=t[i];for(o=0;o<e.length;o++)for(var u=e[o],l=h.attributes[u].value,c=h.attributes[u].size,f="normal"===u,d=0;d<l.length;d++){var p=l[d];this.inside&&f&&(p=-p),this.attributes[u].value[d+c*s]=p}var m=h.indices.length;for(d=0;d<h.indices.length;d++)this.indices[d+a]=s+h.indices[this.inside?m-d-1:d];a+=h.indices.length,s+=h.vertexCount}this.boundingBox=new et,this.boundingBox.max.set(1,1,1),this.boundingBox.min.set(-1,-1,-1)}}),Ri=At.extend({dynamic:!1,generator:null},function(){this.build()},{build:function(){var t=this.generator;if(!(t&&t.x&&t.y&&t.z))throw new Error("Invalid generator");var e=t.x,r=t.y,n=t.z,i=t.u||[0,1,.05],o=t.v||[0,1,.05],a=Math.floor((i[1]-i[0]+i[2])/i[2]),s=Math.floor((o[1]-o[0]+o[2])/o[2]);if(!isFinite(a)||!isFinite(s))throw new Error("Infinite generator");var h=a*s;this.attributes.position.init(h),this.attributes.texcoord0.init(h);for(var u=[],l=[],c=0,f=0;f<s;f++)for(var d=0;d<a;d++){var p=d*i[2]+i[0],m=f*o[2]+o[0];u[0]=e(p,m),u[1]=r(p,m),u[2]=n(p,m),l[0]=d/(a-1),l[1]=f/(s-1),this.attributes.position.set(c,u),this.attributes.texcoord0.set(c,l),c++}var g=h>65535?Uint32Array:Uint16Array,_=(a-1)*(s-1)*6,y=this.indices=new g(_),v=0;for(f=0;f<s-1;f++)for(d=0;d<a-1;d++){var x=f*a+d,b=f*a+d+1,w=(f+1)*a+d+1,T=(f+1)*a+d;y[v++]=b,y[v++]=x,y[v++]=w,y[v++]=x,y[v++]=T,y[v++]=w}this.generateVertexNormals(),this.updateBoundingBox()}}),Li="@end",Oi=["@export clay.header.directional_light","uniform vec3 directionalLightDirection[DIRECTIONAL_LIGHT_COUNT]:unconfigurable;","uniform vec3 directionalLightColor[DIRECTIONAL_LIGHT_COUNT]:unconfigurable;",Li,"@export clay.header.ambient_light","uniform vec3 ambientLightColor[AMBIENT_LIGHT_COUNT]:unconfigurable;",Li,"@export clay.header.ambient_sh_light","uniform vec3 ambientSHLightColor[AMBIENT_SH_LIGHT_COUNT]:unconfigurable;","uniform vec3 ambientSHLightCoefficients[AMBIENT_SH_LIGHT_COUNT * 9]:unconfigurable;","vec3 calcAmbientSHLight(int idx, vec3 N) {\n int offset = 9 * idx;\n return ambientSHLightCoefficients[0]\n + ambientSHLightCoefficients[1] * N.x\n + ambientSHLightCoefficients[2] * N.y\n + ambientSHLightCoefficients[3] * N.z\n + ambientSHLightCoefficients[4] * N.x * N.z\n + ambientSHLightCoefficients[5] * N.z * N.y\n + ambientSHLightCoefficients[6] * N.y * N.x\n + ambientSHLightCoefficients[7] * (3.0 * N.z * N.z - 1.0)\n + ambientSHLightCoefficients[8] * (N.x * N.x - N.y * N.y);\n}",Li,"@export clay.header.ambient_cubemap_light","uniform vec3 ambientCubemapLightColor[AMBIENT_CUBEMAP_LIGHT_COUNT]:unconfigurable;","uniform samplerCube ambientCubemapLightCubemap[AMBIENT_CUBEMAP_LIGHT_COUNT]:unconfigurable;","uniform sampler2D ambientCubemapLightBRDFLookup[AMBIENT_CUBEMAP_LIGHT_COUNT]:unconfigurable;",Li,"@export clay.header.point_light","uniform vec3 pointLightPosition[POINT_LIGHT_COUNT]:unconfigurable;","uniform float pointLightRange[POINT_LIGHT_COUNT]:unconfigurable;","uniform vec3 pointLightColor[POINT_LIGHT_COUNT]:unconfigurable;",Li,"@export clay.header.spot_light","uniform vec3 spotLightPosition[SPOT_LIGHT_COUNT]:unconfigurable;","uniform vec3 spotLightDirection[SPOT_LIGHT_COUNT]:unconfigurable;","uniform float spotLightRange[SPOT_LIGHT_COUNT]:unconfigurable;","uniform float spotLightUmbraAngleCosine[SPOT_LIGHT_COUNT]:unconfigurable;","uniform float spotLightPenumbraAngleCosine[SPOT_LIGHT_COUNT]:unconfigurable;","uniform float spotLightFalloffFactor[SPOT_LIGHT_COUNT]:unconfigurable;","uniform vec3 spotLightColor[SPOT_LIGHT_COUNT]:unconfigurable;",Li].join("\n");en.import(Oi);var ki=We.extend(function(){return{color:[1,1,1],intensity:1,castShadow:!0,shadowResolution:512,group:0}},{type:"",clone:function(){var t=We.prototype.clone.call(this);return t.color=Array.prototype.slice.call(this.color),t.intensity=this.intensity,t.castShadow=this.castShadow,t.shadowResolution=this.shadowResolution,t}}),Di=ki.extend({castShadow:!1},{type:"AMBIENT_LIGHT",uniformTemplates:{ambientLightColor:{type:"3f",value:function(t){var e=t.color,r=t.intensity;return[e[0]*r,e[1]*r,e[2]*r]}}}}),Ii="@export clay.skybox.vertex\n#define SHADER_NAME skybox\nuniform mat4 world : WORLD;\nuniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\nattribute vec3 position : POSITION;\nvarying vec3 v_WorldPosition;\nvoid main()\n{\n v_WorldPosition = (world * vec4(position, 1.0)).xyz;\n gl_Position = worldViewProjection * vec4(position, 1.0);\n}\n@end\n@export clay.skybox.fragment\n#define PI 3.1415926\nuniform mat4 viewInverse : VIEWINVERSE;\n#ifdef EQUIRECTANGULAR\nuniform sampler2D environmentMap;\n#else\nuniform samplerCube environmentMap;\n#endif\nuniform float lod: 0.0;\nvarying vec3 v_WorldPosition;\n@import clay.util.rgbm\n@import clay.util.srgb\n@import clay.util.ACES\nvoid main()\n{\n vec3 eyePos = viewInverse[3].xyz;\n vec3 V = normalize(v_WorldPosition - eyePos);\n#ifdef EQUIRECTANGULAR\n float phi = acos(V.y);\n float theta = atan(-V.x, V.z) + PI * 0.5;\n vec2 uv = vec2(theta / 2.0 / PI, phi / PI);\n vec4 texel = decodeHDR(texture2D(environmentMap, fract(uv)));\n#else\n #if defined(LOD) || defined(SUPPORT_TEXTURE_LOD)\n vec4 texel = decodeHDR(textureCubeLodEXT(environmentMap, V, lod));\n #else\n vec4 texel = decodeHDR(textureCube(environmentMap, V));\n #endif\n#endif\n#ifdef SRGB_DECODE\n texel = sRGBToLinear(texel);\n#endif\n#ifdef TONEMAPPING\n texel.rgb = ACESToneMapping(texel.rgb);\n#endif\n#ifdef SRGB_ENCODE\n texel = linearTosRGB(texel);\n#endif\n gl_FragColor = encodeHDR(vec4(texel.rgb, 1.0));\n}\n@end";en.import(Ii);var Ni,Fi,Bi=Rn.extend(function(){var t=new en({vertex:en.source("clay.skybox.vertex"),fragment:en.source("clay.skybox.fragment")}),e=new Sn({shader:t,depthMask:!1});return{scene:null,geometry:new Pi,material:e,environmentMap:null,culling:!1}},function(){var t=this.scene;t&&this.attachScene(t),this.environmentMap&&this.setEnvironmentMap(this.environmentMap)},{attachScene:function(t){this.scene&&this.detachScene(),t.skybox=this,this.scene=t,t.on("beforerender",this._beforeRenderScene,this)},detachScene:function(){this.scene&&(this.scene.off("beforerender",this._beforeRenderScene),this.scene.skybox=null),this.scene=null},dispose:function(t){this.detachScene(),this.geometry.dispose(t)},setEnvironmentMap:function(t){"texture2D"===t.textureType?(this.material.define("EQUIRECTANGULAR"),t.minFilter=mr.LINEAR):this.material.undefine("EQUIRECTANGULAR"),this.material.set("environmentMap",t)},getEnvironmentMap:function(){return this.material.get("environmentMap")},_beforeRenderScene:function(t,e,r){this.renderSkybox(t,r)},renderSkybox:function(t,e){this.position.copy(e.getWorldPosition()),this.update(),t.gl.disable(t.gl.BLEND),this.material.get("lod")>0?this.material.define("fragment","LOD"):this.material.undefine("fragment","LOD"),t.renderPass([this],e)}}),zi=K.create(),Ui=K.create(),Hi={};function ji(t){var e=[],r=Object.keys(t);r.sort();for(var n=0;n<r.length;n++){var i=r[n];e.push(i+" "+t[i])}var o=e.join("\n");if(Hi[o])return Hi[o];var a=ut.genGUID();return Hi[o]=a,a}function Gi(){this.opaque=[],this.transparent=[],this._opaqueCount=0,this._transparentCount=0}function Vi(t,e){if(e.castShadow&&!t.castShadow)return!0}Gi.prototype.startCount=function(){this._opaqueCount=0,this._transparentCount=0},Gi.prototype.add=function(t,e){e?this.transparent[this._transparentCount++]=t:this.opaque[this._opaqueCount++]=t},Gi.prototype.endCount=function(){this.transparent.length=this._transparentCount,this.opaque.length=this._opaqueCount};var Wi=We.extend(function(){return{material:null,lights:[],viewBoundingBoxLastFrame:new et,shadowUniforms:{},_cameraList:[],_lightUniforms:{},_previousLightNumber:{},_lightNumber:{},_lightProgramKeys:{},_nodeRepository:{},_renderLists:new an(20)}},function(){this._scene=this},{addToScene:function(t){t instanceof ur?(this._cameraList.length>0&&console.warn("Found multiple camera in one scene. Use the fist one."),this._cameraList.push(t)):t instanceof ki&&this.lights.push(t),t.name&&(this._nodeRepository[t.name]=t)},removeFromScene:function(t){var e;t instanceof ur?(e=this._cameraList.indexOf(t))>=0&&this._cameraList.splice(e,1):t instanceof ki&&(e=this.lights.indexOf(t))>=0&&this.lights.splice(e,1),t.name&&delete this._nodeRepository[t.name]},getNode:function(t){return this._nodeRepository[t]},setMainCamera:function(t){var e=this._cameraList.indexOf(t);e>=0&&this._cameraList.splice(e,1),this._cameraList.unshift(t)},getMainCamera:function(){return this._cameraList[0]},getLights:function(){return this.lights},updateLights:function(){var t=this.lights;this._previousLightNumber=this._lightNumber;for(var e={},r=0;r<t.length;r++){var n=t[r];if(!n.invisible){var i=n.group;e[i]||(e[i]={}),e[i][n.type]=e[i][n.type]||0,e[i][n.type]++}}for(var o in this._lightNumber=e,e)this._lightProgramKeys[o]=ji(e[o]);this._updateLightUniforms()},cloneNode:function(t){var e=t.clone(),r={};return function t(e,n){r[e.__uid__]=n;for(var i=0;i<e._children.length;i++)t(e._children[i],n._children[i])}(t,e),e.traverse(function(t){t.skeleton&&(t.skeleton=t.skeleton.clone(r)),t.material&&(t.material=t.material.clone())}),e},updateRenderList:function(t,e){var r=t.__uid__,n=this._renderLists.get(r);n||(n=new Gi,this._renderLists.put(r,n)),n.startCount(),e&&(this.viewBoundingBoxLastFrame.min.set(1/0,1/0,1/0),this.viewBoundingBoxLastFrame.max.set(-1/0,-1/0,-1/0));var i=this.material&&this.material.transparent||!1;return this._doUpdateRenderList(this,t,i,n,e),n.endCount(),n},getRenderList:function(t){return this._renderLists.get(t.__uid__)},_doUpdateRenderList:function(t,e,r,n,i){if(!t.invisible)for(var o=0;o<t._children.length;o++){var a=t._children[o];if(a.isRenderable()){var s=a.isSkinnedMesh()?zi:a.worldTransform.array,h=a.geometry;K.multiplyAffine(Ui,e.viewMatrix.array,s),(i&&!h.boundingBox||!this.isFrustumCulled(a,e,Ui))&&n.add(a,a.material.transparent||r)}a._children.length>0&&this._doUpdateRenderList(a,e,r,n,i)}},isFrustumCulled:(Ni=new et,Fi=new Ge,function(t,e,r){var n=t.boundingBox;if(n||(n=t.skeleton&&t.skeleton.boundingBox?t.skeleton.boundingBox:t.geometry.boundingBox),!n)return!1;if(Fi.array=r,Ni.transformFrom(n,Fi),t.castShadow&&this.viewBoundingBoxLastFrame.union(Ni),t.frustumCulling){if(!Ni.intersectBoundingBox(e.frustum.boundingBox))return!0;Fi.array=e.projectionMatrix.array,Ni.max.array[2]>0&&Ni.min.array[2]<0&&(Ni.max.array[2]=-1e-20),Ni.applyProjection(Fi);var i=Ni.min.array,o=Ni.max.array;if(o[0]<-1||i[0]>1||o[1]<-1||i[1]>1||o[2]<-1||i[2]>1)return!0}return!1}),_updateLightUniforms:function(){var t=this.lights;t.sort(Vi);var e=this._lightUniforms;for(var r in e)for(var n in e[r])e[r][n].value.length=0;for(var i=0;i<t.length;i++){var o=t[i];if(!o.invisible){r=o.group;for(var n in o.uniformTemplates){var a=o.uniformTemplates[n],s=a.value(o);if(null!=s){e[r]||(e[r]={}),e[r][n]||(e[r][n]={type:"",value:[]});var h=e[r][n];switch(h.type=a.type+"v",a.type){case"1i":case"1f":case"t":h.value.push(s);break;case"2f":case"3f":case"4f":for(var u=0;u<s.length;u++)h.value.push(s[u]);break;default:console.error("Unkown light uniform type "+a.type)}}}}}},getLightGroups:function(){var t=[];for(var e in this._lightNumber)t.push(e);return t},getNumberChangedLightGroups:function(){var t=[];for(var e in this._lightNumber)this.isLightNumberChanged(e)&&t.push(e);return t},isLightNumberChanged:function(t){var e=this._previousLightNumber,r=this._lightNumber;for(var n in r[t]){if(!e[t])return!0;if(r[t][n]!==e[t][n])return!0}for(var n in e[t]){if(!r[t])return!0;if(r[t][n]!==e[t][n])return!0}return!1},getLightsNumbers:function(t){return this._lightNumber[t]},getProgramKey:function(t){return this._lightProgramKeys[t]},setLightUniforms:function(){function t(t,e,r){for(var n in t){var i=t[n];if("tv"===i.type){if(!e.hasUniform(n))continue;for(var o=[],a=0;a<i.value.length;a++){var s=i.value[a],h=e.takeCurrentTextureSlot(r,s);o.push(h)}e.setUniform(r.gl,"1iv",n,o)}else e.setUniform(r.gl,i.type,n,i.value)}}return function(e,r,n){t(this._lightUniforms[r],e,n),t(this.shadowUniforms,e,n)}}(),dispose:function(){this.material=null,this._opaqueList=[],this._transparentList=[],this.lights=[],this._lightUniforms={},this._lightNumber={},this._nodeRepository={}}}),Zi=["px","nx","py","ny","pz","nz"],Xi=ct.extend(function(){var t={position:new j,far:1e3,near:.1,texture:null,shadowMapPass:null},e=t._cameras={px:new cr({fov:90}),nx:new cr({fov:90}),py:new cr({fov:90}),ny:new cr({fov:90}),pz:new cr({fov:90}),nz:new cr({fov:90})};return e.px.lookAt(j.POSITIVE_X,j.NEGATIVE_Y),e.nx.lookAt(j.NEGATIVE_X,j.NEGATIVE_Y),e.py.lookAt(j.POSITIVE_Y,j.POSITIVE_Z),e.ny.lookAt(j.NEGATIVE_Y,j.NEGATIVE_Z),e.pz.lookAt(j.POSITIVE_Z,j.NEGATIVE_Y),e.nz.lookAt(j.NEGATIVE_Z,j.NEGATIVE_Y),t._frameBuffer=new Or,t},{getCamera:function(t){return this._cameras[t]},render:function(t,e,r){var n=t.gl;r||e.update();for(var i=this.texture.width,o=2*Math.atan(i/(i-.5))/Math.PI*180,a=0;a<6;a++){var s=Zi[a],h=this._cameras[s];if(j.copy(h.position,this.position),h.far=this.far,h.near=this.near,h.fov=o,this.shadowMapPass){h.update();var u=e.getBoundingBox();u.applyTransform(h.viewMatrix),e.viewBoundingBoxLastFrame.copy(u),this.shadowMapPass.render(t,e,h,!0)}this._frameBuffer.attach(this.texture,n.COLOR_ATTACHMENT0,n.TEXTURE_CUBE_MAP_POSITIVE_X+a),this._frameBuffer.bind(t),t.render(e,h,!0),this._frameBuffer.unbind(t)}},dispose:function(t){this._frameBuffer.dispose(t)}}),qi=Bi;function Yi(t){return t.charCodeAt(0)+(t.charCodeAt(1)<<8)+(t.charCodeAt(2)<<16)+(t.charCodeAt(3)<<24)}var Ji=Yi("DXT1"),Ki=Yi("DXT3"),Qi=Yi("DXT5"),$i={parse:function(t,e){var r=new Int32Array(t,0,31);if(542327876!==r[0])return null;if(4&!r(20))return null;var n,i,o=r(21),a=r[4],s=r[3],h=512&r[28],u=131072&r[2];switch(o){case Ji:n=8,i=mr.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case Ki:n=16,i=mr.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case Qi:n=16,i=mr.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return null}var l=r[1]+4,c=h?6:1,f=1;u&&(f=Math.max(1,r[7]));for(var d=[],p=0;p<c;p++){var m=a,g=s;d[p]=new br({width:m,height:g,format:i});for(var _=[],y=0;y<f;y++){var v=Math.max(4,m)/4*Math.max(4,g)/4*n,x=new Uint8Array(t,l,v);l+=v,m*=.5,g*=.5,_[y]=x}d[p].pixels=_[0],u&&(d[p].mipmaps=_)}if(!e)return d[0];e.width=d[0].width,e.height=d[0].height,e.format=d[0].format,e.pixels=d[0].pixels,e.mipmaps=d[0].mipmaps}},to=String.fromCharCode,eo=8,ro=32767;function no(t,e,r,n){if(t[3]>0){var i=Math.pow(2,t[3]-128-8+n);e[r+0]=t[0]*i,e[r+1]=t[1]*i,e[r+2]=t[2]*i}else e[r+0]=0,e[r+1]=0,e[r+2]=0;return e[r+3]=1,e}function io(t,e,r,n){for(var i,o,a=0,s=0,h=n;h>0;)if(t[s][0]=e[r++],t[s][1]=e[r++],t[s][2]=e[r++],t[s][3]=e[r++],1===t[s][0]&&1===t[s][1]&&1===t[s][2]){for(var u=t[s][3]<<a>>>0;u>0;u--)i=t[s-1],(o=t[s])[0]=i[0],o[1]=i[1],o[2]=i[2],o[3]=i[3],s++,h--;a+=8}else s++,h--,a=0;return r}function oo(t,e,r,n){if(n<eo|n>ro)return io(t,e,r,n);if(2!=(i=e[r++]))return io(t,e,r-1,n);if(t[0][1]=e[r++],t[0][2]=e[r++],i=e[r++],(t[0][2]<<8>>>0|i)>>>0!==n)return null;for(var i=0;i<4;i++)for(var o=0;o<n;){var a=e[r++];if(a>128){a=(127&a)>>>0;for(var s=e[r++];a--;)t[o++][i]=s}else for(;a--;)t[o++][i]=e[r++]}return r}var ao={parseRGBE:function(t,e,r){null==r&&(r=0);var n=new Uint8Array(t),i=n.length;if("#?"===function(t,e,r){for(var n="",i=e;i<r;i++)n+=to(t[i]);return n}(n,0,2)){for(var o=2;o<i&&("\n"!==to(n[o])||"\n"!==to(n[o+1]));o++);if(!(o>=i)){o+=2;for(var a="";o<i;o++){var s=to(n[o]);if("\n"===s)break;a+=s}var h=a.split(" "),u=parseInt(h[1]),l=parseInt(h[3]);if(l&&u){for(var c=o+1,f=[],d=0;d<l;d++){f[d]=[];for(var p=0;p<4;p++)f[d][p]=0}for(var m=new Float32Array(l*u*4),g=0,_=0;_<u;_++){if(!(c=oo(f,n,c,l)))return null;for(d=0;d<l;d++)no(f[d],m,g,r),g+=4}return e||(e=new br),e.width=l,e.height=u,e.pixels=m,e.type=mr.FLOAT,e}}}},parseRGBEFromPNG:function(t){}},so={loadTexture:function(t,e,r,n){var i;if("function"==typeof e?(n=r=e,e={}):e=e||{},"string"==typeof t){if(t.match(/.hdr$/)||"hdr"===e.fileType)return i=new br({width:0,height:0,sRGB:!1}),so._fetchTexture(t,function(t){ao.parseRGBE(t,i,e.exposure),i.dirty(),r&&r(i)},n),i;t.match(/.dds$/)||"dds"===e.fileType?(i=new br({width:0,height:0}),so._fetchTexture(t,function(t){$i.parse(t,i),i.dirty(),r&&r(i)},n)):((i=new br).load(t),i.success(r),i.error(n))}else"object"==typeof t&&void 0!==t.px&&((i=new Un).load(t),i.success(r),i.error(n));return i},loadPanorama:function(t,e,r,n,i,o){var a=this;"function"==typeof n?(o=i=n,n={}):n=n||{},so.loadTexture(e,n,function(e){e.flipY=n.flipY||!1,a.panoramaToCubeMap(t,e,r,n),e.dispose(t),i&&i(r)},o)},panoramaToCubeMap:function(t,e,r,n){var i=new Xi,o=new qi({scene:new Wi});return o.setEnvironmentMap(e),(n=n||{}).encodeRGBM&&o.material.define("fragment","RGBM_ENCODE"),r.sRGB=e.sRGB,i.texture=r,i.render(t,o.scene),i.texture=null,i.dispose(t),r},heightToNormal:function(t,e){var r=document.createElement("canvas"),n=r.width=t.width,i=r.height=t.height,o=r.getContext("2d");o.drawImage(t,0,0,n,i),e=e||!1;for(var a=o.getImageData(0,0,n,i),s=o.createImageData(n,i),h=0;h<a.data.length;h+=4){if(e){var u=a.data[h],l=a.data[h+1],c=a.data[h+2];if(Math.abs(u-l)+Math.abs(l-c)>20)return console.warn("Given image is not a height map"),t}var f,d,p,m;h%(4*n)==0?(f=a.data[h],p=a.data[h+4]):h%(4*n)==4*(n-1)?(f=a.data[h-4],p=a.data[h]):(f=a.data[h-4],p=a.data[h+4]),h<4*n?(d=a.data[h],m=a.data[h+4*n]):h>n*(i-1)*4?(d=a.data[h-4*n],m=a.data[h]):(d=a.data[h-4*n],m=a.data[h+4*n]),s.data[h]=f-p+127,s.data[h+1]=d-m+127,s.data[h+2]=255,s.data[h+3]=255}return o.putImageData(s,0,0),r},isHeightImage:function(t,e,r){if(!t||!t.width||!t.height)return!1;var n=document.createElement("canvas"),i=n.getContext("2d"),o=e||32;r=r||20,n.width=n.height=o,i.drawImage(t,0,0,o,o);for(var a=i.getImageData(0,0,o,o),s=0;s<a.data.length;s+=4){var h=a.data[s],u=a.data[s+1],l=a.data[s+2];if(Math.abs(h-u)+Math.abs(u-l)>r)return!1}return!0},_fetchTexture:function(t,e,r){G.a.request.get({url:t,responseType:"arraybuffer",onload:e,onerror:r})},createChessboard:function(t,e,r,n){t=t||512,e=e||64,r=r||"black",n=n||"white";var i=Math.ceil(t/e),o=document.createElement("canvas");o.width=t,o.height=t;var a=o.getContext("2d");a.fillStyle=n,a.fillRect(0,0,t,t),a.fillStyle=r;for(var s=0;s<i;s++)for(var h=0;h<i;h++){(h%2?s%2:s%2-1)&&a.fillRect(s*e,h*e,e,e)}return new br({image:o,anisotropic:8})},createBlank:function(t){var e=document.createElement("canvas");e.width=1,e.height=1;var r=e.getContext("2d");return r.fillStyle=t,r.fillRect(0,0,1,1),new br({image:e})}},ho=so,uo={},lo=["px","nx","py","ny","pz","nz"];uo.prefilterEnvironmentMap=function(t,e,r,n,i){i&&n||(n=uo.generateNormalDistribution(),i=uo.integrateBRDF(t,n));var o=(r=r||{}).width||64,a=r.height||64,s=r.type||e.type,h=new Un({width:o,height:a,type:s,flipY:!1,mipmaps:[]});h.isPowerOfTwo()||console.warn("Width and height must be power of two to enable mipmap.");var u=Math.min(o,a),l=Math.log(u)/Math.log(2)+1,c=new Sn({shader:new en({vertex:en.source("clay.skybox.vertex"),fragment:"#define SHADER_NAME prefilter\n#define SAMPLE_NUMBER 1024\n#define PI 3.14159265358979\nuniform mat4 viewInverse : VIEWINVERSE;\nuniform samplerCube environmentMap;\nuniform sampler2D normalDistribution;\nuniform float roughness : 0.5;\nvarying vec2 v_Texcoord;\nvarying vec3 v_WorldPosition;\n@import clay.util.rgbm\nvec3 importanceSampleNormal(float i, float roughness, vec3 N) {\n vec3 H = texture2D(normalDistribution, vec2(roughness, i)).rgb;\n vec3 upVector = abs(N.y) > 0.999 ? vec3(1.0, 0.0, 0.0) : vec3(0.0, 1.0, 0.0);\n vec3 tangentX = normalize(cross(N, upVector));\n vec3 tangentZ = cross(N, tangentX);\n return normalize(tangentX * H.x + N * H.y + tangentZ * H.z);\n}\nvoid main() {\n vec3 eyePos = viewInverse[3].xyz;\n vec3 V = normalize(v_WorldPosition - eyePos);\n vec3 N = V;\n vec3 prefilteredColor = vec3(0.0);\n float totalWeight = 0.0;\n float fMaxSampleNumber = float(SAMPLE_NUMBER);\n for (int i = 0; i < SAMPLE_NUMBER; i++) {\n vec3 H = importanceSampleNormal(float(i) / fMaxSampleNumber, roughness, N);\n vec3 L = reflect(-V, H);\n float NoL = clamp(dot(N, L), 0.0, 1.0);\n if (NoL > 0.0) {\n prefilteredColor += decodeHDR(textureCube(environmentMap, L)).rgb * NoL;\n totalWeight += NoL;\n }\n }\n gl_FragColor = encodeHDR(vec4(prefilteredColor / totalWeight, 1.0));\n}\n"})});c.set("normalDistribution",n),r.encodeRGBM&&c.define("fragment","RGBM_ENCODE"),r.decodeRGBM&&c.define("fragment","RGBM_DECODE");var f,d=new Wi;if("texture2D"===e.textureType){var p=new Un({width:o,height:a,type:s===mr.FLOAT?mr.HALF_FLOAT:s});ho.panoramaToCubeMap(t,e,p,{encodeRGBM:r.decodeRGBM}),e=p}(f=new Bi({scene:d,material:c})).material.set("environmentMap",e);var m=new Xi({texture:h});r.encodeRGBM&&(s=h.type=mr.UNSIGNED_BYTE);for(var g=new br({width:o,height:a,type:s}),_=new Or({depthBuffer:!1}),y=G.a[s===mr.UNSIGNED_BYTE?"Uint8Array":"Float32Array"],v=0;v<l;v++){h.mipmaps[v]={pixels:{}},f.material.set("roughness",v/(l-1));for(var x=g.width,b=2*Math.atan(x/(x-.5))/Math.PI*180,w=0;w<lo.length;w++){var T=new y(g.width*g.height*4);_.attach(g),_.bind(t);var E=m.getCamera(lo[w]);E.fov=b,t.render(d,E),t.gl.readPixels(0,0,g.width,g.height,mr.RGBA,s,T),_.unbind(t),h.mipmaps[v].pixels[lo[w]]=T}g.width/=2,g.height/=2,g.dirty()}return _.dispose(t),g.dispose(t),f.dispose(t),n.dispose(t),{environmentMap:h,brdfLookup:i,normalDistribution:n,maxMipmapLevel:l}},uo.integrateBRDF=function(t,e){e=e||uo.generateNormalDistribution();var r=new Or({depthBuffer:!1}),n=new Dn({fragment:"#define SAMPLE_NUMBER 1024\n#define PI 3.14159265358979\nuniform sampler2D normalDistribution;\nuniform vec2 viewportSize : [512, 256];\nconst vec3 N = vec3(0.0, 0.0, 1.0);\nconst float fSampleNumber = float(SAMPLE_NUMBER);\nvec3 importanceSampleNormal(float i, float roughness, vec3 N) {\n vec3 H = texture2D(normalDistribution, vec2(roughness, i)).rgb;\n vec3 upVector = abs(N.y) > 0.999 ? vec3(1.0, 0.0, 0.0) : vec3(0.0, 1.0, 0.0);\n vec3 tangentX = normalize(cross(N, upVector));\n vec3 tangentZ = cross(N, tangentX);\n return normalize(tangentX * H.x + N * H.y + tangentZ * H.z);\n}\nfloat G_Smith(float roughness, float NoV, float NoL) {\n float k = roughness * roughness / 2.0;\n float G1V = NoV / (NoV * (1.0 - k) + k);\n float G1L = NoL / (NoL * (1.0 - k) + k);\n return G1L * G1V;\n}\nvoid main() {\n vec2 uv = gl_FragCoord.xy / viewportSize;\n float NoV = uv.x;\n float roughness = uv.y;\n vec3 V;\n V.x = sqrt(1.0 - NoV * NoV);\n V.y = 0.0;\n V.z = NoV;\n float A = 0.0;\n float B = 0.0;\n for (int i = 0; i < SAMPLE_NUMBER; i++) {\n vec3 H = importanceSampleNormal(float(i) / fSampleNumber, roughness, N);\n vec3 L = reflect(-V, H);\n float NoL = clamp(L.z, 0.0, 1.0);\n float NoH = clamp(H.z, 0.0, 1.0);\n float VoH = clamp(dot(V, H), 0.0, 1.0);\n if (NoL > 0.0) {\n float G = G_Smith(roughness, NoV, NoL);\n float G_Vis = G * VoH / (NoH * NoV);\n float Fc = pow(1.0 - VoH, 5.0);\n A += (1.0 - Fc) * G_Vis;\n B += Fc * G_Vis;\n }\n }\n gl_FragColor = vec4(vec2(A, B) / fSampleNumber, 0.0, 1.0);\n}\n"}),i=new br({width:512,height:256,type:mr.HALF_FLOAT,wrapS:mr.CLAMP_TO_EDGE,wrapT:mr.CLAMP_TO_EDGE,minFilter:mr.NEAREST,magFilter:mr.NEAREST,useMipmap:!1});return n.setUniform("normalDistribution",e),n.setUniform("viewportSize",[512,256]),n.attachOutput(i),n.render(t,r),r.dispose(t),i},uo.generateNormalDistribution=function(t,e){for(var r=new br({width:t=t||256,height:e=e||1024,type:mr.FLOAT,minFilter:mr.NEAREST,magFilter:mr.NEAREST,wrapS:mr.CLAMP_TO_EDGE,wrapT:mr.CLAMP_TO_EDGE,useMipmap:!1}),n=new Float32Array(e*t*4),i=[],o=0;o<t;o++){for(var a=o/t,s=a*a,h=0;h<e;h++){var u=(h<<16|h>>>16)>>>0;u=(((16711935&(u=((252645135&(u=((858993459&(u=((1431655765&u)<<1|(2863311530&u)>>>1)>>>0))<<2|(3435973836&u)>>>2)>>>0))<<4|(4042322160&u)>>>4)>>>0))<<8|(4278255360&u)>>>8)>>>0)/4294967296;var l=Math.sqrt((1-u)/(1+(s*s-1)*u));i[h]=l}for(h=0;h<e;h++){var c=4*(h*t+o),f=(l=i[h],Math.sqrt(1-l*l)),d=h/e,p=2*Math.PI*d;n[c]=f*Math.cos(p),n[c+1]=l,n[c+2]=f*Math.sin(p),n[c+3]=1}}return r.pixels=n,r};var co,fo=uo,po=ki.extend({cubemap:null,castShadow:!1,_normalDistribution:null,_brdfLookup:null},{type:"AMBIENT_CUBEMAP_LIGHT",prefilter:function(t,e){if(t.getGLExtension("EXT_shader_texture_lod")){this._brdfLookup||(this._normalDistribution=fo.generateNormalDistribution(),this._brdfLookup=fo.integrateBRDF(t,this._normalDistribution));var r=this.cubemap;if(!r.__prefiltered){var n=fo.prefilterEnvironmentMap(t,r,{encodeRGBM:!0,width:e,height:e},this._normalDistribution,this._brdfLookup);this.cubemap=n.environmentMap,this.cubemap.__prefiltered=!0,r.dispose(t)}}else console.warn("Device not support textureCubeLodEXT")},getBRDFLookup:function(){return this._brdfLookup},uniformTemplates:{ambientCubemapLightColor:{type:"3f",value:function(t){var e=t.color,r=t.intensity;return[e[0]*r,e[1]*r,e[2]*r]}},ambientCubemapLightCubemap:{type:"t",value:function(t){return t.cubemap}},ambientCubemapLightBRDFLookup:{type:"t",value:function(t){return t._brdfLookup}}}}),mo=ki.extend({castShadow:!1,coefficients:[]},function(){this._coefficientsTmpArr=new G.a.Float32Array(27)},{type:"AMBIENT_SH_LIGHT",uniformTemplates:{ambientSHLightColor:{type:"3f",value:function(t){var e=t.color,r=t.intensity;return[e[0]*r,e[1]*r,e[2]*r]}},ambientSHLightCoefficients:{type:"3f",value:function(t){for(var e=t._coefficientsTmpArr,r=0;r<t.coefficients.length;r++)e[r]=t.coefficients[r];return e}}}}),go=ki.extend({shadowBias:.001,shadowSlopeScale:2,shadowCascade:1,cascadeSplitLogFactor:.2},{type:"DIRECTIONAL_LIGHT",uniformTemplates:{directionalLightDirection:{type:"3f",value:function(t){return t.__dir=t.__dir||new j,t.__dir.copy(t.worldTransform.z).normalize().negate().array}},directionalLightColor:{type:"3f",value:function(t){var e=t.color,r=t.intensity;return[e[0]*r,e[1]*r,e[2]*r]}}},clone:function(){var t=ki.prototype.clone.call(this);return t.shadowBias=this.shadowBias,t.shadowSlopeScale=this.shadowSlopeScale,t}}),_o=ki.extend({range:100,castShadow:!1},{type:"POINT_LIGHT",uniformTemplates:{pointLightPosition:{type:"3f",value:function(t){return t.getWorldPosition().array}},pointLightRange:{type:"1f",value:function(t){return t.range}},pointLightColor:{type:"3f",value:function(t){var e=t.color,r=t.intensity;return[e[0]*r,e[1]*r,e[2]*r]}}},clone:function(){var t=ki.prototype.clone.call(this);return t.range=this.range,t}}),yo=(ki.extend({range:100,radius:5},{type:"SPHERE_LIGHT",uniformTemplates:{sphereLightPosition:{type:"3f",value:function(t){return t.getWorldPosition().array}},sphereLightRange:{type:"1f",value:function(t){return t.range}},sphereLightRadius:{type:"1f",value:function(t){return t.radius}},sphereLightColor:{type:"3f",value:function(t){var e=t.color,r=t.intensity;return[e[0]*r,e[1]*r,e[2]*r]}}}}),ki.extend({range:20,umbraAngle:30,penumbraAngle:45,falloffFactor:2,shadowBias:.001,shadowSlopeScale:2},{type:"SPOT_LIGHT",uniformTemplates:{spotLightPosition:{type:"3f",value:function(t){return t.getWorldPosition().array}},spotLightRange:{type:"1f",value:function(t){return t.range}},spotLightUmbraAngleCosine:{type:"1f",value:function(t){return Math.cos(t.umbraAngle*Math.PI/180)}},spotLightPenumbraAngleCosine:{type:"1f",value:function(t){return Math.cos(t.penumbraAngle*Math.PI/180)}},spotLightFalloffFactor:{type:"1f",value:function(t){return t.falloffFactor}},spotLightDirection:{type:"3f",value:function(t){return t.__dir=t.__dir||new j,t.__dir.copy(t.worldTransform.z).negate().array}},spotLightColor:{type:"3f",value:function(t){var e=t.color,r=t.intensity;return[e[0]*r,e[1]*r,e[2]*r]}}},clone:function(){var t=ki.prototype.clone.call(this);return t.range=this.range,t.umbraAngle=this.umbraAngle,t.penumbraAngle=this.penumbraAngle,t.falloffFactor=this.falloffFactor,t.shadowBias=this.shadowBias,t.shadowSlopeScale=this.shadowSlopeScale,t}})),vo=(ki.extend({range:100,length:10},{type:"TUBE_LIGHT",uniformTemplates:{tubeLightPosition:{type:"3f",value:function(t){return t.getWorldPosition().array}},tubeLightExtend:{type:"3f",value:(co=new j,function(t){return co.copy(t.worldTransform.x).normalize().scale(t.length/2).array})},tubeLightRange:{type:"1f",value:function(t){return t.range}},tubeLightColor:{type:"3f",value:function(t){var e=t.color,r=t.intensity;return[e[0]*r,e[1]*r,e[2]*r]}}}}),ct.extend({rootPath:"",textureRootPath:"",shaderRootPath:"",scene:null,camera:null},{load:function(t){var e=this;this.rootPath||(this.rootPath=t.slice(0,t.lastIndexOf("/"))),G.a.request.get({url:t,onprogress:function(t,r,n){e.trigger("progress",t,r,n)},onerror:function(t){e.trigger("error",t)},responseType:"text",onload:function(t){hi(JSON.parse(t),{textureRootPath:this.textureRootPath||this.rootPath,camera:this.camera,scene:this.scene})}})}}),"\n@export clay.standard.chunk.varying\nvarying vec2 v_Texcoord;\nvarying vec3 v_Normal;\nvarying vec3 v_WorldPosition;\nvarying vec3 v_Barycentric;\n#if defined(PARALLAXOCCLUSIONMAP_ENABLED) || defined(NORMALMAP_ENABLED)\nvarying vec3 v_Tangent;\nvarying vec3 v_Bitangent;\n#endif\n#if defined(AOMAP_ENABLED)\nvarying vec2 v_Texcoord2;\n#endif\n#ifdef VERTEX_COLOR\nvarying vec4 v_Color;\n#endif\n@end\n@export clay.standard.chunk.light_header\n#ifdef AMBIENT_LIGHT_COUNT\n@import clay.header.ambient_light\n#endif\n#ifdef AMBIENT_SH_LIGHT_COUNT\n@import clay.header.ambient_sh_light\n#endif\n#ifdef AMBIENT_CUBEMAP_LIGHT_COUNT\n@import clay.header.ambient_cubemap_light\n#endif\n#ifdef POINT_LIGHT_COUNT\n@import clay.header.point_light\n#endif\n#ifdef DIRECTIONAL_LIGHT_COUNT\n@import clay.header.directional_light\n#endif\n#ifdef SPOT_LIGHT_COUNT\n@import clay.header.spot_light\n#endif\n@end\n@export clay.standard.vertex\n#define SHADER_NAME standard\nuniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\nuniform mat4 worldInverseTranspose : WORLDINVERSETRANSPOSE;\nuniform mat4 world : WORLD;\nuniform vec2 uvRepeat : [1.0, 1.0];\nuniform vec2 uvOffset : [0.0, 0.0];\nattribute vec3 position : POSITION;\nattribute vec2 texcoord : TEXCOORD_0;\n#if defined(AOMAP_ENABLED)\nattribute vec2 texcoord2 : TEXCOORD_1;\n#endif\nattribute vec3 normal : NORMAL;\nattribute vec4 tangent : TANGENT;\n#ifdef VERTEX_COLOR\nattribute vec4 a_Color : COLOR;\n#endif\nattribute vec3 barycentric;\n@import clay.standard.chunk.varying\n@import clay.chunk.skinning_header\nvoid main()\n{\n vec3 skinnedPosition = position;\n vec3 skinnedNormal = normal;\n vec3 skinnedTangent = tangent.xyz;\n#ifdef SKINNING\n @import clay.chunk.skin_matrix\n skinnedPosition = (skinMatrixWS * vec4(position, 1.0)).xyz;\n skinnedNormal = (skinMatrixWS * vec4(normal, 0.0)).xyz;\n skinnedTangent = (skinMatrixWS * vec4(tangent.xyz, 0.0)).xyz;\n#endif\n gl_Position = worldViewProjection * vec4(skinnedPosition, 1.0);\n v_Texcoord = texcoord * uvRepeat + uvOffset;\n v_WorldPosition = (world * vec4(skinnedPosition, 1.0)).xyz;\n v_Barycentric = barycentric;\n v_Normal = normalize((worldInverseTranspose * vec4(skinnedNormal, 0.0)).xyz);\n#if defined(PARALLAXOCCLUSIONMAP_ENABLED) || defined(NORMALMAP_ENABLED)\n v_Tangent = normalize((worldInverseTranspose * vec4(skinnedTangent, 0.0)).xyz);\n v_Bitangent = normalize(cross(v_Normal, v_Tangent) * tangent.w);\n#endif\n#ifdef VERTEX_COLOR\n v_Color = a_Color;\n#endif\n#if defined(AOMAP_ENABLED)\n v_Texcoord2 = texcoord2;\n#endif\n}\n@end\n@export clay.standard.fragment\n#define PI 3.14159265358979\n#define GLOSSINESS_CHANNEL 0\n#define ROUGHNESS_CHANNEL 0\n#define METALNESS_CHANNEL 1\n#define DIFFUSEMAP_ALPHA_ALPHA\n@import clay.standard.chunk.varying\nuniform mat4 viewInverse : VIEWINVERSE;\n#ifdef NORMALMAP_ENABLED\nuniform sampler2D normalMap;\n#endif\nuniform float normalScale: 1.0;\n#ifdef DIFFUSEMAP_ENABLED\nuniform sampler2D diffuseMap;\n#endif\n#ifdef SPECULARMAP_ENABLED\nuniform sampler2D specularMap;\n#endif\n#ifdef USE_ROUGHNESS\nuniform float roughness : 0.5;\n #ifdef ROUGHNESSMAP_ENABLED\nuniform sampler2D roughnessMap;\n #endif\n#else\nuniform float glossiness: 0.5;\n #ifdef GLOSSINESSMAP_ENABLED\nuniform sampler2D glossinessMap;\n #endif\n#endif\n#ifdef METALNESSMAP_ENABLED\nuniform sampler2D metalnessMap;\n#endif\n#ifdef OCCLUSIONMAP_ENABLED\nuniform sampler2D occlusionMap;\n#endif\n#ifdef ENVIRONMENTMAP_ENABLED\nuniform samplerCube environmentMap;\n #ifdef PARALLAX_CORRECTED\nuniform vec3 environmentBoxMin;\nuniform vec3 environmentBoxMax;\n #endif\n#endif\n#ifdef BRDFLOOKUP_ENABLED\nuniform sampler2D brdfLookup;\n#endif\n#ifdef EMISSIVEMAP_ENABLED\nuniform sampler2D emissiveMap;\n#endif\n#ifdef SSAOMAP_ENABLED\nuniform sampler2D ssaoMap;\nuniform vec4 viewport : VIEWPORT;\n#endif\n#ifdef AOMAP_ENABLED\nuniform sampler2D aoMap;\nuniform float aoIntensity;\n#endif\nuniform vec3 color : [1.0, 1.0, 1.0];\nuniform float alpha : 1.0;\n#ifdef ALPHA_TEST\nuniform float alphaCutoff: 0.9;\n#endif\n#ifdef USE_METALNESS\nuniform float metalness : 0.0;\n#else\nuniform vec3 specularColor : [0.1, 0.1, 0.1];\n#endif\nuniform vec3 emission : [0.0, 0.0, 0.0];\nuniform float emissionIntensity: 1;\nuniform float lineWidth : 0.0;\nuniform vec4 lineColor : [0.0, 0.0, 0.0, 0.6];\n#ifdef ENVIRONMENTMAP_PREFILTER\nuniform float maxMipmapLevel: 5;\n#endif\n@import clay.standard.chunk.light_header\n@import clay.util.calculate_attenuation\n@import clay.util.edge_factor\n@import clay.util.rgbm\n@import clay.util.srgb\n@import clay.plugin.compute_shadow_map\n@import clay.util.parallax_correct\n@import clay.util.ACES\nfloat G_Smith(float g, float ndv, float ndl)\n{\n float roughness = 1.0 - g;\n float k = roughness * roughness / 2.0;\n float G1V = ndv / (ndv * (1.0 - k) + k);\n float G1L = ndl / (ndl * (1.0 - k) + k);\n return G1L * G1V;\n}\nvec3 F_Schlick(float ndv, vec3 spec) {\n return spec + (1.0 - spec) * pow(1.0 - ndv, 5.0);\n}\nfloat D_Phong(float g, float ndh) {\n float a = pow(8192.0, g);\n return (a + 2.0) / 8.0 * pow(ndh, a);\n}\nfloat D_GGX(float g, float ndh) {\n float r = 1.0 - g;\n float a = r * r;\n float tmp = ndh * ndh * (a - 1.0) + 1.0;\n return a / (PI * tmp * tmp);\n}\n#ifdef PARALLAXOCCLUSIONMAP_ENABLED\nuniform float parallaxOcclusionScale : 0.02;\nuniform float parallaxMaxLayers : 20;\nuniform float parallaxMinLayers : 5;\nuniform sampler2D parallaxOcclusionMap;\nmat3 transpose(in mat3 inMat)\n{\n vec3 i0 = inMat[0];\n vec3 i1 = inMat[1];\n vec3 i2 = inMat[2];\n return mat3(\n vec3(i0.x, i1.x, i2.x),\n vec3(i0.y, i1.y, i2.y),\n vec3(i0.z, i1.z, i2.z)\n );\n}\nvec2 parallaxUv(vec2 uv, vec3 viewDir)\n{\n float numLayers = mix(parallaxMaxLayers, parallaxMinLayers, abs(dot(vec3(0.0, 0.0, 1.0), viewDir)));\n float layerHeight = 1.0 / numLayers;\n float curLayerHeight = 0.0;\n vec2 deltaUv = viewDir.xy * parallaxOcclusionScale / (viewDir.z * numLayers);\n vec2 curUv = uv;\n float height = 1.0 - texture2D(parallaxOcclusionMap, curUv).r;\n for (int i = 0; i < 30; i++) {\n curLayerHeight += layerHeight;\n curUv -= deltaUv;\n height = 1.0 - texture2D(parallaxOcclusionMap, curUv).r;\n if (height < curLayerHeight) {\n break;\n }\n }\n vec2 prevUv = curUv + deltaUv;\n float next = height - curLayerHeight;\n float prev = 1.0 - texture2D(parallaxOcclusionMap, prevUv).r - curLayerHeight + layerHeight;\n return mix(curUv, prevUv, next / (next - prev));\n}\n#endif\nvoid main() {\n vec4 albedoColor = vec4(color, alpha);\n#ifdef VERTEX_COLOR\n albedoColor *= v_Color;\n#endif\n#ifdef SRGB_DECODE\n albedoColor = sRGBToLinear(albedoColor);\n#endif\n vec3 eyePos = viewInverse[3].xyz;\n vec3 V = normalize(eyePos - v_WorldPosition);\n vec2 uv = v_Texcoord;\n#if defined(PARALLAXOCCLUSIONMAP_ENABLED) || defined(NORMALMAP_ENABLED)\n mat3 tbn = mat3(v_Tangent, v_Bitangent, v_Normal);\n#endif\n#ifdef PARALLAXOCCLUSIONMAP_ENABLED\n uv = parallaxUv(v_Texcoord, normalize(transpose(tbn) * -V));\n#endif\n#ifdef DIFFUSEMAP_ENABLED\n vec4 texel = texture2D(diffuseMap, uv);\n #ifdef SRGB_DECODE\n texel = sRGBToLinear(texel);\n #endif\n albedoColor.rgb *= texel.rgb;\n #ifdef DIFFUSEMAP_ALPHA_ALPHA\n albedoColor.a *= texel.a;\n #endif\n#endif\n#ifdef USE_METALNESS\n float m = metalness;\n #ifdef METALNESSMAP_ENABLED\n float m2 = texture2D(metalnessMap, uv)[METALNESS_CHANNEL];\n m = clamp(m2 + (m - 0.5) * 2.0, 0.0, 1.0);\n #endif\n vec3 baseColor = albedoColor.rgb;\n albedoColor.rgb = baseColor * (1.0 - m);\n vec3 spec = mix(vec3(0.04), baseColor, m);\n#else\n vec3 spec = specularColor;\n#endif\n#ifdef USE_ROUGHNESS\n float g = clamp(1.0 - roughness, 0.0, 1.0);\n #ifdef ROUGHNESSMAP_ENABLED\n float g2 = 1.0 - texture2D(roughnessMap, uv)[ROUGHNESS_CHANNEL];\n g = clamp(g2 + (g - 0.5) * 2.0, 0.0, 1.0);\n #endif\n#else\n float g = glossiness;\n #ifdef GLOSSINESSMAP_ENABLED\n float g2 = texture2D(glossinessMap, uv)[GLOSSINESS_CHANNEL];\n g = clamp(g2 + (g - 0.5) * 2.0, 0.0, 1.0);\n #endif\n#endif\n#ifdef SPECULARMAP_ENABLED\n spec *= sRGBToLinear(texture2D(specularMap, uv)).rgb;\n#endif\n vec3 N = v_Normal;\n#ifdef DOUBLE_SIDED\n if (dot(N, V) < 0.0) {\n N = -N;\n }\n#endif\n#ifdef NORMALMAP_ENABLED\n if (dot(v_Tangent, v_Tangent) > 0.0) {\n vec3 normalTexel = texture2D(normalMap, uv).xyz;\n if (dot(normalTexel, normalTexel) > 0.0) { N = (normalTexel * 2.0 - 1.0);\n N = normalize(N * vec3(normalScale, normalScale, 1.0));\n tbn[1] = -tbn[1];\n N = normalize(tbn * N);\n }\n }\n#endif\n vec3 diffuseTerm = vec3(0.0, 0.0, 0.0);\n vec3 specularTerm = vec3(0.0, 0.0, 0.0);\n float ndv = clamp(dot(N, V), 0.0, 1.0);\n vec3 fresnelTerm = F_Schlick(ndv, spec);\n#ifdef AMBIENT_LIGHT_COUNT\n for(int _idx_ = 0; _idx_ < AMBIENT_LIGHT_COUNT; _idx_++)\n {{\n diffuseTerm += ambientLightColor[_idx_];\n }}\n#endif\n#ifdef AMBIENT_SH_LIGHT_COUNT\n for(int _idx_ = 0; _idx_ < AMBIENT_SH_LIGHT_COUNT; _idx_++)\n {{\n diffuseTerm += calcAmbientSHLight(_idx_, N) * ambientSHLightColor[_idx_];\n }}\n#endif\n#ifdef POINT_LIGHT_COUNT\n#if defined(POINT_LIGHT_SHADOWMAP_COUNT)\n float shadowContribsPoint[POINT_LIGHT_COUNT];\n if(shadowEnabled)\n {\n computeShadowOfPointLights(v_WorldPosition, shadowContribsPoint);\n }\n#endif\n for(int _idx_ = 0; _idx_ < POINT_LIGHT_COUNT; _idx_++)\n {{\n vec3 lightPosition = pointLightPosition[_idx_];\n vec3 lc = pointLightColor[_idx_];\n float range = pointLightRange[_idx_];\n vec3 L = lightPosition - v_WorldPosition;\n float dist = length(L);\n float attenuation = lightAttenuation(dist, range);\n L /= dist;\n vec3 H = normalize(L + V);\n float ndl = clamp(dot(N, L), 0.0, 1.0);\n float ndh = clamp(dot(N, H), 0.0, 1.0);\n float shadowContrib = 1.0;\n#if defined(POINT_LIGHT_SHADOWMAP_COUNT)\n if(shadowEnabled)\n {\n shadowContrib = shadowContribsPoint[_idx_];\n }\n#endif\n vec3 li = lc * ndl * attenuation * shadowContrib;\n diffuseTerm += li;\n specularTerm += li * fresnelTerm * D_Phong(g, ndh);\n }}\n#endif\n#ifdef DIRECTIONAL_LIGHT_COUNT\n#if defined(DIRECTIONAL_LIGHT_SHADOWMAP_COUNT)\n float shadowContribsDir[DIRECTIONAL_LIGHT_COUNT];\n if(shadowEnabled)\n {\n computeShadowOfDirectionalLights(v_WorldPosition, shadowContribsDir);\n }\n#endif\n for(int _idx_ = 0; _idx_ < DIRECTIONAL_LIGHT_COUNT; _idx_++)\n {{\n vec3 L = -normalize(directionalLightDirection[_idx_]);\n vec3 lc = directionalLightColor[_idx_];\n vec3 H = normalize(L + V);\n float ndl = clamp(dot(N, L), 0.0, 1.0);\n float ndh = clamp(dot(N, H), 0.0, 1.0);\n float shadowContrib = 1.0;\n#if defined(DIRECTIONAL_LIGHT_SHADOWMAP_COUNT)\n if(shadowEnabled)\n {\n shadowContrib = shadowContribsDir[_idx_];\n }\n#endif\n vec3 li = lc * ndl * shadowContrib;\n diffuseTerm += li;\n specularTerm += li * fresnelTerm * D_Phong(g, ndh);\n }}\n#endif\n#ifdef SPOT_LIGHT_COUNT\n#if defined(SPOT_LIGHT_SHADOWMAP_COUNT)\n float shadowContribsSpot[SPOT_LIGHT_COUNT];\n if(shadowEnabled)\n {\n computeShadowOfSpotLights(v_WorldPosition, shadowContribsSpot);\n }\n#endif\n for(int i = 0; i < SPOT_LIGHT_COUNT; i++)\n {\n vec3 lightPosition = spotLightPosition[i];\n vec3 spotLightDirection = -normalize(spotLightDirection[i]);\n vec3 lc = spotLightColor[i];\n float range = spotLightRange[i];\n float a = spotLightUmbraAngleCosine[i];\n float b = spotLightPenumbraAngleCosine[i];\n float falloffFactor = spotLightFalloffFactor[i];\n vec3 L = lightPosition - v_WorldPosition;\n float dist = length(L);\n float attenuation = lightAttenuation(dist, range);\n L /= dist;\n float c = dot(spotLightDirection, L);\n float falloff;\n falloff = clamp((c - a) /(b - a), 0.0, 1.0);\n falloff = pow(falloff, falloffFactor);\n vec3 H = normalize(L + V);\n float ndl = clamp(dot(N, L), 0.0, 1.0);\n float ndh = clamp(dot(N, H), 0.0, 1.0);\n float shadowContrib = 1.0;\n#if defined(SPOT_LIGHT_SHADOWMAP_COUNT)\n if (shadowEnabled)\n {\n shadowContrib = shadowContribsSpot[i];\n }\n#endif\n vec3 li = lc * attenuation * (1.0 - falloff) * shadowContrib * ndl;\n diffuseTerm += li;\n specularTerm += li * fresnelTerm * D_Phong(g, ndh);\n }\n#endif\n vec4 outColor = albedoColor;\n outColor.rgb *= max(diffuseTerm, vec3(0.0));\n outColor.rgb += max(specularTerm, vec3(0.0));\n#ifdef AMBIENT_CUBEMAP_LIGHT_COUNT\n vec3 L = reflect(-V, N);\n float rough2 = clamp(1.0 - g, 0.0, 1.0);\n float bias2 = rough2 * 5.0;\n vec2 brdfParam2 = texture2D(ambientCubemapLightBRDFLookup[0], vec2(rough2, ndv)).xy;\n vec3 envWeight2 = spec * brdfParam2.x + brdfParam2.y;\n vec3 envTexel2;\n for(int _idx_ = 0; _idx_ < AMBIENT_CUBEMAP_LIGHT_COUNT; _idx_++)\n {{\n #ifdef SUPPORT_TEXTURE_LOD\n envTexel2 = RGBMDecode(textureCubeLodEXT(ambientCubemapLightCubemap[_idx_], L, bias2), 8.12);\n #else\n envTexel2 = RGBMDecode(textureCube(ambientCubemapLightCubemap[_idx_], L), 8.12);\n #endif\n outColor.rgb += ambientCubemapLightColor[_idx_] * envTexel2 * envWeight2;\n }}\n#endif\n#ifdef ENVIRONMENTMAP_ENABLED\n vec3 envWeight = g * fresnelTerm;\n vec3 L = reflect(-V, N);\n #ifdef PARALLAX_CORRECTED\n L = parallaxCorrect(L, v_WorldPosition, environmentBoxMin, environmentBoxMax);\n#endif\n #ifdef ENVIRONMENTMAP_PREFILTER\n float rough = clamp(1.0 - g, 0.0, 1.0);\n float bias = rough * maxMipmapLevel;\n #ifdef SUPPORT_TEXTURE_LOD\n vec3 envTexel = decodeHDR(textureCubeLodEXT(environmentMap, L, bias)).rgb;\n #else\n vec3 envTexel = decodeHDR(textureCube(environmentMap, L)).rgb;\n #endif\n #ifdef BRDFLOOKUP_ENABLED\n vec2 brdfParam = texture2D(brdfLookup, vec2(rough, ndv)).xy;\n envWeight = spec * brdfParam.x + brdfParam.y;\n #endif\n #else\n vec3 envTexel = textureCube(environmentMap, L).xyz;\n #endif\n outColor.rgb += envTexel * envWeight;\n#endif\n float aoFactor = 1.0;\n#ifdef SSAOMAP_ENABLED\n aoFactor = min(texture2D(ssaoMap, (gl_FragCoord.xy - viewport.xy) / viewport.zw).r, aoFactor);\n#endif\n#ifdef AOMAP_ENABLED\n aoFactor = min(1.0 - clamp((1.0 - texture2D(aoMap, v_Texcoord2).r) * aoIntensity, 0.0, 1.0), aoFactor);\n#endif\n#ifdef OCCLUSIONMAP_ENABLED\n aoFactor = min(1.0 - clamp((1.0 - texture2D(occlusionMap, v_Texcoord).r), 0.0, 1.0), aoFactor);\n#endif\n outColor.rgb *= aoFactor;\n vec3 lEmission = emission;\n#ifdef EMISSIVEMAP_ENABLED\n lEmission *= texture2D(emissiveMap, uv).rgb;\n#endif\n outColor.rgb += lEmission * emissionIntensity;\n if(lineWidth > 0.)\n {\n outColor.rgb = mix(outColor.rgb, lineColor.rgb, (1.0 - edgeFactor(lineWidth)) * lineColor.a);\n }\n#ifdef ALPHA_TEST\n if (outColor.a < alphaCutoff) {\n discard;\n }\n#endif\n#ifdef TONEMAPPING\n outColor.rgb = ACESToneMapping(outColor.rgb);\n#endif\n#ifdef SRGB_ENCODE\n outColor = linearTosRGB(outColor);\n#endif\n gl_FragColor = encodeHDR(outColor);\n}\n@end\n@export clay.standardMR.vertex\n@import clay.standard.vertex\n@end\n@export clay.standardMR.fragment\n#define USE_METALNESS\n#define USE_ROUGHNESS\n@import clay.standard.fragment\n@end");en.import(vo);var xo,bo=["diffuseMap","normalMap","roughnessMap","metalnessMap","emissiveMap","environmentMap","brdfLookup","ssaoMap","aoMap"],wo=["color","emission","emissionIntensity","alpha","roughness","metalness","uvRepeat","uvOffset","aoIntensity","alphaCutoff","normalScale"],To=["linear","encodeRGBM","decodeRGBM","doubleSided","alphaTest","roughnessChannel","metalnessChannel","environmentMapPrefiltered"],Eo={roughnessChannel:"ROUGHNESS_CHANNEL",metalnessChannel:"METALNESS_CHANNEL"},Co={linear:"SRGB_DECODE",encodeRGBM:"RGBM_ENCODE",decodeRGBM:"RGBM_DECODE",doubleSided:"DOUBLE_SIDED",alphaTest:"ALPHA_TEST",environmentMapPrefiltered:"ENVIRONMENTMAP_PREFILTER"},So=Sn.extend(function(){return xo||(xo=new en(en.source("clay.standardMR.vertex"),en.source("clay.standardMR.fragment"))),{shader:xo}},function(t){ut.extend(this,t),ut.defaults(this,{color:[1,1,1],emission:[0,0,0],emissionIntensity:0,roughness:.5,metalness:0,alpha:1,alphaTest:!1,alphaCutoff:.9,normalScale:1,doubleSided:!1,diffuseMap:null,normalMap:null,roughnessMap:null,metalnessMap:null,emissiveMap:null,environmentMap:null,environmentBox:null,brdfLookup:null,ssaoMap:null,aoMap:null,uvRepeat:[1,1],uvOffset:[0,0],aoIntensity:1,environmentMapPrefiltered:!1,linear:!1,encodeRGBM:!1,decodeRGBM:!1,roughnessChannel:0,metalnessChannel:1})},{clone:function(){var t=new So({name:this.name});return bo.forEach(function(e){this[e]&&(t[e]=this[e])},this),wo.concat(To).forEach(function(e){t[e]=this[e]},this),t}});wo.forEach(function(t){Object.defineProperty(So.prototype,t,{get:function(){return this.get(t)},set:function(e){this.setUniform(t,e)}})}),bo.forEach(function(t){Object.defineProperty(So.prototype,t,{get:function(){return this.get(t)},set:function(e){this.setUniform(t,e)}})}),To.forEach(function(t){var e="_"+t;Object.defineProperty(So.prototype,t,{get:function(){return this[e]},set:function(r){if(this[e]=r,t in Eo){var n=Eo[t];this.define("fragment",n,r)}else{n=Co[t];r?this.define("fragment",n):this.undefine("fragment",n)}}})}),Object.defineProperty(So.prototype,"environmentBox",{get:function(){var t=this._environmentBox;return t&&(t.min.setArray(this.get("environmentBoxMin")),t.max.setArray(this.get("environmentBoxMax"))),t},set:function(t){this._environmentBox=t;var e=this.uniforms=this.uniforms||{};e.environmentBoxMin=e.environmentBoxMin||{value:null},e.environmentBoxMax=e.environmentBoxMax||{value:null},t&&(this.setUniform("environmentBoxMin",t.min.array),this.setUniform("environmentBoxMax",t.max.array)),t?this.define("fragment","PARALLAX_CORRECTED"):this.undefine("fragment","PARALLAX_CORRECTED")}});var Ao=So,Mo={};function Po(){this._pool={}}Po.prototype.get=function(t){var e=t;if(this._pool[e])return this._pool[e];var r=Mo[t];if(r){var n=new en(r.vertex,r.fragment);return this._pool[e]=n,n}console.error('Shader "'+t+'" is not in the library')},Po.prototype.clear=function(){this._pool={}};var Ro,Lo=new Po,Oo={createLibrary:function(){return new Po},get:function(){return Lo.get.apply(Lo,arguments)},template:function(t,e,r){Mo[t]={vertex:e,fragment:r}},clear:function(){return Lo.clear()}},ko=ct.extend({name:"",index:-1,node:null}),Do=new et,Io=new Ge,No=ct.extend(function(){return{relativeRootNode:null,name:"",joints:[],boundingBox:null,_clips:[],_invBindPoseMatricesArray:null,_jointMatricesSubArrays:[],_skinMatricesArray:null,_skinMatricesSubArrays:[],_subSkinMatricesArray:{}}},{addClip:function(t,e){for(var r=0;r<this._clips.length;r++)if(this._clips[r].clip===t)return;var n=[];for(r=0;r<this.joints.length;r++)n[r]=-1;for(r=0;r<t.tracks.length;r++)for(var i=0;i<this.joints.length;i++){var o=this.joints[i],a=t.tracks[r],s=o.name;if(e&&(s=e[s]),a.name===s){n[i]=r;break}}return this._clips.push({maps:n,clip:t}),this._clips.length-1},removeClip:function(t){for(var e=-1,r=0;r<this._clips.length;r++)if(this._clips[r].clip===t){e=r;break}e>0&&this._clips.splice(e,1)},removeClipsAll:function(){this._clips=[]},getClip:function(t){if(this._clips[t])return this._clips[t].clip},getClipNumber:function(){return this._clips.length},updateJointMatrices:(Ro=K.create(),function(){this._invBindPoseMatricesArray=new Float32Array(16*this.joints.length),this._skinMatricesArray=new Float32Array(16*this.joints.length);for(var t=0;t<this.joints.length;t++){var e=this.joints[t];K.copy(Ro,e.node.worldTransform.array),K.invert(Ro,Ro);for(var r=16*t,n=0;n<16;n++)this._invBindPoseMatricesArray[r+n]=Ro[n]}this.updateMatricesSubArrays()}),updateJointsBoundingBoxes:function(t){for(var e=t.attributes,r=e.position,n=e.joint,i=e.weight,o=[],a=0;a<this.joints.length;a++)o[a]=new et,o[a].__updated=!1;var s=[],h=[],u=[],l=0;for(a=0;a<t.vertexCount;a++){n.get(a,s),r.get(a,h),i.get(a,u);for(var c=0;c<4;c++)if(u[c]>.01){var f=s[c];l=Math.max(l,f);var d=o[f].min.array,p=o[f].max.array;o[f].__updated=!0,d=D.min(d,d,h),p=D.max(p,p,h)}}this._jointsBoundingBoxes=o,this.boundingBox=new et,l<this.joints.length-1&&console.warn("Geometry joints and skeleton joints don't match")},setJointMatricesArray:function(t){this._invBindPoseMatricesArray=t,this._skinMatricesArray=new Float32Array(t.length),this.updateMatricesSubArrays()},updateMatricesSubArrays:function(){for(var t=0;t<this.joints.length;t++)this._jointMatricesSubArrays[t]=this._invBindPoseMatricesArray.subarray(16*t,16*(t+1)),this._skinMatricesSubArrays[t]=this._skinMatricesArray.subarray(16*t,16*(t+1))},update:function(){this._setPose();for(var t=this._jointsBoundingBoxes,e=0;e<this.joints.length;e++){var r=this.joints[e];K.multiply(this._skinMatricesSubArrays[e],r.node.worldTransform.array,this._jointMatricesSubArrays[e])}if(this.boundingBox){this.boundingBox.min.set(1/0,1/0,1/0),this.boundingBox.max.set(-1/0,-1/0,-1/0);for(e=0;e<this.joints.length;e++){r=this.joints[e];var n=t[e];n.__updated&&(Do.copy(n),Io.array=this._skinMatricesSubArrays[e],Do.applyTransform(Io),this.boundingBox.union(Do))}}},getSubSkinMatrices:function(t,e){var r=this._subSkinMatricesArray[t];r||(r=this._subSkinMatricesArray[t]=new Float32Array(16*e.length));for(var n=0,i=0;i<e.length;i++)for(var o=e[i],a=0;a<16;a++)r[n++]=this._skinMatricesArray[16*o+a];return r},getSubSkinMatricesTexture:function(t,e){var r,n=this.getSubSkinMatrices(t,e),i=this.joints.length;r=i>256?64:i>64?32:i>16?16:8;var o=this._skinMatricesTexture=this._skinMatricesTexture||new br({type:mr.FLOAT,minFilter:mr.NEAREST,magFilter:mr.NEAREST,useMipmap:!1,flipY:!1});return o.width=r,o.height=r,o.pixels&&o.pixels.length===r*r*4||(o.pixels=new Float32Array(r*r*4)),o.pixels.set(n),o.dirty(),o},getSkinMatricesTexture:function(){return this._skinMatricesTexture},_setPose:function(){if(this._clips[0])for(var t=this._clips[0].clip,e=this._clips[0].maps,r=0;r<this.joints.length;r++){var n=this.joints[r];if(-1!==e[r]){var i=t.tracks[e[r]];i.channels.position&&D.copy(n.node.position.array,i.position),i.channels.rotation&&de.copy(n.node.rotation.array,i.rotation),i.channels.scale&&D.copy(n.node.scale.array,i.scale),n.node.position._dirty=!0,n.node.rotation._dirty=!0,n.node.scale._dirty=!0}}},clone:function(t){var e=new No;e.name=this.name;for(var r=0;r<this.joints.length;r++){var n=new ko,i=this.joints[r];if(n.name=i.name,n.index=i.index,t){var o=t[i.node.__uid__];o||console.warn("Can't find node"),n.node=o||i.node}else n.node=i.node;e.joints.push(n)}if(this._invBindPoseMatricesArray){var a=this._invBindPoseMatricesArray.length;e._invBindPoseMatricesArray=new Float32Array(a);for(r=0;r<a;r++)e._invBindPoseMatricesArray[r]=this._invBindPoseMatricesArray[r];e._skinMatricesArray=new Float32Array(a),e.updateMatricesSubArrays()}return e._jointsBoundingBoxe=(this._jointsBoundingBoxes||[]).map(function(t){return t.clone()}),e.update(),e}}),Fo=No,Bo={NORMAL:"normal",POSITION:"position",TEXCOORD_0:"texcoord0",TEXCOORD_1:"texcoord1",WEIGHTS_0:"weight",JOINTS_0:"joint",COLOR_0:"color"},zo={5120:G.a.Int8Array,5121:G.a.Uint8Array,5122:G.a.Int16Array,5123:G.a.Uint16Array,5125:G.a.Uint32Array,5126:G.a.Float32Array},Uo={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function Ho(t,e,r,n){var i=t.accessors[r],o=e.bufferViews[i.bufferView],a=i.byteOffset||0,s=zo[i.componentType]||G.a.Float32Array,h=Uo[i.type];null==h&&n&&(h=1);var u=new s(o,a,h*i.count),l=i.extensions&&i.extensions.WEB3D_quantized_attributes;if(l){for(var c=new G.a.Float32Array(h*i.count),f=l.decodeMatrix,d=new Array(h),p=new Array(h),m=0;m<h;m++)d[m]=f[h*(h+1)+m],p[m]=f[m*(h+1)+m];for(var g=0;g<i.count;g++)for(m=0;m<h;m++)c[g*h+m]=u[g*h+m]*p[m]+d[m];u=c}return u}var jo=ct.extend({rootNode:null,rootPath:null,textureRootPath:null,bufferRootPath:null,shader:"clay.standard",useStandardMaterial:!1,includeCamera:!0,includeAnimation:!0,includeMesh:!0,includeTexture:!0,crossOrigin:"",textureFlipY:!1,textureConvertToPOT:!1,shaderLibrary:null},function(){this.shaderLibrary||(this.shaderLibrary=Oo.createLibrary())},{load:function(t){var e=this,r=t.endsWith(".glb");null==this.rootPath&&(this.rootPath=t.slice(0,t.lastIndexOf("/"))),G.a.request.get({url:t,onprogress:function(t,r,n){e.trigger("progress",t,r,n)},onerror:function(t){e.trigger("error",t)},responseType:r?"arraybuffer":"text",onload:function(t){r?e.parseBinary(t):("string"==typeof t&&(t=JSON.parse(t)),e.parse(t))}})},parseBinary:function(t){var e=new Uint32Array(t,0,4);if(1179937895===e[0])if(e[0]<2)this.trigger("error","Only glTF2.0 is supported.");else{for(var r,n=new DataView(t,12),i=[],o=0;o<n.byteLength;){var a=n.getUint32(o,!0);o+=4;var s=n.getUint32(o,!0);if(o+=4,1313821514===s){var h=new Uint8Array(t,o+12,a),u=(new TextDecoder).decode(h);try{r=JSON.parse(u)}catch(t){return void this.trigger("error","JSON Parse error:"+t.toString())}}else 5130562===s&&i.push(t.slice(o+12,o+12+a));o+=a}if(r)return this.parse(r,i);this.trigger("error","Invalid glTF binary format: Can't find JSON.")}else this.trigger("error","Invalid glTF binary format: Invalid header")},parse:function(t,e){var r=this,n={json:t,buffers:[],bufferViews:[],materials:[],textures:[],meshes:[],joints:[],skeletons:[],cameras:[],nodes:[],clips:[]},i=this.rootNode||new Wi,o=0;function a(){0===--o&&h()}function s(){return{json:t,scene:r.rootNode?null:i,rootNode:r.rootNode?i:null,cameras:n.cameras,textures:n.textures,materials:n.materials,skeletons:n.skeletons,meshes:n.instancedMeshes,clips:n.clips,nodes:n.nodes}}function h(e){if(n.buffers.length===t.buffers.length){if(t.bufferViews.forEach(function(t,e){n.bufferViews[e]=n.buffers[t.buffer].slice(t.byteOffset||0,(t.byteOffset||0)+(t.byteLength||0))}),n.buffers=null,r.includeMesh&&(r.includeTexture&&r._parseTextures(t,n),r._parseMaterials(t,n),r._parseMeshes(t,n)),r._parseNodes(t,n),t.scenes){var o=t.scenes[t.scene||0];if(o)for(var a=0;a<o.nodes.length;a++){var h=n.nodes[o.nodes[a]];h.update(),i.add(h)}}r.includeMesh&&r._parseSkins(t,n),r.includeAnimation&&r._parseAnimations(t,n),e?setTimeout(function(){r.trigger("success",s())}):r.trigger("success",s())}else setTimeout(function(){r.trigger("error","Buffer not load complete.")})}return e?(n.buffers=e.slice(),h(!0)):ut.each(t.buffers,function(t,e){o++;var i=t.uri;r._loadBuffer(i,function(t){n.buffers[e]=t,a()},a)}),s()},resolveBinaryPath:function(t){if(t&&t.match(/^data:(.*?)base64,/))return t;var e=this.bufferRootPath;return null==e&&(e=this.rootPath),ut.relative2absolute(t,e)},resolveTexturePath:function(t){if(t&&t.match(/^data:(.*?)base64,/))return t;var e=this.textureRootPath;return null==e&&(e=this.rootPath),ut.relative2absolute(t,e)},_getShader:function(){return"string"==typeof this.shader?this.shaderLibrary.get(this.shader):this.shader instanceof en?this.shader:void 0},_loadBuffer:function(t,e,r){G.a.request.get({url:this.resolveBinaryPath(t),responseType:"arraybuffer",onload:function(t){e&&e(t)},onerror:function(t){r&&r(t)}})},_parseSkins:function(t,e){function r(t,e,r){t.skeleton=e,t.joints=r,e.boundingBox||e.updateJointsBoundingBoxes(t.geometry)}function n(t){return t.index}ut.each(t.skins,function(r,n){for(var i=new Fo({name:r.name}),o=0;o<r.joints.length;o++){var a=r.joints[o],s=e.nodes[a],h=new ko({name:s.name,node:s,index:i.joints.length});i.joints.push(h)}if(i.relativeRootNode=e.nodes[r.skeleton]||this.rootNode,r.inverseBindMatrices){!0;var u=t.accessors[r.inverseBindMatrices],l=e.bufferViews[u.bufferView],c=u.byteOffset||0,f=16*u.count,d=new G.a.Float32Array(l,c,f);i.setJointMatricesArray(d)}else i.updateJointMatrices();e.skeletons[n]=i},this),ut.each(t.nodes,function(t,i){if(null!=t.skin){var o=t.skin,a=e.skeletons[o],s=e.nodes[i],h=a.joints.map(n);if(s instanceof Rn)r(s,a,h);else for(var u=s.children(),l=0;l<u.length;l++)r(u[l],a,h)}},this)},_parseTextures:function(t,e){ut.each(t.textures,function(r,n){var i=t.samplers&&t.samplers[r.sampler]||{},o={};["wrapS","wrapT","magFilter","minFilter"].forEach(function(t){var e=i[t];null!=e&&(o[t]=e)}),ut.defaults(o,{wrapS:mr.REPEAT,wrapT:mr.REPEAT,flipY:this.textureFlipY,convertToPOT:this.textureConvertToPOT});var a=r.target||ft.TEXTURE_2D,s=r.format;if(null!=s&&(o.format=s),a===ft.TEXTURE_2D){var h,u=new br(o),l=t.images[r.source];l.uri?h=this.resolveTexturePath(l.uri):null!=l.bufferView&&(h=URL.createObjectURL(new Blob([e.bufferViews[l.bufferView]],{type:l.mimeType}))),h&&(u.load(h,this.crossOrigin),e.textures[n]=u)}},this)},_KHRCommonMaterialToStandard:function(t,e){var r={};"number"==typeof(r=t.extensions.KHR_materials_common.values||{}).diffuse&&(r.diffuse=e.textures[r.diffuse]||null),"number"==typeof r.emission&&(r.emission=e.textures[r.emission]||null);var n,i=[];r.diffuse instanceof br&&i.push("diffuseMap"),t.normalTexture&&i.push("normalMap"),r.emission instanceof br&&i.push("emissiveMap");var o=this.useStandardMaterial;o?n=new Ao({name:t.name,doubleSided:t.doubleSided}):((n=new Sn({name:t.name,shader:this._getShader()})).define("fragment","USE_ROUGHNESS"),n.define("fragment","USE_METALNESS"),t.doubleSided&&n.define("fragment","DOUBLE_SIDED")),r.transparent&&(n.depthMask=!1,n.depthTest=!0,n.transparent=!0);var a=r.diffuse;a&&(Array.isArray(a)?(a=a.slice(0,3),o?n.color=a:n.set("color",a)):o?n.diffuseMap=a:n.set("diffuseMap",a));var s=r.emission;if(null!=s&&(Array.isArray(s)?(s=s.slice(0,3),o?n.emission=s:n.set("emission",s)):o?n.emissiveMap=s:n.set("emissiveMap",s)),null!=t.normalTexture){var h=t.normalTexture.index;o?n.normalMap=e.textures[h]||null:n.set("normalMap",e.textures[h]||null)}if(null!=r.shininess){var u=Math.log(r.shininess)/Math.log(8192);n.set("glossiness",u),n.set("roughness",1-u)}else n.set("glossiness",.3),n.set("roughness",.3);return null!=r.specular&&n.set("specularColor",r.specular.slice(0,3)),null!=r.transparency&&n.set("alpha",r.transparency),n},_pbrMetallicRoughnessToStandard:function(t,e,r){var n,i,o,a,s,h,u,l="MASK"===t.alphaMode,c=this.useStandardMaterial,f=[],d=1;e.baseColorTexture&&(i=r.textures[e.baseColorTexture.index]||null)&&f.push("diffuseMap"),e.metallicRoughnessTexture&&(o=a=r.textures[e.metallicRoughnessTexture.index]||null)&&f.push("metalnessMap","roughnessMap"),t.normalTexture&&((s=r.textures[t.normalTexture.index]||null)&&f.push("normalMap"),"number"==typeof t.normalTexture.scale&&(d=t.normalTexture.scale)),t.emissiveTexture&&(h=r.textures[t.emissiveTexture.index]||null)&&f.push("emissiveMap"),t.occlusionTexture&&(u=r.textures[t.occlusionTexture.index]||null)&&f.push("occlusionMap");var p=e.baseColorFactor||[1,1,1,1],m={diffuseMap:i||null,roughnessMap:o||null,metalnessMap:a||null,normalMap:s||null,occlusionMap:u||null,emissiveMap:h||null,color:p.slice(0,3),alpha:p[3],metalness:e.metallicFactor||0,roughness:e.roughnessFactor||0,emission:t.emissiveFactor||[0,0,0],emissionIntensity:1,alphaCutoff:t.alphaCutoff||0,normalScale:d};return m.roughnessMap&&(m.metalness=.5,m.roughness=.5),c?n=new Ao(ut.extend({name:t.name,alphaTest:l,doubleSided:t.doubleSided,roughnessChannel:1,metalnessChannel:2},m)):((n=new Sn({name:t.name,shader:this._getShader()})).define("fragment","USE_ROUGHNESS"),n.define("fragment","USE_METALNESS"),n.define("fragment","ROUGHNESS_CHANNEL",1),n.define("fragment","METALNESS_CHANNEL",2),n.define("fragment","DIFFUSEMAP_ALPHA_ALPHA"),l&&n.define("fragment","ALPHA_TEST"),t.doubleSided&&n.define("fragment","DOUBLE_SIDED"),n.set(m)),"BLEND"===t.alphaMode&&(n.depthMask=!1,n.depthTest=!0,n.transparent=!0),n},_pbrSpecularGlossinessToStandard:function(t,e,r){var n,i,o,a,s,h,u,l="MASK"===t.alphaMode;this.useStandardMaterial&&console.error("StandardMaterial doesn't support specular glossiness workflow yet");var c=[];e.diffuseTexture&&(i=r.textures[e.diffuseTexture.index]||null)&&c.push("diffuseMap"),e.specularGlossinessTexture&&(o=a=r.textures[e.specularGlossinessTexture.index]||null)&&c.push("specularMap","glossinessMap"),t.normalTexture&&(s=r.textures[t.normalTexture.index]||null)&&c.push("normalMap"),t.emissiveTexture&&(h=r.textures[t.emissiveTexture.index]||null)&&c.push("emissiveMap"),t.occlusionTexture&&(u=r.textures[t.occlusionTexture.index]||null)&&c.push("occlusionMap");var f=e.diffuseFactor||[1,1,1,1],d={diffuseMap:i||null,glossinessMap:o||null,specularMap:a||null,normalMap:s||null,emissiveMap:h||null,occlusionMap:u||null,color:f.slice(0,3),alpha:f[3],specularColor:e.specularFactor||[1,1,1],glossiness:e.glossinessFactor||0,emission:t.emissiveFactor||[0,0,0],emissionIntensity:1,alphaCutoff:null==t.alphaCutoff?.9:t.alphaCutoff};return d.glossinessMap&&(d.glossiness=.5),d.specularMap&&(d.specularColor=[1,1,1]),(n=new Sn({name:t.name,shader:this._getShader()})).define("fragment","GLOSSINESS_CHANNEL",3),n.define("fragment","DIFFUSEMAP_ALPHA_ALPHA"),l&&n.define("fragment","ALPHA_TEST"),t.doubleSided&&n.define("fragment","DOUBLE_SIDED"),n.set(d),"BLEND"===t.alphaMode&&(n.depthMask=!1,n.depthTest=!0,n.transparent=!0),n},_parseMaterials:function(t,e){ut.each(t.materials,function(t,r){t.extensions&&t.extensions.KHR_materials_common?e.materials[r]=this._KHRCommonMaterialToStandard(t,e):t.extensions&&t.extensions.KHR_materials_pbrSpecularGlossiness?e.materials[r]=this._pbrSpecularGlossinessToStandard(t,t.extensions.KHR_materials_pbrSpecularGlossiness,e):e.materials[r]=this._pbrMetallicRoughnessToStandard(t,t.pbrMetallicRoughness||{},e)},this)},_parseMeshes:function(t,e){var r=this;ut.each(t.meshes,function(n,i){e.meshes[i]=[];for(var o=0;o<n.primitives.length;o++){for(var a=n.primitives[o],s=new At({dynamic:!1,name:n.name,boundingBox:new et}),h=Object.keys(a.attributes),u=0;u<h.length;u++){var l=h[u],c=a.attributes[l],f=t.accessors[c],d=Bo[l];if(d){var p=Uo[f.type],m=Ho(t,e,c);if(m instanceof G.a.Uint32Array&&(m=new Float32Array(m)),"WEIGHTS_0"===l&&4===p){for(var g=new m.constructor(3*f.count),_=0;_<f.count;_++){var y=3*_,v=m[E=4*_],x=m[E+1],b=m[E+2],w=v+x+b+m[E+3];g[y]=v/w,g[y+1]=x/w,g[y+2]=b/w}s.attributes[d].value=g}else if("COLOR_0"===l&&3===p){var T=new m.constructor(4*f.count);for(_=0;_<f.count;_++){var E;y=3*_;T[E=4*_]=m[y],T[E+1]=m[y+1],T[E+2]=m[y+2],T[E+3]=1}s.attributes[d].value=T}else s.attributes[d].value=m;var C="float";if(m instanceof G.a.Uint16Array?C="ushort":m instanceof G.a.Int16Array?C="short":m instanceof G.a.Uint8Array?C="ubyte":m instanceof G.a.Int8Array&&(C="byte"),s.attributes[d].type=C,"POSITION"===l){var S=f.min,A=f.max;S&&s.boundingBox.min.set(S[0],S[1],S[2]),A&&s.boundingBox.max.set(A[0],A[1],A[2])}}}null!=a.indices&&(s.indices=Ho(t,e,a.indices,!0),s.vertexCount<=65535&&s.indices instanceof G.a.Uint32Array&&(s.indices=new G.a.Uint16Array(s.indices)),s.indices instanceof G.a.Uint8Array&&(s.indices=new G.a.Uint16Array(s.indices)));var M=e.materials[a.material],P=(t.materials||[])[a.material];M||(M=new Sn({shader:r._getShader()}));var R=new Rn({geometry:s,material:M,mode:[Rn.POINTS,Rn.LINES,Rn.LINE_LOOP,Rn.LINE_STRIP,Rn.TRIANGLES,Rn.TRIANGLE_STRIP,Rn.TRIANGLE_FAN][a.mode]||Rn.TRIANGLES,ignoreGBuffer:M.transparent});null!=P&&(R.culling=!P.doubleSided),R.geometry.attributes.normal.value||R.geometry.generateVertexNormals(),(M instanceof Ao&&M.normalMap||M.isTextureEnabled("normalMap"))&&(R.geometry.attributes.tangent.value||R.geometry.generateTangents()),R.geometry.attributes.color.value&&R.material.define("VERTEX_COLOR"),R.name=jo.generateMeshName(t.meshes,i,o),e.meshes[i].push(R)}},this)},_instanceCamera:function(t,e){var r=t.cameras[e.camera];if("perspective"===r.type){var n=r.perspective||{};return new cr({name:e.name,aspect:n.aspectRatio,fov:n.yfov/Math.PI*180,far:n.zfar,near:n.znear})}var i=r.orthographic||{};return new lr({name:e.name,top:i.ymag,right:i.xmag,left:-i.xmag,bottom:-i.ymag,near:i.znear,far:i.zfar})},_parseNodes:function(t,e){function r(t){return new Rn({name:t.name,geometry:t.geometry,material:t.material,culling:t.culling,mode:t.mode})}e.instancedMeshes=[],ut.each(t.nodes,function(n,i){var o;if(null!=n.camera&&this.includeCamera)o=this._instanceCamera(t,n),e.cameras.push(o);else if(null!=n.mesh&&this.includeMesh){var a=e.meshes[n.mesh];if(a)if(1===a.length)(o=r(a[0])).setName(n.name),e.instancedMeshes.push(o);else{(o=new We).setName(n.name);for(var s=0;s<a.length;s++){var h=r(a[s]);o.add(h),e.instancedMeshes.push(h)}}}else(o=new We).setName(n.name);n.matrix?(o.localTransform.setArray(n.matrix),o.decomposeLocalTransform()):(n.translation&&o.position.setArray(n.translation),n.rotation&&o.rotation.setArray(n.rotation),n.scale&&o.scale.setArray(n.scale)),e.nodes[i]=o},this),ut.each(t.nodes,function(t,r){var n=e.nodes[r];if(t.children)for(var i=0;i<t.children.length;i++){var o=t.children[i],a=e.nodes[o];n.add(a)}})},_parseAnimations:function(t,e){function r(t){return"weights"!==t.path||(console.warn("GLTFLoader not support morph targets yet."),!1)}function n(t,e){return t.target.node+"_"+e.samplers[t.sampler].input}var i={};ut.each(t.animations,function(o,a){var s=o.channels.filter(r);if(s.length){for(var h={},u=0;u<s.length;u++){var l=s[u],c=n(l,o),f=e.nodes[l.target.node],d=h[c],p=o.samplers[l.sampler];if(!d){(d=h[c]=new ye({name:f?f.name:"",target:f})).targetNodeIndex=l.target.node,d.channels.time=Ho(t,e,p.input);var m=d.channels.time.length;if(!i[p.input]){for(var g=0;g<m;g++)d.channels.time[g]*=1e3;i[p.input]=!0}}"LINEAR"!==(p.interpolation||"LINEAR")&&console.warn("GLTFLoader only support LINEAR interpolation.");var _=l.target.path;"translation"===_&&(_="position"),d.channels[_]=Ho(t,e,p.output)}var y=[];for(var v in h)y.push(h[v]);var x=new be({name:o.name,loop:!0,tracks:y});e.clips.push(x)}},this);var o=e.clips.reduce(function(t,e){return Math.max(t,e.life)},0);return e.clips.forEach(function(t){t.life=o}),e.clips}});jo.generateMeshName=function(t,e,r){var n=t[e].name||"mesh_"+e;return 0===r?n:n+"$"+r};var Go=jo,Vo=function(){this.array=Ei.create(),this._dirty=!0};Vo.prototype={constructor:Vo,setArray:function(t){for(var e=0;e<this.array.length;e++)this.array[e]=t[e];return this._dirty=!0,this},clone:function(){return(new Vo).copy(this)},copy:function(t){return Ei.copy(this.array,t.array),this._dirty=!0,this},adjoint:function(){return Ei.adjoint(this.array,this.array),this._dirty=!0,this},determinant:function(){return Ei.determinant(this.array)},identity:function(){return Ei.identity(this.array),this._dirty=!0,this},invert:function(){return Ei.invert(this.array,this.array),this._dirty=!0,this},mul:function(t){return Ei.mul(this.array,this.array,t.array),this._dirty=!0,this},mulLeft:function(t){return Ei.mul(this.array,t.array,this.array),this._dirty=!0,this},multiply:function(t){return Ei.multiply(this.array,this.array,t.array),this._dirty=!0,this},multiplyLeft:function(t){return Ei.multiply(this.array,t.array,this.array),this._dirty=!0,this},rotate:function(t){return Ei.rotate(this.array,this.array,t),this._dirty=!0,this},scale:function(t){return Ei.scale(this.array,this.array,t.array),this._dirty=!0,this},transpose:function(){return Ei.transpose(this.array,this.array),this._dirty=!0,this},toString:function(){return"["+Array.prototype.join.call(this.array,",")+"]"},toArray:function(){return Array.prototype.slice.call(this.array)}},Vo.adjoint=function(t,e){return Ei.adjoint(t.array,e.array),t._dirty=!0,t},Vo.copy=function(t,e){return Ei.copy(t.array,e.array),t._dirty=!0,t},Vo.determinant=function(t){return Ei.determinant(t.array)},Vo.identity=function(t){return Ei.identity(t.array),t._dirty=!0,t},Vo.invert=function(t,e){return Ei.invert(t.array,e.array),t._dirty=!0,t},Vo.multiply=Vo.mul=function(t,e,r){return Ei.mul(t.array,e.array,r.array),t._dirty=!0,t},Vo.rotate=function(t,e,r){return Ei.rotate(t.array,e.array,r),t._dirty=!0,t},Vo.scale=function(t,e,r){return Ei.scale(t.array,e.array,r.array),t._dirty=!0,t},Vo.transpose=function(t,e){return Ei.transpose(t.array,e.array),t._dirty=!0,t};var Wo=function(){this.array=Si.create(),this._dirty=!0};Wo.prototype={constructor:Wo,setArray:function(t){for(var e=0;e<this.array.length;e++)this.array[e]=t[e];return this._dirty=!0,this},clone:function(){return(new Wo).copy(this)},copy:function(t){return Si.copy(this.array,t.array),this._dirty=!0,this},determinant:function(){return Si.determinant(this.array)},identity:function(){return Si.identity(this.array),this._dirty=!0,this},invert:function(){return Si.invert(this.array,this.array),this._dirty=!0,this},mul:function(t){return Si.mul(this.array,this.array,t.array),this._dirty=!0,this},mulLeft:function(t){return Si.mul(this.array,t.array,this.array),this._dirty=!0,this},multiply:function(t){return Si.multiply(this.array,this.array,t.array),this._dirty=!0,this},multiplyLeft:function(t){return Si.multiply(this.array,t.array,this.array),this._dirty=!0,this},rotate:function(t){return Si.rotate(this.array,this.array,t),this._dirty=!0,this},scale:function(t){return Si.scale(this.array,this.array,t.array),this._dirty=!0,this},translate:function(t){return Si.translate(this.array,this.array,t.array),this._dirty=!0,this},toString:function(){return"["+Array.prototype.join.call(this.array,",")+"]"},toArray:function(){return Array.prototype.slice.call(this.array)}},Wo.copy=function(t,e){return Si.copy(t.array,e.array),t._dirty=!0,t},Wo.determinant=function(t){return Si.determinant(t.array)},Wo.identity=function(t){return Si.identity(t.array),t._dirty=!0,t},Wo.invert=function(t,e){return Si.invert(t.array,e.array),t._dirty=!0,t},Wo.multiply=Wo.mul=function(t,e,r){return Si.mul(t.array,e.array,r.array),t._dirty=!0,t},Wo.rotate=function(t,e,r){return Si.rotate(t.array,e.array,r),t._dirty=!0,t},Wo.scale=function(t,e,r){return Si.scale(t.array,e.array,r.array),t._dirty=!0,t},Wo.translate=function(t,e,r){return Si.translate(t.array,e.array,r.array),t._dirty=!0,t};var Zo=function(){this.array=ce.create(),this._dirty=!0};Zo.prototype={constructor:Zo,setArray:function(t){for(var e=0;e<this.array.length;e++)this.array[e]=t[e];return this._dirty=!0,this},adjoint:function(){return ce.adjoint(this.array,this.array),this._dirty=!0,this},clone:function(){return(new Zo).copy(this)},copy:function(t){return ce.copy(this.array,t.array),this._dirty=!0,this},determinant:function(){return ce.determinant(this.array)},fromMat2d:function(t){return ce.fromMat2d(this.array,t.array),this._dirty=!0,this},fromMat4:function(t){return ce.fromMat4(this.array,t.array),this._dirty=!0,this},fromQuat:function(t){return ce.fromQuat(this.array,t.array),this._dirty=!0,this},identity:function(){return ce.identity(this.array),this._dirty=!0,this},invert:function(){return ce.invert(this.array,this.array),this._dirty=!0,this},mul:function(t){return ce.mul(this.array,this.array,t.array),this._dirty=!0,this},mulLeft:function(t){return ce.mul(this.array,t.array,this.array),this._dirty=!0,this},multiply:function(t){return ce.multiply(this.array,this.array,t.array),this._dirty=!0,this},multiplyLeft:function(t){return ce.multiply(this.array,t.array,this.array),this._dirty=!0,this},rotate:function(t){return ce.rotate(this.array,this.array,t),this._dirty=!0,this},scale:function(t){return ce.scale(this.array,this.array,t.array),this._dirty=!0,this},translate:function(t){return ce.translate(this.array,this.array,t.array),this._dirty=!0,this},normalFromMat4:function(t){return ce.normalFromMat4(this.array,t.array),this._dirty=!0,this},transpose:function(){return ce.transpose(this.array,this.array),this._dirty=!0,this},toString:function(){return"["+Array.prototype.join.call(this.array,",")+"]"},toArray:function(){return Array.prototype.slice.call(this.array)}},Zo.adjoint=function(t,e){return ce.adjoint(t.array,e.array),t._dirty=!0,t},Zo.copy=function(t,e){return ce.copy(t.array,e.array),t._dirty=!0,t},Zo.determinant=function(t){return ce.determinant(t.array)},Zo.identity=function(t){return ce.identity(t.array),t._dirty=!0,t},Zo.invert=function(t,e){return ce.invert(t.array,e.array),t},Zo.multiply=Zo.mul=function(t,e,r){return ce.mul(t.array,e.array,r.array),t._dirty=!0,t},Zo.fromMat2d=function(t,e){return ce.fromMat2d(t.array,e.array),t._dirty=!0,t},Zo.fromMat4=function(t,e){return ce.fromMat4(t.array,e.array),t._dirty=!0,t},Zo.fromQuat=function(t,e){return ce.fromQuat(t.array,e.array),t._dirty=!0,t},Zo.normalFromMat4=function(t,e){return ce.normalFromMat4(t.array,e.array),t._dirty=!0,t},Zo.rotate=function(t,e,r){return ce.rotate(t.array,e.array,r),t._dirty=!0,t},Zo.scale=function(t,e,r){return ce.scale(t.array,e.array,r.array),t._dirty=!0,t},Zo.transpose=function(t,e){return ce.transpose(t.array,e.array),t._dirty=!0,t},Zo.translate=function(t,e,r){return ce.translate(t.array,e.array,r.array),t._dirty=!0,t};var Xo=function(){};Xo.prototype.get=function(t){};var qo=function(t){this.get=function(){return t}};(qo.prototype=new Xo).constructor=qo;var Yo=function(t){var e=t.constructor;this.get=function(r){return r||(r=new e),r.copy(t),r}};(Yo.prototype=new Xo).constructor=Yo;var Jo=function(t,e){var r=e-t;this.get=function(){return Math.random()*r+t}};(Jo.prototype=new Xo).constructor=Jo;var Ko=function(t,e){var r=e.x-t.x,n=e.y-t.y;this.get=function(e){return e||(e=new re),re.set(e,r*Math.random()+t.array[0],n*Math.random()+t.array[1]),e}};(Ko.prototype=new Xo).constructor=Ko;var Qo=function(t,e){var r=e.x-t.x,n=e.y-t.y,i=e.z-t.z;this.get=function(e){return e||(e=new j),j.set(e,r*Math.random()+t.array[0],n*Math.random()+t.array[1],i*Math.random()+t.array[2]),e}};(Qo.prototype=new Xo).constructor=Qo,Xo.constant=function(t){return new qo(t)},Xo.vector=function(t){return new Yo(t)},Xo.random1D=function(t,e){return new Jo(t,e)},Xo.random2D=function(t,e){return new Ko(t,e)},Xo.random3D=function(t,e){return new Qo(t,e)};var $o=Xo,ta=function(t,e,r,n){t=t||0,e=e||0,r=r||0,n=n||0,this.array=oe.fromValues(t,e,r,n),this._dirty=!0};ta.prototype={constructor:ta,add:function(t){return oe.add(this.array,this.array,t.array),this._dirty=!0,this},set:function(t,e,r,n){return this.array[0]=t,this.array[1]=e,this.array[2]=r,this.array[3]=n,this._dirty=!0,this},setArray:function(t){return this.array[0]=t[0],this.array[1]=t[1],this.array[2]=t[2],this.array[3]=t[3],this._dirty=!0,this},clone:function(){return new ta(this.x,this.y,this.z,this.w)},copy:function(t){return oe.copy(this.array,t.array),this._dirty=!0,this},dist:function(t){return oe.dist(this.array,t.array)},distance:function(t){return oe.distance(this.array,t.array)},div:function(t){return oe.div(this.array,this.array,t.array),this._dirty=!0,this},divide:function(t){return oe.divide(this.array,this.array,t.array),this._dirty=!0,this},dot:function(t){return oe.dot(this.array,t.array)},len:function(){return oe.len(this.array)},length:function(){return oe.length(this.array)},lerp:function(t,e,r){return oe.lerp(this.array,t.array,e.array,r),this._dirty=!0,this},min:function(t){return oe.min(this.array,this.array,t.array),this._dirty=!0,this},max:function(t){return oe.max(this.array,this.array,t.array),this._dirty=!0,this},mul:function(t){return oe.mul(this.array,this.array,t.array),this._dirty=!0,this},multiply:function(t){return oe.multiply(this.array,this.array,t.array),this._dirty=!0,this},negate:function(){return oe.negate(this.array,this.array),this._dirty=!0,this},normalize:function(){return oe.normalize(this.array,this.array),this._dirty=!0,this},random:function(t){return oe.random(this.array,t),this._dirty=!0,this},scale:function(t){return oe.scale(this.array,this.array,t),this._dirty=!0,this},scaleAndAdd:function(t,e){return oe.scaleAndAdd(this.array,this.array,t.array,e),this._dirty=!0,this},sqrDist:function(t){return oe.sqrDist(this.array,t.array)},squaredDistance:function(t){return oe.squaredDistance(this.array,t.array)},sqrLen:function(){return oe.sqrLen(this.array)},squaredLength:function(){return oe.squaredLength(this.array)},sub:function(t){return oe.sub(this.array,this.array,t.array),this._dirty=!0,this},subtract:function(t){return oe.subtract(this.array,this.array,t.array),this._dirty=!0,this},transformMat4:function(t){return oe.transformMat4(this.array,this.array,t.array),this._dirty=!0,this},transformQuat:function(t){return oe.transformQuat(this.array,this.array,t.array),this._dirty=!0,this},toString:function(){return"["+Array.prototype.join.call(this.array,",")+"]"},toArray:function(){return Array.prototype.slice.call(this.array)}};var ea=Object.defineProperty;if(ea){var ra=ta.prototype;ea(ra,"x",{get:function(){return this.array[0]},set:function(t){this.array[0]=t,this._dirty=!0}}),ea(ra,"y",{get:function(){return this.array[1]},set:function(t){this.array[1]=t,this._dirty=!0}}),ea(ra,"z",{get:function(){return this.array[2]},set:function(t){this.array[2]=t,this._dirty=!0}}),ea(ra,"w",{get:function(){return this.array[3]},set:function(t){this.array[3]=t,this._dirty=!0}})}ta.add=function(t,e,r){return oe.add(t.array,e.array,r.array),t._dirty=!0,t},ta.set=function(t,e,r,n,i){oe.set(t.array,e,r,n,i),t._dirty=!0},ta.copy=function(t,e){return oe.copy(t.array,e.array),t._dirty=!0,t},ta.distance=ta.dist=function(t,e){return oe.distance(t.array,e.array)},ta.divide=ta.div=function(t,e,r){return oe.divide(t.array,e.array,r.array),t._dirty=!0,t},ta.dot=function(t,e){return oe.dot(t.array,e.array)},ta.len=function(t){return oe.length(t.array)},ta.lerp=function(t,e,r,n){return oe.lerp(t.array,e.array,r.array,n),t._dirty=!0,t},ta.min=function(t,e,r){return oe.min(t.array,e.array,r.array),t._dirty=!0,t},ta.max=function(t,e,r){return oe.max(t.array,e.array,r.array),t._dirty=!0,t},ta.multiply=ta.mul=function(t,e,r){return oe.multiply(t.array,e.array,r.array),t._dirty=!0,t},ta.negate=function(t,e){return oe.negate(t.array,e.array),t._dirty=!0,t},ta.normalize=function(t,e){return oe.normalize(t.array,e.array),t._dirty=!0,t},ta.random=function(t,e){return oe.random(t.array,e),t._dirty=!0,t},ta.scale=function(t,e,r){return oe.scale(t.array,e.array,r),t._dirty=!0,t},ta.scaleAndAdd=function(t,e,r,n){return oe.scaleAndAdd(t.array,e.array,r.array,n),t._dirty=!0,t},ta.squaredDistance=ta.sqrDist=function(t,e){return oe.sqrDist(t.array,e.array)},ta.squaredLength=ta.sqrLen=function(t){return oe.sqrLen(t.array)},ta.subtract=ta.sub=function(t,e,r){return oe.subtract(t.array,e.array,r.array),t._dirty=!0,t},ta.transformMat4=function(t,e,r){return oe.transformMat4(t.array,e.array,r.array),t._dirty=!0,t},ta.transformQuat=function(t,e,r){return oe.transformQuat(t.array,e.array,r.array),t._dirty=!0,t};var na=function(){this.position=new j,this.rotation=new j,this.velocity=null,this.angularVelocity=null,this.life=1,this.age=0,this.spriteSize=1,this.weight=1,this.emitter=null};na.prototype.update=function(t){this.velocity&&D.scaleAndAdd(this.position.array,this.position.array,this.velocity.array,t),this.angularVelocity&&D.scaleAndAdd(this.rotation.array,this.rotation.array,this.angularVelocity.array,t)};var ia=na,oa=ct.extend({max:1e3,amount:20,life:null,position:null,rotation:null,velocity:null,angularVelocity:null,spriteSize:null,weight:null,_particlePool:null},function(){this._particlePool=[];for(var t=0;t<this.max;t++){var e=new ia;e.emitter=this,this._particlePool.push(e),this.velocity&&(e.velocity=new j),this.angularVelocity&&(e.angularVelocity=new j)}},{emit:function(t){for(var e,r=Math.min(this._particlePool.length,this.amount),n=0;n<r;n++)e=this._particlePool.pop(),this.position&&this.position.get(e.position),this.rotation&&this.rotation.get(e.rotation),this.velocity&&this.velocity.get(e.velocity),this.angularVelocity&&this.angularVelocity.get(e.angularVelocity),this.life&&(e.life=this.life.get()),this.spriteSize&&(e.spriteSize=this.spriteSize.get()),this.weight&&(e.weight=this.weight.get()),e.age=0,t.push(e)},kill:function(t){this._particlePool.push(t)}});oa.constant=$o.constant,oa.vector=$o.vector,oa.random1D=$o.random1D,oa.random2D=$o.random2D,oa.random3D=$o.random3D;var aa=ct.extend({},{applyTo:function(t,e,r,n){}});aa.extend(function(){return{force:new j}},{applyTo:function(t,e,r,n){r>0&&D.scaleAndAdd(t.array,t.array,this.force.array,n/r)}});en.import("@export clay.particle.vertex\nuniform mat4 worldView : WORLDVIEW;\nuniform mat4 projection : PROJECTION;\nattribute vec3 position : POSITION;\nattribute vec3 normal : NORMAL;\n#ifdef UV_ANIMATION\nattribute vec2 texcoord0 : TEXCOORD_0;\nattribute vec2 texcoord1 : TEXCOORD_1;\nvarying vec2 v_Uv0;\nvarying vec2 v_Uv1;\n#endif\nvarying float v_Age;\nvoid main() {\n v_Age = normal.x;\n float rotation = normal.y;\n vec4 worldViewPosition = worldView * vec4(position, 1.0);\n gl_Position = projection * worldViewPosition;\n float w = gl_Position.w;\n gl_PointSize = normal.z * projection[0].x / w;\n #ifdef UV_ANIMATION\n v_Uv0 = texcoord0;\n v_Uv1 = texcoord1;\n #endif\n}\n@end\n@export clay.particle.fragment\nuniform sampler2D sprite;\nuniform sampler2D gradient;\nuniform vec3 color : [1.0, 1.0, 1.0];\nuniform float alpha : 1.0;\nvarying float v_Age;\n#ifdef UV_ANIMATION\nvarying vec2 v_Uv0;\nvarying vec2 v_Uv1;\n#endif\nvoid main() {\n vec4 color = vec4(color, alpha);\n #ifdef SPRITE_ENABLED\n #ifdef UV_ANIMATION\n color *= texture2D(sprite, mix(v_Uv0, v_Uv1, gl_PointCoord));\n #else\n color *= texture2D(sprite, gl_PointCoord);\n #endif\n #endif\n #ifdef GRADIENT_ENABLED\n color *= texture2D(gradient, vec2(v_Age, 0.5));\n #endif\n gl_FragColor = color;\n}\n@end");var sa=new en(en.source("clay.particle.vertex"),en.source("clay.particle.fragment")),ha=Mn.extend({loop:!0,oneshot:!1,duration:1,spriteAnimationTileX:1,spriteAnimationTileY:1,spriteAnimationRepeat:0,mode:Mn.POINTS,ignorePicking:!0,_elapsedTime:0,_emitting:!0},function(){this.geometry=new At({dynamic:!0}),this.material||(this.material=new Sn({shader:sa,transparent:!0,depthMask:!1}),this.material.enableTexture("sprite")),this._particles=[],this._fields=[],this._emitters=[]},{culling:!1,frustumCulling:!1,castShadow:!1,receiveShadow:!1,addEmitter:function(t){this._emitters.push(t)},removeEmitter:function(t){this._emitters.splice(this._emitters.indexOf(t),1)},addField:function(t){this._fields.push(t)},removeField:function(t){this._fields.splice(this._fields.indexOf(t),1)},reset:function(){for(var t=0;t<this._particles.length;t++){var e=this._particles[t];e.emitter.kill(e)}this._particles.length=0,this._elapsedTime=0,this._emitting=!0},updateParticles:function(t){t/=1e3,this._elapsedTime+=t;var e=this._particles;if(this._emitting){for(var r=0;r<this._emitters.length;r++)this._emitters[r].emit(e);this.oneshot&&(this._emitting=!1)}var n=e.length;for(r=0;r<n;){(i=e[r]).age+=t,i.age>=i.life?(i.emitter.kill(i),e[r]=e[n-1],e.pop(),n--):r++}for(r=0;r<n;r++){var i=e[r];if(this._fields.length>0)for(var o=0;o<this._fields.length;o++)this._fields[o].applyTo(i.velocity,i.position,i.weight,t);i.update(t)}this._updateVertices()},_updateVertices:function(){var t=this.geometry,e=this.spriteAnimationTileX,r=this.spriteAnimationTileY,n=this.spriteAnimationRepeat,i=r*e*n,o=i>1,a=t.attributes.position.value,s=t.attributes.normal.value,h=t.attributes.texcoord0.value,u=t.attributes.texcoord1.value,l=this._particles.length;a&&a.length===3*l||(a=t.attributes.position.value=new Float32Array(3*l),s=t.attributes.normal.value=new Float32Array(3*l),o&&(h=t.attributes.texcoord0.value=new Float32Array(2*l),u=t.attributes.texcoord1.value=new Float32Array(2*l)));for(var c=1/e,f=0;f<l;f++){for(var d=this._particles[f],p=3*f,m=0;m<3;m++)a[p+m]=d.position.array[m],s[p]=d.age/d.life,s[p+1]=0,s[p+2]=d.spriteSize;var g=2*f;if(o){var _=d.age/d.life,y=Math.round(_*(i-1))*n,v=Math.floor(y*c),x=y-v*e;h[g]=x/e,h[g+1]=1-v/r,u[g]=(x+1)/e,u[g+1]=1-(v+1)/r}}t.dirty()},isFinished:function(){return this._elapsedTime>this.duration&&!this.loop},dispose:function(t){for(var e=0;e<this._particles.length;e++){var r=this._particles[e];r.emitter.kill(r)}this.geometry.dispose(t)},clone:function(){var t=new ha({material:this.material});t.loop=this.loop,t.duration=this.duration,t.oneshot=this.oneshot,t.spriteAnimationRepeat=this.spriteAnimationRepeat,t.spriteAnimationTileY=this.spriteAnimationTileY,t.spriteAnimationTileX=this.spriteAnimationTileX,t.position.copy(this.position),t.rotation.copy(this.rotation),t.scale.copy(this.scale);for(var e=0;e<this._children.length;e++)t.add(this._children[e].clone());return t}});function ua(t){var e=t>>16,r=t-(e<<8)>>8;return[e,r,t-(e<<16)-(r<<8)]}en.import("@export clay.picking.color.vertex\nuniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\nattribute vec3 position : POSITION;\n@import clay.chunk.skinning_header\nvoid main(){\n vec3 skinnedPosition = position;\n #ifdef SKINNING\n @import clay.chunk.skin_matrix\n skinnedPosition = (skinMatrixWS * vec4(position, 1.0)).xyz;\n #endif\n gl_Position = worldViewProjection * vec4(skinnedPosition, 1.0);\n}\n@end\n@end\n@export clay.picking.color.fragment\nuniform vec4 color : [1.0, 1.0, 1.0, 1.0];\nvoid main() {\n gl_FragColor = color;\n}\n@end");ct.extend(function(){return{renderer:null,downSampleRatio:1,width:100,height:100,lookupOffset:1,_frameBuffer:null,_texture:null,_shader:null,_idMaterials:[],_lookupTable:[],_meshMaterials:[],_idOffset:0}},function(){this.renderer&&(this.width=this.renderer.getWidth(),this.height=this.renderer.getHeight()),this._init()},{_init:function(){this._texture=new br({width:this.width*this.downSampleRatio,height:this.height*this.downSampleRatio}),this._frameBuffer=new Or,this._shader=new en(en.source("clay.picking.color.vertex"),en.source("clay.picking.color.fragment"))},setPrecision:function(t){this._texture.width=this.width*t,this._texture.height=this.height*t,this.downSampleRatio=t},resize:function(t,e){this._texture.width=t*this.downSampleRatio,this._texture.height=e*this.downSampleRatio,this.width=t,this.height=e,this._texture.dirty()},update:function(t,e){var r=this.renderer;r.getWidth()===this.width&&r.getHeight()===this.height||this.resize(r.width,r.height),this._frameBuffer.attach(this._texture),this._frameBuffer.bind(r),this._idOffset=this.lookupOffset,this._setMaterial(t),r.render(t,e),this._restoreMaterial(),this._frameBuffer.unbind(r)},_setMaterial:function(t){for(var e=0;e<t._children.length;e++){var r=t._children[e];if(r.geometry&&r.material&&r.material.shader){var n=this._idOffset++,i=n-this.lookupOffset,o=this._idMaterials[i];if(!o){o=new Sn({shader:this._shader});var a=ua(n);a[0]/=255,a[1]/=255,a[2]/=255,a[3]=1,o.set("color",a),this._idMaterials[i]=o}this._meshMaterials[i]=r.material,this._lookupTable[i]=r,r.material=o}r._children.length&&this._setMaterial(r)}},pick:function(t,e){var r=this.renderer,n=this.downSampleRatio;t=Math.ceil(n*t),e=Math.ceil(n*(this.height-e)),this._frameBuffer.bind(r);var i,o,a,s=new Uint8Array(4),h=r.gl;if(h.readPixels(t,e,1,1,h.RGBA,h.UNSIGNED_BYTE,s),this._frameBuffer.unbind(r),255===s[3]){var u=(i=s[0],o=s[1],a=s[2],(i<<16)+(o<<8)+a);if(u)return this._lookupTable[u-this.lookupOffset]}},_restoreMaterial:function(){for(var t=0;t<this._lookupTable.length;t++)this._lookupTable[t].material=this._meshMaterials[t]},dispose:function(t){this._frameBuffer.dispose(t)}});var la,ca,fa,da,pa,ma=ct.extend({scene:null,camera:null,renderer:null},function(){this._ray=new hr,this._ndc=new re},{pick:function(t,e,r){return this.pickAll(t,e,[],r)[0]||null},pickAll:function(t,e,r,n){return this.renderer.screenToNDC(t,e,this._ndc),this.camera.castRay(this._ndc,this._ray),r=r||[],this._intersectNode(this.scene,r,n||!1),r.sort(this._intersectionCompareFunc),r},_intersectNode:function(t,e,r){t instanceof Mn&&t.isRenderable()&&(t.ignorePicking&&!r||!(t.mode===ft.TRIANGLES&&t.geometry.isUseIndices()||t.geometry.pickByRay||t.geometry.pick)||this._intersectRenderable(t,e));for(var n=0;n<t._children.length;n++)this._intersectNode(t._children[n],e,r)},_intersectRenderable:(la=new j,ca=new j,fa=new j,da=new hr,pa=new Ge,function(t,e){var r=t.isSkinnedMesh();da.copy(this._ray),Ge.invert(pa,t.worldTransform),r||da.applyTransform(pa);var n=t.geometry,i=r?t.skeleton.boundingBox:n.boundingBox;if(!i||da.intersectBoundingBox(i))if(n.pick)n.pick(this._ndc.x,this._ndc.y,this.renderer,this.camera,t,e);else if(n.pickByRay)n.pickByRay(da,t,e);else{var o,a,s=t.cullFace===ft.BACK&&t.frontFace===ft.CCW||t.cullFace===ft.FRONT&&t.frontFace===ft.CW,h=n.indices,u=n.attributes.position,l=n.attributes.weight,c=n.attributes.joint,f=[];if(u&&u.value&&h){if(r){a=t.skeleton.getSubSkinMatrices(t.__uid__,t.joints);for(var d=0;d<t.joints.length;d++){f[d]=f[d]||[];for(var p=0;p<16;p++)f[d][p]=a[16*d+p]}var m=[],g=[],_=[],y=[],v=[],x=n.attributes.skinnedPosition;for(x&&x.value||(n.createAttribute("skinnedPosition","f",3),(x=n.attributes.skinnedPosition).init(n.vertexCount)),d=0;d<n.vertexCount;d++){for(u.get(d,m),l.get(d,g),c.get(d,_),g[3]=1-g[0]-g[1]-g[2],D.set(y,0,0,0),p=0;p<4;p++)_[p]>=0&&g[p]>1e-4&&(D.transformMat4(v,m,f[_[p]]),D.scaleAndAdd(y,y,v,g[p]));x.set(d,y)}}for(d=0;d<h.length;d+=3){var b=h[d],w=h[d+1],T=h[d+2],E=r?n.attributes.skinnedPosition:u;if(E.get(b,la.array),E.get(w,ca.array),E.get(T,fa.array),o=s?da.intersectTriangle(la,ca,fa,t.culling):da.intersectTriangle(la,fa,ca,t.culling)){var C=new j;r?j.copy(C,o):j.transformMat4(C,o,t.worldTransform),e.push(new ma.Intersection(o,C,t,[b,w,T],d/3,j.dist(C,this._ray.origin)))}}}}}),_intersectionCompareFunc:function(t,e){return t.distance-e.distance}});ma.Intersection=function(t,e,r,n,i,o){this.point=t,this.pointWorld=e,this.target=r,this.triangle=n,this.triangleIndex=i,this.distance=o};var ga=ma,_a="undefined"==typeof document?{}:document,ya=ct.extend(function(){return{target:null,domElement:null,sensitivity:1,speed:.4,up:new j(0,1,0),verticalMoveLock:!1,timeline:null,_moveForward:!1,_moveBackward:!1,_moveLeft:!1,_moveRight:!1,_offsetPitch:0,_offsetRoll:0}},function(){this._lockChange=this._lockChange.bind(this),this._keyDown=this._keyDown.bind(this),this._keyUp=this._keyUp.bind(this),this._mouseMove=this._mouseMove.bind(this),this.domElement&&this.init()},{init:function(){var t=this.domElement;G.a.addEventListener(t,"click",this._requestPointerLock),G.a.addEventListener(_a,"pointerlockchange",this._lockChange),G.a.addEventListener(_a,"mozpointerlockchange",this._lockChange),G.a.addEventListener(_a,"webkitpointerlockchange",this._lockChange),G.a.addEventListener(_a,"keydown",this._keyDown),G.a.addEventListener(_a,"keyup",this._keyUp),this.timeline&&this.timeline.on("frame",this._detectMovementChange,this)},dispose:function(){var t=this.domElement;t.exitPointerLock=t.exitPointerLock||t.mozExitPointerLock||t.webkitExitPointerLock,t.exitPointerLock&&t.exitPointerLock(),G.a.removeEventListener(t,"click",this._requestPointerLock),G.a.removeEventListener(_a,"pointerlockchange",this._lockChange),G.a.removeEventListener(_a,"mozpointerlockchange",this._lockChange),G.a.removeEventListener(_a,"webkitpointerlockchange",this._lockChange),G.a.removeEventListener(_a,"keydown",this._keyDown),G.a.removeEventListener(_a,"keyup",this._keyUp),this.timeline&&this.timeline.off("frame",this._detectMovementChange)},_requestPointerLock:function(){var t=this;t.requestPointerLock=t.requestPointerLock||t.mozRequestPointerLock||t.webkitRequestPointerLock,t.requestPointerLock()},update:function(t){var e=this.target,r=this.target.position,n=e.localTransform.x.normalize(),i=e.localTransform.z.normalize();this.verticalMoveLock&&(i.y=0,i.normalize());var o=this.speed*t/20;this._moveForward&&r.scaleAndAdd(i,-o),this._moveBackward&&r.scaleAndAdd(i,o),this._moveLeft&&r.scaleAndAdd(n,-o/2),this._moveRight&&r.scaleAndAdd(n,o/2),e.rotateAround(e.position,this.up,-this._offsetPitch*t*Math.PI/360);n=e.localTransform.x;e.rotateAround(e.position,n,-this._offsetRoll*t*Math.PI/360),this._offsetRoll=this._offsetPitch=0},_lockChange:function(){_a.pointerLockElement===this.domElement||_a.mozPointerLockElement===this.domElement||_a.webkitPointerLockElement===this.domElement?G.a.addEventListener(_a,"mousemove",this._mouseMove,!1):G.a.removeEventListener(_a,"mousemove",this._mouseMove)},_mouseMove:function(t){var e=t.movementX||t.mozMovementX||t.webkitMovementX||0,r=t.movementY||t.mozMovementY||t.webkitMovementY||0;this._offsetPitch+=e*this.sensitivity/200,this._offsetRoll+=r*this.sensitivity/200,this.trigger("change")},_detectMovementChange:function(){(this._moveForward||this._moveBackward||this._moveLeft||this._moveRight)&&this.trigger("change")},_keyDown:function(t){switch(t.keyCode){case 87:case 37:this._moveForward=!0;break;case 83:case 40:this._moveBackward=!0;break;case 65:case 37:this._moveLeft=!0;break;case 68:case 39:this._moveRight=!0}this.trigger("change")},_keyUp:function(t){switch(t.keyCode){case 87:case 37:this._moveForward=!1;break;case 83:case 40:this._moveBackward=!1;break;case 65:case 37:this._moveLeft=!1;break;case 68:case 39:this._moveRight=!1}}}),va=ct.extend(function(){return{target:null,moveSpeed:.1,lookAroundSpeed:.1,up:new j(0,1,0),timeline:null,onStandardGamepadReady:function(t){},onGamepadDisconnected:function(t){},_moveForward:!1,_moveBackward:!1,_moveLeft:!1,_moveRight:!1,_offsetPitch:0,_offsetRoll:0,_connectedGamepadIndex:0,_standardGamepadAvailable:!1,_gamepadAxisThreshold:.3}},function(){this._checkGamepadCompatibility=this._checkGamepadCompatibility.bind(this),this._disconnectGamepad=this._disconnectGamepad.bind(this),this._getStandardGamepad=this._getStandardGamepad.bind(this),this._scanPressedGamepadButtons=this._scanPressedGamepadButtons.bind(this),this._scanInclinedGamepadAxes=this._scanInclinedGamepadAxes.bind(this),this.update=this.update.bind(this),"function"==typeof navigator.getGamepads&&this.init()},{init:function(){G.a.addEventListener(window,"gamepadconnected",this._checkGamepadCompatibility),this.timeline&&this.timeline.on("frame",this.update),G.a.addEventListener(window,"gamepaddisconnected",this._disconnectGamepad)},dispose:function(){G.a.removeEventListener(window,"gamepadconnected",this._checkGamepadCompatibility),this.timeline&&this.timeline.off("frame",this.update),G.a.removeEventListener(window,"gamepaddisconnected",this._disconnectGamepad)},update:function(t){if(this._standardGamepadAvailable){this._scanPressedGamepadButtons(),this._scanInclinedGamepadAxes();var e=this.target,r=this.target.position,n=e.localTransform.x.normalize(),i=e.localTransform.z.normalize(),o=this.moveSpeed*t/20;this._moveForward&&r.scaleAndAdd(i,-o),this._moveBackward&&r.scaleAndAdd(i,o),this._moveLeft&&r.scaleAndAdd(n,-o),this._moveRight&&r.scaleAndAdd(n,o),e.rotateAround(e.position,this.up,-this._offsetPitch*t*Math.PI/360);n=e.localTransform.x;e.rotateAround(e.position,n,-this._offsetRoll*t*Math.PI/360),!0!==this._moveForward&&!0!==this._moveBackward&&!0!==this._moveLeft&&!0!==this._moveRight&&0===this._offsetPitch&&0===this._offsetRoll||this.trigger("update"),this._moveForward=this._moveBackward=this._moveLeft=this._moveRight=!1,this._offsetPitch=this._offsetRoll=0}},_checkGamepadCompatibility:function(t){"standard"===t.gamepad.mapping&&(this._standardGamepadIndex=t.gamepad.index,this._standardGamepadAvailable=!0,this.onStandardGamepadReady(t.gamepad))},_disconnectGamepad:function(t){this._standardGamepadAvailable=!1,this.onGamepadDisconnected(t.gamepad)},_getStandardGamepad:function(){return navigator.getGamepads()[this._standardGamepadIndex]},_scanPressedGamepadButtons:function(){for(var t=this._getStandardGamepad().buttons,e=0;e<t.length;e++){if(t[e].pressed)switch(e){case 12:this._moveForward=!0;break;case 13:this._moveBackward=!0;break;case 14:this._moveLeft=!0;break;case 15:this._moveRight=!0}}},_scanInclinedGamepadAxes:function(){for(var t=this._getStandardGamepad().axes,e=0;e<t.length;e++){var r=t[e];if(Math.abs(r)>this._gamepadAxisThreshold)switch(e){case 0:this._moveLeft=r<0,this._moveRight=r>0;break;case 1:this._moveForward=r<0,this._moveBackward=r>0;break;case 2:this._offsetPitch+=r*this.lookAroundSpeed;break;case 3:this._offsetRoll+=r*this.lookAroundSpeed}}}}),xa=function(){this._track=[]};function ba(t){var e=t[1][0]-t[0][0],r=t[1][1]-t[0][1];return Math.sqrt(e*e+r*r)}xa.prototype={constructor:xa,recognize:function(t,e,r){return this._doTrack(t,e,r),this._recognize(t)},clear:function(){return this._track.length=0,this},_doTrack:function(t,e,r){var n=t.targetTouches;if(n){for(var i={points:[],touches:[],target:e,event:t},o=0,a=n.length;o<a;o++){var s=n[o];i.points.push([s.clientX,s.clientY]),i.touches.push(s)}this._track.push(i)}},_recognize:function(t){for(var e in wa)if(wa.hasOwnProperty(e)){var r=wa[e](this._track,t);if(r)return r}}};var wa={pinch:function(t,e){var r=t.length;if(r){var n,i=(t[r-1]||{}).points,o=(t[r-2]||{}).points||i;if(o&&o.length>1&&i&&i.length>1){var a=ba(i)/ba(o);!isFinite(a)&&(a=1),e.pinchScale=a;var s=[((n=i)[0][0]+n[1][0])/2,(n[0][1]+n[1][1])/2];return e.pinchX=s[0],e.pinchY=s[1],{type:"pinch",target:t[0].target,event:e}}}}},Ta=xa,Ea=[[0,0],[0,1],[1,1],[1,0]],Ca=[0,1,2,2,3,0],Sa=Rn.extend({camera:null,plane:null,maxGrid:0,frustumCulling:!1},function(){var t=this.geometry=new At({dynamic:!0});t.attributes.position.init(6),t.attributes.normal.init(6),t.attributes.texcoord0.init(6),t.indices=new Uint16Array(6),this.plane=new qe},{updateGeometry:function(){var t=this._unProjectGrid();if(t){for(var e=this.geometry.attributes.position,r=this.geometry.attributes.normal,n=this.geometry.attributes.texcoord0,i=this.geometry.indices,o=0;o<6;o++){var a=Ca[o];e.set(o,t[a].array),r.set(o,this.plane.normal.array),n.set(o,Ea[a]),i[o]=o}this.geometry.dirty()}},_unProjectGrid:function(){for(var t=new qe,e=[0,1,0,2,1,3,2,3,4,5,4,6,5,7,6,7,0,4,1,5,2,6,3,7],r=new j,n=new j,i=[],o=[],a=0;a<4;a++)o[a]=new j(0,0);var s=new hr;return function(){t.copy(this.plane),t.applyTransform(this.camera.viewMatrix);for(var a=this.camera.frustum.vertices,h=0,u=0;u<12;u++){r.array=a[e[2*u]],n.array=a[e[2*u+1]];var l=t.intersectLine(r,n,i[h]);l&&(i[h]||(i[h]=l),h++)}if(0!==h){for(u=0;u<h;u++)i[u].applyProjection(this.camera.projectionMatrix);var c=i[0].array[0],f=i[0].array[1],d=i[0].array[0],p=i[0].array[1];for(u=1;u<h;u++)d=Math.max(d,i[u].array[0]),p=Math.max(p,i[u].array[1]),c=Math.min(c,i[u].array[0]),f=Math.min(f,i[u].array[1]);if(c!=d&&f!=p){o[0].array[0]=c,o[0].array[1]=f,o[1].array[0]=c,o[1].array[1]=p,o[2].array[0]=d,o[2].array[1]=p,o[3].array[0]=d,o[3].array[1]=f;for(u=0;u<4;u++)this.camera.castRay(o[u],s),s.intersectPlane(this.plane,o[u]);return o}}}}()});function Aa(t){return Array.isArray(t)||(t=[t,t]),t}var Ma=ct.extend(function(){return{timeline:null,domElement:null,target:null,_center:new j,minDistance:.1,maxDistance:1e3,minAlpha:-90,maxAlpha:90,minBeta:-1/0,maxBeta:1/0,autoRotateAfterStill:0,autoRotateDirection:"cw",autoRotateSpeed:60,_mode:"rotate",damping:.8,rotateSensitivity:1,zoomSensitivity:1,panSensitivity:1,_needsUpdate:!1,_rotating:!1,_phi:0,_theta:0,_mouseX:0,_mouseY:0,_rotateVelocity:new re,_panVelocity:new re,_distance:20,_zoomSpeed:0,_stillTimeout:0,_animators:[],_gestureMgr:new Ta}},function(){this._mouseDownHandler=this._mouseDownHandler.bind(this),this._mouseWheelHandler=this._mouseWheelHandler.bind(this),this._mouseMoveHandler=this._mouseMoveHandler.bind(this),this._mouseUpHandler=this._mouseUpHandler.bind(this),this._pinchHandler=this._pinchHandler.bind(this),this.init()},{init:function(){var t=this.domElement;G.a.addEventListener(t,"touchstart",this._mouseDownHandler),G.a.addEventListener(t,"mousedown",this._mouseDownHandler),G.a.addEventListener(t,"wheel",this._mouseWheelHandler),this.timeline&&this.timeline.on("frame",this.update,this)},dispose:function(){var t=this.domElement;G.a.removeEventListener(t,"touchstart",this._mouseDownHandler),G.a.removeEventListener(t,"touchmove",this._mouseMoveHandler),G.a.removeEventListener(t,"touchend",this._mouseUpHandler),G.a.removeEventListener(t,"mousedown",this._mouseDownHandler),G.a.removeEventListener(t,"mousemove",this._mouseMoveHandler),G.a.removeEventListener(t,"mouseup",this._mouseUpHandler),G.a.removeEventListener(t,"wheel",this._mouseWheelHandler),G.a.removeEventListener(t,"mouseout",this._mouseUpHandler),this.timeline&&this.timeline.off("frame",this.update),this.stopAllAnimation()},getDistance:function(){return this._distance},setDistance:function(t){this._distance=t,this._needsUpdate=!0},getAlpha:function(){return this._theta/Math.PI*180},getBeta:function(){return-this._phi/Math.PI*180},getCenter:function(){return this._center.toArray()},setAlpha:function(t){t=Math.max(Math.min(this.maxAlpha,t),this.minAlpha),this._theta=t/180*Math.PI,this._needsUpdate=!0},setBeta:function(t){t=Math.max(Math.min(this.maxBeta,t),this.minBeta),this._phi=-t/180*Math.PI,this._needsUpdate=!0},setCenter:function(t){this._center.setArray(t)},setOption:function(t){t=t||{},["autoRotate","autoRotateAfterStill","autoRotateDirection","autoRotateSpeed","damping","minDistance","maxDistance","minAlpha","maxAlpha","minBeta","maxBeta","rotateSensitivity","zoomSensitivity","panSensitivity"].forEach(function(e){null!=t[e]&&(this[e]=t[e])},this),null!=t.distance&&this.setDistance(t.distance),null!=t.alpha&&this.setAlpha(t.alpha),null!=t.beta&&this.setBeta(t.beta),t.center&&this.setCenter(t.center)},animateTo:function(t){var e=this,r={},n={},i=this.timeline;if(i)return null!=t.distance&&(r.distance=this.getDistance(),n.distance=t.distance),null!=t.alpha&&(r.alpha=this.getAlpha(),n.alpha=t.alpha),null!=t.beta&&(r.beta=this.getBeta(),n.beta=t.beta),null!=t.center&&(r.center=this.getCenter(),n.center=t.center),this._addAnimator(i.animate(r).when(t.duration||1e3,n).during(function(){null!=r.alpha&&e.setAlpha(r.alpha),null!=r.beta&&e.setBeta(r.beta),null!=r.distance&&e.setDistance(r.distance),null!=r.center&&e.setCenter(r.center),e._needsUpdate=!0}).done(t.done)).start(t.easing||"linear")},stopAllAnimation:function(){for(var t=0;t<this._animators.length;t++)this._animators[t].stop();this._animators.length=0},_isAnimating:function(){return this._animators.length>0},update:function(t){if(t=t||16,this._rotating){var e=("cw"===this.autoRotateDirection?1:-1)*this.autoRotateSpeed/180*Math.PI;this._phi-=e*t/1e3,this._needsUpdate=!0}else this._rotateVelocity.len()>0&&(this._needsUpdate=!0);(Math.abs(this._zoomSpeed)>.01||this._panVelocity.len()>0)&&(this._needsUpdate=!0),this._needsUpdate&&(this._updateDistance(Math.min(t,50)),this._updatePan(Math.min(t,50)),this._updateRotate(Math.min(t,50)),this._updateTransform(),this.target.update(),this.trigger("update"),this._needsUpdate=!1)},_updateRotate:function(t){var e=this._rotateVelocity;this._phi=e.y*t/20+this._phi,this._theta=e.x*t/20+this._theta,this.setAlpha(this.getAlpha()),this.setBeta(this.getBeta()),this._vectorDamping(e,this.damping)},_updateDistance:function(t){this._setDistance(this._distance+this._zoomSpeed*t/20),this._zoomSpeed*=this.damping},_setDistance:function(t){this._distance=Math.max(Math.min(t,this.maxDistance),this.minDistance)},_updatePan:function(t){var e=this._panVelocity,r=this._distance,n=this.target,i=n.worldTransform.y,o=n.worldTransform.x;this._center.scaleAndAdd(o,-e.x*r/200).scaleAndAdd(i,-e.y*r/200),this._vectorDamping(e,0),e.x=e.y=0},_updateTransform:function(){var t=this.target,e=new j,r=this._theta+Math.PI/2,n=this._phi+Math.PI/2,i=Math.sin(r);e.x=i*Math.cos(n),e.y=-Math.cos(r),e.z=i*Math.sin(n),t.position.copy(this._center).scaleAndAdd(e,this._distance),t.rotation.identity().rotateY(-this._phi).rotateX(-this._theta)},_startCountingStill:function(){clearTimeout(this._stillTimeout);var t=this.autoRotateAfterStill,e=this;!isNaN(t)&&t>0&&(this._stillTimeout=setTimeout(function(){e._rotating=!0},1e3*t))},_vectorDamping:function(t,e){var r=t.len();(r*=e)<1e-4&&(r=0),t.normalize().scale(r)},decomposeTransform:function(){if(this.target){this.target.updateWorldTransform();var t=this.target.worldTransform.z,e=Math.asin(t.y),r=Math.atan2(t.x,t.z);this._theta=e,this._phi=-r,this.setBeta(this.getBeta()),this.setAlpha(this.getAlpha()),this._setDistance(this.target.position.dist(this._center))}},_mouseDownHandler:function(t){if(!this._isAnimating()){var e=t.clientX,r=t.clientY;if(t.targetTouches){var n=t.targetTouches[0];e=n.clientX,r=n.clientY,this._mode="rotate",this._processGesture(t,"start")}else 0===t.button?this._mode="rotate":1===t.button?(this._mode="pan",t.preventDefault()):this._mode=null;var i=this.domElement;G.a.addEventListener(i,"touchmove",this._mouseMoveHandler),G.a.addEventListener(i,"touchend",this._mouseUpHandler),G.a.addEventListener(i,"mousemove",this._mouseMoveHandler),G.a.addEventListener(i,"mouseup",this._mouseUpHandler),G.a.addEventListener(i,"mouseout",this._mouseUpHandler),this._rotateVelocity.set(0,0),this._rotating=!1,this.autoRotate&&this._startCountingStill(),this._mouseX=e,this._mouseY=r}},_mouseMoveHandler:function(t){if(!this._isAnimating()){var e,r=t.clientX,n=t.clientY;if(t.targetTouches){var i=t.targetTouches[0];r=i.clientX,n=i.clientY,e=this._processGesture(t,"change")}var o=Aa(this.panSensitivity),a=Aa(this.rotateSensitivity);e||("rotate"===this._mode?(this._rotateVelocity.y+=(r-this._mouseX)/this.domElement.clientWidth*2*a[0],this._rotateVelocity.x+=(n-this._mouseY)/this.domElement.clientHeight*2*a[1]):"pan"===this._mode&&(this._panVelocity.x+=(r-this._mouseX)/this.domElement.clientWidth*o[0]*400,this._panVelocity.y+=(-n+this._mouseY)/this.domElement.clientHeight*o[1]*400)),this._mouseX=r,this._mouseY=n,t.preventDefault&&t.preventDefault()}},_mouseWheelHandler:function(t){if(!this._isAnimating()){var e=t.deltaY;0!==e&&this._zoomHandler(t,e>0?1:-1)}},_pinchHandler:function(t){this._isAnimating()||this._zoomHandler(t,t.pinchScale>1?-.4:.4)},_zoomHandler:function(t,e){var r=Math.max(Math.min(this._distance-this.minDistance,this.maxDistance-this._distance));this._zoomSpeed=e*Math.max(r/40*this.zoomSensitivity,.2),this._rotating=!1,this.autoRotate&&"rotate"===this._mode&&this._startCountingStill(),t.preventDefault&&t.preventDefault()},_mouseUpHandler:function(t){var e=this.domElement;G.a.removeEventListener(e,"touchmove",this._mouseMoveHandler),G.a.removeEventListener(e,"touchend",this._mouseUpHandler),G.a.removeEventListener(e,"mousemove",this._mouseMoveHandler),G.a.removeEventListener(e,"mouseup",this._mouseUpHandler),G.a.removeEventListener(e,"mouseout",this._mouseUpHandler),this._processGesture(t,"end")},_addAnimator:function(t){var e=this._animators;return e.push(t),t.done(function(){var r=e.indexOf(t);r>=0&&e.splice(r,1)}),t},_processGesture:function(t,e){var r=this._gestureMgr;"start"===e&&r.clear();var n=r.recognize(t,null,this.domElement);if("end"===e&&r.clear(),n){var i=n.type;t.gestureEvent=i,this._pinchHandler(n.event)}return n}});Object.defineProperty(Ma.prototype,"autoRotate",{get:function(){return this._autoRotate},set:function(t){this._autoRotate=t,this._rotating=t}}),Object.defineProperty(Ma.prototype,"target",{get:function(){return this._target},set:function(t){t&&t.target&&this.setCenter(t.target.toArray()),this._target=t,this.decomposeTransform()}});var Pa=Ma,Ra={};function La(t,e,r){if(!t.getShaderParameter(e,t.COMPILE_STATUS))return[t.getShaderInfoLog(e),function(t){for(var e=t.split("\n"),r=0,n=e.length;r<n;r++)e[r]=r+1+": "+e[r];return e.join("\n")}(r)].join("\n")}var Oa=new G.a.Float32Array(16),ka=ct.extend({uniformSemantics:{},attributes:{}},function(){this._locations={},this._textureSlot=0,this._program=null},{bind:function(t){this._textureSlot=0,t.gl.useProgram(this._program)},hasUniform:function(t){var e=this._locations[t];return null!==e&&void 0!==e},useTextureSlot:function(t,e,r){e&&(t.gl.activeTexture(t.gl.TEXTURE0+r),e.isRenderable()?e.bind(t):e.unbind(t))},currentTextureSlot:function(){return this._textureSlot},resetTextureSlot:function(t){this._textureSlot=t||0},takeCurrentTextureSlot:function(t,e){var r=this._textureSlot;return this.useTextureSlot(t,e,r),this._textureSlot++,r},setUniform:function(t,e,r,n){var i=this._locations[r];if(null===i||void 0===i)return!1;switch(e){case"m4":if(!(n instanceof Float32Array)){for(var o=0;o<n.length;o++)Oa[o]=n[o];n=Oa}t.uniformMatrix4fv(i,!1,n);break;case"2i":t.uniform2i(i,n[0],n[1]);break;case"2f":t.uniform2f(i,n[0],n[1]);break;case"3i":t.uniform3i(i,n[0],n[1],n[2]);break;case"3f":t.uniform3f(i,n[0],n[1],n[2]);break;case"4i":t.uniform4i(i,n[0],n[1],n[2],n[3]);break;case"4f":t.uniform4f(i,n[0],n[1],n[2],n[3]);break;case"1i":t.uniform1i(i,n);break;case"1f":t.uniform1f(i,n);break;case"1fv":t.uniform1fv(i,n);break;case"1iv":t.uniform1iv(i,n);break;case"2iv":t.uniform2iv(i,n);break;case"2fv":t.uniform2fv(i,n);break;case"3iv":t.uniform3iv(i,n);break;case"3fv":t.uniform3fv(i,n);break;case"4iv":t.uniform4iv(i,n);break;case"4fv":t.uniform4fv(i,n);break;case"m2":case"m2v":t.uniformMatrix2fv(i,!1,n);break;case"m3":case"m3v":t.uniformMatrix3fv(i,!1,n);break;case"m4v":if(Array.isArray(n)&&Array.isArray(n[0])){var a=new G.a.Float32Array(16*n.length),s=0;for(o=0;o<n.length;o++)for(var h=n[o],u=0;u<16;u++)a[s++]=h[u];t.uniformMatrix4fv(i,!1,a)}else t.uniformMatrix4fv(i,!1,n)}return!0},setUniformOfSemantic:function(t,e,r){var n=this.uniformSemantics[e];return!!n&&this.setUniform(t,n.type,n.symbol,r)},enableAttributes:function(t,e,r){var n,i=t.gl,o=this._program,a=this._locations;(n=r?r.__enabledAttributeList:Ra[t.__uid__])||(n=r?r.__enabledAttributeList=[]:Ra[t.__uid__]=[]);for(var s=[],h=0;h<e.length;h++){var u=e[h];if(this.attributes[u]){var l=a[u];if(null==l){if(-1===(l=i.getAttribLocation(o,u))){s[h]=-1;continue}a[u]=l}s[h]=l,n[l]?n[l]=2:n[l]=1}else s[h]=-1}for(h=0;h<n.length;h++)switch(n[h]){case 1:i.enableVertexAttribArray(h),n[h]=3;break;case 2:n[h]=3;break;case 3:i.disableVertexAttribArray(h),n[h]=0}return s},buildProgram:function(t,e,r,n){var i=t.createShader(t.VERTEX_SHADER),o=t.createProgram();t.shaderSource(i,r),t.compileShader(i);var a=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(a,n),t.compileShader(a);var s=La(t,i,r);if(s)return s;if(s=La(t,a,n))return s;if(t.attachShader(o,i),t.attachShader(o,a),e.attributeSemantics.POSITION)t.bindAttribLocation(o,0,e.attributeSemantics.POSITION.symbol);else{var h=Object.keys(this.attributes);t.bindAttribLocation(o,0,h[0])}if(t.linkProgram(o),!t.getProgramParameter(o,t.LINK_STATUS))return"Could not link program\n"+t.getProgramInfoLog(o);for(var u=0;u<e.uniforms.length;u++){var l=e.uniforms[u];this._locations[l]=t.getUniformLocation(o,l)}t.deleteShader(i),t.deleteShader(a),this._program=o,this.vertexCode=r,this.fragmentCode=n}}),Da=/for\s*?\(int\s*?_idx_\s*\=\s*([\w-]+)\;\s*_idx_\s*<\s*([\w-]+);\s*_idx_\s*\+\+\s*\)\s*\{\{([\s\S]+?)(?=\}\})\}\}/g;function Ia(t,e,r){var n={};for(var i in r)n[i+"_COUNT"]=r[i];return t.replace(Da,function(t,r,i,o){var a="";isNaN(r)&&(r=r in e?e[r]:n[r]),isNaN(i)&&(i=i in e?e[i]:n[i]);for(var s=parseInt(r);s<parseInt(i);s++)a+="{"+o.replace(/float\s*\(\s*_idx_\s*\)/g,s.toFixed(1)).replace(/_idx_/g,s)+"}";return a})}function Na(t,e,r){var n=[];if(e)for(var i in e){var o=e[i];o>0&&n.push("#define "+i.toUpperCase()+"_COUNT "+o)}if(r)for(var a=0;a<r.length;a++){var s=r[a];n.push("#define "+s.toUpperCase()+"_ENABLED")}for(var s in t){var h=t[s];null===h?n.push("#define "+s):n.push("#define "+s+" "+h.toString())}return n.join("\n")}function Fa(t){this._renderer=t,this._cache={}}Fa.prototype.getProgram=function(t,e,r){var n=this._cache,i=t.isSkinnedMesh&&t.isSkinnedMesh(),o="s"+e.shader.shaderID+"m"+e.getProgramKey();if(r&&(o+="se"+r.getProgramKey(t.lightGroup)),i&&(o+=","+t.joints.length),_=n[o])return _;var a=r?r.getLightsNumbers(t.lightGroup):{},s=this._renderer,h=s.gl,u=e.getEnabledTextures(),l="";if(i){var c={SKINNING:null,JOINT_COUNT:t.joints.length};t.joints.length>s.getMaxJointNumber()&&(c.USE_SKIN_MATRICES_TEXTURE=null),l="\n"+Na(c)+"\n"}var f=l+Na(e.vertexDefines,a,u),d=l+Na(e.fragmentDefines,a,u),p=f+"\n"+e.shader.vertex,m=["OES_standard_derivatives","EXT_shader_texture_lod"].filter(function(t){return null!=s.getGLExtension(t)});m.indexOf("EXT_shader_texture_lod")>=0&&(d+="\n#define SUPPORT_TEXTURE_LOD"),m.indexOf("OES_standard_derivatives")>=0&&(d+="\n#define SUPPORT_STANDARD_DERIVATIVES");var g,_,y=function(t){for(var e=[],r=0;r<t.length;r++)e.push("#extension GL_"+t[r]+" : enable");return e.join("\n")}(m)+"\n"+(["precision",g=e.precision,"float"].join(" ")+";\n"+["precision",g,"int"].join(" ")+";\n"+["precision",g,"sampler2D"].join(" ")+";\n")+"\n"+d+"\n"+e.shader.fragment,v=Ia(p,e.vertexDefines,a),x=Ia(y,e.fragmentDefines,a);(_=new ka).uniformSemantics=e.shader.uniformSemantics,_.attributes=e.shader.attributes;var b=_.buildProgram(h,e.shader,v,x);return _.__error=b,n[o]=_,_};var Ba=Fa;en.import(vi);var za=K.create,Ua={};function Ha(t){return t.material}function ja(t,e,r){return e.uniforms[r].value}function Ga(t,e,r,n){return r!==n}function Va(t){return!0}function Wa(){}var Za={float:ft.FLOAT,byte:ft.BYTE,ubyte:ft.UNSIGNED_BYTE,short:ft.SHORT,ushort:ft.UNSIGNED_SHORT};var Xa=ct.extend(function(){return{canvas:null,_width:100,_height:100,devicePixelRatio:"undefined"!=typeof window&&window.devicePixelRatio||1,clearColor:[0,0,0,0],clearBit:17664,alpha:!0,depth:!0,stencil:!1,antialias:!0,premultipliedAlpha:!0,preserveDrawingBuffer:!1,throwError:!0,gl:null,viewport:{},__currentFrameBuffer:null,_viewportStack:[],_clearStack:[],_sceneRendering:null}},function(){this.canvas||(this.canvas=G.a.createCanvas());var t=this.canvas;try{var e={alpha:this.alpha,depth:this.depth,stencil:this.stencil,antialias:this.antialias,premultipliedAlpha:this.premultipliedAlpha,preserveDrawingBuffer:this.preserveDrawingBuffer};if(this.gl=t.getContext("webgl",e)||t.getContext("experimental-webgl",e),!this.gl)throw new Error;this._glinfo=new fi(this.gl),this.gl.targetRenderer&&console.error("Already created a renderer"),this.gl.targetRenderer=this,this.resize()}catch(t){throw"Error creating WebGL Context "+t}this._programMgr=new Ba(this),this._placeholderTexture=new function(t){var e,r;this.bind=function(t){e||((e=G.a.createCanvas()).width=e.height=1,e.getContext("2d"));var n=t.gl,i=!r;i&&(r=n.createTexture()),n.bindTexture(n.TEXTURE_2D,r),i&&n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,e)},this.unbind=function(t){t.gl.bindTexture(t.gl.TEXTURE_2D,null)},this.isRenderable=function(){return!0}}(this)},{resize:function(t,e){var r=this.canvas,n=this.devicePixelRatio;null!=t?(r.style.width=t+"px",r.style.height=e+"px",r.width=t*n,r.height=e*n,this._width=t,this._height=e):(this._width=r.width/n,this._height=r.height/n),this.setViewport(0,0,this._width,this._height)},getWidth:function(){return this._width},getHeight:function(){return this._height},getViewportAspect:function(){var t=this.viewport;return t.width/t.height},setDevicePixelRatio:function(t){this.devicePixelRatio=t,this.resize(this._width,this._height)},getDevicePixelRatio:function(){return this.devicePixelRatio},getGLExtension:function(t){return this._glinfo.getExtension(t)},getGLParameter:function(t){return this._glinfo.getParameter(t)},setViewport:function(t,e,r,n,i){if("object"==typeof t){var o=t;t=o.x,e=o.y,r=o.width,n=o.height,i=o.devicePixelRatio}i=i||this.devicePixelRatio,this.gl.viewport(t*i,e*i,r*i,n*i),this.viewport={x:t,y:e,width:r,height:n,devicePixelRatio:i}},saveViewport:function(){this._viewportStack.push(this.viewport)},restoreViewport:function(){this._viewportStack.length>0&&this.setViewport(this._viewportStack.pop())},saveClear:function(){this._clearStack.push({clearBit:this.clearBit,clearColor:this.clearColor})},restoreClear:function(){if(this._clearStack.length>0){var t=this._clearStack.pop();this.clearColor=t.clearColor,this.clearBit=t.clearBit}},bindSceneRendering:function(t){this._sceneRendering=t},render:function(t,e,r,n){var i=this.gl,o=this.clearColor;if(this.clearBit){i.colorMask(!0,!0,!0,!0),i.depthMask(!0);var a=this.viewport,s=!1,h=a.devicePixelRatio;(a.width!==this._width||a.height!==this._height||h&&h!==this.devicePixelRatio||a.x||a.y)&&(s=!0,i.enable(i.SCISSOR_TEST),i.scissor(a.x*h,a.y*h,a.width*h,a.height*h)),i.clearColor(o[0],o[1],o[2],o[3]),i.clear(this.clearBit),s&&i.disable(i.SCISSOR_TEST)}if(r||t.update(!1),t.updateLights(),e=e||t.getMainCamera()){e.update();var u=t.updateRenderList(e,!0);this._sceneRendering=t;var l=u.opaque,c=u.transparent,f=t.material;t.trigger("beforerender",this,t,e,u),n?(this.renderPreZ(l,t,e),i.depthFunc(i.LEQUAL)):i.depthFunc(i.LESS);for(var d=za(),p=D.create(),m=0;m<c.length;m++){var g=c[m];K.multiplyAffine(d,e.viewMatrix.array,g.worldTransform.array),D.transformMat4(p,g.position.array,d),g.__depth=p[2]}this.renderPass(l,e,{getMaterial:function(t){return f||t.material},sortCompare:this.opaqueSortCompare}),this.renderPass(c,e,{getMaterial:function(t){return f||t.material},sortCompare:this.transparentSortCompare}),t.trigger("afterrender",this,t,e,u),this._sceneRendering=null}else console.error("Can't find camera in the scene.")},getProgram:function(t,e,r){return e=e||t.material,this._programMgr.getProgram(t,e,r)},validateProgram:function(t){if(t.__error){var e=t.__error;if(Ua[t.__uid__])return;if(Ua[t.__uid__]=!0,this.throwError)throw new Error(e);this.trigger("error",e)}},updatePrograms:function(t,e,r){var n=r&&r.getMaterial||Ha;e=e||null;for(var i=0;i<t.length;i++){var o=t[i],a=n.call(this,o);if(i>0){var s=t[i-1],h=s.joints?s.joints.length:0;if((o.joints?o.joints.length:0)===h&&o.material===s.material&&o.lightGroup===s.lightGroup){o.__program=s.__program;continue}}var u=this._programMgr.getProgram(o,a,e);this.validateProgram(u),o.__program=u}},renderPass:function(t,e,r){this.trigger("beforerenderpass",this,t,e,r),(r=r||{}).getMaterial=r.getMaterial||Ha,r.getUniform=r.getUniform||ja,r.isMaterialChanged=r.isMaterialChanged||Ga,r.beforeRender=r.beforeRender||Wa,r.afterRender=r.afterRender||Wa;var n=r.ifRender||Va;this.updatePrograms(t,this._sceneRendering,r),r.sortCompare&&t.sort(r.sortCompare);var i=this.viewport,o=i.devicePixelRatio,a=[i.x*o,i.y*o,i.width*o,i.height*o],s=this.devicePixelRatio,h=this.__currentFrameBuffer?[this.__currentFrameBuffer.getTextureWidth(),this.__currentFrameBuffer.getTextureHeight()]:[this._width*s,this._height*s],u=[a[2],a[3]],l=Date.now();e?(K.copy(qa.VIEW,e.viewMatrix.array),K.copy(qa.PROJECTION,e.projectionMatrix.array),K.copy(qa.VIEWINVERSE,e.worldTransform.array)):(K.identity(qa.VIEW),K.identity(qa.PROJECTION),K.identity(qa.VIEWINVERSE)),K.multiply(qa.VIEWPROJECTION,qa.PROJECTION,qa.VIEW),K.invert(qa.PROJECTIONINVERSE,qa.PROJECTION),K.invert(qa.VIEWPROJECTIONINVERSE,qa.VIEWPROJECTION);for(var c,f,d,p,m,g,_,y,v,x,b,w,T=this.gl,E=this._sceneRendering,C=0;C<t.length;C++){var S,A=t[C],M=null!=A.worldTransform;if(n(A)){M&&(S=A.isSkinnedMesh&&A.isSkinnedMesh()?qa.IDENTITY:A.worldTransform.array);var P=A.geometry,R=r.getMaterial.call(this,A),L=A.__program,O=R.shader,k=P.__uid__+"-"+L.__uid__,D=k!==x;x=k,M&&(K.copy(qa.WORLD,S),K.multiply(qa.WORLDVIEWPROJECTION,qa.VIEWPROJECTION,S),K.multiplyAffine(qa.WORLDVIEW,qa.VIEW,S),(O.matrixSemantics.WORLDINVERSE||O.matrixSemantics.WORLDINVERSETRANSPOSE)&&K.invert(qa.WORLDINVERSE,S),(O.matrixSemantics.WORLDVIEWINVERSE||O.matrixSemantics.WORLDVIEWINVERSETRANSPOSE)&&K.invert(qa.WORLDVIEWINVERSE,qa.WORLDVIEW),(O.matrixSemantics.WORLDVIEWPROJECTIONINVERSE||O.matrixSemantics.WORLDVIEWPROJECTIONINVERSETRANSPOSE)&&K.invert(qa.WORLDVIEWPROJECTIONINVERSE,qa.WORLDVIEWPROJECTION)),A.beforeRender&&A.beforeRender(this),r.beforeRender.call(this,A,R,c);var I=L!==f;I?(L.bind(this),L.setUniformOfSemantic(T,"VIEWPORT",a),L.setUniformOfSemantic(T,"WINDOW_SIZE",h),e&&(L.setUniformOfSemantic(T,"NEAR",e.near),L.setUniformOfSemantic(T,"FAR",e.far)),L.setUniformOfSemantic(T,"DEVICEPIXELRATIO",o),L.setUniformOfSemantic(T,"TIME",l),L.setUniformOfSemantic(T,"VIEWPORT_SIZE",u),E&&E.setLightUniforms(L,A.lightGroup,this)):L=f,(I||r.isMaterialChanged(A,d,R,c))&&(R.depthTest!==p&&(R.depthTest?T.enable(T.DEPTH_TEST):T.disable(T.DEPTH_TEST),p=R.depthTest),R.depthMask!==m&&(T.depthMask(R.depthMask),m=R.depthMask),R.transparent!==v&&(R.transparent?T.enable(T.BLEND):T.disable(T.BLEND),v=R.transparent),R.transparent&&(R.blend?R.blend(T):(T.blendEquationSeparate(T.FUNC_ADD,T.FUNC_ADD),T.blendFuncSeparate(T.SRC_ALPHA,T.ONE_MINUS_SRC_ALPHA,T.ONE,T.ONE_MINUS_SRC_ALPHA))),w=this._bindMaterial(A,R,L,d||null,c||null,f||null,r.getUniform),c=R);var N=O.matrixSemanticKeys;if(M)for(var F=0;F<N.length;F++){var B=N[F],z=O.matrixSemantics[B],U=qa[B];if(z.isTranspose){var H=qa[z.semanticNoTranspose];K.transpose(U,H)}L.setUniform(T,z.type,z.symbol,U)}A.cullFace!==_&&(_=A.cullFace,T.cullFace(_)),A.frontFace!==y&&(y=A.frontFace,T.frontFace(y)),A.culling!==g&&((g=A.culling)?T.enable(T.CULL_FACE):T.disable(T.CULL_FACE)),this._updateSkeleton(A,L,w),D&&(b=this._bindVAO(null,O,P,L)),this._renderObject(A,b),r.afterRender(this,A),A.afterRender&&A.afterRender(this),f=L,d=A}}this.trigger("afterrenderpass",this,t,e,r)},getMaxJointNumber:function(){return this._glinfo.getMaxJointNumber()},_updateSkeleton:function(t,e,r){var n=this.gl,i=t.skeleton;if(i)if(i.update(),t.joints.length>this._glinfo.getMaxJointNumber()){var o=i.getSubSkinMatricesTexture(t.__uid__,t.joints);e.useTextureSlot(this,o,r),e.setUniform(n,"1i","skinMatricesTexture",r),e.setUniform(n,"1f","skinMatricesTextureSize",o.width)}else{var a=i.getSubSkinMatrices(t.__uid__,t.joints);e.setUniformOfSemantic(n,"SKIN_MATRIX",a)}},_renderObject:function(t,e){var r=this.gl,n=t.geometry,i=t.mode;if(null==i&&(i=4),e.indicesBuffer){var o=this.getGLExtension("OES_element_index_uint")&&n.indices instanceof Uint32Array?r.UNSIGNED_INT:r.UNSIGNED_SHORT;r.drawElements(i,e.indicesBuffer.count,o,0)}else r.drawArrays(i,0,n.vertexCount)},_bindMaterial:function(t,e,r,n,i,o,a){for(var s=this.gl,h=o===r,u=r.currentTextureSlot(),l=e.getEnabledUniforms(),c=e.getTextureUniforms(),f=this._placeholderTexture,d=0;d<c.length;d++){var p=a(t,e,_=c[d]);if("t"===(g=e.uniforms[_].type)&&p)p.__slot=-1;else if("tv"===g)for(var m=0;m<p.length;m++)p[m]&&(p[m].__slot=-1)}f.__slot=-1;for(d=0;d<l.length;d++){var g,_=l[d],y=e.uniforms[_],v=(p=a(t,e,_),"t"===(g=y.type));if(v&&(p&&p.isRenderable()||(p=f)),i&&h){var x=a(n,i,_);if(v&&(x&&x.isRenderable()||(x=f)),x===p){if(v)r.takeCurrentTextureSlot(this,null);else if("tv"===g&&p)for(m=0;m<p.length;m++)r.takeCurrentTextureSlot(this,null);continue}}if(null!=p)if(v)if(p.__slot<0){var b=r.currentTextureSlot();r.setUniform(s,"1i",_,b)&&(r.takeCurrentTextureSlot(this,p),p.__slot=b)}else r.setUniform(s,"1i",_,p.__slot);else if(Array.isArray(p)){if(0===p.length)continue;if("tv"===g){if(!r.hasUniform(_))continue;var w=[];for(m=0;m<p.length;m++){var T=p[m];if(T.__slot<0){b=r.currentTextureSlot();w.push(b),r.takeCurrentTextureSlot(this,T),T.__slot=b}else w.push(T.__slot)}r.setUniform(s,"1iv",_,w)}else r.setUniform(s,y.type,_,p)}else r.setUniform(s,y.type,_,p)}var E=r.currentTextureSlot();return r.resetTextureSlot(u),E},_bindVAO:function(t,e,r,n){var i=!r.dynamic,o=this.gl,a=this.__uid__+"-"+n.__uid__,s=r.__vaoCache[a];if(!s){var h=r.getBufferChunks(this);if(!h||!h.length)return;for(var u=h[0],l=u.attributeBuffers,c=u.indicesBuffer,f=[],d=[],p=0;p<l.length;p++){var m,g=(w=l[p]).name,_=w.semantic;if(_){var y=e.attributeSemantics[_];m=y&&y.symbol}else m=g;m&&n.attributes[m]&&(f.push(w),d.push(m))}s=new function(t,e,r){this.availableAttributes=t,this.availableAttributeSymbols=e,this.indicesBuffer=r,this.vao=null}(f,d,c),i&&(r.__vaoCache[a]=s)}var v=!0;t&&i&&(null==s.vao?s.vao=t.createVertexArrayOES():v=!1,t.bindVertexArrayOES(s.vao));f=s.availableAttributes,c=s.indicesBuffer;if(v){var x=n.enableAttributes(this,s.availableAttributeSymbols,t&&i&&s);for(p=0;p<f.length;p++){var b=x[p];if(-1!==b){var w,T=(w=f[p]).buffer,E=w.size,C=Za[w.type]||o.FLOAT;o.bindBuffer(o.ARRAY_BUFFER,T),o.vertexAttribPointer(b,E,C,!1,0,0)}}r.isUseIndices()&&o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,c.buffer)}return s},renderPreZ:function(t,e,r){var n=this.gl,i=this._prezMaterial||new Sn({shader:new en(en.source("clay.prez.vertex"),en.source("clay.prez.fragment"))});this._prezMaterial=i,n.colorMask(!1,!1,!1,!1),n.depthMask(!0),this.renderPass(t,r,{ifRender:function(t){return!t.ignorePreZ},isMaterialChanged:function(t,e){var r=t.material,n=e.material;return r.get("diffuseMap")!==n.get("diffuseMap")||(r.get("alphaCutoff")||0)!==(n.get("alphaCutoff")||0)},getUniform:function(t,e,r){return"alphaMap"===r?t.material.get("diffuseMap"):"alphaCutoff"===r?t.material.isDefined("fragment","ALPHA_TEST")&&t.material.get("diffuseMap")&&t.material.get("alphaCutoff")||0:e.get(r)},getMaterial:function(){return i},sort:this.opaqueSortCompare}),n.colorMask(!0,!0,!0,!0),n.depthMask(!0)},disposeScene:function(t){this.disposeNode(t,!0,!0),t.dispose()},disposeNode:function(t,e,r){t.getParent()&&t.getParent().remove(t);var n={};t.traverse(function(t){var i=t.material;if(t.geometry&&e&&t.geometry.dispose(this),r&&i&&!n[i.__uid__]){for(var o=i.getTextureUniforms(),a=0;a<o.length;a++){var s=o[a],h=i.uniforms[s].value,u=i.uniforms[s].type;if(h)if("t"===u)h.dispose&&h.dispose(this);else if("tv"===u)for(var l=0;l<h.length;l++)h[l]&&h[l].dispose&&h[l].dispose(this)}n[i.__uid__]=!0}t.dispose&&t.dispose(this)},this)},disposeGeometry:function(t){t.dispose(this)},disposeTexture:function(t){t.dispose(this)},disposeFrameBuffer:function(t){t.dispose(this)},dispose:function(){},screenToNDC:function(t,e,r){r||(r=new re),e=this._height-e;var n=this.viewport,i=r.array;return i[0]=(t-n.x)/n.width,i[0]=2*i[0]-1,i[1]=(e-n.y)/n.height,i[1]=2*i[1]-1,r}});Xa.opaqueSortCompare=Xa.prototype.opaqueSortCompare=function(t,e){return t.renderOrder===e.renderOrder?t.__program===e.__program?t.material===e.material?t.geometry.__uid__-e.geometry.__uid__:t.material.__uid__-e.material.__uid__:t.__program&&e.__program?t.__program.__uid__-e.__program.__uid__:0:t.renderOrder-e.renderOrder},Xa.transparentSortCompare=Xa.prototype.transparentSortCompare=function(t,e){return t.renderOrder===e.renderOrder?t.__depth===e.__depth?t.__program===e.__program?t.material===e.material?t.geometry.__uid__-e.geometry.__uid__:t.material.__uid__-e.material.__uid__:t.__program&&e.__program?t.__program.__uid__-e.__program.__uid__:0:t.__depth-e.__depth:t.renderOrder-e.renderOrder};var qa={IDENTITY:za(),WORLD:za(),VIEW:za(),PROJECTION:za(),WORLDVIEW:za(),VIEWPROJECTION:za(),WORLDVIEWPROJECTION:za(),WORLDINVERSE:za(),VIEWINVERSE:za(),PROJECTIONINVERSE:za(),WORLDVIEWINVERSE:za(),VIEWPROJECTIONINVERSE:za(),WORLDVIEWPROJECTIONINVERSE:za(),WORLDTRANSPOSE:za(),VIEWTRANSPOSE:za(),PROJECTIONTRANSPOSE:za(),WORLDVIEWTRANSPOSE:za(),VIEWPROJECTIONTRANSPOSE:za(),WORLDVIEWPROJECTIONTRANSPOSE:za(),WORLDINVERSETRANSPOSE:za(),VIEWINVERSETRANSPOSE:za(),PROJECTIONINVERSETRANSPOSE:za(),WORLDVIEWINVERSETRANSPOSE:za(),VIEWPROJECTIONINVERSETRANSPOSE:za(),WORLDVIEWPROJECTIONINVERSETRANSPOSE:za()};Xa.COLOR_BUFFER_BIT=ft.COLOR_BUFFER_BIT,Xa.DEPTH_BUFFER_BIT=ft.DEPTH_BUFFER_BIT,Xa.STENCIL_BUFFER_BIT=ft.STENCIL_BUFFER_BIT;var Ya=Xa,Ja=["px","nx","py","ny","pz","nz"];function Ka(t,e,r){return"alphaMap"===r?t.material.get("diffuseMap"):"alphaCutoff"===r?t.material.isDefined("fragment","ALPHA_TEST")&&t.material.get("diffuseMap")&&t.material.get("alphaCutoff")||0:e.get(r)}function Qa(t,e){var r=t.material,n=e.material;return r.get("diffuseMap")!==n.get("diffuseMap")||(r.get("alphaCutoff")||0)!==(n.get("alphaCutoff")||0)}en.import("@export clay.sm.depth.vertex\nuniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\nattribute vec3 position : POSITION;\nattribute vec2 texcoord : TEXCOORD_0;\n@import clay.chunk.skinning_header\nvarying vec4 v_ViewPosition;\nvarying vec2 v_Texcoord;\nvoid main(){\n vec3 skinnedPosition = position;\n#ifdef SKINNING\n @import clay.chunk.skin_matrix\n skinnedPosition = (skinMatrixWS * vec4(position, 1.0)).xyz;\n#endif\n v_ViewPosition = worldViewProjection * vec4(skinnedPosition, 1.0);\n gl_Position = v_ViewPosition;\n v_Texcoord = texcoord;\n}\n@end\n@export clay.sm.depth.fragment\nvarying vec4 v_ViewPosition;\nvarying vec2 v_Texcoord;\nuniform float bias : 0.001;\nuniform float slopeScale : 1.0;\nuniform sampler2D alphaMap;\nuniform float alphaCutoff: 0.0;\n@import clay.util.encode_float\nvoid main(){\n float depth = v_ViewPosition.z / v_ViewPosition.w;\n if (alphaCutoff > 0.0) {\n if (texture2D(alphaMap, v_Texcoord).a <= alphaCutoff) {\n discard;\n }\n }\n#ifdef USE_VSM\n depth = depth * 0.5 + 0.5;\n float moment1 = depth;\n float moment2 = depth * depth;\n #ifdef SUPPORT_STANDARD_DERIVATIVES\n float dx = dFdx(depth);\n float dy = dFdy(depth);\n moment2 += 0.25*(dx*dx+dy*dy);\n #endif\n gl_FragColor = vec4(moment1, moment2, 0.0, 1.0);\n#else\n #ifdef SUPPORT_STANDARD_DERIVATIVES\n float dx = dFdx(depth);\n float dy = dFdy(depth);\n depth += sqrt(dx*dx + dy*dy) * slopeScale + bias;\n #else\n depth += bias;\n #endif\n gl_FragColor = encodeFloat(depth * 0.5 + 0.5);\n#endif\n}\n@end\n@export clay.sm.debug_depth\nuniform sampler2D depthMap;\nvarying vec2 v_Texcoord;\n@import clay.util.decode_float\nvoid main() {\n vec4 tex = texture2D(depthMap, v_Texcoord);\n#ifdef USE_VSM\n gl_FragColor = vec4(tex.rgb, 1.0);\n#else\n float depth = decodeFloat(tex);\n gl_FragColor = vec4(depth, depth, depth, 1.0);\n#endif\n}\n@end\n@export clay.sm.distance.vertex\nuniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\nuniform mat4 world : WORLD;\nattribute vec3 position : POSITION;\n@import clay.chunk.skinning_header\nvarying vec3 v_WorldPosition;\nvoid main (){\n vec3 skinnedPosition = position;\n#ifdef SKINNING\n @import clay.chunk.skin_matrix\n skinnedPosition = (skinMatrixWS * vec4(position, 1.0)).xyz;\n#endif\n gl_Position = worldViewProjection * vec4(skinnedPosition , 1.0);\n v_WorldPosition = (world * vec4(skinnedPosition, 1.0)).xyz;\n}\n@end\n@export clay.sm.distance.fragment\nuniform vec3 lightPosition;\nuniform float range : 100;\nvarying vec3 v_WorldPosition;\n@import clay.util.encode_float\nvoid main(){\n float dist = distance(lightPosition, v_WorldPosition);\n#ifdef USE_VSM\n gl_FragColor = vec4(dist, dist * dist, 0.0, 0.0);\n#else\n dist = dist / range;\n gl_FragColor = encodeFloat(dist);\n#endif\n}\n@end\n@export clay.plugin.shadow_map_common\n@import clay.util.decode_float\nfloat tapShadowMap(sampler2D map, vec2 uv, float z){\n vec4 tex = texture2D(map, uv);\n return step(z, decodeFloat(tex) * 2.0 - 1.0);\n}\nfloat pcf(sampler2D map, vec2 uv, float z, float textureSize, vec2 scale) {\n float shadowContrib = tapShadowMap(map, uv, z);\n vec2 offset = vec2(1.0 / textureSize) * scale;\n#ifdef PCF_KERNEL_SIZE\n for (int _idx_ = 0; _idx_ < PCF_KERNEL_SIZE; _idx_++) {{\n shadowContrib += tapShadowMap(map, uv + offset * pcfKernel[_idx_], z);\n }}\n return shadowContrib / float(PCF_KERNEL_SIZE + 1);\n#else\n shadowContrib += tapShadowMap(map, uv+vec2(offset.x, 0.0), z);\n shadowContrib += tapShadowMap(map, uv+vec2(offset.x, offset.y), z);\n shadowContrib += tapShadowMap(map, uv+vec2(-offset.x, offset.y), z);\n shadowContrib += tapShadowMap(map, uv+vec2(0.0, offset.y), z);\n shadowContrib += tapShadowMap(map, uv+vec2(-offset.x, 0.0), z);\n shadowContrib += tapShadowMap(map, uv+vec2(-offset.x, -offset.y), z);\n shadowContrib += tapShadowMap(map, uv+vec2(offset.x, -offset.y), z);\n shadowContrib += tapShadowMap(map, uv+vec2(0.0, -offset.y), z);\n return shadowContrib / 9.0;\n#endif\n}\nfloat pcf(sampler2D map, vec2 uv, float z, float textureSize) {\n return pcf(map, uv, z, textureSize, vec2(1.0));\n}\nfloat chebyshevUpperBound(vec2 moments, float z){\n float p = 0.0;\n z = z * 0.5 + 0.5;\n if (z <= moments.x) {\n p = 1.0;\n }\n float variance = moments.y - moments.x * moments.x;\n variance = max(variance, 0.0000001);\n float mD = moments.x - z;\n float pMax = variance / (variance + mD * mD);\n pMax = clamp((pMax-0.4)/(1.0-0.4), 0.0, 1.0);\n return max(p, pMax);\n}\nfloat computeShadowContrib(\n sampler2D map, mat4 lightVPM, vec3 position, float textureSize, vec2 scale, vec2 offset\n) {\n vec4 posInLightSpace = lightVPM * vec4(position, 1.0);\n posInLightSpace.xyz /= posInLightSpace.w;\n float z = posInLightSpace.z;\n if(all(greaterThan(posInLightSpace.xyz, vec3(-0.99, -0.99, -1.0))) &&\n all(lessThan(posInLightSpace.xyz, vec3(0.99, 0.99, 1.0)))){\n vec2 uv = (posInLightSpace.xy+1.0) / 2.0;\n #ifdef USE_VSM\n vec2 moments = texture2D(map, uv * scale + offset).xy;\n return chebyshevUpperBound(moments, z);\n #else\n return pcf(map, uv * scale + offset, z, textureSize, scale);\n #endif\n }\n return 1.0;\n}\nfloat computeShadowContrib(sampler2D map, mat4 lightVPM, vec3 position, float textureSize) {\n return computeShadowContrib(map, lightVPM, position, textureSize, vec2(1.0), vec2(0.0));\n}\nfloat computeShadowContribOmni(samplerCube map, vec3 direction, float range)\n{\n float dist = length(direction);\n vec4 shadowTex = textureCube(map, direction);\n#ifdef USE_VSM\n vec2 moments = shadowTex.xy;\n float variance = moments.y - moments.x * moments.x;\n float mD = moments.x - dist;\n float p = variance / (variance + mD * mD);\n if(moments.x + 0.001 < dist){\n return clamp(p, 0.0, 1.0);\n }else{\n return 1.0;\n }\n#else\n return step(dist, (decodeFloat(shadowTex) + 0.0002) * range);\n#endif\n}\n@end\n@export clay.plugin.compute_shadow_map\n#if defined(SPOT_LIGHT_SHADOWMAP_COUNT) || defined(DIRECTIONAL_LIGHT_SHADOWMAP_COUNT) || defined(POINT_LIGHT_SHADOWMAP_COUNT)\n#ifdef SPOT_LIGHT_SHADOWMAP_COUNT\nuniform sampler2D spotLightShadowMaps[SPOT_LIGHT_SHADOWMAP_COUNT]:unconfigurable;\nuniform mat4 spotLightMatrices[SPOT_LIGHT_SHADOWMAP_COUNT]:unconfigurable;\nuniform float spotLightShadowMapSizes[SPOT_LIGHT_SHADOWMAP_COUNT]:unconfigurable;\n#endif\n#ifdef DIRECTIONAL_LIGHT_SHADOWMAP_COUNT\n#if defined(SHADOW_CASCADE)\nuniform sampler2D directionalLightShadowMaps[1]:unconfigurable;\nuniform mat4 directionalLightMatrices[SHADOW_CASCADE]:unconfigurable;\nuniform float directionalLightShadowMapSizes[1]:unconfigurable;\nuniform float shadowCascadeClipsNear[SHADOW_CASCADE]:unconfigurable;\nuniform float shadowCascadeClipsFar[SHADOW_CASCADE]:unconfigurable;\n#else\nuniform sampler2D directionalLightShadowMaps[DIRECTIONAL_LIGHT_SHADOWMAP_COUNT]:unconfigurable;\nuniform mat4 directionalLightMatrices[DIRECTIONAL_LIGHT_SHADOWMAP_COUNT]:unconfigurable;\nuniform float directionalLightShadowMapSizes[DIRECTIONAL_LIGHT_SHADOWMAP_COUNT]:unconfigurable;\n#endif\n#endif\n#ifdef POINT_LIGHT_SHADOWMAP_COUNT\nuniform samplerCube pointLightShadowMaps[POINT_LIGHT_SHADOWMAP_COUNT]:unconfigurable;\n#endif\nuniform bool shadowEnabled : true;\n#ifdef PCF_KERNEL_SIZE\nuniform vec2 pcfKernel[PCF_KERNEL_SIZE];\n#endif\n@import clay.plugin.shadow_map_common\n#if defined(SPOT_LIGHT_SHADOWMAP_COUNT)\nvoid computeShadowOfSpotLights(vec3 position, inout float shadowContribs[SPOT_LIGHT_COUNT] ) {\n float shadowContrib;\n for(int _idx_ = 0; _idx_ < SPOT_LIGHT_SHADOWMAP_COUNT; _idx_++) {{\n shadowContrib = computeShadowContrib(\n spotLightShadowMaps[_idx_], spotLightMatrices[_idx_], position,\n spotLightShadowMapSizes[_idx_]\n );\n shadowContribs[_idx_] = shadowContrib;\n }}\n for(int _idx_ = SPOT_LIGHT_SHADOWMAP_COUNT; _idx_ < SPOT_LIGHT_COUNT; _idx_++){{\n shadowContribs[_idx_] = 1.0;\n }}\n}\n#endif\n#if defined(DIRECTIONAL_LIGHT_SHADOWMAP_COUNT)\n#ifdef SHADOW_CASCADE\nvoid computeShadowOfDirectionalLights(vec3 position, inout float shadowContribs[DIRECTIONAL_LIGHT_COUNT]){\n float depth = (2.0 * gl_FragCoord.z - gl_DepthRange.near - gl_DepthRange.far)\n / (gl_DepthRange.far - gl_DepthRange.near);\n float shadowContrib;\n shadowContribs[0] = 1.0;\n for (int _idx_ = 0; _idx_ < SHADOW_CASCADE; _idx_++) {{\n if (\n depth >= shadowCascadeClipsNear[_idx_] &&\n depth <= shadowCascadeClipsFar[_idx_]\n ) {\n shadowContrib = computeShadowContrib(\n directionalLightShadowMaps[0], directionalLightMatrices[_idx_], position,\n directionalLightShadowMapSizes[0],\n vec2(1.0 / float(SHADOW_CASCADE), 1.0),\n vec2(float(_idx_) / float(SHADOW_CASCADE), 0.0)\n );\n shadowContribs[0] = shadowContrib;\n }\n }}\n for(int _idx_ = DIRECTIONAL_LIGHT_SHADOWMAP_COUNT; _idx_ < DIRECTIONAL_LIGHT_COUNT; _idx_++) {{\n shadowContribs[_idx_] = 1.0;\n }}\n}\n#else\nvoid computeShadowOfDirectionalLights(vec3 position, inout float shadowContribs[DIRECTIONAL_LIGHT_COUNT]){\n float shadowContrib;\n for(int _idx_ = 0; _idx_ < DIRECTIONAL_LIGHT_SHADOWMAP_COUNT; _idx_++) {{\n shadowContrib = computeShadowContrib(\n directionalLightShadowMaps[_idx_], directionalLightMatrices[_idx_], position,\n directionalLightShadowMapSizes[_idx_]\n );\n shadowContribs[_idx_] = shadowContrib;\n }}\n for(int _idx_ = DIRECTIONAL_LIGHT_SHADOWMAP_COUNT; _idx_ < DIRECTIONAL_LIGHT_COUNT; _idx_++) {{\n shadowContribs[_idx_] = 1.0;\n }}\n}\n#endif\n#endif\n#if defined(POINT_LIGHT_SHADOWMAP_COUNT)\nvoid computeShadowOfPointLights(vec3 position, inout float shadowContribs[POINT_LIGHT_COUNT] ){\n vec3 lightPosition;\n vec3 direction;\n for(int _idx_ = 0; _idx_ < POINT_LIGHT_SHADOWMAP_COUNT; _idx_++) {{\n lightPosition = pointLightPosition[_idx_];\n direction = position - lightPosition;\n shadowContribs[_idx_] = computeShadowContribOmni(pointLightShadowMaps[_idx_], direction, pointLightRange[_idx_]);\n }}\n for(int _idx_ = POINT_LIGHT_SHADOWMAP_COUNT; _idx_ < POINT_LIGHT_COUNT; _idx_++) {{\n shadowContribs[_idx_] = 1.0;\n }}\n}\n#endif\n#endif\n@end");var $a,ts,es,rs,ns,is,os,as=ct.extend(function(){return{softShadow:as.PCF,shadowBlur:1,lightFrustumBias:"auto",kernelPCF:new Float32Array([1,0,1,1,-1,1,0,1,-1,0,-1,-1,1,-1,0,-1]),precision:"highp",_lastRenderNotCastShadow:!1,_frameBuffer:new Or,_textures:{},_shadowMapNumber:{POINT_LIGHT:0,DIRECTIONAL_LIGHT:0,SPOT_LIGHT:0},_depthMaterials:{},_distanceMaterials:{},_receivers:[],_lightsCastShadow:[],_lightCameras:{},_lightMaterials:{},_texturePool:new Sr}},function(){this._gaussianPassH=new Dn({fragment:en.source("clay.compositor.gaussian_blur")}),this._gaussianPassV=new Dn({fragment:en.source("clay.compositor.gaussian_blur")}),this._gaussianPassH.setUniform("blurSize",this.shadowBlur),this._gaussianPassH.setUniform("blurDir",0),this._gaussianPassV.setUniform("blurSize",this.shadowBlur),this._gaussianPassV.setUniform("blurDir",1),this._outputDepthPass=new Dn({fragment:en.source("clay.sm.debug_depth")})},{render:function(t,e,r,n){r||(r=e.getMainCamera()),this.trigger("beforerender",this,t,e,r),this._renderShadowPass(t,e,r,n),this.trigger("afterrender",this,t,e,r)},renderDebug:function(t,e){t.saveClear();var r=t.viewport,n=0,i=e||r.width/4,o=i;for(var a in this.softShadow===as.VSM?this._outputDepthPass.material.define("fragment","USE_VSM"):this._outputDepthPass.material.undefine("fragment","USE_VSM"),this._textures){var s=this._textures[a];t.setViewport(n,0,i*s.width/s.height,o),this._outputDepthPass.setUniform("depthMap",s),this._outputDepthPass.render(t),n+=i*s.width/s.height}t.setViewport(r),t.restoreClear()},_updateReceivers:function(t,e){if(e.receiveShadow?(this._receivers.push(e),e.material.set("shadowEnabled",1),e.material.set("pcfKernel",this.kernelPCF)):e.material.set("shadowEnabled",0),this.softShadow===as.VSM)e.material.define("fragment","USE_VSM"),e.material.undefine("fragment","PCF_KERNEL_SIZE");else{e.material.undefine("fragment","USE_VSM");var r=this.kernelPCF;r&&r.length?e.material.define("fragment","PCF_KERNEL_SIZE",r.length/2):e.material.undefine("fragment","PCF_KERNEL_SIZE")}},_update:function(t,e){var r=this;e.traverse(function(e){e.isRenderable()&&r._updateReceivers(t,e)});for(var n=0;n<e.lights.length;n++){var i=e.lights[n];i.castShadow&&!i.invisible&&this._lightsCastShadow.push(i)}},_renderShadowPass:function(t,e,r,n){for(var i in this._shadowMapNumber)this._shadowMapNumber[i]=0;this._lightsCastShadow.length=0,this._receivers.length=0;var o=t.gl;if(n||e.update(),r&&r.update(),e.updateLights(),this._update(t,e),this._lightsCastShadow.length||!this._lastRenderNotCastShadow){this._lastRenderNotCastShadow=0===this._lightsCastShadow,o.enable(o.DEPTH_TEST),o.depthMask(!0),o.disable(o.BLEND),o.clearColor(1,1,1,1);for(var a,s=[],h=[],u=[],l=[],c=[],f=[],d=0;d<this._lightsCastShadow.length;d++){var p=this._lightsCastShadow[d];if("DIRECTIONAL_LIGHT"===p.type){if(a){console.warn("Only one direectional light supported with shadow cascade");continue}if(p.shadowCascade>4){console.warn("Support at most 4 cascade");continue}p.shadowCascade>1&&(a=p),this.renderDirectionalLightShadow(t,e,r,p,c,l,u)}else"SPOT_LIGHT"===p.type?this.renderSpotLightShadow(t,e,p,h,s):"POINT_LIGHT"===p.type&&this.renderPointLightShadow(t,e,p,f);this._shadowMapNumber[p.type]++}for(var m in this._shadowMapNumber){var g=this._shadowMapNumber[m],_=m+"_SHADOWMAP_COUNT";for(d=0;d<this._receivers.length;d++){(y=this._receivers[d].material).fragmentDefines[_]!==g&&(g>0?y.define("fragment",_,g):y.isDefined("fragment",_)&&y.undefine("fragment",_))}}for(d=0;d<this._receivers.length;d++){var y=this._receivers[d].material;a?y.define("fragment","SHADOW_CASCADE",a.shadowCascade):y.undefine("fragment","SHADOW_CASCADE")}var v=e.shadowUniforms;if(u.length>0){var x=u.map(E);if(v.directionalLightShadowMaps={value:u,type:"tv"},v.directionalLightMatrices={value:l,type:"m4v"},v.directionalLightShadowMapSizes={value:x,type:"1fv"},a){var b=c.slice(),w=c.slice();b.pop(),w.shift(),b.reverse(),w.reverse(),l.reverse(),v.shadowCascadeClipsNear={value:b,type:"1fv"},v.shadowCascadeClipsFar={value:w,type:"1fv"}}}if(s.length>0){var T=s.map(E);(v=e.shadowUniforms).spotLightShadowMaps={value:s,type:"tv"},v.spotLightMatrices={value:h,type:"m4v"},v.spotLightShadowMapSizes={value:T,type:"1fv"}}f.length>0&&(v.pointLightShadowMaps={value:f,type:"tv"})}function E(t){return t.height}},renderDirectionalLightShadow:($a=new or,ts=new Ge,es=new et,rs=new Ge,ns=new Ge,is=new Ge,os=new Ge,function(t,e,r,n,i,o,a){var s=this._getDepthMaterial(n),h={getMaterial:function(t){return t.shadowDepthMaterial||s},isMaterialChanged:Qa,getUniform:Ka,ifRender:function(t){return t.castShadow},sortCompare:Ya.opaqueSortCompare};if(!e.viewBoundingBoxLastFrame.isFinite()){var u=e.getBoundingBox();e.viewBoundingBoxLastFrame.copy(u).applyTransform(r.viewMatrix)}var l=Math.min(-e.viewBoundingBoxLastFrame.min.z,r.far),c=Math.max(-e.viewBoundingBoxLastFrame.max.z,r.near),f=this._getDirectionalLightCamera(n,e,r),d=is.array;os.copy(f.projectionMatrix),K.invert(ns.array,f.worldTransform.array),K.multiply(ns.array,ns.array,r.worldTransform.array),K.multiply(d,os.array,ns.array);for(var p=[],m=r instanceof cr,g=(r.near+r.far)/(r.near-r.far),_=2*r.near*r.far/(r.near-r.far),y=0;y<=n.shadowCascade;y++){var v=c*Math.pow(l/c,y/n.shadowCascade),x=c+(l-c)*y/n.shadowCascade,b=v*n.cascadeSplitLogFactor+x*(1-n.cascadeSplitLogFactor);p.push(b),i.push(-(-b*g+_)/-b)}var w=this._getTexture(n,n.shadowCascade);a.push(w);var T=t.viewport,E=t.gl;for(this._frameBuffer.attach(w),this._frameBuffer.bind(t),E.clear(E.COLOR_BUFFER_BIT|E.DEPTH_BUFFER_BIT),y=0;y<n.shadowCascade;y++){var C=p[y],S=p[y+1];m?K.perspective(ts.array,r.fov/180*Math.PI,r.aspect,C,S):K.ortho(ts.array,r.left,r.right,r.bottom,r.top,C,S),$a.setFromProjection(ts),$a.getTransformedBoundingBox(es,ns),es.applyProjection(os);var A=es.min.array,M=es.max.array;A[0]=Math.max(A[0],-1),A[1]=Math.max(A[1],-1),M[0]=Math.min(M[0],1),M[1]=Math.min(M[1],1),rs.ortho(A[0],M[0],A[1],M[1],1,-1),f.projectionMatrix.multiplyLeft(rs);var P=n.shadowResolution||512;t.setViewport((n.shadowCascade-y-1)*P,0,P,P,1);var R=e.updateRenderList(f);t.renderPass(R.opaque,f,h),this.softShadow===as.VSM&&this._gaussianFilter(t,w,w.width);var L=new Ge;L.copy(f.viewMatrix).multiplyLeft(f.projectionMatrix),o.push(L.array),f.projectionMatrix.copy(os)}this._frameBuffer.unbind(t),t.setViewport(T)}),renderSpotLightShadow:function(t,e,r,n,i){var o=this._getTexture(r),a=this._getSpotLightCamera(r),s=t.gl;this._frameBuffer.attach(o),this._frameBuffer.bind(t),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT);var h=this._getDepthMaterial(r),u={getMaterial:function(t){return t.shadowDepthMaterial||h},isMaterialChanged:Qa,getUniform:Ka,ifRender:function(t){return t.castShadow},sortCompare:Ya.opaqueSortCompare},l=e.updateRenderList(a);t.renderPass(l.opaque,a,u),this._frameBuffer.unbind(t),this.softShadow===as.VSM&&this._gaussianFilter(t,o,o.width);var c=new Ge;c.copy(a.worldTransform).invert().multiplyLeft(a.projectionMatrix),i.push(o),n.push(c.array)},renderPointLightShadow:function(t,e,r,n){var i=this._getTexture(r),o=t.gl;n.push(i);var a=this._getDepthMaterial(r),s={getMaterial:function(t){return t.shadowDepthMaterial||a},getUniform:Ka,sortCompare:Ya.opaqueSortCompare},h={px:[],py:[],pz:[],nx:[],ny:[],nz:[]},u=new et,l=r.getWorldPosition().array,c=new et,f=r.range;c.min.setArray(l),c.max.setArray(l);var d=new j(f,f,f);c.max.add(d),c.min.sub(d);var p={px:!1,py:!1,pz:!1,nx:!1,ny:!1,nz:!1};e.traverse(function(t){if(t.isRenderable()&&t.castShadow){var e=t.geometry;if(!e.boundingBox){for(var r=0;r<Ja.length;r++)h[Ja[r]].push(t);return}if(u.transformFrom(e.boundingBox,t.worldTransform),!u.intersectBoundingBox(c))return;u.updateVertices();for(r=0;r<Ja.length;r++)p[Ja[r]]=!1;for(r=0;r<8;r++){var n=u.vertices[r],i=n[0]-l[0],o=n[1]-l[1],a=n[2]-l[2],s=Math.abs(i),f=Math.abs(o),d=Math.abs(a);s>f?s>d?p[i>0?"px":"nx"]=!0:p[a>0?"pz":"nz"]=!0:f>d?p[o>0?"py":"ny"]=!0:p[a>0?"pz":"nz"]=!0}for(r=0;r<Ja.length;r++)p[Ja[r]]&&h[Ja[r]].push(t)}});for(var m=0;m<6;m++){var g=Ja[m],_=this._getPointLightCamera(r,g);this._frameBuffer.attach(i,o.COLOR_ATTACHMENT0,o.TEXTURE_CUBE_MAP_POSITIVE_X+m),this._frameBuffer.bind(t),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT),t.renderPass(h[g],_,s)}this._frameBuffer.unbind(t)},_getDepthMaterial:function(t){var e=this._lightMaterials[t.__uid__],r="POINT_LIGHT"===t.type;if(!e){var n=r?"clay.sm.distance.":"clay.sm.depth.";e=new Sn({precision:this.precision,shader:new en(en.source(n+"vertex"),en.source(n+"fragment"))}),this._lightMaterials[t.__uid__]=e}return null!=t.shadowSlopeScale&&e.setUniform("slopeScale",t.shadowSlopeScale),null!=t.shadowBias&&e.setUniform("bias",t.shadowBias),this.softShadow===as.VSM?e.define("fragment","USE_VSM"):e.undefine("fragment","USE_VSM"),r&&(e.set("lightPosition",t.getWorldPosition().array),e.set("range",t.range)),e},_gaussianFilter:function(t,e,r){var n={width:r,height:r,type:mr.FLOAT},i=this._texturePool.get(n);this._frameBuffer.attach(i),this._frameBuffer.bind(t),this._gaussianPassH.setUniform("texture",e),this._gaussianPassH.setUniform("textureWidth",r),this._gaussianPassH.render(t),this._frameBuffer.attach(e),this._gaussianPassV.setUniform("texture",i),this._gaussianPassV.setUniform("textureHeight",r),this._gaussianPassV.render(t),this._frameBuffer.unbind(t),this._texturePool.put(i)},_getTexture:function(t,e){var r=t.__uid__,n=this._textures[r],i=t.shadowResolution||512;return e=e||1,n||((n="POINT_LIGHT"===t.type?new Un:new br).width=i*e,n.height=i,this.softShadow===as.VSM?(n.type=mr.FLOAT,n.anisotropic=4):(n.minFilter=ft.NEAREST,n.magFilter=ft.NEAREST,n.useMipmap=!1),this._textures[r]=n),n},_getPointLightCamera:function(t,e){this._lightCameras.point||(this._lightCameras.point={px:new cr,nx:new cr,py:new cr,ny:new cr,pz:new cr,nz:new cr});var r=this._lightCameras.point[e];switch(r.far=t.range,r.fov=90,r.position.set(0,0,0),e){case"px":r.lookAt(j.POSITIVE_X,j.NEGATIVE_Y);break;case"nx":r.lookAt(j.NEGATIVE_X,j.NEGATIVE_Y);break;case"py":r.lookAt(j.POSITIVE_Y,j.POSITIVE_Z);break;case"ny":r.lookAt(j.NEGATIVE_Y,j.NEGATIVE_Z);break;case"pz":r.lookAt(j.POSITIVE_Z,j.NEGATIVE_Y);break;case"nz":r.lookAt(j.NEGATIVE_Z,j.NEGATIVE_Y)}return t.getWorldPosition(r.position),r.update(),r},_getDirectionalLightCamera:function(){var t=new Ge,e=new et,r=new et;return function(n,i,o){this._lightCameras.directional||(this._lightCameras.directional=new lr);var a=this._lightCameras.directional;e.copy(i.viewBoundingBoxLastFrame),e.intersection(o.frustum.boundingBox),a.position.copy(e.min).add(e.max).scale(.5).transformMat4(o.worldTransform),a.rotation.copy(n.rotation),a.scale.copy(n.scale),a.updateWorldTransform(),Ge.invert(t,a.worldTransform),Ge.multiply(t,t,o.worldTransform),r.copy(e).applyTransform(t);var s=r.min.array,h=r.max.array;return a.position.set((s[0]+h[0])/2,(s[1]+h[1])/2,h[2]).transformMat4(a.worldTransform),a.near=0,a.far=-s[2]+h[2],isNaN(this.lightFrustumBias)?a.far*=4:a.far+=this.lightFrustumBias,a.left=s[0],a.right=h[0],a.top=h[1],a.bottom=s[1],a.update(!0),a}}(),_getSpotLightCamera:function(t){this._lightCameras.spot||(this._lightCameras.spot=new cr);var e=this._lightCameras.spot;return e.fov=2*t.penumbraAngle,e.far=t.range,e.worldTransform.copy(t.worldTransform),e.updateProjectionMatrix(),K.invert(e.viewMatrix.array,e.worldTransform.array),e},dispose:function(t){var e=t.gl||t;for(var r in this._frameBuffer&&this._frameBuffer.dispose(e),this._textures)this._textures[r].dispose(e);this._texturePool.clear(t.gl),this._depthMaterials={},this._distanceMaterials={},this._textures={},this._lightCameras={},this._shadowMapNumber={POINT_LIGHT:0,DIRECTIONAL_LIGHT:0,SPOT_LIGHT:0},this._meshMaterials={};for(var n=0;n<this._receivers.length;n++){var i=this._receivers[n];if(i.material){var o=i.material;o.undefine("fragment","POINT_LIGHT_SHADOW_COUNT"),o.undefine("fragment","DIRECTIONAL_LIGHT_SHADOW_COUNT"),o.undefine("fragment","AMBIENT_LIGHT_SHADOW_COUNT"),o.set("shadowEnabled",0)}}this._receivers=[],this._lightsCastShadow=[]}});as.VSM=1,as.PCF=2;var ss=as,hs={merge:function(t,e){if(t.length){var r=t[0],n=r.geometry,i=r.material,o=new At({dynamic:!1});o.boundingBox=new et;for(var a=n.getEnabledAttributes(),s=0;s<a.length;s++){var h=a[s],u=n.attributes[h];o.attributes[h]||(o.attributes[h]=u.clone(!1))}for(var l=K.create(),c=0,f=0,d=0;d<t.length;d++){(v=t[d].geometry).boundingBox&&(v.boundingBox.applyTransform(e?t[d].worldTransform:t[d].localTransform),o.boundingBox.union(v.boundingBox)),c+=v.vertexCount,f+=v.triangleCount}for(var p=0;p<a.length;p++){h=a[p];o.attributes[h].init(c)}o.indices=c>=65535?new Uint32Array(3*f):new Uint16Array(3*f);for(var m=0,g=0,_=n.isUseIndices(),y=0;y<t.length;y++){var v,x=t[y],b=(c=(v=x.geometry).vertexCount,e?x.worldTransform.array:x.localTransform.array);K.invert(l,b),K.transpose(l,l);for(var w=0;w<a.length;w++){h=a[w];var T=v.attributes[h],E=o.attributes[h];if(T.value.length){var C=T.value.length,S=T.size,A=m*S,M=C/S;for(s=0;s<C;s++)E.value[A+s]=T.value[s];"position"===h?D.forEach(E.value,S,A,M,D.transformMat4,b):"normal"!==h&&"tangent"!==h||D.forEach(E.value,S,A,M,D.transformMat4,l)}}if(_){for(C=v.indices.length,s=0;s<C;s++)o.indices[s+g]=v.indices[s]+m;g+=C}m+=c}return new Rn({material:i,geometry:o})}},splitByJoints:function(t,e,r){var n=t.geometry,i=t.skeleton,o=t.material,a=t.joints;if(n&&i&&a.length){if(a.length<e)return t;for(var s=n.indices,h=n.triangleCount,u=h,l=[],c=n.attributes.joint.value,f=0;f<h;f++)l[f]=!1;for(var d=[],p=[],m=function(t){return a[t]};u>0;){var g=[],_=[],y=[],v=0;for(f=0;f<a.length;f++)_[f]=-1;for(var x=0;x<h;x++)if(!l[x]){var b=!0,w=0;for(f=0;f<3;f++)for(var T=s[3*x+f],E=0;E<4;E++){(G=c[4*T+E])>=0&&-1===_[G]&&(v<e?(_[G]=v,y[v++]=G,d[w++]=G):b=!1)}if(b)g.push(s.subarray(3*x,3*(x+1))),l[x]=!0,u--;else for(f=0;f<w;f++)_[d[f]]=-1,y.pop(),v--}p.push({triangles:g,joints:y.map(m),jointReverseMap:_})}var C=new We({name:t.name}),S=n.getEnabledAttributes();S.splice(S.indexOf("joint"),1);for(var A=[],M=0;M<p.length;M++){var P=p[M],R=P.jointReverseMap,L=(v=P.joints.length,new At),O=new Rn({name:[t.name,f].join("-"),material:o,geometry:L,skeleton:i,joints:P.joints.slice()}),k=0,D=n.vertexCount;for(f=0;f<D;f++)A[f]=-1;for(x=0;x<P.triangles.length;x++){var I=P.triangles[x];for(f=0;f<3;f++){-1===A[T=I[f]]&&(A[T]=k,k++)}}for(var N=0;N<S.length;N++){var F=S[N];(H=L.attributes[F]).init(k)}L.attributes.joint.value=new Float32Array(4*k),L.indices=k>65535?new Uint32Array(3*P.triangles.length):new Uint16Array(3*P.triangles.length);var B=0;k=0;for(f=0;f<D;f++)A[f]=-1;for(x=0;x<P.triangles.length;x++){var z=P.triangles[x];for(f=0;f<3;f++){if(-1===A[T=z[f]]){A[T]=k;for(N=0;N<S.length;N++){F=S[N];var U=n.attributes[F],H=L.attributes[F],j=U.size;for(E=0;E<j;E++)H.value[k*j+E]=U.value[T*j+E]}for(E=0;E<4;E++){var G=n.attributes.joint.value[4*T+E],V=4*k+E;L.attributes.joint.value[V]=G>=0?R[G]:-1}k++}L.indices[B++]=A[T]}}L.updateBoundingBox(),C.add(O)}var W=t.children();for(f=0;f<W.length;f++)C.add(W[f]);if(C.position.copy(t.position),C.rotation.copy(t.rotation),C.scale.copy(t.scale),r&&t.getParent()){var Z=t.getParent();Z.remove(t),Z.add(C)}return C}}},us={},ls=["px","nx","py","ny","pz","nz"];function cs(t,e){var r=t[0],n=t[1],i=t[2];return 0===e?1:1===e?r:2===e?n:3===e?i:4===e?r*i:5===e?n*i:6===e?r*n:7===e?3*i*i-1:r*r-n*n}var fs={px:[2,1,0,-1,-1,1],nx:[2,1,0,1,-1,-1],py:[0,2,1,1,-1,-1],ny:[0,2,1,1,1,1],pz:[0,1,2,-1,-1,-1],nz:[0,1,2,1,-1,1]};us.projectEnvironmentMap=function(t,e,r){var n;(r=r||{}).lod=r.lod||0;var i=new Wi,o=64;"texture2D"===e.textureType?n=new qi({scene:i,environmentMap:e}):(o=e.image&&e.image.px?e.image.px.width:e.width,n=new Bi({scene:i,environmentMap:e}));var a=Math.ceil(o/Math.pow(2,r.lod)),s=Math.ceil(o/Math.pow(2,r.lod)),h=new br({width:a,height:s}),u=new Or;n.material.define("fragment","RGBM_ENCODE"),r.decodeRGBM&&n.material.define("fragment","RGBM_DECODE"),n.material.set("lod",r.lod);for(var l=new Xi({texture:h}),c={},f=0;f<ls.length;f++){c[ls[f]]=new Uint8Array(a*s*4);var d=l.getCamera(ls[f]);d.fov=90,u.attach(h),u.bind(t),t.render(i,d),t.gl.readPixels(0,0,a,s,mr.RGBA,mr.UNSIGNED_BYTE,c[ls[f]]),u.unbind(t)}return n.dispose(t),u.dispose(t),h.dispose(t),function(t,e,r,n){for(var i=new G.a.Float32Array(27),o=D.create(),a=D.create(),s=D.create(),h=0;h<9;h++){for(var u=D.create(),l=0;l<ls.length;l++){for(var c=e[ls[l]],f=D.create(),d=0,p=0,m=fs[ls[l]],g=0;g<n;g++)for(var _=0;_<r;_++){o[0]=_/(r-1)*2-1,o[1]=g/(n-1)*2-1,o[2]=-1,D.normalize(o,o),s[0]=o[m[0]]*m[3],s[1]=o[m[1]]*m[4],s[2]=o[m[2]]*m[5],a[0]=c[p++]/255,a[1]=c[p++]/255,a[2]=c[p++]/255;var y=c[p++]/255*8.12;a[0]*=y,a[1]*=y,a[2]*=y,D.scaleAndAdd(f,f,a,cs(s,h)*-o[2]),d+=-o[2]}D.scaleAndAdd(u,u,f,1/d)}i[3*h]=u[0]/6,i[3*h+1]=u[1]/6,i[3*h+2]=u[2]/6}return i}(0,c,a,s)};var ds=us,ps={version:1,type:"Geometry",generator:"util.transferable.toObject"},ms={toObject:function(t,e){if(!t)return null;var r={metadata:ut.extend({},ps)},n=[];for(var i in r.dynamic=t.dynamic,t.boundingBox&&(r.boundingBox={min:t.boundingBox.min.toArray(),max:t.boundingBox.max.toArray()}),t.indices&&t.indices.length>0&&(r.indices=_s(t.indices,e),n.push(r.indices.buffer)),r.attributes={},t.attributes)if(t.attributes.hasOwnProperty(i)){var o=t.attributes[i];o&&o.value&&o.value.length>0&&(o=r.attributes[i]=gs(o,e),n.push(o.value.buffer))}return{data:r,buffers:n}},toGeometry:function(t){if(!t)return null;if(t.data&&t.buffers)return ms.toGeometry(t.data);if(!t.metadata||t.metadata.generator!==ps.generator)throw new Error("[util.transferable.toGeometry] the object is not generated by util.transferable.");var e={dynamic:t.dynamic,indices:t.indices};if(t.boundingBox){var r=(new j).setArray(t.boundingBox.min),n=(new j).setArray(t.boundingBox.max);e.boundingBox=new et(r,n)}var i=new At(e);for(var o in t.attributes)if(t.attributes.hasOwnProperty(o)){var a=t.attributes[o];i.attributes[o]=new At.Attribute(a.name,a.type,a.size,a.semantic),i.attributes[o].value=a.value}return i}};function gs(t,e){return{name:t.name,type:t.type,size:t.size,semantic:t.semantic,value:_s(t.value,e)}}function _s(t,e){return e?t:new t.constructor(t)}var ys=ms;function vs(t,e,r){return t*(1-r)+e*r}en.import("@export clay.vr.disorter.output.vertex\nattribute vec2 texcoord: TEXCOORD_0;\nattribute vec3 position: POSITION;\nvarying vec2 v_Texcoord;\nvoid main()\n{\n v_Texcoord = texcoord;\n gl_Position = vec4(position.xy, 0.5, 1.0);\n}\n@end\n@export clay.vr.disorter.output.fragment\nuniform sampler2D texture;\nvarying vec2 v_Texcoord;\nvoid main()\n{\n gl_FragColor = texture2D(texture, v_Texcoord);\n}\n@end");ct.extend(function(){return{clearColor:[0,0,0,1],_mesh:new Rn({geometry:new At({dynamic:!0}),culling:!1,material:new Sn({depthTest:!1,shader:new en({vertex:en.source("clay.vr.disorter.output.vertex"),fragment:en.source("clay.vr.disorter.output.fragment")})})}),_fakeCamera:new cr}},{render:function(t,e){var r=this.clearColor,n=t.gl;n.clearColor(r[0],r[1],r[2],r[3]),n.clear(n.COLOR_BUFFER_BIT),n.disable(n.BLEND),this._mesh.material.set("texture",e),t.saveViewport(),t.setViewport(0,0,t.getWidth(),t.getHeight()),t.renderPass([this._mesh],this._fakeCamera),t.restoreViewport()},updateFromVRDisplay:function(t){t.deviceInfo_?this._updateMesh(20,20,t.deviceInfo_):console.warn("Cant get vrDisplay.deviceInfo_, seems code changed")},_updateMesh:function(t,e,r){var n=this._mesh.geometry.attributes.position,i=this._mesh.geometry.attributes.texcoord0;n.init(2*t*e),i.init(2*t*e);for(var o=r.getLeftEyeVisibleTanAngles(),a=r.getLeftEyeNoLensTanAngles(),s=r.getLeftEyeVisibleScreenRect(a),h=0,u=[],l=[],c=0;c<2;c++){for(var f=0;f<e;f++)for(var d=0;d<t;d++,h++){var p=d/(t-1),m=f/(e-1),g=p,_=m,y=vs(o[0],o[2],p),v=vs(o[3],o[1],m),x=Math.sqrt(y*y+v*v),b=r.distortion.distortInverse(x),w=v*b/x;p=(y*b/x-a[0])/(a[2]-a[0]),m=(w-a[3])/(a[1]-a[3]);r.device.widthMeters,r.device.heightMeters;p=2*(s.x+p*s.width-.5),m=2*(s.y+m*s.height-.5),u[0]=p,u[1]=m,u[2]=0,l[0]=.5*g+.5*c,l[1]=_,n.set(h,u),i.set(h,l)}var T=o[2]-o[0];o[0]=-(T+o[0]),o[2]=T-o[2],T=a[2]-a[0],a[0]=-(T+a[0]),a[2]=T-a[2],s.x=1-(s.x+s.width)}var E=new Uint16Array(2*(t-1)*(e-1)*6),C=t/2,S=e/2,A=(h=0,0);for(c=0;c<2;c++)for(f=0;f<e;f++)for(d=0;d<t;d++,h++)0!==d&&0!==f&&(d<=C==f<=S?(E[A++]=h,E[A++]=h-t-1,E[A++]=h-t,E[A++]=h-t-1,E[A++]=h,E[A++]=h-1):(E[A++]=h-1,E[A++]=h-t,E[A++]=h,E[A++]=h-t,E[A++]=h-1,E[A++]=h-t-1));this._mesh.geometry.indices=E,this._mesh.geometry.dirty()}});var xs=new Ge,bs=(We.extend(function(){return{aspect:.5,_leftCamera:new cr,_rightCamera:new cr,_eyeLeft:new Ge,_eyeRight:new Ge,_frameData:null}},{updateFromCamera:function(t,e,r,n){t.transformNeedsUpdate()&&console.warn("Node transform is not updated"),e=null==e?10:e,r=null==r?1:r,n=null==n?.064:n;var i=t.fov,o=t.aspect*this.aspect,a=t.near;xs.copy(t.projectionMatrix);var s,h,u=(n=n/2)*a/e,l=a*Math.tan(Math.PI/180*i*.5)/r;this._eyeLeft.array[12]=-n,this._eyeRight.array[12]=n,s=-l*o+u,h=l*o+u,xs.array[0]=2*a/(h-s),xs.array[8]=(h+s)/(h-s),this._leftCamera.projectionMatrix.copy(xs),s=-l*o-u,h=l*o-u,xs.array[0]=2*a/(h-s),xs.array[8]=(h+s)/(h-s),this._rightCamera.projectionMatrix.copy(xs),this._leftCamera.worldTransform.copy(t.worldTransform).multiply(this._eyeLeft),this._rightCamera.worldTransform.copy(t.worldTransform).multiply(this._eyeRight),this._leftCamera.decomposeWorldTransform(),this._leftCamera.decomposeProjectionMatrix(),this._rightCamera.decomposeWorldTransform(),this._rightCamera.decomposeProjectionMatrix()},updateFromVRDisplay:function(t,e){if("undefined"!=typeof VRFrameData){var r=this._frameData||(this._frameData=new VRFrameData);t.getFrameData(r);var n=this._leftCamera,i=this._rightCamera;n.projectionMatrix.setArray(r.leftProjectionMatrix),n.decomposeProjectionMatrix(),n.viewMatrix.setArray(r.leftViewMatrix),n.setViewMatrix(n.viewMatrix),i.projectionMatrix.setArray(r.rightProjectionMatrix),i.decomposeProjectionMatrix(),i.viewMatrix.setArray(r.rightViewMatrix),i.setViewMatrix(i.viewMatrix),e&&e.worldTransform&&(e.transformNeedsUpdate()&&console.warn("Node transform is not updated"),n.worldTransform.multiplyLeft(e.worldTransform),n.decomposeWorldTransform(),i.worldTransform.multiplyLeft(e.worldTransform),i.decomposeWorldTransform())}},getLeftCamera:function(){return this._leftCamera},getRightCamera:function(){return this._rightCamera}}),{Compositor:kr,CompositorNode:fr,createCompositor:ui,FilterNode:In,Graph:dr,Pass:Dn,SceneNode:Dr,TextureNode:Ir,TexturePool:Sr}),ws=(di.a,G.a,{GBuffer:mi,Renderer:wi}),Ts={Cone:_i,Cube:Pi,Cylinder:yi,ParametricSurface:Ri,Plane:Nr,Sphere:gi},Es={FreeControl:ya,GamepadControl:va,GestureMgr:Ta,InfinitePlane:Sa,OrbitControl:Pa,Skybox:Bi,Skydome:qi},Cs={EnvironmentMap:Xi,ShadowMap:ss},Ss={cubemap:fo,dds:$i,delaunay:Kt,hdr:ao,mesh:hs,sh:ds,texture:ho,transferable:ys};en.import(Oi),en.import(xi),en.import("@export clay.basic.vertex\nuniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\nuniform vec2 uvRepeat : [1.0, 1.0];\nuniform vec2 uvOffset : [0.0, 0.0];\nattribute vec2 texcoord : TEXCOORD_0;\nattribute vec3 position : POSITION;\nattribute vec3 barycentric;\n@import clay.chunk.skinning_header\nvarying vec2 v_Texcoord;\nvarying vec3 v_Barycentric;\n#ifdef VERTEX_COLOR\nattribute vec4 a_Color : COLOR;\nvarying vec4 v_Color;\n#endif\nvoid main()\n{\n vec3 skinnedPosition = position;\n#ifdef SKINNING\n @import clay.chunk.skin_matrix\n skinnedPosition = (skinMatrixWS * vec4(position, 1.0)).xyz;\n#endif\n v_Texcoord = texcoord * uvRepeat + uvOffset;\n v_Barycentric = barycentric;\n gl_Position = worldViewProjection * vec4(skinnedPosition, 1.0);\n#ifdef VERTEX_COLOR\n v_Color = a_Color;\n#endif\n}\n@end\n@export clay.basic.fragment\n#define DIFFUSEMAP_ALPHA_ALPHA\nvarying vec2 v_Texcoord;\nuniform sampler2D diffuseMap;\nuniform vec3 color : [1.0, 1.0, 1.0];\nuniform vec3 emission : [0.0, 0.0, 0.0];\nuniform float alpha : 1.0;\n#ifdef ALPHA_TEST\nuniform float alphaCutoff: 0.9;\n#endif\n#ifdef VERTEX_COLOR\nvarying vec4 v_Color;\n#endif\nuniform float lineWidth : 0.0;\nuniform vec4 lineColor : [0.0, 0.0, 0.0, 0.6];\nvarying vec3 v_Barycentric;\n@import clay.util.edge_factor\n@import clay.util.rgbm\n@import clay.util.srgb\n@import clay.util.ACES\nvoid main()\n{\n gl_FragColor = vec4(color, alpha);\n#ifdef VERTEX_COLOR\n gl_FragColor *= v_Color;\n#endif\n#ifdef SRGB_DECODE\n gl_FragColor = sRGBToLinear(gl_FragColor);\n#endif\n#ifdef DIFFUSEMAP_ENABLED\n vec4 texel = decodeHDR(texture2D(diffuseMap, v_Texcoord));\n#ifdef SRGB_DECODE\n texel = sRGBToLinear(texel);\n#endif\n#if defined(DIFFUSEMAP_ALPHA_ALPHA)\n gl_FragColor.a = texel.a;\n#endif\n gl_FragColor.rgb *= texel.rgb;\n#endif\n gl_FragColor.rgb += emission;\n if( lineWidth > 0.)\n {\n gl_FragColor.rgb = mix(gl_FragColor.rgb, lineColor.rgb, (1.0 - edgeFactor(lineWidth)) * lineColor.a);\n }\n#ifdef ALPHA_TEST\n if (gl_FragColor.a < alphaCutoff) {\n discard;\n }\n#endif\n#ifdef TONEMAPPING\n gl_FragColor.rgb = ACESToneMapping(gl_FragColor.rgb);\n#endif\n#ifdef SRGB_ENCODE\n gl_FragColor = linearTosRGB(gl_FragColor);\n#endif\n gl_FragColor = encodeHDR(gl_FragColor);\n}\n@end"),en.import("\n@export clay.lambert.vertex\nuniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\nuniform mat4 worldInverseTranspose : WORLDINVERSETRANSPOSE;\nuniform mat4 world : WORLD;\nuniform vec2 uvRepeat : [1.0, 1.0];\nuniform vec2 uvOffset : [0.0, 0.0];\nattribute vec3 position : POSITION;\nattribute vec2 texcoord : TEXCOORD_0;\nattribute vec3 normal : NORMAL;\nattribute vec3 barycentric;\n#ifdef VERTEX_COLOR\nattribute vec4 a_Color : COLOR;\nvarying vec4 v_Color;\n#endif\n@import clay.chunk.skinning_header\nvarying vec2 v_Texcoord;\nvarying vec3 v_Normal;\nvarying vec3 v_WorldPosition;\nvarying vec3 v_Barycentric;\nvoid main()\n{\n vec3 skinnedPosition = position;\n vec3 skinnedNormal = normal;\n#ifdef SKINNING\n @import clay.chunk.skin_matrix\n skinnedPosition = (skinMatrixWS * vec4(position, 1.0)).xyz;\n skinnedNormal = (skinMatrixWS * vec4(normal, 0.0)).xyz;\n#endif\n gl_Position = worldViewProjection * vec4( skinnedPosition, 1.0 );\n v_Texcoord = texcoord * uvRepeat + uvOffset;\n v_Normal = normalize( ( worldInverseTranspose * vec4(skinnedNormal, 0.0) ).xyz );\n v_WorldPosition = ( world * vec4( skinnedPosition, 1.0) ).xyz;\n v_Barycentric = barycentric;\n#ifdef VERTEX_COLOR\n v_Color = a_Color;\n#endif\n}\n@end\n@export clay.lambert.fragment\n#define DIFFUSEMAP_ALPHA_ALPHA\nvarying vec2 v_Texcoord;\nvarying vec3 v_Normal;\nvarying vec3 v_WorldPosition;\nuniform sampler2D diffuseMap;\nuniform sampler2D alphaMap;\nuniform vec3 color : [1.0, 1.0, 1.0];\nuniform vec3 emission : [0.0, 0.0, 0.0];\nuniform float alpha : 1.0;\n#ifdef ALPHA_TEST\nuniform float alphaCutoff: 0.9;\n#endif\nuniform float lineWidth : 0.0;\nuniform vec4 lineColor : [0.0, 0.0, 0.0, 0.6];\nvarying vec3 v_Barycentric;\n#ifdef VERTEX_COLOR\nvarying vec4 v_Color;\n#endif\n#ifdef AMBIENT_LIGHT_COUNT\n@import clay.header.ambient_light\n#endif\n#ifdef AMBIENT_SH_LIGHT_COUNT\n@import clay.header.ambient_sh_light\n#endif\n#ifdef POINT_LIGHT_COUNT\n@import clay.header.point_light\n#endif\n#ifdef DIRECTIONAL_LIGHT_COUNT\n@import clay.header.directional_light\n#endif\n#ifdef SPOT_LIGHT_COUNT\n@import clay.header.spot_light\n#endif\n@import clay.util.calculate_attenuation\n@import clay.util.edge_factor\n@import clay.util.rgbm\n@import clay.plugin.compute_shadow_map\n@import clay.util.ACES\nvoid main()\n{\n gl_FragColor = vec4(color, alpha);\n#ifdef VERTEX_COLOR\n gl_FragColor *= v_Color;\n#endif\n#ifdef SRGB_DECODE\n gl_FragColor = sRGBToLinear(gl_FragColor);\n#endif\n#ifdef DIFFUSEMAP_ENABLED\n vec4 tex = texture2D( diffuseMap, v_Texcoord );\n#ifdef SRGB_DECODE\n tex.rgb = pow(tex.rgb, vec3(2.2));\n#endif\n gl_FragColor.rgb *= tex.rgb;\n#ifdef DIFFUSEMAP_ALPHA_ALPHA\n gl_FragColor.a *= tex.a;\n#endif\n#endif\n vec3 diffuseColor = vec3(0.0, 0.0, 0.0);\n#ifdef AMBIENT_LIGHT_COUNT\n for(int _idx_ = 0; _idx_ < AMBIENT_LIGHT_COUNT; _idx_++)\n {\n diffuseColor += ambientLightColor[_idx_];\n }\n#endif\n#ifdef AMBIENT_SH_LIGHT_COUNT\n for(int _idx_ = 0; _idx_ < AMBIENT_SH_LIGHT_COUNT; _idx_++)\n {{\n diffuseColor += calcAmbientSHLight(_idx_, v_Normal) * ambientSHLightColor[_idx_];\n }}\n#endif\n#ifdef POINT_LIGHT_COUNT\n#if defined(POINT_LIGHT_SHADOWMAP_COUNT)\n float shadowContribsPoint[POINT_LIGHT_COUNT];\n if( shadowEnabled )\n {\n computeShadowOfPointLights(v_WorldPosition, shadowContribsPoint);\n }\n#endif\n for(int i = 0; i < POINT_LIGHT_COUNT; i++)\n {\n vec3 lightPosition = pointLightPosition[i];\n vec3 lightColor = pointLightColor[i];\n float range = pointLightRange[i];\n vec3 lightDirection = lightPosition - v_WorldPosition;\n float dist = length(lightDirection);\n float attenuation = lightAttenuation(dist, range);\n lightDirection /= dist;\n float ndl = dot( v_Normal, lightDirection );\n float shadowContrib = 1.0;\n#if defined(POINT_LIGHT_SHADOWMAP_COUNT)\n if( shadowEnabled )\n {\n shadowContrib = shadowContribsPoint[i];\n }\n#endif\n diffuseColor += lightColor * clamp(ndl, 0.0, 1.0) * attenuation * shadowContrib;\n }\n#endif\n#ifdef DIRECTIONAL_LIGHT_COUNT\n#if defined(DIRECTIONAL_LIGHT_SHADOWMAP_COUNT)\n float shadowContribsDir[DIRECTIONAL_LIGHT_COUNT];\n if(shadowEnabled)\n {\n computeShadowOfDirectionalLights(v_WorldPosition, shadowContribsDir);\n }\n#endif\n for(int i = 0; i < DIRECTIONAL_LIGHT_COUNT; i++)\n {\n vec3 lightDirection = -directionalLightDirection[i];\n vec3 lightColor = directionalLightColor[i];\n float ndl = dot(v_Normal, normalize(lightDirection));\n float shadowContrib = 1.0;\n#if defined(DIRECTIONAL_LIGHT_SHADOWMAP_COUNT)\n if( shadowEnabled )\n {\n shadowContrib = shadowContribsDir[i];\n }\n#endif\n diffuseColor += lightColor * clamp(ndl, 0.0, 1.0) * shadowContrib;\n }\n#endif\n#ifdef SPOT_LIGHT_COUNT\n#if defined(SPOT_LIGHT_SHADOWMAP_COUNT)\n float shadowContribsSpot[SPOT_LIGHT_COUNT];\n if(shadowEnabled)\n {\n computeShadowOfSpotLights(v_WorldPosition, shadowContribsSpot);\n }\n#endif\n for(int i = 0; i < SPOT_LIGHT_COUNT; i++)\n {\n vec3 lightPosition = -spotLightPosition[i];\n vec3 spotLightDirection = -normalize( spotLightDirection[i] );\n vec3 lightColor = spotLightColor[i];\n float range = spotLightRange[i];\n float a = spotLightUmbraAngleCosine[i];\n float b = spotLightPenumbraAngleCosine[i];\n float falloffFactor = spotLightFalloffFactor[i];\n vec3 lightDirection = lightPosition - v_WorldPosition;\n float dist = length(lightDirection);\n float attenuation = lightAttenuation(dist, range);\n lightDirection /= dist;\n float c = dot(spotLightDirection, lightDirection);\n float falloff;\n falloff = clamp((c - a) /( b - a), 0.0, 1.0);\n falloff = pow(falloff, falloffFactor);\n float ndl = dot(v_Normal, lightDirection);\n ndl = clamp(ndl, 0.0, 1.0);\n float shadowContrib = 1.0;\n#if defined(SPOT_LIGHT_SHADOWMAP_COUNT)\n if( shadowEnabled )\n {\n shadowContrib = shadowContribsSpot[i];\n }\n#endif\n diffuseColor += lightColor * ndl * attenuation * (1.0-falloff) * shadowContrib;\n }\n#endif\n gl_FragColor.rgb *= diffuseColor;\n gl_FragColor.rgb += emission;\n if(lineWidth > 0.)\n {\n gl_FragColor.rgb = mix(gl_FragColor.rgb, lineColor.rgb, (1.0 - edgeFactor(lineWidth)) * lineColor.a);\n }\n#ifdef ALPHA_TEST\n if (gl_FragColor.a < alphaCutoff) {\n discard;\n }\n#endif\n#ifdef TONEMAPPING\n gl_FragColor.rgb = ACESToneMapping(gl_FragColor.rgb);\n#endif\n#ifdef SRGB_ENCODE\n gl_FragColor = linearTosRGB(gl_FragColor);\n#endif\n gl_FragColor = encodeHDR(gl_FragColor);\n}\n@end"),en.import(vo),en.import("@export clay.wireframe.vertex\nuniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\nuniform mat4 world : WORLD;\nattribute vec3 position : POSITION;\nattribute vec3 barycentric;\n@import clay.chunk.skinning_header\nvarying vec3 v_Barycentric;\nvoid main()\n{\n vec3 skinnedPosition = position;\n#ifdef SKINNING\n @import clay.chunk.skin_matrix\n skinnedPosition = (skinMatrixWS * vec4(position, 1.0)).xyz;\n#endif\n gl_Position = worldViewProjection * vec4(skinnedPosition, 1.0 );\n v_Barycentric = barycentric;\n}\n@end\n@export clay.wireframe.fragment\nuniform vec3 color : [0.0, 0.0, 0.0];\nuniform float alpha : 1.0;\nuniform float lineWidth : 1.0;\nvarying vec3 v_Barycentric;\n@import clay.util.edge_factor\nvoid main()\n{\n gl_FragColor.rgb = color;\n gl_FragColor.a = (1.0-edgeFactor(lineWidth)) * alpha;\n}\n@end"),en.import(Ii),en.import(vi),Oo.template("clay.basic",en.source("clay.basic.vertex"),en.source("clay.basic.fragment")),Oo.template("clay.lambert",en.source("clay.lambert.vertex"),en.source("clay.lambert.fragment")),Oo.template("clay.wireframe",en.source("clay.wireframe.vertex"),en.source("clay.wireframe.fragment")),Oo.template("clay.skybox",en.source("clay.skybox.vertex"),en.source("clay.skybox.fragment")),Oo.template("clay.prez",en.source("clay.prez.vertex"),en.source("clay.prez.fragment")),Oo.template("clay.standard",en.source("clay.standard.vertex"),en.source("clay.standard.fragment")),Oo.template("clay.standardMR",en.source("clay.standardMR.vertex"),en.source("clay.standardMR.fragment"));var As=Oo,Ms=bn.parseToFloat,Ps=["click","dblclick","mouseover","mouseout","mousemove","touchstart","touchend","touchmove","mousewheel","DOMMouseScroll"];function Rs(t,e){if((e=e||{}).graphic=e.graphic||{},null==e.autoRender&&(e.autoRender=!0),"string"==typeof t&&(t=document.querySelector(t)),!t)throw new Error("Invalid dom");var r=!t.nodeName||"CANVAS"===t.nodeName.toUpperCase(),n={};r&&(n.canvas=t),e.devicePixelRatio&&(n.devicePixelRatio=e.devicePixelRatio);var i=new Ya(n),o=e.width||t.clientWidth,a=e.height||t.clientHeight,s=new Wi,h=new ve,u=e.graphic.shadow&&new ss,l=e.event&&new ga({scene:s,renderer:i});!r&&t.appendChild(i.canvas),i.resize(o,a);var c=0,f=0;h.start();var d={};for(var p in e.methods)d[p]=e.methods[p].bind(e,this);Object.defineProperties(this,{container:{get:function(){return t}},renderer:{get:function(){return i}},scene:{get:function(){return s}},timeline:{get:function(){return h}},frameTime:{get:function(){return c}},elapsedTime:{get:function(){return f}},width:{get:function(){return i.getWidth()}},height:{get:function(){return i.getHeight()}},methods:{get:function(){return d}},_shadowPass:{get:function(){return u}},_appNS:{get:function(){return e}}}),this.resize=function(r,n){o=r||e.width||t.clientWidth,a=n||t.height||t.clientHeight,i.resize(o,a)},this.dispose=function(){this._disposed=!0,e.dispose&&e.dispose(this),h.stop(),i.disposeScene(s),u&&u.dispose(i),t.innerHTML="",Ps.forEach(function(e){this[Os(e)]&&G.a.removeEventListener(t,Os(e))},this)},l&&this._initMouseEvents(l),this._geoCache=new an(20),this._texCache=new an(20),this._texturesList={},this._geometriesList={};var m=Promise.resolve(e.init&&e.init(this));l&&(l.camera=s.getMainCamera()),e.loop||console.warn("Miss loop method.");var g=this;m.then(function(){h.on("frame",function(t){c=t,f+=t;var r=s.getMainCamera();r&&(r.aspect=i.getViewportAspect()),l&&(l.camera=r),e.loop&&e.loop(g),e.autoRender&&g.render(),g.collectResources()},this)}),s.on("beforerender",function(t,r,n,i){this._inRender&&(this._updateGraphicOptions(e.graphic,i.opaque,!1),this._updateGraphicOptions(e.graphic,i.transparent,!1))},this)}function Ls(t){return"undefined"!=typeof Image&&t instanceof Image||"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof HTMLVideoElement&&t instanceof HTMLVideoElement}function Os(t){return"_"+t+"Handler"}function ks(t,e,r,n,i){var o=ut.clone(e);return o.type=t,o.offsetX=r,o.offsetY=n,null!==i&&(o.wheelDelta=i),o}function Ds(t,e){for(;t&&!e.cancelBubble;)t.trigger(e.type,e),t=t.getParent()}function Is(t){for(var e=0;e<t.length;e++)t[e].__used=0}function Ns(t,e){for(var r=0;r<e.length;r++)e[r].__used||e[r].dispose(t)}function Fs(t,e){t.__used=t.__used||0,t.__used++,1===t.__used&&e.push(t)}Rs.prototype._initMouseEvents=function(t){var e=this.container,r=null;Ps.forEach(function(n){G.a.addEventListener(e,n,this[Os(n)]=function(i){if(t.camera){i.preventDefault&&i.preventDefault();var o,a,s=e.getBoundingClientRect(),h=n;if(h.indexOf("touch")>=0){var u="touchend"!==h?i.targetTouches[0]:i.changedTouches[0];"touchstart"===h?h="mousedown":"touchend"===h?h="mouseup":"touchmove"===h&&(h="mousemove"),o=u.clientX-s.left,a=u.clientY-s.top}else o=i.clientX-s.left,a=i.clientY-s.top;var l,c=t.pick(o,a);if("DOMMouseScroll"!==h&&"mousewheel"!==h||(l=i.wheelDelta?i.wheelDelta/120:-(i.detail||0)/3),c){if(c.target.silent)return;if("mousemove"===h){var f=c.target!==r;f&&r&&Ds(r,ks("mouseout",{target:r},o,a)),Ds(c.target,ks("mousemove",c,o,a)),f&&Ds(c.target,ks("mouseover",c,o,a))}else Ds(c.target,ks(h,c,o,a,l));r=c.target}else r&&(Ds(r,ks("mouseout",{target:r},o,a)),r=null)}})},this)},Rs.prototype._updateGraphicOptions=function(t,e,r){for(var n,i=!!t.tonemapping,o=!!t.linear,a=0;a<e.length;a++){var s=e[a].material;if(s!==n){if(i?s.define("fragment","TONEMAPPING"):s.undefine("fragment","TONEMAPPING"),o){var h=!0;r&&s.get("environmentMap")&&!s.get("environmentMap").sRGB&&(h=!1),h&&s.define("fragment","SRGB_DECODE"),s.define("fragment","SRGB_ENCODE")}else s.undefine("fragment","SRGB_DECODE"),s.undefine("fragment","SRGB_ENCODE");n=s}}},Rs.prototype._doRender=function(t,e){var r=e.getMainCamera();t.render(e,r,!0)},Rs.prototype.render=function(){this._inRender=!0;var t=this._appNS;t.beforeRender&&t.beforeRender(self);var e=this.scene,r=this.renderer,n=this._shadowPass;e.update();var i=[];e.skybox&&i.push(e.skybox),e.skydome&&i.push(e.skydome),this._updateGraphicOptions(t.graphic,i,!0),n&&n.render(r,e,null,!0),this._doRender(r,e,!0),t.afterRender&&t.afterRender(self),this._inRender=!1},Rs.prototype.collectResources=function(){var t=this.renderer,e=this.scene,r=this._texturesList,n=this._geometriesList;Is(r),Is(n);var i=[],o=[];!function(t,e,r){var n,i;t.traverse(function(t){if(t.isRenderable()){var o=t.geometry,a=t.material;if(a!==n)for(var s=a.getTextureUniforms(),h=0;h<s.length;h++){var u=s[h],l=a.uniforms[u].value,c=a.uniforms[u].type;if(l)if("t"===c)Fs(l,e);else if("tv"===c)for(var f=0;f<l.length;f++)l[f]&&Fs(l[f],e)}o!==i&&Fs(o,r),n=a,i=o}});for(var o=0;o<t.lights.length;o++)t.lights[o].cubemap&&Fs(t.lights[o].cubemap,e)}(e,i,o),Ns(t,r),Ns(t,n),this._texturesList=i,this._geometriesList=o},Rs.prototype.loadTexture=function(t,e,r){var n,i=this,o="string"==typeof(n=t)?n:n.__key__||(n.__key__=ut.genGUID());if(r&&this._texCache.get(o))return this._texCache.get(o);var a=new Promise(function(r,n){var o=i.loadTextureSync(t,e);o.isRenderable()?r(o):(o.success(function(){i._disposed||r(o)}),o.error(function(){i._disposed||n()}))});return r&&this._texCache.put(o,a),a},Rs.prototype.loadTextureSync=function(t,e){var r=new br(e);if("string"==typeof t)if(t.match(/.hdr$|^data:application\/octet-stream/))for(var n in r=ho.loadTexture(t,{exposure:e&&e.exposure,fileType:"hdr"},function(){r.dirty(),r.trigger("success")}),e)r[n]=e[n];else r.load(t);else Ls(t)&&(r.image=t,r.dynamic=t instanceof HTMLVideoElement);return r},Rs.prototype.loadTextureCube=function(t,e){var r=this.loadTextureCubeSync(t,e);return new Promise(function(t,e){r.isRenderable()?t(r):r.success(function(){t(r)}).error(function(){e()})})},Rs.prototype.loadTextureCubeSync=function(t,e){(e=e||{}).flipY=e.flipY||!1;var r=new Un(e);if(!(t&&t.px&&t.nx&&t.py&&t.ny&&t.pz&&t.nz))throw new Error("Invalid cubemap format. Should be an object including px,nx,py,ny,pz,nz");return"string"==typeof t.px?r.load(t):r.image=ut.clone(t),r},Rs.prototype.createMaterial=function(t){(t=t||{}).shader=t.shader||"clay.standardMR";var e=t.shader instanceof en?t.shader:As.get(t.shader),r=new Sn({shader:e}),n=[];function i(e){return function(n){return r.setUniform(e,n),t.textureLoaded&&t.textureLoaded(e,n),n}}for(var o in t)if(r.uniforms[o]){var a=t[o];"t"!==r.uniforms[o].type&&!Ls(a)||a instanceof mr?r.setUniform(o,a):n.push(this.loadTexture(a,{convertToPOT:t.textureConvertToPOT||!1,flipY:null==t.textureFlipY||t.textureFlipY}).then(i(o)))}return t.transparent&&(t.depthMask=!1,t.transparent=!0),t.texturesReady&&Promise.all(n).then(function(e){t.texturesReady(e)}),r},Rs.prototype.createCube=function(t,e,r){null==r&&(r=1),"number"==typeof r&&(r=[r,r,r]);var n="cube-"+r.join("-"),i=this._geoCache.get(n);return i||((i=new Pi({widthSegments:r[0],heightSegments:r[1],depthSegments:r[2]})).generateTangents(),this._geoCache.put(n,i)),this.createMesh(i,t,e)},Rs.prototype.createCubeInside=function(t,e,r){null==r&&(r=1),"number"==typeof r&&(r=[r,r,r]);var n="cubeInside-"+r.join("-"),i=this._geoCache.get(n);return i||((i=new Pi({inside:!0,widthSegments:r[0],heightSegments:r[1],depthSegments:r[2]})).generateTangents(),this._geoCache.put(n,i)),this.createMesh(i,t,e)},Rs.prototype.createSphere=function(t,e,r){null==r&&(r=20);var n="sphere-"+r,i=this._geoCache.get(n);return i||((i=new gi({widthSegments:2*r,heightSegments:r})).generateTangents(),this._geoCache.put(n,i)),this.createMesh(i,t,e)},Rs.prototype.createPlane=function(t,e,r){null==r&&(r=1),"number"==typeof r&&(r=[r,r]);var n="plane-"+r.join("-"),i=this._geoCache.get(n);return i||((i=new Nr({widthSegments:r[0],heightSegments:r[1]})).generateTangents(),this._geoCache.put(n,i)),this.createMesh(i,t,e)},Rs.prototype.createParametricSurface=function(t,e,r){var n=new Ri({generator:r});return n.generateTangents(),this.createMesh(n,t,e)},Rs.prototype.createMesh=function(t,e,r){var n=new Rn({geometry:t,material:e instanceof Sn?e:this.createMaterial(e)});return(r=r||this.scene).add(n),n},Rs.prototype.createNode=function(t){var e=new We;return(t=t||this.scene).add(e),e},Rs.prototype.createCamera=function(t,e,r,n){var i,o=!1;"ortho"===r||"orthographic"===r?(o=!0,i=lr):(r&&"perspective"!==r&&console.error("Unkown camera type "+r+". Use default perspective camera"),i=cr);var a=new i;return t instanceof j?a.position.copy(t):t instanceof Array&&a.position.setArray(t),e instanceof Array&&(e=new j(e[0],e[1],e[2])),e instanceof j&&a.lookAt(e),n&&o?(n=n.array||n,a.left=-n[0]/2,a.right=n[0]/2,a.top=n[1]/2,a.bottom=-n[1]/2,a.near=0,a.far=n[2]):a.aspect=this.renderer.getViewportAspect(),this.scene.add(a),a},Rs.prototype.createDirectionalLight=function(t,e,r){var n=new go;return t instanceof j&&(t=t.array),n.position.setArray(t).negate(),n.lookAt(j.ZERO),"string"==typeof e&&(e=Ms(e)),null!=e&&(n.color=e),null!=r&&(n.intensity=r),this.scene.add(n),n},Rs.prototype.createSpotLight=function(t,e,r,n,i,o,a){var s=new yo;return s.position.setArray(t instanceof j?t.array:t),e instanceof Array&&(e=new j(e[0],e[1],e[2])),e instanceof j&&s.lookAt(e),"string"==typeof n&&(n=Ms(n)),null!=r&&(s.range=r),null!=n&&(s.color=n),null!=i&&(s.intensity=i),null!=o&&(s.umbraAngle=o),null!=a&&(s.penumbraAngle=a),this.scene.add(s),s},Rs.prototype.createPointLight=function(t,e,r,n){var i=new _o;return i.position.setArray(t instanceof j?t.array:t),"string"==typeof r&&(r=Ms(r)),null!=e&&(i.range=e),null!=r&&(i.color=r),null!=n&&(i.intensity=n),this.scene.add(i),i},Rs.prototype.createAmbientLight=function(t,e){var r=new Di;return"string"==typeof t&&(t=Ms(t)),null!=t&&(r.color=t),null!=e&&(r.intensity=e),this.scene.add(r),r},Rs.prototype.createAmbientCubemapLight=function(t,e,r,n,i){var o=this;null==n&&(n=0),null==i&&(i=32);var a=this.scene;return("textureCube"===t.textureType?t.isRenderable()?Promise.resolve(t):new Promise(function(e,r){t.success(function(){e(t)})}):this.loadTexture(t,{exposure:n})).then(function(t){var n=new po({intensity:null!=e?e:.7});n.cubemap=t,t.flipY=!1,n.prefilter(o.renderer,32);var i=new mo({intensity:null!=r?r:.7,coefficients:ds.projectEnvironmentMap(o.renderer,n.cubemap,{lod:1})});return a.add(n),a.add(i),{specular:n,diffuse:i,environmentMap:t}})},Rs.prototype.loadModel=function(t,e,r){if("string"!=typeof t)throw new Error("Invalid URL.");null==(e=e||{}).autoPlayAnimation&&(e.autoPlayAnimation=!0);var n=e.shader||"clay.standard",i={rootNode:new We,shader:n,textureRootPath:e.textureRootPath,crossOrigin:"Anonymous",textureFlipY:e.textureFlipY,textureConvertToPOT:e.textureConvertToPOT};e.upAxis&&"z"===e.upAxis.toLowerCase()&&i.rootNode.rotation.identity().rotateX(-Math.PI/2);var o=new Go(i);r=r||this.scene;var a=this.timeline,s=this;return new Promise(function(n,i){function h(t){s._disposed||(r.add(t.rootNode),e.autoPlayAnimation&&t.clips.forEach(function(t){a.addClip(t)}),n(t))}o.success(function(t){s._disposed||(e.waitTextureLoaded?Promise.all(t.textures.map(function(t){return t.isRenderable()?Promise.resolve(t):new Promise(function(e){t.success(e),t.error(e)})})).then(function(){h(t)}).catch(function(){h(t)}):h(t))}),o.error(function(){i()}),o.load(t)})},Rs.prototype.cloneNode=function(t,e){e=e||t.getParent();var r=this.scene.cloneNode(t,e);return e&&e.add(r),r};var Bs=function(t,e){return new Rs(t,e)},zs=r(66),Us=r(65),Hs=r.n(Us);function js(t,e){var r=t.__state.conversionName.toString(),n=Math.round(t.r),i=Math.round(t.g),o=Math.round(t.b),a=t.a,s=Math.round(t.h),h=t.s.toFixed(1),u=t.v.toFixed(1);if(e||"THREE_CHAR_HEX"===r||"SIX_CHAR_HEX"===r){for(var l=t.hex.toString(16);l.length<6;)l="0"+l;return"#"+l}return"CSS_RGB"===r?"rgb("+n+","+i+","+o+")":"CSS_RGBA"===r?"rgba("+n+","+i+","+o+","+a+")":"HEX"===r?"0x"+t.hex.toString(16):"RGB_ARRAY"===r?"["+n+","+i+","+o+"]":"RGBA_ARRAY"===r?"["+n+","+i+","+o+","+a+"]":"RGB_OBJ"===r?"{r:"+n+",g:"+i+",b:"+o+"}":"RGBA_OBJ"===r?"{r:"+n+",g:"+i+",b:"+o+",a:"+a+"}":"HSV_OBJ"===r?"{h:"+s+",s:"+h+",v:"+u+"}":"HSVA_OBJ"===r?"{h:"+s+",s:"+h+",v:"+u+",a:"+a+"}":"unknown format"}var Gs=Array.prototype.forEach,Vs=Array.prototype.slice,Ws={BREAK:{},extend:function(t){return this.each(Vs.call(arguments,1),function(e){(this.isObject(e)?Object.keys(e):[]).forEach(function(r){this.isUndefined(e[r])||(t[r]=e[r])}.bind(this))},this),t},defaults:function(t){return this.each(Vs.call(arguments,1),function(e){(this.isObject(e)?Object.keys(e):[]).forEach(function(r){this.isUndefined(t[r])&&(t[r]=e[r])}.bind(this))},this),t},compose:function(){var t=Vs.call(arguments);return function(){for(var e=Vs.call(arguments),r=t.length-1;r>=0;r--)e=[t[r].apply(this,e)];return e[0]}},each:function(t,e,r){if(t)if(Gs&&t.forEach&&t.forEach===Gs)t.forEach(e,r);else if(t.length===t.length+0){var n,i=void 0;for(i=0,n=t.length;i<n;i++)if(i in t&&e.call(r,t[i],i)===this.BREAK)return}else for(var o in t)if(e.call(r,t[o],o)===this.BREAK)return},defer:function(t){setTimeout(t,0)},debounce:function(t,e,r){var n=void 0;return function(){var i=this,o=arguments;var a=r||!n;clearTimeout(n),n=setTimeout(function(){n=null,r||t.apply(i,o)},e),a&&t.apply(i,o)}},toArray:function(t){return t.toArray?t.toArray():Vs.call(t)},isUndefined:function(t){return void 0===t},isNull:function(t){return null===t},isNaN:function(t){function e(e){return t.apply(this,arguments)}return e.toString=function(){return t.toString()},e}(function(t){return isNaN(t)}),isArray:Array.isArray||function(t){return t.constructor===Array},isObject:function(t){return t===Object(t)},isNumber:function(t){return t===t+0},isString:function(t){return t===t+""},isBoolean:function(t){return!1===t||!0===t},isFunction:function(t){return"[object Function]"===Object.prototype.toString.call(t)}},Zs=[{litmus:Ws.isString,conversions:{THREE_CHAR_HEX:{read:function(t){var e=t.match(/^#([A-F0-9])([A-F0-9])([A-F0-9])$/i);return null!==e&&{space:"HEX",hex:parseInt("0x"+e[1].toString()+e[1].toString()+e[2].toString()+e[2].toString()+e[3].toString()+e[3].toString(),0)}},write:js},SIX_CHAR_HEX:{read:function(t){var e=t.match(/^#([A-F0-9]{6})$/i);return null!==e&&{space:"HEX",hex:parseInt("0x"+e[1].toString(),0)}},write:js},CSS_RGB:{read:function(t){var e=t.match(/^rgb\(\s*(.+)\s*,\s*(.+)\s*,\s*(.+)\s*\)/);return null!==e&&{space:"RGB",r:parseFloat(e[1]),g:parseFloat(e[2]),b:parseFloat(e[3])}},write:js},CSS_RGBA:{read:function(t){var e=t.match(/^rgba\(\s*(.+)\s*,\s*(.+)\s*,\s*(.+)\s*,\s*(.+)\s*\)/);return null!==e&&{space:"RGB",r:parseFloat(e[1]),g:parseFloat(e[2]),b:parseFloat(e[3]),a:parseFloat(e[4])}},write:js}}},{litmus:Ws.isNumber,conversions:{HEX:{read:function(t){return{space:"HEX",hex:t,conversionName:"HEX"}},write:function(t){return t.hex}}}},{litmus:Ws.isArray,conversions:{RGB_ARRAY:{read:function(t){return 3===t.length&&{space:"RGB",r:t[0],g:t[1],b:t[2]}},write:function(t){return[t.r,t.g,t.b]}},RGBA_ARRAY:{read:function(t){return 4===t.length&&{space:"RGB",r:t[0],g:t[1],b:t[2],a:t[3]}},write:function(t){return[t.r,t.g,t.b,t.a]}}}},{litmus:Ws.isObject,conversions:{RGBA_OBJ:{read:function(t){return!!(Ws.isNumber(t.r)&&Ws.isNumber(t.g)&&Ws.isNumber(t.b)&&Ws.isNumber(t.a))&&{space:"RGB",r:t.r,g:t.g,b:t.b,a:t.a}},write:function(t){return{r:t.r,g:t.g,b:t.b,a:t.a}}},RGB_OBJ:{read:function(t){return!!(Ws.isNumber(t.r)&&Ws.isNumber(t.g)&&Ws.isNumber(t.b))&&{space:"RGB",r:t.r,g:t.g,b:t.b}},write:function(t){return{r:t.r,g:t.g,b:t.b}}},HSVA_OBJ:{read:function(t){return!!(Ws.isNumber(t.h)&&Ws.isNumber(t.s)&&Ws.isNumber(t.v)&&Ws.isNumber(t.a))&&{space:"HSV",h:t.h,s:t.s,v:t.v,a:t.a}},write:function(t){return{h:t.h,s:t.s,v:t.v,a:t.a}}},HSV_OBJ:{read:function(t){return!!(Ws.isNumber(t.h)&&Ws.isNumber(t.s)&&Ws.isNumber(t.v))&&{space:"HSV",h:t.h,s:t.s,v:t.v}},write:function(t){return{h:t.h,s:t.s,v:t.v}}}}}],Xs=void 0,qs=void 0,Ys=function(){qs=!1;var t=arguments.length>1?Ws.toArray(arguments):arguments[0];return Ws.each(Zs,function(e){if(e.litmus(t))return Ws.each(e.conversions,function(e,r){if(Xs=e.read(t),!1===qs&&!1!==Xs)return qs=Xs,Xs.conversionName=r,Xs.conversion=e,Ws.BREAK}),Ws.BREAK}),qs},Js=void 0,Ks={hsv_to_rgb:function(t,e,r){var n=Math.floor(t/60)%6,i=t/60-Math.floor(t/60),o=r*(1-e),a=r*(1-i*e),s=r*(1-(1-i)*e),h=[[r,s,o],[a,r,o],[o,r,s],[o,a,r],[s,o,r],[r,o,a]][n];return{r:255*h[0],g:255*h[1],b:255*h[2]}},rgb_to_hsv:function(t,e,r){var n=Math.min(t,e,r),i=Math.max(t,e,r),o=i-n,a=void 0;return 0===i?{h:NaN,s:0,v:0}:(a=t===i?(e-r)/o:e===i?2+(r-t)/o:4+(t-e)/o,(a/=6)<0&&(a+=1),{h:360*a,s:o/i,v:i/255})},rgb_to_hex:function(t,e,r){var n=this.hex_with_component(0,2,t);return n=this.hex_with_component(n,1,e),n=this.hex_with_component(n,0,r)},component_from_hex:function(t,e){return t>>8*e&255},hex_with_component:function(t,e,r){return r<<(Js=8*e)|t&~(255<<Js)}},Qs="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},$s=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},th=function(){function t(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,r,n){return r&&t(e.prototype,r),n&&t(e,n),e}}(),eh=function t(e,r,n){null===e&&(e=Function.prototype);var i=Object.getOwnPropertyDescriptor(e,r);if(void 0===i){var o=Object.getPrototypeOf(e);return null===o?void 0:t(o,r,n)}if("value"in i)return i.value;var a=i.get;return void 0!==a?a.call(n):void 0},rh=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},nh=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},ih=function(){function t(){if($s(this,t),this.__state=Ys.apply(this,arguments),!1===this.__state)throw new Error("Failed to interpret color arguments");this.__state.a=this.__state.a||1}return th(t,[{key:"toString",value:function(){return js(this)}},{key:"toHexString",value:function(){return js(this,!0)}},{key:"toOriginal",value:function(){return this.__state.conversion.write(this)}}]),t}();function oh(t,e,r){Object.defineProperty(t,e,{get:function(){return"RGB"===this.__state.space?this.__state[e]:(ih.recalculateRGB(this,e,r),this.__state[e])},set:function(t){"RGB"!==this.__state.space&&(ih.recalculateRGB(this,e,r),this.__state.space="RGB"),this.__state[e]=t}})}function ah(t,e){Object.defineProperty(t,e,{get:function(){return"HSV"===this.__state.space?this.__state[e]:(ih.recalculateHSV(this),this.__state[e])},set:function(t){"HSV"!==this.__state.space&&(ih.recalculateHSV(this),this.__state.space="HSV"),this.__state[e]=t}})}ih.recalculateRGB=function(t,e,r){if("HEX"===t.__state.space)t.__state[e]=Ks.component_from_hex(t.__state.hex,r);else{if("HSV"!==t.__state.space)throw new Error("Corrupted color state");Ws.extend(t.__state,Ks.hsv_to_rgb(t.__state.h,t.__state.s,t.__state.v))}},ih.recalculateHSV=function(t){var e=Ks.rgb_to_hsv(t.r,t.g,t.b);Ws.extend(t.__state,{s:e.s,v:e.v}),Ws.isNaN(e.h)?Ws.isUndefined(t.__state.h)&&(t.__state.h=0):t.__state.h=e.h},ih.COMPONENTS=["r","g","b","h","s","v","hex","a"],oh(ih.prototype,"r",2),oh(ih.prototype,"g",1),oh(ih.prototype,"b",0),ah(ih.prototype,"h"),ah(ih.prototype,"s"),ah(ih.prototype,"v"),Object.defineProperty(ih.prototype,"a",{get:function(){return this.__state.a},set:function(t){this.__state.a=t}}),Object.defineProperty(ih.prototype,"hex",{get:function(){return"HEX"!==!this.__state.space&&(this.__state.hex=Ks.rgb_to_hex(this.r,this.g,this.b)),this.__state.hex},set:function(t){this.__state.space="HEX",this.__state.hex=t}});var sh=function(){function t(e,r){$s(this,t),this.initialValue=e[r],this.domElement=document.createElement("div"),this.object=e,this.property=r,this.__onChange=void 0,this.__onFinishChange=void 0}return th(t,[{key:"onChange",value:function(t){return this.__onChange=t,this}},{key:"onFinishChange",value:function(t){return this.__onFinishChange=t,this}},{key:"setValue",value:function(t){return this.object[this.property]=t,this.__onChange&&this.__onChange.call(this,t),this.updateDisplay(),this}},{key:"getValue",value:function(){return this.object[this.property]}},{key:"updateDisplay",value:function(){return this}},{key:"isModified",value:function(){return this.initialValue!==this.getValue()}}]),t}(),hh={};Ws.each({HTMLEvents:["change"],MouseEvents:["click","mousemove","mousedown","mouseup","mouseover"],KeyboardEvents:["keydown"]},function(t,e){Ws.each(t,function(t){hh[t]=e})});var uh=/(\d+(\.\d+)?)px/;function lh(t){if("0"===t||Ws.isUndefined(t))return 0;var e=t.match(uh);return Ws.isNull(e)?0:parseFloat(e[1])}var ch={makeSelectable:function(t,e){void 0!==t&&void 0!==t.style&&(t.onselectstart=e?function(){return!1}:function(){},t.style.MozUserSelect=e?"auto":"none",t.style.KhtmlUserSelect=e?"auto":"none",t.unselectable=e?"on":"off")},makeFullscreen:function(t,e,r){var n=r,i=e;Ws.isUndefined(i)&&(i=!0),Ws.isUndefined(n)&&(n=!0),t.style.position="absolute",i&&(t.style.left=0,t.style.right=0),n&&(t.style.top=0,t.style.bottom=0)},fakeEvent:function(t,e,r,n){var i=r||{},o=hh[e];if(!o)throw new Error("Event type "+e+" not supported.");var a=document.createEvent(o);switch(o){case"MouseEvents":var s=i.x||i.clientX||0,h=i.y||i.clientY||0;a.initMouseEvent(e,i.bubbles||!1,i.cancelable||!0,window,i.clickCount||1,0,0,s,h,!1,!1,!1,!1,0,null);break;case"KeyboardEvents":var u=a.initKeyboardEvent||a.initKeyEvent;Ws.defaults(i,{cancelable:!0,ctrlKey:!1,altKey:!1,shiftKey:!1,metaKey:!1,keyCode:void 0,charCode:void 0}),u(e,i.bubbles||!1,i.cancelable,window,i.ctrlKey,i.altKey,i.shiftKey,i.metaKey,i.keyCode,i.charCode);break;default:a.initEvent(e,i.bubbles||!1,i.cancelable||!0)}Ws.defaults(a,n),t.dispatchEvent(a)},bind:function(t,e,r,n){var i=n||!1;return t.addEventListener?t.addEventListener(e,r,i):t.attachEvent&&t.attachEvent("on"+e,r),ch},unbind:function(t,e,r,n){var i=n||!1;return t.removeEventListener?t.removeEventListener(e,r,i):t.detachEvent&&t.detachEvent("on"+e,r),ch},addClass:function(t,e){if(void 0===t.className)t.className=e;else if(t.className!==e){var r=t.className.split(/ +/);-1===r.indexOf(e)&&(r.push(e),t.className=r.join(" ").replace(/^\s+/,"").replace(/\s+$/,""))}return ch},removeClass:function(t,e){if(e)if(t.className===e)t.removeAttribute("class");else{var r=t.className.split(/ +/),n=r.indexOf(e);-1!==n&&(r.splice(n,1),t.className=r.join(" "))}else t.className=void 0;return ch},hasClass:function(t,e){return new RegExp("(?:^|\\s+)"+e+"(?:\\s+|$)").test(t.className)||!1},getWidth:function(t){var e=getComputedStyle(t);return lh(e["border-left-width"])+lh(e["border-right-width"])+lh(e["padding-left"])+lh(e["padding-right"])+lh(e.width)},getHeight:function(t){var e=getComputedStyle(t);return lh(e["border-top-width"])+lh(e["border-bottom-width"])+lh(e["padding-top"])+lh(e["padding-bottom"])+lh(e.height)},getOffset:function(t){var e=t,r={left:0,top:0};if(e.offsetParent)do{r.left+=e.offsetLeft,r.top+=e.offsetTop,e=e.offsetParent}while(e);return r},isActive:function(t){return t===document.activeElement&&(t.type||t.href)}},fh=function(t){function e(t,r){$s(this,e);var n=nh(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,r)),i=n;return n.__prev=n.getValue(),n.__checkbox=document.createElement("input"),n.__checkbox.setAttribute("type","checkbox"),ch.bind(n.__checkbox,"change",function(){i.setValue(!i.__prev)},!1),n.domElement.appendChild(n.__checkbox),n.updateDisplay(),n}return rh(e,sh),th(e,[{key:"setValue",value:function(t){var r=eh(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setValue",this).call(this,t);return this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),this.__prev=this.getValue(),r}},{key:"updateDisplay",value:function(){return!0===this.getValue()?(this.__checkbox.setAttribute("checked","checked"),this.__checkbox.checked=!0,this.__prev=!0):(this.__checkbox.checked=!1,this.__prev=!1),eh(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this)}}]),e}(),dh=function(t){function e(t,r,n){$s(this,e);var i=nh(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,r)),o=n,a=i;if(i.__select=document.createElement("select"),Ws.isArray(o)){var s={};Ws.each(o,function(t){s[t]=t}),o=s}return Ws.each(o,function(t,e){var r=document.createElement("option");r.innerHTML=e,r.setAttribute("value",t),a.__select.appendChild(r)}),i.updateDisplay(),ch.bind(i.__select,"change",function(){var t=this.options[this.selectedIndex].value;a.setValue(t)}),i.domElement.appendChild(i.__select),i}return rh(e,sh),th(e,[{key:"setValue",value:function(t){var r=eh(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setValue",this).call(this,t);return this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),r}},{key:"updateDisplay",value:function(){return ch.isActive(this.__select)?this:(this.__select.value=this.getValue(),eh(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this))}}]),e}(),ph=function(t){function e(t,r){$s(this,e);var n=nh(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,r)),i=n;function o(){i.setValue(i.__input.value)}return n.__input=document.createElement("input"),n.__input.setAttribute("type","text"),ch.bind(n.__input,"keyup",o),ch.bind(n.__input,"change",o),ch.bind(n.__input,"blur",function(){i.__onFinishChange&&i.__onFinishChange.call(i,i.getValue())}),ch.bind(n.__input,"keydown",function(t){13===t.keyCode&&this.blur()}),n.updateDisplay(),n.domElement.appendChild(n.__input),n}return rh(e,sh),th(e,[{key:"updateDisplay",value:function(){return ch.isActive(this.__input)||(this.__input.value=this.getValue()),eh(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this)}}]),e}();function mh(t){var e=t.toString();return e.indexOf(".")>-1?e.length-e.indexOf(".")-1:0}var gh=function(t){function e(t,r,n){$s(this,e);var i=nh(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,r)),o=n||{};return i.__min=o.min,i.__max=o.max,i.__step=o.step,Ws.isUndefined(i.__step)?0===i.initialValue?i.__impliedStep=1:i.__impliedStep=Math.pow(10,Math.floor(Math.log(Math.abs(i.initialValue))/Math.LN10))/10:i.__impliedStep=i.__step,i.__precision=mh(i.__impliedStep),i}return rh(e,sh),th(e,[{key:"setValue",value:function(t){var r=t;return void 0!==this.__min&&r<this.__min?r=this.__min:void 0!==this.__max&&r>this.__max&&(r=this.__max),void 0!==this.__step&&r%this.__step!=0&&(r=Math.round(r/this.__step)*this.__step),eh(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setValue",this).call(this,r)}},{key:"min",value:function(t){return this.__min=t,this}},{key:"max",value:function(t){return this.__max=t,this}},{key:"step",value:function(t){return this.__step=t,this.__impliedStep=t,this.__precision=mh(t),this}}]),e}();var _h=function(t){function e(t,r,n){$s(this,e);var i=nh(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,r,n));i.__truncationSuspended=!1;var o=i,a=void 0;function s(){o.__onFinishChange&&o.__onFinishChange.call(o,o.getValue())}function h(t){var e=a-t.clientY;o.setValue(o.getValue()+e*o.__impliedStep),a=t.clientY}function u(){ch.unbind(window,"mousemove",h),ch.unbind(window,"mouseup",u),s()}return i.__input=document.createElement("input"),i.__input.setAttribute("type","text"),ch.bind(i.__input,"change",function(){var t=parseFloat(o.__input.value);Ws.isNaN(t)||o.setValue(t)}),ch.bind(i.__input,"blur",function(){s()}),ch.bind(i.__input,"mousedown",function(t){ch.bind(window,"mousemove",h),ch.bind(window,"mouseup",u),a=t.clientY}),ch.bind(i.__input,"keydown",function(t){13===t.keyCode&&(o.__truncationSuspended=!0,this.blur(),o.__truncationSuspended=!1,s())}),i.updateDisplay(),i.domElement.appendChild(i.__input),i}return rh(e,gh),th(e,[{key:"updateDisplay",value:function(){var t,r,n;return this.__input.value=this.__truncationSuspended?this.getValue():(t=this.getValue(),r=this.__precision,n=Math.pow(10,r),Math.round(t*n)/n),eh(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this)}}]),e}();function yh(t,e,r,n,i){return n+(t-e)/(r-e)*(i-n)}var vh=function(t){function e(t,r,n,i,o){$s(this,e);var a=nh(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,r,{min:n,max:i,step:o})),s=a;function h(t){t.preventDefault();var e=s.__background.getBoundingClientRect();return s.setValue(yh(t.clientX,e.left,e.right,s.__min,s.__max)),!1}function u(){ch.unbind(window,"mousemove",h),ch.unbind(window,"mouseup",u),s.__onFinishChange&&s.__onFinishChange.call(s,s.getValue())}function l(t){var e=t.touches[0].clientX,r=s.__background.getBoundingClientRect();s.setValue(yh(e,r.left,r.right,s.__min,s.__max))}function c(){ch.unbind(window,"touchmove",l),ch.unbind(window,"touchend",c),s.__onFinishChange&&s.__onFinishChange.call(s,s.getValue())}return a.__background=document.createElement("div"),a.__foreground=document.createElement("div"),ch.bind(a.__background,"mousedown",function(t){document.activeElement.blur(),ch.bind(window,"mousemove",h),ch.bind(window,"mouseup",u),h(t)}),ch.bind(a.__background,"touchstart",function(t){if(1!==t.touches.length)return;ch.bind(window,"touchmove",l),ch.bind(window,"touchend",c),l(t)}),ch.addClass(a.__background,"slider"),ch.addClass(a.__foreground,"slider-fg"),a.updateDisplay(),a.__background.appendChild(a.__foreground),a.domElement.appendChild(a.__background),a}return rh(e,gh),th(e,[{key:"updateDisplay",value:function(){var t=(this.getValue()-this.__min)/(this.__max-this.__min);return this.__foreground.style.width=100*t+"%",eh(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this)}}]),e}(),xh=function(t){function e(t,r,n){$s(this,e);var i=nh(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,r)),o=i;return i.__button=document.createElement("div"),i.__button.innerHTML=void 0===n?"Fire":n,ch.bind(i.__button,"click",function(t){return t.preventDefault(),o.fire(),!1}),ch.addClass(i.__button,"button"),i.domElement.appendChild(i.__button),i}return rh(e,sh),th(e,[{key:"fire",value:function(){this.__onChange&&this.__onChange.call(this),this.getValue().call(this.object),this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue())}}]),e}(),bh=function(t){function e(t,r){$s(this,e);var n=nh(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,r));n.__color=new ih(n.getValue()),n.__temp=new ih(0);var i=n;n.domElement=document.createElement("div"),ch.makeSelectable(n.domElement,!1),n.__selector=document.createElement("div"),n.__selector.className="selector",n.__saturation_field=document.createElement("div"),n.__saturation_field.className="saturation-field",n.__field_knob=document.createElement("div"),n.__field_knob.className="field-knob",n.__field_knob_border="2px solid ",n.__hue_knob=document.createElement("div"),n.__hue_knob.className="hue-knob",n.__hue_field=document.createElement("div"),n.__hue_field.className="hue-field",n.__input=document.createElement("input"),n.__input.type="text",n.__input_textShadow="0 1px 1px ",ch.bind(n.__input,"keydown",function(t){13===t.keyCode&&c.call(this)}),ch.bind(n.__input,"blur",c),ch.bind(n.__selector,"mousedown",function(){ch.addClass(this,"drag").bind(window,"mouseup",function(){ch.removeClass(i.__selector,"drag")})}),ch.bind(n.__selector,"touchstart",function(){ch.addClass(this,"drag").bind(window,"touchend",function(){ch.removeClass(i.__selector,"drag")})});var o,a=document.createElement("div");function s(t){d(t),ch.bind(window,"mousemove",d),ch.bind(window,"touchmove",d),ch.bind(window,"mouseup",u),ch.bind(window,"touchend",u)}function h(t){p(t),ch.bind(window,"mousemove",p),ch.bind(window,"touchmove",p),ch.bind(window,"mouseup",l),ch.bind(window,"touchend",l)}function u(){ch.unbind(window,"mousemove",d),ch.unbind(window,"touchmove",d),ch.unbind(window,"mouseup",u),ch.unbind(window,"touchend",u),f()}function l(){ch.unbind(window,"mousemove",p),ch.unbind(window,"touchmove",p),ch.unbind(window,"mouseup",l),ch.unbind(window,"touchend",l),f()}function c(){var t=Ys(this.value);!1!==t?(i.__color.__state=t,i.setValue(i.__color.toOriginal())):this.value=i.__color.toString()}function f(){i.__onFinishChange&&i.__onFinishChange.call(i,i.__color.toOriginal())}function d(t){-1===t.type.indexOf("touch")&&t.preventDefault();var e=i.__saturation_field.getBoundingClientRect(),r=t.touches&&t.touches[0]||t,n=r.clientX,o=r.clientY,a=(n-e.left)/(e.right-e.left),s=1-(o-e.top)/(e.bottom-e.top);return s>1?s=1:s<0&&(s=0),a>1?a=1:a<0&&(a=0),i.__color.v=s,i.__color.s=a,i.setValue(i.__color.toOriginal()),!1}function p(t){-1===t.type.indexOf("touch")&&t.preventDefault();var e=i.__hue_field.getBoundingClientRect(),r=1-((t.touches&&t.touches[0]||t).clientY-e.top)/(e.bottom-e.top);return r>1?r=1:r<0&&(r=0),i.__color.h=360*r,i.setValue(i.__color.toOriginal()),!1}return Ws.extend(n.__selector.style,{width:"122px",height:"102px",padding:"3px",backgroundColor:"#222",boxShadow:"0px 1px 3px rgba(0,0,0,0.3)"}),Ws.extend(n.__field_knob.style,{position:"absolute",width:"12px",height:"12px",border:n.__field_knob_border+(n.__color.v<.5?"#fff":"#000"),boxShadow:"0px 1px 3px rgba(0,0,0,0.5)",borderRadius:"12px",zIndex:1}),Ws.extend(n.__hue_knob.style,{position:"absolute",width:"15px",height:"2px",borderRight:"4px solid #fff",zIndex:1}),Ws.extend(n.__saturation_field.style,{width:"100px",height:"100px",border:"1px solid #555",marginRight:"3px",display:"inline-block",cursor:"pointer"}),Ws.extend(a.style,{width:"100%",height:"100%",background:"none"}),Th(a,"top","rgba(0,0,0,0)","#000"),Ws.extend(n.__hue_field.style,{width:"15px",height:"100px",border:"1px solid #555",cursor:"ns-resize",position:"absolute",top:"3px",right:"3px"}),(o=n.__hue_field).style.background="",o.style.cssText+="background: -moz-linear-gradient(top,  #ff0000 0%, #ff00ff 17%, #0000ff 34%, #00ffff 50%, #00ff00 67%, #ffff00 84%, #ff0000 100%);",o.style.cssText+="background: -webkit-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",o.style.cssText+="background: -o-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",o.style.cssText+="background: -ms-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",o.style.cssText+="background: linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",Ws.extend(n.__input.style,{outline:"none",textAlign:"center",color:"#fff",border:0,fontWeight:"bold",textShadow:n.__input_textShadow+"rgba(0,0,0,0.7)"}),ch.bind(n.__saturation_field,"mousedown",s),ch.bind(n.__saturation_field,"touchstart",s),ch.bind(n.__field_knob,"mousedown",s),ch.bind(n.__field_knob,"touchstart",s),ch.bind(n.__hue_field,"mousedown",h),ch.bind(n.__hue_field,"touchstart",h),n.__saturation_field.appendChild(a),n.__selector.appendChild(n.__field_knob),n.__selector.appendChild(n.__saturation_field),n.__selector.appendChild(n.__hue_field),n.__hue_field.appendChild(n.__hue_knob),n.domElement.appendChild(n.__input),n.domElement.appendChild(n.__selector),n.updateDisplay(),n}return rh(e,sh),th(e,[{key:"updateDisplay",value:function(){var t=Ys(this.getValue());if(!1!==t){var e=!1;Ws.each(ih.COMPONENTS,function(r){if(!Ws.isUndefined(t[r])&&!Ws.isUndefined(this.__color.__state[r])&&t[r]!==this.__color.__state[r])return e=!0,{}},this),e&&Ws.extend(this.__color.__state,t)}Ws.extend(this.__temp.__state,this.__color.__state),this.__temp.a=1;var r=this.__color.v<.5||this.__color.s>.5?255:0,n=255-r;Ws.extend(this.__field_knob.style,{marginLeft:100*this.__color.s-7+"px",marginTop:100*(1-this.__color.v)-7+"px",backgroundColor:this.__temp.toHexString(),border:this.__field_knob_border+"rgb("+r+","+r+","+r+")"}),this.__hue_knob.style.marginTop=100*(1-this.__color.h/360)+"px",this.__temp.s=1,this.__temp.v=1,Th(this.__saturation_field,"left","#fff",this.__temp.toHexString()),this.__input.value=this.__color.toString(),Ws.extend(this.__input.style,{backgroundColor:this.__color.toHexString(),color:"rgb("+r+","+r+","+r+")",textShadow:this.__input_textShadow+"rgba("+n+","+n+","+n+",.7)"})}}]),e}(),wh=["-moz-","-o-","-webkit-","-ms-",""];function Th(t,e,r,n){t.style.background="",Ws.each(wh,function(i){t.style.cssText+="background: "+i+"linear-gradient("+e+", "+r+" 0%, "+n+" 100%); "})}var Eh=function(t,e){var r=e||document,n=document.createElement("style");n.type="text/css",n.innerHTML=t;var i=r.getElementsByTagName("head")[0];try{i.appendChild(n)}catch(t){}},Ch=function(t,e){var r=t[e];return Ws.isArray(arguments[2])||Ws.isObject(arguments[2])?new dh(t,e,arguments[2]):Ws.isNumber(r)?Ws.isNumber(arguments[2])&&Ws.isNumber(arguments[3])?Ws.isNumber(arguments[4])?new vh(t,e,arguments[2],arguments[3],arguments[4]):new vh(t,e,arguments[2],arguments[3]):Ws.isNumber(arguments[4])?new _h(t,e,{min:arguments[2],max:arguments[3],step:arguments[4]}):new _h(t,e,{min:arguments[2],max:arguments[3]}):Ws.isString(r)?new ph(t,e):Ws.isFunction(r)?new xh(t,e,""):Ws.isBoolean(r)?new fh(t,e):null};var Sh=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){setTimeout(t,1e3/60)},Ah=function(){function t(){$s(this,t),this.backgroundElement=document.createElement("div"),Ws.extend(this.backgroundElement.style,{backgroundColor:"rgba(0,0,0,0.8)",top:0,left:0,display:"none",zIndex:"1000",opacity:0,WebkitTransition:"opacity 0.2s linear",transition:"opacity 0.2s linear"}),ch.makeFullscreen(this.backgroundElement),this.backgroundElement.style.position="fixed",this.domElement=document.createElement("div"),Ws.extend(this.domElement.style,{position:"fixed",display:"none",zIndex:"1001",opacity:0,WebkitTransition:"-webkit-transform 0.2s ease-out, opacity 0.2s linear",transition:"transform 0.2s ease-out, opacity 0.2s linear"}),document.body.appendChild(this.backgroundElement),document.body.appendChild(this.domElement);var e=this;ch.bind(this.backgroundElement,"click",function(){e.hide()})}return th(t,[{key:"show",value:function(){var t=this;this.backgroundElement.style.display="block",this.domElement.style.display="block",this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)",this.layout(),Ws.defer(function(){t.backgroundElement.style.opacity=1,t.domElement.style.opacity=1,t.domElement.style.webkitTransform="scale(1)"})}},{key:"hide",value:function(){var t=this,e=function e(){t.domElement.style.display="none",t.backgroundElement.style.display="none",ch.unbind(t.domElement,"webkitTransitionEnd",e),ch.unbind(t.domElement,"transitionend",e),ch.unbind(t.domElement,"oTransitionEnd",e)};ch.bind(this.domElement,"webkitTransitionEnd",e),ch.bind(this.domElement,"transitionend",e),ch.bind(this.domElement,"oTransitionEnd",e),this.backgroundElement.style.opacity=0,this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)"}},{key:"layout",value:function(){this.domElement.style.left=window.innerWidth/2-ch.getWidth(this.domElement)/2+"px",this.domElement.style.top=window.innerHeight/2-ch.getHeight(this.domElement)/2+"px"}}]),t}();Eh(function(t){if(t&&"undefined"!=typeof window){var e=document.createElement("style");return e.setAttribute("type","text/css"),e.innerHTML=t,document.head.appendChild(e),t}}(".dg ul{list-style:none;margin:0;padding:0;width:100%;clear:both}.dg.ac{position:fixed;top:0;left:0;right:0;height:0;z-index:0}.dg:not(.ac) .main{overflow:hidden}.dg.main{-webkit-transition:opacity .1s linear;-o-transition:opacity .1s linear;-moz-transition:opacity .1s linear;transition:opacity .1s linear}.dg.main.taller-than-window{overflow-y:auto}.dg.main.taller-than-window .close-button{opacity:1;margin-top:-1px;border-top:1px solid #2c2c2c}.dg.main ul.closed .close-button{opacity:1 !important}.dg.main:hover .close-button,.dg.main .close-button.drag{opacity:1}.dg.main .close-button{-webkit-transition:opacity .1s linear;-o-transition:opacity .1s linear;-moz-transition:opacity .1s linear;transition:opacity .1s linear;border:0;line-height:19px;height:20px;cursor:pointer;text-align:center;background-color:#000}.dg.main .close-button.close-top{position:relative}.dg.main .close-button.close-bottom{position:absolute}.dg.main .close-button:hover{background-color:#111}.dg.a{float:right;margin-right:15px;overflow-y:visible}.dg.a.has-save>ul.close-top{margin-top:0}.dg.a.has-save>ul.close-bottom{margin-top:27px}.dg.a.has-save>ul.closed{margin-top:0}.dg.a .save-row{top:0;z-index:1002}.dg.a .save-row.close-top{position:relative}.dg.a .save-row.close-bottom{position:fixed}.dg li{-webkit-transition:height .1s ease-out;-o-transition:height .1s ease-out;-moz-transition:height .1s ease-out;transition:height .1s ease-out;-webkit-transition:overflow .1s linear;-o-transition:overflow .1s linear;-moz-transition:overflow .1s linear;transition:overflow .1s linear}.dg li:not(.folder){cursor:auto;height:27px;line-height:27px;padding:0 4px 0 5px}.dg li.folder{padding:0;border-left:4px solid rgba(0,0,0,0)}.dg li.title{cursor:pointer;margin-left:-4px}.dg .closed li:not(.title),.dg .closed ul li,.dg .closed ul li>*{height:0;overflow:hidden;border:0}.dg .cr{clear:both;padding-left:3px;height:27px;overflow:hidden}.dg .property-name{cursor:default;float:left;clear:left;width:40%;overflow:hidden;text-overflow:ellipsis}.dg .c{float:left;width:60%;position:relative}.dg .c input[type=text]{border:0;margin-top:4px;padding:3px;width:100%;float:right}.dg .has-slider input[type=text]{width:30%;margin-left:0}.dg .slider{float:left;width:66%;margin-left:-5px;margin-right:0;height:19px;margin-top:4px}.dg .slider-fg{height:100%}.dg .c input[type=checkbox]{margin-top:7px}.dg .c select{margin-top:5px}.dg .cr.function,.dg .cr.function .property-name,.dg .cr.function *,.dg .cr.boolean,.dg .cr.boolean *{cursor:pointer}.dg .cr.color{overflow:visible}.dg .selector{display:none;position:absolute;margin-left:-9px;margin-top:23px;z-index:10}.dg .c:hover .selector,.dg .selector.drag{display:block}.dg li.save-row{padding:0}.dg li.save-row .button{display:inline-block;padding:0px 6px}.dg.dialogue{background-color:#222;width:460px;padding:15px;font-size:13px;line-height:15px}#dg-new-constructor{padding:10px;color:#222;font-family:Monaco, monospace;font-size:10px;border:0;resize:none;box-shadow:inset 1px 1px 1px #888;word-wrap:break-word;margin:12px 0;display:block;width:440px;overflow-y:scroll;height:100px;position:relative}#dg-local-explain{display:none;font-size:11px;line-height:17px;border-radius:3px;background-color:#333;padding:8px;margin-top:10px}#dg-local-explain code{font-size:10px}#dat-gui-save-locally{display:none}.dg{color:#eee;font:11px 'Lucida Grande', sans-serif;text-shadow:0 -1px 0 #111}.dg.main::-webkit-scrollbar{width:5px;background:#1a1a1a}.dg.main::-webkit-scrollbar-corner{height:0;display:none}.dg.main::-webkit-scrollbar-thumb{border-radius:5px;background:#676767}.dg li:not(.folder){background:#1a1a1a;border-bottom:1px solid #2c2c2c}.dg li.save-row{line-height:25px;background:#dad5cb;border:0}.dg li.save-row select{margin-left:5px;width:108px}.dg li.save-row .button{margin-left:5px;margin-top:1px;border-radius:2px;font-size:9px;line-height:7px;padding:4px 4px 5px 4px;background:#c5bdad;color:#fff;text-shadow:0 1px 0 #b0a58f;box-shadow:0 -1px 0 #b0a58f;cursor:pointer}.dg li.save-row .button.gears{background:#c5bdad url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAANCAYAAAB/9ZQ7AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQJJREFUeNpiYKAU/P//PwGIC/ApCABiBSAW+I8AClAcgKxQ4T9hoMAEUrxx2QSGN6+egDX+/vWT4e7N82AMYoPAx/evwWoYoSYbACX2s7KxCxzcsezDh3evFoDEBYTEEqycggWAzA9AuUSQQgeYPa9fPv6/YWm/Acx5IPb7ty/fw+QZblw67vDs8R0YHyQhgObx+yAJkBqmG5dPPDh1aPOGR/eugW0G4vlIoTIfyFcA+QekhhHJhPdQxbiAIguMBTQZrPD7108M6roWYDFQiIAAv6Aow/1bFwXgis+f2LUAynwoIaNcz8XNx3Dl7MEJUDGQpx9gtQ8YCueB+D26OECAAQDadt7e46D42QAAAABJRU5ErkJggg==) 2px 1px no-repeat;height:7px;width:8px}.dg li.save-row .button:hover{background-color:#bab19e;box-shadow:0 -1px 0 #b0a58f}.dg li.folder{border-bottom:0}.dg li.title{padding-left:16px;background:#000 url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlI+hKgFxoCgAOw==) 6px 10px no-repeat;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.2)}.dg .closed li.title{background-image:url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlGIWqMCbWAEAOw==)}.dg .cr.boolean{border-left:3px solid #806787}.dg .cr.color{border-left:3px solid}.dg .cr.function{border-left:3px solid #e61d5f}.dg .cr.number{border-left:3px solid #2FA1D6}.dg .cr.number input[type=text]{color:#2FA1D6}.dg .cr.string{border-left:3px solid #1ed36f}.dg .cr.string input[type=text]{color:#1ed36f}.dg .cr.function:hover,.dg .cr.boolean:hover{background:#111}.dg .c input[type=text]{background:#303030;outline:none}.dg .c input[type=text]:hover{background:#3c3c3c}.dg .c input[type=text]:focus{background:#494949;color:#fff}.dg .c .slider{background:#303030;cursor:ew-resize}.dg .c .slider-fg{background:#2FA1D6;max-width:100%}.dg .c .slider:hover{background:#3c3c3c}.dg .c .slider:hover .slider-fg{background:#44abda}\n"));var Mh="Default",Ph=function(){try{return!!window.localStorage}catch(t){return!1}}(),Rh=void 0,Lh=!0,Oh=void 0,kh=!1,Dh=[],Ih=function t(e){var r=this,n=e||{};this.domElement=document.createElement("div"),this.__ul=document.createElement("ul"),this.domElement.appendChild(this.__ul),ch.addClass(this.domElement,"dg"),this.__folders={},this.__controllers=[],this.__rememberedObjects=[],this.__rememberedObjectIndecesToControllers=[],this.__listening=[],n=Ws.defaults(n,{closeOnTop:!1,autoPlace:!0,width:t.DEFAULT_WIDTH}),n=Ws.defaults(n,{resizable:n.autoPlace,hideable:n.autoPlace}),Ws.isUndefined(n.load)?n.load={preset:Mh}:n.preset&&(n.load.preset=n.preset),Ws.isUndefined(n.parent)&&n.hideable&&Dh.push(this),n.resizable=Ws.isUndefined(n.parent)&&n.resizable,n.autoPlace&&Ws.isUndefined(n.scrollable)&&(n.scrollable=!0);var i,o=Ph&&"true"===localStorage.getItem(Hh(this,"isLocal")),a=void 0;if(Object.defineProperties(this,{parent:{get:function(){return n.parent}},scrollable:{get:function(){return n.scrollable}},autoPlace:{get:function(){return n.autoPlace}},closeOnTop:{get:function(){return n.closeOnTop}},preset:{get:function(){return r.parent?r.getRoot().preset:n.load.preset},set:function(t){r.parent?r.getRoot().preset=t:n.load.preset=t,function(t){for(var e=0;e<t.__preset_select.length;e++)t.__preset_select[e].value===t.preset&&(t.__preset_select.selectedIndex=e)}(this),r.revert()}},width:{get:function(){return n.width},set:function(t){n.width=t,Wh(r,t)}},name:{get:function(){return n.name},set:function(t){n.name=t,titleRowName&&(titleRowName.innerHTML=n.name)}},closed:{get:function(){return n.closed},set:function(e){n.closed=e,n.closed?ch.addClass(r.__ul,t.CLASS_CLOSED):ch.removeClass(r.__ul,t.CLASS_CLOSED),this.onResize(),r.__closeButton&&(r.__closeButton.innerHTML=e?t.TEXT_OPEN:t.TEXT_CLOSED)}},load:{get:function(){return n.load}},useLocalStorage:{get:function(){return o},set:function(t){Ph&&(o=t,t?ch.bind(window,"unload",a):ch.unbind(window,"unload",a),localStorage.setItem(Hh(r,"isLocal"),t))}}}),Ws.isUndefined(n.parent)){if(n.closed=!1,ch.addClass(this.domElement,t.CLASS_MAIN),ch.makeSelectable(this.domElement,!1),Ph&&o){r.useLocalStorage=!0;var s=localStorage.getItem(Hh(this,"gui"));s&&(n.load=JSON.parse(s))}this.__closeButton=document.createElement("div"),this.__closeButton.innerHTML=t.TEXT_CLOSED,ch.addClass(this.__closeButton,t.CLASS_CLOSE_BUTTON),n.closeOnTop?(ch.addClass(this.__closeButton,t.CLASS_CLOSE_TOP),this.domElement.insertBefore(this.__closeButton,this.domElement.childNodes[0])):(ch.addClass(this.__closeButton,t.CLASS_CLOSE_BOTTOM),this.domElement.appendChild(this.__closeButton)),ch.bind(this.__closeButton,"click",function(){r.closed=!r.closed})}else{void 0===n.closed&&(n.closed=!0);var h=document.createTextNode(n.name);ch.addClass(h,"controller-name");var u=Nh(r,h);ch.addClass(this.__ul,t.CLASS_CLOSED),ch.addClass(u,"title"),ch.bind(u,"click",function(t){return t.preventDefault(),r.closed=!r.closed,!1}),n.closed||(this.closed=!1)}n.autoPlace&&(Ws.isUndefined(n.parent)&&(Lh&&(Oh=document.createElement("div"),ch.addClass(Oh,"dg"),ch.addClass(Oh,t.CLASS_AUTO_PLACE_CONTAINER),document.body.appendChild(Oh),Lh=!1),Oh.appendChild(this.domElement),ch.addClass(this.domElement,t.CLASS_AUTO_PLACE)),this.parent||Wh(r,n.width)),this.__resizeHandler=function(){r.onResizeDebounced()},ch.bind(window,"resize",this.__resizeHandler),ch.bind(this.__ul,"webkitTransitionEnd",this.__resizeHandler),ch.bind(this.__ul,"transitionend",this.__resizeHandler),ch.bind(this.__ul,"oTransitionEnd",this.__resizeHandler),this.onResize(),n.resizable&&Vh(this),a=function(){Ph&&"true"===localStorage.getItem(Hh(r,"isLocal"))&&localStorage.setItem(Hh(r,"gui"),JSON.stringify(r.getSaveObject()))},this.saveToLocalStorageIfPossible=a,n.parent||((i=r.getRoot()).width+=1,Ws.defer(function(){i.width-=1}))};function Nh(t,e,r){var n=document.createElement("li");return e&&n.appendChild(e),r?t.__ul.insertBefore(n,r):t.__ul.appendChild(n),t.onResize(),n}function Fh(t){ch.unbind(window,"resize",t.__resizeHandler),t.saveToLocalStorageIfPossible&&ch.unbind(window,"unload",t.saveToLocalStorageIfPossible)}function Bh(t,e){var r=t.__preset_select[t.__preset_select.selectedIndex];r.innerHTML=e?r.value+"*":r.value}function zh(t,e){var r=t.getRoot(),n=r.__rememberedObjects.indexOf(e.object);if(-1!==n){var i=r.__rememberedObjectIndecesToControllers[n];if(void 0===i&&(i={},r.__rememberedObjectIndecesToControllers[n]=i),i[e.property]=e,r.load&&r.load.remembered){var o=r.load.remembered,a=void 0;if(o[t.preset])a=o[t.preset];else{if(!o[Mh])return;a=o[Mh]}if(a[n]&&void 0!==a[n][e.property]){var s=a[n][e.property];e.initialValue=s,e.setValue(s)}}}}function Uh(t,e,r,n){if(void 0===e[r])throw new Error('Object "'+e+'" has no property "'+r+'"');var i=void 0;if(n.color)i=new bh(e,r);else{var o=[e,r].concat(n.factoryArgs);i=Ch.apply(t,o)}n.before instanceof sh&&(n.before=n.before.__li),zh(t,i),ch.addClass(i.domElement,"c");var a=document.createElement("span");ch.addClass(a,"property-name"),a.innerHTML=i.property;var s=document.createElement("div");s.appendChild(a),s.appendChild(i.domElement);var h=Nh(t,s,n.before);return ch.addClass(h,Ih.CLASS_CONTROLLER_ROW),i instanceof bh?ch.addClass(h,"color"):ch.addClass(h,Qs(i.getValue())),function(t,e,r){if(r.__li=e,r.__gui=t,Ws.extend(r,{options:function(e){if(arguments.length>1){var n=r.__li.nextElementSibling;return r.remove(),Uh(t,r.object,r.property,{before:n,factoryArgs:[Ws.toArray(arguments)]})}if(Ws.isArray(e)||Ws.isObject(e)){var i=r.__li.nextElementSibling;return r.remove(),Uh(t,r.object,r.property,{before:i,factoryArgs:[e]})}},name:function(t){return r.__li.firstElementChild.firstElementChild.innerHTML=t,r},listen:function(){return r.__gui.listen(r),r},remove:function(){return r.__gui.remove(r),r}}),r instanceof vh){var n=new _h(r.object,r.property,{min:r.__min,max:r.__max,step:r.__step});Ws.each(["updateDisplay","onChange","onFinishChange","step"],function(t){var e=r[t],i=n[t];r[t]=n[t]=function(){var t=Array.prototype.slice.call(arguments);return i.apply(n,t),e.apply(r,t)}}),ch.addClass(e,"has-slider"),r.domElement.insertBefore(n.domElement,r.domElement.firstElementChild)}else if(r instanceof _h){var i=function(e){if(Ws.isNumber(r.__min)&&Ws.isNumber(r.__max)){var n=r.__li.firstElementChild.firstElementChild.innerHTML,i=r.__gui.__listening.indexOf(r)>-1;r.remove();var o=Uh(t,r.object,r.property,{before:r.__li.nextElementSibling,factoryArgs:[r.__min,r.__max,r.__step]});return o.name(n),i&&o.listen(),o}return e};r.min=Ws.compose(i,r.min),r.max=Ws.compose(i,r.max)}else r instanceof fh?(ch.bind(e,"click",function(){ch.fakeEvent(r.__checkbox,"click")}),ch.bind(r.__checkbox,"click",function(t){t.stopPropagation()})):r instanceof xh?(ch.bind(e,"click",function(){ch.fakeEvent(r.__button,"click")}),ch.bind(e,"mouseover",function(){ch.addClass(r.__button,"hover")}),ch.bind(e,"mouseout",function(){ch.removeClass(r.__button,"hover")})):r instanceof bh&&(ch.addClass(e,"color"),r.updateDisplay=Ws.compose(function(t){return e.style.borderLeftColor=r.__color.toString(),t},r.updateDisplay),r.updateDisplay());r.setValue=Ws.compose(function(e){return t.getRoot().__preset_select&&r.isModified()&&Bh(t.getRoot(),!0),e},r.setValue)}(t,h,i),t.__controllers.push(i),i}function Hh(t,e){return document.location.href+"."+e}function jh(t,e,r){var n=document.createElement("option");n.innerHTML=e,n.value=e,t.__preset_select.appendChild(n),r&&(t.__preset_select.selectedIndex=t.__preset_select.length-1)}function Gh(t,e){e.style.display=t.useLocalStorage?"block":"none"}function Vh(t){var e=void 0;function r(r){return r.preventDefault(),t.width+=e-r.clientX,t.onResize(),e=r.clientX,!1}function n(){ch.removeClass(t.__closeButton,Ih.CLASS_DRAG),ch.unbind(window,"mousemove",r),ch.unbind(window,"mouseup",n)}function i(i){return i.preventDefault(),e=i.clientX,ch.addClass(t.__closeButton,Ih.CLASS_DRAG),ch.bind(window,"mousemove",r),ch.bind(window,"mouseup",n),!1}t.__resize_handle=document.createElement("div"),Ws.extend(t.__resize_handle.style,{width:"6px",marginLeft:"-3px",height:"200px",cursor:"ew-resize",position:"absolute"}),ch.bind(t.__resize_handle,"mousedown",i),ch.bind(t.__closeButton,"mousedown",i),t.domElement.insertBefore(t.__resize_handle,t.domElement.firstElementChild)}function Wh(t,e){t.domElement.style.width=e+"px",t.__save_row&&t.autoPlace&&(t.__save_row.style.width=e+"px"),t.__closeButton&&(t.__closeButton.style.width=e+"px")}function Zh(t,e){var r={};return Ws.each(t.__rememberedObjects,function(n,i){var o={},a=t.__rememberedObjectIndecesToControllers[i];Ws.each(a,function(t,r){o[r]=e?t.initialValue:t.getValue()}),r[i]=o}),r}Ih.toggleHide=function(){kh=!kh,Ws.each(Dh,function(t){t.domElement.style.display=kh?"none":""})},Ih.CLASS_AUTO_PLACE="a",Ih.CLASS_AUTO_PLACE_CONTAINER="ac",Ih.CLASS_MAIN="main",Ih.CLASS_CONTROLLER_ROW="cr",Ih.CLASS_TOO_TALL="taller-than-window",Ih.CLASS_CLOSED="closed",Ih.CLASS_CLOSE_BUTTON="close-button",Ih.CLASS_CLOSE_TOP="close-top",Ih.CLASS_CLOSE_BOTTOM="close-bottom",Ih.CLASS_DRAG="drag",Ih.DEFAULT_WIDTH=245,Ih.TEXT_CLOSED="Close Controls",Ih.TEXT_OPEN="Open Controls",Ih._keydownHandler=function(t){"text"===document.activeElement.type||72!==t.which&&72!==t.keyCode||Ih.toggleHide()},ch.bind(window,"keydown",Ih._keydownHandler,!1),Ws.extend(Ih.prototype,{add:function(t,e){return Uh(this,t,e,{factoryArgs:Array.prototype.slice.call(arguments,2)})},addColor:function(t,e){return Uh(this,t,e,{color:!0})},remove:function(t){this.__ul.removeChild(t.__li),this.__controllers.splice(this.__controllers.indexOf(t),1);var e=this;Ws.defer(function(){e.onResize()})},destroy:function(){if(this.parent)throw new Error("Only the root GUI should be removed with .destroy(). For subfolders, use gui.removeFolder(folder) instead.");this.autoPlace&&Oh.removeChild(this.domElement);var t=this;Ws.each(this.__folders,function(e){t.removeFolder(e)}),ch.unbind(window,"keydown",Ih._keydownHandler,!1),Fh(this)},addFolder:function(t){if(void 0!==this.__folders[t])throw new Error('You already have a folder in this GUI by the name "'+t+'"');var e={name:t,parent:this};e.autoPlace=this.autoPlace,this.load&&this.load.folders&&this.load.folders[t]&&(e.closed=this.load.folders[t].closed,e.load=this.load.folders[t]);var r=new Ih(e);this.__folders[t]=r;var n=Nh(this,r.domElement);return ch.addClass(n,"folder"),r},removeFolder:function(t){this.__ul.removeChild(t.domElement.parentElement),delete this.__folders[t.name],this.load&&this.load.folders&&this.load.folders[t.name]&&delete this.load.folders[t.name],Fh(t);var e=this;Ws.each(t.__folders,function(e){t.removeFolder(e)}),Ws.defer(function(){e.onResize()})},open:function(){this.closed=!1},close:function(){this.closed=!0},onResize:function(){var t=this.getRoot();if(t.scrollable){var e=ch.getOffset(t.__ul).top,r=0;Ws.each(t.__ul.childNodes,function(e){t.autoPlace&&e===t.__save_row||(r+=ch.getHeight(e))}),window.innerHeight-e-20<r?(ch.addClass(t.domElement,Ih.CLASS_TOO_TALL),t.__ul.style.height=window.innerHeight-e-20+"px"):(ch.removeClass(t.domElement,Ih.CLASS_TOO_TALL),t.__ul.style.height="auto")}t.__resize_handle&&Ws.defer(function(){t.__resize_handle.style.height=t.__ul.offsetHeight+"px"}),t.__closeButton&&(t.__closeButton.style.width=t.width+"px")},onResizeDebounced:Ws.debounce(function(){this.onResize()},50),remember:function(){if(Ws.isUndefined(Rh)&&((Rh=new Ah).domElement.innerHTML='<div id="dg-save" class="dg dialogue">\n\n  Here\'s the new load parameter for your <code>GUI</code>\'s constructor:\n\n  <textarea id="dg-new-constructor"></textarea>\n\n  <div id="dg-save-locally">\n\n    <input id="dg-local-storage" type="checkbox"/> Automatically save\n    values to <code>localStorage</code> on exit.\n\n    <div id="dg-local-explain">The values saved to <code>localStorage</code> will\n      override those passed to <code>dat.GUI</code>\'s constructor. This makes it\n      easier to work incrementally, but <code>localStorage</code> is fragile,\n      and your friends may not see the same values you do.\n\n    </div>\n\n  </div>\n\n</div>'),this.parent)throw new Error("You can only call remember on a top level GUI.");var t=this;Ws.each(Array.prototype.slice.call(arguments),function(e){0===t.__rememberedObjects.length&&function(t){var e=t.__save_row=document.createElement("li");ch.addClass(t.domElement,"has-save"),t.__ul.insertBefore(e,t.__ul.firstChild),ch.addClass(e,"save-row");var r=document.createElement("span");r.innerHTML="&nbsp;",ch.addClass(r,"button gears");var n=document.createElement("span");n.innerHTML="Save",ch.addClass(n,"button"),ch.addClass(n,"save");var i=document.createElement("span");i.innerHTML="New",ch.addClass(i,"button"),ch.addClass(i,"save-as");var o=document.createElement("span");o.innerHTML="Revert",ch.addClass(o,"button"),ch.addClass(o,"revert");var a=t.__preset_select=document.createElement("select");t.load&&t.load.remembered?Ws.each(t.load.remembered,function(e,r){jh(t,r,r===t.preset)}):jh(t,Mh,!1);if(ch.bind(a,"change",function(){for(var e=0;e<t.__preset_select.length;e++)t.__preset_select[e].innerHTML=t.__preset_select[e].value;t.preset=this.value}),e.appendChild(a),e.appendChild(r),e.appendChild(n),e.appendChild(i),e.appendChild(o),Ph){var s=document.getElementById("dg-local-explain"),h=document.getElementById("dg-local-storage"),u=document.getElementById("dg-save-locally");u.style.display="block","true"===localStorage.getItem(Hh(t,"isLocal"))&&h.setAttribute("checked","checked"),Gh(t,s),ch.bind(h,"change",function(){t.useLocalStorage=!t.useLocalStorage,Gh(t,s)})}var l=document.getElementById("dg-new-constructor");ch.bind(l,"keydown",function(t){!t.metaKey||67!==t.which&&67!==t.keyCode||Rh.hide()}),ch.bind(r,"click",function(){l.innerHTML=JSON.stringify(t.getSaveObject(),void 0,2),Rh.show(),l.focus(),l.select()}),ch.bind(n,"click",function(){t.save()}),ch.bind(i,"click",function(){var e=prompt("Enter a new preset name.");e&&t.saveAs(e)}),ch.bind(o,"click",function(){t.revert()})}(t),-1===t.__rememberedObjects.indexOf(e)&&t.__rememberedObjects.push(e)}),this.autoPlace&&Wh(this,this.width)},getRoot:function(){for(var t=this;t.parent;)t=t.parent;return t},getSaveObject:function(){var t=this.load;return t.closed=this.closed,this.__rememberedObjects.length>0&&(t.preset=this.preset,t.remembered||(t.remembered={}),t.remembered[this.preset]=Zh(this)),t.folders={},Ws.each(this.__folders,function(e,r){t.folders[r]=e.getSaveObject()}),t},save:function(){this.load.remembered||(this.load.remembered={}),this.load.remembered[this.preset]=Zh(this),Bh(this,!1),this.saveToLocalStorageIfPossible()},saveAs:function(t){this.load.remembered||(this.load.remembered={},this.load.remembered[Mh]=Zh(this,!0)),this.load.remembered[t]=Zh(this),this.preset=t,jh(this,t,!0),this.saveToLocalStorageIfPossible()},revert:function(t){Ws.each(this.__controllers,function(e){this.getRoot().load.remembered?zh(t||this.getRoot(),e):e.setValue(e.initialValue),e.__onFinishChange&&e.__onFinishChange.call(e,e.getValue())},this),Ws.each(this.__folders,function(t){t.revert(t)}),t||Bh(this.getRoot(),!1)},listen:function(t){var e=0===this.__listening.length;this.__listening.push(t),e&&function t(e){0!==e.length&&Sh.call(window,function(){t(e)});Ws.each(e,function(t){t.updateDisplay()})}(this.__listening)},updateDisplay:function(){Ws.each(this.__controllers,function(t){t.updateDisplay()}),Ws.each(this.__folders,function(t){t.updateDisplay()})}});var Xh=Ih;var qh=function(t,e){for(var r=0,n=1/e,i=t;i>0;)r+=n*(i%e),i=Math.floor(i/e),n/=e;return r},Yh=bs.Pass;function Jh(t){for(var e=new Uint8Array(t*t*4),r=0,n=new j,i=0;i<t;i++)for(var o=0;o<t;o++)n.set(2*Math.random()-1,2*Math.random()-1,0).normalize(),e[r++]=255*(.5*n.x+.5),e[r++]=255*(.5*n.y+.5),e[r++]=0,e[r++]=255;return e}function Kh(t){return new br({pixels:Jh(t),wrapS:mr.REPEAT,wrapT:mr.REPEAT,width:t,height:t})}function Qh(t,e,r){var n=new Float32Array(3*t);e=e||0;for(var i=0;i<t;i++){var o=qh(i+e,2)*(r?1:2)*Math.PI,a=qh(i+e,3)*Math.PI,s=Math.random(),h=Math.cos(o)*Math.sin(a)*s,u=Math.cos(a)*s,l=Math.sin(o)*Math.sin(a)*s;n[3*i]=h,n[3*i+1]=u,n[3*i+2]=l}return n}function $h(t){t=t||{},this._ssaoPass=new Yh({fragment:en.source("car.ssao.estimate")}),this._blendPass=new Yh({fragment:en.source("car.temporalBlend")}),this._blurPass=new Yh({fragment:en.source("car.ssao.blur")}),this._framebuffer=new Or,this._ssaoTexture=new br,this._prevTexture=new br,this._currTexture=new br,this._blurTexture=new br,this._depthTex=t.depthTexture,this._normalTex=t.normalTexture,this._velocityTex=t.velocityTexture,this.setNoiseSize(4),this.setKernelSize(t.kernelSize||12),null!=t.radius&&this.setParameter("radius",t.radius),null!=t.power&&this.setParameter("power",t.power),this._normalTex||(this._ssaoPass.material.disableTexture("normalTex"),this._blurPass.material.disableTexture("normalTex")),this._depthTex||this._blurPass.material.disableTexture("depthTex"),this._blurPass.material.setUniform("normalTex",this._normalTex),this._blurPass.material.setUniform("depthTex",this._depthTex),this._temporalFilter=!0,this._frame=0}en.import("@export car.ssao.estimate\n#define SHADER_NAME SSAO\nuniform sampler2D depthTex;\nuniform sampler2D normalTex;\nuniform sampler2D noiseTex;\nuniform vec2 depthTexSize;\nuniform vec2 noiseTexSize;\nuniform mat4 projection;\nuniform mat4 projectionInv;\nuniform mat4 viewInverseTranspose;\nuniform vec3 kernel[KERNEL_SIZE];\nuniform float radius : 1;\nuniform float power : 1;\nuniform float bias: 0.01;\nuniform float intensity: 1.0;\nvarying vec2 v_Texcoord;\nfloat ssaoEstimator(in vec3 originPos, in vec3 N, in mat3 kernelBasis) {\n float occlusion = 0.0;\n for (int i = 0; i < KERNEL_SIZE; i++) {\n vec3 samplePos = kernel[i];\n#ifdef NORMALTEX_ENABLED\n samplePos = kernelBasis * samplePos;\n#endif\n samplePos = samplePos * radius + originPos;\n vec4 texCoord = projection * vec4(samplePos, 1.0);\n texCoord.xy /= texCoord.w;\n texCoord.xy = texCoord.xy * 0.5 + 0.5;\n vec4 depthTexel = texture2D(depthTex, texCoord.xy);\n float z = depthTexel.r * 2.0 - 1.0;\n#ifdef ALCHEMY\n vec4 projectedPos = vec4(texCoord.xy * 2.0 - 1.0, z, 1.0);\n vec4 p4 = projectionInv * projectedPos;\n p4.xyz /= p4.w;\n vec3 cDir = p4.xyz - originPos;\n float vv = dot(cDir, cDir);\n float vn = dot(cDir, N);\n float radius2 = radius * radius;\n vn = max(vn + p4.z * bias, 0.0);\n float f = max(radius2 - vv, 0.0) / radius2;\n occlusion += f * f * f * max(vn / (0.01 + vv), 0.0);\n#else\n if (projection[3][3] == 0.0) {\n z = projection[3][2] / (z * projection[2][3] - projection[2][2]);\n }\n else {\n z = (z - projection[3][2]) / projection[2][2];\n }\n float factor = step(samplePos.z, z - bias);\n float rangeCheck = smoothstep(0.0, 1.0, radius / abs(originPos.z - z));\n occlusion += rangeCheck * factor;\n#endif\n }\n#ifdef NORMALTEX_ENABLED\n occlusion = 1.0 - occlusion / float(KERNEL_SIZE);\n#else\n occlusion = 1.0 - clamp((occlusion / float(KERNEL_SIZE) - 0.6) * 2.5, 0.0, 1.0);\n#endif\n return pow(occlusion, power);\n}\nvoid main()\n{\n vec2 uv = v_Texcoord;\n vec4 depthTexel = texture2D(depthTex, uv);\n#ifdef NORMALTEX_ENABLED\n vec2 texelSize = 1.0 / depthTexSize;\n vec4 tex = texture2D(normalTex, uv);\n vec3 r = texture2D(normalTex, uv + vec2(texelSize.x, 0.0)).rgb;\n vec3 l = texture2D(normalTex, uv + vec2(-texelSize.x, 0.0)).rgb;\n vec3 t = texture2D(normalTex, uv + vec2(0.0, -texelSize.y)).rgb;\n vec3 b = texture2D(normalTex, uv + vec2(0.0, texelSize.y)).rgb;\n if (dot(tex.rgb, tex.rgb) == 0.0\n || dot(r, r) == 0.0 || dot(l, l) == 0.0\n || dot(t, t) == 0.0 || dot(b, b) == 0.0\n ) {\n gl_FragColor = vec4(1.0);\n return;\n }\n vec3 N = tex.rgb * 2.0 - 1.0;\n N = (viewInverseTranspose * vec4(N, 0.0)).xyz;\n vec2 noiseTexCoord = depthTexSize / vec2(noiseTexSize) * uv;\n vec3 rvec = texture2D(noiseTex, noiseTexCoord).rgb * 2.0 - 1.0;\n vec3 T = normalize(rvec - N * dot(rvec, N));\n vec3 BT = normalize(cross(N, T));\n mat3 kernelBasis = mat3(T, BT, N);\n#else\n if (depthTexel.r > 0.99999) {\n gl_FragColor = vec4(1.0);\n return;\n }\n mat3 kernelBasis;\n#endif\n float z = depthTexel.r * 2.0 - 1.0;\n vec4 projectedPos = vec4(uv * 2.0 - 1.0, z, 1.0);\n vec4 p4 = projectionInv * projectedPos;\n vec3 position = p4.xyz / p4.w;\n float ao = ssaoEstimator(position, N, kernelBasis);\n ao = clamp(1.0 - (1.0 - ao) * intensity, 0.0, 1.0);\n gl_FragColor = vec4(vec3(ao), 1.0);\n}\n@end\n@export car.ssao.blur\n#define SHADER_NAME SSAO_BLUR\nuniform sampler2D ssaoTexture;\n#ifdef NORMALTEX_ENABLED\nuniform sampler2D normalTex;\n#endif\nvarying vec2 v_Texcoord;\nuniform vec2 textureSize;\nuniform float blurSize : 1.0;\nuniform int direction: 0.0;\n#ifdef DEPTHTEX_ENABLED\nuniform sampler2D depthTex;\nuniform mat4 projection;\nuniform float depthRange : 0.05;\nfloat getLinearDepth(vec2 coord)\n{\n float depth = texture2D(depthTex, coord).r * 2.0 - 1.0;\n return projection[3][2] / (depth * projection[2][3] - projection[2][2]);\n}\n#endif\nvoid main()\n{\n float kernel[5];\n kernel[0] = 0.122581;\n kernel[1] = 0.233062;\n kernel[2] = 0.288713;\n kernel[3] = 0.233062;\n kernel[4] = 0.122581;\n vec2 off = vec2(0.0);\n if (direction == 0) {\n off[0] = blurSize / textureSize.x;\n }\n else {\n off[1] = blurSize / textureSize.y;\n }\n vec2 coord = v_Texcoord;\n float sum = 0.0;\n float weightAll = 0.0;\n#ifdef NORMALTEX_ENABLED\n vec3 centerNormal = texture2D(normalTex, v_Texcoord).rgb * 2.0 - 1.0;\n#endif\n#if defined(DEPTHTEX_ENABLED)\n float centerDepth = getLinearDepth(v_Texcoord);\n#endif\n for (int i = 0; i < 5; i++) {\n vec2 coord = clamp(v_Texcoord + vec2(float(i) - 2.0) * off, vec2(0.0), vec2(1.0));\n float w = kernel[i];\n#ifdef NORMALTEX_ENABLED\n vec3 normal = texture2D(normalTex, coord).rgb * 2.0 - 1.0;\n w *= clamp(dot(normal, centerNormal), 0.0, 1.0);\n#endif\n#ifdef DEPTHTEX_ENABLED\n float d = getLinearDepth(coord);\n w *= (1.0 - smoothstep(abs(centerDepth - d) / depthRange, 0.0, 1.0));\n#endif\n weightAll += w;\n sum += texture2D(ssaoTexture, coord).r * w;\n }\n gl_FragColor = vec4(vec3(sum / weightAll), 1.0);\n}\n@end\n"),$h.prototype.setDepthTexture=function(t){this._depthTex=t},$h.prototype.setNormalTexture=function(t){this._normalTex=t,this._ssaoPass.material[t?"enableTexture":"disableTexture"]("normalTex"),this.setKernelSize(this._kernelSize)},$h.prototype.update=function(t,e,r){var n=t.getWidth(),i=t.getHeight(),o=this._ssaoPass,a=this._blurPass,s=this._blendPass;this._frame++,o.setUniform("kernel",this._kernels[(this._temporalFilter?this._frame:r)%this._kernels.length]),o.setUniform("depthTex",this._depthTex),null!=this._normalTex&&o.setUniform("normalTex",this._normalTex),o.setUniform("depthTexSize",[this._depthTex.width,this._depthTex.height]);var h=new Ge;Ge.transpose(h,e.worldTransform),o.setUniform("projection",e.projectionMatrix.array),o.setUniform("projectionInv",e.invProjectionMatrix.array),o.setUniform("viewInverseTranspose",h.array);var u=this._ssaoTexture,l=this._blurTexture,c=this._prevTexture,f=this._currTexture;u.width=n,u.height=i,l.width=n,l.height=i,c.width=n,c.height=i,f.width=n,f.height=i,this._framebuffer.attach(u),this._framebuffer.bind(t),t.gl.clearColor(1,1,1,1),t.gl.clear(t.gl.COLOR_BUFFER_BIT),o.render(t),this._temporalFilter&&(this._framebuffer.attach(f),s.setUniform("prevTex",c),s.setUniform("currTex",u),s.setUniform("velocityTex",this._velocityTex),s.render(t)),a.setUniform("textureSize",[n,i]),a.setUniform("projection",e.projectionMatrix.array),this._framebuffer.attach(l),a.setUniform("direction",0),a.setUniform("ssaoTexture",this._temporalFilter?f:u),a.render(t),this._framebuffer.attach(u),a.setUniform("direction",1),a.setUniform("ssaoTexture",l),a.render(t),this._framebuffer.unbind(t);var d=t.clearColor;t.gl.clearColor(d[0],d[1],d[2],d[3]);var p=this._prevTexture;this._prevTexture=this._currTexture,this._currTexture=p},$h.prototype.getTargetTexture=function(){return this._ssaoTexture},$h.prototype.setParameter=function(t,e){"noiseTexSize"===t?this.setNoiseSize(e):"kernelSize"===t?this.setKernelSize(e):"intensity"===t?this._ssaoPass.material.set("intensity",e):"temporalFilter"===t?this._temporalFilter=e:this._ssaoPass.setUniform(t,e)},$h.prototype.setKernelSize=function(t){this._kernelSize=t,this._ssaoPass.material.define("fragment","KERNEL_SIZE",t),this._kernels=this._kernels||[];for(var e=0;e<30;e++)this._kernels[e]=Qh(t,e*t,!!this._normalTex)},$h.prototype.setNoiseSize=function(t){var e=this._ssaoPass.getUniform("noiseTex");e?(e.data=Jh(t),e.width=e.height=t,e.dirty()):(e=Kh(t),this._ssaoPass.setUniform("noiseTex",Kh(t))),this._ssaoPass.setUniform("noiseTexSize",[t,t])},$h.prototype.dispose=function(t){this._blurTexture.dispose(t),this._ssaoTexture.dispose(t),this._prevTexture.dispose(t),this._currTexture.dispose(t)},$h.prototype.isFinished=function(t){return t>30};var tu=$h,eu=bs.Pass,ru=Ss.cubemap;function nu(t){t=t||{},this._ssrPass=new eu({fragment:en.source("car.ssr.main"),clearColor:[0,0,0,0]}),this._blurPass1=new eu({fragment:en.source("car.ssr.blur"),clearColor:[0,0,0,0]}),this._blurPass2=new eu({fragment:en.source("car.ssr.blur"),clearColor:[0,0,0,0]}),this._blendPass=new eu({fragment:en.source("clay.compositor.blend")}),this._blendPass.material.disableTexturesAll(),this._blendPass.material.enableTexture(["texture1","texture2"]),this._ssrPass.setUniform("gBufferTexture1",t.normalTexture),this._ssrPass.setUniform("gBufferTexture2",t.depthTexture),this._ssrPass.setUniform("gBufferTexture3",t.albedoTexture),this._blurPass1.setUniform("gBufferTexture1",t.normalTexture),this._blurPass1.setUniform("gBufferTexture2",t.depthTexture),this._blurPass2.setUniform("gBufferTexture1",t.normalTexture),this._blurPass2.setUniform("gBufferTexture2",t.depthTexture),this._blurPass2.material.define("fragment","VERTICAL"),this._blurPass2.material.define("fragment","BLEND"),this._ssrTexture=new br({type:mr.HALF_FLOAT}),this._texture2=new br({type:mr.HALF_FLOAT}),this._texture3=new br({type:mr.HALF_FLOAT}),this._prevTexture=new br({type:mr.HALF_FLOAT}),this._currentTexture=new br({type:mr.HALF_FLOAT}),this._frameBuffer=new Or({depthBuffer:!1}),this._normalDistribution=null,this._totalSamples=256,this._samplePerFrame=4,this._ssrPass.material.define("fragment","SAMPLE_PER_FRAME",this._samplePerFrame),this._ssrPass.material.define("fragment","TOTAL_SAMPLES",this._totalSamples),this._downScale=1}en.import("@export car.ssr.main\n#define SHADER_NAME SSR\n#define MAX_ITERATION 20;\n#define SAMPLE_PER_FRAME 5;\n#define TOTAL_SAMPLES 128;\nuniform sampler2D sourceTexture;\nuniform sampler2D gBufferTexture1;\nuniform sampler2D gBufferTexture2;\nuniform sampler2D gBufferTexture3;\nuniform samplerCube specularCubemap;\nuniform sampler2D brdfLookup;\nuniform float specularIntensity: 1;\nuniform mat4 projection;\nuniform mat4 projectionInv;\nuniform mat4 toViewSpace;\nuniform mat4 toWorldSpace;\nuniform float maxRayDistance: 200;\nuniform float pixelStride: 16;\nuniform float pixelStrideZCutoff: 50;\nuniform float screenEdgeFadeStart: 0.9;\nuniform float eyeFadeStart : 0.2;uniform float eyeFadeEnd: 0.8;\nuniform float minGlossiness: 0.2;uniform float zThicknessThreshold: 1;\nuniform float nearZ;\nuniform vec2 viewportSize : VIEWPORT_SIZE;\nuniform float jitterOffset: 0;\nvarying vec2 v_Texcoord;\n#ifdef DEPTH_DECODE\n@import clay.util.decode_float\n#endif\n#ifdef PHYSICALLY_CORRECT\nuniform sampler2D normalDistribution;\nuniform float sampleOffset: 0;\nuniform vec2 normalDistributionSize;\nvec3 transformNormal(vec3 H, vec3 N) {\n vec3 upVector = N.y > 0.999 ? vec3(1.0, 0.0, 0.0) : vec3(0.0, 1.0, 0.0);\n vec3 tangentX = normalize(cross(N, upVector));\n vec3 tangentZ = cross(N, tangentX);\n return normalize(tangentX * H.x + N * H.y + tangentZ * H.z);\n}\nvec3 importanceSampleNormalGGX(float i, float roughness, vec3 N) {\n float p = fract((i + sampleOffset) / float(TOTAL_SAMPLES));\n vec3 H = texture2D(normalDistribution,vec2(roughness, p)).rgb;\n return transformNormal(H, N);\n}\nfloat G_Smith(float g, float ndv, float ndl) {\n float roughness = 1.0 - g;\n float k = roughness * roughness / 2.0;\n float G1V = ndv / (ndv * (1.0 - k) + k);\n float G1L = ndl / (ndl * (1.0 - k) + k);\n return G1L * G1V;\n}\nvec3 F_Schlick(float ndv, vec3 spec) {\n return spec + (1.0 - spec) * pow(1.0 - ndv, 5.0);\n}\n#endif\nfloat fetchDepth(sampler2D depthTexture, vec2 uv)\n{\n vec4 depthTexel = texture2D(depthTexture, uv);\n return depthTexel.r * 2.0 - 1.0;\n}\nfloat linearDepth(float depth)\n{\n if (projection[3][3] == 0.0) {\n return projection[3][2] / (depth * projection[2][3] - projection[2][2]);\n }\n else {\n return (depth - projection[3][2]) / projection[2][2];\n }\n}\nbool rayIntersectDepth(float rayZNear, float rayZFar, vec2 hitPixel)\n{\n if (rayZFar > rayZNear)\n {\n float t = rayZFar; rayZFar = rayZNear; rayZNear = t;\n }\n float cameraZ = linearDepth(fetchDepth(gBufferTexture2, hitPixel));\n return rayZFar <= cameraZ && rayZNear >= cameraZ - zThicknessThreshold;\n}\nbool traceScreenSpaceRay(\n vec3 rayOrigin, vec3 rayDir, float jitter,\n out vec2 hitPixel, out vec3 hitPoint, out float iterationCount\n)\n{\n float rayLength = ((rayOrigin.z + rayDir.z * maxRayDistance) > -nearZ)\n ? (-nearZ - rayOrigin.z) / rayDir.z : maxRayDistance;\n vec3 rayEnd = rayOrigin + rayDir * rayLength;\n vec4 H0 = projection * vec4(rayOrigin, 1.0);\n vec4 H1 = projection * vec4(rayEnd, 1.0);\n float k0 = 1.0 / H0.w, k1 = 1.0 / H1.w;\n vec3 Q0 = rayOrigin * k0, Q1 = rayEnd * k1;\n vec2 P0 = (H0.xy * k0 * 0.5 + 0.5) * viewportSize;\n vec2 P1 = (H1.xy * k1 * 0.5 + 0.5) * viewportSize;\n P1 += dot(P1 - P0, P1 - P0) < 0.0001 ? 0.01 : 0.0;\n vec2 delta = P1 - P0;\n bool permute = false;\n if (abs(delta.x) < abs(delta.y)) {\n permute = true;\n delta = delta.yx;\n P0 = P0.yx;\n P1 = P1.yx;\n }\n float stepDir = sign(delta.x);\n float invdx = stepDir / delta.x;\n vec3 dQ = (Q1 - Q0) * invdx;\n float dk = (k1 - k0) * invdx;\n vec2 dP = vec2(stepDir, delta.y * invdx);\n float strideScaler = 1.0 - min(1.0, -rayOrigin.z / pixelStrideZCutoff);\n float pixStride = 1.0 + strideScaler * pixelStride;\n dP *= pixStride; dQ *= pixStride; dk *= pixStride;\n vec4 pqk = vec4(P0, Q0.z, k0);\n vec4 dPQK = vec4(dP, dQ.z, dk);\n pqk += dPQK * jitter;\n float rayZFar = (dPQK.z * 0.5 + pqk.z) / (dPQK.w * 0.5 + pqk.w);\n float rayZNear;\n bool intersect = false;\n vec2 texelSize = 1.0 / viewportSize;\n iterationCount = 0.0;\n for (int i = 0; i < MAX_ITERATION; i++)\n {\n pqk += dPQK;\n rayZNear = rayZFar;\n rayZFar = (dPQK.z * 0.5 + pqk.z) / (dPQK.w * 0.5 + pqk.w);\n hitPixel = permute ? pqk.yx : pqk.xy;\n hitPixel *= texelSize;\n intersect = rayIntersectDepth(rayZNear, rayZFar, hitPixel);\n iterationCount += 1.0;\n dPQK *= 1.2;\n if (intersect) {\n break;\n }\n }\n Q0.xy += dQ.xy * iterationCount;\n Q0.z = pqk.z;\n hitPoint = Q0 / pqk.w;\n return intersect;\n}\nfloat calculateAlpha(\n float iterationCount, float reflectivity,\n vec2 hitPixel, vec3 hitPoint, float dist, vec3 rayDir\n)\n{\n float alpha = clamp(reflectivity, 0.0, 1.0);\n alpha *= 1.0 - (iterationCount / float(MAX_ITERATION));\n vec2 hitPixelNDC = hitPixel * 2.0 - 1.0;\n float maxDimension = min(1.0, max(abs(hitPixelNDC.x), abs(hitPixelNDC.y)));\n alpha *= 1.0 - max(0.0, maxDimension - screenEdgeFadeStart) / (1.0 - screenEdgeFadeStart);\n float _eyeFadeStart = eyeFadeStart;\n float _eyeFadeEnd = eyeFadeEnd;\n if (_eyeFadeStart > _eyeFadeEnd) {\n float tmp = _eyeFadeEnd;\n _eyeFadeEnd = _eyeFadeStart;\n _eyeFadeStart = tmp;\n }\n float eyeDir = clamp(rayDir.z, _eyeFadeStart, _eyeFadeEnd);\n alpha *= 1.0 - (eyeDir - _eyeFadeStart) / (_eyeFadeEnd - _eyeFadeStart);\n alpha *= 1.0 - clamp(dist / maxRayDistance, 0.0, 1.0);\n return alpha;\n}\n@import clay.util.rand\n@import clay.util.rgbm\nvoid main()\n{\n vec4 normalAndGloss = texture2D(gBufferTexture1, v_Texcoord);\n if (dot(normalAndGloss.rgb, vec3(1.0)) == 0.0) {\n discard;\n }\n float g = normalAndGloss.a;\n#if !defined(PHYSICALLY_CORRECT)\n if (g <= minGlossiness) {\n discard;\n }\n#endif\n float reflectivity = (g - minGlossiness) / (1.0 - minGlossiness);\n vec3 N = normalize(normalAndGloss.rgb * 2.0 - 1.0);\n N = normalize((toViewSpace * vec4(N, 0.0)).xyz);\n vec4 projectedPos = vec4(v_Texcoord * 2.0 - 1.0, fetchDepth(gBufferTexture2, v_Texcoord), 1.0);\n vec4 pos = projectionInv * projectedPos;\n vec3 rayOrigin = pos.xyz / pos.w;\n vec3 V = -normalize(rayOrigin);\n float ndv = clamp(dot(N, V), 0.0, 1.0);\n float iterationCount;\n float jitter = rand(fract(v_Texcoord + jitterOffset));\n vec4 albedoMetalness = texture2D(gBufferTexture3, v_Texcoord);\n vec3 albedo = albedoMetalness.rgb;\n float m = albedoMetalness.a;\n vec3 diffuseColor = albedo * (1.0 - m);\n vec3 spec = mix(vec3(0.04), albedo, m);\n#ifdef PHYSICALLY_CORRECT\n vec4 color = vec4(vec3(0.0), 1.0);\n float jitter2 = rand(fract(v_Texcoord)) * float(TOTAL_SAMPLES);\n for (int i = 0; i < SAMPLE_PER_FRAME; i++) {\n vec3 H = importanceSampleNormalGGX(float(i) + jitter2, 1.0 - g, N);\n vec3 rayDir = normalize(reflect(-V, H));\n#else\n vec3 rayDir = normalize(reflect(-V, N));\n#endif\n vec2 hitPixel;\n vec3 hitPoint;\n bool intersect = traceScreenSpaceRay(rayOrigin, rayDir, jitter, hitPixel, hitPoint, iterationCount);\n float dist = distance(rayOrigin, hitPoint);\n vec3 hitNormal = texture2D(gBufferTexture1, hitPixel).rgb * 2.0 - 1.0;\n hitNormal = normalize((toViewSpace * vec4(hitNormal, 0.0)).xyz);\n#ifdef PHYSICALLY_CORRECT\n float ndl = clamp(dot(N, rayDir), 0.0, 1.0);\n float vdh = clamp(dot(V, H), 0.0, 1.0);\n float ndh = clamp(dot(N, H), 0.0, 1.0);\n vec3 litTexel = vec3(0.0);\n if (dot(hitNormal, rayDir) < 0.0 && intersect) {\n litTexel = texture2D(sourceTexture, hitPixel).rgb;\n litTexel *= pow(clamp(1.0 - dist / 200.0, 0.0, 1.0), 3.0);\n }\n else {\n#ifdef SPECULARCUBEMAP_ENABLED\n vec3 rayDirW = normalize(toWorldSpace * vec4(rayDir, 0.0)).rgb;\n litTexel = RGBMDecode(textureCubeLodEXT(specularCubemap, rayDirW, 0.0), 8.12).rgb * specularIntensity;\n#endif\n }\n color.rgb += ndl * litTexel * (\n F_Schlick(ndl, spec) * G_Smith(g, ndv, ndl) * vdh / (ndh * ndv + 0.001)\n );\n }\n color.rgb /= float(SAMPLE_PER_FRAME);\n#else\n#if !defined(SPECULARCUBEMAP_ENABLED)\n if (dot(hitNormal, rayDir) >= 0.0) {\n discard;\n }\n if (!intersect) {\n discard;\n }\n#endif\n float alpha = clamp(calculateAlpha(iterationCount, reflectivity, hitPixel, hitPoint, dist, rayDir), 0.0, 1.0);\n vec4 color = texture2D(sourceTexture, hitPixel);\n color.rgb *= alpha;\n#ifdef SPECULARCUBEMAP_ENABLED\n vec3 rayDirW = normalize(toWorldSpace * vec4(rayDir, 0.0)).rgb;\n alpha = alpha * (intersect ? 1.0 : 0.0);\n float bias = (1.0 - g) * 5.0;\n vec2 brdfParam2 = texture2D(brdfLookup, vec2(1.0 - g, ndv)).xy;\n color.rgb += (1.0 - alpha)\n * RGBMDecode(textureCubeLodEXT(specularCubemap, rayDirW, bias), 8.12).rgb\n * (spec * brdfParam2.x + brdfParam2.y)\n * specularIntensity;\n#endif\n#endif\n gl_FragColor = encodeHDR(color);\n}\n@end\n@export car.ssr.blur\nuniform sampler2D texture;\nuniform sampler2D gBufferTexture1;\nuniform sampler2D gBufferTexture2;\nuniform mat4 projection;\nuniform float depthRange : 0.05;\nvarying vec2 v_Texcoord;\nuniform vec2 textureSize;\nuniform float blurSize : 1.0;\n#ifdef BLEND\n #ifdef SSAOTEX_ENABLED\nuniform sampler2D ssaoTex;\n #endif\nuniform sampler2D sourceTexture;\n#endif\nfloat getLinearDepth(vec2 coord)\n{\n float depth = texture2D(gBufferTexture2, coord).r * 2.0 - 1.0;\n return projection[3][2] / (depth * projection[2][3] - projection[2][2]);\n}\n@import clay.util.rgbm\nvoid main()\n{\n @import clay.compositor.kernel.gaussian_9\n vec4 centerNTexel = texture2D(gBufferTexture1, v_Texcoord);\n float g = centerNTexel.a;\n float maxBlurSize = clamp(1.0 - g, 0.0, 1.0) * blurSize;\n#ifdef VERTICAL\n vec2 off = vec2(0.0, maxBlurSize / textureSize.y);\n#else\n vec2 off = vec2(maxBlurSize / textureSize.x, 0.0);\n#endif\n vec2 coord = v_Texcoord;\n vec4 sum = vec4(0.0);\n float weightAll = 0.0;\n vec3 cN = centerNTexel.rgb * 2.0 - 1.0;\n float cD = getLinearDepth(v_Texcoord);\n for (int i = 0; i < 9; i++) {\n vec2 coord = clamp((float(i) - 4.0) * off + v_Texcoord, vec2(0.0), vec2(1.0));\n float w = gaussianKernel[i]\n * clamp(dot(cN, texture2D(gBufferTexture1, coord).rgb * 2.0 - 1.0), 0.0, 1.0);\n float d = getLinearDepth(coord);\n w *= (1.0 - smoothstep(abs(cD - d) / depthRange, 0.0, 1.0));\n weightAll += w;\n sum += decodeHDR(texture2D(texture, coord)) * w;\n }\n#ifdef BLEND\n float aoFactor = 1.0;\n #ifdef SSAOTEX_ENABLED\n aoFactor = texture2D(ssaoTex, v_Texcoord).r;\n #endif\n gl_FragColor = encodeHDR(\n sum / weightAll * aoFactor + decodeHDR(texture2D(sourceTexture, v_Texcoord))\n );\n#else\n gl_FragColor = encodeHDR(sum / weightAll);\n#endif\n}\n@end"),nu.prototype.setAmbientCubemap=function(t,e,r){this._ssrPass.material.set("specularCubemap",t),this._ssrPass.material.set("brdfLookup",e),this._ssrPass.material.set("specularIntensity",r);var n=t&&r;this._ssrPass.material[n?"enableTexture":"disableTexture"]("specularCubemap")},nu.prototype.update=function(t,e,r,n,i){var o=t.getWidth(),a=t.getHeight(),s=this._ssrTexture,h=this._texture2,u=this._texture3;s.width=this._prevTexture.width=this._currentTexture.width=o/this._downScale,s.height=this._prevTexture.height=this._currentTexture.height=a/this._downScale,h.width=u.width=o,h.height=u.height=a;var l=this._frameBuffer,c=this._ssrPass,f=this._blurPass1,d=this._blurPass2,p=this._blendPass,m=new Ge,g=new Ge;Ge.transpose(m,e.worldTransform),Ge.transpose(g,e.viewMatrix),c.setUniform("sourceTexture",n),c.setUniform("projection",e.projectionMatrix.array),c.setUniform("projectionInv",e.invProjectionMatrix.array),c.setUniform("toViewSpace",m.array),c.setUniform("toWorldSpace",g.array),c.setUniform("nearZ",e.near);var _=i/this._totalSamples*this._samplePerFrame;if(c.setUniform("jitterOffset",_),c.setUniform("sampleOffset",i*this._samplePerFrame),f.setUniform("textureSize",[s.width,s.height]),d.setUniform("textureSize",[o,a]),d.setUniform("sourceTexture",r),f.setUniform("projection",e.projectionMatrix.array),d.setUniform("projection",e.projectionMatrix.array),l.attach(s),l.bind(t),c.render(t),this._physicallyCorrect&&(l.attach(this._currentTexture),p.setUniform("texture1",this._prevTexture),p.setUniform("texture2",s),p.material.set({weight1:i>=1?.95:0,weight2:i>=1?.05:1}),p.render(t)),l.attach(h),f.setUniform("texture",this._physicallyCorrect?this._currentTexture:s),f.render(t),l.attach(u),d.setUniform("texture",h),d.render(t),l.unbind(t),this._physicallyCorrect){var y=this._prevTexture;this._prevTexture=this._currentTexture,this._currentTexture=y}},nu.prototype.getTargetTexture=function(){return this._texture3},nu.prototype.setParameter=function(t,e){"maxIteration"===t?this._ssrPass.material.define("fragment","MAX_ITERATION",e):this._ssrPass.setUniform(t,e)},nu.prototype.setPhysicallyCorrect=function(t){t?(this._normalDistribution||(this._normalDistribution=ru.generateNormalDistribution(64,this._totalSamples)),this._ssrPass.material.define("fragment","PHYSICALLY_CORRECT"),this._ssrPass.material.set("normalDistribution",this._normalDistribution),this._ssrPass.material.set("normalDistributionSize",[64,this._totalSamples])):this._ssrPass.material.undefine("fragment","PHYSICALLY_CORRECT"),this._physicallyCorrect=t},nu.prototype.setSSAOTexture=function(t){var e=this._blurPass2;t?(e.material.enableTexture("ssaoTex"),e.material.set("ssaoTex",t)):e.material.disableTexture("ssaoTex")},nu.prototype.isFinished=function(t){return!this._physicallyCorrect||t>this._totalSamples/this._samplePerFrame},nu.prototype.dispose=function(t){this._ssrTexture.dispose(t),this._texture2.dispose(t),this._texture3.dispose(t),this._prevTexture.dispose(t),this._currentTexture.dispose(t),this._frameBuffer.dispose(t)};var iu=nu,ou=[.014096,-.022658,.055991,.004413,-.020612,-.025574,.019188,0,-.038708,.006957,0,.049223,-.021449,.040468,.018301,.099929,.013015,.050223,.054845,.114689,.042178,.038585,.085769,.09708,.057972,.019812,.102517,.068674,.063647,.005252,.108535,.046643,.064754,0,.109709,.038697,.063647,.005252,.108535,.046643,.057972,.019812,.102517,.068674,.042178,.038585,.085769,.09708,.013015,.050223,.054845,.114689,-.021449,.040468,.018301,.099929,-.038708,.006957,0,.049223,-.020612,-.025574,.019188,0,.014096,-.022658,.055991,.00441],au=[115e-6,.009116,0,.051147,.005324,.013416,.009311,.075276,.013753,.016519,.024376,.092685,.0247,.017215,.04394,.096591,.036693,.015064,.065375,.084521,.047976,.010684,.085539,.059948,.057015,.00557,.101695,.031254,.062782,.001529,.112002,.008578,.064754,0,.115526,0,.062782,.001529,.112002,.008578,.057015,.00557,.101695,.031254,.047976,.010684,.085539,.059948,.036693,.015064,.065375,.084521,.0247,.017215,.04394,.096591,.013753,.016519,.024376,.092685,.005324,.013416,.009311,.075276,115e-6,.009116,0,.05114],su={color:{parameters:{width:"expr(width / 2.0 * 1.0)",height:"expr(height / 2.0 * 1.0)",type:"HALF_FLOAT"}}},hu={textureSize:"expr( [width / 2.0 * 1.0, height / 2.0 * 1.0] )"},uu={type:"compositor",nodes:[{name:"source",type:"texture",outputs:{color:{}}},{name:"source_half",shader:"#source(clay.compositor.downsample)",inputs:{texture:"source"},outputs:{color:{parameters:{width:"expr(width * 1.0 / 2)",height:"expr(height * 1.0 / 2)",type:"HALF_FLOAT"}}},parameters:{textureSize:"expr( [width * 1.0, height * 1.0] )"}},{name:"bright",shader:"#source(clay.compositor.bright)",inputs:{texture:"source_half"},outputs:{color:{parameters:{width:"expr(width * 1.0 / 2)",height:"expr(height * 1.0 / 2)",type:"HALF_FLOAT"}}},parameters:{threshold:2,scale:4,textureSize:"expr([width * 1.0 / 2, height / 2])"}},{name:"bright_downsample_4",shader:"#source(clay.compositor.downsample)",inputs:{texture:"bright"},outputs:{color:{parameters:{width:"expr(width * 1.0 / 4)",height:"expr(height * 1.0 / 4)",type:"HALF_FLOAT"}}},parameters:{textureSize:"expr( [width * 1.0 / 2, height / 2] )"}},{name:"bright_downsample_8",shader:"#source(clay.compositor.downsample)",inputs:{texture:"bright_downsample_4"},outputs:{color:{parameters:{width:"expr(width * 1.0 / 8)",height:"expr(height * 1.0 / 8)",type:"HALF_FLOAT"}}},parameters:{textureSize:"expr( [width * 1.0 / 4, height / 4] )"}},{name:"bright_downsample_16",shader:"#source(clay.compositor.downsample)",inputs:{texture:"bright_downsample_8"},outputs:{color:{parameters:{width:"expr(width * 1.0 / 16)",height:"expr(height * 1.0 / 16)",type:"HALF_FLOAT"}}},parameters:{textureSize:"expr( [width * 1.0 / 8, height / 8] )"}},{name:"bright_downsample_32",shader:"#source(clay.compositor.downsample)",inputs:{texture:"bright_downsample_16"},outputs:{color:{parameters:{width:"expr(width * 1.0 / 32)",height:"expr(height * 1.0 / 32)",type:"HALF_FLOAT"}}},parameters:{textureSize:"expr( [width * 1.0 / 16, height / 16] )"}},{name:"bright_upsample_16_blur_h",shader:"#source(clay.compositor.gaussian_blur)",inputs:{texture:"bright_downsample_32"},outputs:{color:{parameters:{width:"expr(width * 1.0 / 16)",height:"expr(height * 1.0 / 16)",type:"HALF_FLOAT"}}},parameters:{blurSize:1,blurDir:0,textureSize:"expr( [width * 1.0 / 32, height / 32] )"}},{name:"bright_upsample_16_blur_v",shader:"#source(clay.compositor.gaussian_blur)",inputs:{texture:"bright_upsample_16_blur_h"},outputs:{color:{parameters:{width:"expr(width * 1.0 / 16)",height:"expr(height * 1.0 / 16)",type:"HALF_FLOAT"}}},parameters:{blurSize:1,blurDir:1,textureSize:"expr( [width * 1.0 / 32, height * 1.0 / 32] )"}},{name:"bright_upsample_8_blur_h",shader:"#source(clay.compositor.gaussian_blur)",inputs:{texture:"bright_downsample_16"},outputs:{color:{parameters:{width:"expr(width * 1.0 / 8)",height:"expr(height * 1.0 / 8)",type:"HALF_FLOAT"}}},parameters:{blurSize:1,blurDir:0,textureSize:"expr( [width * 1.0 / 16, height * 1.0 / 16] )"}},{name:"bright_upsample_8_blur_v",shader:"#source(clay.compositor.gaussian_blur)",inputs:{texture:"bright_upsample_8_blur_h"},outputs:{color:{parameters:{width:"expr(width * 1.0 / 8)",height:"expr(height * 1.0 / 8)",type:"HALF_FLOAT"}}},parameters:{blurSize:1,blurDir:1,textureSize:"expr( [width * 1.0 / 16, height * 1.0 / 16] )"}},{name:"bright_upsample_8_blend",shader:"#source(clay.compositor.blend)",inputs:{texture1:"bright_upsample_8_blur_v",texture2:"bright_upsample_16_blur_v"},outputs:{color:{parameters:{width:"expr(width * 1.0 / 8)",height:"expr(height * 1.0 / 8)",type:"HALF_FLOAT"}}},parameters:{weight1:.3,weight2:.7}},{name:"bright_upsample_4_blur_h",shader:"#source(clay.compositor.gaussian_blur)",inputs:{texture:"bright_downsample_8"},outputs:{color:{parameters:{width:"expr(width * 1.0 / 4)",height:"expr(height * 1.0 / 4)",type:"HALF_FLOAT"}}},parameters:{blurSize:1,blurDir:0,textureSize:"expr( [width * 1.0 / 8, height * 1.0 / 8] )"}},{name:"bright_upsample_4_blur_v",shader:"#source(clay.compositor.gaussian_blur)",inputs:{texture:"bright_upsample_4_blur_h"},outputs:{color:{parameters:{width:"expr(width * 1.0 / 4)",height:"expr(height * 1.0 / 4)",type:"HALF_FLOAT"}}},parameters:{blurSize:1,blurDir:1,textureSize:"expr( [width * 1.0 / 8, height * 1.0 / 8] )"}},{name:"bright_upsample_4_blend",shader:"#source(clay.compositor.blend)",inputs:{texture1:"bright_upsample_4_blur_v",texture2:"bright_upsample_8_blend"},outputs:{color:{parameters:{width:"expr(width * 1.0 / 4)",height:"expr(height * 1.0 / 4)",type:"HALF_FLOAT"}}},parameters:{weight1:.3,weight2:.7}},{name:"bright_upsample_2_blur_h",shader:"#source(clay.compositor.gaussian_blur)",inputs:{texture:"bright_downsample_4"},outputs:{color:{parameters:{width:"expr(width * 1.0 / 2)",height:"expr(height * 1.0 / 2)",type:"HALF_FLOAT"}}},parameters:{blurSize:1,blurDir:0,textureSize:"expr( [width * 1.0 / 4, height * 1.0 / 4] )"}},{name:"bright_upsample_2_blur_v",shader:"#source(clay.compositor.gaussian_blur)",inputs:{texture:"bright_upsample_2_blur_h"},outputs:{color:{parameters:{width:"expr(width * 1.0 / 2)",height:"expr(height * 1.0 / 2)",type:"HALF_FLOAT"}}},parameters:{blurSize:1,blurDir:1,textureSize:"expr( [width * 1.0 / 4, height * 1.0 / 4] )"}},{name:"bright_upsample_2_blend",shader:"#source(clay.compositor.blend)",inputs:{texture1:"bright_upsample_2_blur_v",texture2:"bright_upsample_4_blend"},outputs:{color:{parameters:{width:"expr(width * 1.0 / 2)",height:"expr(height * 1.0 / 2)",type:"HALF_FLOAT"}}},parameters:{weight1:.3,weight2:.7}},{name:"bright_upsample_full_blur_h",shader:"#source(clay.compositor.gaussian_blur)",inputs:{texture:"bright"},outputs:{color:{parameters:{width:"expr(width * 1.0)",height:"expr(height * 1.0)",type:"HALF_FLOAT"}}},parameters:{blurSize:1,blurDir:0,textureSize:"expr( [width * 1.0 / 2, height * 1.0 / 2] )"}},{name:"bright_upsample_full_blur_v",shader:"#source(clay.compositor.gaussian_blur)",inputs:{texture:"bright_upsample_full_blur_h"},outputs:{color:{parameters:{width:"expr(width * 1.0)",height:"expr(height * 1.0)",type:"HALF_FLOAT"}}},parameters:{blurSize:1,blurDir:1,textureSize:"expr( [width * 1.0 / 2, height * 1.0 / 2] )"}},{name:"bloom_composite",shader:"#source(clay.compositor.blend)",inputs:{texture1:"bright_upsample_full_blur_v",texture2:"bright_upsample_2_blend"},outputs:{color:{parameters:{width:"expr(width * 1.0)",height:"expr(height * 1.0)",type:"HALF_FLOAT"}}},parameters:{weight1:.3,weight2:.7}},{name:"coc",shader:"#source(car.dof.coc)",outputs:{color:{parameters:{width:"expr(width * 1.0)",height:"expr(height * 1.0)",type:"HALF_FLOAT"}}}},{name:"coc_dilate_1",shader:"#source(car.dof.dilateCoc)",inputs:{cocTex:"coc"},outputs:{color:{parameters:{width:"expr(width * 1.0)",height:"expr(height * 1.0)",type:"HALF_FLOAT"}}},parameters:{textureSize:"expr( [width / 1.0 * 1.0, height / 1.0 * 1.0] )"}},{name:"coc_dilate_2",shader:"#source(car.dof.dilateCoc)",inputs:{cocTex:"coc_dilate_1"},outputs:{color:{parameters:{width:"expr(width * 1.0)",height:"expr(height * 1.0)",type:"HALF_FLOAT"}}},parameters:{textureSize:"expr( [width / 1.0 * 1.0, height / 1.0 * 1.0] )"},defines:{VERTICAL:null}},{name:"dof_separate_far",shader:"#source(car.dof.separate)",inputs:{mainTex:"source",cocTex:"coc"},outputs:su,defines:{FARFIELD:null}},{name:"dof_separate_near",shader:"#source(car.dof.separate)",inputs:{mainTex:"source",cocTex:"coc"},outputs:su},{name:"dof_blur_far_1",shader:"#source(car.dof.blur)",inputs:{mainTex:"dof_separate_far",cocTex:"coc"},outputs:su,parameters:hu,defines:{R_PASS:null,FARFIELD:null}},{name:"dof_blur_far_2",shader:"#source(car.dof.blur)",inputs:{mainTex:"dof_separate_far",cocTex:"coc"},outputs:su,parameters:hu,defines:{G_PASS:null,FARFIELD:null}},{name:"dof_blur_far_3",shader:"#source(car.dof.blur)",inputs:{mainTex:"dof_separate_far",cocTex:"coc"},outputs:su,parameters:hu,defines:{B_PASS:null,FARFIELD:null}},{name:"dof_blur_far_4",shader:"#source(car.dof.blur)",inputs:{mainTex:"dof_separate_far",cocTex:"coc"},outputs:su,parameters:hu,defines:{A_PASS:null,FARFIELD:null}},{name:"dof_blur_far_final",shader:"#source(car.dof.blur)",inputs:{rTex:"dof_blur_far_1",gTex:"dof_blur_far_2",bTex:"dof_blur_far_3",aTex:"dof_blur_far_4",cocTex:"coc"},outputs:su,parameters:hu,defines:{FINAL_PASS:null,FARFIELD:null}},{name:"dof_blur_near_1",shader:"#source(car.dof.blur)",inputs:{mainTex:"dof_separate_near",cocTex:"coc",dilateCocTex:"coc_dilate_2"},outputs:su,parameters:hu,defines:{R_PASS:null}},{name:"dof_blur_near_2",shader:"#source(car.dof.blur)",inputs:{mainTex:"dof_separate_near",cocTex:"coc",dilateCocTex:"coc_dilate_2"},outputs:su,parameters:hu,defines:{G_PASS:null}},{name:"dof_blur_near_3",shader:"#source(car.dof.blur)",inputs:{mainTex:"dof_separate_near",cocTex:"coc",dilateCocTex:"coc_dilate_2"},outputs:su,parameters:hu,defines:{B_PASS:null}},{name:"dof_blur_near_4",shader:"#source(car.dof.blur)",inputs:{mainTex:"dof_separate_near",cocTex:"coc",dilateCocTex:"coc_dilate_2"},outputs:su,parameters:hu,defines:{A_PASS:null}},{name:"dof_blur_near_final",shader:"#source(car.dof.blur)",inputs:{rTex:"dof_blur_near_1",gTex:"dof_blur_near_2",bTex:"dof_blur_near_3",aTex:"dof_blur_near_4",cocTex:"coc",dilateCocTex:"coc_dilate_2"},outputs:su,parameters:hu,defines:{FINAL_PASS:null}},{name:"dof_composite",shader:"#source(car.dof.composite)",inputs:{sharpTex:"source",farTex:"dof_blur_far_final",nearTex:"dof_blur_near_final",cocTex:"coc"},outputs:{color:{parameters:{width:"expr(width * 1.0)",height:"expr(height * 1.0)",type:"HALF_FLOAT"}}},defines:{}},{name:"composite",shader:"#source(clay.compositor.hdr.composite)",inputs:{texture:"source",bloom:"bloom_composite"},defines:{}},{name:"FXAA",shader:"#source(clay.compositor.fxaa)",inputs:{texture:"composite"}}]},lu=ws.GBuffer;en.import("@export car.dof.coc\nuniform sampler2D depth;\nuniform float zNear = 0.1;\nuniform float zFar = 2000;\nuniform float focalDistance = 10;\nuniform float focalLength = 50;\nuniform float aperture = 5.6;\nuniform float maxCoc;\nuniform float _filmHeight = 0.024;\nvarying vec2 v_Texcoord;\n@import clay.util.encode_float\nvoid main()\n{\n float z = texture2D(depth, v_Texcoord).r * 2.0 - 1.0;\n float dist = 2.0 * zNear * zFar / (zFar + zNear - z * (zFar - zNear));\n float f = focalLength / 1000.0;\n float s1 = max(f, focalDistance);\n float coeff = f * f / (aperture * (s1 - f) * _filmHeight * 2.0);\n float coc = (dist - focalDistance) * coeff / max(dist, 1e-5);\n coc /= maxCoc;\n gl_FragColor = vec4(clamp(coc * 0.5 + 0.5, 0.0, 1.0), 0.0, 0.0, 1.0);\n}\n@end\n@export car.dof.composite\n#define DEBUG 0\nuniform sampler2D sharpTex;\nuniform sampler2D nearTex;\nuniform sampler2D farTex;\nuniform sampler2D cocTex;\nuniform float maxCoc;\nuniform float minCoc;\nvarying vec2 v_Texcoord;\n@import clay.util.rgbm\nvoid main()\n{\n float coc = texture2D(cocTex, v_Texcoord).r * 2.0 - 1.0;\n vec4 nearTexel = decodeHDR(texture2D(nearTex, v_Texcoord));\n vec4 farTexel = decodeHDR(texture2D(farTex, v_Texcoord));\n vec4 sharpTexel = decodeHDR(texture2D(sharpTex, v_Texcoord));\n float nfa = clamp(nearTexel.a, 0.0, 1.0);\n float ffa = smoothstep(minCoc / maxCoc, 0.2, coc);\n ffa *= clamp(farTexel.a, 0.0, 1.0);\n gl_FragColor.rgb = mix(mix(sharpTexel.rgb, farTexel.rgb, ffa), nearTexel.rgb, nfa);\n gl_FragColor.a = max(max(sharpTexel.a, nfa), clamp(farTexel.a, 0.0, 1.0));\n}\n@end\n@export car.dof.separate\nuniform sampler2D mainTex;\nuniform sampler2D cocTex;\nuniform float minCoc;\nvarying vec2 v_Texcoord;\n@import clay.util.rgbm\nvoid main()\n{\n vec4 color = decodeHDR(texture2D(mainTex, v_Texcoord));\n float coc = texture2D(cocTex, v_Texcoord).r * 2.0 - 1.0;\n#ifdef FARFIELD\n color *= step(0.0, coc);\n#else\n color.a *= step(minCoc, -coc);\n#endif\n gl_FragColor = encodeHDR(color);\n}\n@end\n@export car.dof.dilateCoc\n#define SHADER_NAME dilateCoc\nuniform sampler2D cocTex;\nuniform vec2 textureSize;\nvarying vec2 v_Texcoord;\nvoid main()\n{\n#ifdef VERTICAL\n vec2 offset = vec2(0.0, 1.0 / textureSize.y);\n#else\n vec2 offset = vec2(1.0 / textureSize.x, 0.0);\n#endif\n float coc0 = 1.0;\n for (int i = 0; i < 17; i++) {\n vec2 duv = (float(i) - 8.0) * offset * 1.5;\n float coc = texture2D(cocTex, v_Texcoord + duv).r * 2.0 - 1.0;\n coc *= pow(1.0 - abs(float(i) - 8.0) / 10.0, 2.0);\n coc0 = min(coc0, coc);\n }\n gl_FragColor = vec4(coc0 * 0.5 + 0.5, 0.0, 0.0, 1.0);\n}\n@end\n@export car.dof.blur\n#define KERNEL_SIZE 17\nconst vec2 kernel1Weight = vec2(0.411259,-0.548794);\nconst vec2 kernel2Weight = vec2(0.513282,4.561110);\nuniform vec4 kernel1[KERNEL_SIZE];\nuniform vec4 kernel2[KERNEL_SIZE];\n#ifdef FINAL_PASS\nuniform sampler2D rTex;\nuniform sampler2D gTex;\nuniform sampler2D bTex;\nuniform sampler2D aTex;\n#endif\nuniform sampler2D mainTex;\nuniform sampler2D cocTex;\nuniform sampler2D dilateCocTex;\nuniform float maxCoc;\nuniform float minCoc;\nuniform vec2 textureSize;\nvarying vec2 v_Texcoord;\nvec2 multComplex(vec2 p, vec2 q)\n{\n return vec2(p.x*q.x-p.y*q.y, p.x*q.y+p.y*q.x);\n}\nfloat GetSmallestCoc(vec2 uv)\n{\n vec2 k = 1.0 / textureSize;\n float coc = texture2D(cocTex, uv).r;\n vec4 around = vec4(\n texture2D(cocTex, uv - k).r,\n texture2D(cocTex, uv + vec2(k.x, -k.y)).r,\n texture2D(cocTex, uv + vec2(-k.x, k.y)).r,\n texture2D(cocTex, uv + k).r\n );\n return min(min(min(min(around.x, around.y), around.z), around.w), coc);\n}\n@import clay.util.rgbm\n@import clay.util.float\nvoid main()\n{\n float halfKernelSize = float(KERNEL_SIZE / 2);\n vec2 texelSize = 1.0 / textureSize;\n float weight = 0.0;\n#ifdef FARFIELD\n float coc0 = texture2D(cocTex, v_Texcoord).r * 2.0 - 1.0;\n#else\n float coc0 = -(texture2D(dilateCocTex, v_Texcoord).r * 2.0 - 1.0);\n#endif\n if (coc0 <= 0.0) {\n gl_FragColor = vec4(0.0);\n return;\n }\n coc0 *= maxCoc;\n#ifdef FINAL_PASS\n vec4 valR = vec4(0.0);\n vec4 valG = vec4(0.0);\n vec4 valB = vec4(0.0);\n vec4 valA = vec4(0.0);\n vec2 offset = vec2(0.0, abs(coc0) / halfKernelSize);\n#else\n vec4 val = vec4(0.0);\n vec2 offset = vec2(texelSize.x / texelSize.y * abs(coc0) / halfKernelSize, 0.0);\n#endif\n for (int i = 0; i < KERNEL_SIZE; i++) {\n vec2 duv = (float(i) - halfKernelSize) * offset;\n float dist = length(duv);\n vec2 uv = clamp(v_Texcoord + duv, vec2(0.0), vec2(1.0));\n#ifdef FARFIELD\n float coc = GetSmallestCoc(uv) * 2.0 - 1.0;\n#else\n float coc = texture2D(cocTex, uv).r * 2.0 - 1.0;\n#endif\n coc *= maxCoc;\n float w = 1.0;\n#ifdef FARFIELD\n w *= step(dist, coc);\n#endif\n weight += w;\n vec4 c0c1 = vec4(kernel1[i].xy, kernel2[i].xy);\n#ifdef FINAL_PASS\n vec4 rTexel = texture2D(rTex, uv) * w;\n vec4 gTexel = texture2D(gTex, uv) * w;\n vec4 bTexel = texture2D(bTex, uv) * w;\n vec4 aTexel = texture2D(aTex, uv) * w;\n valR.xy += multComplex(rTexel.xy,c0c1.xy);\n valR.zw += multComplex(rTexel.zw,c0c1.zw);\n valG.xy += multComplex(gTexel.xy,c0c1.xy);\n valG.zw += multComplex(gTexel.zw,c0c1.zw);\n valB.xy += multComplex(bTexel.xy,c0c1.xy);\n valB.zw += multComplex(bTexel.zw,c0c1.zw);\n valA.xy += multComplex(aTexel.xy,c0c1.xy);\n valA.zw += multComplex(aTexel.zw,c0c1.zw);\n#else\n vec4 color = texture2D(mainTex, uv);\n float tmp;\n #if defined(R_PASS)\n tmp = color.r;\n #elif defined(G_PASS)\n tmp = color.g;\n #elif defined(B_PASS)\n tmp = color.b;\n #elif defined(A_PASS)\n tmp = color.a;\n #endif\n val += tmp * c0c1 * w;\n#endif\n }\n weight /= float(KERNEL_SIZE);\n weight = max(weight, 0.0001);\n#ifdef FINAL_PASS\n valR /= weight;\n valG /= weight;\n valB /= weight;\n valA /= weight;\n float r = dot(valR.xy,kernel1Weight)+dot(valR.zw,kernel2Weight);\n float g = dot(valG.xy,kernel1Weight)+dot(valG.zw,kernel2Weight);\n float b = dot(valB.xy,kernel1Weight)+dot(valB.zw,kernel2Weight);\n float a = dot(valA.xy,kernel1Weight)+dot(valA.zw,kernel2Weight);\n gl_FragColor = vec4(r, g, b, a);\n#else\n val /= weight;\n gl_FragColor = val;\n#endif\n}\n@end\n// @end"),en.import("@export car.temporalBlend\nuniform sampler2D prevTex;\nuniform sampler2D currTex;\nuniform sampler2D velocityTex;\nuniform float stillBlending = 0.95;\nuniform float motionBlending = 0.5;\nvarying vec2 v_Texcoord;\nvoid main() {\n vec4 vel = texture2D(velocityTex, v_Texcoord);\n vec2 motion = vel.rg - 0.5;\n vec4 curr = texture2D(currTex, v_Texcoord);\n vec4 prev = texture2D(prevTex, v_Texcoord - motion);\n if (vel.a < 0.01) {\n gl_FragColor = curr;\n }\n else {\n float motionLength = length(motion);\n float weight = clamp(\n mix(stillBlending, motionBlending, motionLength * 1000.0),\n motionBlending, stillBlending\n );\n gl_FragColor = mix(curr, prev, weight);\n }\n}\n@end");var cu={color:{parameters:{width:function(t){return t.getWidth()},height:function(t){return t.getHeight()}}}},fu=["composite","FXAA"];function du(){this._gBufferPass=new lu({renderTransparent:!0,enableTargetTexture3:!1,enableTargetTexture4:!0}),this._compositor=hi(uu);var t=this._compositor.getNodeByName("source"),e=this._compositor.getNodeByName("coc");this._sourceNode=t,this._cocNode=e,this._compositeNode=this._compositor.getNodeByName("composite"),this._fxaaNode=this._compositor.getNodeByName("FXAA"),this._dofBlurNodes=["dof_blur_far_1","dof_blur_far_2","dof_blur_far_3","dof_blur_far_4","dof_blur_far_final","dof_blur_near_1","dof_blur_near_2","dof_blur_near_3","dof_blur_near_4","dof_blur_near_final"].map(function(t){return this._compositor.getNodeByName(t)},this),this._dofFarFieldNode=this._compositor.getNodeByName("dof_separate_far"),this._dofNearFieldNode=this._compositor.getNodeByName("dof_separate_near"),this._dofCompositeNode=this._compositor.getNodeByName("dof_composite"),this._dofBlurKernel=null,this._dofBlurKernelSize=new Float32Array(0),this._finalNodesChain=fu.map(function(t){return this._compositor.getNodeByName(t)},this);var r={normalTexture:this._gBufferPass.getTargetTexture1(),depthTexture:this._gBufferPass.getTargetTexture2(),albedoTexture:this._gBufferPass.getTargetTexture3(),velocityTexture:this._gBufferPass.getTargetTexture4()};this._ssaoPass=new tu(r),this._ssrPass=new iu(r)}du.prototype.resize=function(t,e,r){t*=r=r||1,e*=r,this._gBufferPass.resize(t,e)},du.prototype._ifRenderNormalPass=function(){return!0},du.prototype._getPrevNode=function(t){for(var e=fu.indexOf(t.name)-1,r=this._finalNodesChain[e];r&&!this._compositor.getNodeByName(r.name);)e-=1,r=this._finalNodesChain[e];return r},du.prototype._getNextNode=function(t){for(var e=fu.indexOf(t.name)+1,r=this._finalNodesChain[e];r&&!this._compositor.getNodeByName(r.name);)e+=1,r=this._finalNodesChain[e];return r},du.prototype._addChainNode=function(t){var e=this._getPrevNode(t),r=this._getNextNode(t);e&&(e.outputs=cu,t.inputs.texture=e.name,r?(t.outputs=cu,r.inputs.texture=t.name):t.outputs=null,this._compositor.addNode(t))},du.prototype._removeChainNode=function(t){var e=this._getPrevNode(t),r=this._getNextNode(t);e&&(r?(e.outputs=cu,r.inputs.texture=e.name):e.outputs=null,this._compositor.removeNode(t))},du.prototype.updateGBuffer=function(t,e,r,n){this._ifRenderNormalPass()&&this._gBufferPass.update(t,e,r)},du.prototype.updateSSAO=function(t,e,r,n){this._ssaoPass.update(t,r,n)},du.prototype.updateSSR=function(t,e,r,n,i,o){this._ssrPass.setSSAOTexture(this._enableSSAO?this._ssaoPass.getTargetTexture():null);for(var a=e.getLights(),s=0;s<a.length;s++)a[s].cubemap&&this._ssrPass.setAmbientCubemap(a[s].cubemap,a[s]._brdfLookup,a[s].intensity);this._ssrPass.update(t,r,n,i,o)},du.prototype.enableSSAO=function(){this._enableSSAO=!0},du.prototype.disableSSAO=function(){this._enableSSAO=!1},du.prototype.enableVelocityBuffer=function(){this._gBufferPass.enableTargetTexture4=!0},du.prototype.disableVelocityBuffer=function(){this._gBufferPass.enableTargetTexture4=!1},du.prototype.enableSSR=function(){this._enableSSR=!0,this._gBufferPass.enableTargetTexture3=!0},du.prototype.disableSSR=function(){this._enableSSR=!1,this._gBufferPass.enableTargetTexture3=!1},du.prototype.getSSAOTexture=function(){return this._ssaoPass.getTargetTexture()},du.prototype.getSSRTexture=function(){return this._ssrPass.getTargetTexture()},du.prototype.getVelocityTexture=function(){return this._gBufferPass.getTargetTexture4()},du.prototype.getDepthTexture=function(){return this._gBufferPass.getTargetTexture2()},du.prototype.disableFXAA=function(){this._removeChainNode(this._fxaaNode)},du.prototype.enableFXAA=function(){this._addChainNode(this._fxaaNode)},du.prototype.enableBloom=function(){this._compositeNode.inputs.bloom="bloom_composite",this._compositor.dirty()},du.prototype.disableBloom=function(){this._compositeNode.inputs.bloom=null,this._compositor.dirty()},du.prototype.enableDOF=function(){this._compositeNode.inputs.texture="dof_composite",this._compositor.dirty()},du.prototype.disableDOF=function(){this._compositeNode.inputs.texture="source",this._compositor.dirty()},du.prototype.enableColorCorrection=function(){this._compositeNode.define("COLOR_CORRECTION"),this._enableColorCorrection=!0},du.prototype.disableColorCorrection=function(){this._compositeNode.undefine("COLOR_CORRECTION"),this._enableColorCorrection=!1},du.prototype.enableEdge=function(){this._enableEdge=!0},du.prototype.disableEdge=function(){this._enableEdge=!1},du.prototype.setBloomIntensity=function(t){null!=t&&this._compositeNode.setParameter("bloomIntensity",t)},du.prototype.setSSAOParameter=function(t,e){if(null!=e)switch(t){case"quality":var r={low:6,medium:12,high:32,ultra:62}[e]||12;this._ssaoPass.setParameter("kernelSize",r);break;case"radius":this._ssaoPass.setParameter(t,e),this._ssaoPass.setParameter("bias",e/50);break;case"intensity":case"temporalFilter":this._ssaoPass.setParameter(t,e)}},du.prototype.setDOFParameter=function(t,e){if(null!=e)switch(t){case"focalDistance":case"focalRange":case"aperture":this._cocNode.setParameter(t,e);break;case"blurRadius":this._dofBlurRadius=e}},du.prototype.setSSRParameter=function(t,e){if(null!=e)switch(t){case"quality":var r={low:10,medium:15,high:30,ultra:80}[e]||20,n={low:32,medium:16,high:8,ultra:4}[e]||16;this._ssrPass.setParameter("maxIteration",r),this._ssrPass.setParameter("pixelStride",n);break;case"maxRoughness":this._ssrPass.setParameter("minGlossiness",Math.max(Math.min(1-e,1),0));break;case"physical":this.setPhysicallyCorrectSSR(e);break;default:console.warn("Unkown SSR parameter "+t)}},du.prototype.setPhysicallyCorrectSSR=function(t){this._ssrPass.setPhysicallyCorrect(t)},du.prototype.setEdgeColor=function(t){},du.prototype.setExposure=function(t){null!=t&&this._compositeNode.setParameter("exposure",Math.pow(2,t))},du.prototype.setColorLookupTexture=function(t,e){},du.prototype.setColorCorrection=function(t,e){this._compositeNode.setParameter(t,e)},du.prototype.composite=function(t,e,r,n,i,o){this._sourceNode.texture=n,this._cocNode.setParameter("depth",i);var a=this._dofBlurRadius||10;a/=t.getHeight();for(var s=0;s<this._dofBlurNodes.length;s++){var h=this._dofBlurNodes[s];h.setParameter("kernel1",ou),h.setParameter("kernel2",au),h.setParameter("maxCoc",a),h.setParameter("minCoc",0)}this._cocNode.setParameter("maxCoc",a),this._dofCompositeNode.setParameter("maxCoc",a),this._dofCompositeNode.setParameter("minCoc",0),this._dofFarFieldNode.setParameter("minCoc",0/a),this._dofNearFieldNode.setParameter("minCoc",0/a),this._cocNode.setParameter("zNear",r.near),this._cocNode.setParameter("zFar",r.far),this._compositor.render(t)},du.prototype.isSSRFinished=function(t){return!this._ssrPass||this._ssrPass.isFinished(t)},du.prototype.isSSAOFinished=function(t){return!this._ssaoPass||this._ssaoPass.isFinished(t)},du.prototype.isSSREnabled=function(){return this._enableSSR},du.prototype.dispose=function(t){this._compositor.dispose(t),this._gBufferPass.dispose(t),this._ssaoPass.dispose(t)};var pu=du,mu=bs.Pass;function gu(t){t=t||{};for(var e=[],r=0;r<30;r++)e.push([qh(r,2),qh(r,3)]);this._haltonSequence=e,this._frame=0,this._prevFrameTex=new br({type:mr.HALF_FLOAT}),this._outputTex=new br({type:mr.HALF_FLOAT}),this._taaPass=new mu({fragment:en.source("car.taa")}),this._velocityTex=t.velocityTexture,this._depthTex=t.depthTexture,this._taaFb=new Or({depthBuffer:!1}),this._outputPass=new mu({fragment:en.source("clay.compositor.output"),blendWithPrevious:!0}),this._outputPass.material.define("fragment","OUTPUT_ALPHA"),this._outputPass.material.blend=function(t){t.blendEquationSeparate(t.FUNC_ADD,t.FUNC_ADD),t.blendFuncSeparate(t.ONE,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA)}}en.import("@export car.taa\n#define SHADER_NAME TAA3\nuniform sampler2D prevTex;\nuniform sampler2D currTex;\nuniform sampler2D velocityTex;\nuniform sampler2D depthTex;\nuniform vec2 texelSize;\nuniform vec2 velocityTexelSize;\nuniform vec2 jitterOffset;\nuniform bool still;\nuniform float stillBlending = 0.95;\nuniform float motionBlending = 0.85;\nuniform float sharpness = 0.25;\nuniform float motionAmplification = 6000;\nvarying vec2 v_Texcoord;\nfloat Luminance(vec4 color)\n{\n return dot(color.rgb, vec3(0.2125, 0.7154, 0.0721));\n}\nfloat compareDepth(float a, float b)\n{\n return step(a, b);\n}\nvec2 GetClosestFragment(vec2 uv)\n{\n vec2 k = velocityTexelSize.xy;\n vec4 neighborhood = vec4(\n texture2D(depthTex, uv - k).r,\n texture2D(depthTex, uv + vec2(k.x, -k.y)).r,\n texture2D(depthTex, uv + vec2(-k.x, k.y)).r,\n texture2D(depthTex, uv + k).r\n );\n vec3 result = vec3(0.0, 0.0, texture2D(depthTex, uv));\n result = mix(result, vec3(-1.0, -1.0, neighborhood.x), compareDepth(neighborhood.x, result.z));\n result = mix(result, vec3( 1.0, -1.0, neighborhood.y), compareDepth(neighborhood.y, result.z));\n result = mix(result, vec3(-1.0, 1.0, neighborhood.z), compareDepth(neighborhood.z, result.z));\n result = mix(result, vec3( 1.0, 1.0, neighborhood.w), compareDepth(neighborhood.w, result.z));\n return (uv + result.xy * k);\n}\nvec4 ClipToAABB(vec4 color, vec3 minimum, vec3 maximum)\n{\n vec3 center = 0.5 * (maximum + minimum);\n vec3 extents = 0.5 * (maximum - minimum);\n vec3 offset = color.rgb - center;\n vec3 ts = abs(extents / (offset + 0.0001));\n float t = clamp(min(min(ts.x, ts.y), ts.z), 0.0, 1.0);\n color.rgb = center + offset * t;\n return color;\n}\nvec4 Tonemap(vec4 color)\n{\n return vec4(color.rgb / (Luminance(color) + 1.0), color.a);\n}\nvec4 Untonemap(vec4 color)\n{\n return vec4(color.rgb / max(1.0 - Luminance(color), 0.0001), color.a);\n}\nvoid main()\n{\n vec2 closest = GetClosestFragment(v_Texcoord);\n vec4 motionTexel = texture2D(velocityTex, closest);\n if (still) {\n gl_FragColor = Untonemap(\n mix(\n Tonemap(texture2D(currTex, v_Texcoord)),\n Tonemap(texture2D(prevTex, v_Texcoord)),\n stillBlending\n )\n );\n return;\n }\n if (motionTexel.a < 0.1) {\n gl_FragColor = texture2D(currTex, v_Texcoord);\n return;\n }\n vec2 motion = motionTexel.rg - 0.5;\n vec2 k = texelSize.xy;\n vec2 uv = v_Texcoord;\n vec4 color = texture2D(currTex, uv);\n vec4 topLeft = texture2D(currTex, uv - k * 0.5);\n vec4 bottomRight = texture2D(currTex, uv + k * 0.5);\n vec4 corners = 4.0 * (topLeft + bottomRight) - 2.0 * color;\n vec4 average = (corners + color) * 0.142857;\n vec4 history = texture2D(prevTex, v_Texcoord - motion);\n float motionLength = length(motion);\n vec2 luma = vec2(Luminance(average), Luminance(color));\n float nudge = mix(4.0, 0.25, clamp(motionLength * 100.0, 0.0, 1.0)) * abs(luma.x - luma.y);\n vec4 minimum = min(bottomRight, topLeft) - nudge;\n vec4 maximum = max(topLeft, bottomRight) + nudge;\n history = ClipToAABB(history, minimum.xyz, maximum.xyz);\n float weight = clamp(\n mix(stillBlending, motionBlending, motionLength * motionAmplification),\n motionBlending, stillBlending\n );\n color = mix(Tonemap(color), Tonemap(history), weight);\n color = Untonemap(clamp(color, 0.0, 1.0));\n gl_FragColor = color;\n}\n@end"),gu.prototype={constructor:gu,jitterProjection:function(t,e){var r=this._haltonSequence[this._frame%this._haltonSequence.length],n=t.viewport,i=n.devicePixelRatio||t.getDevicePixelRatio(),o=n.width*i,a=n.height*i,s=new Ge;s.array[12]=(2*r[0]-1)/o,s.array[13]=(2*r[1]-1)/a,Ge.mul(e.projectionMatrix,s,e.projectionMatrix),Ge.invert(e.invProjectionMatrix,e.projectionMatrix)},getJitterOffset:function(t){var e=this._haltonSequence[this._frame%this._haltonSequence.length],r=t.viewport,n=r.devicePixelRatio||t.getDevicePixelRatio(),i=r.width*n,o=r.height*n;return[e[0]/i,e[1]/o]},resetFrame:function(){this._frame=0},getFrame:function(){return this._frame},getTargetTexture:function(){return this._prevFrameTex},resize:function(t,e){this._prevFrameTex.width=t,this._prevFrameTex.height=e,this._outputTex.width=t,this._outputTex.height=e},isFinished:function(){return this._frame>=this._haltonSequence.length},render:function(t,e,r,n,i){var o=this._taaPass;o.setUniform("jitterOffset",this.getJitterOffset(t)),o.setUniform("velocityTex",this._velocityTex),o.setUniform("prevTex",this._prevFrameTex),o.setUniform("currTex",r),o.setUniform("depthTex",this._depthTex),o.setUniform("texelSize",[1/r.width,1/r.height]),o.setUniform("velocityTexelSize",[1/this._depthTex.width,1/this._depthTex.height]),o.setUniform("still",!!n),n&&o.setUniform("stillBlending",0===this._frame?0:.95),this._taaFb.attach(this._outputTex),this._taaFb.bind(t),o.render(t),this._taaFb.unbind(t),i&&(this._outputPass.setUniform("texture",this._outputTex),this._outputPass.render(t));var a=this._prevFrameTex;this._prevFrameTex=this._outputTex,this._outputTex=a,this._frame++},dispose:function(t){this._taaFb.dispose(t),this._prevFrameTex.dispose(t),this._outputTex.dispose(t),this._outputPass.dispose(t),this._taaPass.dispose(t)}};var _u=gu,yu=Cs.ShadowMap;function vu(t,e,r){this.renderer=t,this.scene=e,this.preZ=!0,this._compositor=new pu,this._temporalSS=new _u({velocityTexture:this._compositor.getVelocityTexture(),depthTexture:this._compositor.getDepthTexture()}),r&&(this._shadowMapPass=new yu({lightFrustumBias:20})),this._enableTemporalSS="auto",e.on("beforerender",function(t,e,r){this.needsTemporalSS()&&this._temporalSS.jitterProjection(t,r)},this),this._framebuffer=new Or,this._sourceTex=new br({type:mr.HALF_FLOAT}),this._depthTex=new br({format:mr.DEPTH_COMPONENT,type:mr.UNSIGNED_INT})}var xu=new re;vu.prototype.castRay=function(t,e,r){var n=this.layer.renderer,i=n.viewport;return n.viewport=this.viewport,n.screenToNDC(t,e,xu),this.camera.castRay(xu,r),n.viewport=i,r},vu.prototype.prepareRender=function(){var t=this.scene,e=t.getMainCamera(),r=this.renderer;e.aspect=r.getViewportAspect(),t.update(),t.updateLights();var n=t.updateRenderList(e);this._updateSRGBOfList(n.opaque),this._updateSRGBOfList(n.transparent),this._frame=0,this._temporalSupportDynamic||this._temporalSS.resetFrame();for(var i=t.getLights(),o=0;o<i.length;o++)i[o].cubemap&&(this._compositor&&this._compositor.isSSREnabled()?i[o].invisible=!0:i[o].invisible=!1);this._enablePostEffect&&this._compositor.resize(r.getWidth(),r.getHeight(),r.getDevicePixelRatio()),this._temporalSS&&this._temporalSS.resize(r.getWidth(),r.getHeight())},vu.prototype.render=function(t){var e=this.scene,r=e.getMainCamera();this._doRender(e,r,t,this._frame),this._frame++},vu.prototype.needsAccumulate=function(){return this.needsTemporalSS()},vu.prototype.needsTemporalSS=function(){var t=this._enableTemporalSS;return"auto"===t&&(t=this._enablePostEffect),t},vu.prototype.hasDOF=function(){return this._enableDOF},vu.prototype.isAccumulateFinished=function(){var t=this._frame;return!(this.needsTemporalSS()&&!this._temporalSS.isFinished(t)||this._compositor&&!this._compositor.isSSAOFinished(t)||this._compositor&&!this._compositor.isSSRFinished(t)||this._compositor&&t<30)},vu.prototype._doRender=function(t,e,r,n){var i=this.renderer;n=n||0,!r&&this._shadowMapPass&&(this._shadowMapPass.kernelPCF=this._pcfKernels[0],this._shadowMapPass.render(i,t,e,!0)),this._updateShadowPCFKernel(t,e,n),i.gl.clearColor(0,0,0,0),this._enablePostEffect&&(this.needsTemporalSS()&&this._temporalSS.jitterProjection(i,e),this._compositor.updateGBuffer(i,t,e,this._temporalSS.getFrame())),this._updateSSAO(i,t,e,r?this._temporalSS.getFrame():0);var o=this.needsTemporalSS()&&(this._temporalSupportDynamic||r),a=this._enablePostEffect;if(o||a){var s=this._compositor.isSSREnabled(),h=this._sourceTex,u=this._depthTex,l=this._framebuffer;if(u.width=h.width=i.getWidth(),u.height=h.height=i.getHeight(),l.attach(h),l.attach(u,Or.DEPTH_ATTACHMENT),l.bind(i),i.gl.clear(i.gl.DEPTH_BUFFER_BIT|i.gl.COLOR_BUFFER_BIT),i.render(t,e,!0,this.preZ),this.afterRenderScene(i,t,e),l.unbind(i),s&&a&&(this._compositor.updateSSR(i,t,e,h,o?this._temporalSS.getTargetTexture():h,this._temporalSS.getFrame()),h=this._compositor.getSSRTexture()),o){var c=!a;this._temporalSS.render(i,e,h,r,c),h=this._temporalSS.getTargetTexture()}a&&this._compositor.composite(i,t,e,h,u,o?this._temporalSS.getFrame():0,r)}else i.render(t,e,!0,this.preZ),this.afterRenderScene(i,t,e);this.afterRenderAll(i,t,e)},vu.prototype._updateSRGBOfList=function(t){for(var e=this.isLinearSpace(),r=0;r<t.length;r++)t[r].material[e?"define":"undefine"]("fragment","SRGB_DECODE")},vu.prototype.afterRenderScene=function(t,e,r){},vu.prototype.afterRenderAll=function(t,e,r){},vu.prototype._updateSSAO=function(t,e,r,n){var i=this._enableSSAO&&this._enablePostEffect,o=this._compositor;function a(t){for(var e=0;e<t.length;e++){var r=t[e];r.material[i?"enableTexture":"disableTexture"]("ssaoMap"),i&&r.material.set("ssaoMap",o.getSSAOTexture())}}i&&this._compositor.updateSSAO(t,e,r,this._temporalSS.getFrame()),a(e.getRenderList(r).opaque),a(e.getRenderList(r).transparent)},vu.prototype._updateShadowPCFKernel=function(t,e,r){var n=this._pcfKernels[r%this._pcfKernels.length];function i(t){for(var e=0;e<t.length;e++)t[e].receiveShadow&&(t[e].material.set("pcfKernel",n),t[e].material&&t[e].material.define("fragment","PCF_KERNEL_SIZE",n.length/2))}i(t.getRenderList(e).opaque),i(t.getRenderList(e).transparent)},vu.prototype.dispose=function(){var t=this.renderer;this._compositor.dispose(t),this._temporalSS.dispose(t),this._shadowMapPass&&this._shadowMapPass.dispose(t),t.dispose()},vu.prototype.setPostEffect=function(t,e){var r=this._compositor;t=t||{},this._enablePostEffect=!!t.enable;var n=t.bloom||{},i=t.edge||{},o=t.depthOfField||{},a=t.screenSpaceAmbientOcclusion||{},s=t.screenSpaceReflection||{},h=t.FXAA||{},u=t.colorCorrection||{};n.enable?r.enableBloom():r.disableBloom(),o.enable?r.enableDOF():r.disableDOF(),s.enable?r.enableSSR():r.disableSSR(),u.enable?r.enableColorCorrection():r.disableColorCorrection(),i.enable?r.enableEdge():r.disableEdge(),h.enable?r.enableFXAA():r.disableFXAA(),this._enableDOF=o.enable,this._enableSSAO=a.enable,this._enableSSAO?r.enableSSAO():r.disableSSAO(),r.setBloomIntensity(n.intensity),r.setEdgeColor(i.color),r.setColorLookupTexture(u.lookupTexture,e),r.setExposure(u.exposure),["radius","quality","intensity","temporalFilter"].forEach(function(t){r.setSSAOParameter(t,a[t])}),["quality","maxRoughness","physical"].forEach(function(t){r.setSSRParameter(t,s[t])}),["quality","focalDistance","focalRange","blurRadius","aperture"].forEach(function(t){r.setDOFParameter(t,o[t])}),["brightness","contrast","saturation"].forEach(function(t){r.setColorCorrection(t,u[t])})},vu.prototype.setShadow=function(t){for(var e=[],r=0,n=0;n<30;n++){for(var i=[],o=0;o<t.kernelSize;o++)i.push((2*qh(r,2)-1)*t.blurSize),i.push((2*qh(r,3)-1)*t.blurSize),r++;e.push(i)}this._pcfKernels=e},vu.prototype.isDOFEnabled=function(){return this._enablePostEffect&&this._enableDOF},vu.prototype.setDOFFocusOnPoint=function(t){if(this._enablePostEffect){if(t>this.camera.far||t<this.camera.near)return;return this._compositor.setDOFParameter("focalDistance",t),!0}},vu.prototype.setTemporalSuperSampling=function(t){t=t||{},this._enableTemporalSS=t.enable,this._temporalSupportDynamic=t.dynamic,this._enableTemporalSS&&this._temporalSupportDynamic?this._compositor.enableVelocityBuffer():this._compositor.disableVelocityBuffer()},vu.prototype.isLinearSpace=function(){return this._enablePostEffect};var bu=vu,wu={shadow:{enable:!0,kernelSize:6,blurSize:2},temporalSuperSampling:{dynamic:!0,enable:"auto"},postEffect:{enable:!0,bloom:{enable:!0,intensity:.1},depthOfField:{enable:!1,focalDistance:5,focalRange:1,blurRadius:20,aperture:5.6,quality:"medium"},screenSpaceAmbientOcclusion:{enable:!1,radius:.2,quality:"medium",intensity:1,temporalFilter:!1},screenSpaceReflection:{enable:!1,physical:!1,quality:"medium",maxRoughness:.8},colorCorrection:{enable:!0,exposure:0,brightness:0,contrast:1,saturation:1,lookupTexture:""},FXAA:{enable:!1}}},Tu={"[object Function]":1,"[object RegExp]":1,"[object Date]":1,"[object Error]":1,"[object CanvasGradient]":1,"[object CanvasPattern]":1,"[object Image]":1,"[object Canvas]":1},Eu={"[object Int8Array]":1,"[object Uint8Array]":1,"[object Uint8ClampedArray]":1,"[object Int16Array]":1,"[object Uint16Array]":1,"[object Int32Array]":1,"[object Uint32Array]":1,"[object Float32Array]":1,"[object Float64Array]":1},Cu=Object.prototype.toString,Su=Array.prototype,Au=Su.forEach,Mu=(Su.filter,Su.slice),Pu=(Su.map,Su.reduce,{});function Ru(t){if(null==t||"object"!=typeof t)return t;var e=t,r=Cu.call(t);if("[object Array]"===r){if(!Fu(t)){e=[];for(var n=0,i=t.length;n<i;n++)e[n]=Ru(t[n])}}else if(Eu[r]){if(!Fu(t)){var o=t.constructor;if(t.constructor.from)e=o.from(t);else{e=new o(t.length);for(n=0,i=t.length;n<i;n++)e[n]=Ru(t[n])}}}else if(!Tu[r]&&!Fu(t)&&!Iu(t))for(var a in e={},t)t.hasOwnProperty(a)&&(e[a]=Ru(t[a]));return e}function Lu(t,e,r){if(!ku(e)||!ku(t))return r?Ru(e):t;for(var n in e)if(e.hasOwnProperty(n)){var i=t[n],o=e[n];!ku(o)||!ku(i)||Ou(o)||Ou(i)||Iu(o)||Iu(i)||Du(o)||Du(i)||Fu(o)||Fu(i)?!r&&n in t||(t[n]=Ru(e[n])):Lu(i,o,r)}return t}function Ou(t){return"[object Array]"===Cu.call(t)}function ku(t){var e=typeof t;return"function"===e||!!t&&"object"==e}function Du(t){return!!Tu[Cu.call(t)]}function Iu(t){return"object"==typeof t&&"number"==typeof t.nodeType&&"object"==typeof t.ownerDocument}Pu.createCanvas=function(){return document.createElement("canvas")};var Nu="__ec_primitive__";function Fu(t){return t[Nu]}function Bu(t){var e=Ou(t),r=this;function n(t,n){e?r.set(t,n):r.set(n,t)}t instanceof Bu?t.each(n):t&&function(t,e,r){if(t&&e)if(t.forEach&&t.forEach===Au)t.forEach(e,r);else if(t.length===+t.length)for(var n=0,i=t.length;n<i;n++)e.call(r,t[n],n,t);else for(var o in t)t.hasOwnProperty(o)&&e.call(r,t[o],o,t)}(t,n)}function zu(t,e,r,n){"boolean"==typeof(n=Lu({},n)).shadow&&(n.shadow={enable:n.shadow}),n=Lu(n,wu),this._renderMain=new bu(t,e,n.shadow),this._renderMain.setShadow(n.shadow),this._renderMain.setPostEffect(n.postEffect),this._renderMain.setTemporalSuperSampling(n.temporalSuperSampling),this._needsRefresh=!1,this._graphicOpts=n,r.on("frame",this._loop,this),e.on("click",function(t){this.setPostEffect({depthOfField:{focalDistance:t.distance}}),this.render()},this)}Bu.prototype={constructor:Bu,get:function(t){return this.hasOwnProperty(t)?this[t]:null},set:function(t,e){return this[t]=e},each:function(t,e){for(var r in void 0!==e&&(t=function(t,e){var r=Mu.call(arguments,2);return function(){return t.apply(e,r.concat(Mu.call(arguments)))}}(t,e)),this)this.hasOwnProperty(r)&&t(this[r],r)},removeKey:function(t){delete this[t]}},zu.prototype.render=function(t){this._needsRefresh=!0},zu.prototype.setPostEffect=function(t){Lu(this._graphicOpts.postEffect,t,!0),this._renderMain.setPostEffect(this._graphicOpts.postEffect)},zu.prototype.setShadow=function(t){Lu(this._graphicOpts.shadow,t,!0),this._renderMain.setShadow(this._graphicOpts.shadow)},zu.prototype._loop=function(t){this._disposed||this._needsRefresh&&(this._needsRefresh=!1,this._renderMain.prepareRender(),this._renderMain.render(),this._startAccumulating())};var Uu=1;zu.prototype._stopAccumulating=function(){this._accumulatingId=0,clearTimeout(this._accumulatingTimeout)},zu.prototype._startAccumulating=function(t){var e=this;this._stopAccumulating();var r=e._renderMain.needsAccumulate();function n(i){e._accumulatingId&&i===e._accumulatingId&&!e._disposed&&(e._renderMain.isAccumulateFinished()&&r||(e._renderMain.render(!0),t?n(i):requestAnimationFrame(function(){n(i)})))}r&&(this._accumulatingId=Uu++,t?n(e._accumulatingId):this._accumulatingTimeout=setTimeout(function(){n(e._accumulatingId)},50))},zu.prototype.dispose=function(){this._disposed=!0,this._renderMain.dispose()},zu.version="0.1.1";var Hu=zu,ju=r(64),Gu=r.n(ju),Vu=r(63),Wu=r.n(Vu),Zu="# https://github.com/pissang/little-big-city\n";function Xu(t,e,r){t[0]=Math.round(e[0]*r)/r,t[1]=Math.round(e[1]*r)/r,t[2]=Math.round(e[2]*r)/r}function qu(t){var e,r={};return r.Kd=(t.get("color")||[1,1,1]).slice(0,3).join(" "),r.Ks=[1,1,1].join(" "),r.Ns=(null==(e=t.get("roughness"))&&(e=1),Math.pow(1e3,1-e)),"ecgl.realistic"===t.shader.name&&(null!=t.get("metalness")&&(r.Pm=t.get("metalness")),null!=t.get("roughness")&&(r.Pr=t.get("roughness"))),r}var Yu=r(62),Ju=r.n(Yu);function Ku(t){const e=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);t[0]/=e,t[1]/=e,t[2]/=e}function Qu(t,e,r,n,i){const o=[],a=r/Math.sqrt(2),s=a/n;for(let r=0;r<t.length;r+=3){const h=t[r],u=t[r+1],l=t[r+2];let c=(h-e.x)/e.width*2-1,f=(u-e.y)/e.height*2-1;c*=n,f*=n;const d=l+s,p=s-a;switch(i){case"pz":o[0]=c,o[1]=f,o[2]=1,Ku(o),t[r]=o[0]*d,t[r+1]=o[1]*d,t[r+2]=-p+o[2]*d;break;case"px":o[0]=1,o[1]=f,o[2]=-c,Ku(o),t[r]=-p+o[0]*d,t[r+1]=o[1]*d,t[r+2]=o[2]*d;break;case"nz":o[0]=-c,o[1]=f,o[2]=-1,Ku(o),t[r]=o[0]*d,t[r+1]=o[1]*d,t[r+2]=p+o[2]*d;break;case"py":o[0]=-c,o[1]=1,o[2]=f,Ku(o),t[r]=o[0]*d,t[r+1]=-p+o[1]*d,t[r+2]=o[2]*d;break;case"nx":o[0]=-1,o[1]=-c,o[2]=f,Ku(o),t[r]=p+o[0]*d,t[r+1]=o[1]*d,t[r+2]=o[2]*d;break;case"ny":o[0]=c,o[1]=-1,o[2]=f,Ku(o),t[r]=o[0]*d,t[r+1]=p+o[1]*d,t[r+2]=o[2]*d}}return t}const $u=Gu()(50),tl=r(69);let el=!1;const rl={radius:60,curveness:1,showEarth:!0,earthColor:"#c2ebb6",showBuildings:!0,buildingsColor:"#fab8b8",showRoads:!0,roadsColor:"#828282",showWater:!1,waterColor:"#80a9d7",showCloud:!0,cloudColor:"#fff",autoRotateSpeed:0,sky:!0,downloadOBJ:()=>{if(el)return;const{obj:t,mtl:e}=function(t,e){(e=e||{}).storeVertexColorInTexture=e.storeVertexColorInTexture||!1,e.mtllib=e.mtllib||"material";let r=Zu;r+="mtllib "+e.mtllib+".mtl\n";let n={},i=0,o=1;t.traverse(function(t){if(!t.invisible&&t.isRenderable()&&t.geometry.vertexCount){let b="mat_"+i++;r+="o "+t.name+"\n",n[b]=qu(t.material);let w=[],T=[],E=[],C=t.geometry,S=C.attributes.position,A=C.attributes.color,M=C.attributes.normal,P=C.attributes.texcoord0;t.updateWorldTransform();for(var a=t.worldTransform.clone().invert().transpose(),s=new j,h=new j,u=[],l=[],c=!(!P||!P.value),f=!(!M||!M.value),d=!(!A||!A.value),p=[],m=0;m<C.vertexCount;m++){S.get(m,s.array),j.transformMat4(s,s,t.worldTransform),Xu(p,s.array,1e5);var g="v "+p.join(" ");d&&!e.storeVertexColorInTexture&&(A.get(m,u),Xu(u,u,1e3),g+=" "+u.join(" ")),w.push(g),f&&(M.get(m,h.array),j.transformMat4(h,h,a),j.normalize(h,h),Xu(p,h.array,1e3),E.push("vn "+p.join(" "))),c&&(P.get(m,l),T.push("vt "+l.join(" ")))}var _=[],y=[];for(m=0;m<C.triangleCount;m++){C.getTriangleIndices(m,y);for(var v=0;v<3;v++){y[v]+=o;var x=y[v];c&&(y[v]+="/"+x),f&&(c||(y[v]+="/"),y[v]+="/"+x)}_.push("f "+y.join(" "))}r+=w.join("\n")+"\n"+E.join("\n")+"\n"+T.join("\n")+"\nusemtl "+b+"\n"+_.join("\n")+"\n",o+=C.vertexCount}});var a=[Zu];for(var s in n){var h=n[s];for(var u in a.push("newmtl "+s),h){var l=h[u];a.push(u+" "+l)}}return{obj:r,mtl:a.join("\n")}}(sl.scene,{mtllib:"city"}),r=new Ju.a;r.file("city.obj",t),r.file("city.mtl",e),r.generateAsync({type:"blob",compression:"DEFLATE"}).then(t=>{el=!1,saveAs(t,"city.zip")}).catch(t=>{el=!1,console.error(t.toString())}),el=!0},randomCloud:()=>{sl.methods.generateCloud()}},nl=new tl.TileLayer("base",{tileSize:[256,256],urlTemplate:"http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",subdomains:["a","b","c"]}),il=new tl.Map("map",{center:[-74.0130345,40.70635160000003],zoom:16,baseLayer:nl});il.setMinZoom(16),il.setMaxZoom(16);const ol=["pz","px","nz","py","nx","ny"],al=[{type:"buildings",geometryType:"polygon",depth:t=>(t.properties.height||30)/10+1},{type:"roads",geometryType:"polyline",depth:1},{type:"water",geometryType:"polygon",depth:2}],sl=Bs("#viewport",{autoRender:!1,devicePixelRatio:1,init(t){this._advRenderer=new Hu(t.renderer,t.scene,t.timeline,{shadow:!0,temporalSuperSampling:{enable:!0,dynamic:!1},postEffect:{enable:!0,bloom:{enable:!1},screenSpaceAmbientOcclusion:{enable:!0,intensity:1.1,radius:5},FXAA:{enable:!0}}}),this._advRenderer.setShadow({kernelSize:10,blurSize:3});const e=t.createCamera([0,0,170],[0,0,0]);this._earthNode=t.createNode(),this._cloudsNode=t.createNode(),this._elementsNodes={},this._elementsMaterials={},this._diffuseTex=t.loadTextureSync("./asset/paper-detail.png",{anisotropic:8}),al.forEach(e=>{this._elementsNodes[e.type]=t.createNode(),this._elementsMaterials[e.type]=t.createMaterial({name:"mat_"+e.type,diffuseMap:this._diffuseTex,uvRepeat:[10,10],color:rl[e.type+"Color"],roughness:1})}),t.methods.updateEarthSphere(),t.methods.updateElements(),t.methods.updateVisibility(),t.methods.generateCloud(),t.createAmbientCubemapLight("./asset/Grand_Canyon_C.hdr",.2,.8,1).then(e=>{const r=new Es.Skybox({environmentMap:e.specular.cubemap,scene:t.scene});r.material.set("lod",2),this._skybox=r,this._advRenderer.render()});const r=t.createDirectionalLight([-1,-1,-1],"#fff");r.shadowResolution=1024,r.shadowBias=5e-4,this._control=new Es.OrbitControl({target:e,domElement:t.container,timeline:t.timeline,rotateSensitivity:2}),this._control.on("update",()=>{this._advRenderer.render()}),this._advRenderer.render()},methods:{updateEarthSphere(t){this._earthNode.removeAll();const e=t.createMaterial({roughness:1,color:rl.earthColor,diffuseMap:this._diffuseTex,uvRepeat:[2,2],name:"mat_earth"});ol.forEach((r,n)=>{const i=new Ts.Plane({widthSegments:20,heightSegments:20});t.createMesh(i,e,this._earthNode),Qu(i.attributes.position.value,{x:-1,y:-1,width:2,height:2},rl.radius,rl.curveness,r),i.generateVertexNormals()}),this._advRenderer.render()},updateElements(t){this._id=Math.random();const e=this._advRenderer,r=this._elementsNodes,n=this._elementsMaterials;for(let t in r)r[t].removeAll();for(let t in this._buildingAnimators)this._buildingAnimators[t].stop();const i=this._buildingAnimators={};function o(o,a,s,h){const u=s.extent2d.convertTo(t=>il.pointToCoord(t)).toJSON(),l=P({features:a},{translate:[1e4*-u.xmin,1e4*-u.ymin],scale:[1e4,1e4],lineWidth:.5,excludeBottom:!0,simplify:.01,depth:o.depth}),c={x:0,y:0,width:1e4*(u.xmax-u.xmin),height:1e4*(u.ymax-u.ymin)},f=l[o.geometryType],d=new At;if("water"===o.type){const{indices:t,position:e}=function(t,e,r){const n=new j,i=new j,o=new j,a=new j,s=new j,h=new j,u=new j,l=[],c=[];let f=t.length/3;function d(t,e,r,n,i,o,a){return t===e?i:t===r?o:t===n?a:(l.push(t.array[0]),l.push(t.array[1]),l.push(t.array[2]),f++)}function p(t,e,r){c.push(t),c.push(e),c.push(r)}for(let l=0;l<e.length;){const c=e[l++],f=e[l++],m=e[l++];if(j.set(n,t[3*c],t[3*c+1],t[3*c+2]),j.set(i,t[3*f],t[3*f+1],t[3*f+2]),j.set(o,t[3*m],t[3*m+1],t[3*m+2]),n.z>0&&i.z>0&&o.z>0){j.sub(a,n,i),j.sub(s,o,i),j.sub(h,o,n);const t=j.len(a),e=j.len(s),l=j.len(h);if(t<=r&&e<=r&&l<=r)continue;j.scale(a,a,1/t),j.scale(s,s,1/e);let g=[i],_=[i];for(let e=r;e<t;e+=r){const t=j.scaleAndAdd(new j,i,a,e);g.push(t)}g.push(n);for(let t=r;t<e;t+=r){const e=j.scaleAndAdd(new j,i,s,t);_.push(e)}_.push(o);const y=g.length,v=_.length;let x=[f];for(let t=1;t<Math.max(y,v);t++){const e=Math.min(y-1,t),a=Math.min(v-1,t),s=g[e],h=_[a];j.sub(u,h,s);const l=j.len(u);j.scale(u,u,1/l);const b=[];b.push(d(s,n,i,o,c,f,m));for(let t=r;t<l;t+=r){const e=j.scaleAndAdd(new j,s,u,t);b.push(d(e,n,i,o,c,f,m))}b.push(d(h,n,i,o,c,f,m));const w=x.length-1;for(let t=0;t<b.length-1;t++){const e=t+1,r=Math.min(w,t),n=Math.min(w,e);p(b[t],x[r],b[e]),r!==n&&p(x[r],x[n],b[e])}x=b}}}if(l.length){const r=new Float32Array(t.length+l.length),n=new(r.length/3>65535?Uint32Array:Uint16Array)(e.length+c.length);return r.set(t),r.set(l,t.length),n.set(e),n.set(c,e.length),{position:r,indices:n}}return{position:t,indices:e}}(f.position,f.indices,8);f.indices=t,f.position=e}d.attributes.texcoord0.value=f.uv,d.indices=f.indices;const p=t.createMesh(d,n[o.type],r[o.type]);if("buildings"===o.type){let r=new Float32Array(f.position);for(let t=0;t<r.length;t+=3){r[t+2]>0&&(r[t+2]=1)}let n=Qu(f.position,c,rl.radius,rl.curveness,ol[h]);r=Qu(r,c,rl.radius,rl.curveness,ol[h]),d.attributes.position.value=n,d.generateVertexNormals(),d.updateBoundingBox();const o=new Float32Array(r);d.attributes.position.value=o,p.invisible=!0;const a={p:0};i[ol[h]]=t.timeline.animate(a).when(2e3,{p:1}).delay(1e3).during((t,i)=>{p.invisible=!1;for(let t=0;t<o.length;t++){const e=r[t],a=n[t];o[t]=(a-e)*i+e}d.dirty(),e.render()}).start("elasticOut")}else d.attributes.position.value=Qu(f.position,c,rl.radius,rl.curveness,ol[h]),d.generateVertexNormals(),d.updateBoundingBox()}nl.getTiles().tileGrids[0].tiles.forEach((e,r)=>{const n=this._id;if(r>=6)return;const i="https://tile.nextzen.org/tilezen/vector/v1/256/all/{z}/{x}/{y}.mvt?api_key=EWFsMD1DSEysLDWd2hj2cw".replace("{z}",e.z).replace("{x}",e.x).replace("{y}",e.y);if($u.get(i)){const t=$u.get(i);for(let n in t)o(al.find(t=>t.type===n),t[n],e,r)}return fetch(i,{mode:"cors"}).then(t=>t.arrayBuffer()).then(a=>{if(n!==this._id)return;const s=new Hs.a(new Uint8Array(a)),h=new zs.VectorTile(s);if(!h.layers.buildings)return;const u={};["buildings","roads","water"].forEach(t=>{if(h.layers[t]){u[t]=[];for(let r=0;r<h.layers[t].length;r++){const n=h.layers[t].feature(r).toGeoJSON(e.x,e.y,e.z);u[t].push(n)}}}),$u.set(i,u);for(let t in u)o(al.find(e=>e.type===t),u[t],e,r);t.methods.render()})})},generateCloud(t){function e(t){const e=Math.random()*Math.PI*2,r=Math.random()*Math.PI,n=Math.sin(r)*t,i=Math.cos(r)*t;return[Math.cos(e)*n,i,Math.sin(e)*n]}this._cloudsNode.removeAll();for(let r=0;r<15;r++){const r=new Float32Array(1500);let n=0,i=[],o=Math.random()-.5,a=Math.random()-.5;const s=Math.sqrt(o*o+a*a);o/=s,a/=s;const h=4+2*Math.random();for(let t=0;t<5;t++){const s=t-2+(.4*Math.random()-.2),u=3-Math.abs(s),l=[],c=n/3;for(let t=0;t<100;t++){const t=e(Math.random()*u+u);l.push(t),r[n++]=t[0]+s*h*o,r[n++]=t[1]+s*h*a,r[n++]=t[2]}const f=Wu()(l);for(let t=0;t<f.length;t++)i.push(f[t][0]+c),i.push(f[t][1]+c),i.push(f[t][2]+c)}const u=new At;u.attributes.position.value=r,u.initIndicesFromArray(i),u.generateFaceNormals();const l=t.createMesh(u,{roughness:1},this._cloudsNode);l.position.setArray(e(rl.radius/Math.sqrt(2)+20+10*Math.random())),l.lookAt(j.ZERO)}t.methods.render()},updateColor(){this._earthNode.eachChild(t=>{t.material.set("color",rl.earthColor)}),this._cloudsNode.eachChild(t=>{t.material.set("color",rl.cloudColor)});for(let t in this._elementsMaterials)this._elementsMaterials[t].set("color",rl[t+"Color"]);this._advRenderer.render()},render(t){this._advRenderer.render(),setTimeout(()=>{this._advRenderer.render()},20)},updateAutoRotate(){this._control.autoRotateSpeed=50*rl.autoRotateSpeed,this._control.autoRotate=Math.abs(rl.autoRotateSpeed)>.3},updateSky(t){rl.sky?this._skybox.attachScene(t.scene):this._skybox.detachScene(),this._advRenderer.render()},updateVisibility(t){this._earthNode.invisible=!rl.showEarth,this._cloudsNode.invisible=!rl.showCloud,this._elementsNodes.buildings.invisible=!rl.showBuildings,this._elementsNodes.roads.invisible=!rl.showRoads,this._elementsNodes.water.invisible=!rl.showWater,t.methods.render()}}});let hl;il.on("moveend",function(){clearTimeout(hl),hl=setTimeout(function(){sl.methods.updateElements()},500)}),il.on("zoomend",function(){clearTimeout(hl),hl=setTimeout(function(){sl.methods.updateElements()},500)});const ul=new Xh;ul.add(rl,"radius",30,100).step(1).onChange(function(){sl.methods.updateEarthSphere(),sl.methods.updateElements()}),ul.add(rl,"autoRotateSpeed",-2,2).step(.01).onChange(sl.methods.updateAutoRotate),ul.add(rl,"sky").onChange(sl.methods.updateSky);const ll=ul.addFolder("Earth");ll.add(rl,"showEarth").onChange(sl.methods.updateVisibility),ll.addColor(rl,"earthColor").onChange(sl.methods.updateColor);const cl=ul.addFolder("Buildings");cl.add(rl,"showBuildings").onChange(sl.methods.updateVisibility),cl.addColor(rl,"buildingsColor").onChange(sl.methods.updateColor);const fl=ul.addFolder("Roads");fl.add(rl,"showRoads").onChange(sl.methods.updateVisibility),fl.addColor(rl,"roadsColor").onChange(sl.methods.updateColor);const dl=ul.addFolder("Water");dl.add(rl,"showWater").onChange(sl.methods.updateVisibility),dl.addColor(rl,"waterColor").onChange(sl.methods.updateColor);const pl=ul.addFolder("Cloud");pl.add(rl,"showCloud").onChange(sl.methods.updateVisibility),pl.addColor(rl,"cloudColor").onChange(sl.methods.updateColor),pl.add(rl,"randomCloud"),ul.add(rl,"downloadOBJ"),window.addEventListener("resize",()=>{sl.resize(),sl.methods.render()})},function(t,e,r){"use strict";r.r(e),function(t,n,i){r.d(e,"Util",function(){return Ut}),r.d(e,"DomUtil",function(){return nr}),r.d(e,"StringUtil",function(){return Me}),r.d(e,"MapboxUtil",function(){return Rt}),r.d(e,"ui",function(){return yo}),r.d(e,"control",function(){return Mo}),r.d(e,"renderer",function(){return ba}),r.d(e,"symbolizer",function(){return An}),r.d(e,"animation",function(){return Hn}),r.d(e,"Browser",function(){return ue}),r.d(e,"Ajax",function(){return ir}),r.d(e,"Canvas",function(){return ar}),r.d(e,"Class",function(){return pr}),r.d(e,"Eventable",function(){return cr}),r.d(e,"JSONAble",function(){return gr}),r.d(e,"Handlerable",function(){return _r}),r.d(e,"Handler",function(){return dr}),r.d(e,"DragHandler",function(){return xr}),r.d(e,"MapTool",function(){return Ci}),r.d(e,"DrawTool",function(){return Ai}),r.d(e,"AreaTool",function(){return io}),r.d(e,"DistanceTool",function(){return no}),r.d(e,"SpatialReference",function(){return rn}),r.d(e,"INTERNAL_LAYER_PREFIX",function(){return o}),r.d(e,"GEOMETRY_COLLECTION_TYPES",function(){return a}),r.d(e,"GEOJSON_TYPES",function(){return s}),r.d(e,"RESOURCE_PROPERTIES",function(){return h}),r.d(e,"RESOURCE_SIZE_PROPERTIES",function(){return u}),r.d(e,"NUMERICAL_PROPERTIES",function(){return l}),r.d(e,"COLOR_PROPERTIES",function(){return c}),r.d(e,"projection",function(){return Wr}),r.d(e,"measurer",function(){return Br}),r.d(e,"Coordinate",function(){return br}),r.d(e,"CRS",function(){return wr}),r.d(e,"Extent",function(){return Er}),r.d(e,"Point",function(){return ce}),r.d(e,"PointExtent",function(){return Cr}),r.d(e,"Size",function(){return fe}),r.d(e,"Transformation",function(){return Sr}),r.d(e,"Map",function(){return on}),r.d(e,"Layer",function(){return $r}),r.d(e,"TileLayer",function(){return Do}),r.d(e,"GroupTileLayer",function(){return Io}),r.d(e,"WMSTileLayer",function(){return Fo}),r.d(e,"CanvasTileLayer",function(){return Bo}),r.d(e,"ImageLayer",function(){return Xo}),r.d(e,"OverlayLayer",function(){return bi}),r.d(e,"VectorLayer",function(){return Ti}),r.d(e,"CanvasLayer",function(){return $o}),r.d(e,"ParticleLayer",function(){return ta}),r.d(e,"TileSystem",function(){return Po}),r.d(e,"TileConfig",function(){return Lo}),r.d(e,"ArcCurve",function(){return ui}),r.d(e,"Circle",function(){return ii}),r.d(e,"ConnectorLine",function(){return vi}),r.d(e,"ArcConnectorLine",function(){return xi}),r.d(e,"CubicBezierCurve",function(){return li}),r.d(e,"Curve",function(){return hi}),r.d(e,"Ellipse",function(){return oi}),r.d(e,"GeoJSON",function(){return ni}),r.d(e,"Geometry",function(){return On}),r.d(e,"GeometryCollection",function(){return Yn}),r.d(e,"Label",function(){return gi}),r.d(e,"LineString",function(){return qn}),r.d(e,"Marker",function(){return Zn}),r.d(e,"MultiLineString",function(){return ti}),r.d(e,"MultiPoint",function(){return Qn}),r.d(e,"MultiPolygon",function(){return ei}),r.d(e,"Polygon",function(){return Vn}),r.d(e,"QuadBezierCurve",function(){return ci}),r.d(e,"Rectangle",function(){return ai}),r.d(e,"Sector",function(){return si}),r.d(e,"TextBox",function(){return mi}),r.d(e,"TextMarker",function(){return pi});
/*!
 * maptalks v0.40.5
 * LICENSE : BSD-3-Clause
 * (c) 2016-2018 maptalks.org
 */
var o="_maptalks__internal_layer_",a=["MultiPoint","MultiLineString","MultiPolygon","GeometryCollection"],s=["FeatureCollection","Feature","Point","LineString","Polygon"].concat(a),h=["markerFile","polygonPatternFile","linePatternFile","markerFillPatternFile","markerLinePatternFile"],u=[["markerWidth","markerHeight"],[],[null,"lineWidth"],[],[null,"markerLineWidth"]],l={lineWidth:1,lineOpacity:1,lineDx:1,lineDy:1,polygonOpacity:1,markerWidth:1,markerHeight:1,markerDx:1,markerDy:1,markerOpacity:1,markerFillOpacity:1,markerLineWidth:1,markerLineOpacity:1,textSize:1,textOpacity:1,textHaloRadius:1,textWrapWidth:1,textLineSpacing:1,textDx:1,textDy:1},c=["lineColor","polygonFill","markerFill","markerLineColor","textFill"];var f="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},d=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},p=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):function(t,e){for(var r=Object.getOwnPropertyNames(e),n=0;n<r.length;n++){var i=r[n],o=Object.getOwnPropertyDescriptor(e,i);o&&o.configurable&&void 0===t[i]&&Object.defineProperty(t,i,o)}}(t,e))},m=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e};function g(){return Date.now()}function _(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var n in r)t[n]=r[n]}return t}function y(t){return null==t}function v(t){return"number"==typeof t&&!isNaN(t)}function x(t){return(0|t)===t}function b(t){return"object"===(void 0===t?"undefined":f(t))&&!!t}function w(t){return!y(t)&&("string"==typeof t||null!==t.constructor&&t.constructor===String)}function T(t){return!y(t)&&("function"==typeof t||null!==t.constructor&&t.constructor===Function)}var E=Object.prototype.hasOwnProperty;function C(t,e){return E.call(t,e)}var S=Math.PI/180;function A(t){return t*S}function M(t){return t/S}var P="[object process]"===Object.prototype.toString.call(void 0!==t?t:0)&&!t.versions.electron&&!t.versions.nw&&!t.versions["node-webkit"],R=void 0,L=void 0;function O(t){return t.length>4&&".svg"===t.slice(-4)?1:"data:image/svg+xml"===t.slice(0,"data:image/svg+xml".length)?2:0}function k(t,e){P&&k.node?k.node(t,e):t.src=e[0]}!function(){if(P)return R=function(t){return setTimeout(t,16)},void(L=clearTimeout);var t=void 0,e=void 0,r=1e3/30;function n(t){return setTimeout(t,r)}function i(t){return window["webkit"+t]||window["moz"+t]||window["ms"+t]}"undefined"!=typeof window?(t=window.requestAnimationFrame||i("RequestAnimationFrame")||n,e=window.cancelAnimationFrame||i("CancelAnimationFrame")||i("CancelRequestAnimationFrame")||function(t){window.clearTimeout(t)}):(t=n,e=clearTimeout),R=function(e){return t(e)},L=function(t){t&&e(t)}}();var D=0;function I(){return D++}var N=I;function F(t){return t&&w(t)?JSON.parse(t):t}function B(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];if(r)for(var n=0,i=r.length;n<i;n++)t.push(r[n])}return t.length}function z(t,e){var r=e.indexOf(t);r>-1&&e.splice(r,1)}function U(t,e,r){if(!Array.isArray(t))return r?e.call(r,t):e(t);for(var n=[],i=void 0,o=void 0,a=0,s=t.length;a<s;a++)y(i=t[a])?n.push(null):Array.isArray(i)?n.push(U(i,e,r)):(o=r?e.call(r,i):e(i),n.push(o));return n}function H(t,e){return void 0===t?e:t}function j(t){return Math.sign?Math.sign(t):0===(t=+t)||isNaN(t)?Number(t):t>0?1:-1}function G(t){if(Math.log2)return Math.log2(t);var e=Math.log(t)*Math.LOG2E,r=Math.round(e);return Math.abs(r-e)<1e-14?r:e}function V(t,e,r){return t*(1-r)+e*r}function W(t,e,r){if(t===r||t===e)return t;var n=r-e;return((t-e)%n+n)%n+e}function Z(t,e,r){return Math.min(r,Math.max(e,t))}function X(t){return Array.isArray(t)&&t.length>0}function q(t){if(!t)return!1;var e=t.slice(0,6);return"http:/"===e||"https:"===e||"file:/"===e}var Y=/^url\((['"])(.+)\1\)$/i,J=/^url\(([^'"].*[^'"])\)$/i;function K(t){if(!w(t))return 0;var e=t.slice(0,6);return"http:/"===e||"https:"===e?3:J.test(t)?1:Y.test(t)?2:0}function Q(t){var e=K(t);return 3===e?t:1===e?J.exec(t)[1]:2===e?Y.exec(t)[2]:t}var $="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";function tt(t){if("undefined"!=typeof window&&window.btoa)return window.btoa(t);for(var e,r,n=String(t),i="",o=0,a=$;n.charAt(0|o)||(a="=",o%1);i+=a.charAt(63&e>>8-o%1*8)){if((r=n.charCodeAt(o+=.75))>255)throw new Error("'btoa' failed: The string to be encoded contains characters outside of the Latin1 range.");e=e<<8|r}return i}function et(t,e){for(var r=atob(t),n=new ArrayBuffer(r.length),i=new Uint8Array(n),o=0;o<r.length;o++)i[o]=255&r.charCodeAt(o);return new Blob([n],{type:e})}function rt(t,e,r,n){var i=r-t,o=n-e;return Math.atan2(o,i)}var nt="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";function it(t,e){if(!t&&!e)return!0;if(!t||!e)return!1;for(var r in t)if("center"===r){if(!e[r]||!ot(t[r][0],e[r][0])||!ot(t[r][1],e[r][1]))return!1}else if(t[r]!==e[r])return!1;return!0}function ot(t,e,r){return null==r&&(r=1e-6),t>=e-r&&t<=e+r}function at(t,e,r,n){t||(t=100),e||(e=4);var i=this;return e*=2,this._flashTimeout&&clearTimeout(this._flashTimeout),this._flashTimeout=setTimeout(function o(){if(0===e)return i.show(),void(r&&(n?r.call(n):r()));e%2==0?i.hide():i.show(),e--,i._flashTimeout=setTimeout(o,t)},t),this}var st=["Unknown","Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon","GeometryCollection"];function ht(t){return new Function("f","var p = (f && f.properties || {}); return "+ut(t))}function ut(t){if(!t)return"true";var e=t[0];return t.length<=1?"any"===e?"false":"true":"("+("=="===e?ct(t[1],t[2],"===",!1):"!="===e?ct(t[1],t[2],"!==",!1):"<"===e||">"===e||"<="===e||">="===e?ct(t[1],t[2],e,!0):"any"===e?ft(t.slice(1),"||"):"all"===e?ft(t.slice(1),"&&"):"none"===e?mt(ft(t.slice(1),"||")):"in"===e?dt(t[1],t.slice(2)):"!in"===e?mt(dt(t[1],t.slice(2))):"has"===e?pt(t[1]):"!has"===e?mt(pt(t[1])):"true")+")"}function lt(t){return"$"===t[0]?"f."+t.substring(1):"p["+JSON.stringify(t)+"]"}function ct(t,e,r,n){var i=lt(t),o="$type"===t?st.indexOf(e):JSON.stringify(e);return(n?"typeof "+i+"=== typeof "+o+"&&":"")+i+r+o}function ft(t,e){return t.map(ut).join(e)}function dt(t,e){"$type"===t&&(e=e.map(function(t){return st.indexOf(t)}));var r=JSON.stringify(e.sort(gt)),n=lt(t);return e.length<=200?r+".indexOf("+n+") !== -1":"function(v, a, i, j) {while (i <= j) { var m = (i + j) >> 1;    if (a[m] === v) return true; if (a[m] > v) j = m - 1; else i = m + 1;}return false; }("+n+", "+r+",0,"+(e.length-1)+")"}function pt(t){return"$id"===t?'"id" in f':JSON.stringify(t)+" in p"}function mt(t){return"!("+t+")"}function gt(t,e){return t<e?-1:t>e?1:0}function _t(t){var e=t._toJSON(),r=e.feature;return r.type=st.indexOf(r.geometry.type),r.subType=e.subType,r}function yt(t){if(!Array.isArray(t))return yt([t]);for(var e=[],r=0;r<t.length;r++){var n=void 0;n=!0===t[r].filter?function(){return!0}:ht(t[r].filter),e.push(_({},t[r],{filter:n}))}return e}function vt(t,e){var r;if(Ct(t)){var n,i=t.stops&&"object"===f(t.stops[0][0]),o=i||void 0!==t.property,a=i||!o,s=t.type||e||"exponential";if("exponential"===s)n=wt;else if("interval"===s)n=bt;else if("categorical"===s)n=xt;else{if("identity"!==s)throw new Error('Unknown function type "'+s+'"');n=Tt}if(i){for(var h={},u=[],l=0;l<t.stops.length;l++){var c=t.stops[l];void 0===h[c[0].zoom]&&(h[c[0].zoom]={zoom:c[0].zoom,type:t.type,property:t.property,stops:[]}),h[c[0].zoom].stops.push([c[0].value,c[1]])}for(var d in h)u.push([h[d].zoom,vt(h[d])]);(r=function(e,r){return wt({stops:u,base:t.base},e)(e,r)}).isFeatureConstant=!1,r.isZoomConstant=!1}else a?((r=function(e){return n(t,e)}).isFeatureConstant=!0,r.isZoomConstant=!1):((r=function(e,r){return n(t,r[t.property])}).isFeatureConstant=!1,r.isZoomConstant=!0)}else(r=function(){return t}).isFeatureConstant=!0,r.isZoomConstant=!0;return r}function xt(t,e){for(var r=0;r<t.stops.length;r++)if(e===t.stops[r][0])return t.stops[r][1];return t.stops[0][1]}function bt(t,e){for(var r=0;r<t.stops.length&&!(e<t.stops[r][0]);r++);return t.stops[Math.max(r-1,0)][1]}function wt(t,e){for(var r=void 0!==t.base?t.base:1,n=0;!(n>=t.stops.length||e<=t.stops[n][0]);)n++;return 0===n?t.stops[n][1]:n===t.stops.length?t.stops[n-1][1]:function t(e,r,n,i,o,a){return"function"==typeof o?function(){var s=o.apply(void 0,arguments),h=a.apply(void 0,arguments);return t(e,r,n,i,s,h)}:o.length?function(t,e,r,n,i,o){for(var a=[],s=0;s<i.length;s++)a[s]=Et(t,e,r,n,i[s],o[s]);return a}(e,r,n,i,o,a):Et(e,r,n,i,o,a)}(e,r,t.stops[n-1][0],t.stops[n][0],t.stops[n-1][1],t.stops[n][1])}function Tt(t,e){return e}function Et(t,e,r,n,i,o){var a,s=n-r,h=t-r;return i*(1-(a=1===e?h/s:(Math.pow(e,h)-1)/(Math.pow(e,s)-1)))+o*a}function Ct(t){return t&&"object"===(void 0===t?"undefined":f(t))&&(t.stops||t.property&&"identity"===t.type)}function St(t){for(var e in t)if(Ct(t[e]))return!0;return!1}function At(t){return vt(t,"exponential")}function Mt(t,e){if(!t)return null;var r=!1;if(Array.isArray(t)){for(var n,i=[],o=0;o<t.length;o++)(n=Mt(t[o],e))?(i.push(n),r=!0):i.push(t[o]);return r?i:t}var a,s={__fn_types_loaded:!0},h=[];for(a in t)t.hasOwnProperty(a)&&h.push(a);for(var u=0,l=h.length;u<l;u++)Ct(t[a=h[u]])?(r=!0,s["_"+a]=t[a],function(t){Object.defineProperty(s,t,{get:function(){return this["__fn_"+t]||(this["__fn_"+t]=At(this["_"+t])),this["__fn_"+t].apply(this,e())},set:function(e){this["_"+t]=e},configurable:!0,enumerable:!0})}(a)):s[a]=t[a];return r?s:t}function Pt(t){if(!t||!t.stops)return[];for(var e=[],r=0,n=t.stops.length;r<n;r++)e.push(t.stops[r][1]);return e}var Rt=Object.freeze({createFilter:ht,getFilterFeature:_t,compileStyle:yt,isFunctionDefinition:Ct,hasFunctionDefinition:St,interpolated:At,piecewiseConstant:function(t){return vt(t,"interval")},loadFunctionTypes:Mt,getFunctionTypeResources:Pt});function Lt(t){var e={stroke:{stroke:t.markerLineColor,"stroke-width":t.markerLineWidth,"stroke-opacity":t.markerLineOpacity,"stroke-dasharray":null,"stroke-linecap":"butt","stroke-linejoin":"round"},fill:{fill:t.markerFill,"fill-opacity":t.markerFillOpacity}};return"butt"===e.stroke["stroke-linecap"]&&ue.vml&&(e.stroke["stroke-linecap"]="flat"),0===e.stroke["stroke-width"]&&(e.stroke["stroke-opacity"]=0),e}function Ot(t,e,r){if(!t.markerPath)return null;var n=1,i=Lt(t);v(t.markerOpacity)&&(n=t.markerOpacity),v(t.opacity)&&(n*=t.opacity);var o={};if(i){for(var a in i.stroke)i.stroke.hasOwnProperty(a)&&(y(i.stroke[a])||(o[a]=i.stroke[a]));for(var s in i.fill)i.fill.hasOwnProperty(s)&&(y(i.fill[s])||(o[s]=i.fill[s]))}for(var h=Array.isArray(t.markerPath)?t.markerPath:[t.markerPath],u=void 0,l=[],c=0;c<h.length;c++)(u=_({},u=w(h[c])?{path:h[c]}:h[c],o)).d=u.path,delete u.path,l.push(u);var f=['<svg version="1.1"','xmlns="http://www.w3.org/2000/svg"'];n<1&&f.push('opacity="'+n+'"'),t.markerPathWidth&&t.markerPathHeight&&f.push('viewBox="0 0 '+t.markerPathWidth+" "+t.markerPathHeight+'"'),f.push('preserveAspectRatio="none"'),e&&f.push('width="'+e+'"'),r&&f.push('height="'+r+'"'),f.push("><defs></defs>");for(var d=0;d<l.length;d++){var p="<path ";for(var m in l[d])l[d].hasOwnProperty(m)&&(p+=" "+m+'="'+l[d][m]+'"');p+="></path>",f.push(p)}return f.push("</svg>"),"data:image/svg+xml;base64,"+tt(f.join(" "))}function kt(t,e){if(!t)return[];var r=t;Array.isArray(t)||(r=[t]);for(var n=[],i=h,o=void 0,a=void 0,s=void 0,l=void 0,c=r.length-1;c>=0;c--)if(t=r[c]){e&&(t=Dt(t));for(var f=0;f<i.length;f++)if(Ct(o=t[i[f]])&&(o=Pt(o)),o){Array.isArray(o)||(o=[o]);for(var d=0;d<o.length;d++)"url("===o[d].slice(0,4)&&(o[d]=Q(o[d])),a=u[f],n.push([o[d],t[a[0]],t[a[1]]])}if("path"===t.markerType&&t.markerPath)if(s=Ct(t.markerWidth)?200:t.markerWidth,l=Ct(t.markerHeight)?200:t.markerHeight,Ct(t.markerPath)){o=Pt(t.markerPath);for(var p=t.markerPath,m=0;m<o.length;m++)t.markerPath=o[m],n.push([Ot(t),s,l]);t.markerPath=p}else n.push([Ot(t),s,l])}return n}function Dt(t){if(!t)return null;var e=t;if(P)return e;for(var r=h,n=void 0,i=0,o=r.length;i<o;i++)(n=e[r[i]])&&(e[r[i]]=It(n));return e}function It(t){if(Ct(t)){for(var e=t.stops,r=0;r<e.length;r++)e[r][1]=It(e[r][1]);return t}return"url("===t.slice(0,4)&&(t=Q(t)),!q(t)&&(t.length<="data:".length||"data:"!==t.substring(0,"data:".length))&&(t=function(t,e){var r=t.split("/"),n=e.split("/");if(0===e.slice(0,1))return r.slice(0,3).join("/")+e;r.pop();for(var i=0;i<n.length;i++)"."!==n[i]&&(".."===n[i]?r.pop():r.push(n[i]));return r.join("/")}(location.href,t)),t}function Nt(t){return t&&t.colorStops}function Ft(t){var e=[t.type];if(t.places&&e.push(t.places.join()),t.colorStops){for(var r=[],n=t.colorStops.length-1;n>=0;n--)r.push(t.colorStops[n].join());e.push(r.join(","))}return e.join("_")}function Bt(t,e){function r(t,e){y(t.opacity)?t.opacity=e:t.opacity*=e}var n=void 0;if(Array.isArray(t)){n=[];for(var i=0;i<t.length;i++){var o=_({},t[i]);r(o,e),n.push(o)}}else r(n=_({},t),e);return n}function zt(t){var e=Array.prototype.slice.call(arguments,1);if(e&&e.length||(e=[{}]),Array.isArray(t)){for(var r=void 0,n=void 0,i=[],o=0,a=t.length;o<a;o++){r=t[o],n={};for(var s=0,h=e.length;s<h;s++)Array.isArray(e[s])?y(e[s][o])?_(n,r||{}):_(n,r,e[s][o]):_(n,r,e[s]?e[s]:{});i.push(n)}return i}var u=[{},t];return u.push.apply(u,e),_.apply(this,u)}var Ut=Object.freeze({now:g,extend:_,isNil:y,isNumber:v,isInteger:x,isObject:b,isString:w,isFunction:T,hasOwn:C,join:function(t,e){return t.join?t.join(e||","):Array.prototype.join.call(t,e||",")},toRadian:A,toDegree:M,IS_NODE:P,get requestAnimFrame(){return R},get cancelAnimFrame(){return L},isSVG:O,loadImage:k,UID:I,GUID:N,parseJSON:F,pushIn:B,removeFromArray:z,forEachCoord:U,getValueOrDefault:H,sign:j,log2:G,interpolate:V,wrap:W,clamp:Z,isArrayHasData:X,isURL:q,isCssUrl:K,extractCssUrl:Q,btoa:tt,b64toBlob:et,computeDegree:rt,emptyImageUrl:nt,equalMapView:it,flash:at,translateToSVGStyles:Lt,getMarkerPathBase64:Ot,getExternalResources:kt,convertResourceUrl:Dt,isGradient:Nt,getGradientStamp:Ft,getSymbolStamp:function t(e){var r=[];if(Array.isArray(e)){for(var n=0;n<e.length;n++)r.push(t(e[n]));return"[ "+r.join(" , ")+" ]"}for(var i in e)C(e,i)&&(T(e[i])||(Nt(e[i])?r.push(i+"="+Ft(e[i])):r.push(i+"="+e[i])));return r.join(";")},lowerSymbolOpacity:Bt,extendSymbol:zt}),Ht={};if(!P){var jt=navigator.userAgent.toLowerCase(),Gt=document.documentElement,Vt="ActiveXObject"in window,Wt=-1!==jt.indexOf("webkit"),Zt=-1!==jt.indexOf("phantom"),Xt=-1!==jt.search("android [23]"),qt=-1!==jt.indexOf("chrome"),Yt=-1!==jt.indexOf("gecko")&&!Wt&&!window.opera&&!Vt,Jt="undefined"!=typeof orientation||-1!==jt.indexOf("mobile"),Kt=!window.PointerEvent&&window.MSPointerEvent,Qt=window.PointerEvent&&navigator.pointerEnabled||Kt,$t=Vt&&"transition"in Gt.style,te="WebKitCSSMatrix"in window&&"m11"in new window.WebKitCSSMatrix&&!Xt,ee="MozPerspective"in Gt.style,re="OTransition"in Gt.style,ne=($t||te||ee)&&!re&&!Zt,ie=0;qt&&(ie=jt.match(/chrome\/([\d.]+)/)[1]);var oe=!Zt&&(Qt||"ontouchstart"in window||window.DocumentTouch&&document instanceof window.DocumentTouch),ae=void 0;try{var se=document.createElement("canvas"),he=se.getContext("webgl")||se.getContext("experimental-webgl");ae=he&&he instanceof WebGLRenderingContext}catch(t){ae=!1}Ht={ie:Vt,ielt9:Vt&&!document.addEventListener,edge:"msLaunchUri"in navigator&&!("documentMode"in document),webkit:Wt,gecko:Yt,android:-1!==jt.indexOf("android"),android23:Xt,chrome:qt,chromeVersion:ie,safari:!qt&&-1!==jt.indexOf("safari"),phantomjs:Zt,ie3d:$t,webkit3d:te,gecko3d:ee,opera12:re,any3d:ne,mobile:Jt,mobileWebkit:Jt&&Wt,mobileWebkit3d:Jt&&te,mobileOpera:Jt&&window.opera,mobileGecko:Jt&&Yt,touch:!!oe,msPointer:!!Kt,pointer:!!Qt,retina:(window.devicePixelRatio||window.screen.deviceXDPI/window.screen.logicalXDPI)>1,language:navigator.browserLanguage?navigator.browserLanguage:navigator.language,ie9:Vt&&9===document.documentMode,ie10:Vt&&10===document.documentMode,webgl:ae}}var ue=Ht,le=function(){function t(e,r){if(d(this,t),y(e)||y(r)?y(e.x)||y(e.y)?Array.isArray(e)&&(this.x=+e[0],this.y=+e[1]):(this.x=+e.x,this.y=+e.y):(this.x=+e,this.y=+r),this._isNaN())throw new Error("Position is NaN")}return t.prototype.abs=function(){return new this.constructor(Math.abs(this.x),Math.abs(this.y))},t.prototype._abs=function(){return this.x=Math.abs(this.x),this.y=Math.abs(this.y),this},t.prototype._round=function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},t.prototype.round=function(){return new this.constructor(Math.round(this.x),Math.round(this.y))},t.prototype._ceil=function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this},t.prototype.ceil=function(){return new this.constructor(Math.ceil(this.x),Math.ceil(this.y))},t.prototype._floor=function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this},t.prototype.floor=function(){return new this.constructor(Math.floor(this.x),Math.floor(this.y))},t.prototype.copy=function(){return new this.constructor(this.x,this.y)},t.prototype._add=function(t,e){return y(t.x)?y(t[0])?(this.x+=t,this.y+=e):(this.x+=t[0],this.y+=t[1]):(this.x+=t.x,this.y+=t.y),this},t.prototype.add=function(t,e){var r=void 0,n=void 0;return y(t.x)?y(t[0])?(r=this.x+t,n=this.y+e):(r=this.x+t[0],n=this.y+t[1]):(r=this.x+t.x,n=this.y+t.y),new this.constructor(r,n)},t.prototype._sub=function(t,e){return y(t.x)?y(t[0])?(this.x-=t,this.y-=e):(this.x-=t[0],this.y-=t[1]):(this.x-=t.x,this.y-=t.y),this},t.prototype._substract=function(){return this._sub.apply(this,arguments)},t.prototype.sub=function(t,e){var r=void 0,n=void 0;return y(t.x)?y(t[0])?(r=this.x-t,n=this.y-e):(r=this.x-t[0],n=this.y-t[1]):(r=this.x-t.x,n=this.y-t.y),new this.constructor(r,n)},t.prototype.substract=function(){return this.sub.apply(this,arguments)},t.prototype.multi=function(t){return new this.constructor(this.x*t,this.y*t)},t.prototype._multi=function(t){return this.x*=t,this.y*=t,this},t.prototype.div=function(t){return this.multi(1/t)},t.prototype._div=function(t){return this._multi(1/t)},t.prototype.equals=function(t){return t instanceof this.constructor&&(this.x===t.x&&this.y===t.y)},t.prototype._isNaN=function(){return isNaN(this.x)||isNaN(this.y)},t.prototype.isZero=function(){return 0===this.x&&0===this.y},t.prototype.toArray=function(){return[this.x,this.y]},t.prototype.toFixed=function(t){return new this.constructor(this.x.toFixed(t),this.y.toFixed(t))},t.prototype.toJSON=function(){return{x:this.x,y:this.y}},t}(),ce=function(t){function e(){return d(this,e),m(this,t.apply(this,arguments))}return p(e,t),e.prototype.closeTo=function(t,e){return e||(e=0),this.x>=t.x-e&&this.x<=t.x+e&&this.y>=t.y-e&&this.y<=t.y+e},e.prototype.distanceTo=function(t){var e=t.x-this.x,r=t.y-this.y;return Math.sqrt(e*e+r*r)},e.prototype.mag=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},e.prototype.unit=function(){return this.copy()._unit()},e.prototype._unit=function(){return this._div(this.mag()),this},e.prototype.perp=function(){return this.copy()._perp()},e.prototype._perp=function(){var t=this.y;return this.y=this.x,this.x=-t,this},e.prototype.angleWith=function(t){return this.angleWithSep(t.x,t.y)},e.prototype.angleWithSep=function(t,e){return Math.atan2(this.x*e-this.y*t,this.x*t+this.y*e)},e.prototype._rotate=function(t){var e=Math.cos(t),r=Math.sin(t),n=e*this.x-r*this.y,i=r*this.x+e*this.y;return this.x=n,this.y=i,this},e.prototype.rotate=function(t){return this.copy()._rotate(t)},e}(le),fe=function(){function t(e,r){d(this,t),v(e)&&v(r)?(this.width=e,this.height=r):v(e.width)?(this.width=e.width,this.height=e.height):Array.isArray(e)&&(this.width=e[0],this.height=e[1])}return t.prototype.copy=function(){return new t(this.width,this.height)},t.prototype.add=function(e,r){var n=void 0,i=void 0;return e instanceof t?(n=this.width+e.width,i=this.height+e.height):(n=this.width+e,i=this.height+r),new t(n,i)},t.prototype.equals=function(t){return this.width===t.width&&this.height===t.height},t.prototype.multi=function(e){return new t(this.width*e,this.height*e)},t.prototype._multi=function(t){return this.width*=t,this.height*=t,this},t.prototype._round=function(){return this.width=Math.round(this.width),this.height=Math.round(this.height),this},t.prototype.toPoint=function(){return new ce(this.width,this.height)},t.prototype.toArray=function(){return[this.width,this.height]},t.prototype.toJSON=function(){return{width:this.width,height:this.height}},t}();function de(t){return t.trim?t.trim():t.replace(/^\s+|\s+$/g,"")}var pe=/[\b\t\r\v\f]/gim;function me(t){return w(t)?t.replace(pe,""):t}function ge(t){return de(t).split(/\s+/)}var _e="undefined"!=typeof document?document.createElement("canvas").getContext("2d"):null;function ye(t,e){return ye.node?ye.node(t,e):(_e.font=e,_e.measureText(t).width)}var ve={};function xe(t,e){if(xe.node)return xe.node(t,e);var r=ye(t,e);return e||(e="_default_"),ve[e]||(ve[e]=be(e)),new fe(r,ve[e])}function be(t){var e=tr();"_default_"!==t&&(e.style.font=t),e.innerHTML="";var r=e.clientHeight;return Ne(e),r}function we(t,e,r,n){if(!t||0===t.length)return[{text:"",width:0}];var i=y(n)?ye(t,e):n,o=i/t.length,a=Math.floor(r/o/2);if(o>=r||a<=0)return[{text:"",width:r}];if(i<=r)return[{text:t,width:i}];for(var s=[],h=t.substring(0,a),u=o*a,l=a,c=t.length;l<c;l++){var f=t[l],d=ye(h+f);d>=r?(s.push({text:h,width:u}),h=t.substring(l,a+l),l+=a-1,u=o*a):(h+=f,u=d),l>=c-1&&(u=ye(h),s.push({text:h,width:u}))}return s}var Te=/\{([\w_]+)\}/g;function Ee(t,e){return w(t)?t.replace(Te,function(t,r){if(!e)return"";var n=e[r];return y(n)?"":Array.isArray(n)?n.join():n}):t}function Ce(t,e,r){var n=t.width,i=t.height;return new ce("left"===e?-n:"right"===e?0:-n/2,"top"===r?-i:"bottom"===r?0:-i/2)}function Se(t){return t.textFont?t.textFont:(t.textStyle&&"normal"!==t.textStyle?t.textStyle+" ":"")+(t.textWeight&&"normal"!==t.textWeight?t.textWeight+" ":"")+t.textSize+"px "+('"'===t.textFaceName[0]?t.textFaceName:'"'+t.textFaceName+'"')}function Ae(t,e){var r=Se(e),n=e.textLineSpacing||0,i=xe(t,r),o=i.width,a=i.height,s=e.textWrapCharacter,h=[],u=e.textWrapWidth;(!u||u>o)&&(u=o),w(t)||(t+="");var l=0;if(s&&t.indexOf(s)>=0)for(var c=t.split(s),f=0,d=c.length;f<d;f++){var p=c[f],m=ye(p,r);if(m>u)for(var g=we(p,r,u,m),_=0,y=g.length;_<y;_++){var v=g[_].width;v>l&&(l=v),h.push({text:g[_].text,size:new fe(v,a)})}else m>l&&(l=m),h.push({text:p,size:new fe(m,a)})}else if(o>u)for(var x=we(t,r,u,o),b=0;b<x.length;b++){var T=x[b].width;T>l&&(l=T),h.push({text:x[b].text,size:new fe(T,a)})}else o>l&&(l=o),h.push({text:t,size:i});var E=h.length;return{total:E,size:new fe(l,a*E+n*(E-1)),rows:h,rawSize:i}}var Me=Object.freeze({trim:de,escapeSpecialChars:me,splitWords:ge,stringWidth:ye,stringLength:xe,getFontHeight:be,splitContent:we,replaceVariable:Ee,getAlignPoint:Ce,getFont:Se,splitTextToRow:Ae}),Pe=P?function(t){return t[0]}:function(t){for(var e=document.documentElement.style,r=0;r<t.length;r++)if(t[r]in e)return t[r];return!1},Re=Pe(["transform","WebkitTransform","OTransform","MozTransform","msTransform"]),Le=Pe(["transformOrigin","WebkitTransformOrigin","OTransformOrigin","MozTransformOrigin","msTransformOrigin"]),Oe=Pe(["transition","WebkitTransition","OTransition","MozTransition","msTransition"]),ke=Pe(["filter","WebkitFilter","OFilter","MozFilter","msFilter"]);function De(t,e){var r=document.createElement(t);return e&&Ye(r,e),r}function Ie(t,e,r){var n=De(t);return e&&Ze(n,e),r&&r.appendChild(n),n}function Ne(t){if(!t)return this;if(ue.ielt9||ue.ie9){var e=De("div");e.appendChild(t),e.innerHTML="",e=null}else t.parentNode&&t.parentNode.removeChild(t);return this}function Fe(t,e,r,n){if(!(t&&t.addEventListener&&e&&r))return this;for(var i=function(e){e||(e=window.event),r.call(n||t,e)},o=e.split(" "),a=o.length-1;a>=0;a--){var s=o[a];if(s)t["Z__"+s]||(t["Z__"+s]=[]),ze(t,s,r)>=0&&Be(t,s,r),t["Z__"+s].push({callback:i,src:r}),"mousewheel"===s&&ue.gecko&&(s="DOMMouseScroll"),t.addEventListener(s,i,!1)}return this}function Be(t,e,r){function n(e,r){"mousewheel"===e&&ue.gecko&&(e="DOMMouseScroll"),t.removeEventListener(e,r,!1)}if(!t||!t.removeEventListener||!e)return this;for(var i=e.split(" "),o=i.length-1;o>=0;o--){var a=i[o];if(a){if(!r&&t["Z__"+a]){for(var s=t["Z__"+a],h=0,u=s.length;h<u;h++)n(s[h].callback);return delete t["Z__"+a],this}var l=ze(t,a,r);if(l<0)return this;n(a,t["Z__"+a][l].callback),t["Z__"+a].splice(l,1)}}return this}function ze(t,e,r){if(!t||!t["Z__"+e]||!r)return-1;for(var n=t["Z__"+e],i=0,o=n.length;i<o;i++)if(n[i].src===r)return i;return-1}function Ue(t){return t.preventDefault?t.preventDefault():t.returnValue=!1,this}function He(t){return t.stopPropagation?t.stopPropagation():t.cancelBubble=!0,this}function je(t){return t.onselectstart=function(){return!1},t.ondragstart=function(){return!1},t.setAttribute("unselectable","on"),this}function Ge(t,e){return t?(ue.any3d?Ke(t,e):(t.style.left=e.x+"px",t.style.top=e.y+"px"),e):null}function Ve(t){var e=window.getComputedStyle(t),r=[parseInt(e["padding-left"]),parseInt(e["padding-top"])],n=t.getBoundingClientRect(),i=t.offsetWidth,o=t.offsetHeight,a=i?n.width/i:1,s=o?n.height/o:1;return t.__position=[n.left+r[0],n.top+r[1],a,s],t.__position}function We(t,e){t||(t=window.event);var r=e.__position;return r||(r=Ve(e)),new ce(t.clientX/r[2]-r[0]-e.clientLeft,t.clientY/r[3]-r[1]-e.clientTop)}function Ze(t,e){var r,n,i,o=t.style.cssText;return n=";",(i=(r=o).length-n.length)>=0&&r.indexOf(n,i)===i||(o+=";"),t.style.cssText=o+e,this}function Xe(t,e){if(void 0!==t.classList)return t.classList.contains(e);var r=Je(t);return r.length>0&&new RegExp("(^|\\s)"+e+"(\\s|$)").test(r)}function qe(t,e){if(void 0===t.classList||Xe(t,e)){var r=Je(t);Ye(t,(r?r+" ":"")+e)}else for(var n=ge(e),i=0,o=n.length;i<o;i++)t.classList.add(n[i]);return this}function Ye(t,e){return y(t.className.baseVal)?t.className=e:t.className.baseVal=e,this}function Je(t){return y(t.className.baseVal)?t.className:t.className.baseVal}function Ke(t,e){var r=e||new ce(0,0);return t.style[Re]=ue.any3d?"translate3d("+r.x+"px,"+r.y+"px,0px)":"translate("+r.x+"px,"+r.y+"px)",this}function Qe(t){return/<[a-z\][\s\S]*>/i.test(t)}function $e(t,e){var r=tr(t);w(e)?r.innerHTML=e:r.appendChild(e);var n=new fe(r.clientWidth,r.clientHeight);return Ne(r),n}function tr(t){var e=document.createElement(t);return e.style.cssText="position:absolute;left:-10000px;top:-10000px;",document.body.appendChild(e),e}var er=Fe,rr=Be,nr=Object.freeze({TRANSFORM:Re,TRANSFORMORIGIN:Le,TRANSITION:Oe,CSSFILTER:ke,createEl:De,createElOn:Ie,removeDomNode:Ne,addDomEvent:Fe,removeDomEvent:Be,listensDomEvent:ze,preventDefault:Ue,stopPropagation:He,preventSelection:je,offsetDom:Ge,computeDomPosition:Ve,getEventContainerPoint:We,setStyle:Ze,hasClass:Xe,addClass:qe,setClass:Ye,getClass:Je,setOpacity:function(t,e){return t.style.opacity=e,this},setTransform:Ke,setTransformMatrix:function(t,e){var r="matrix("+(w(e)?e:e.join())+")";return t.style[Re]!==r&&(t.style[Re]=r),this},removeTransform:function(t){return t.style[Re]&&(t.style[Re]=""),this},isHTML:Qe,measureDom:$e,getDomRuler:tr,on:er,off:rr}),ir={jsonp:function(t,e){var r="_maptalks_jsonp_"+I();t.match(/\?/)?t+="&callback="+r:t+="?callback="+r;var n=document.createElement("script");return n.type="text/javascript",n.src=t,window[r]=function(t){e(null,t),document.getElementsByTagName("head")[0].removeChild(n),n=null,delete window[r]},document.getElementsByTagName("head")[0].appendChild(n),this},get:function(t,e,r){if(T(e)){var n=r;r=e,e=n}if(P&&ir.get.node)return ir.get.node(t,r,e);var i=ir._getClient(r);if(i.open("GET",t,!0),e){for(var o in e.headers)i.setRequestHeader(o,e.headers[o]);i.withCredentials="include"===e.credentials,e.responseType&&(i.responseType=e.responseType)}return i.send(null),i},post:function(t,e,r){var n=void 0;if(w(t)){if(T(e)){var i=r;r=e,e=i}n=(e=e||{}).postData}else{var o=r;n=e,t=(e=t).url,r=o}if(P&&ir.post.node)return e.url=t,ir.post.node(e,n,r);var a=ir._getClient(r);if(a.open("POST",e.url,!0),e.headers||(e.headers={}),e.headers["Content-Type"]||(e.headers["Content-Type"]="application/x-www-form-urlencoded"),"setRequestHeader"in a)for(var s in e.headers)e.headers.hasOwnProperty(s)&&a.setRequestHeader(s,e.headers[s]);return w(n)||(n=JSON.stringify(n)),a.send(n),a},_wrapCallback:function(t,e){return function(){4===t.readyState&&(200===t.status?"arraybuffer"===t.responseType?0===t.response.byteLength?e(new Error("http status 200 returned without content.")):e(null,{data:t.response,cacheControl:t.getResponseHeader("Cache-Control"),expires:t.getResponseHeader("Expires"),contentType:t.getResponseHeader("Content-Type")}):e(null,t.responseText):e(new Error(t.statusText+","+t.status)))}},_getClient:function(t){var e=void 0;try{e=new XMLHttpRequest}catch(t){try{e=new ActiveXObject("Msxml2.XMLHTTP")}catch(t){try{e=new ActiveXObject("Microsoft.XMLHTTP")}catch(t){}}}return e.onreadystatechange=ir._wrapCallback(e,t),e},getArrayBuffer:function(t,e,r){if(T(e)){var n=r;r=e,e=n}return e||(e={}),e.responseType="arraybuffer",ir.get(t,e,r)},getImage:function(t,e,r){return ir.getArrayBuffer(e,r,function(e,r){if(e)t.onerror&&t.onerror(e);else if(r){var n=window.URL||window.webkitURL,i=t.onload;t.onload=function(){i&&i(),n.revokeObjectURL(t.src)};var o=new Blob([new Uint8Array(r.data)],{type:r.contentType});t.cacheControl=r.cacheControl,t.expires=r.expires,t.src=r.data.byteLength?n.createObjectURL(o):nt}})},getJSON:function(t,e,r){if(T(e)){var n=r;r=e,e=n}var i=function(t,e){var n=e?F(e):null;r(t,n)};return e&&e.jsonp?ir.jsonp(t,i):ir.get(t,e,i)}},or=!1,ar={setHitTesting:function(t){or=t},createCanvas:function(t,e,r){var n=void 0;return P?n=new r(t,e):((n=De("canvas")).width=t,n.height=e),n},prepareCanvasFont:function(t,e){t.textBaseline="top",t.font=Se(e);var r=e.textFill;r||(r="#000"),t.fillStyle=ar.getRgba(r,e.textOpacity)},prepareCanvas:function(t,e,r,n){if(e){var i=e.lineWidth;y(i)||t.lineWidth===i||(t.lineWidth=i);var o=e.linePatternFile||e.lineColor||"#000";if(n)t.strokeStyle="#000";else if(ur(o)&&r){var a=void 0;(e.linePatternDx||e.linePatternDy)&&(a=[e.linePatternDx,e.linePatternDy]),ar._setStrokePattern(t,o,i,a,r),e.lineDasharray=[]}else Nt(o)?e.lineGradientExtent?t.strokeStyle=ar._createGradient(t,o,e.lineGradientExtent):t.strokeStyle="#000":t.strokeStyle=o;e.lineJoin&&(t.lineJoin=e.lineJoin),e.lineCap&&(t.lineCap=e.lineCap),t.setLineDash&&X(e.lineDasharray)&&t.setLineDash(e.lineDasharray);var s=e.polygonPatternFile||e.polygonFill||"rgba(255,255,255,0)";if(n)t.fillStyle="#000";else if(ur(s)&&r){var h=lr(s),u=r.getImage([h,null,null]);if(u||(u=r.getImage([h+"-texture",null,i])),O(h)&&u instanceof Image&&(ue.edge||ue.ie)){var l=u.width||20,c=u.height||20,f=ar.createCanvas(l,c);ar.image(f.getContext("2d"),u,0,0,l,c),u=f}u?(t.fillStyle=t.createPattern(u,"repeat"),(e.polygonPatternDx||e.polygonPatternDy)&&(t.fillStyle.polygonPatternOffset=[e.polygonPatternDx,e.polygonPatternDy])):"undefined"!=typeof console&&console.warn("img not found for",h)}else Nt(s)?e.polygonGradientExtent?t.fillStyle=ar._createGradient(t,s,e.polygonGradientExtent):t.fillStyle="rgba(255,255,255,0)":t.fillStyle=s}},_createGradient:function(t,e,r){var n=null,i=e.places,o=r.getMin(),a=r.getMax(),s=r.getWidth(),h=r.getHeight();if(e.type&&"linear"!==e.type){if("radial"===e.type){if(i){if(6!==i.length)throw new Error("A radial gradient's places should have 6 numbers.");i=[o.x+i[0]*s,o.y+i[1]*h,s*i[2],o.x+i[3]*s,o.y+i[4]*h,s*i[5]]}else{var u=r.getCenter()._round();i=[u.x,u.y,Math.abs(u.x-o.x),u.x,u.y,0]}n=t.createRadialGradient.apply(t,i)}}else{if(i){if(4!==i.length)throw new Error("A linear gradient's places should have 4 numbers.");i=[o.x+i[0]*s,o.y+i[1]*h,o.x+i[2]*s,o.y+i[3]*h]}else i=[o.x,o.y,a.x,o.y];n=t.createLinearGradient.apply(t,i)}return e.colorStops.forEach(function(t){n.addColorStop.apply(n,t)}),n},_setStrokePattern:function(t,e,r,n,i){var o=lr(e),a=void 0;if(P)a=i.getImage([o,null,r]);else{var s=o+"-texture-"+r;if(!(a=i.getImage(s))){var h=i.getImage([o,null,null]);if(h){var u=void 0;u=h.width&&h.height?Math.round(h.width*r/h.height):r;var l=ar.createCanvas(u,r,t.canvas.constructor);ar.image(l.getContext("2d"),h,0,0,u,r),i.addResource([s,null,r],l),a=l}}}a?(t.strokeStyle=t.createPattern(a,"repeat"),t.strokeStyle.linePatternOffset=n):"undefined"!=typeof console&&console.warn("img not found for",o)},clearRect:function(t,e,r,n,i){t.canvas._drawn=!1,t.clearRect(e,r,n,i)},fillCanvas:function(t,e,r,n){if(or&&(e=1),t.canvas._drawn=!0,0!==e){var i=ar._isPattern(t.fillStyle),o=t.fillStyle&&t.fillStyle.polygonPatternOffset,a=o?o[0]:0,s=o?o[1]:0;y(e)&&(e=1);var h=void 0;e<1&&(h=t.globalAlpha,t.globalAlpha*=e),i&&(r=r||0,n=n||0,t.translate(r+a,n+s)),t.fill(),i&&t.translate(-r-a,-n-s),e<1&&(t.globalAlpha=h)}},getRgba:function(t,e){if(y(e)&&(e=1),"#"!==t[0])return t;var r=void 0,n=void 0,i=void 0;return 7===t.length?(r=parseInt(t.substring(1,3),16),n=parseInt(t.substring(3,5),16),i=parseInt(t.substring(5,7),16)):(r=17*parseInt(t.substring(1,2),16),n=17*parseInt(t.substring(2,3),16),i=17*parseInt(t.substring(3,4),16)),"rgba("+r+","+n+","+i+","+e+")"},image:function(t,e,r,n,i,o){t.canvas._drawn=!0;try{v(i)&&v(o)?t.drawImage(e,r,n,i,o):t.drawImage(e,r,n)}catch(t){console&&(console.warn("error when drawing image on canvas:",t),console.warn(e))}},text:function(t,e,r,n,i){ar._textOnMultiRow(t,i.rows,n,r,i.size,i.rawSize)},_textOnMultiRow:function(t,e,r,n,i,o){for(var a=Ce(i,r.textHorizontalAlignment,r.textVerticalAlignment),s=o.height+r.textLineSpacing,h=n.add(0,a.y),u=r.textMaxHeight,l=void 0,c=void 0,f=0,d=0,p=e.length;d<p&&(l=e[d].text,c=Ce(e[d].size,r.textHorizontalAlignment,r.textVerticalAlignment),ar._textOnLine(t,l,h.add(c.x,d*s),r.textHaloRadius,r.textHaloFill,r.textHaloOpacity),!(u>0&&(f+=s)+o.height>=u));d++);},_textOnLine:function(t,e,r,n,i,o){or&&(o=1);var a=0!==o&&0!==n;t.textBaseline="top";var s=void 0,h=void 0,u=t.shadowBlur,l=t.shadowOffsetX,c=t.shadowOffsetY;if(a){var f=t.globalAlpha;t.globalAlpha*=o,t.miterLimit=2,t.lineJoin="round",t.lineCap="round",t.lineWidth=2*n,t.strokeStyle=i,t.strokeText(e,Math.round(r.x),Math.round(r.y)),t.miterLimit=10,t.globalAlpha=f,s=t.globalCompositeOperation,t.globalCompositeOperation="destination-out",h=t.fillStyle,t.fillStyle="#000"}u&&a&&(t.shadowBlur=t.shadowOffsetX=t.shadowOffsetY=0),ar.fillText(t,e,r),s&&(t.globalCompositeOperation=s,ar.fillText(t,e,r,h),u&&(t.shadowBlur=u,t.shadowOffsetX=l,t.shadowOffsetY=c))},fillText:function(t,e,r,n){t.canvas._drawn=!0,n&&(t.fillStyle=n),t.fillText(e,Math.round(r.x),Math.round(r.y))},_stroke:function(t,e,r,n){if(or&&(e=1),t.canvas._drawn=!0,0!==e){var i=t.strokeStyle&&t.strokeStyle.linePatternOffset,o=i?i[0]:0,a=i?i[1]:0,s=ar._isPattern(t.strokeStyle)&&(!y(r)&&!y(n)||!y(o)&&!y(a));y(e)&&(e=1);var h=void 0;e<1&&(h=t.globalAlpha,t.globalAlpha*=e),s&&(r=r||0,n=n||0,t.translate(r+o,n+a)),t.stroke(),s&&t.translate(-r-o,-n-a),e<1&&(t.globalAlpha=h)}},_path:function(t,e,r,n,i){if(X(e))for(var o,a,s,h=X(r),u=!0!==i&&ar._isPattern(t.strokeStyle),l=void 0,c=void 0,f=void 0,d=0,p=e.length;d<p;d++)if(l=e[d],!h||t.setLineDash)t.lineTo(l.x,l.y),u&&d>0&&(c=e[d-1],a=l,void 0,s=rt((o=c).x,o.y,a.x,a.y),t.save(),t.translate(o.x,o.y-t.lineWidth/2/Math.cos(s)),t.rotate(s),ar._stroke(t,n),t.restore(),t.beginPath(),t.moveTo(l.x,l.y));else if(h){if(d===p-1)break;f=e[d+1],sr(t,l,f,r)}},path:function(t,e,r,n,i){X(e)&&(t.beginPath(),t.moveTo(e[0].x,e[0].y),ar._path(t,e,i,r),ar._stroke(t,r))},polygon:function(t,e,r,n,i,o){if(X(e)){var a=ar._isPattern(t.strokeStyle),s=X(i)&&!t.setLineDash||a&&!o;X(e[0])||(e=[e]);var h=void 0,u=void 0,l=void 0;if(s){for(t.save(),u=0,l=e.length;u<l;u++)X(e[u])&&(ar._ring(t,e[u],null,0,!0),h=n,u>0&&(t.globalCompositeOperation="destination-out",h=1),c(e,u,h),u>0?t.globalCompositeOperation="source-over":l>1&&(t.fillStyle="#fff"),ar._stroke(t,0));t.restore()}for(u=0,l=e.length;u<l;u++)X(e[u])&&(o?(ar.paintSmoothLine(t,e[u],r,o,!0),t.closePath()):ar._ring(t,e[u],i,r),s||(h=n,u>0&&(t.globalCompositeOperation="destination-out",h=1),c(e,u,h),u>0?t.globalCompositeOperation="source-over":l>1&&(t.fillStyle="#fff")),ar._stroke(t,r))}function c(e,r,n){ar.fillCanvas(t,n,e[r][0].x,e[r][0].y)}},_ring:function(t,e,r,n,i){var o=ar._isPattern(t.strokeStyle);i||!o||e[0].equals(e[e.length-1])||(e=e.concat([e[0]])),t.beginPath(),t.moveTo(e[0].x,e[0].y),ar._path(t,e,r,n,i),o||t.closePath()},paintSmoothLine:function(t,e,r,n,i,o,a){if(e)if(e.length<=2||!n)ar.path(t,e,r);else{var s=e.length,h=i?s:s-1;t.beginPath(),t.moveTo(e[0].x,e[0].y),void 0!==a&&(h-=Math.max(h-o-1,0));for(var u=void 0,l=0;l<h;l++){var c=e[l].x,f=e[l].y,d=void 0,p=void 0,m=void 0,g=void 0,_=void 0,y=void 0;l-1<0?i?(d=e[h-1].x,p=e[h-1].y):(d=e[l+1].x,p=e[l+1].y):(d=e[l-1].x,p=e[l-1].y),l+1<s?(m=e[l+1].x,g=e[l+1].y):(m=e[l+1-s].x,g=e[l+1-s].y),l+2<s?(_=e[l+2].x,y=e[l+2].y):i?(_=e[l+2-s].x,y=e[l+2-s].y):(_=e[l].x,y=e[l].y);var v=b(d,p,c,f,m,g,_,y,n,l===h-1?a:1);if(l===h-1&&a>=0&&a<1){t.bezierCurveTo(v[0],v[1],v[2],v[3],v[4],v[5]),e.splice(h-1,s-(h-1)-1);var x=new ce(v[4],v[5]);x.prevCtrlPoint=new ce(v[2],v[3]),e.push(x),s=e.length}else t.bezierCurveTo(v[0],v[1],v[2],v[3],m,g);e[l].nextCtrlPoint=v.slice(0,2),e[l].prevCtrlPoint=u?u.slice(2):null,u=v}!i&&e[1].prevCtrlPoint&&(e[0].nextCtrlPoint=e[1].prevCtrlPoint,delete e[0].prevCtrlPoint),e[s-1].prevCtrlPoint||(e[s-1].prevCtrlPoint=e[s-2].nextCtrlPoint),ar._stroke(t,r)}function b(t,e,r,n,i,o,a,s,h,u){var l=(t+r)/2,c=(e+n)/2,f=(r+i)/2,d=(n+o)/2,p=(i+a)/2,m=(o+s)/2,g=Math.sqrt((r-t)*(r-t)+(n-e)*(n-e)),_=Math.sqrt((i-r)*(i-r)+(o-n)*(o-n)),y=g/(g+_),v=_/(_+Math.sqrt((a-i)*(a-i)+(s-o)*(s-o))),x=l+(f-l)*y,b=c+(d-c)*y,w=f+(p-f)*v,T=d+(m-d)*v,E=x+(f-x)*h+r-x,C=b+(d-b)*h+n-b,S=w+(f-w)*h+i-w,A=T+(d-T)*h+o-T,M=[E,C,S,A];return u<1?function(t,e,r,n,i,o,a,s,h,u){var l=1-t,c=1-e,f=r*c*c+2*i*e*c+a*e*e,d=i*c*c+2*a*e*c+h*e*e,p=n*c*c+2*o*e*c+s*e*e,m=o*c*c+2*s*e*c+u*e*e;return[(r*l*l+2*i*t*l+a*t*t)*c+(i*l*l+2*a*t*l+h*t*t)*e,(n*l*l+2*o*t*l+s*t*t)*c+(o*l*l+2*s*t*l+u*t*t)*e,f*l+d*t,p*l+m*t,f*c+d*e,p*c+m*e]}(0,u,r,n,E,C,S,A,i,o):M}},_arcBetween:function(t,e,r,n){var i=n,o=e.distanceTo(r),a=o/2/Math.sin(i/2),s=Math.asin((r.y-e.y)/o);e.x>r.x&&(s=Math.PI-s);var h=s-(90*Math.PI/180-i/2),u=Math.cos(h)*a,l=Math.sin(h)*a,c=e.x+u,f=e.y+l,d=Math.asin((r.y-f)/a);c>r.x&&(d=Math.PI-d);var p=d+i;return t.beginPath(),t.arc(c,f,a,d,p),[c,f]},_lineTo:function(t,e){t.lineTo(e.x,e.y)},bezierCurveAndFill:function(t,e,r,n){t.beginPath();var i=e[0];t.moveTo(i.x,i.y);var o=[t];o.push.apply(o,e.splice(1)),ar._bezierCurveTo.apply(ar,o),ar.fillCanvas(t,n),ar._stroke(t,r)},_bezierCurveTo:function(t,e,r,n){t.bezierCurveTo(e.x,e.y,r.x,r.y,n.x,n.y)},ellipse:function(t,e,r,n,i,o){var a,s,h,u,l,c,f;t.beginPath(),r===n?t.arc(e.x,e.y,r,0,2*Math.PI):t.ellipse?t.ellipse(e.x,e.y,r,n,0,0,Math.PI/180*360):(a=e.x,s=e.y,c=(h=r)*(l=.5522848),f=(u=n)*l,t.moveTo(a-h,s),t.bezierCurveTo(a-h,s-f,a-c,s-u,a,s-u),t.bezierCurveTo(a+c,s-u,a+h,s-f,a+h,s),t.bezierCurveTo(a+h,s+f,a+c,s+u,a,s+u),t.bezierCurveTo(a-c,s+u,a-h,s+f,a-h,s),t.closePath()),ar.fillCanvas(t,o,e.x-r,e.y-n),ar._stroke(t,i,e.x-r,e.y-n)},rectangle:function(t,e,r,n,i){t.beginPath(),t.rect(e.x,e.y,r.width,r.height),ar.fillCanvas(t,i,e.x,e.y),ar._stroke(t,n,e.x,e.y)},sector:function(t,e,r,n,i,o){var a=Math.PI/180,s=n[0],h=n[1];function u(t,e,r,n,s,h){var u=a*-h,l=a*-s;t.beginPath(),t.moveTo(e,r),t.arc(e,r,n,u,l),t.lineTo(e,r),ar.fillCanvas(t,o,e-n,r-n),ar._stroke(t,i,e-n,r-n)}u(t,e.x,e.y,r,s,h)},_isPattern:function(t){return!(w(t)||"addColorStop"in t)},drawCross:function(t,e,r,n){t.canvas._drawn=!0,t.strokeStyle=n,t.lineWidth=r,t.beginPath(),t.moveTo(e.x-5,e.y),t.lineTo(e.x+5,e.y),t.moveTo(e.x,e.y-5),t.lineTo(e.x,e.y+5),t.stroke()},copy:function(t,e){var r=e||De("canvas");return r.width=t.width,r.height=t.height,r.getContext("2d").drawImage(t,0,0),r}};function sr(t,e,r,n){var i=e.x,o=e.y,a=r.x,s=r.y,h=n,u=function(t,e){return t<=e},l=function(t,e){return t>=e},c=function(t,e){return Math.min(t,e)},f=function(t,e){return Math.max(t,e)},d={thereYet:l,cap:c},p={thereYet:l,cap:c};o-s>0&&(p.thereYet=u,p.cap=f),i-a>0&&(d.thereYet=u,d.cap=f),t.moveTo(i,o);for(var m=i,g=o,_=0,y=!0,v=void 0,x=void 0;!d.thereYet(m,a)||!p.thereYet(g,s);)v=Math.atan2(s-o,a-i),x=h[_],m=d.cap(a,m+Math.cos(v)*x),g=p.cap(s,g+Math.sin(v)*x),y?t.lineTo(m,g):t.moveTo(m,g),_=(_+1)%h.length,y=!y}var hr="data:image/";function ur(t){return t.length>hr.length&&t.substring(0,hr.length)===hr||K(t)}function lr(t){return t.substring(0,hr.length)===hr?t:Q(t)}var cr=function(t){return function(t){function e(){return d(this,e),m(this,t.apply(this,arguments))}return p(e,t),e.prototype.on=function(t,e,r){if(!t)return this;if(!w(t))return this._switch("on",t,e);if(!e)return this;this._eventMap||(this._eventMap={});var n=t.toLowerCase().split(" "),i=void 0;r||(r=this);for(var o=void 0,a=0,s=n.length;a<s;a++){i=n[a],(o=this._eventMap[i])||(o=[],this._eventMap[i]=o);var h=o.length;if(h>0)for(var u=0;u<h;u++)if(e===o[u].handler&&o[u].context===r)return this;o.push({handler:e,context:r})}return this},e.prototype.addEventListener=function(){return this.on.apply(this,arguments)},e.prototype.once=function(t,e,r){if(!w(t)){var n={};for(var i in t)t.hasOwnProperty(i)&&(n[i]=this._wrapOnceHandler(i,t[i],r));return this._switch("on",n)}for(var o=t.split(" "),a=0,s=o.length;a<s;a++)this.on(o[a],this._wrapOnceHandler(o[a],e,r));return this},e.prototype.off=function(t,e,r){if(!this._eventMap||!t)return this;if(!w(t))return this._switch("off",t,e);if(!e)return this;var n=t.split(" "),i=void 0,o=void 0,a=void 0;r||(r=this);for(var s=0,h=n.length;s<h;s++){if(a="Z__"+(i=n[s].toLowerCase()),!(o=this._eventMap[i]))return this;for(var u=o.length-1;u>=0;u--){var l=o[u];e!==l.handler&&e!==l.handler[a]||l.context!==r||(delete l.handler[a],o.splice(u,1))}}return this},e.prototype.removeEventListener=function(){return this.off.apply(this,arguments)},e.prototype.listens=function(t,e,r){if(!this._eventMap||!w(t))return 0;var n=this._eventMap[t.toLowerCase()];if(!n||!n.length)return 0;for(var i=0,o=0,a=n.length;o<a;o++)if(e){if(e===n[o].handler&&(y(r)||n[o].context===r))return 1}else i++;return i},e.prototype.copyEventListeners=function(t){var e=t._eventMap;if(!e)return this;var r=void 0;for(var n in e)for(var i=0,o=(r=e[n]).length;i<o;i++)this.on(n,r[i].handler,r[i].context);return this},e.prototype.fire=function(){return this._eventParent?this._eventParent.fire.apply(this._eventParent,arguments):this._fire.apply(this,arguments)},e.prototype._wrapOnceHandler=function(t,e,r){var n=this,i="Z__"+t,o=!1,a=function s(){o||(delete a[i],o=!0,r?e.apply(r,arguments):e.apply(this,arguments),n.off(t,s,this))};return a[i]=e,a},e.prototype._switch=function(t,e,r){for(var n in e)e.hasOwnProperty(n)&&this[t](n,e[n],r);return this},e.prototype._clearListeners=function(t){this._eventMap&&w(t)&&(this._eventMap[t.toLowerCase()]&&(this._eventMap[t]=null))},e.prototype._clearAllListeners=function(){this._eventMap=null},e.prototype._setEventParent=function(t){return this._eventParent=t,this},e.prototype._fire=function(t,e){if(!this._eventMap)return this;var r=this._eventMap[t.toLowerCase()];if(!r)return this;e||(e={}),e.type=t,e.target=this;for(var n=r.slice(0),i=void 0,o=void 0,a=0,s=n.length;a<s;a++)n[a]&&(i=n[a].context,!0,o=_({},e),!1===(i?n[a].handler.call(i,o):n[a].handler(o))&&e.domEvent&&He(e.domEvent));return this},e}(t)},fr=function(){function t(e){d(this,t),this.target=e}return t.prototype.enable=function(){return this._enabled?this:(this._enabled=!0,this.addHooks(),this)},t.prototype.disable=function(){return this._enabled?(this._enabled=!1,this.removeHooks(),this):this},t.prototype.enabled=function(){return!!this._enabled},t.prototype.remove=function(){this.disable(),delete this.target,delete this.dom},t}(),dr=cr(fr),pr=function(){function t(e){if(d(this,t),!this||!this.setOptions)throw new Error('Class instance is being created without "new" operator.');this.setOptions(e),this.callInitHooks()}return t.prototype.callInitHooks=function(){var t=Object.getPrototypeOf(this);return this._visitInitHooks(t),this},t.prototype.setOptions=function(t){if(this.hasOwnProperty("options")||(this.options=this.options?Object.create(this.options):{}),!t)return this;for(var e in t)this.options[e]=t[e];return this},t.prototype.config=function(t){if(!t){var e={};for(var r in this.options)this.options.hasOwnProperty(r)&&(e[r]=this.options[r]);return e}if(2===arguments.length){var n={};n[t]=arguments[1],t=n}for(var i in t)this.options[i]=t[i],this[i]&&this[i]instanceof dr&&(t[i]?this[i].enable():this[i].disable());return this.onConfig(t),this},t.prototype.onConfig=function(){},t.prototype._visitInitHooks=function(t){if(!this._initHooksCalled){var e=Object.getPrototypeOf(t);e._visitInitHooks&&e._visitInitHooks.call(this,e),this._initHooksCalled=!0;var r=t._initHooks;if(r&&r!==e._initHooks)for(var n=0;n<r.length;n++)r[n].call(this)}},t.addInitHook=function(t){for(var e=arguments.length,r=Array(e>1?e-1:0),n=1;n<e;n++)r[n-1]=arguments[n];var i="function"==typeof t?t:function(){this[t].apply(this,r)},o=this.prototype,a=Object.getPrototypeOf(o);return o._initHooks&&o._initHooks!==a._initHooks||(o._initHooks=[]),o._initHooks.push(i),this},t.include=function(){for(var t=arguments.length,e=Array(t),r=0;r<t;r++)e[r]=arguments[r];for(var n=0;n<e.length;n++)_(this.prototype,e[n]);return this},t.mergeOptions=function(t){var e=this.prototype,r=Object.getPrototypeOf(e);return e.options&&e.options!==r.options||(e.options=e.options?Object.create(e.options):{}),_(e.options,t),this},t}(),mr={},gr=function(t){return function(t){function e(){return d(this,e),m(this,t.apply(this,arguments))}return p(e,t),e.registerJSONType=function(t){return t?(mr[t]=this,this):this},e.getJSONClass=function(t){return t?mr[t]:null},e.prototype.getJSONType=function(){if(void 0===this._jsonType){var t=Object.getPrototypeOf(this).constructor;for(var e in mr)if(mr[e]===t){this._jsonType=e;break}}if(!this._jsonType)throw new Error("Found an unregistered geometry class!");return this._jsonType},e}(t)},_r=function(t){return function(t){function e(){return d(this,e),m(this,t.apply(this,arguments))}return p(e,t),e.prototype.addHandler=function(t,e){if(!e)return this;if(this._handlers||(this._handlers=[]),this[t])return this[t].enable(),this;var r=this[t]=new e(this);return this._handlers.push(r),this.options[t]&&r.enable(),this},e.prototype.removeHandler=function(t){if(!t)return this;var e=this[t];if(e){var r=this._handlers.indexOf(e);r>=0&&this._handlers.splice(r,1),this[t].remove(),delete this[t]}return this},e.prototype._clearHandlers=function(){for(var t=0,e=this._handlers.length;t<e;t++)this._handlers[t].remove();this._handlers=[]},e}(t)},yr={mousedown:"mousemove",touchstart:"touchmove",pointerdown:"touchmove",MSPointerDown:"touchmove"},vr={mousedown:"mouseup",touchstart:"touchend",pointerdown:"touchend",MSPointerDown:"touchend"},xr=function(t){function e(r){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};d(this,e);var i=m(this,t.call(this,null));return i.dom=r,i.options=n,i}return p(e,t),e.prototype.enable=function(){return this.dom?(this._onMouseDown=function(t){return this.onMouseDown(t)},er(this.dom,"touchstart mousedown",this._onMouseDown,this),this):this},e.prototype.disable=function(){return this.dom?(this._offEvents(),rr(this.dom,"touchstart mousedown",this._onMouseDown),delete this._onMouseDown,this):this},e.prototype.onMouseDown=function(t){if((this.options.rightclick||2!==t.button)&&!(t.touches&&t.touches.length>1||this.options.cancelOn&&!0===this.options.cancelOn(t))){var e=this.dom;e.setCapture?e.setCapture():window.captureEvents&&window.captureEvents(window.Event.MOUSEMOVE|window.Event.MOUSEUP),e.ondragstart=function(){return!1},delete this.moved;var r=t.touches?t.touches[0]:t;this.startPos=new ce(r.clientX,r.clientY),er(document,yr[t.type],this.onMouseMove,this),er(document,vr[t.type],this.onMouseUp,this),this.options.ignoreMouseleave||er(this.dom,"mouseleave",this.onMouseUp,this),this.fire("mousedown",{domEvent:t,mousePos:new ce(r.clientX,r.clientY)})}},e.prototype.onMouseMove=function(t){if(t.touches&&t.touches.length>1)this.moved&&(this.interupted=!0,this.onMouseUp(t));else{var e=t.touches?t.touches[0]:t,r=new ce(e.clientX,e.clientY).sub(this.startPos);(r.x||r.y)&&(this.moved?this.fire("dragging",{domEvent:t,mousePos:new ce(e.clientX,e.clientY)}):(this.fire("dragstart",{domEvent:t,mousePos:this.startPos.copy()}),this.moved=!0))}},e.prototype.onMouseUp=function(t){var e=t.changedTouches?t.changedTouches[0]:t;this._offEvents();var r={domEvent:t};v(e.clientX)&&(r.mousePos=new ce(parseInt(e.clientX,0),parseInt(e.clientY,0))),this.moved&&(r.interupted=this.interupted,this.fire("dragend",r),delete this.interupted,delete this.moved),this.fire("mouseup",r)},e.prototype._offEvents=function(){var t=this.dom;if(rr(t,"mouseleave",this.onMouseUp,this),"undefined"!=typeof document&&"undefined"!=typeof window){for(var e in yr)rr(document,yr[e],this.onMouseMove,this),rr(document,vr[e],this.onMouseUp,this);t.releaseCapture?t.releaseCapture():window.captureEvents&&window.captureEvents(window.Event.MOUSEMOVE|window.Event.MOUSEUP)}},e}(dr),br=function(t){function e(){return d(this,e),m(this,t.apply(this,arguments))}return p(e,t),e.toNumberArrays=function(t){return Array.isArray(t)?U(t,function(t){return[t.x,t.y]}):[t.x,t.y]},e.toCoordinates=function(t){if(v(t[0])&&v(t[1]))return new e(t);for(var r=[],n=0,i=t.length;n<i;n++){var o=t[n];Array.isArray(o)?v(o[0])?r.push(new e(o)):r.push(e.toCoordinates(o)):r.push(new e(o))}return r},e}(le),wr=function(){function t(e,r){d(this,t),this.type=e,this.properties=r}return t.createProj4=function(e){return new t("proj4",{proj:e})},t.fromProjectionCode=function(e){return e&&t[e=e.toUpperCase().replace(":","")]||null},t}();wr.WGS84=wr.createProj4("+proj=longlat +datum=WGS84 +no_defs"),wr.EPSG4326=wr.WGS84,wr.EPSG3857=wr.createProj4("+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext  +no_defs"),wr.IDENTITY=wr.createProj4("+proj=identity +no_defs"),wr.CGCS2000=wr.createProj4("+proj=longlat +datum=CGCS2000"),wr.EPSG4490=wr.CGCS2000,wr.BD09LL=wr.createProj4("+proj=longlat +datum=BD09"),wr.GCJ02=wr.createProj4("+proj=longlat +datum=GCJ02");var Tr,Er=function(){function t(e,r,n,i){d(this,t),this._clazz=br;var o=arguments.length,a=o>0?arguments[o-1]:null;a&&a.unproject&&(this.projection=arguments[o-1]),this._dirty=!0,this._initialize(e,r,n,i)}return t.prototype._initialize=function(t,e,r,n){if(this.xmin=null,this.xmax=null,this.ymin=null,this.ymax=null,!y(t)){var i=this.projection;v(t)&&v(e)&&v(r)&&v(n)?i?(this.xmin=t,this.ymin=e,this.xmax=r,this.ymax=n):(this.xmin=Math.min(t,r),this.ymin=Math.min(e,n),this.xmax=Math.max(t,r),this.ymax=Math.max(e,n)):Array.isArray(t)?i?(this.xmin=t[0],this.ymin=t[1],this.xmax=t[2],this.ymax=t[3]):(this.xmin=Math.min(t[0],t[2]),this.ymin=Math.min(t[1],t[3]),this.xmax=Math.max(t[0],t[2]),this.ymax=Math.max(t[1],t[3])):v(t.x)&&v(e.x)&&v(t.y)&&v(e.y)?i?(this.xmin=t.x,this.ymin=t.y,this.xmax=e.x,this.ymax=e.y):(t.x>e.x?(this.xmin=e.x,this.xmax=t.x):(this.xmin=t.x,this.xmax=e.x),t.y>e.y?(this.ymin=e.y,this.ymax=t.y):(this.ymin=t.y,this.ymax=e.y)):v(t.xmin)&&v(t.xmax)&&v(t.ymin)&&v(t.ymax)&&(this.xmin=t.xmin,this.ymin=t.ymin,this.xmax=t.xmax,this.ymax=t.ymax)}},t.prototype._add=function(t){return this._dirty=!0,y(t.x)?y(t.xmin)?y(t[0])||(this.xmin+=t[0],this.ymin+=t[1],this.xmax+=t[0],this.ymax+=t[1]):(this.xmin+=t.xmin,this.ymin+=t.ymin,this.xmax+=t.xmax,this.ymax+=t.ymax):(this.xmin+=t.x,this.ymin+=t.y,this.xmax+=t.x,this.ymax+=t.y),this},t.prototype.add=function(){var t=new this.constructor(this.xmin,this.ymin,this.xmax,this.ymax,this.projection);return t._add.apply(t,arguments)},t.prototype._sub=function(t){return this._dirty=!0,y(t.x)?y(t.xmin)?y(t[0])||(this.xmin-=t[0],this.ymin-=t[1],this.xmax-=t[0],this.ymax-=t[1]):(this.xmin-=t.xmin,this.ymin-=t.ymin,this.xmax-=t.xmax,this.ymax-=t.ymax):(this.xmin-=t.x,this.ymin-=t.y,this.xmax-=t.x,this.ymax-=t.y),this},t.prototype._substract=function(){return this._sub.apply(this,arguments)},t.prototype.sub=function(){var t=new this.constructor(this.xmin,this.ymin,this.xmax,this.ymax,this.projection);return t._sub.apply(t,arguments)},t.prototype.substract=function(){return this.sub.apply(this,arguments)},t.prototype.round=function(){return new this.constructor(Math.round(this.xmin),Math.round(this.ymin),Math.round(this.xmax),Math.round(this.ymax),this.projection)},t.prototype._round=function(){return this._dirty=!0,this.xmin=Math.round(this.xmin),this.ymin=Math.round(this.ymin),this.xmax=Math.round(this.xmax),this.ymax=Math.round(this.ymax),this},t.prototype.getMin=function(){return new this._clazz(this.xmin,this.ymin)},t.prototype.getMax=function(){return new this._clazz(this.xmax,this.ymax)},t.prototype.getCenter=function(){return new this._clazz((this.xmin+this.xmax)/2,(this.ymin+this.ymax)/2)},t.prototype.isValid=function(){return v(this.xmin)&&v(this.ymin)&&v(this.xmax)&&v(this.ymax)},t.prototype.equals=function(t){return this.xmin===t.xmin&&this.xmax===t.xmax&&this.ymin===t.ymin&&this.ymax===t.ymax},t.prototype.intersects=function(t){this._project(this),this._project(t);var e=Math.max(this.pxmin,t.pxmin),r=Math.max(this.pymin,t.pymin),n=Math.min(this.pxmax,t.pxmax),i=Math.min(this.pymax,t.pymax),o=!(e>n||r>i);return o},t.prototype.within=function(t){return this._project(this),this._project(t),this.pxmin>=t.pxmin&&this.pxmax<=t.pxmax&&this.pymin>=t.pymin&&this.pymax<=t.pymax},t.prototype.contains=function(t){if(!t)return!1;this._project(this);var e=this.projection;return Array.isArray(t)&&(t=new this._clazz(t)),e&&(t=e.project(t)),t.x>=this.pxmin&&t.x<=this.pxmax&&t.y>=this.pymin&&t.y<=this.pymax},t.prototype.getWidth=function(){return Math.abs(this.xmax-this.xmin)},t.prototype.getHeight=function(){return Math.abs(this.ymax-this.ymin)},t.prototype.getSize=function(){return new fe(this.getWidth(),this.getHeight())},t.prototype.__combine=function(t){t instanceof this.constructor||(t=new this.constructor(t,t)),this._project(t),this._project(this);var e=this.pxmin;v(e)?v(t.pxmin)&&e>t.pxmin&&(e=t.pxmin):e=t.pxmin;var r=this.pxmax;v(r)?v(t.pxmax)&&r<t.pxmax&&(r=t.pxmax):r=t.pxmax;var n=this.pymin;v(n)?v(t.pymin)&&n>t.pymin&&(n=t.pymin):n=t.pymin;var i=this.pymax;v(i)?v(t.pymax)&&i<t.pymax&&(i=t.pymax):i=t.pymax;var o=this.projection;if(o){var a=o.unproject(new this._clazz(e,n)),s=o.unproject(new this._clazz(r,i));e=a.x,n=a.y,r=s.x,i=s.y}return[e,n,r,i]},t.prototype._combine=function(t){if(!t)return this;var e=this.__combine(t);return this.xmin=e[0],this.ymin=e[1],this.xmax=e[2],this.ymax=e[3],this._dirty=!0,this},t.prototype.combine=function(t){if(!t)return this;var e=this.__combine(t);return new this.constructor(e[0],e[1],e[2],e[3],this.projection)},t.prototype.intersection=function(t){if(!this.intersects(t))return null;var e=new this._clazz(Math.max(this.pxmin,t.pxmin),Math.max(this.pymin,t.pymin)),r=new this._clazz(Math.min(this.pxmax,t.pxmax),Math.min(this.pymax,t.pymax)),n=this.projection;return n&&(e=n.unproject(e),r=n.unproject(r)),new this.constructor(e,r,n)},t.prototype.expand=function(t){var e=void 0,r=void 0;return v(t)?e=r=t:(e=t.width||t.x||t[0]||0,r=t.height||t.y||t[1]||0),new this.constructor(this.xmin-e,this.ymin-r,this.xmax+e,this.ymax+r,this.projection)},t.prototype._expand=function(t){var e=void 0,r=void 0;return v(t)?e=r=t:(e=t.width||t.x||t[0]||0,r=t.height||t.y||t[1]||0),this.xmin-=e,this.ymin-=r,this.xmax+=e,this.ymax+=r,this._dirty=!0,this},t.prototype.toJSON=function(){return{xmin:this.xmin,ymin:this.ymin,xmax:this.xmax,ymax:this.ymax}},t.prototype.toArray=function(){var t=this.xmin,e=this.ymin,r=this.xmax,n=this.ymax;return[new this._clazz([t,n]),new this._clazz([r,n]),new this._clazz([r,e]),new this._clazz([t,e]),new this._clazz([t,n])]},t.prototype.toString=function(){return this.xmin+","+this.ymin+","+this.xmax+","+this.ymax},t.prototype.copy=function(){return new this.constructor(this.xmin,this.ymin,this.xmax,this.ymax,this.projection)},t.prototype.convertTo=function(t){if(!this.isValid())return null;var e=new this.constructor,r=new this._clazz(this.xmin,this.ymax);return e._combine(t(r)),r.x=this.xmax,e._combine(t(r)),r.y=this.ymin,e._combine(t(r)),r.x=this.xmin,e._combine(t(r)),e},t.prototype._project=function(t){if(t&&t.isValid()){var e=this.projection;if(e){if(t._dirty){var r=[t.getMin(),t.getMax()],n=(r=e.projectCoords(r))[0],i=r[1];t.pxmin=Math.min(n.x,i.x),t.pymin=Math.min(n.y,i.y),t.pxmax=Math.max(n.x,i.x),t.pymax=Math.max(n.y,i.y)}delete t._dirty}else t.pxmin=t.xmin,t.pxmax=t.xmax,t.pymin=t.ymin,t.pymax=t.ymax}},t}(),Cr=function(t){function e(r,n,i,o){d(this,e);var a=m(this,t.call(this,r,n,i,o));return a._clazz=ce,a}return p(e,t),e}(Er),Sr=function(){function t(e){d(this,t),this.matrix=e}return t.prototype.transform=function(t,e){return new ce(this.matrix[0]*(t.x-this.matrix[2])/e,this.matrix[1]*(t.y-this.matrix[3])/e)},t.prototype.untransform=function(t,e){return new br(t.x*e/this.matrix[0]+this.matrix[2],t.y*e/this.matrix[1]+this.matrix[3])},t}(),Ar={project:function(){},unproject:function(){},projectCoords:function(t){var e=this;if(!t)return[];if(!Array.isArray(t))return this.project(t);if(0===t.length)return[];if(!this.isSphere())return U(t,this.project,this);if(Array.isArray(t[0]))return t.map(function(t){return e.projectCoords(t)});for(var r=this.getCircum(),n=this.getSphereExtent(),i=n.sx,o=n.sy,a=void 0,s=void 0,h=t[0],u=void 0,l=void 0,c=void 0,f=void 0,d=[this.project(h)],p=1,m=t.length;p<m;p++)l=(u=t[p]).x-h.x,c=u.y-h.y,f=this.project(u),Math.abs(l)>180&&(void 0===a&&(a=u.x<h.x),a&&(f._add(-r.x*j(l)*i,0),u._add(-360*j(l),0))),Math.abs(c)>90&&(void 0===s&&(s=u.y<h.y),s&&(f._add(0,-r.y*j(c)*o),u._add(0,-180*j(c)))),h=u,d.push(f);return d},unprojectCoords:function(t){return t?Array.isArray(t)?U(t,this.unproject,this):this.unproject(t):[]},isSphere:function(){return!!this.sphere},isOutSphere:function(t){return!!this.isSphere()&&!this.getSphereExtent().contains(t)},wrapCoord:function(t){if(!this.isSphere())return t;var e=this.getSphereExtent(),r=new br(t);return e.contains(r)||(r.x=W(t.x,e.xmin,e.xmax),r.y=W(t.y,e.ymin,e.ymax)),r},getCircum:function(){if(!this.circum&&this.isSphere()){var t=this.getSphereExtent();this.circum={x:t.getWidth(),y:t.getHeight()}}return this.circum},getSphereExtent:function(){if(!this.extent&&this.isSphere()){var t=this.project(new br(180,90)),e=this.project(new br(-180,-90));this.extent=new Er(e,t,this),this.extent.sx=t.x>e.x?1:-1,this.extent.sy=t.y>e.y?1:-1}return this.extent}},Mr={measureLength:function(t,e){if(!Array.isArray(t))return this.measureLenBetween(t,e);for(var r=0,n=0,i=t.length;n<i-1;n++)r+=this.measureLenBetween(t[n],t[n+1]);return r}},Pr=_({measure:"IDENTITY",measureLenBetween:function(t,e){if(!t||!e)return 0;try{return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))}catch(t){return 0}},measureArea:function(t){if(!Array.isArray(t))return 0;for(var e=0,r=0,n=t.length;r<n;r++){var i=t[r],o=null;o=r===n-1?t[0]:t[r+1],e+=i.x*o.y-i.y*o.x}return Math.abs(e/2)},locate:function(t,e,r){return t=new br(t.x,t.y),this._locate(t,e,r)},_locate:function(t,e,r){return t?(e||(e=0),r||(r=0),e||r?(t.x=t.x+e,t.y=t.y+r,t):t):null},rotate:function(t,e,r){return t=new br(t.x,t.y),this._rotate(t,e,r)},_rotate:(Tr=new ce(0,0),function(t,e,r){return Tr.x=t.x-e.x,Tr.y=t.y-e.y,Tr._rotate(r*Math.PI/180),t._add(Tr.x,Tr.y)})},Mr),Rr=function(){function t(e){d(this,t),this.radius=e}return t.prototype.measureLenBetween=function(t,e){if(!t||!e)return 0;var r=A(t.y),n=A(e.y),i=r-n,o=A(t.x)-A(e.x);return r=2*Math.asin(Math.sqrt(Math.pow(Math.sin(i/2),2)+Math.cos(r)*Math.cos(n)*Math.pow(Math.sin(o/2),2))),r*=this.radius,Math.round(1e5*r)/1e5},t.prototype.measureArea=function(t){var e=A(this.radius),r=0,n=t,i=n.length;if(i<3)return 0;var o=void 0;for(o=0;o<i-1;o++){var a=n[o],s=n[o+1];r+=a.x*e*Math.cos(A(a.y))*s.y*e-s.x*e*Math.cos(A(s.y))*a.y*e}return i=n[o],n=n[0],r+=i.x*e*Math.cos(A(i.y))*n.y*e-n.x*e*Math.cos(A(n.y))*i.y*e,.5*Math.abs(r)},t.prototype.locate=function(t,e,r){return t=new br(t.x,t.y),this._locate(t,e,r)},t.prototype._locate=function(t,e,r){if(!t)return null;if(e||(e=0),r||(r=0),!e&&!r)return t;var n=void 0,i=void 0,o=A(t.y);if(0!==r){var a=Math.abs(r);i=W(180*(o+=2*Math.sin(a/(2*this.radius))*(r>0?1:-1))/Math.PI,-90,90)}else i=t.y;if(0!==e){var s=Math.abs(e),h=A(t.x);n=W(180*(h+=2*Math.sqrt(Math.pow(Math.sin(s/(2*this.radius)),2)/Math.pow(Math.cos(o),2))*(e>0?1:-1))/Math.PI,-180,180)}else n=t.x;return t.x=n,t.y=i,t},t.prototype.rotate=function(t,e,r){return t=new br(t),this._rotate(t,e,r)},t.prototype._rotate=function(t,e,r){var n=function(t,e){var r=void 0;r=(arguments.length>2&&void 0!==arguments[2]?arguments[2]:{}).final?Lr(e,t):Lr(t,e);return r>180?-(360-r):r}(e,t)-r,i=this.measureLenBetween(e,t);return t.x=e.x,t.y=e.y,function(t,e,r,n){var i=e/n,o=t.x*Math.PI/180,a=A(t.y),s=A(r),h=i*Math.cos(s),u=a+h;Math.abs(u)>Math.PI/2&&(u=u>0?Math.PI-u:-Math.PI-u);var l=Math.log(Math.tan(u/2+Math.PI/4)/Math.tan(a/2+Math.PI/4)),c=Math.abs(l)>1e-11?h/l:Math.cos(a),f=i*Math.sin(s)/c,d=o+f;return t.x=(180*d/Math.PI+540)%360-180,t.y=180*u/Math.PI,t}(t,i,n,this.radius)},t}();function Lr(t,e){var r=A(t.y),n=A(e.y),i=A(e.x-t.x);i>Math.PI&&(i-=2*Math.PI),i<-Math.PI&&(i+=2*Math.PI);var o=Math.log(Math.tan(n/2+Math.PI/4)/Math.tan(r/2+Math.PI/4));return(M(Math.atan2(i,o))+360)%360}var Or=_({measure:"EPSG:4326",sphere:new Rr(6378137),measureLenBetween:function(){return this.sphere.measureLenBetween.apply(this.sphere,arguments)},measureArea:function(){return this.sphere.measureArea.apply(this.sphere,arguments)},_locate:function(){return this.sphere._locate.apply(this.sphere,arguments)},locate:function(){return this.sphere.locate.apply(this.sphere,arguments)},_rotate:function(){return this.sphere._rotate.apply(this.sphere,arguments)},rotate:function(){return this.sphere.rotate.apply(this.sphere,arguments)}},Mr),kr=_({measure:"BAIDU",sphere:new Rr(6370996.81),measureLenBetween:function(){return this.sphere.measureLenBetween.apply(this.sphere,arguments)},measureArea:function(){return this.sphere.measureArea.apply(this.sphere,arguments)},_locate:function(){return this.sphere._locate.apply(this.sphere,arguments)},locate:function(){return this.sphere.locate.apply(this.sphere,arguments)},_rotate:function(){return this.sphere._rotate.apply(this.sphere,arguments)},rotate:function(){return this.sphere.rotate.apply(this.sphere,arguments)}},Mr),Dr=Or,Ir={};function Nr(t){Ir[t.measure]=t}Nr(Pr),Nr(Or),Nr(kr);var Fr={getInstance:function(t){if(!t)return Dr;for(var e in Ir)if(C(Ir,e)){var r=Ir[e].measure;if(!r)continue;if(t.toLowerCase()===r.toLowerCase())return Ir[e]}return null}},Br=Object.freeze({Identity:Pr,DEFAULT:Dr,Measurer:Fr,WGS84Sphere:Or,BaiduSphere:kr}),zr=_({},Ar,{code:"EPSG:3857",rad:Math.PI/180,metersPerDegree:6378137*Math.PI/180,maxLatitude:85.0511287798,project:function(t){var e=this.rad,r=this.metersPerDegree,n=this.maxLatitude,i=t.x,o=Math.max(Math.min(n,t.y),-n),a=void 0;return a=0===o?0:Math.log(Math.tan((90+o)*e/2))/e,new br(i*r,a*r)},unproject:function(t){var e=t.x,r=t.y,n=this.rad,i=this.metersPerDegree,o=void 0;return 0===r?o=0:(o=r/i,o=(2*Math.atan(Math.exp(o*n))-Math.PI/2)/n),new br(W(e/i,-180,180),W(o,-this.maxLatitude,this.maxLatitude))}},Or),Ur=_({},Ar,{code:"EPSG:4326",project:function(t){return new br(t)},unproject:function(t){return new br(t)}},Or),Hr=_({},Ur,{code:"EPSG:4490"}),jr=_({},Ar,{code:"BAIDU",project:function(t){return this.convertLL2MC(t)},unproject:function(t){return this.convertMC2LL(t)}},kr,{EARTHRADIUS:6370996.81,MCBAND:[12890594.86,8362377.87,5591021,3481989.83,1678043.12,0],LLBAND:[75,60,45,30,15,0],MC2LL:[[1.410526172116255e-8,898305509648872e-20,-1.9939833816331,200.9824383106796,-187.2403703815547,91.6087516669843,-23.38765649603339,2.57121317296198,-.03801003308653,17337981.2],[-7.435856389565537e-9,8983055097726239e-21,-.78625201886289,96.32687599759846,-1.85204757529826,-59.36935905485877,47.40033549296737,-16.50741931063887,2.28786674699375,10260144.86],[-3.030883460898826e-8,898305509983578e-20,.30071316287616,59.74293618442277,7.357984074871,-25.38371002664745,13.45380521110908,-3.29883767235584,.32710905363475,6856817.37],[-1.981981304930552e-8,8983055099779535e-21,.03278182852591,40.31678527705744,.65659298677277,-4.44255534477492,.85341911805263,.12923347998204,-.04625736007561,4482777.06],[3.09191371068437e-9,8983055096812155e-21,6995724062e-14,23.10934304144901,-.00023663490511,-.6321817810242,-.00663494467273,.03430082397953,-.00466043876332,2555164.4],[2.890871144776878e-9,8983055095805407e-21,-3.068298e-8,7.47137025468032,-353937994e-14,-.02145144861037,-1234426596e-14,.00010322952773,-323890364e-14,826088.5]],LL2MC:[[-.0015702102444,111320.7020616939,0x60e374c3105a3,-0x24bb4115e2e164,0x5cc55543bb0ae8,-0x7ce070193f3784,0x5e7ca61ddf8150,-0x261a578d8b24d0,0x665d60f3742ca,82.5],[.0008277824516172526,111320.7020463578,647795574.6671607,-4082003173.641316,10774905663.51142,-15171875531.51559,12053065338.62167,-5124939663.577472,913311935.9512032,67.5],[.00337398766765,111320.7020202162,4481351.045890365,-23393751.19931662,79682215.47186455,-115964993.2797253,97236711.15602145,-43661946.33752821,8477230.501135234,52.5],[.00220636496208,111320.7020209128,51751.86112841131,3796837.749470245,992013.7397791013,-1221952.21711287,1340652.697009075,-620943.6990984312,144416.9293806241,37.5],[-.0003441963504368392,111320.7020576856,278.2353980772752,2485758.690035394,6070.750963243378,54821.18345352118,9540.606633304236,-2710.55326746645,1405.483844121726,22.5],[-.0003218135878613132,111320.7020701615,.00369383431289,823725.6402795718,.46104986909093,2351.343141331292,1.58060784298199,8.77738589078284,.37238884252424,7.45]],convertMC2LL:function(t){Math.abs(t.x);for(var e=Math.abs(t.y),r=void 0,n=0,i=this.MCBAND.length;n<i;n++)if(e>=this.MCBAND[n]){r=this.MC2LL[n];break}var o=this.convertor(t,r);return new br(o.x,o.y)},convertLL2MC:function(t){var e,r=void 0,n=void 0;t.x=this.getLoop(t.x,-180,180),t.y=this.getRange(t.y,-74,74);var i=new br(t.x,t.y);for(n=0,e=this.LLBAND.length;n<e;n++)if(i.y>=this.LLBAND[n]){r=this.LL2MC[n];break}if(!r)for(n=this.LLBAND.length-1;n>=0;n--)if(i.y<=-this.LLBAND[n]){r=this.LL2MC[n];break}var o=this.convertor(t,r);return new br(o.x,o.y)},convertor:function(t,e){if(!t||!e)return null;var r=e[0]+e[1]*Math.abs(t.x),n=Math.abs(t.y)/e[9],i=e[2]+e[3]*n+e[4]*n*n+e[5]*n*n*n+e[6]*n*n*n*n+e[7]*n*n*n*n*n+e[8]*n*n*n*n*n*n;return r*=t.x<0?-1:1,i*=t.y<0?-1:1,new br(r,i)},toRadians:function(t){return Math.PI*t/180},toDegrees:function(t){return 180*t/Math.PI},getRange:function(t,e,r){return null!=e&&(t=Math.max(t,e)),null!=r&&(t=Math.min(t,r)),t},getLoop:function(t,e,r){for(;t>r;)t-=r-e;for(;t<e;)t+=r-e;return t}}),Gr=_({},Ar,{code:"IDENTITY",project:function(t){return t.copy()},unproject:function(t){return t.copy()}},Pr),Vr=zr,Wr=Object.freeze({EPSG3857:zr,DEFAULT:Vr,EPSG4326:Ur,EPSG4490:Hr,BAIDU:jr,IDENTITY:Gr,Common:Ar}),Zr=function(t){return function(t){function e(){return d(this,e),m(this,t.apply(this,arguments))}return p(e,t),e.registerRenderer=function(t,e){var r=this.prototype,n=Object.getPrototypeOf(r);return r._rendererClasses&&r._rendererClasses!==n._rendererClasses||(r._rendererClasses=r._rendererClasses?Object.create(r._rendererClasses):{}),r._rendererClasses[t.toLowerCase()]=e,this},e.getRendererClass=function(t){var e=this.prototype;return e._rendererClasses?e._rendererClasses[t.toLowerCase()]:null},e}(t)},Xr="undefined"!=typeof window?window:void 0!==n?n:"undefined"!=typeof self?self:{};function qr(t,e){return t(e={exports:{}},e.exports),e.exports}var Yr=qr(function(t){!function(e){function r(t){if(t){var e=this;t(function(t){e.resolve(t)},function(t){e.reject(t)})}}function n(t,e){if("function"==typeof t.y)try{var r=t.y.call(s,e);t.p.resolve(r)}catch(e){t.p.reject(e)}else t.p.resolve(e)}function o(t,e){if("function"==typeof t.n)try{var r=t.n.call(s,e);t.p.resolve(r)}catch(e){t.p.reject(e)}else t.p.reject(e)}var a,s,h="fulfilled",u="undefined",l=function(){function t(){for(;r.length-n;){try{r[n]()}catch(t){e.console&&e.console.error(t)}r[n++]=s,n==o&&(r.splice(0,o),n=0)}}var r=[],n=0,o=1024,a=function(){if(("undefined"==typeof MutationObserver?"undefined":f(MutationObserver))!==u){var e=document.createElement("div");return new MutationObserver(t).observe(e,{attributes:!0}),function(){e.setAttribute("a",0)}}return(void 0===i?"undefined":f(i))!==u?function(){i(t)}:function(){setTimeout(t,0)}}();return function(t){r.push(t),r.length-n==1&&a()}}();r.prototype={resolve:function(t){if(this.state===a){if(t===this)return this.reject(new TypeError("Attempt to resolve promise with self"));var e=this;if(t&&("function"==typeof t||"object"==(void 0===t?"undefined":f(t))))try{var r=!0,i=t.then;if("function"==typeof i)return void i.call(t,function(t){r&&(r=!1,e.resolve(t))},function(t){r&&(r=!1,e.reject(t))})}catch(t){return void(r&&this.reject(t))}this.state=h,this.v=t,e.c&&l(function(){for(var r=0,i=e.c.length;i>r;r++)n(e.c[r],t)})}},reject:function(t){if(this.state===a){this.state="rejected",this.v=t;var n=this.c;n?l(function(){for(var e=0,r=n.length;r>e;e++)o(n[e],t)}):!r.suppressUncaughtRejectionError&&e.console&&e.console.log("You upset Zousan. Please catch rejections: ",t,t?t.stack:null)}},then:function(t,e){var i=new r,s={y:t,n:e,p:i};if(this.state===a)this.c?this.c.push(s):this.c=[s];else{var u=this.state,c=this.v;l(function(){u===h?n(s,c):o(s,c)})}return i},catch:function(t){return this.then(null,t)},finally:function(t){return this.then(t,t)},timeout:function(t,e){e=e||"Timeout";var n=this;return new r(function(r,i){setTimeout(function(){i(Error(e))},t),n.then(function(t){r(t)},function(t){i(t)})})}},r.resolve=function(t){var e=new r;return e.resolve(t),e},r.reject=function(t){var e=new r;return e.reject(t),e},r.all=function(t){function e(e,a){e&&"function"==typeof e.then||(e=r.resolve(e)),e.then(function(e){n[a]=e,++i==t.length&&o.resolve(n)},function(t){o.reject(t)})}for(var n=[],i=0,o=new r,a=0;a<t.length;a++)e(t[a],a);return t.length||o.resolve(n),o},t.exports&&(t.exports=r),e.define&&e.define.amd&&e.define([],function(){return r}),e.Zousan=r,r.soon=l}(Xr)}),Jr="undefined"!=typeof Promise?Promise:Yr,Kr=function(t){function e(r){d(this,e);var n=m(this,t.call(this));return n.layer=r,n._painted=!1,n._drawTime=0,n.setToRedraw(),n}return p(e,t),e.prototype.render=function(t){var e=this;if(this.prepareRender(),this.getMap()&&this.layer.isVisible())if(this.resources||(this.resources=new Qr),this.checkResources){var r=this.checkResources();r.length>0?(this._loadingResource=!0,this.loadResources(r).then(function(){e._loadingResource=!1,e.layer&&(e.layer.fire("resourceload"),e.setToRedraw())})):this._tryToDraw(t)}else this._tryToDraw(t)},e.prototype.testIfNeedRedraw=function(){var t=this.getMap();return!this._loadingResource&&(!!this._toRedraw||!(t.isInteracting()&&!this.drawOnInteracting)&&!!this.needToRedraw())},e.prototype.needToRedraw=function(){var t=this.getMap();return!!t.isInteracting()&&!(!t.getPitch()&&t.isMoving()&&!t.isZooming()&&!t.isRotating()&&!this.layer.options.forceRenderOnMoving)},e.prototype.onSkipDrawOnInteracting=function(){},e.prototype.isRenderComplete=function(){return!!this._renderComplete},e.prototype.mustRenderOnInteracting=function(){return!this._painted||this.checkResources&&this.checkResources().length>0},e.prototype.setToRedraw=function(){return this._toRedraw=!0,this},e.prototype.setCanvasUpdated=function(){return this._canvasUpdated=!0,this},e.prototype.isCanvasUpdated=function(){return!!this._canvasUpdated},e.prototype.remove=function(){this.onRemove(),delete this._loadingResource,delete this.southWest,delete this.canvas,delete this.context,delete this.canvasExtent2D,delete this._extent2D,delete this.resources,delete this.layer},e.prototype.onRemove=function(){},e.prototype.onAdd=function(){},e.prototype.getMap=function(){return this.layer?this.layer.getMap():null},e.prototype.getCanvasImage=function(){var t=this.getMap();if(this._canvasUpdated=!1,this._renderZoom!==t.getZoom()||!this.canvas||!this._extent2D)return null;if(this.isBlank())return null;if(this.layer.isEmpty&&this.layer.isEmpty())return null;var e=t._pointToContainerPoint(this.southWest)._add(0,-t.height);return{image:this.canvas,layer:this.layer,point:e}},e.prototype.clear=function(){this.clearCanvas()},e.prototype.isBlank=function(){return!this._painted},e.prototype.show=function(){this.setToRedraw()},e.prototype.hide=function(){this.clear(),this.setToRedraw()},e.prototype.setZIndex=function(){this.setToRedraw()},e.prototype.hitDetect=function(t){if(!this.context||this.layer.isEmpty&&this.layer.isEmpty()||this.isBlank()||this._errorThrown)return!1;var e=this.getMap(),r=ue.retina?2:1,n=e.getSize();if(t.x<0||t.x>n.width*r||t.y<0||t.y>n.height*r)return!1;try{if(this.context.getImageData(r*t.x,r*t.y,1,1).data[3]>0)return!0}catch(t){return this._errorThrown||(console&&console.warn("hit detect failed with tainted canvas, some geometries have external resources in another domain:\n",t),this._errorThrown=!0),!1}return!1},e.prototype.loadResources=function(t){this.resources||(this.resources=new Qr);var e=this.resources,r=[];if(X(t))for(var n={},i=t.length-1;i>=0;i--){var o=t[i];o&&o.length&&!n[o.join("-")]&&(n[o.join("-")]=1,e.isResourceLoaded(o,!0)||r.push(new Jr(this._promiseResource(o))))}return Jr.all(r)},e.prototype.prepareRender=function(){delete this._renderComplete;var t=this.getMap();this._renderZoom=t.getZoom(),this.canvasExtent2D=this._extent2D=t._get2DExtent(),this.southWest=t._containerPointToPoint(new ce(0,t.height))},e.prototype.createCanvas=function(){if(!this.canvas){var t=this.getMap(),e=t.getSize(),r=ue.retina?2:1,n=r*e.width,i=r*e.height;if(this.layer._canvas){var o=this.layer._canvas;o.width=n,o.height=i,o.style&&(o.style.width=e.width+"px",o.style.height=e.height+"px"),this.canvas=this.layer._canvas}else this.canvas=ar.createCanvas(n,i,t.CanvasClass);this.onCanvasCreate()}},e.prototype.onCanvasCreate=function(){},e.prototype.createContext=function(){if(!(this.gl&&this.gl.canvas===this.canvas||this.context)&&(this.context=this.canvas.getContext("2d"),this.layer.options.globalCompositeOperation&&(this.context.globalCompositeOperation=this.layer.options.globalCompositeOperation),ue.retina)){this.context.scale(2,2)}},e.prototype.resetCanvasTransform=function(){if(this.context){var t=ue.retina?2:1;this.context.setTransform(t,0,0,t,0,0)}},e.prototype.resizeCanvas=function(t){var e=this.canvas;if(e){var r=t||this.getMap().getSize(),n=ue.retina?2:1;e.width===n*r.width&&e.height===n*r.height||(e.height=n*r.height,e.width=n*r.width,ue.retina&&this.context&&this.context.scale(n,n),this.layer._canvas&&e.style&&(e.style.width=r.width+"px",e.style.height=r.height+"px"))}},e.prototype.clearCanvas=function(){this.context&&ar.clearRect(this.context,0,0,this.canvas.width,this.canvas.height)},e.prototype.prepareCanvas=function(){this.canvas?(this.clearCanvas(),this.resizeCanvas(),this.resetCanvasTransform()):(this.createCanvas(),this.createContext(),this.layer.fire("canvascreate",{context:this.context,gl:this.gl})),delete this._maskExtent;var t=this.layer.getMask();if(!t)return this.layer.fire("renderstart",{context:this.context,gl:this.gl}),null;var e=this._maskExtent=t._getPainter().get2DExtent();return e.intersects(this._extent2D),this.layer.fire("renderstart",{context:this.context,gl:this.gl}),e},e.prototype.clipCanvas=function(t){var e=this.layer.getMask();if(!e)return!1;var r=this.southWest,n=this.getMap();return this.southWest=n._containerPointToPoint(new ce(0,n.height)),t.save(),ue.retina&&(t.save(),t.scale(2,2)),e._getPainter().paint(null,t),ue.retina&&t.restore(),t.clip(),this.southWest=r,!0},e.prototype.getViewExtent=function(){return{extent:this._extent2D,maskExtent:this._maskExtent,zoom:this._renderZoom,southWest:this.southWest}},e.prototype.completeRender=function(){this.getMap()&&(this._renderComplete=!0,this.layer.fire("renderend",{context:this.context,gl:this.gl}),this.setCanvasUpdated())},e.prototype.getEvents=function(){return{_zoomstart:this.onZoomStart,_zooming:this.onZooming,_zoomend:this.onZoomEnd,_resize:this.onResize,_movestart:this.onMoveStart,_moving:this.onMoving,_moveend:this.onMoveEnd,_dragrotatestart:this.onDragRotateStart,_dragrotating:this.onDragRotating,_dragrotateend:this.onDragRotateEnd,_spatialreferencechange:this.onSpatialReferenceChange}},e.prototype.onZoomStart=function(){},e.prototype.onZoomEnd=function(){this.setToRedraw()},e.prototype.onZooming=function(){},e.prototype.onMoveStart=function(){},e.prototype.onMoving=function(){},e.prototype.onMoveEnd=function(){this.setToRedraw()},e.prototype.onResize=function(){delete this._extent2D,this.resizeCanvas(),this.setToRedraw()},e.prototype.onDragRotateStart=function(){},e.prototype.onDragRotating=function(){},e.prototype.onDragRotateEnd=function(){this.setToRedraw()},e.prototype.onSpatialReferenceChange=function(){},e.prototype.getDrawTime=function(){return this._drawTime},e.prototype._tryToDraw=function(t){this._toRedraw=!1,!this.canvas&&this.layer.isEmpty&&this.layer.isEmpty()?this._renderComplete=!0:this._drawAndRecord(t)},e.prototype._drawAndRecord=function(t){if(this.getMap()){var e=this._painted;this._painted=!0;var r=g();this.draw(t),r=g()-r,this._drawTime=e?r:r/2,e&&this.layer.options.logDrawTime&&console.log(this.layer.getId(),"frameTimeStamp:",t,"drawTime:",this._drawTime)}},e.prototype._promiseResource=function(t){var e=this,r=this.resources,n=this.layer.options.crossOrigin;return function(i){if(r.isResourceLoaded(t,!0))i(t);else{var o=new Image;y(n)||(o.crossOrigin=n),O(t[0])&&!P&&(t[1]&&(t[1]*=2),t[2]&&(t[2]*=2)),o.onload=function(){e._cacheResource(t,o),i(t)},o.onabort=function(e){console&&console.warn("image loading aborted: "+t[0]),e&&console&&console.warn(e),i(t)},o.onerror=function(e){e&&"undefined"!=typeof console&&console.warn(e),r.markErrorResource(t),i(t)},k(o,t)}}},e.prototype._cacheResource=function(t,e){if(this.layer&&this.resources){var r=t[1],n=t[2];if(this.layer.options.cacheSvgOnCanvas&&1===O(t[0])&&(ue.edge||ue.ie)){y(r)&&(r=e.width||this.layer.options.defaultIconSize[0]),y(n)&&(n=e.height||this.layer.options.defaultIconSize[1]);var i=ar.createCanvas(r,n);ar.image(i.getContext("2d"),e,0,0,r,n),e=i}this.resources.addResource(t,e)}},e}(pr),Qr=function(){function t(){d(this,t),this.resources={},this._errors={}}return t.prototype.addResource=function(t,e){this.resources[t[0]]={image:e,width:+t[1],height:+t[2]}},t.prototype.isResourceLoaded=function(t,e){if(!t)return!1;var r=this._getImgUrl(t);if(this._errors[r])return!0;var n=this.resources[r];return!!n&&!(e&&O(t[0])&&(+t[1]>n.width||+t[2]>n.height))},t.prototype.getImage=function(t){var e=this._getImgUrl(t);return!this.isResourceLoaded(t)||this._errors[e]?null:this.resources[e].image},t.prototype.markErrorResource=function(t){this._errors[this._getImgUrl(t)]=1},t.prototype.merge=function(t){if(!t)return this;for(var e in t.resources){var r=t.resources[e];this.addResource([e,r.width,r.height],r.image)}return this},t.prototype.forEach=function(t){if(!this.resources)return this;for(var e in this.resources)C(this.resources,e)&&t(e,this.resources[e]);return this},t.prototype._getImgUrl=function(t){return Array.isArray(t)?t[0]:t},t}(),$r=function(t){function e(r,n){d(this,e);var i=void 0;n&&(i=n.canvas,delete n.canvas);var o=m(this,t.call(this,n));return i&&(o._canvas=i),o.setId(r),n&&o.setZIndex(n.zIndex),o}return p(e,t),e.prototype.load=function(){if(!this.getMap())return this;if(this.onLoad()){this._initRenderer();var t=this.getZIndex();y(t)||(this._renderer.setZIndex(t),this.isCanvasRender()||this._renderer.render()),this.onLoadEnd()}return this},e.prototype.getId=function(){return this._id},e.prototype.setId=function(t){var e=this._id;return y(t)||(t+=""),this._id=t,this.fire("idchange",{old:e,new:t}),this},e.prototype.addTo=function(t){return t.addLayer(this),this},e.prototype.setZIndex=function(t){return this._zIndex=t,this.map&&this.map._sortLayersByZIndex(),this._renderer&&this._renderer.setZIndex(t),this},e.prototype.getZIndex=function(){return this._zIndex||0},e.prototype.getMinZoom=function(){var t=this.getMap(),e=this.options.minZoom;return t?Math.max(t.getMinZoom(),e||0):e},e.prototype.getMaxZoom=function(){var t=this.getMap(),e=this.options.maxZoom;return t?Math.min(t.getMaxZoom(),y(e)?1/0:e):e},e.prototype.getOpacity=function(){return this.options.opacity},e.prototype.setOpacity=function(t){return this.config("opacity",t),this},e.prototype.isCanvasRender=function(){var t=this._getRenderer();return t&&t instanceof Kr},e.prototype.getMap=function(){return this.map?this.map:null},e.prototype.getProjection=function(){var t=this.getMap();return t?t.getProjection():null},e.prototype.bringToFront=function(){var t=this._getLayerList();if(!t.length)return this;var e=t[t.length-1];if(1===t.length||e===this)return this;var r=e.getZIndex();return this.setZIndex(r+1),this},e.prototype.bringToBack=function(){var t=this._getLayerList();if(!t.length)return this;var e=t[0];if(1===t.length||e===this)return this;var r=e.getZIndex();return this.setZIndex(r-1),this},e.prototype.show=function(){var t=this;if(!this.options.visible){this.options.visible=!0;var e=this.getRenderer();e&&e.show();var r=this.getMap();e&&r?r.once("renderend",function(){t.fire("show")}):this.fire("show")}return this},e.prototype.hide=function(){var t=this;if(this.options.visible){this.options.visible=!1;var e=this.getRenderer();e&&e.hide();var r=this.getMap();e&&r?r.once("renderend",function(){t.fire("hide")}):this.fire("hide")}return this},e.prototype.isVisible=function(){if(v(this.options.opacity)&&this.options.opacity<=0)return!1;var t=this.getMap();if(t){var e=t.getZoom();if(!y(this.options.maxZoom)&&this.options.maxZoom<e||!y(this.options.minZoom)&&this.options.minZoom>e)return!1}return y(this.options.visible)&&(this.options.visible=!0),this.options.visible},e.prototype.remove=function(){return this.map&&this.map.removeLayer(this),this},e.prototype.getMask=function(){return this._mask},e.prototype.setMask=function(t){if(!("Point"===t.type&&t._isVectorMarker()||"Polygon"===t.type))throw new Error("Mask for a layer must be a marker with vector marker symbol or a Polygon.");if("Point"===t.type?t.updateSymbol({markerLineColor:"rgba(0, 0, 0, 0)",markerFillOpacity:0}):t.setSymbol({lineColor:"rgba(0, 0, 0, 0)",polygonOpacity:0}),t._bindLayer(this),this._mask=t,!this.getMap()||this.getMap().isZooming())return this;var e=this._getRenderer();return e&&e.setToRedraw&&this._getRenderer().setToRedraw(),this},e.prototype.removeMask=function(){if(delete this._mask,!this.getMap()||this.getMap().isZooming())return this;var t=this._getRenderer();return t&&t.setToRedraw&&this._getRenderer().setToRedraw(),this},e.prototype.onLoad=function(){return!0},e.prototype.onLoadEnd=function(){},e.prototype.isLoaded=function(){return!!this._loaded},e.prototype.getRenderer=function(){return this._getRenderer()},e.prototype.onConfig=function(t){if(v(t.opacity)||t.cssFilter){var e=this.getRenderer();e&&e.setToRedraw()}},e.prototype.onAdd=function(){},e.prototype.onRemove=function(){},e.prototype._bindMap=function(t,e){t&&(this.map=t,y(e)||this.setZIndex(e),this._switchEvents("on",this),this.onAdd(),this.fire("add"))},e.prototype._initRenderer=function(){var t=this.options.renderer;if(this.constructor.getRendererClass){var e=this.constructor.getRendererClass(t);if(!e)throw new Error("Invalid renderer for Layer("+this.getId()+"):"+t);this._renderer=new e(this),this._renderer.layer=this,this._renderer.setZIndex(this.getZIndex()),this._switchEvents("on",this._renderer),this._renderer.onAdd&&this._renderer.onAdd(),this.fire("renderercreate",{renderer:this._renderer})}},e.prototype._doRemove=function(){this._loaded=!1,this.onRemove(),this._switchEvents("off",this),this._renderer&&(this._switchEvents("off",this._renderer),this._renderer.remove(),delete this._renderer),delete this._mask,delete this.map},e.prototype._switchEvents=function(t,e){e&&e.getEvents&&this.getMap()[t](e.getEvents(),e)},e.prototype._getRenderer=function(){return this._renderer},e.prototype._getLayerList=function(){return this.map?this.map._layers:[]},e.prototype._getMask2DExtent=function(){if(!this._mask||!this.getMap())return null;var t=this._mask._getPainter();return t?t.get2DExtent():null},e}(gr(cr(Zr(pr))));$r.mergeOptions({attribution:null,minZoom:null,maxZoom:null,visible:!0,opacity:1,globalCompositeOperation:null,renderer:"canvas",debugOutline:"#0f0",cssFilter:null,forceRenderOnMoving:!1,forceRenderOnZooming:!1,forceRenderOnRotating:!1});var tn=$r.prototype.fire;$r.prototype.fire=function(t,e){return"layerload"===t&&(this._loaded=!0),this.map&&(e||(e={}),e.type=t,e.target=this,this.map._onLayerEvent(e)),tn.apply(this,arguments)};var en={"EPSG:3857":{resolutions:function(){for(var t=[],e=12756274*Math.PI,r=0;r<21;r++)t[r]=e/(256*Math.pow(2,r));return t}(),fullExtent:{top:6378137*Math.PI,left:-6378137*Math.PI,bottom:-6378137*Math.PI,right:6378137*Math.PI}},"EPSG:4326":{fullExtent:{top:90,left:-180,bottom:-90,right:180},resolutions:function(){for(var t=[],e=0;e<20;e++)t[e]=180/(128*Math.pow(2,e));return t}()},BAIDU:{resolutions:function(){for(var t=Math.pow(2,18),e=[],r=0;r<20;r++)e[r]=t,t*=.5;return e[0]=null,e[1]=null,e[2]=null,e}(),fullExtent:{top:33554432,left:-33554432,bottom:-33554432,right:33554432}},IDENTITY:{resolutions:function(){for(var t=Math.pow(2,8),e=[],r=0;r<18;r++)e[r]=t,t*=.5;return e}(),fullExtent:{top:2e5,left:-2e5,bottom:-2e5,right:2e5}}};en["EPSG:4490"]=en["EPSG:4326"];var rn=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};d(this,t),this.options=e,this._initSpatialRef()}return t.getProjectionInstance=function(t){if(!t)return null;if(b(t))return t;for(var e in t=(t+"").toLowerCase(),Wr)if(C(Wr,e)){var r=Wr[e].code;if(r&&r.toLowerCase()===t)return Wr[e]}return null},t.equals=function(t,e){if(!t&&!e)return!0;if(!t||!e)return!1;if(t.projection!==e.projection)return!1;var r=t.fullExtent,n=e.fullExtent;if(r&&n&&(r.top!==n.top||r.bottom!==n.bottom||r.left!==n.left||r.right!==n.right))return!1;var i=t.resolutions,o=e.resolutions;if(i&&o){if(i.length!==o.length)return!1;for(var a=0;a<i.length;a++)if(i[a]!==o[a])return!1}return!0},t.prototype._initSpatialRef=function(){var e=this.options.projection;if(!(e=e?t.getProjectionInstance(e):Vr))throw new Error("must provide a valid projection in map's spatial reference.");(e=_({},Ar,e)).measureLength||_(e,Fr.DEFAULT),this._projection=e;var r=void 0,n=this.options.resolutions;if(!n&&(e.code&&(r=en[e.code])&&(n=r.resolutions),!n))throw new Error("must provide valid resolutions in map's spatial reference.");this._resolutions=n;var i=this.options.fullExtent;if(!i&&(e.code&&(r=en[e.code])&&(i=r.fullExtent),!i))throw new Error("must provide a valid fullExtent in map's spatial reference.");if(y(i.left)?(this._fullExtent=new Er(i),i.left=i.xmin,i.right=i.xmax,i.top=i.ymax,i.bottom=i.ymin):this._fullExtent=new Er(new br(i.left,i.top),new br(i.right,i.bottom)),y(i.top)||y(i.bottom)||y(i.left)||y(i.right))throw new Error("must provide valid top/bottom/left/right in fullExtent.");_(this._fullExtent,i),this._projection.fullExtent=i;var o=i.right>=i.left?1:-1,a=i.top>=i.bottom?-1:1;this._transformation=new Sr([o,a,0,0])},t.prototype.getResolutions=function(){return this._resolutions||[]},t.prototype.getResolution=function(t){var e=0|t;e<0?e=0:e>this._resolutions.length-1&&(e=this._resolutions.length-1);var r=this._resolutions[e];return x(t)||e===this._resolutions.length-1?r:r+(this._resolutions[e+1]-r)*(t-e)},t.prototype.getProjection=function(){return this._projection},t.prototype.getFullExtent=function(){return this._fullExtent},t.prototype.getTransformation=function(){return this._transformation},t.prototype.getMinZoom=function(){for(var t=0;t<this._resolutions.length;t++)if(!y(this._resolutions[t]))return t;return 0},t.prototype.getMaxZoom=function(){for(var t=this._resolutions.length-1;t>=0;t--)if(!y(this._resolutions[t]))return t;return this._resolutions.length-1},t.prototype.getZoomDirection=function(){return j(this._resolutions[this.getMinZoom()]-this._resolutions[this.getMaxZoom()])},t.prototype.toJSON=function(){return this.json||(this.json={resolutions:this._resolutions,fullExtent:{top:this._fullExtent.top,left:this._fullExtent.left,bottom:this._fullExtent.bottom,right:this._fullExtent.right},projection:this._projection.code}),this.json},t}(),nn={maxVisualPitch:60,maxPitch:80,centerCross:!1,zoomInCenter:!1,zoomAnimation:!P,zoomAnimationDuration:330,panAnimation:!P,panAnimationDuration:600,zoomable:!0,enableInfoWindow:!0,hitDetect:!ue.mobile,hitDetectLimit:5,fpsOnInteracting:25,layerCanvasLimitOnInteracting:-1,maxZoom:null,minZoom:null,maxExtent:null,checkSize:!0,renderer:"canvas"},on=function(t){function e(r,n){if(d(this,e),!n)throw new Error("Invalid options when creating map.");if(!n.center)throw new Error("Invalid center when creating map.");var i=_({},n),o=i.zoom;delete i.zoom;var a=new br(i.center);delete i.center;var s=i.baseLayer;delete i.baseLayer;var h=i.layers;delete i.layers;var u=m(this,t.call(this,i));return Object.defineProperty(u,"id",{value:I(),writable:!1}),u._loaded=!1,u._initContainer(r),u._panels={},u._baseLayer=null,u._layers=[],u._zoomLevel=o,u._center=a,u.setSpatialReference(i.spatialReference||i.view),u._mapViewPoint=new ce(0,0),u._initRenderer(),u._updateMapSize(u._getContainerDomSize()),s&&u.setBaseLayer(s),h&&u.addLayer(h),u._Load(),u}return p(e,t),e.addOnLoadHook=function(t){var e=Array.prototype.slice.call(arguments,1),r="function"==typeof t?t:function(){this[t].apply(this,e)};return this.prototype._onLoadHooks=this.prototype._onLoadHooks||[],this.prototype._onLoadHooks.push(r),this},e.prototype.isLoaded=function(){return!!this._loaded},e.prototype.getContainer=function(){return this._containerDOM},e.prototype.getSpatialReference=function(){return this._spatialReference},e.prototype.setSpatialReference=function(t){var e=this.options.spatialReference;if(this._loaded&&rn.equals(e,t))return this;if(t=_({},t),this._center=this.getCenter(),this.options.spatialReference=t,this._spatialReference=new rn(t),this.options.spatialReference&&T(this.options.spatialReference.projection)){var r=this._spatialReference.getProjection();this.options.spatialReference.projection=r.code}return this._resetMapStatus(),this._fireEvent("spatialreferencechange",{old:e,new:_({},this.options.spatialReference)}),this},e.prototype.onConfig=function(t){var e=t.spatialReference||t.view;return y(e)||this.setSpatialReference(e),this},e.prototype.getProjection=function(){return this._spatialReference?this._spatialReference.getProjection():null},e.prototype.getFullExtent=function(){return this._spatialReference?this._spatialReference.getFullExtent():null},e.prototype.setCursor=function(t){return delete this._cursor,this._trySetCursor(t),this._cursor=t,this},e.prototype.resetCursor=function(){return this.setCursor(null)},e.prototype.getCenter=function(){return this._loaded&&this._prjCenter?this.getProjection().unproject(this._prjCenter):this._center},e.prototype.setCenter=function(t){if(!t)return this;if(t=new br(t),!this._verifyExtent(t))return this;if(!this._loaded)return this._center=t,this;this.onMoveStart();var e=this.getProjection().project(t);return this._setPrjCenter(e),this.onMoveEnd(this._parseEventFromCoord(this.getCenter())),this},e.prototype.getSize=function(){return y(this.width)||y(this.height)?this._getContainerDomSize():new fe(this.width,this.height)},e.prototype.getContainerExtent=function(){var t=this.height,e=this.getPitch(),r=this.options.maxVisualPitch;return r&&e>r&&(t=this._getVisualHeight(r)),new Cr(0,this.height-t,this.width,this.height)},e.prototype._getVisualHeight=function(t){var e=this.getPitch(),r=this.height/2*Math.tan(t*Math.PI/180);return this.height/2+r*Math.tan((90-e)*Math.PI/180)},e.prototype.getExtent=function(){return this._pointToExtent(this._get2DExtent())},e.prototype.getProjExtent=function(){var t=this._get2DExtent();return new Er(this._pointToPrj(t.getMin()),this._pointToPrj(t.getMax()))},e.prototype.getPrjExtent=function(){return this.getProjExtent()},e.prototype.getMaxExtent=function(){return this.options.maxExtent?new Er(this.options.maxExtent,this.getProjection()):null},e.prototype.setMaxExtent=function(t){if(t){var e=new Er(t,this.getProjection());this.options.maxExtent=e;var r=this.getCenter();this._verifyExtent(r)||this.panTo(e.getCenter())}else delete this.options.maxExtent;return this},e.prototype.getZoom=function(){return this._zoomLevel},e.prototype.getZoomForScale=function(t,e,r){var n=this.getZoom();if(y(e)&&(e=n),1===t&&e===n)return n;var i=this._getResolution(e)/t,o=this.getZoomFromRes(i);if(r)return o;return this.getSpatialReference().getZoomDirection()<0?Math.ceil(o-1e-6):Math.floor(o+1e-6)},e.prototype.getZoomFromRes=function(t){var e=this._getResolutions(),r=this._getResolution(this.getMinZoom()),n=this._getResolution(this.getMaxZoom());if(r<=n){if(t<=r)return this.getMinZoom();if(t>=n)return this.getMaxZoom()}else{if(t>=r)return this.getMinZoom();if(t<=n)return this.getMaxZoom()}for(var i=e.length,o=0;o<i-1;o++)if(e[o]){var a=e[o+1]-e[o],s=t-e[o];if(j(a)===j(s)&&Math.abs(a)>=Math.abs(s))return o+s/a}return i-1},e.prototype.setZoom=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{animation:!0};return isNaN(t)||y(t)?this:(this._loaded&&this.options.zoomAnimation&&e.animation?this._zoomAnimation(t):this._zoom(t),this)},e.prototype.getMaxZoom=function(){return y(this.options.maxZoom)?this.getMaxNativeZoom():this.options.maxZoom},e.prototype.setMaxZoom=function(t){var e=this.getMaxNativeZoom();return t>e&&(t=e),null!==t&&t<this._zoomLevel&&this.setZoom(t),this.options.maxZoom=t,this},e.prototype.getMinZoom=function(){return y(this.options.minZoom)?this._spatialReference.getMinZoom():this.options.minZoom},e.prototype.setMinZoom=function(t){if(null!==t){var e=this._spatialReference.getMinZoom();t<e&&(t=e),t>this._zoomLevel&&this.setZoom(t)}return this.options.minZoom=t,this},e.prototype.getMaxNativeZoom=function(){var t=this.getSpatialReference();return t?t.getMaxZoom():null},e.prototype.getGLZoom=function(){return this.getMaxNativeZoom()/2},e.prototype.getGLScale=function(t){return y(t)&&(t=this.getZoom()),this.getScale(t)/this.getScale(this.getGLZoom())},e.prototype.zoomIn=function(){return this.setZoom(this.getZoom()+1)},e.prototype.zoomOut=function(){return this.setZoom(this.getZoom()-1)},e.prototype.isZooming=function(){return!!this._zooming},e.prototype.isInteracting=function(){return this.isZooming()||this.isMoving()||this.isRotating()},e.prototype.setCenterAndZoom=function(t,e){return y(e)||this._zoomLevel===e?this.setCenter(t):(this.setCenter(t),this.setZoom(e,{animation:!1})),this},e.prototype.getFitZoom=function(t){var e=this;if(!(t&&t instanceof Er))return this._zoomLevel;if(t.xmin===t.xmax&&t.ymin===t.ymax)return this.getMaxZoom();var r=this.getSize(),n=t.convertTo(function(t){return e.coordToContainerPoint(t)}),i=n.getWidth(),o=n.getHeight(),a=r.width/i,s=r.height/o,h=this.getSpatialReference().getZoomDirection()<0?Math.max(a,s):Math.min(a,s);return this.getZoomForScale(h)},e.prototype.getView=function(){return{center:this.getCenter().toArray(),zoom:this.getZoom(),pitch:this.getPitch(),bearing:this.getBearing()}},e.prototype.setView=function(t){return t?(t.center&&this.setCenter(t.center),t.zoom&&this.setZoom(t.zoom,{animation:!1}),t.pitch&&this.setPitch(t.pitch),t.bearing&&this.setBearing(t.bearing),this):this},e.prototype.getResolution=function(t){return this._getResolution(t)},e.prototype.getScale=function(t){var e=y(t)?this.getZoom():t,r=this._getResolution(this.getMaxNativeZoom());return this._getResolution(e)/r},e.prototype.fitExtent=function(t,e){if(!t)return this;t=new Er(t,this.getProjection());var r=this.getFitZoom(t)+(e||0),n=t.getCenter();return this.setCenterAndZoom(n,r)},e.prototype.getBaseLayer=function(){return this._baseLayer},e.prototype.setBaseLayer=function(t){var e=!1;if(this._baseLayer&&(e=!0,this._fireEvent("baselayerchangestart"),this._baseLayer.remove()),!t)return delete this._baseLayer,this._fireEvent("baselayerchangeend"),this._fireEvent("setbaselayer"),this;return this._baseLayer=t,t._bindMap(this,-1),this._baseLayer.on("layerload",function(){this._fireEvent("baselayerload"),e&&(e=!1,this._fireEvent("baselayerchangeend"))},this),this._loaded&&this._baseLayer.load(),this._fireEvent("setbaselayer"),this},e.prototype.removeBaseLayer=function(){return this._baseLayer&&(this._baseLayer.remove(),delete this._baseLayer,this._fireEvent("baselayerremove")),this},e.prototype.getLayers=function(t){return this._getLayers(function(e){return!(e===this._baseLayer||e.getId().indexOf(o)>=0)&&(!t||t(e))})},e.prototype.getLayer=function(t){if(!t)return null;var e=this._layerCache?this._layerCache[t]:null;if(e)return e;var r=this.getBaseLayer();return r&&r.getId()===t?r:null},e.prototype.addLayer=function(t){if(!t)return this;if(!Array.isArray(t))return t=Array.prototype.slice.call(arguments,0),this.addLayer(t);this._layerCache||(this._layerCache={});for(var e=this._layers,r=0,n=t.length;r<n;r++){var i=t[r],o=i.getId();if(y(o))throw new Error("Invalid id for the layer: "+o);if(i.getMap()!==this){if(this._layerCache[o])throw new Error("Duplicate layer id in the map: "+o);this._layerCache[o]=i,i._bindMap(this),e.push(i),this._loaded&&i.load()}}return this._sortLayersByZIndex(),this._fireEvent("addlayer",{layers:t}),this},e.prototype.removeLayer=function(t){if(!t)return this;if(!Array.isArray(t))return this.removeLayer([t]);for(var e=[],r=0,n=t.length;r<n;r++){var i=t[r];if(i instanceof $r||(i=this.getLayer(i)),i){var o=i.getMap();if(o&&o===this){e.push(i),this._removeLayer(i,this._layers),this._loaded&&i._doRemove();var a=i.getId();this._layerCache&&delete this._layerCache[a]}}}return e.length>0&&this.once("frameend",function(){e.forEach(function(t){t.fire("remove")})}),this._fireEvent("removelayer",{layers:t}),this},e.prototype.sortLayers=function(t){if(!t||!Array.isArray(t))return this;for(var e=[],r=Number.MAX_VALUE,n=0,i=t.length;n<i;n++){var o=t[n];if(w(t[n])&&(o=this.getLayer(o)),!(o instanceof $r&&o.getMap()&&o.getMap()===this))throw new Error("It must be a layer added to this map to order.");o.getZIndex()<r&&(r=o.getZIndex()),e.push(o)}for(var a=0,s=e.length;a<s;a++)e[a].setZIndex(r+a);return this},e.prototype.toDataURL=function(t){t||(t={});var e=t.mimeType;e||(e="image/png");var r=t.save,n=this._getRenderer();if(n&&n.toDataURL){var i=t.fileName;i||(i="export");var o=n.toDataURL(e);if(r&&o){var a=void 0;if("undefined"!=typeof Blob&&"undefined"!=typeof atob){var s=et(o.replace(/^data:image\/(png|jpeg|jpg);base64,/,""),e);a=URL.createObjectURL(s)}else a=o;var h=document.createElement("a");h.download=i,h.href=a,document.body.appendChild(h),h.click(),document.body.removeChild(h)}return o}return null},e.prototype.coordinateToPoint=function(t,e){var r=this.getProjection().project(t);return this._prjToPoint(r,e)},e.prototype.coordToPoint=function(t,e){return this.coordinateToPoint(t,e)},e.prototype.pointToCoordinate=function(t,e){var r=this._pointToPrj(t,e);return this.getProjection().unproject(r)},e.prototype.pointToCoord=function(t,e){return this.pointToCoordinate(t,e)},e.prototype.coordinateToViewPoint=function(t){return this._prjToViewPoint(this.getProjection().project(t))},e.prototype.coordToViewPoint=function(t){return this.coordinateToViewPoint(t)},e.prototype.viewPointToCoordinate=function(t){return this.getProjection().unproject(this._viewPointToPrj(t))},e.prototype.viewPointToCoord=function(t){return this.viewPointToCoordinate(t)},e.prototype.coordinateToContainerPoint=function(t,e){var r=this.getProjection().project(t);return this._prjToContainerPoint(r,e)},e.prototype.coordToContainerPoint=function(t,e){return this.coordinateToContainerPoint(t,e)},e.prototype.containerPointToCoordinate=function(t){var e=this._containerPointToPrj(t);return this.getProjection().unproject(e)},e.prototype.containerPointToCoord=function(t){return this.containerPointToCoordinate(t)},e.prototype.containerPointToViewPoint=function(t){return t.sub(this.getViewPoint())},e.prototype.viewPointToContainerPoint=function(t){return t.add(this.getViewPoint())},e.prototype.containerToExtent=function(t){var e=new Cr(this._containerPointToPoint(t.getMin()),this._containerPointToPoint(t.getMax()));return this._pointToExtent(e)},e.prototype.checkSize=function(){var t=g()-this._initTime<1500&&0===this.width||0===this.height,e=this._getContainerDomSize(),r=this.height,n=this.width;if(e.width===n&&e.height===r)return this;var i=this.getCenter();this._updateMapSize(e);var o=new ce((n-e.width)/2,(r-e.height)/2);this._offsetCenterByPixel(o),this._mapViewCoord=this._getPrjCenter();var a=0===e.width||0===e.height||0===n||0===r;return(t||a)&&(this._noEvent=!0,this.setCenter(i),delete this._noEvent),this._fireEvent("resize"),this},e.prototype.distanceToPixel=function(t,e,r){var n=this.getProjection();if(!n)return null;var i=this.getScale()/this.getScale(r),o=this.getCenter(),a=n.locate(o,t,e),s=this.coordToContainerPoint(o),h=this.coordToContainerPoint(a);return h._sub(s)._multi(i)._abs(),new fe(h.x,h.y)},e.prototype.distanceToPoint=function(t,e,r){var n=this.getProjection();if(!n)return null;var i=this.getCenter(),o=n.locate(i,t,e),a=this.coordToPoint(i,r),s=this.coordToPoint(o,r);return s._sub(a)._abs(),s},e.prototype.pixelToDistance=function(t,e){var r=this.getProjection();if(!r)return null;var n=this.getFullExtent(),i=n.top>n.bottom?-1:1,o=new ce(this.width/2+t,this.height/2+i*e),a=this.containerPointToCoord(o);return r.measureLength(this.getCenter(),a)},e.prototype.pointToDistance=function(t,e,r){var n=this.getProjection();if(!n)return null;var i=this._prjToPoint(this._getPrjCenter(),r);i._add(t,e);var o=this.pointToCoord(i,r);return n.measureLength(this.getCenter(),o)},e.prototype.locate=function(t,e,r){return this.getProjection()._locate(new br(t),e,r)},e.prototype.locateByPoint=function(t,e,r){var n=this.coordToContainerPoint(t);return this.containerPointToCoord(n._add(e,r))},e.prototype.getMainPanel=function(){return this._getRenderer().getMainPanel()},e.prototype.getPanels=function(){return this._panels},e.prototype.remove=function(){if(this.isRemoved())return this;this._fireEvent("removestart"),this._removeDomEvents(),this._clearHandlers(),this.removeBaseLayer();for(var t=this.getLayers(),e=0;e<t.length;e++)t[e].remove();return this._getRenderer()&&this._getRenderer().remove(),this._containerDOM.innerHTML&&(this._containerDOM.innerHTML=""),delete this._panels,delete this._containerDOM,delete this.renderer,this._fireEvent("removeend"),this._clearAllListeners(),this},e.prototype.isRemoved=function(){return!this._containerDOM},e.prototype.isMoving=function(){return!!this._moving},e.prototype.onMoveStart=function(t){this._originCenter=this.getCenter(),this._moving=!0,this._trySetCursor("move"),this._fireEvent("movestart",this._parseEvent(t?t.domEvent:null,"movestart"))},e.prototype.onMoving=function(t){this._fireEvent("moving",this._parseEvent(t?t.domEvent:null,"moving"))},e.prototype.onMoveEnd=function(t){if(this._moving=!1,this._trySetCursor("default"),this._fireEvent("moveend",t&&t.domEvent?this._parseEvent(t.domEvent,"moveend"):t),!this._verifyExtent(this.getCenter())){var e=this._originCenter;this._verifyExtent(e)||(e=this.getMaxExtent().getCenter()),this.panTo(e)}},e.prototype.onDragRotateStart=function(t){this._dragRotating=!0,this._fireEvent("dragrotatestart",this._parseEvent(t?t.domEvent:null,"dragrotatestart"))},e.prototype.onDragRotating=function(t){this._fireEvent("dragrotating",this._parseEvent(t?t.domEvent:null,"dragrotating"))},e.prototype.onDragRotateEnd=function(t){this._dragRotating=!1,this._fireEvent("dragrotateend",this._parseEvent(t?t.domEvent:null,"dragrotateend"))},e.prototype.isDragRotating=function(){return!!this._dragRotating},e.prototype.getRenderer=function(){return this._getRenderer()},e.prototype._initContainer=function(t){if(w(t)){if(this._containerDOM=document.getElementById(t),!this._containerDOM)throw new Error("Invalid container when creating map: '"+t+"'")}else this._containerDOM=t,P&&(this.CanvasClass=this._containerDOM.constructor);if(this._containerDOM.childNodes&&this._containerDOM.childNodes.length>0&&"maptalks-wrapper"===this._containerDOM.childNodes[0].className)throw new Error("Container is already loaded with another map instance, use map.remove() to clear it.")},e.prototype._trySetCursor=function(t){return this._cursor||this._priorityCursor||(t||(t="default"),this._setCursorToPanel(t)),this},e.prototype._setPriorityCursor=function(t){if(t)this._priorityCursor=t,this._setCursorToPanel(t);else{var e=!1;this._priorityCursor&&(e=!0),delete this._priorityCursor,e&&this.setCursor(this._cursor)}return this},e.prototype._setCursorToPanel=function(t){var e=this.getMainPanel();e&&e.style&&e.style.cursor!==t&&(e.style.cursor=t)},e.prototype._get2DExtent=function(t){var e=this;return this.getContainerExtent().convertTo(function(r){return e._containerPointToPoint(r,t)})},e.prototype._pointToExtent=function(t){var e=t.getMin(),r=t.getMax(),n=this.getFullExtent(),i=!n||n.left<=n.right?[e.x,r.x]:[r.x,e.x],o=i[0],a=i[1],s=!n||n.top>n.bottom?[r.y,e.y]:[e.y,r.y],h=s[1],u=new br(o,s[0]),l=new br(a,h);return new Er(this.pointToCoord(u),this.pointToCoord(l),this.getProjection())},e.prototype._removeLayer=function(t,e){if(t&&e){var r=e.indexOf(t);r>-1&&e.splice(r,1)}},e.prototype._sortLayersByZIndex=function(){if(this._layers){for(var t=0,e=this._layers.length;t<e;t++)this._layers[t]._order=t;this._layers.sort(function(t,e){var r=t.getZIndex()-e.getZIndex();return 0===r?t._order-e._order:r})}},e.prototype._fireEvent=function(t,e){this._noEvent||(this.fire("_"+t,e),this.fire(t,e))},e.prototype._Load=function(){this._resetMapStatus(),this.options.pitch&&(this.setPitch(this.options.pitch),delete this.options.pitch),this.options.bearing&&(this.setBearing(this.options.bearing),delete this.options.bearing),this._loadAllLayers(),this._getRenderer().onLoad(),this._loaded=!0,this._callOnLoadHooks(),this._initTime=g()},e.prototype._initRenderer=function(){var t=this.options.renderer,r=e.getRendererClass(t);this._renderer=new r(this),this._renderer.load()},e.prototype._getRenderer=function(){return this._renderer},e.prototype._loadAllLayers=function(){this._baseLayer&&this._baseLayer.load(),this._eachLayer(function(t){t&&t.load()},this.getLayers())},e.prototype._getLayers=function(t){for(var e=this._baseLayer?[this._baseLayer].concat(this._layers):this._layers,r=[],n=0;n<e.length;n++)t&&!t.call(this,e[n])||r.push(e[n]);return r},e.prototype._eachLayer=function(t){if(!(arguments.length<2)){var e=Array.prototype.slice.call(arguments,1);e&&!Array.isArray(e)&&(e=[e]);for(var r=[],n=0,i=e.length;n<i;n++)r=r.concat(e[n]);for(var o=0,a=r.length;o<a;o++)t.call(t,r[o])}},e.prototype._onLayerEvent=function(t){t&&"idchange"===t.type&&(delete this._layerCache[t.old],this._layerCache[t.new]=t.target)},e.prototype._resetMapStatus=function(){var t=this.getMaxZoom(),e=this.getMinZoom(),r=this._spatialReference.getMaxZoom(),n=this._spatialReference.getMinZoom();(y(t)||-1===t||t>r)&&this.setMaxZoom(r),(y(e)||-1===e||e<n)&&this.setMinZoom(n),(t=this.getMaxZoom())<(e=this.getMinZoom())&&this.setMaxZoom(e),(y(this._zoomLevel)||this._zoomLevel>t)&&(this._zoomLevel=t),this._zoomLevel<e&&(this._zoomLevel=e),delete this._prjCenter;var i=this.getProjection();this._prjCenter=i.project(this._center),this._calcMatrices();var o=this._getRenderer();o&&o.resetContainer()},e.prototype._getContainerDomSize=function(){if(!this._containerDOM)return null;var t=this._containerDOM,e=void 0,r=void 0;if(y(t.width)||y(t.height)){if(y(t.clientWidth)||y(t.clientHeight))throw new Error("can not get size of container");e=parseInt(t.clientWidth,0),r=parseInt(t.clientHeight,0)}else e=t.width,r=t.height,ue.retina&&t.layer&&(e/=2,r/=2);return new fe(e,r)},e.prototype._updateMapSize=function(t){return this.width=t.width,this.height=t.height,this._getRenderer().updateMapSize(t),this._calcMatrices(),this},e.prototype._getPrjCenter=function(){return this._prjCenter},e.prototype._setPrjCenter=function(t){this._prjCenter=t,this.isInteracting()&&!this.isMoving()&&(this._mapViewCoord=t),this._calcMatrices()},e.prototype._setPrjCoordAtContainerPoint=function(t,e){if(e.x===this.width/2&&e.y===this.height/2)return this;var r=this._containerPointToPoint(e)._sub(this._prjToPoint(this._getPrjCenter())),n=this._pointToPrj(this._prjToPoint(t).sub(r));return this._setPrjCenter(n),this},e.prototype._verifyExtent=function(t){if(!t)return!1;var e=this.getMaxExtent();return!e||e.contains(t)},e.prototype._offsetCenterByPixel=function(t){var e=new ce(this.width/2-t.x,this.height/2-t.y),r=this._containerPointToPrj(e);return this._setPrjCenter(r),r},e.prototype.offsetPlatform=function(t){return t?(this._getRenderer().offsetPlatform(t),this._mapViewCoord=this._getPrjCenter(),this._mapViewPoint=this._mapViewPoint.add(t),this):this._mapViewPoint},e.prototype.getViewPoint=function(){var t=this._getViewPointFrameOffset(),e=this.offsetPlatform();return t&&(e=e.add(t)),e},e.prototype._getViewPointFrameOffset=function(){if(this.isZooming())return null;var t=this._getPrjCenter();return this._mapViewCoord&&!this._mapViewCoord.equals(t)?this._prjToContainerPoint(this._mapViewCoord).sub(this._prjToContainerPoint(t)):null},e.prototype._resetMapViewPoint=function(){this._mapViewPoint=new ce(0,0),this._mapViewCoord=this._getPrjCenter()},e.prototype._getResolution=function(t){return y(t)&&(t=this.getZoom()),this._spatialReference.getResolution(t)},e.prototype._getResolutions=function(){return this._spatialReference.getResolutions()},e.prototype._prjToPoint=function(t,e){return e=y(e)?this.getZoom():e,this._spatialReference.getTransformation().transform(t,this._getResolution(e))},e.prototype._pointToPrj=function(t,e){return e=y(e)?this.getZoom():e,this._spatialReference.getTransformation().untransform(t,this._getResolution(e))},e.prototype._pointToPoint=function(t,e){return y(e)?t.copy():t.multi(this._getResolution(e)/this._getResolution())},e.prototype._pointToPointAtZoom=function(t,e){return y(e)?t.copy():t.multi(this._getResolution()/this._getResolution(e))},e.prototype._containerPointToPrj=function(t){return this._pointToPrj(this._containerPointToPoint(t))},e.prototype._viewPointToPrj=function(t){return this._containerPointToPrj(this.viewPointToContainerPoint(t))},e.prototype._prjToContainerPoint=function(t,e){return this._pointToContainerPoint(this._prjToPoint(t,e),e)},e.prototype._prjToViewPoint=function(t){var e=this._prjToContainerPoint(t);return this._containerPointToViewPoint(e)},e.prototype._containerPointToViewPoint=function(t){return t?t._sub(this.getViewPoint()):null},e.prototype._viewPointToPoint=function(t,e){return this._containerPointToPoint(this.viewPointToContainerPoint(t),e)},e.prototype._pointToViewPoint=function(t,e){return this._prjToViewPoint(this._pointToPrj(t,e))},e.prototype._callOnLoadHooks=function(){var t=e.prototype;if(t._onLoadHooks)for(var r=0,n=t._onLoadHooks.length;r<n;r++)t._onLoadHooks[r].call(this)},e}(_r(cr(Zr(pr))));on.mergeOptions(nn);var an=function(t){function e(){return d(this,e),m(this,t.apply(this,arguments))}return p(e,t),e.prototype.addHooks=function(){this.target&&this.target.on("_dblclick",this._onDoubleClick,this)},e.prototype.removeHooks=function(){this.target&&this.target.off("_dblclick",this._onDoubleClick,this)},e.prototype._onDoubleClick=function(t){var e=this.target;if(e.options.doubleClickZoom){var r=e.getZoom(),n=t.domEvent.shiftKey?Math.ceil(r)-1:Math.floor(r)+1;e._zoomAnimation(n,t.containerPoint)}},e}(dr);on.mergeOptions({doubleClickZoom:!0}),on.addOnLoadHook("addHandler","doubleClickZoom",an);var sn=function(t){function e(){return d(this,e),m(this,t.apply(this,arguments))}return p(e,t),e.prototype.addHooks=function(){var t=this.target;if(t){var e=t._panels.mapWrapper||t._containerDOM;this._dragHandler=new xr(e,{cancelOn:this._cancelOn.bind(this),rightclick:!0}),this._dragHandler.on("mousedown",this._onMouseDown,this).on("dragstart",this._onDragStart,this).on("dragging",this._onDragging,this).on("dragend",this._onDragEnd,this).enable()}},e.prototype.removeHooks=function(){this._dragHandler.off("mousedown",this._onMouseDown,this).off("dragstart",this._onDragStart,this).off("dragging",this._onDragging,this).off("dragend",this._onDragEnd,this),this._dragHandler.remove(),delete this._dragHandler},e.prototype._cancelOn=function(t){return!(!this.target.isZooming()&&!this._ignore(t))},e.prototype._ignore=function(t){return!!t&&(t.domEvent&&(t=t.domEvent),this.target._ignoreEvent(t))},e.prototype._onMouseDown=function(t){delete this.startDragTime,delete this._mode,2===t.domEvent.button||t.domEvent.ctrlKey?(this.target.options.dragRotate||this.target.options.dragPitch)&&(this._mode="rotatePitch"):this.target.options.dragPan&&(this._mode="move"),this.target._stopAnim(this.target._animPlayer),Ue(t.domEvent)},e.prototype._onDragStart=function(t){this.startDragTime=g(),"move"===this._mode?this._moveStart(t):"rotatePitch"===this._mode&&this._rotateStart(t)},e.prototype._onDragging=function(t){this.target._isEventOutMap(t.domEvent)||("move"===this._mode?this._moving(t):"rotatePitch"===this._mode&&this._rotating(t))},e.prototype._onDragEnd=function(t){"move"===this._mode?this._moveEnd(t):"rotatePitch"===this._mode&&this._rotateEnd(t),delete this.startDragTime,delete this.startBearing},e.prototype._start=function(t){this.preX=t.mousePos.x,this.preY=t.mousePos.y,this.startX=this.preX,this.startY=this.preY},e.prototype._moveStart=function(t){this._start(t);var e=this.target;e.onMoveStart(t);var r=We(e._getActualEvent(t.domEvent),e.getContainer());this.startPrjCoord=e._containerPointToPrj(r)},e.prototype._moving=function(t){if(this.startDragTime){var e=this.target,r=We(e._getActualEvent(t.domEvent),e.getContainer());e._setPrjCoordAtContainerPoint(this.startPrjCoord,r),e.onMoving(t)}},e.prototype._moveEnd=function(t){if(this.startDragTime){var e=this.target,r=g()-this.startDragTime,n=t.mousePos.x,i=t.mousePos.y,o=n-this.startX,a=i-this.startY;this._clear(),e.options.panAnimation&&!t.interupted&&e._verifyExtent(e.getCenter())&&r<280&&Math.abs(a)+Math.abs(o)>5?(r=5*r*(Math.abs(o)+Math.abs(a))/500,e.panBy(new ce(o,a),{duration:r})):e.onMoveEnd(t)}},e.prototype._rotateStart=function(t){this._start(t),delete this._rotateMode,this.startBearing=this.target.getBearing(),this.target.onDragRotateStart(t),this._db=0},e.prototype._rotating=function(t){var e=this.target,r=t.mousePos.x,n=t.mousePos.y,i=e.getPitch(),o=e.getBearing(),a=Math.abs(r-this.preX),s=Math.abs(n-this.preY);if(this._rotateMode||(e.options.dragRotatePitch?this._rotateMode="rotate_pitch":this._rotateMode=a>s?"rotate":a<s?"pitch":"rotate"),!("pitch"===this._rotateMode&&0===i&&s<10)){if(this._rotateMode.indexOf("rotate")>=0&&e.options.dragRotate){var h=0;h=e.options.dragPitch||a>s?-.6*(this.preX-r):r>e.width/2?.6*(this.preY-n):-.6*(this.preY-n);var u=e.getBearing()+h;this._db=this._db||0,this._db+=h,e.setBearing(u)}this._rotateMode.indexOf("pitch")>=0&&e.options.dragPitch&&e.setPitch(e.getPitch()+.4*(this.preY-n)),this.preX=r,this.preY=n,e.getBearing()===o&&e.getPitch()===i||e.onDragRotating(t)}},e.prototype._rotateEnd=function(t){var e=this.target,r=e.getBearing();this._clear();var n=g()-this.startDragTime;if(e.onDragRotateEnd(t),Math.abs(r-this.startBearing)>20&&("rotate"===this._rotateMode||"rotate_pitch"===this._rotateMode)&&!t.interupted&&n<400){var i=e.getBearing();e.animateTo({bearing:i+this._db/2},{easing:"out",duration:800})}},e.prototype._clear=function(){delete this.startPrjCoord,delete this.preX,delete this.preY,delete this.startX,delete this.startY},e}(dr);function hn(t,e,r,n){for(var i=[],o=0,a=void 0,s=0,h=t.length;s<h-1;s++)(a=ln(t[s],t[s+1],e,s,r,n))&&(i[o]=i[o]||[],i[o].push({point:a[0],index:s}),a[1]===t[s+1]&&s!==h-2||(i[o].push({point:a[1],index:s+1}),o++));return i}on.mergeOptions({draggable:!0,dragPan:!0,dragRotatePitch:!0,dragRotate:!0,dragPitch:!0}),on.addOnLoadHook("addHandler","draggable",sn);var un=void 0;function ln(t,e,r,n,i,o){var a=n?un:dn(t,r),s=dn(e,r),h=void 0,u=void 0,l=void 0;for(un=s;;){if(!(a|s))return[t,e];if(a&s)return!1;if(o)return[t,e];l=dn(u=fn(t,e,h=a||s,r,i),r),h===a?(t=u,a=l):(e=u,s=l)}}function cn(t,e,r){var n=[1,4,2,8],i=void 0,o=void 0,a=void 0,s=void 0,h=void 0,u=void 0,l=void 0,c=void 0,f=void 0;for(o=0,l=t.length;o<l;o++)t[o]._code=dn(t[o],e);for(s=0;s<4;s++){for(c=n[s],i=[],o=0,a=(l=t.length)-1;o<l;a=o++)h=t[o],u=t[a],h._code&c?u._code&c||((f=fn(u,h,c,e,r))._code=dn(f,e),i.push(f)):(u._code&c&&((f=fn(u,h,c,e,r))._code=dn(f,e),i.push(f)),i.push(h));t=i}return t}function fn(t,e,r,n,i){var o=e.x-t.x,a=e.y-t.y,s=n.getMin(),h=n.getMax(),u=void 0,l=void 0;8&r?(u=t.x+o*(h.y-t.y)/a,l=h.y):4&r?(u=t.x+o*(s.y-t.y)/a,l=s.y):2&r?(u=h.x,l=t.y+a*(h.x-t.x)/o):1&r&&(u=s.x,l=t.y+a*(s.x-t.x)/o);var c=new ce(u,l);return i&&c._round(),c}function dn(t,e){var r=0;return t.x<e.getMin().x?r|=1:t.x>e.getMax().x&&(r|=2),t.y<e.getMin().y?r|=4:t.y>e.getMax().y&&(r|=8),r}function pn(t,e,r,n){t=new ce(t);var i=Math.abs(r.x-e.x),o=Math.abs(r.y-e.y),a=Math.sqrt(Math.abs(i*i-o*o)),s=void 0,h=void 0,u=void 0;return i>=o?(s=new ce(e.x-a,e.y),h=new ce(e.x+a,e.y),u=2*i):(s=new ce(e.x,e.y-a),h=new ce(e.x,e.y+a),u=2*o),t.distanceTo(s)+t.distanceTo(h)<=u+2*n}var mn=function(){function t(){d(this,t)}return t.prototype.getMap=function(){return this.geometry.getMap()},t.prototype.getPainter=function(){return this.painter},t.testColor=function(t){return!(!t||!w(t))&&c.indexOf(t)>=0},t}(),gn=function(t){function e(){return d(this,e),m(this,t.apply(this,arguments))}return p(e,t),e.prototype._prepareContext=function(t){v(this.symbol.opacity)?t.globalAlpha!==this.symbol.opacity&&(t.globalAlpha=this.symbol.opacity):1!==t.globalAlpha&&(t.globalAlpha=1)},e.prototype.prepareCanvas=function(t,e,r){ar.prepareCanvas(t,e,r,this.getPainter().isHitTesting())},e.prototype.remove=function(){},e.prototype.setZIndex=function(){},e.prototype.show=function(){},e.prototype.hide=function(){},e.prototype._defineStyle=function(t){return function(){var e=this,r=[],n={};return Mt(t,function(){var t=e.getMap();return function(t,e,r){return t[0]=e,t[1]=r,t}(r,t.getZoom(),_({},e.geometry.getProperties(),function(t,e,r,n){return t["{bearing}"]=e,t["{pitch}"]=r,t["{zoom}"]=n,t}(n,t.getBearing(),t.getPitch(),t.getZoom())))})}.bind(this)()},e}(mn);var _n=function(t){function e(r,n,i){d(this,e);var o=m(this,t.call(this));return o.symbol=r,o.geometry=n,o.painter=i,o}return p(e,t),e.prototype.get2DExtent=function(){for(var t=this.getMap(),e=t.getGLZoom(),r=new Cr,n=this._getRenderPoints()[0],i=n.length-1;i>=0;i--)n[i]&&r._combine(t._pointToPoint(n[i],e));return r},e.prototype._rotateExtent=function(t,e){return t.convertTo(function(t){return t._rotate(e)})},e.prototype._getRenderPoints=function(){return this.getPainter().getRenderPoints(this.getPlacement())},e.prototype._getRenderContainerPoints=function(t){var e=this.getPainter(),r=this._getRenderPoints()[0];if(e.isSpriting())return r;var n=this.getDxDy(),i=this.painter._pointContainerPoints(r,n.x,n.y,t,!0,this.getPlacement());if(!i||!Array.isArray(i[0]))return i;for(var o=[],a=0,s=i.length;a<s;a++)for(var h=0,u=i[a].length;h<u;h++)o.push(i[a][h]);return o},e.prototype._getRotationAt=function(t){var e=this.getRotation();e||(e=0);var r=this._getRenderPoints()[1];if(!r||!r[t])return e;var n=this.getMap(),i=r[t][0],o=r[t][1];if(n.isTransforming()){var a=n.getGLZoom();i=n._pointToContainerPoint(r[t][0],a),o=n._pointToContainerPoint(r[t][1],a)}return e+rt(i.x,i.y,o.x,o.y)},e.prototype._rotate=function(t,e,r){if(r){var n=this.getDxDy(),i=e.sub(n);return t.save(),t.translate(i.x,i.y),t.rotate(r),this.getDxDy()}return null},e}(gn),yn=function(t){function e(r,n,i){d(this,e);var o=m(this,t.call(this,r,n,i));o._dynamic=St(r),o.style=o._defineStyle(o.translate()),o.strokeAndFill=o._defineStyle(e.translateLineAndFill(o.style));var a=o.strokeAndFill.lineWidth;return o.padding=a%2==0?2:1.5,o}return p(e,t),e.test=function(t){return!!t&&!(!y(t.markerFile)||y(t.markerType)||"path"===t.markerType)},e.prototype.symbolize=function(t,e){var r=this.style;if(this.painter.isHitTesting()||0!==r.markerWidth&&0!==r.markerHeight&&(0!==r.polygonOpacity||0!==r.lineOpacity)){var n=this._getRenderContainerPoints();X(n)&&(this._prepareContext(t),this.getPainter().isSpriting()||this.geometry.getLayer().getMask()===this.geometry||this._dynamic||!1===this.geometry.getLayer().options.cacheVectorOnCanvas?this._drawMarkers(t,n,e):this._drawMarkersWithCache(t,n,e))}},e.prototype.getDxDy=function(){var t=this.style,e=t.markerDx,r=t.markerDy;return new ce(e,r)},e.prototype._drawMarkers=function(t,e,r){var n=this.strokeAndFill;Nt(n.lineColor)||Nt(n.polygonFill)||this.prepareCanvas(t,n,r);for(var i=e.length-1;i>=0;i--){var o=e[i],a=this._rotate(t,o,this._getRotationAt(i));a&&(o=a),this._drawVectorMarker(t,o,r),a&&t.restore()}},e.prototype._drawMarkersWithCache=function(t,e,r){var n=this._stampSymbol(),i=r.getImage(n);i||(i=this._createMarkerImage(t,r),r.addResource([n,i.width,i.height],i));for(var o=this._getAnchor(i.width,i.height),a=e.length-1;a>=0;a--){var s=e[a],h=this._rotate(t,s,this._getRotationAt(a));h&&(s=h),ar.image(t,i,s.x+o.x,s.y+o.y),h&&t.restore()}},e.prototype._calMarkerSize=function(){if(!this._size){var t=this.strokeAndFill.lineWidth,e=2*(this.symbol.shadowBlur||0),r=Math.round(this.style.markerWidth+t+2*e+2*this.padding),n=Math.round(this.style.markerHeight+t+2*e+2*this.padding);this._size=[r,n]}return this._size},e.prototype._createMarkerImage=function(t,e){var r=t.canvas.constructor,n=this._calMarkerSize(),i=ar.createCanvas(n[0],n[1],r),o=this._getCacheImageAnchor(n[0],n[1]),a=i.getContext("2d");return Nt(this.strokeAndFill.lineColor)||Nt(this.strokeAndFill.polygonFill)||this.prepareCanvas(a,this.strokeAndFill,e),this._drawVectorMarker(a,o,e),i},e.prototype._stampSymbol=function(){return this._stamp||(this._stamp=[this.style.markerType,Nt(this.style.markerFill)?Ft(this.style.markerFill):this.style.markerFill,this.style.markerFillOpacity,this.style.markerFillPatternFile,Nt(this.style.markerLineColor)?Ft(this.style.markerLineColor):this.style.markerLineColor,this.style.markerLineWidth,this.style.markerLineOpacity,this.style.markerLineDasharray?this.style.markerLineDasharray.join(","):"",this.style.markerLinePatternFile,this.style.markerWidth,this.style.markerHeight,this.style.markerHorizontalAlignment,this.style.markerVerticalAlignment].join("_")),this._stamp},e.prototype._getAnchor=function(t,e){var r=2*(this.symbol.shadowBlur||0)+this.padding,n=Ce(new fe(t,e),this.style.markerHorizontalAlignment,this.style.markerVerticalAlignment);return n.x!==-t/2&&(n.x-=j(n.x+t/2)*r),n.y!==-e/2&&(n.y-=j(n.y+e/2)*r),n},e.prototype._getCacheImageAnchor=function(t,e){var r=2*(this.symbol.shadowBlur||0)+this.padding,n=this.style.markerType;return"bar"===n||"pie"===n||"pin"===n?new ce(t/2,e-r):"rectangle"===n?new ce(r,r):new ce(t/2,e/2)},e.prototype._getGraidentExtent=function(t){var e=new Cr,r=this.getDxDy(),n=this.getFixedExtent();if(Array.isArray(t))for(var i=t.length-1;i>=0;i--)e._combine(t[i]);else e._combine(t);return e.xmin+=n.xmin-r.x,e.ymin+=n.ymin-r.y,e.xmax+=n.xmax-r.x,e.ymax+=n.ymax-r.y,e},e.prototype._drawVectorMarker=function(t,r,n){var i=this.style,o=this.strokeAndFill,a=i.markerType.toLowerCase(),s=e._getVectorPoints(a,i.markerWidth,i.markerHeight),h=o.lineOpacity,u=o.polygonOpacity;if(Nt(o.lineColor)||Nt(o.polygonFill)){var l=void 0;Nt(o.lineColor)&&(l=this._getGraidentExtent(r),o.lineGradientExtent=l.expand(o.lineWidth)),Nt(o.polygonFill)&&(l||(l=this._getGraidentExtent(r)),o.polygonGradientExtent=l),this.prepareCanvas(t,o,n)}var c=i.markerWidth,f=i.markerHeight,d=i.markerLineWidth/2;if("ellipse"===a)ar.ellipse(t,r,c/2,f/2,h,u);else if("cross"===a||"x"===a){for(var p=s.length-1;p>=0;p--)s[p]._add(r);ar.path(t,s.slice(0,2),h),ar.path(t,s.slice(2,4),h)}else if("diamond"===a||"bar"===a||"square"===a||"rectangle"===a||"triangle"===a){"bar"===a?r=r.add(0,-d):"rectangle"===a&&(r=r.add(d,d));for(var m=s.length-1;m>=0;m--)s[m]._add(r);ar.polygon(t,s,h,u)}else if("pin"===a){r=r.add(0,-d);for(var g=s.length-1;g>=0;g--)s[g]._add(r);var _=t.lineCap;t.lineCap="round",ar.bezierCurveAndFill(t,s,h,u),t.lineCap=_}else{if("pie"!==a)throw new Error("unsupported markerType: "+a);r=r.add(0,-d);var y=180*Math.atan(c/2/f)/Math.PI,v=t.lineCap;t.lineCap="round",ar.sector(t,r,f,[90-y,90+y],h,u),t.lineCap=v}},e.prototype.getPlacement=function(){return this.symbol.markerPlacement},e.prototype.getRotation=function(){var t=this.style.markerRotation;return v(t)?-t*Math.PI/180:null},e.prototype.getFixedExtent=function(){var t=this.getDxDy(),e=2*this.padding,r=this._calMarkerSize().map(function(t){return t-e}),n=this._getAnchor(r[0],r[1]),i=new Cr(t.add(0,0),t.add(r[0],r[1]));i._add(n);var o=this.getRotation();return o&&(i=this._rotateExtent(i,o)),i},e.prototype.translate=function(){var t=this.symbol,e={markerType:H(t.markerType,"ellipse"),markerFill:H(t.markerFill,"#00f"),markerFillOpacity:H(t.markerFillOpacity,1),markerFillPatternFile:H(t.markerFillPatternFile,null),markerLineColor:H(t.markerLineColor,"#000"),markerLineWidth:H(t.markerLineWidth,1),markerLineOpacity:H(t.markerLineOpacity,1),markerLineDasharray:H(t.markerLineDasharray,[]),markerLinePatternFile:H(t.markerLinePatternFile,null),markerDx:H(t.markerDx,0),markerDy:H(t.markerDy,0),markerWidth:H(t.markerWidth,10),markerHeight:H(t.markerHeight,10),markerRotation:H(t.markerRotation,0)},r=e.markerType,n=void 0,i=void 0;return"bar"===r||"pie"===r||"pin"===r?(n="middle",i="top"):"rectangle"===r?(n="right",i="bottom"):(n="middle",i="middle"),e.markerHorizontalAlignment=H(t.markerHorizontalAlignment,n),e.markerVerticalAlignment=H(t.markerVerticalAlignment,i),v(t.markerOpacity)&&(v(t.markerFillOpacity)&&(e.markerFillOpacity*=t.markerOpacity),v(t.markerLineOpacity)&&(e.markerLineOpacity*=t.markerOpacity)),e},e.translateLineAndFill=function(t){var e={lineColor:t.markerLineColor,linePatternFile:t.markerLinePatternFile,lineWidth:t.markerLineWidth,lineOpacity:t.markerLineOpacity,lineDasharray:t.markerLineDasharray,lineCap:"butt",lineJoin:"round",polygonFill:t.markerFill,polygonPatternFile:t.markerFillPatternFile,polygonOpacity:t.markerFillOpacity};return 0===e.lineWidth&&(e.lineOpacity=0),e},e._getVectorPoints=function(t,e,r){var n=r/2,i=e/2,o=void 0;if("triangle"===t)return[o=new ce(0,0-n),new ce(0-i,0+n),new ce(0+i,0+n)];if("cross"===t)return[o=new ce(0-i,0),new ce(0+i,0),new ce(0,0-n),new ce(0,0+n)];if("diamond"===t)return[o=new ce(0-i,0),new ce(0,0-n),new ce(0+i,0),new ce(0,0+n)];if("square"===t)return[o=new ce(0-i,0+n),new ce(0+i,0+n),new ce(0+i,0-n),new ce(0-i,0-n)];if("rectangle"===t)return[o=new ce(0,0),o.add(e,0),o.add(e,r),o.add(0,r)];if("x"===t)return[o=new ce(0-i,0+n),new ce(0+i,0-n),new ce(0+i,0+n),new ce(0-i,0-n)];if("bar"===t)return[o=new ce(0-i,0-r),new ce(0+i,0-r),new ce(0+i,0),new ce(0-i,0)];if("pin"===t){var a=r*Math.atan(i/n);return[o=new ce(0,0),new ce(0-a,0-r),new ce(0+a,0-r),new ce(0,0)]}return[]},e}(_n),vn=function(t){function e(){return d(this,e),m(this,t.apply(this,arguments))}return p(e,t),e.prototype.getPlacement=function(){return"point"},e.prototype.getDxDy=function(){return new ce(0,0)},e.prototype.symbolize=function(t){var e=this.geometry,r=e.getLayer();if(e.options.debug||!r||r.options.debug){var n=this.getMap();if(n&&!n.isZooming()){var i=r.options.debugOutline;t.strokeStyle=i,t.fillStyle=i;var o=this.getPainter().getContainerExtent().toArray();ar.polygon(t,[o],1,0);for(var a=this._getRenderContainerPoints(),s=this.geometry.getId(),h=yn._getVectorPoints("cross",10,10),u=0;u<a.length;u++){var l=a[u];y(s)||ar.fillText(t,s,l.add(8,-4),i);for(var c=[],f=0;f<h.length;f++)c.push(h[f].add(l));ar.path(t,c.slice(0,2),1),ar.path(t,c.slice(2,4),1)}}}},e}(_n),xn=function(t){function e(r,n,i){d(this,e);var o=m(this,t.call(this,r,n,i));return o.style=o._defineStyle(o.translate()),o}return p(e,t),e.test=function(t){return!!t&&!y(t.markerFile)},e.prototype.symbolize=function(t,e){var r=this.style;if(this.painter.isHitTesting()||0!==r.markerWidth&&0!==r.markerHeight&&0!==r.markerOpacity){var n=this._getRenderContainerPoints();if(X(n)){var i=this._getImage(e);if(i){this._prepareContext(t);var o=r.markerWidth,a=r.markerHeight;if(!v(o)||!v(a)){o=i.width,a=i.height,r.markerWidth=o,r.markerHeight=a;var s=[r.markerFile,r.markerWidth,r.markerHeight];e.isResourceLoaded(s)||e.addResource(s,i);var h=this.getPainter();h.isSpriting()||h.removeCache()}var u=void 0;"path"!==this.symbol.markerType&&v(r.markerOpacity)&&r.markerOpacity<1&&(u=t.globalAlpha,t.globalAlpha*=r.markerOpacity);for(var l=Ce(new fe(o,a),r.markerHorizontalAlignment,r.markerVerticalAlignment),c=0,f=n.length;c<f;c++){var d=n[c],p=this._rotate(t,d,this._getRotationAt(c));p&&(d=p),ar.image(t,i,d.x+l.x,d.y+l.y,o,a),p&&t.restore()}void 0!==u&&(t.globalAlpha=u)}else"undefined"!=typeof console&&console.warn("no img found for "+(this.style.markerFile||this._url[0]))}}},e.prototype._getImage=function(t){return t?t.getImage([this.style.markerFile,this.style.markerWidth,this.style.markerHeight]):null},e.prototype.getPlacement=function(){return this.symbol.markerPlacement},e.prototype.getRotation=function(){var t=this.style.markerRotation;return v(t)?-t*Math.PI/180:null},e.prototype.getDxDy=function(){var t=this.style,e=t.markerDx,r=t.markerDy;return new ce(e,r)},e.prototype.getFixedExtent=function(t){var e=this.style,r=e.markerFile,n=t?t.getImage(r):null,i=e.markerWidth||(n?n.width:0),o=e.markerHeight||(n?n.height:0),a=this.getDxDy(),s=Ce(new fe(i,o),e.markerHorizontalAlignment,e.markerVerticalAlignment),h=new Cr(a.add(0,0),a.add(i,o));h._add(s);var u=this.getRotation();return u&&(h=this._rotateExtent(h,u)),h},e.prototype.translate=function(){var t=this.symbol;return{markerFile:t.markerFile,markerOpacity:H(t.markerOpacity,1),markerWidth:H(t.markerWidth,null),markerHeight:H(t.markerHeight,null),markerRotation:H(t.markerRotation,0),markerDx:H(t.markerDx,0),markerDy:H(t.markerDy,0),markerHorizontalAlignment:H(t.markerHorizontalAlignment,"middle"),markerVerticalAlignment:H(t.markerVerticalAlignment,"top")}},e}(_n),bn=function(t){function e(r,n,i){d(this,e);var o=m(this,t.call(this));return o.symbol=r,o.geometry=n,o.painter=i,"Point"===n.type?m(o):(o.style=o._defineStyle(o.translate()),o)}return p(e,t),e.test=function(t,e){if(!t)return!1;if(e&&"Point"===e.type)return!1;for(var r in t){var n=r.slice(0,4);if("line"===n||"poly"===n)return!0}return!1},e.prototype.symbolize=function(t,e){var r=this.style;if(0!==r.polygonOpacity||0!==r.lineOpacity||this.painter.isHitTesting()){var n=this._getPaintParams();if(n){this._prepareContext(t);var i=Nt(r.lineColor),o="Polygon"===this.geometry.getJSONType()||"LineString"===this.geometry.type;!i||!r.lineColor.places&&o||(r.lineGradientExtent=this.getPainter().getContainerExtent()._expand(r.lineWidth)),Nt(r.polygonFill)&&(r.polygonGradientExtent=this.getPainter().getContainerExtent());var a=n[0];if("Polygon"===this.geometry.getJSONType()&&a.length>0&&Array.isArray(a[0][0])||"LineString"===this.geometry.type&&a.length>0&&Array.isArray(a[0]))for(var s=0;s<a.length;s++){this.prepareCanvas(t,r,e),i&&o&&!r.lineColor.places&&this._createGradient(t,a[s],r.lineColor);var h=[t,a[s]];n.length>1&&h.push.apply(h,n.slice(1)),h.push(r.lineOpacity,r.polygonOpacity,r.lineDasharray),this.geometry._paintOn.apply(this.geometry,h)}else{this.prepareCanvas(t,r,e),i&&o&&!r.lineColor.places&&this._createGradient(t,a,r.lineColor);var u=[t];u.push.apply(u,n),u.push(r.lineOpacity,r.polygonOpacity,r.lineDasharray),this.geometry._paintOn.apply(this.geometry,u)}t.setLineDash&&Array.isArray(r.lineDasharray)&&t.setLineDash([])}}},e.prototype.get2DExtent=function(){var t=this.getMap(),e=this.geometry._getPrjExtent();if(!e)return null;this._extMin&&this._extMax||(this._extMin=new br(0,0),this._extMax=new br(0,0)),this._extMin.x=e.xmin,this._extMin.y=e.ymin,this._extMax.x=e.xmax,this._extMax.y=e.ymax;var r=t._prjToPoint(this._extMin),n=t._prjToPoint(this._extMax);return this._pxExtent?(this._pxExtent.xmin=Math.min(r.x,n.x),this._pxExtent.xmax=Math.max(r.x,n.x),this._pxExtent.ymin=Math.min(r.y,n.y),this._pxExtent.ymax=Math.max(r.y,n.y)):this._pxExtent=new Cr(r,n),this._pxExtent},e.prototype.getFixedExtent=function(){var t=this.style.lineWidth/2;return new Cr(-t,-t,t,t)},e.prototype._getPaintParams=function(){return this.getPainter().getPaintParams(this.style.lineDx,this.style.lineDy)},e.prototype.translate=function(){var t=this.symbol,e={lineColor:H(t.lineColor,"#000"),lineWidth:H(t.lineWidth,2),lineOpacity:H(t.lineOpacity,1),lineDasharray:H(t.lineDasharray,[]),lineCap:H(t.lineCap,"butt"),lineJoin:H(t.lineJoin,"miter"),linePatternFile:H(t.linePatternFile,null),lineDx:H(t.lineDx,0),lineDy:H(t.lineDy,0),polygonFill:H(t.polygonFill,null),polygonOpacity:H(t.polygonOpacity,1),polygonPatternFile:H(t.polygonPatternFile,null),polygonPatternDx:H(t.polygonPatternDx,0),polygonPatternDy:H(t.polygonPatternDy,0),linePatternDx:H(t.linePatternDx,0),linePatternDy:H(t.linePatternDy,0)};return 0===e.lineWidth&&(e.lineOpacity=0),"LineString"!==this.geometry.type||e.polygonFill||(e.polygonFill=e.lineColor),e},e.prototype._createGradient=function(t,e,r){if(Array.isArray(e)){var n=e.length,i=t.createLinearGradient(e[0].x,e[0].y,e[n-1].x,e[n-1].y);r.colorStops.forEach(function(t){i.addColorStop.apply(i,t)}),t.strokeStyle=i}},e}(gn),wn="___text_symbol_cache",Tn=function(t){function e(r,n,i){d(this,e);var o=m(this,t.call(this,r,n,i));if(o._dynamic=St(r),o.style=o._defineStyle(o.translate()),0===o.style.textWrapWidth)return m(o);o.strokeAndFill=o._defineStyle(o.translateLineAndFill(o.style));var a=Ee(o.style.textName,o.geometry.getProperties());return o._dynamic||(o._cacheKey=function(t,e){var r=[t];for(var n in e)e.hasOwnProperty(n)&&n.length>4&&"text"===n.substring(0,4)&&r.push(n+"="+e[n]);return r.join("-")}(a,o.style)),o._descText(a),o}return p(e,t),e.test=function(t){return!!t&&!y(t.textName)},e.prototype.symbolize=function(t,e){if(this.painter.isHitTesting()||0!==this.style.textSize&&(this.style.textOpacity||this.style.textHaloRadius&&this.style.textHaloOpacity)&&0!==this.style.textWrapWidth){var r=this._getRenderContainerPoints();if(X(r)){var n=this.style,i=this.strokeAndFill,o=Ee(this.style.textName,this.geometry.getProperties());this._descText(o),this._prepareContext(t),this.prepareCanvas(t,i,e),ar.prepareCanvasFont(t,n);for(var a=0,s=r.length;a<s;a++){var h=r[a],u=this._rotate(t,h,this._getRotationAt(a));u&&(h=u),ar.text(t,o,h,n,this.textDesc),u&&t.restore()}}}},e.prototype.getPlacement=function(){return this.symbol.textPlacement},e.prototype.getRotation=function(){var t=this.style.textRotation;return v(t)?-t*Math.PI/180:null},e.prototype.getDxDy=function(){var t=this.style;return new ce(t.textDx,t.textDy)},e.prototype.getFixedExtent=function(){var t=this.getDxDy(),e=this.style,r=this.textDesc.size,n=Ce(r,e.textHorizontalAlignment,e.textVerticalAlignment),i=n.x,o=n.y;if(e.textHaloRadius){var a=e.textHaloRadius;r=r.add(2*a,2*a)}var s=new Cr(t.add(i,o),t.add(i+r.width,o+r.height)),h=this.getRotation();return h&&(s=this._rotateExtent(s,h)),s},e.prototype.translate=function(){var t=this.symbol,e={textName:t.textName,textFaceName:H(t.textFaceName,"monospace"),textWeight:H(t.textWeight,"normal"),textStyle:H(t.textStyle,"normal"),textSize:H(t.textSize,10),textFont:H(t.textFont,null),textFill:H(t.textFill,"#000"),textOpacity:H(t.textOpacity,1),textHaloFill:H(t.textHaloFill,"#ffffff"),textHaloRadius:H(t.textHaloRadius,0),textHaloOpacity:H(t.textHaloOpacity,1),textWrapWidth:H(t.textWrapWidth,null),textWrapCharacter:H(t.textWrapCharacter,"\n"),textLineSpacing:H(t.textLineSpacing,0),textDx:H(t.textDx,0),textDy:H(t.textDy,0),textHorizontalAlignment:H(t.textHorizontalAlignment,"middle"),textVerticalAlignment:H(t.textVerticalAlignment,"middle"),textAlign:H(t.textAlign,"center"),textRotation:H(t.textRotation,0),textMaxWidth:H(t.textMaxWidth,0),textMaxHeight:H(t.textMaxHeight,0)};return e.textMaxWidth>0&&(!e.textWrapWidth||e.textWrapWidth>e.textMaxWidth)&&(e.textWrapWidth||(e.textMaxHeight=1),e.textWrapWidth=e.textMaxWidth),e},e.prototype.translateLineAndFill=function(t){return{lineColor:t.textHaloRadius?t.textHaloFill:t.textFill,lineWidth:t.textHaloRadius,lineOpacity:t.textOpacity,lineDasharray:null,lineCap:"butt",lineJoin:"round",polygonFill:t.textFill,polygonOpacity:t.textOpacity}},e.prototype._descText=function(t){this._dynamic?this.textDesc=this._measureText(t):(this.textDesc=this._loadFromCache(),this.textDesc||(this.textDesc=this._measureText(t),this._storeToCache(this.textDesc)))},e.prototype._measureText=function(t){var e=this.style.textMaxHeight,r=Ae(t,this.style);return e&&e<r.size.height&&(r.size.height=e),r},e.prototype._storeToCache=function(t){P||(this.geometry[wn]||(this.geometry[wn]={}),this.geometry[wn][this._cacheKey]={desc:t,active:!0})},e.prototype._loadFromCache=function(){if(!this.geometry[wn])return null;var t=this.geometry[wn][this._cacheKey];return t?(t.active=!0,t.desc):null},e}(_n);Tn.CACHE_KEY=wn;var En=function(t){function e(r,n,i){d(this,e);var o=m(this,t.call(this,r,n,i));return o.style=o._defineStyle(o.translate()),y(o.style.markerWidth)&&(o.style.markerWidth=80),y(o.style.markerHeight)&&(o.style.markerHeight=80),ue.gecko?o._url=[Ot(r,o.style.markerWidth,o.style.markerHeight),o.style.markerWidth,o.style.markerHeight]:o._url=[Ot(r),r.markerWidth,r.markerHeight],o}return p(e,t),e.test=function(t){return!!t&&!(!y(t.markerFile)||"path"!==t.markerType)},e.prototype._prepareContext=function(){},e.prototype._getImage=function(t){if(t&&t.isResourceLoaded(this._url))return t.getImage(this._url);var e=new Image;return e.src=this._url[0],t&&t.addResource(this._url,e),e},e}(xn),Cn={lineWidth:1,polygonFill:"#fff",polygonOpacity:.5},Sn=function(t){function e(r,n,i){d(this,e);var o=m(this,t.call(this,r,n,i));return o.style=n.getLayer().options.drawAltitude,o.style&&b(o.style)||(o.style={lineWidth:2}),o.style.lineWidth||(o.style.lineWidth=0),o.dxdy=o._defineStyle({dx:r.textDx||r.markerDx,dy:r.textDy||r.markerDy}),o}return p(e,t),e.test=function(t,e){if(!e.getLayer())return!1;var r=e.getJSONType();return"Marker"===r||"LineString"===r},e.prototype.symbolize=function(t){var e=this.geometry.getLayer();if(e.options.drawAltitude){var r=this.geometry.getProperties();if(r&&r[e.options.altitudeProperty]){var n=this._getStyle();if(this._prepareContext(t),"LineString"===this.geometry.type){var i=this._getPaintParams(n.lineDx,n.lineDy);if(!i)return;var o=this.getPainter().getPaintParams(n.lineDx,n.lineDy,!0)[0];this._drawLineAltitude(t,i[0],o)}else{var a=this._getRenderContainerPoints(),s=this._getRenderContainerPoints(!0);if(!a||0===a.length)return;this._drawMarkerAltitude(t,a[0],s[0])}}}},e.prototype.getDxDy=function(){var t=this.dxdy;return new ce(t.dx||0,t.dy||0)},e.prototype.get2DExtent=function(){return"LineString"===this.geometry.type?bn.prototype.get2DExtent.apply(this):t.prototype.get2DExtent.call(this)},e.prototype.getPlacement=function(){return"point"},e.prototype._getPaintParams=function(t,e){return this.getPainter().getPaintParams(t||0,e||0)},e.prototype._drawMarkerAltitude=function(t,e,r){var n=this._getStyle();this.prepareCanvas(t,n),ar.path(t,[e,r],n.lineOpacity,null,n.lineDasharray)},e.prototype._drawLineAltitude=function(t,e,r){var n=this._getStyle();if(e.length>0&&Array.isArray(e[0]))for(var i=0;i<e.length;i++)this._drawLine(t,e[i],r[i]);else this._drawLine(t,e,r);t.setLineDash&&Array.isArray(n.lineDasharray)&&t.setLineDash([])},e.prototype._drawLine=function(t,e,r){var n=this._getStyle();this.prepareCanvas(t,n);for(var i=0,o=e.length-1;i<o;i++)ar.polygon(t,[e[i],e[i+1],r[i+1],r[i]],n.lineOpacity,n.polygonOpacity,n.lineDasharray)},e.prototype._getStyle=function(){var t=this.geometry.getLayer().options.drawAltitude;return b(t)||(t=Cn),t.lineWidth||(t.lineWidth=0,t.lineOpacity=0),t},e}(_n),An=Object.freeze({Symbolizer:mn,CanvasSymbolizer:gn,DebugSymbolizer:vn,ImageMarkerSymbolizer:xn,PointSymbolizer:_n,StrokeAndFillSymbolizer:bn,TextMarkerSymbolizer:Tn,VectorMarkerSymbolizer:yn,VectorPathMarkerSymbolizer:En,DrawAltitudeSymbolizer:Sn}),Mn=[Sn,bn,xn,En,yn,Tn],Pn=void 0,Rn=function(t){function e(r){d(this,e);var n=m(this,t.call(this));return n.geometry=r,n.symbolizers=n._createSymbolizers(),n._altAtGLZoom=n._getGeometryAltitude(),n}return p(e,t),e.prototype.getMap=function(){return this.geometry.getMap()},e.prototype.getLayer=function(){return this.geometry.getLayer()},e.prototype._createSymbolizers=function(){var t=this.getSymbol(),e=[],r=Mn,n=t;Array.isArray(t)||(n=[t]);for(var i=n.length-1;i>=0;i--)for(var o=n[i],a=r.length-1;a>=0;a--)if(r[a].test(o,this.geometry)){var s=new r[a](o,this.geometry,this);e.push(s),s instanceof _n&&(this._hasPoint=!0)}if(!e.length&&console){var h=this.geometry.getId();console.warn("invalid symbol for geometry("+(this.geometry?this.geometry.getType()+(h?":"+h:""):"")+") to draw : "+JSON.stringify(t))}return this._debugSymbolizer=new vn(t,this.geometry,this),e},e.prototype.hasPoint=function(){return!!this._hasPoint},e.prototype.getRenderPoints=function(t){return this._renderPoints||(this._renderPoints={}),t||(t="center"),this._renderPoints[t]||(this._renderPoints[t]=this.geometry._getRenderPoints(t)),this._renderPoints[t]},e.prototype.getPaintParams=function(t,e,r){var n=this.getMap(),i=this.geometry,o=n.getResolution(),a=0!==n.getPitch(),s=0!==n.getBearing(),h=this._cachedParams,u=i._paintAsPath&&i._paintAsPath();if(u&&this._unsimpledParams&&o<=this._unsimpledParams._res)h=this._unsimpledParams;else if(!h||h._res!==n.getResolution()||this._pitched!==a&&i._redrawWhenPitch()||this._rotated!==s&&i._redrawWhenRotate()){if(!(h=i._getPaintParams()))return null;h._res=o,!i._simplified&&u&&(this._unsimpledParams||(this._unsimpledParams=h),o>this._unsimpledParams._res&&(this._unsimpledParams._res=o)),this._cachedParams=h}if(!h)return null;this._pitched=a,this._rotated=s;var l=n.getGLScale(),c=[],f=h[0],d=n.getContainerExtent(),p=this._pointContainerPoints(f,t,e,r,!d.contains(this._hitPoint));if(!p)return null;c.push(p);for(var m=1,g=h.length;m<g;m++)v(h[m])||h[m]instanceof fe?v(h[m])?c.push(h[m]/l):c.push(h[m].multi(1/l)):c.push(h[m]);return c},e.prototype._pointContainerPoints=function(t,e,r,n,i,o){if(!this.getContainerExtent())return null;var a=this.getMap(),s=a.getGLZoom(),h=this.containerOffset,u=void 0;function l(t,n){var i=a._pointToContainerPoint(t,s,n)._sub(h);return(e||r)&&i._add(e||0,r||0),i}var c=this.getAltitude();if(Array.isArray(t)){var f=this.geometry,d=void 0,p=(d=!i&&f.options.enableClip?this._clip(t,c):{points:t,altitude:c}).points;c=d.altitude,n&&(c=0);var m=c;u=[];for(var g=0,_=p.length;g<_;g++){var y=p[g];if(Array.isArray(y)){for(var v=[],x=0,b=y.length;x<b;x++){var w=y[x];Array.isArray(c)&&(m=c[g]?c[g][x]:0),v.push(l(w,m))}u.push(v)}else Array.isArray(c)&&(m="vertex-last"===o?c[c.length-1-g]:"line"===o?(c[g]+c[g+1])/2:c[g]),u.push(l(y,m))}}else t instanceof ce&&(n&&(c=0),u=a._pointToContainerPoint(t,s,c)._sub(h),(e||r)&&u._add(e,r));return u},e.prototype._clip=function(t,e){var r=this.getMap(),n=this.geometry,i=r.getGLZoom(),o=this.getSymbol().lineWidth;v(o)||(o=4);var a=r.getContainerExtent().expand(o).convertTo(function(t){return r._containerPointToPoint(t,i)});if(r.getPitch()>0&&e){var s=r.cameraLookAt,h=r.cameraPosition;a=a.combine(new ce(h)._add(j(s[0]-h[0]),j(s[1]-h[1])))}var u=t;if(this.get2DExtent().within(a))return{points:u,altitude:e};var l=n.options.smoothness;if(n.getShell&&this.geometry.getHoles&&!l)if(Array.isArray(t[0])){u=[];for(var c=0;c<t.length;c++){var f=cn(t[c],a);f.length&&u.push(f)}}else u=cn(t,a);else if("LineString"===n.getJSONType()){if(Array.isArray(t[0])){u=[];for(var d=0;d<t.length;d++)B(u,hn(t[d],a,!1,!!l))}else u=hn(t,a,!1,!!l);return this._interpolateSegAlt(u,t,e)}return{points:u,altitude:e}},e.prototype._interpolateSegAlt=function(t,e,r){if(!Array.isArray(r)){var n=function(t){return t.point};return{points:t.map(function(t){return Array.isArray(t)?t.map(n):t.point}),altitude:r}}var i=function t(e,r,n){if(!Array.isArray(n))return e;var i=[];for(var o=0,a=e.length;o<a;o++)if(Array.isArray(e[o]))i.push(t(e[o],r,n));else{var s=e[o];if(s.point.equals(r[s.index]))s.altitude=n[s.index],i.push(s);else{var h=void 0,u=void 0;0===s.index?(h=s.index,u=s.index+1):(h=s.index-1,u=s.index);var l=s.point.distanceTo(r[u]),c=l/(l+r[h].distanceTo(s.point)),f=V(n[h],n[u],1-c);s.altitude=f,i.push(s)}}return i}(t,e,r);return r=[],{points:i.map(function(t){if(Array.isArray(t)){var e=[],n=t.map(function(t){return e.push(t.altitude),t.point});return r.push(e),n}return r.push(t.altitude),t.point}),altitude:r}},e.prototype.getSymbol=function(){return this.geometry._getInternalSymbol()},e.prototype.paint=function(t,e,r){if(this.symbolizers){var n=this.getLayer()._getRenderer();if(n&&n.context&&(!t||t.intersects(this.get2DExtent(n.resources)))){var i=this.getMap(),o=this.getMinAltitude(),a=i.getFrustumAltitude();if(!(o&&a&&a<o)){this.containerOffset=r||i._pointToContainerPoint(n.southWest)._add(0,-i.height),this._beforePaint();for(var s=e||n.context,h=[s,n.resources],u=this.symbolizers.length-1;u>=0;u--)this._prepareShadow(s,this.symbolizers[u].symbol),this.symbolizers[u].symbolize.apply(this.symbolizers[u],h);this._afterPaint(),this._painted=!0,this._debugSymbolizer.symbolize.apply(this._debugSymbolizer,h)}}}},e.prototype.getSprite=function(t,e){if("Point"!==this.geometry.type)return null;if(this._spriting=!0,!this._sprite&&this.symbolizers.length>0){var r=new Cr;this.symbolizers.forEach(function(e){var n=e.getFixedExtent(t);r._combine(n)});var n=r.getMin().multi(-1),i=e||(this.getMap()?this.getMap().CanvasClass:null),o=ar.createCanvas(r.getWidth(),r.getHeight(),i),a=void 0;this._renderPoints&&(a=this._renderPoints);for(var s=o.getContext("2d"),h=[s,t],u=this.symbolizers.length-1;u>=0;u--){var l=this.symbolizers[u].getDxDy();this._renderPoints={center:[[n.add(l)]]},this._prepareShadow(s,this.symbolizers[u].symbol),this.symbolizers[u].symbolize.apply(this.symbolizers[u],h)}a&&(this._renderPoints=a),this._sprite={canvas:o,offset:r.getCenter()}}return this._spriting=!1,this._sprite},e.prototype.isSpriting=function(){return!!this._spriting},e.prototype.hitTest=function(t,e){(!e||e<.5)&&(e=.5),Pn||(Pn=ar.createCanvas(1,1)),ar.setHitTesting(!0),Pn.width=Pn.height=2*e;var r=Pn.getContext("2d");this._hitPoint=t.sub(e,e);try{this.paint(null,r,this._hitPoint)}catch(t){throw t}finally{ar.setHitTesting(!1)}delete this._hitPoint;for(var n=r.getImageData(0,0,Pn.width,Pn.height).data,i=3,o=n.length;i<o;i+=4)if(n[i]>0)return!0;return!1},e.prototype.isHitTesting=function(){return!!this._hitPoint},e.prototype._prepareShadow=function(t,e){e.shadowBlur?(t.shadowBlur=e.shadowBlur,t.shadowColor=e.shadowColor||"#000",t.shadowOffsetX=e.shadowOffsetX||0,t.shadowOffsetY=e.shadowOffsetY||0):t.shadowBlur&&(t.shadowBlur=null,t.shadowColor=null,t.shadowOffsetX=null,t.shadowOffsetY=null)},e.prototype._eachSymbolizer=function(t,e){if(this.symbolizers){e||(e=this);for(var r=this.symbolizers.length-1;r>=0;r--)t.apply(e,[this.symbolizers[r]])}},e.prototype.get2DExtent=function(t){this._verifyProjection();var e=this.getMap();t=t||this.getLayer()._getRenderer().resources;var r=e.getZoom();if((!this._extent2D||this._extent2D._zoom!==r)&&(delete this._extent2D,delete this._fixedExtent,this.symbolizers)){for(var n=this._extent2D=new Cr,i=this._fixedExtent=new Cr,o=this.symbolizers.length-1;o>=0;o--){var a=this.symbolizers[o];n._combine(a.get2DExtent()),a.getFixedExtent&&i._combine(a.getFixedExtent(t))}n._zoom=r}return this._extent2D.add(this._fixedExtent)},e.prototype.getContainerExtent=function(){this._verifyProjection();var t=this.getMap(),e=t.getZoom(),r=t.getGLScale();this._extent2D&&this._extent2D._zoom===e||this.get2DExtent();var n=this.getMinAltitude(),i=t.getFrustumAltitude();if(n&&i&&i<n)return null;var o=this._extent2D.convertTo(function(i){return t._pointToContainerPoint(i,e,n/r)}),a=this.getMaxAltitude();if(a!==n){var s=this._extent2D.convertTo(function(n){return t._pointToContainerPoint(n,e,a/r)});o._combine(s)}return o&&o._add(this._fixedExtent),this.geometry.options.smoothness&&o._expand(.15*o.getWidth()),o},e.prototype.getFixedExtent=function(){var t=this.getMap().getZoom();return this._extent2D&&this._extent2D._zoom===t||this.get2DExtent(),this._fixedExtent},e.prototype.setZIndex=function(t){this._eachSymbolizer(function(e){e.setZIndex(t)})},e.prototype.show=function(){this._painted?(this.removeCache(),this._eachSymbolizer(function(t){t.show()})):this.getLayer().isCanvasRender()||this.paint()},e.prototype.hide=function(){this._eachSymbolizer(function(t){t.hide()})},e.prototype.repaint=function(){this._altAtGLZoom=this._getGeometryAltitude(),this.removeCache();var t=this.getLayer();if(t){var e=t.getRenderer();e&&e.setToRedraw()&&e.setToRedraw()}},e.prototype.refreshSymbol=function(){this.removeCache(),this._removeSymbolizers(),this.symbolizers=this._createSymbolizers()},e.prototype.remove=function(){this.removeCache(),this._removeSymbolizers()},e.prototype._removeSymbolizers=function(){this._eachSymbolizer(function(t){delete t.painter,t.remove()}),delete this.symbolizers},e.prototype.removeCache=function(){delete this._renderPoints,delete this._paintParams,delete this._sprite,delete this._extent2D,delete this._fixedExtent,delete this._cachedParams,delete this._unsimpledParams,this.geometry&&delete this.geometry[Tn.CACHE_KEY]},e.prototype.getAltitude=function(){return this._getAltitudeProperty()!==this._propAlt&&(this._altAtGLZoom=this._getGeometryAltitude()),this._altAtGLZoom?this._altAtGLZoom:0},e.prototype.getMinAltitude=function(){return this.minAltitude?this.minAltitude:0},e.prototype.getMaxAltitude=function(){return this.maxAltitude?this.maxAltitude:0},e.prototype._getGeometryAltitude=function(){var t=this;if(!this.getMap())return 0;var e=this._getAltitudeProperty();if(this._propAlt=e,!e)return this.minAltitude=this.maxAltitude=0,0;var r=this.geometry.getCenter();return Array.isArray(e)?(this.minAltitude=Number.MAX_VALUE,this.maxAltitude=Number.MIN_VALUE,e.map(function(e){var n=t._meterToPoint(r,e);return n<t.minAltitude&&(t.minAltitude=n),n>t.maxAltitude&&(t.maxAltitude=n),n})):(this.minAltitude=this.maxAltitude=this._meterToPoint(r,e),this.minAltitude)},e.prototype._meterToPoint=function(t,e){var r=this.getMap(),n=r.getGLZoom(),i=r.locate(t,e,0),o=r.coordToPoint(t,n),a=r.coordToPoint(i,n);return Math.abs(a.x-o.x)*j(e)},e.prototype._getAltitudeProperty=function(){var t=this.geometry,e=t.getLayer().options,r=t.getProperties();return e.enableAltitude&&r?r[e.altitudeProperty]:0},e.prototype._verifyProjection=function(){var t=this.geometry._getProjection();this._projCode&&this._projCode!==t.code&&this.removeCache(),this._projCode=t.code},e.prototype._beforePaint=function(){var t=this.geometry[Tn.CACHE_KEY];if(t)for(var e in t)C(t,e)&&(t[e].active=!1)},e.prototype._afterPaint=function(){var t=this.geometry[Tn.CACHE_KEY];if(t)for(var e in t)C(t,e)&&(t[e].active||delete t[e])},e}(pr);var Ln=function(t){function e(r){d(this,e);var n=m(this,t.call(this));return n.geometry=r,n}return p(e,t),e.prototype._eachPainter=function(t){for(var e=this.geometry.getGeometries(),r=void 0,n=0,i=e.length;n<i&&(!(r=e[n]._getPainter())||!r||!1!==t.call(this,r));n++);},e.prototype.paint=function(t){this.geometry&&this._eachPainter(function(e){e.paint(t)})},e.prototype.get2DExtent=function(t){var e=new Cr;return this._eachPainter(function(r){e=e.combine(r.get2DExtent(t))}),e},e.prototype.getContainerExtent=function(){var t=new Cr;return this._eachPainter(function(e){t=t.combine(e.getContainerExtent())}),t},e.prototype.remove=function(){var t=arguments;this._eachPainter(function(e){e.remove.apply(e,t)})},e.prototype.setZIndex=function(){var t=arguments;this._eachPainter(function(e){e.setZIndex.apply(e,t)})},e.prototype.show=function(){var t=arguments;this._eachPainter(function(e){e.show.apply(e,t)})},e.prototype.hide=function(){var t=arguments;this._eachPainter(function(e){e.hide.apply(e,t)})},e.prototype.repaint=function(){var t=arguments;this._eachPainter(function(e){e.repaint.apply(e,t)})},e.prototype.refreshSymbol=function(){var t=arguments;this._eachPainter(function(e){e.refreshSymbol.apply(e,t)})},e.prototype.hasPoint=function(){var t=!1;return this._eachPainter(function(e){return!e.hasPoint()||(t=!0,!1)}),t},e.prototype.getMinAltitude=function(){var t=!0,e=0;return this._eachPainter(function(r){var n=r.getMinAltitude();(t||n<e)&&(t=!1,e=n)}),e},e.prototype.getMaxAltitude=function(){var t=0;return this._eachPainter(function(e){var r=e.getMaxAltitude();r>t&&(t=r)}),t},e}(pr),On=function(t){function e(r){d(this,e);var n=_({},r),i=n.symbol,o=n.properties,a=n.id;delete n.symbol,delete n.id,delete n.properties;var s=m(this,t.call(this,n));return i&&s.setSymbol(i),o&&s.setProperties(o),y(a)||s.setId(a),s}return p(e,t),e.prototype.getFirstCoordinate=function(){if("GeometryCollection"===this.type){var t=this.getGeometries();return t.length?t[0].getFirstCoordinate():null}var e=this.getCoordinates();if(!Array.isArray(e))return e;do{e=e[0]}while(Array.isArray(e)&&e.length>0);return e},e.prototype.getLastCoordinate=function(){if("GeometryCollection"===this.type){var t=this.getGeometries();return t.length?t[t.length-1].getLastCoordinate():null}var e=this.getCoordinates();if(!Array.isArray(e))return e;do{e=e[e.length-1]}while(Array.isArray(e)&&e.length>0);return e},e.prototype.addTo=function(t,e){return t.addGeometry(this,e),this},e.prototype.getLayer=function(){return this._layer?this._layer:null},e.prototype.getMap=function(){return this._layer?this._layer.getMap():null},e.prototype.getId=function(){return this._id},e.prototype.setId=function(t){var e=this.getId();return this._id=t,this._fireEvent("idchange",{old:e,new:t}),this},e.prototype.getProperties=function(){return this.properties?this.properties:this._getParent()?this._getParent().getProperties():null},e.prototype.setProperties=function(t){var e=this.properties;return this.properties=b(t)?_({},t):t,this._repaint(),this._fireEvent("propertieschange",{old:e,new:t}),this},e.prototype.getType=function(){return this.type},e.prototype.getSymbol=function(){var t=this._symbol;return t?Array.isArray(t)?zt(t):_({},t):null},e.prototype.setSymbol=function(t){return this._symbol=this._prepareSymbol(t),this.onSymbolChanged(),this},e.prototype.updateSymbol=function(t){if(!t)return this;var e=this._getSymbol();return e=zt(e||this._getInternalSymbol(),t),this.setSymbol(e)},e.prototype.getCenter=function(){return this._computeCenter(this._getMeasurer())},e.prototype.getExtent=function(){var t=this._getPrjExtent();if(t){var e=this._getProjection(),r=e.unproject(new br(t.xmin,t.ymin)),n=e.unproject(new br(t.xmax,t.ymax));return new Er(r,n,this._getProjection())}return this._computeExtent(this._getMeasurer())},e.prototype.getContainerExtent=function(){var t=this._getPainter();return t?t.getContainerExtent():null},e.prototype.getSize=function(){var t=this.getContainerExtent();return t?t.getSize():null},e.prototype.containsPoint=function(t,e){if(!this.getMap())throw new Error('The geometry is required to be added on a map to perform "containsPoint".');return t instanceof br&&(t=this.getMap().coordToContainerPoint(t)),this._containsPoint(t,e)},e.prototype._containsPoint=function(t,e){var r=this._getPainter();return!!r&&(y(e)&&this._hitTestTolerance&&(e=this._hitTestTolerance()),r.hitTest(t,e))},e.prototype.show=function(){if(this.options.visible=!0,this.getMap()){var t=this._getPainter();t&&t.show(),this._fireEvent("show")}return this},e.prototype.hide=function(){if(this.options.visible=!1,this.getMap()){this.onHide();var t=this._getPainter();t&&t.hide(),this._fireEvent("hide")}return this},e.prototype.isVisible=function(){if(!this.options.visible)return!1;var t=this._getInternalSymbol();if(!t)return!0;if(Array.isArray(t)){if(!t.length)return!0;for(var e=0,r=t.length;e<r;e++)if(y(t[e].opacity)||t[e].opacity>0)return!0;return!1}return y(t.opacity)||v(t.opacity)&&t.opacity>0},e.prototype.getZIndex=function(){return this.options.zIndex||0},e.prototype.setZIndex=function(t){var e=this.options.zIndex;return this.options.zIndex=t,this._fireEvent("zindexchange",{old:e,new:t}),this},e.prototype.setZIndexSilently=function(t){return this.options.zIndex=t,this},e.prototype.bringToFront=function(){var t=this.getLayer();if(!t||!t.getGeoMaxZIndex)return this;var e=t.getGeoMaxZIndex();return this.setZIndex(e+1),this},e.prototype.bringToBack=function(){var t=this.getLayer();if(!t||!t.getGeoMinZIndex)return this;var e=t.getGeoMinZIndex();return this.setZIndex(e-1),this},e.prototype.translate=function(t,e){if(y(t))return this;var r=new br(t,e);if(0===r.x&&0===r.y)return this;var n=this.getCoordinates();if(n)if(Array.isArray(n)){var i=U(n,function(t){return t.add(r)});this.setCoordinates(i)}else this.setCoordinates(n.add(r));return this},e.prototype.flash=function(t,e,r,n){return at.call(this,t,e,r,n)},e.prototype.copy=function(){var t=this.toJSON(),r=e.fromJSON(t);return r.options.visible=!0,r},e.prototype.remove=function(){return this.getLayer()?(this._fireEvent("removestart"),this._unbind(),this._fireEvent("removeend"),this._fireEvent("remove"),this):this},e.prototype.toGeoJSONGeometry=function(){return this._exportGeoJSONGeometry()},e.prototype.toGeoJSON=function(t){t||(t={});var e={type:"Feature",geometry:null};if(y(t.geometry)||t.geometry){var r=this._exportGeoJSONGeometry();e.geometry=r}var n=this.getId();y(n)||(e.id=n);var i=void 0;return(y(t.properties)||t.properties)&&(i=this._exportProperties()),e.properties=i,e},e.prototype.toJSON=function(t){t||(t={});var e=this._toJSON(t);return _(e,this._exportGraphicOptions(t)),e},e.prototype.getLength=function(){return this._computeGeodesicLength(this._getMeasurer())},e.prototype.getArea=function(){return this._computeGeodesicArea(this._getMeasurer())},e.prototype.rotate=function(t,e){if("GeometryCollection"===this.type)return this.getGeometries().forEach(function(r){return r.rotate(t,e)}),this;e=e?new br(e):this.getCenter();var r=this._getMeasurer(),n=this.getCoordinates();if(!Array.isArray(n)){if(e.x!==n.x||e.y!==n.y){var i=r._rotate(n,e,t);this.setCoordinates(i)}return this}return U(n,function(n){return r._rotate(n,e,t)}),this.setCoordinates(n),this},e.prototype._getConnectPoints=function(){return[this.getCenter()]},e.prototype._initOptions=function(t){var e=_({},t),r=e.symbol,n=e.properties,i=e.id;delete e.symbol,delete e.id,delete e.properties,this.setOptions(e),r&&this.setSymbol(r),n&&this.setProperties(n),y(i)||this.setId(i)},e.prototype._bindLayer=function(t){if(this.getLayer())throw new Error("Geometry cannot be added to two or more layers at the same time.");this._layer=t,this._clearCache(),this._clearProjection()},e.prototype._prepareSymbol=function(t){if(Array.isArray(t)){for(var e=[],r=0;r<t.length;r++)e.push(Dt(this._checkAndCopySymbol(t[r])));return e}return t?Dt(t=this._checkAndCopySymbol(t)):null},e.prototype._checkAndCopySymbol=function(t){var e={};for(var r in t)l[r]&&w(t[r])?e[r]=+t[r]:e[r]=t[r];return e},e.prototype._getSymbol=function(){return this._symbol},e.prototype._setExternSymbol=function(t){return this._externSymbol=this._prepareSymbol(t),this.onSymbolChanged(),this},e.prototype._getInternalSymbol=function(){return this._symbol?this._symbol:this._externSymbol?this._externSymbol:this.options.symbol?this.options.symbol:null},e.prototype._getPrjExtent=function(){var t=this._getProjection();return this._verifyProjection(),!this._extent&&t&&(this._extent=this._computePrjExtent(t)),this._extent},e.prototype._unbind=function(){var t=this.getLayer();t&&(this._animPlayer&&this._animPlayer.finish(),this._clearHandlers(),this._unbindMenu(),this._unbindInfoWindow(),this.isEditing()&&this.endEdit(),this._removePainter(),this.onRemove&&this.onRemove(),t.onRemoveGeometry&&t.onRemoveGeometry(this),delete this._layer,delete this._internalId,delete this._extent)},e.prototype._getInternalId=function(){return this._internalId},e.prototype._setInternalId=function(t){this._internalId=t},e.prototype._getMeasurer=function(){return this._getProjection()?this._getProjection():rn.getProjectionInstance(this.options.defaultProjection)},e.prototype._getProjection=function(){var t=this.getMap();return t?t.getProjection():null},e.prototype._verifyProjection=function(){var t=this._getProjection();!this._projCode||t&&this._projCode===t.code||this._clearProjection(),this._projCode=t?t.code:null},e.prototype._getExternalResources=function(){return kt(this._getInternalSymbol())},e.prototype._getPainter=function(){return!this._painter&&this.getMap()&&(-1!==a.indexOf(this.type)?this._painter=new Ln(this):this._painter=new Rn(this)),this._painter},e.prototype._removePainter=function(){this._painter&&this._painter.remove(),delete this._painter},e.prototype._paint=function(t){this._painter&&this._painter.paint(t)},e.prototype._clearCache=function(){delete this._extent},e.prototype._clearProjection=function(){delete this._extent},e.prototype._repaint=function(){this._painter&&this._painter.repaint()},e.prototype.onHide=function(){this.closeMenu(),this.closeInfoWindow()},e.prototype.onShapeChanged=function(){this._clearCache(),this._repaint(),this._fireEvent("shapechange")},e.prototype.onPositionChanged=function(){this._clearCache(),this._repaint(),this._fireEvent("positionchange")},e.prototype.onSymbolChanged=function(){this._painter&&this._painter.refreshSymbol(),this._fireEvent("symbolchange")},e.prototype.onConfig=function(t){var e=void 0;t.properties&&(e=t.properties,delete t.properties);var r=!1;for(var n in t)if(t.hasOwnProperty(n)){var i=n.slice(0,5);if("arrow"===i||"smoot"===i){r=!0;break}}e?(this.setProperties(e),this._repaint()):r&&this._repaint()},e.prototype._setParent=function(t){t&&(this._parent=t)},e.prototype._getParent=function(){return this._parent},e.prototype._fireEvent=function(t,e){this.getLayer()&&this.getLayer()._onGeometryEvent&&(e||(e={}),e.type=t,e.target=this,this.getLayer()._onGeometryEvent(e)),this.fire(t,e)},e.prototype._toJSON=function(t){return{feature:this.toGeoJSON(t)}},e.prototype._exportGraphicOptions=function(t){var e={};return(y(t.options)||t.options)&&(e.options=this.config()),(y(t.symbol)||t.symbol)&&(e.symbol=this.getSymbol()),(y(t.infoWindow)||t.infoWindow)&&this._infoWinOptions&&(e.infoWindow=this._infoWinOptions),e},e.prototype._exportGeoJSONGeometry=function(){var t=this.getCoordinates(),e=br.toNumberArrays(t);return{type:this.getType(),coordinates:e}},e.prototype._exportProperties=function(){var t=null,e=this.getProperties();return y(e)||(t=b(e)?_({},e):e),t},e}(gr(cr(_r(pr))));On.mergeOptions({id:null,visible:!0,editable:!0,cursor:null,defaultProjection:"EPSG:4326"});var kn="mousedown mouseup mousemove click dblclick contextmenu touchstart touchmove touchend",Dn=function(t){function e(){return d(this,e),m(this,t.apply(this,arguments))}return p(e,t),e.prototype.addHooks=function(){var t=this.target,e=t._panels.allLayers||t._containerDOM;er(e,kn,this._identifyGeometryEvents,this)},e.prototype.removeHooks=function(){var t=this.target,e=t._panels.allLayers||t._containerDOM;rr(e,kn,this._identifyGeometryEvents,this)},e.prototype._identifyGeometryEvents=function(t,e){var r=this.target;if(!r.isInteracting()&&!r._ignoreEvent(t)){var n=r._getLayers(function(t){return!(!t.identify||!t.options.geometryEvents)});if(n.length){var i=null,o=e||t.type;if("mousedown"===o||"touchstart"===o&&1===t.touches.length)this._mouseDownTime=g();else if(("click"===o||"touchend"===o)&&this._mouseDownTime){var a=this._mouseDownTime;if(delete this._mouseDownTime,g()-a>300){if("click"===o)return}else"touchend"===o&&(i="click")}var s=t.touches&&t.touches.length>0?t.touches[0]:t.changedTouches&&t.changedTouches.length>0?t.changedTouches[0]:t;if(s){var h=We(s,r._containerDOM),u=r.containerPointToCoordinate(h);"touchstart"===o&&Ue(t);var l=null,c={includeInternals:!0,filter:function(e){if(!(e instanceof On))return!1;var r=e._getEventTypeToFire(t);if("mousemove"===o){if(!l&&e.options.cursor&&(l=e.options.cursor),!e.listens("mousemove")&&!e.listens("mouseover")&&!e.listens("mouseenter"))return!1}else if(!e.listens(r)&&!e.listens(i))return!1;return!0},count:1,coordinate:u,onlyVisible:r.options.onlyVisibleGeometryEvents,layers:n},f=function(e){var n=!0;if("mousemove"===o){var a={};if(e.length>0)for(var s=e.length-1;s>=0;s--){var h=e[s];if(h instanceof On){var u=h._getInternalId();a[u]=h,h._onEvent(t),this._prevOverGeos&&this._prevOverGeos.geomap[u]||h._onEvent(t,"mouseenter"),n=h._onEvent(t,"mouseover")}}r._setPriorityCursor(l);var c=this._prevOverGeos&&this._prevOverGeos.geos;if(this._prevOverGeos={geos:e,geomap:a},c&&c.length>0)for(var f=c.length-1;f>=0;f--){var d=c[f];if(d instanceof On){var p=c[f]._getInternalId();a[p]||(n=d._onEvent(t,"mouseout"))}}}else{if(!e||!e.length)return;for(var m=e.length-1;m>=0;m--)if(e[m]instanceof On){n=e[m]._onEvent(t),i&&e[m]._onEvent(t,i);break}}!1===n&&He(t)}.bind(this);this._queryIdentifyTimeout&&L(this._queryIdentifyTimeout),"mousemove"===o||"touchmove"===o?this._queryIdentifyTimeout=R(function(){r.isInteracting()||r.identify(c,f)}):r.identify(c,f)}}}},e}(dr);on.mergeOptions({geometryEvents:!0,onlyVisibleGeometryEvents:!0}),on.addOnLoadHook("addHandler","geometryEvents",Dn);var In=function(t){function e(){return d(this,e),m(this,t.apply(this,arguments))}return p(e,t),e.prototype.addHooks=function(){Fe(this.target._containerDOM,"mousewheel",this._onWheelScroll,this)},e.prototype.removeHooks=function(){Be(this.target._containerDOM,"mousewheel",this._onWheelScroll)},e.prototype._onWheelScroll=function(t){var e=this,r=this.target;if(r._ignoreEvent(t)||!r.options.zoomable)return!1;if(Ue(t),He(t),this._zooming)return this._requesting++,!1;this._requesting=0;var n=r._containerDOM,i=(t.wheelDelta?t.wheelDelta:t.detail)>0?1:-1;t.detail&&(i*=-1);var o=r.getZoom(),a=o+i;if((a=r._checkZoom(i>0?Math.ceil(a):Math.floor(a)))===o)return!1;this._zooming=!0;var s=r._checkZoomOrigin(We(t,n));this._delta||(r.onZoomStart(null,s),this._origin=s,this._delta=i,this._startZoom=r.getZoom());return r.animateTo({zoom:a-1*this._delta/2,around:this._origin},{continueOnViewChanged:!0,easing:"linear",duration:90,wheelZoom:!0},function(n){"finished"===n.state.playState&&(e._requesting<1||Math.abs(a-e._startZoom)>2||a===r.getMaxZoom()||a===r.getMinZoom()?(r.animateTo({zoom:a,around:e._origin},{continueOnViewChanged:!0,duration:100},function(t){"finished"===t.state.playState&&setTimeout(function(){delete e._zooming,delete e._requesting},200)}),delete e._startZoom,delete e._origin,delete e._delta,e._requesting=0):y(e._requesting)||(delete e._zooming,e._onWheelScroll(t)))}),!1},e}(dr);on.mergeOptions({scrollWheelZoom:!0}),on.addOnLoadHook("addHandler","scrollWheelZoom",In);var Nn=function(t){function e(){return d(this,e),m(this,t.apply(this,arguments))}return p(e,t),e.prototype.addHooks=function(){Fe(this.target.getContainer(),"touchstart",this._onTouchStart,this)},e.prototype.removeHooks=function(){Be(this.target.getContainer(),"touchstart",this._onTouchStart)},e.prototype._onTouchStart=function(t){var e=this.target;if(t.touches&&2===t.touches.length&&!e.isInteracting()){var r=e.getContainer(),n=We(t.touches[0],r),i=We(t.touches[1],r);this.preY=n.y,this._startP1=n,this._startP2=i,this._startDist=n.distanceTo(i),this._startVector=n.sub(i),this._startZoom=e.getZoom(),this._startBearing=e.getBearing(),Fe(document,"touchmove",this._onTouchMove,this),Fe(document,"touchend",this._onTouchEnd,this),Ue(t),e._fireEvent("touchactstart")}},e.prototype._onTouchMove=function(t){var e=this.target;if(t.touches&&2===t.touches.length){var r=e.getContainer(),n=We(t.touches[0],r),i=We(t.touches[1],r),o=n.sub(this._startP1),a=i.sub(this._startP2),s=n.sub(i),h=n.distanceTo(i)/this._startDist,u=180*s.angleWith(this._startVector)/Math.PI,l=.4*((this.preY||n.y)-n.y);this.preY=n.y;var c={domEvent:t,mousePos:[n,i]};if(this.mode||(e.options.touchRotate&&Math.abs(u)>8?this.mode=e.options.touchZoomRotate?"rotate_zoom":"rotate":e.options.touchPitch&&o.y*a.y>0&&Math.abs(o.y)>10&&Math.abs(a.y)>10?this.mode="pitch":e.options.zoomable&&e.options.touchZoom&&Math.abs(1-h)>.15&&(this.mode=e.options.touchZoomRotate&&e.options.touchRotate?"rotate_zoom":"zoom"),this._startTouching(c)),"zoom"===this.mode||"rotate_zoom"===this.mode){this._scale=h;var f=e._getResolution(this._startZoom)/h,d=e.getZoomFromRes(f);e.onZooming(d,this._Origin)}"rotate"===this.mode||"rotate_zoom"===this.mode?(e.setBearing(this._startBearing+u),e.onDragRotating(c)):"pitch"===this.mode&&(e.setPitch(e.getPitch()+l),e.onDragRotating(c)),e._fireEvent("touchactinging")}},e.prototype._startTouching=function(t){var e=this.target;if("zoom"===this.mode||"rotate_zoom"===this.mode){var r=e.getSize();this._Origin=new ce(r.width/2,r.height/2),e.onZoomStart(null,this._Origin)}"rotate"!==this.mode&&"pitch"!==this.mode&&"rotate_zoom"!==this.mode||e.onDragRotateStart(t)},e.prototype._onTouchEnd=function(t){delete this.preY;var e=this.target;if(rr(document,"touchmove",this._onTouchMove,this),rr(document,"touchend",this._onTouchEnd,this),"zoom"===this.mode||"rotate_zoom"===this.mode){var r=this._scale,n=e._getResolution(this._startZoom)/r,i=e.getZoomFromRes(n);e.onZoomEnd(i,this._Origin)}"pitch"!==this.mode&&"rotate"!==this.mode&&"rotate_zoom"!==this.mode||e.onDragRotateEnd({domEvent:t}),delete this.mode,e._fireEvent("touchactend")},e}(dr);on.mergeOptions({touchGesture:!0,touchZoom:!0,touchPitch:!0,touchRotate:!0,touchZoomRotate:!1}),on.addOnLoadHook("addHandler","touchGesture",Nn);var Fn={in:function(t){return Math.pow(t,2)},out:function(t){return 1-Fn.in(1-t)},inAndOut:function(t){return 3*t*t-2*t*t*t},linear:function(t){return t},upAndDown:function(t){return t<.5?Fn.inAndOut(2*t):1-Fn.inAndOut(2*(t-.5))}},Bn=function t(e,r){d(this,t),this.state=e,this.styles=r},zn=function t(e,r,n){d(this,t),this._animation=e,this.options=r,this._onFrame=n,this.playState="idle",this.ready=!0,this.finished=!1},Un={speed:{slow:2e3,normal:1e3,fast:500},_resolveStyles:function(t){if(!t)return null;function e(t){if(!Array.isArray(t))return Un._resolveStyles(t);for(var e=[],r=[],n=[],i=0;i<t.length;i++){var o=Un._resolveStyles(t[i]);o&&(e.push(o[0]),r.push(o[1]),n.push(o[2]))}return e.length?[e,r,n]:null}function r(t){var e=t,r=void 0;Array.isArray(t)||(e=v(t)?[0,t]:t instanceof ce||t instanceof br?[new(r=t.constructor)(0,0),t]:[t,t]);var n=e[0],i=e[1];return v(n)&&v(i)?n===i?null:[n,i-n,i]:Array.isArray(n)||n instanceof br||n instanceof ce?(Array.isArray(n)?(n=new br(n),i=new br(i)):(n=new(r=n.constructor)(n),i=new r(i)),n.equals(i)?null:[n,i.sub(n),i]):[n,0,i]}var n,i={},o={},a={};for(var s in t)if(t.hasOwnProperty(s)){var h=t[s];if(!h)continue;if(Array.isArray(h)&&(y(h[0])||y(h[1])))continue;var u=void 0;n=h,(u=!Array.isArray(n)&&n.constructor===Object||Array.isArray(n)&&n[0].constructor===Object?e(h):r(h))&&(o[s]=u[0],i[s]=u[1],a[s]=u[2])}return[o,i,a]},framing:function(t,e){e||(e={});var r=e.easing?Fn[e.easing]:Fn.linear;r||(r=Fn.linear);var n=void 0,i=void 0,o=void 0;(t=Un._resolveStyles(t))&&(i=t[0],n=t[1],o=t[2]);return function(t,e){var a=void 0,s=void 0;if(t<0)a={playState:"idle",delta:0},s=i;else if(t<e){var h=r(t/e);a={playState:"running",delta:h},s=function t(e,r,n){if(!r||!n)return null;var i={};for(var a in n)if(n.hasOwnProperty(a)){if(r[a]===o[a]){i[a]=r[a];continue}var s=r[a],h=n[a];if(v(h))i[a]=s+e*h;else if(Array.isArray(h)){for(var u=[],l=0;l<h.length;l++)u.push(t(e,s[l],h[l]));i[a]=u}else h.constructor===Object?i[a]=t(e,s,h):(s instanceof ce||s instanceof br)&&(i[a]=s.add(h.multi(e)))}return i}(h,i,n)}else a={playState:"finished",delta:1},s=o;return a.startStyles=i,a.destStyles=o,a.progress=t,a.remainingMs=e-t,new Bn(a,s)}},_requestAnimFrame:function(t){this._frameQueue||(this._frameQueue=[]),this._frameQueue.push(t),this._a()},_a:function(){this._animationFrameId||(this._animationFrameId=R(Un._frameFn))},_run:function(){if(this._frameQueue.length){var t=this._frameQueue;this._frameQueue=[];for(var e=0,r=t.length;e<r;e++)t[e]();this._frameQueue.length?this._animationFrameId=R(Un._frameFn):delete this._animationFrameId}},animate:function(t,e,r){e||(e={});var n=Un.framing(t,e);return new zn(n,e,r)}};Un._frameFn=Un._run.bind(Un),_(zn.prototype,{_prepare:function(){var t=this.options,e=t.speed||t.duration;w(e)&&((e=Un.speed[e])||(e=+e)),e||(e=Un.speed.normal),this.duration=e,this._framer=t.framer||Un._requestAnimFrame.bind(Un)},play:function(){if("idle"!==this.playState&&"paused"!==this.playState)return this;"idle"===this.playState&&(this.currentTime=0,this._prepare());var t=g();if(!this.startTime){var e=this.options;this.startTime=e.startTime?e.startTime:t}return this._playStartTime=Math.max(t,this.startTime),"paused"===this.playState&&(this._playStartTime-=this.currentTime),this.playState="running",this._run(),this},pause:function(){return"paused"===this.playState?this:(this.playState="paused",this._run(),this)},cancel:function(){return"idle"===this.playState?this:(this.playState="idle",this.finished=!1,this._run(),this)},finish:function(){return"finished"===this.playState?this:(this.playState="finished",this.finished=!0,this._run(),this)},reverse:function(){},_run:function(){var t=this,e=this._onFrame,r=g(),n=r-this._playStartTime;if(this.options.repeat&&n>=this.duration&&(this._playStartTime=r,n=0),"running"===this.playState){var i=this._animation(n,this.duration);this.playState=i.state.playState,"idle"===this.playState?this.startTime>r&&setTimeout(this._run.bind(this),this.startTime-r):"running"===this.playState?this._framer(function(){"running"===t.playState&&(t.currentTime=n,e&&e(i),t._run())}):"finished"===this.playState&&(this.finished=!0,e&&e(i))}else if(e){"finished"===this.playState?n=this.duration:"idle"===this.playState&&(n=0);var o=this._animation(n,this.duration);o.state.playState=this.playState,e(o)}}});var Hn=Object.freeze({Animation:Un,Easing:Fn,Player:zn,Frame:Bn}),jn=qr(function(t){!function(){function e(t,e,r){var n=e.x,i=e.y,o=r.x-n,a=r.y-i;if(0!==o||0!==a){var s=((t.x-n)*o+(t.y-i)*a)/(o*o+a*a);s>1?(n=r.x,i=r.y):s>0&&(n+=o*s,i+=a*s)}return(o=t.x-n)*o+(a=t.y-i)*a}function r(t,r){var n=t.length-1,i=[t[0]];return function t(r,n,i,o,a){for(var s,h=o,u=n+1;u<i;u++){var l=e(r[u],r[n],r[i]);l>h&&(s=u,h=l)}h>o&&(s-n>1&&t(r,n,s,o,a),a.push(r[s]),i-s>1&&t(r,s,i,o,a))}(t,0,n,r,i),i.push(t[n]),i}function n(t,e,n){if(t.length<=2)return t;var i=void 0!==e?e*e:1;return t=r(t=n?t:function(t,e){for(var r,n,i,o,a,s=t[0],h=[s],u=1,l=t.length;u<l;u++)r=t[u],i=s,o=(n=r).x-i.x,a=n.y-i.y,o*o+a*a>e&&(h.push(r),s=r);return s!==r&&h.push(r),h}(t,i),i)}t.exports=n,t.exports.default=n}()}),Gn=function(t){function e(){return d(this,e),m(this,t.apply(this,arguments))}return p(e,t),e.prototype.getOutline=function(){var t=this._getPainter();if(!t)return null;var e=this.getMap(),r=t.getContainerExtent().convertTo(function(t){return e.containerPointToCoord(t)});return new Vn(r.toArray(),{symbol:{lineWidth:1,lineColor:"6b707b"}})},e.prototype.animateShow=function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=arguments[1];this._showPlayer&&this._showPlayer.finish(),T(e)&&(r=e={});var n=this.getCoordinates();if(0===n.length)return this;this._animIdx=0,this._animLenSoFar=0,this.show();var i=!!this.getShell?this.getShell().concat(this.getShell()[0]):this.getCoordinates(),o=this._getProjection();this._aniShowCenter=o.unproject(this._getPrjExtent().getCenter());var a=e.duration||1e3,s=this.getLength(),h=e.easing||"out";this.setCoordinates([]);var u=this._showPlayer=Un.animate({t:a},{duration:a,easing:h},function(e){if(t.getMap()){var o=t._drawAnimShowFrame(e.styles.t,a,s,i);"finished"===e.state.playState&&(delete t._showPlayer,delete t._aniShowCenter,delete t._animIdx,delete t._animLenSoFar,delete t._animTailRatio,t.setCoordinates(n)),r&&r(e,o)}else if("finished"!==u.playState&&(u.finish(),r)){var h=t.getCoordinates();r(e,h[h.length-1])}});return u.play(),u},e.prototype._drawAnimShowFrame=function(t,e,r,n){if(0===t)return n[0];var i,o=this.getMap(),a=t/e*r,s=0,h=void 0;for(h=this._animIdx,i=n.length;h<i-1&&(s=o.computeLength(n[h],n[h+1]),!(this._animLenSoFar+s>a));h++)this._animLenSoFar+=s;if(this._animIdx=h,this._animIdx>=i-1)return this.setCoordinates(n),n[n.length-1];var u=this._animIdx,l=n[u],c=n[u+1],f=(a-this._animLenSoFar)/s;this._animTailRatio=f;var d=l.x+(c.x-l.x)*f,p=l.y+(c.y-l.y)*f,m=new br(d,p),g=!!this.getShell;if(!g&&this.options.smoothness>0){var _=n.slice(0,this._animIdx+3);this.setCoordinates(_)}else{var y=n.slice(0,this._animIdx+1);y.push(m),g?this.setCoordinates([this._aniShowCenter].concat(y)):this.setCoordinates(y)}return m},e.prototype._getCenterInExtent=function(t,e,r){var n=this.getExtent();if(!t.intersects(n))return null;var i=r(e,t);if(0===i.length)return null;var o=0,a=0,s=0;i.forEach(function(t){Array.isArray(t)?t.forEach(function(t){t.point&&(t=t.point),o+=t.x,a+=t.y,s++}):(t.point&&(t=t.point),o+=t.x,a+=t.y,s++)});var h=new br(o,a)._multi(1/s);return h.count=s,h},e.prototype._getPath2DPoints=function(t,e,r){if(!X(t))return[];var n=this.getMap(),i=!e&&this._shouldSimplify(),o=2*n._getResolution(),a=Array.isArray(t[0]);if(delete this._simplified,i&&!a){var s=t.length;t=jn(t,o,!1),this._simplified=t.length<s}return y(r)&&(r=n.getZoom()),U(t,function(t){return n._prjToPoint(t,r)})},e.prototype._shouldSimplify=function(){var t=this.getLayer(),e=this.getProperties(),r=e&&t.options.enableAltitude&&!y(e[t.options.altitudeProperty]);return t&&t.options.enableSimplify&&!r&&this.options.enableSimplify},e.prototype._setPrjCoordinates=function(t){this._prjCoords=t,this.onShapeChanged()},e.prototype._getPrjCoordinates=function(){return this._getProjection()?(this._verifyProjection(),this._prjCoords||(this._prjCoords=this._projectCoords(this._coordinates)),this._prjCoords):null},e.prototype._updateCache=function(){this._clearCache(),this._getProjection()&&this._prjCoords&&(this._coordinates=this._unprojectCoords(this._getPrjCoordinates()))},e.prototype._clearProjection=function(){this._prjCoords=null,t.prototype._clearProjection.call(this)},e.prototype._projectCoords=function(t){var e=this._getProjection();return e?e.projectCoords(t):[]},e.prototype._unprojectCoords=function(t){var e=this._getProjection();return e?e.unprojectCoords(t):[]},e.prototype._computeCenter=function(){var t=this._coordinates;if(!X(t))return null;for(var e=0,r=0,n=0,i=t.length,o=0;o<i;o++)t[o]&&v(t[o].x)&&v(t[o].y)&&(e+=t[o].x,r+=t[o].y,n++);return new br(e/n,r/n)},e.prototype._computeExtent=function(){var t=this._coordinates;if(!X(t))return null;var e=[t];return this.hasHoles&&this.hasHoles()&&e.push.apply(e,this.getHoles()),this._coords2Extent(e,this._getProjection())},e.prototype._computePrjExtent=function(){var t=[this._getPrjCoordinates()];return this.hasHoles&&this.hasHoles()&&t.push.apply(t,this._getPrjHoles()),this._coords2Extent(t)},e.prototype._get2DLength=function(){for(var t=this._getPath2DPoints(this._getPrjCoordinates(),!0),e=0,r=1,n=t.length;r<n;r++)e+=t[r].distanceTo(t[r-1]);return e},e.prototype._hitTestTolerance=function(){var t=this._getInternalSymbol(),e=void 0;if(Array.isArray(t)){e=0;for(var r=0;r<t.length;r++)v(t[r].lineWidth)&&t[r].lineWidth>e&&(e=t[r].lineWidth)}else e=t.lineWidth;return v(e)?e/2:1.5},e.prototype._coords2Extent=function(t,e){for(var r=new Er(e),n=0,i=t.length;n<i;n++)for(var o=0,a=t[n].length;o<a;o++)r._combine(t[n][o]);return r},e}(On);Gn.mergeOptions({smoothness:0,enableClip:!0,enableSimplify:!0,symbol:{lineColor:"#000",lineWidth:2,lineOpacity:1,polygonFill:"#fff",polygonOpacity:1,opacity:1}});var Vn=function(t){function e(r,n){d(this,e);var i=m(this,t.call(this,n));return i.type="Polygon",r&&i.setCoordinates(r),i}return p(e,t),e.prototype.setCoordinates=function(t){if(!t)return this._coordinates=null,this._holes=null,this._projectRings(),this;var e=br.toCoordinates(t),r=e.length;if(Array.isArray(e[0])){if(this._coordinates=this._trimRing(e[0]),r>1){for(var n=[],i=1;i<r;i++)e[i]&&n.push(this._trimRing(e[i]));this._holes=n}}else this._coordinates=this._trimRing(e);return this._projectRings(),this},e.prototype.getCoordinates=function(){if(!this._coordinates)return[];for(var t=this.getHoles(),e=[this._copyAndCloseRing(this._coordinates)],r=0,n=t.length;r<n;r++)e.push(this._copyAndCloseRing(t[r]));return e},e.prototype.getCenterInExtent=function(t){return this._getCenterInExtent(t,this.getShell(),cn)},e.prototype.getShell=function(){return this._coordinates||[]},e.prototype.getHoles=function(){return this._holes||[]},e.prototype.hasHoles=function(){return this.getHoles().length>0},e.prototype._projectRings=function(){this.getMap()?(this._prjCoords=this._projectCoords(this._coordinates),this._prjHoles=this._projectCoords(this._holes),this.onShapeChanged()):this.onShapeChanged()},e.prototype._cleanRing=function(t){for(var e=t.length-1;e>=0;e--)t[e]||t.splice(e,1)},e.prototype._checkRing=function(t){if(this._cleanRing(t),!t||!X(t))return!1;var e=t[t.length-1],r=!0;return t[0].x===e.x&&t[0].y===e.y||(r=!1),r},e.prototype._trimRing=function(t){var e=this._checkRing(t);return X(t)&&e&&t.splice(t.length-1,1),t},e.prototype._copyAndCloseRing=function(t){t=t.slice(0);var e=this._checkRing(t);return X(t)&&!e?(t.push(t[0].copy()),t):t},e.prototype._getPrjShell=function(){return"Polygon"===this.getJSONType()?this._getPrjCoordinates():this._getProjection()?(this._verifyProjection(),this._prjShell||(this._prjShell=this._projectCoords(this.getShell())),this._prjShell):null},e.prototype._getPrjHoles=function(){return this._getProjection()?(this._verifyProjection(),this._prjHoles||(this._prjHoles=this._projectCoords(this.getHoles())),this._prjHoles):null},e.prototype._computeGeodesicLength=function(t){var e=this.getCoordinates();if(!X(e))return 0;for(var r=0,n=0,i=e.length;n<i;n++)r+=t.measureLength(e[n]);return r},e.prototype._computeGeodesicArea=function(t){var e=this.getCoordinates();if(!X(e))return 0;for(var r=t.measureArea(e[0]),n=1,i=e.length;n<i;n++)r-=t.measureArea(e[n]);return r},e.prototype._updateCache=function(){t.prototype._updateCache.call(this),this._prjHoles&&(this._holes=this._unprojectCoords(this._getPrjHoles()))},e.prototype._clearCache=function(){return delete this._prjShell,t.prototype._clearCache.call(this)},e.prototype._clearProjection=function(){this._prjHoles&&(this._prjHoles=null),this._prjShell&&(this._prjShell=null),t.prototype._clearProjection.call(this)},e}(Gn);Vn.registerJSONType("Polygon");var Wn=function(t){return function(t){function e(){return d(this,e),m(this,t.apply(this,arguments))}return p(e,t),e.prototype.getCoordinates=function(){return this._coordinates},e.prototype.setCoordinates=function(t){var e=t instanceof br?t:new br(t);if(e.equals(this._coordinates))return this;if(this._coordinates=e,!this.getMap())return this.onPositionChanged(),this;var r=this._getProjection();return this._setPrjCoordinates(r.project(this._coordinates)),this},e.prototype._getCenter2DPoint=function(t){var e=this.getMap();if(!e)return null;var r=y(t)?e.getZoom():e.getGLZoom(),n=this._getPrjCoordinates();return n?e._prjToPoint(n,r):null},e.prototype._getPrjCoordinates=function(){var t=this._getProjection();return t?(this._verifyProjection(),this._pcenter||this._coordinates&&(this._pcenter=t.project(this._coordinates)),this._pcenter):null},e.prototype._setPrjCoordinates=function(t){this._pcenter=t,this.onPositionChanged()},e.prototype._updateCache=function(){this._clearCache();var t=this._getProjection();this._pcenter&&t&&(this._coordinates=t.unproject(this._pcenter))},e.prototype._clearProjection=function(){this._pcenter=null,t.prototype._clearProjection.call(this)},e.prototype._computeCenter=function(){return this._coordinates?this._coordinates.copy():null},e}(t)},Zn=function(t){function e(r,n){d(this,e);var i=m(this,t.call(this,n));return i.type="Point",r&&i.setCoordinates(r),i}return p(e,t),e.prototype.getOutline=function(){var t=this._getPainter();if(!t)return null;var r=this.getCoordinates(),n=t.getContainerExtent(),i=this.getMap().coordToContainerPoint(r);return new e(r,{symbol:{markerType:"square",markerWidth:n.getWidth(),markerHeight:n.getHeight(),markerLineWidth:1,markerLineColor:"6b707b",markerFill:"rgba(0, 0, 0, 0)",markerDx:n.xmin-(i.x-n.getWidth()/2),markerDy:n.ymin-(i.y-n.getHeight()/2)}})},e.prototype._isVectorMarker=function(){var t=this._getInternalSymbol();return!Array.isArray(t)&&yn.test(t)},e.prototype._canEdit=function(){var t=this._getInternalSymbol();return!Array.isArray(t)&&(yn.test(t)||En.test(t)||xn.test(t))},e.prototype._containsPoint=function(e,r){var n=this.getContainerExtent();return r&&(n=n.expand(r)),!!n.contains(e)&&(!this.options.hitTestForEvent||t.prototype._containsPoint.call(this,e,r))},e.prototype._computeExtent=function(){return Xn.call(this,"getCenter")},e.prototype._computePrjExtent=function(){return Xn.call(this,"_getPrjCoordinates")},e.prototype._computeGeodesicLength=function(){return 0},e.prototype._computeGeodesicArea=function(){return 0},e.prototype._getSprite=function(t,e){return this._getPainter()?this._getPainter().getSprite(t,e):new Rn(this).getSprite(t,e)},e}(Wn(On));function Xn(t){var e=this[t]();return e?new Er(e,e,this._getProjection()):null}Zn.mergeOptions({symbol:{markerType:"path",markerPath:[{path:"M8 23l0 0 0 0 0 0 0 0 0 0c-4,-5 -8,-10 -8,-14 0,-5 4,-9 8,-9l0 0 0 0c4,0 8,4 8,9 0,4 -4,9 -8,14z M3,9 a5,5 0,1,0,0,-0.9Z",fill:"#DE3333"}],markerPathWidth:16,markerPathHeight:23,markerWidth:24,markerHeight:34},hitTestForEvent:!1}),Zn.registerJSONType("Marker");var qn=function(t){function e(r,n){d(this,e);var i=m(this,t.call(this,n));return i.type="LineString",r&&i.setCoordinates(r),i}return p(e,t),e.prototype.setCoordinates=function(t){return t?(this._coordinates=br.toCoordinates(t),this.getMap()?this._setPrjCoordinates(this._projectCoords(this._coordinates)):this.onShapeChanged(),this):(this._coordinates=null,this._setPrjCoordinates(null),this)},e.prototype.getCoordinates=function(){return this._coordinates||[]},e.prototype.getCenterInExtent=function(t){return this._getCenterInExtent(t,this.getCoordinates(),hn)},e.prototype._computeGeodesicLength=function(t){return t.measureLength(this.getCoordinates())},e.prototype._computeGeodesicArea=function(){return 0},e}(Gn);qn.mergeOptions({arrowStyle:null,arrowPlacement:"vertex-last"}),qn.registerJSONType("LineString");var Yn=function(t){function e(r,n){d(this,e);var i=m(this,t.call(this,n));return i.type="GeometryCollection",i.setGeometries(r),i}return p(e,t),e.prototype.setGeometries=function(t){for(var e=this._checkGeometries(t||[]),r=this._getSymbol(),n=this.config(),i=e.length-1;i>=0;i--)e[i]._initOptions(n),e[i]._setParent(this),e[i]._setEventParent(this),r&&e[i].setSymbol(r);return this._geometries=e,this.getLayer()&&(this._bindGeometriesToLayer(),this.onShapeChanged()),this},e.prototype.getGeometries=function(){return this._geometries||[]},e.prototype.forEach=function(t,e){for(var r=this.getGeometries(),n=0,i=r.length;n<i;n++)r[n]&&(e?t.call(e,r[n],n):t(r[n],n));return this},e.prototype.filter=function(t,r){if(!t)return new e;var n=[],i=T(t),o=i?t:ht(t);return this.forEach(function(t){var e=i?t:_t(t);(r?o.call(r,e):o(e))&&n.push(t)},this),new e(n)},e.prototype.translate=function(t){if(!t)return this;if(this.isEmpty())return this;var e=arguments;return this.forEach(function(t){t&&t.translate&&t.translate.apply(t,e)}),this},e.prototype.isEmpty=function(){return!X(this.getGeometries())},e.prototype.remove=function(){return this.forEach(function(t){t._unbind()}),On.prototype.remove.apply(this,arguments)},e.prototype.show=function(){return this.options.visible=!0,this.forEach(function(t){t.show()}),this},e.prototype.hide=function(){return this.options.visible=!1,this.forEach(function(t){t.hide()}),this},e.prototype.onConfig=function(t){this.forEach(function(e){e.config(t)})},e.prototype.getSymbol=function(){var e=t.prototype.getSymbol.call(this);if(!e){var r=[],n=!1;this.forEach(function(t){t.getSymbol()&&!n&&(n=!0),r.push(t.getSymbol())}),n&&(e={children:r})}return e},e.prototype.setSymbol=function(t){if(t&&t.children)this._symbol=null,this.forEach(function(e,r){e.setSymbol(t.children[r])});else{var e=this._prepareSymbol(t);this._symbol=e,this.forEach(function(t){t.setSymbol(e)})}return this.onSymbolChanged(),this},e.prototype._setExternSymbol=function(t){return t=this._prepareSymbol(t),this._externSymbol=t,this.forEach(function(e){e._setExternSymbol(t)}),this.onSymbolChanged(),this},e.prototype._bindLayer=function(){t.prototype._bindLayer.apply(this,arguments),this._bindGeometriesToLayer()},e.prototype._bindGeometriesToLayer=function(){var t=this.getLayer();this.forEach(function(e){e._bindLayer(t)})},e.prototype._checkGeometries=function(t){if(t&&!Array.isArray(t)){if(t instanceof On)return[t];throw new Error("The geometry added to collection is invalid.")}for(var e=0,r=t.length;e<r;e++)if(!this._checkGeo(t[e]))throw new Error("The geometry added to collection is invalid. Index: "+e);return t},e.prototype._checkGeo=function(t){return t instanceof On},e.prototype._updateCache=function(){this._clearCache(),this.isEmpty()||this.forEach(function(t){t&&t._updateCache&&t._updateCache()})},e.prototype._removePainter=function(){this._painter&&this._painter.remove(),delete this._painter,this.forEach(function(t){t._removePainter()})},e.prototype._computeCenter=function(t){if(!t||this.isEmpty())return null;for(var e=0,r=0,n=0,i=this.getGeometries(),o=0,a=i.length;o<a;o++)if(i[o]){var s=i[o]._computeCenter(t);s&&(e+=s.x,r+=s.y,n++)}return 0===n?null:new br(e/n,r/n)},e.prototype._containsPoint=function(t,e){if(this.isEmpty())return!1;for(var r=this.getGeometries(),n=0,i=r.length;n<i;n++)if(r[n]._containsPoint(t,e))return!0;return!1},e.prototype._computeExtent=function(t){return Jn.call(this,t,"_computeExtent")},e.prototype._computePrjExtent=function(t){return Jn.call(this,t,"_computePrjExtent")},e.prototype._computeGeodesicLength=function(t){if(!t||this.isEmpty())return 0;for(var e=this.getGeometries(),r=0,n=0,i=e.length;n<i;n++)e[n]&&(r+=e[n]._computeGeodesicLength(t));return r},e.prototype._computeGeodesicArea=function(t){if(!t||this.isEmpty())return 0;for(var e=this.getGeometries(),r=0,n=0,i=e.length;n<i;n++)e[n]&&(r+=e[n]._computeGeodesicArea(t));return r},e.prototype._exportGeoJSONGeometry=function(){var t=[];if(!this.isEmpty())for(var e=this.getGeometries(),r=0,n=e.length;r<n;r++)e[r]&&t.push(e[r]._exportGeoJSONGeometry());return{type:"GeometryCollection",geometries:t}},e.prototype._clearProjection=function(){if(!this.isEmpty())for(var t=this.getGeometries(),e=0,r=t.length;e<r;e++)t[e]&&t[e]._clearProjection()},e.prototype._getConnectPoints=function(){var t=this.getExtent();return[new br(t.xmin,t.ymax),new br(t.xmax,t.ymin),new br(t.xmin,t.ymin),new br(t.xmax,t.ymax)]},e.prototype._getExternalResources=function(){if(this.isEmpty())return[];for(var t=this.getGeometries(),e=[],r={},n=void 0,i=void 0,o=0,a=t.length;o<a;o++)if(t[o])for(var s=0,h=(n=kt(t[o]._getInternalSymbol())).length;s<h;s++)r[i=n[s].join()]||(e.push(n[s]),r[i]=1);return e},e.prototype.startEdit=function(t){var e=this;if(this.isEmpty())return this;t||(t={}),t.symbol&&(this._originalSymbol=this.getSymbol(),this.setSymbol(t.symbol)),this._draggbleBeforeEdit=this.options.draggable,this.config("draggable",!1);for(var r=this.getGeometries(),n=0,i=r.length;n<i;n++)r[n].startEdit(t);return this._editing=!0,this.hide(),setTimeout(function(){e.fire("editstart")},1),this},e.prototype.endEdit=function(){if(this.isEmpty())return this;for(var t=this.getGeometries(),e=0,r=t.length;e<r;e++)t[e].endEdit();return this._originalSymbol&&(this.setSymbol(this._originalSymbol),delete this._originalSymbol),this._editing=!1,this.show(),this.config("draggable",this._draggbleBeforeEdit),this.fire("editend"),this},e.prototype.isEditing=function(){return!!this._editing},e}(On);function Jn(t,e){if(this.isEmpty())return null;for(var r=this.getGeometries(),n=null,i=0,o=r.length;i<o;i++){var a=r[i];if(a){var s=a[e](t);s&&(n=s.combine(n))}}return n}Yn.registerJSONType("GeometryCollection");var Kn=function(t){function e(r,n,i,o){d(this,e);var a=m(this,t.call(this,null,o));return a.GeometryType=r,a.type=n,a._initData(i),a}return p(e,t),e.prototype.getCoordinates=function(){for(var t=[],e=this.getGeometries(),r=0,n=e.length;r<n;r++)t.push(e[r].getCoordinates());return t},e.prototype.setCoordinates=function(t){for(var e=[],r=0,n=(t=t||[]).length;r<n;r++){var i=new this.GeometryType(t[r],this.config());e.push(i)}return this.setGeometries(e),this},e.prototype._initData=function(t){(t=t||[]).length&&(t[0]instanceof this.GeometryType?this.setGeometries(t):this.setCoordinates(t))},e.prototype._checkGeo=function(t){return t instanceof this.GeometryType},e.prototype._exportGeoJSONGeometry=function(){var t=this.getCoordinates(),e=br.toNumberArrays(t);return{type:this.getType(),coordinates:e}},e}(Yn),Qn=function(t){function e(r,n){return d(this,e),m(this,t.call(this,Zn,"MultiPoint",r,n))}return p(e,t),e}(Kn);Qn.registerJSONType("MultiPoint");var $n=function(t){function e(){return d(this,e),m(this,t.apply(this,arguments))}return p(e,t),e.prototype.getCenterInExtent=function(t){var e=0,r=0,n=0;return this.getGeometries().forEach(function(i){var o=i.getCenterInExtent(t);o&&(e+=o.x*o.count,r+=o.y*o.count,n+=o.count)}),0===n?null:new br(e,r)._multi(1/n)},e}(Kn),ti=function(t){function e(r,n){return d(this,e),m(this,t.call(this,qn,"MultiLineString",r,n))}return p(e,t),e}($n);ti.registerJSONType("MultiLineString");var ei=function(t){function e(r,n){return d(this,e),m(this,t.call(this,Vn,"MultiPolygon",r,n))}return p(e,t),e}($n);ei.registerJSONType("MultiPolygon");var ri={Marker:Zn,LineString:qn,Polygon:Vn,MultiPoint:Qn,MultiLineString:ti,MultiPolygon:ei},ni={toGeometry:function(t){if(w(t)&&(t=F(t)),Array.isArray(t)){for(var e=[],r=0,n=t.length;r<n;r++){var i=ni._convert(t[r]);Array.isArray(i)?B(e,i):e.push(i)}return e}return ni._convert(t)},_convert:function(t){if(!t||y(t.type))return null;var e=t.type;if("Feature"===e){var r=t.geometry,n=ni._convert(r);return n?(n.setId(t.id),n.setProperties(t.properties),n):null}if("FeatureCollection"===e){var i=t.features;return i?ni.toGeometry(i):null}if(["Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon"].indexOf(e)>=0)return new ri["Point"===e?"Marker":e](t.coordinates);if("GeometryCollection"===e){var o=t.geometries;if(!X(o))return new Yn;for(var a=[],s=o.length,h=0;h<s;h++)a.push(ni._convert(o[h]));return new Yn(a)}return null}},ii=function(t){function e(r,n,i){d(this,e);var o=m(this,t.call(this,null,i));return r&&o.setCoordinates(r),o._radius=n,o}return p(e,t),e.fromJSON=function(t){var r=t.feature,n=new e(t.coordinates,t.radius,t.options);return n.setProperties(r.properties),n},e.prototype.getRadius=function(){return this._radius},e.prototype.setRadius=function(t){return this._radius=t,this.onShapeChanged(),this},e.prototype.getShell=function(){for(var t=this._getMeasurer(),e=this.getCoordinates(),r=this.options.numberOfShellPoints,n=this.getRadius(),i=[],o=void 0,a=void 0,s=void 0,h=0,u=r-1;h<u;h++){o=360*h/u*Math.PI/180,a=n*Math.cos(o),s=n*Math.sin(o);var l=t.locate(e,a,s);i.push(l)}return i.push(i[0]),i},e.prototype.getHoles=function(){return[]},e.prototype.animateShow=function(){return this.show()},e.prototype._containsPoint=function(e,r){var n=this.getMap();if(n.getPitch())return t.prototype._containsPoint.call(this,e,r);var i=n._pointToContainerPoint(this._getCenter2DPoint()),o=this.getSize(),a=y(r)?this._hitTestTolerance():r;return pn(e,i,i.add(o.width/2,o.height/2),a)},e.prototype._computePrjExtent=function(t){var e=this._getMinMax(t);if(!e)return null;var r=this._getPrjCoordinates(),n=e.map(function(e){return t.project(e)}),i=Math.min(Math.abs(n[0].x-r.x),Math.abs(n[1].x-r.x)),o=Math.min(Math.abs(n[2].y-r.y),Math.abs(n[3].y-r.y));return new Er(r.sub(i,o),r.add(i,o))},e.prototype._computeExtent=function(t){var e=this._getMinMax(t);return e?new Er(e[0].x,e[2].y,e[1].x,e[3].y,this._getProjection()):null},e.prototype._getMinMax=function(t){if(!t||!this._coordinates||y(this._radius))return null;var e=this._radius;return[t.locate(this._coordinates,-e,0),t.locate(this._coordinates,e,0),t.locate(this._coordinates,0,e),t.locate(this._coordinates,0,-e)]},e.prototype._computeGeodesicLength=function(){return y(this._radius)?0:2*Math.PI*this._radius},e.prototype._computeGeodesicArea=function(){return y(this._radius)?0:Math.PI*Math.pow(this._radius,2)},e.prototype._exportGeoJSONGeometry=function(){return{type:"Polygon",coordinates:br.toNumberArrays([this.getShell()])}},e.prototype._toJSON=function(t){var e=this.getCenter(),r=_({},t);r.geometry=!1;var n=this.toGeoJSON(r);return n.geometry={type:"Polygon"},{feature:n,subType:"Circle",coordinates:[e.x,e.y],radius:this.getRadius()}},e}(Wn(Vn));ii.mergeOptions({numberOfShellPoints:60}),ii.registerJSONType("Circle");var oi=function(t){function e(r,n,i,o){d(this,e);var a=m(this,t.call(this,null,o));return r&&a.setCoordinates(r),a.width=n,a.height=i,a}return p(e,t),e.fromJSON=function(t){var r=t.feature,n=new e(t.coordinates,t.width,t.height,t.options);return n.setProperties(r.properties),n},e.prototype.getWidth=function(){return this.width},e.prototype.setWidth=function(t){return this.width=t,this.onShapeChanged(),this},e.prototype.getHeight=function(){return this.height},e.prototype.setHeight=function(t){return this.height=t,this.onShapeChanged(),this},e.prototype.getShell=function(){for(var t=this._getMeasurer(),e=this.getCoordinates(),r=this.options.numberOfShellPoints,n=this.getWidth(),i=this.getHeight(),o=[],a=Math.pow(n/2,2)*Math.pow(i/2,2),s=Math.pow(n/2,2),h=Math.pow(i/2,2),u=void 0,l=void 0,c=void 0,f=void 0,d=0;d<r;d++){l=(u=360*d/r)*Math.PI/180,c=Math.sqrt(a/(s*Math.pow(Math.tan(l),2)+h)),f=Math.sqrt(a/(h*Math.pow(1/Math.tan(l),2)+s)),u>90&&u<270&&(c*=-1),u>180&&u<360&&(f*=-1);var p=t.locate(e,c,f);o.push(p)}return o},e.prototype.getHoles=function(){return[]},e.prototype.animateShow=function(){return this.show()},e.prototype._containsPoint=function(e,r){var n=this.getMap();if(n.isTransforming())return t.prototype._containsPoint.call(this,e,r);var i=n.getProjection(),o=y(r)?this._hitTestTolerance():r,a=i.projectCoords([this._coordinates,n.locate(this._coordinates,this.getWidth()/2,this.getHeight()/2)]);return pn(e,n._prjToContainerPoint(a[0]),n._prjToContainerPoint(a[1]),o)},e.prototype._computePrjExtent=function(){return ii.prototype._computePrjExtent.apply(this,arguments)},e.prototype._computeExtent=function(){return ii.prototype._computeExtent.apply(this,arguments)},e.prototype._getMinMax=function(t){if(!t||!this._coordinates||y(this.width)||y(this.height))return null;var e=this.getWidth(),r=this.getHeight();return[t.locate(this._coordinates,-e/2,0),t.locate(this._coordinates,e/2,0),t.locate(this._coordinates,0,-r/2),t.locate(this._coordinates,0,r/2)]},e.prototype._computeGeodesicLength=function(){if(y(this.width)||y(this.height))return 0;var t=this.width>this.height?this.width:this.height;return 2*Math.PI*t/2-4*Math.abs(this.width-this.height)},e.prototype._computeGeodesicArea=function(){return y(this.width)||y(this.height)?0:Math.PI*this.width*this.height/4},e.prototype._exportGeoJSONGeometry=function(){return{type:"Polygon",coordinates:br.toNumberArrays([this.getShell()])}},e.prototype._toJSON=function(t){var e=_({},t),r=this.getCenter();e.geometry=!1;var n=this.toGeoJSON(e);return n.geometry={type:"Polygon"},{feature:n,subType:"Ellipse",coordinates:[r.x,r.y],width:this.getWidth(),height:this.getHeight()}},e}(Wn(Vn));oi.mergeOptions({numberOfShellPoints:80}),oi.registerJSONType("Ellipse");var ai=function(t){function e(r,n,i,o){d(this,e);var a=m(this,t.call(this,null,o));return r&&a.setCoordinates(r),a._width=n,a._height=i,a}return p(e,t),e.fromJSON=function(t){var r=t.feature,n=new e(t.coordinates,t.width,t.height,t.options);return n.setProperties(r.properties),n},e.prototype.getCoordinates=function(){return this._coordinates},e.prototype.setCoordinates=function(t){if(this._coordinates=t instanceof br?t:new br(t),!this._coordinates||!this.getMap())return this.onPositionChanged(),this;var e=this._getProjection();return this._setPrjCoordinates(e.project(this._coordinates)),this},e.prototype.getWidth=function(){return this._width},e.prototype.setWidth=function(t){return this._width=t,this.onShapeChanged(),this},e.prototype.getHeight=function(){return this._height},e.prototype.setHeight=function(t){return this._height=t,this.onShapeChanged(),this},e.prototype.getShell=function(){var t=this._getMeasurer(),e=this._coordinates,r=this.getMap(),n=1,i=-1;if(r){var o=r.getFullExtent();o.left>o.right&&(n=-1),o.bottom>o.top&&(i=1)}var a=[];return a.push(e),a.push(t.locate(e,n*this._width,0)),a.push(t.locate(e,n*this._width,i*this._height)),a.push(t.locate(e,0,i*this._height)),a.push(e),a},e.prototype.getHoles=function(){return[]},e.prototype.animateShow=function(){return this.show()},e.prototype._getPrjCoordinates=function(){var t=this._getProjection();return t?(this._verifyProjection(),this._pnw||this._coordinates&&(this._pnw=t.project(this._coordinates)),this._pnw):null},e.prototype._setPrjCoordinates=function(t){this._pnw=t,this.onPositionChanged()},e.prototype._getPrjShell=function(){var e=t.prototype._getPrjShell.call(this),r=this._getProjection();if(!r.isSphere())return e;for(var n=r.getSphereExtent(),i=n.sx,o=n.sy,a=this._getProjection().getCircum(),s=e[0],h=1,u=e.length;h<u;h++){var l=e[h],c=0,f=0;i*(s.x-l.x)>0&&(c=a.x*i),o*(s.y-l.y)<0&&(f=a.y*o),e[h]._add(c,f)}return e},e.prototype._updateCache=function(){this._clearCache();var t=this._getProjection();this._pnw&&t&&(this._coordinates=t.unproject(this._pnw))},e.prototype._clearProjection=function(){this._pnw=null,t.prototype._clearProjection.call(this)},e.prototype._computeCenter=function(t){return t.locate(this._coordinates,this._width/2,-this._height/2)},e.prototype._containsPoint=function(e,r){var n=this.getMap();if(n.isTransforming())return t.prototype._containsPoint.call(this,e,r);var i=y(r)?this._hitTestTolerance():r,o=n._getResolution()*i,a=this._getPrjExtent().expand(o),s=n._containerPointToPrj(e);return a.contains(s)},e.prototype._computePrjExtent=function(t){var e=this._getSouthEast(t);if(!e)return null;var r=t.projectCoords([new br(this._coordinates.x,e.y),new br(e.x,this._coordinates.y)]);return new Er(r[0],r[1])},e.prototype._computeExtent=function(t){var e=this._getSouthEast(t);return e?new Er(this._coordinates,e,this._getProjection()):null},e.prototype._getSouthEast=function(t){if(!t||!this._coordinates||y(this._width)||y(this._height))return null;var e=this.getWidth(),r=-this.getHeight();if(t.fullExtent){var n=t.fullExtent;e*=n.right>n.left?1:-1,r*=n.top>n.bottom?1:-1}return t.locate(this._coordinates,e,r)},e.prototype._computeGeodesicLength=function(){return y(this._width)||y(this._height)?0:2*(this._width+this._height)},e.prototype._computeGeodesicArea=function(){return y(this._width)||y(this._height)?0:this._width*this._height},e.prototype._exportGeoJSONGeometry=function(){return{type:"Polygon",coordinates:br.toNumberArrays([this.getShell()])}},e.prototype._toJSON=function(t){var e=_({},t),r=this.getCoordinates();e.geometry=!1;var n=this.toGeoJSON(e);return n.geometry={type:"Polygon"},{feature:n,subType:"Rectangle",coordinates:[r.x,r.y],width:this.getWidth(),height:this.getHeight()}},e}(Vn);ai.registerJSONType("Rectangle");var si=function(t){function e(r,n,i,o,a){d(this,e);var s=m(this,t.call(this,r,n,a));return s.startAngle=i,s.endAngle=o,s}return p(e,t),e.fromJSON=function(t){var r=t.feature,n=new e(t.coordinates,t.radius,t.startAngle,t.endAngle,t.options);return n.setProperties(r.properties),n},e.prototype.getStartAngle=function(){return this.startAngle},e.prototype.setStartAngle=function(t){return this.startAngle=t,this.onShapeChanged(),this},e.prototype.getEndAngle=function(){return this.endAngle},e.prototype.setEndAngle=function(t){return this.endAngle=t,this.onShapeChanged(),this},e.prototype.getShell=function(){for(var t=this._getMeasurer(),e=this.getCoordinates(),r=this.options.numberOfShellPoints-2,n=this.getRadius(),i=[e.copy()],o=this.getStartAngle(),a=this.getEndAngle()-o,s=void 0,h=void 0,u=void 0,l=0;l<r;l++){s=(a*l/(r-1)+o)*Math.PI/180,h=n*Math.cos(s),u=n*Math.sin(s);var c=t.locate(e,h,u);i.push(c)}return i.push(e.copy()),i},e.prototype._containsPoint=function(e,r){var n=this.getMap();if(n.isTransforming())return t.prototype._containsPoint.call(this,e,r);var i=n._pointToContainerPoint(this._getCenter2DPoint()),o=y(r)?this._hitTestTolerance():r,a=this.getSize(),s=i,h=e,u=h.x-s.x,l=s.y-h.y,c=Math.atan2(l,u),f=c<0?360*(c+2*Math.PI)/(2*Math.PI):360*c/(2*Math.PI),d=this.startAngle%360,p=this.endAngle%360,m=!1;return m=d>p?!(f>p&&f<d):f>=d&&f<=p,h.distanceTo(s)<=a.width/2+o&&m},e.prototype._computeGeodesicLength=function(){return y(this._radius)?0:2*Math.PI*this._radius*Math.abs(this.startAngle-this.endAngle)/360+2*this._radius},e.prototype._computeGeodesicArea=function(){return y(this._radius)?0:Math.PI*Math.pow(this._radius,2)*Math.abs(this.startAngle-this.endAngle)/360},e.prototype._toJSON=function(t){var e=_({},t),r=this.getCenter();e.geometry=!1;var n=this.toGeoJSON(e);return n.geometry={type:"Polygon"},{feature:n,subType:"Sector",coordinates:[r.x,r.y],radius:this.getRadius(),startAngle:this.getStartAngle(),endAngle:this.getEndAngle()}},e}(ii);si.mergeOptions({numberOfShellPoints:60}),si.registerJSONType("Sector");var hi=function(t){function e(){return d(this,e),m(this,t.apply(this,arguments))}return p(e,t),e.prototype._arc=function(t,e,r){for(var n=this.options.arcDegree*Math.PI/180,i=1,o=e.length;i<o;i++){var a=ar._arcBetween(t,e[i-1],e[i],n),s=[e[i-1].x+e[i].x-a[0],e[i-1].y+e[i].y-a[1]];e[i-1].nextCtrlPoint=s,e[i].prevCtrlPoint=s,ar._stroke(t,r)}},e.prototype._quadraticCurve=function(t,e){if(e.length<=2)ar._path(t,e);else{var r,n=void 0;for(n=2,r=e.length;n<r;n+=2)t.quadraticCurveTo(e[n-1].x,e[n-1].y,e[n].x,e[n].y);if((n-=1)<r)for(;n<r;n++)t.lineTo(e[n].x,e[n].y)}},e.prototype._bezierCurve=function(t,e){if(e.length<=3)ar._path(t,e);else{var r,n=void 0;for(n=1,r=e.length;n+2<r;n+=3)t.bezierCurveTo(e[n].x,e[n].y,e[n+1].x,e[n+1].y,e[n+2].x,e[n+2].y);if(n<r)for(;n<r;n++)t.lineTo(e[n].x,e[n].y)}},e.prototype._getCurveArrowPoints=function(t,e,r,n,i,o){var a=e.length,s=void 0;for(s=o;s<a;s+=o)t.push(this._getArrowShape(e[s-1],e[s],r,n,i));if((s-=o)<a-1)for(s+=1;s<a;s++)t.push(this._getArrowShape(e[s-1],e[s],r,n,i))},e}(qn);hi.mergeOptions({enableSimplify:!1,enableClip:!1});var ui=function(t){function e(){return d(this,e),m(this,t.apply(this,arguments))}return p(e,t),e.prototype._toJSON=function(t){return{feature:this.toGeoJSON(t),subType:"ArcCurve"}},e.prototype._paintOn=function(t,e,r){t.beginPath(),this._arc(t,e,r),ar._stroke(t,r),this._paintArrow(t,e,r)},e.fromJSON=function(t){var r=t.feature,n=new e(r.geometry.coordinates,t.options);return n.setProperties(r.properties),n},e}(hi);ui.registerJSONType("ArcCurve"),ui.mergeOptions({arcDegree:90});var li=function(t){function e(){return d(this,e),m(this,t.apply(this,arguments))}return p(e,t),e.fromJSON=function(t){var r=t.feature,n=new e(r.geometry.coordinates,t.options);return n.setProperties(r.properties),n},e.prototype._toJSON=function(t){return{feature:this.toGeoJSON(t),subType:"CubicBezierCurve"}},e.prototype._paintOn=function(t,e,r){t.beginPath(),t.moveTo(e[0].x,e[0].y),this._bezierCurve(t,e),ar._stroke(t,r),this._paintArrow(t,e,r)},e.prototype._getArrowPoints=function(t,e,r,n,i){return this._getCurveArrowPoints(t,e,r,n,i,3)},e}(hi);li.registerJSONType("CubicBezierCurve");var ci=function(t){function e(){return d(this,e),m(this,t.apply(this,arguments))}return p(e,t),e.fromJSON=function(t){var r=t.feature,n=new e(r.geometry.coordinates,t.options);return n.setProperties(r.properties),n},e.prototype._toJSON=function(t){return{feature:this.toGeoJSON(t),subType:"QuadBezierCurve"}},e.prototype._paintOn=function(t,e,r){t.beginPath(),t.moveTo(e[0].x,e[0].y),this._quadraticCurve(t,e,r),ar._stroke(t,r),this._paintArrow(t,e,r)},e.prototype._getArrowPoints=function(t,e,r,n,i){return this._getCurveArrowPoints(t,e,r,n,i,2)},e}(hi);ci.registerJSONType("QuadBezierCurve");var fi={textFaceName:"monospace",textSize:12,textLineSpacing:8,textWrapCharacter:"\n",textHorizontalAlignment:"middle",textVerticalAlignment:"middle"},di={markerType:"square",markerLineColor:"#000",markerLineWidth:2,markerLineOpacity:1,markerFill:"#fff",markerOpacity:1},pi=function(t){function e(){return d(this,e),m(this,t.apply(this,arguments))}return p(e,t),e.prototype.getContent=function(){return this._content},e.prototype.setContent=function(t){var e=this._content;return this._content=me(t),this._refresh(),this._fireEvent("contentchange",{old:e,new:t}),this},e.prototype.onAdd=function(){this._refresh()},e.prototype.toJSON=function(){var e=t.prototype.toJSON.call(this);return delete e.symbol,e},e.prototype.setSymbol=function(e){if(this._refreshing||!e)return t.prototype.setSymbol.call(this,e);var r=this._parseSymbol(e);if(this.setTextStyle){var n=this.getTextStyle()||{};n.symbol=r[0],this.setTextStyle(n)}else this.setTextSymbol&&this.setTextSymbol(r[0]);if(this.setBoxStyle){var i=this.getBoxStyle()||{};i.symbol=r[1],this.setBoxStyle(i)}else this.setBoxSymbol&&this.setBoxSymbol(r[1]);return this},e.prototype._parseSymbol=function(t){var e={},r={};for(var n in t)C(t,n)&&(0===n.indexOf("text")?e[n]=t[n]:r[n]=t[n]);return[e,r]},e.prototype._getTextSize=function(t){return Ae(this._content,t).size},e.prototype._getInternalSymbol=function(){return this._symbol},e.prototype._getDefaultTextSymbol=function(){return _({},fi)},e.prototype._getDefaultBoxSymbol=function(){return _({},di)},e.prototype._getDefaultPadding=function(){return[12,8]},e}(Zn),mi=function(t){function e(r,n,i,o){var a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};d(this,e);var s=m(this,t.call(this,n,a));return s._content=me(r),s._width=y(i)?100:i,s._height=y(o)?40:o,a.boxSymbol&&s.setBoxSymbol(a.boxSymbol),a.textStyle&&s.setTextStyle(a.textStyle),s._refresh(),s}return p(e,t),e.prototype.getWidth=function(){return this._width},e.prototype.setWidth=function(t){return this._width=t,this._refresh(),this},e.prototype.getHeight=function(){return this._height},e.prototype.setHeight=function(t){return this._height=t,this._refresh(),this},e.prototype.getBoxSymbol=function(){return _({},this.options.boxSymbol)},e.prototype.setBoxSymbol=function(t){return this.options.boxSymbol=t?_({},t):t,this.getSymbol()&&this._refresh(),this},e.prototype.getTextStyle=function(){return this.options.textStyle?_({},this.options.textStyle):null},e.prototype.setTextStyle=function(t){return this.options.textStyle=t?_({},t):t,this.getSymbol()&&this._refresh(),this},e.fromJSON=function(t){var r=t.feature,n=new e(t.content,r.geometry.coordinates,t.width,t.height,t.options);return n.setProperties(r.properties),n.setId(r.id),t.symbol&&n.setSymbol(t.symbol),n},e.prototype._toJSON=function(t){return{feature:this.toGeoJSON(t),width:this.getWidth(),height:this.getHeight(),subType:"TextBox",content:this._content}},e.prototype._refresh=function(){var t=this.getTextStyle()||{},e=t.padding||[12,8],r=this._width-2*e[0],n=this._height-2*e[1],i=_({},t.symbol||this._getDefaultTextSymbol(),this.options.boxSymbol||this._getDefaultBoxSymbol(),{textName:this._content,markerWidth:this._width,markerHeight:this._height,textHorizontalAlignment:"middle",textVerticalAlignment:"middle",textMaxWidth:r,textMaxHeight:n});t.wrap&&!i.textWrapWidth&&(i.textWrapWidth=r);var o=t.horizontalAlignment;i.textDx=i.markerDx||0;var a=i.markerWidth/2-e[0];"left"===o?(i.textHorizontalAlignment="right",i.textDx=i.textDx-a):"right"===o&&(i.textHorizontalAlignment="left",i.textDx=i.textDx+a);var s=t.verticalAlignment;i.textDy=i.markerDy||0;var h=i.markerHeight/2-e[1];"top"===s?(i.textVerticalAlignment="bottom",i.textDy-=h):"bottom"===s&&(i.textVerticalAlignment="top",i.textDy+=h),this._refreshing=!0,this.updateSymbol(i),delete this._refreshing},e}(pi);mi.mergeOptions({textStyle:{wrap:!0,padding:[12,8],verticalAlignment:"middle",horizontalAlignment:"middle"},boxSymbol:null}),mi.registerJSONType("TextBox");var gi=function(t){function e(r,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};d(this,e);var o=m(this,t.call(this,n,i));return i.textSymbol&&o.setTextSymbol(i.textSymbol),i.boxStyle&&o.setBoxStyle(i.boxStyle),o._content=me(r),o._refresh(),o}return p(e,t),e.prototype.getBoxStyle=function(){return this.options.boxStyle?_({},this.options.boxStyle):null},e.prototype.setBoxStyle=function(t){return this.options.boxStyle=t?_({},t):t,this._refresh(),this},e.prototype.getTextSymbol=function(){return _({},this._getDefaultTextSymbol(),this.options.textSymbol)},e.prototype.setTextSymbol=function(t){return this.options.textSymbol=t?_({},t):t,this._refresh(),this},e.fromJSON=function(t){var r=t.feature,n=new e(t.content,r.geometry.coordinates,t.options);return n.setProperties(r.properties),n.setId(r.id),t.symbol&&n.setSymbol(t.symbol),n},e.prototype._canEdit=function(){return!1},e.prototype._toJSON=function(t){return{feature:this.toGeoJSON(t),subType:"Label",content:this._content}},e.prototype._refresh=function(){var t=_({},this.getTextSymbol(),{textName:this._content}),e=this.getBoxStyle();if(e){_(t,e.symbol);var r=this._getBoxSize(t),n=r[1],i=e.padding||this._getDefaultPadding(),o=r[0];t.markerWidth=o.width,t.markerHeight=o.height;var a=t.textDx||0,s=t.textDy||0,h=Ce(n,t.textHorizontalAlignment,t.textVerticalAlignment)._add(a,s),u=e.horizontalAlignment||"middle";t.markerDx=h.x,"left"===u?t.markerDx+=t.markerWidth/2-i[0]:"right"===u?t.markerDx-=t.markerWidth/2-n.width-i[0]:t.markerDx+=n.width/2;var l=e.verticalAlignment||"middle";t.markerDy=h.y,"top"===l?t.markerDy+=t.markerHeight/2-i[1]:"bottom"===l?t.markerDy-=t.markerHeight/2-n.height-i[1]:t.markerDy+=n.height/2}this._refreshing=!0,this.updateSymbol(t),delete this._refreshing},e.prototype._getBoxSize=function(t){t.markerType||(t.markerType="square");var e=this.getBoxStyle(),r=this._getTextSize(t),n=void 0,i=void 0,o=e.padding||this._getDefaultPadding();return n=r.width+2*o[0],i=r.height+2*o[1],e.minWidth&&(!n||n<e.minWidth)&&(n=e.minWidth),e.minHeight&&(!i||i<e.minHeight)&&(i=e.minHeight),[new fe(n,i),r]},e}(pi);gi.mergeOptions({boxStyle:null,textSymbol:null}),gi.registerJSONType("Label");var _i=function(t){return function(t){function e(){return d(this,e),m(this,t.apply(this,arguments))}return p(e,t),e._hasConnectors=function(t){return!y(t.__connectors)&&t.__connectors.length>0},e._getConnectors=function(t){return t.__connectors},e.prototype.getConnectSource=function(){return this._connSource},e.prototype.setConnectSource=function(t){var e=this._connTarget;return this.onRemove(),this._connSource=t,this._connTarget=e,this.onAdd(),this},e.prototype.getConnectTarget=function(){return this._connTarget},e.prototype.setConnectTarget=function(t){var e=this._connSource;return this.onRemove(),this._connSource=e,this._connTarget=t,this._updateCoordinates(),this._registerEvents(),this},e.prototype._updateCoordinates=function(){var t=this.getMap();if(!t&&this._connSource&&(t=this._connSource.getMap()),!t&&this._connTarget&&(t=this._connTarget.getMap()),t&&this._connSource&&this._connTarget){for(var e=this._connSource._getConnectPoints(),r=this._connTarget._getConnectPoints(),n=0,i=this.getCoordinates(),o=void 0,a=void 0,s=0,h=e.length;s<h;s++)for(var u=e[s],l=0,c=r.length;l<c;l++){var f=r[l],d=t.computeLength(u,f);0===s&&0===l?(o=u,a=f,n=d):d<n&&(o=u,a=f)}X(i)&&i[0].equals(o)&&i[1].equals(a)||this.setCoordinates([o,a])}},e.prototype.onAdd=function(){this._registerEvents(),this._updateCoordinates()},e.prototype.onRemove=function(){if(this._connSource&&(this._connSource.__connectors&&z(this,this._connSource.__connectors),this._connSource.off("dragging positionchange",this._updateCoordinates,this).off("remove",this.onRemove,this),this._connSource.off("dragstart mousedown mouseover",this._showConnect,this),this._connSource.off("dragend mouseup mouseout",this.hide,this),this._connSource.off("show",this._showConnect,this).off("hide",this.hide,this),delete this._connSource),this._connTarget&&(z(this,this._connTarget.__connectors),this._connTarget.off("dragging positionchange",this._updateCoordinates,this).off("remove",this.onRemove,this),this._connTarget.off("show",this._showConnect,this).off("hide",this.hide,this),delete this._connTarget),!(this._connSource instanceof On&&this._connTarget instanceof On)){var t=this.getMap();t&&t.off("movestart moving moveend zoomstart zooming zoomend rotate pitch fovchange spatialreferencechange",this._updateCoordinates,this)}},e.prototype._showConnect=function(){this._connSource&&this._connTarget&&this._connSource.isVisible()&&this._connTarget.isVisible()&&(this._updateCoordinates(),this.show())},e.prototype._registerEvents=function(){if(this._connSource&&this._connTarget){this._connSource.__connectors||(this._connSource.__connectors=[]),this._connTarget.__connectors||(this._connTarget.__connectors=[]),this._connSource.__connectors.push(this),this._connTarget.__connectors.push(this),this._connSource.on("dragging positionchange",this._updateCoordinates,this).on("remove",this.remove,this),this._connTarget.on("dragging positionchange",this._updateCoordinates,this).on("remove",this.remove,this),this._connSource.on("show",this._showConnect,this).on("hide",this.hide,this),this._connTarget.on("show",this._showConnect,this).on("hide",this.hide,this);var t=this.options.showOn;if(this.hide(),"moving"===t?(this._connSource.on("dragstart",this._showConnect,this).on("dragend",this.hide,this),this._connTarget.on("dragstart",this._showConnect,this).on("dragend",this.hide,this)):"click"===t?(this._connSource.on("mousedown",this._showConnect,this).on("mouseup",this.hide,this),this._connTarget.on("mousedown",this._showConnect,this).on("mouseup",this.hide,this)):"mouseover"===t?(this._connSource.on("mouseover",this._showConnect,this).on("mouseout",this.hide,this),this._connTarget.on("mouseover",this._showConnect,this).on("mouseout",this.hide,this)):this._showConnect(),!(this._connSource instanceof On&&this._connTarget instanceof On)){var e=this.getMap();e&&e.on("movestart moving moveend zoomstart zooming zoomend rotate pitch fovchange spatialreferencechange",this._updateCoordinates,this)}}},e}(t)},yi={showOn:"always"},vi=function(t){function e(r,n,i){d(this,e);var o=m(this,t.call(this,null,i));return 1===arguments.length&&(i=r,r=null,n=null),o._connSource=r,o._connTarget=n,o}return p(e,t),e}(_i(qn));vi.mergeOptions(yi),vi.registerJSONType("ConnectorLine");var xi=function(t){function e(r,n,i){d(this,e);var o=m(this,t.call(this,null,i));return 1===arguments.length&&(i=r,r=null,n=null),o._connSource=r,o._connTarget=n,o}return p(e,t),e}(_i(ui));xi.mergeOptions(yi),xi.registerJSONType("ArcConnectorLine");var bi=function(t){function e(r,n,i){d(this,e),n&&!(n instanceof On)&&!Array.isArray(n)&&s.indexOf(n.type)<0&&(i=n,n=null);var o=m(this,t.call(this,r,i));return o._maxZIndex=0,o._minZIndex=0,o._initCache(),n&&o.addGeometry(n),o}return p(e,t),e.prototype.getGeometryById=function(t){return y(t)||""===t?null:this._geoMap[t]?this._geoMap[t]:null},e.prototype.getGeometries=function(t,e){if(!t)return this._geoList.slice(0);for(var r=[],n=void 0,i=0,o=this._geoList.length;i<o;i++)n=this._geoList[i],(e?t.call(e,n):t(n))&&r.push(n);return r},e.prototype.getFirstGeometry=function(){return this._geoList.length?this._geoList[0]:null},e.prototype.getLastGeometry=function(){var t=this._geoList.length;return 0===t?null:this._geoList[t-1]},e.prototype.getCount=function(){return this._geoList.length},e.prototype.getExtent=function(){if(0===this.getCount())return null;var t=new Er(this.getProjection());return this.forEach(function(e){t._combine(e.getExtent())}),t},e.prototype.forEach=function(t,e){for(var r=this._geoList.slice(0),n=0,i=r.length;n<i;n++)e?t.call(e,r[n],n):t(r[n],n);return this},e.prototype.filter=function(){return Yn.prototype.filter.apply(this,arguments)},e.prototype.isEmpty=function(){return!this._geoList.length},e.prototype.addGeometry=function(t,e){if(!t)return this;if("FeatureCollection"===t.type)return this.addGeometry(ni.toGeometry(t),e);if(!Array.isArray(t)){var r=arguments.length,n=arguments[r-1];return t=Array.prototype.slice.call(arguments,0,r-1),e=n,b(n)&&(t.push(n),e=!1),this.addGeometry(t,e)}if(0===t.length)return this;this._initCache();var i=void 0;!0===e&&(i=new Er),this._toSort=this._maxZIndex>0;for(var o=[],a=0,s=t.length;a<s;a++){var h=t[a];if(!h)throw new Error("Invalid geometry to add to layer("+this.getId()+") at index:"+a);if(!(h instanceof On)&&(h=On.fromJSON(h),Array.isArray(h)))for(var u=0,l=h.length;u<l;u++)this._add(h[u],i,a),o.push(h[u]);Array.isArray(h)||(this._add(h,i,a),o.push(h))}var c=this.getMap();if(c&&(this._getRenderer().onGeometryAdd(o),!0===e&&!y(i.xmin))){var f=c.getFitZoom(i);c.setCenterAndZoom(i.getCenter(),f)}return this.fire("addgeo",{geometries:t}),this},e.prototype.getGeoMinZIndex=function(){return this._minZIndex},e.prototype.getGeoMaxZIndex=function(){return this._maxZIndex},e.prototype._add=function(t,e,r){this._toSort||(this._toSort=0!==t.getZIndex()),this._updateZIndex(t.getZIndex());var n=t.getId();if(!y(n)){if(!y(this._geoMap[n]))throw new Error("Duplicate geometry id in layer("+this.getId()+"):"+n+", at index:"+r);this._geoMap[n]=t}var i=I();t._setInternalId(i),this._geoList.push(t),this.onAddGeometry&&this.onAddGeometry(t),t._bindLayer(this),t.onAdd&&t.onAdd(),e&&e._combine(t.getExtent()),t._fireEvent("add",{layer:this})},e.prototype.removeGeometry=function(t){if(!Array.isArray(t))return this.removeGeometry([t]);for(var e=t.length-1;e>=0;e--)t[e]instanceof On||(t[e]=this.getGeometryById(t[e])),t[e]&&this===t[e].getLayer()&&t[e].remove();return this.fire("removegeo",{geometries:t}),this},e.prototype.clear=function(){this._clearing=!0,this.forEach(function(t){t.remove()}),this._geoMap={};var t=this._geoList;return this._geoList=[],this._getRenderer()&&this._getRenderer().onGeometryRemove(t),this._clearing=!1,this.fire("clear"),this},e.prototype.onRemoveGeometry=function(t){if(t&&!this._clearing&&(this===t.getLayer()&&!y(t._getInternalId()))){var e=t.getId();y(e)||delete this._geoMap[e];var r=this._findInList(t);r>=0&&this._geoList.splice(r,1),this._getRenderer()&&this._getRenderer().onGeometryRemove([t])}},e.prototype.hide=function(){for(var t=0,e=this._geoList.length;t<e;t++)this._geoList[t].onHide();return $r.prototype.hide.call(this)},e.prototype.identify=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this._hitGeos(this._geoList,t,e)},e.prototype._hitGeos=function(t,e){for(var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=r.filter,i=r.tolerance,o=[],a=this.getMap(),s=a.coordToPoint(e),h=a._pointToContainerPoint(s),u=t.length-1;u>=0;u--){var l=t[u];if(l&&l.isVisible()&&l._getPainter()){if(!(l instanceof qn&&(l._getArrowStyle()||l instanceof hi))){var c=l.getContainerExtent();if(i&&(c=c.expand(i)),!c||!c.contains(h))continue}if(l._containsPoint(h,i)&&(!n||n(l))&&(o.push(l),r.count&&o.length>=r.count))break}}return o},e.prototype._initCache=function(){this._geoList||(this._geoList=[],this._geoMap={})},e.prototype._updateZIndex=function(){for(var t=arguments.length,e=Array(t),r=0;r<t;r++)e[r]=arguments[r];this._maxZIndex=Math.max(this._maxZIndex,Math.max.apply(Math,e)),this._minZIndex=Math.min(this._minZIndex,Math.min.apply(Math,e))},e.prototype._sortGeometries=function(){var t=this;this._toSort&&(this._maxZIndex=0,this._minZIndex=0,this._geoList.sort(function(e,r){return t._updateZIndex(e.getZIndex(),r.getZIndex()),t._compare(e,r)}),this._toSort=!1)},e.prototype._compare=function(t,e){return t.getZIndex()===e.getZIndex()?t._getInternalId()-e._getInternalId():t.getZIndex()-e.getZIndex()},e.prototype._findInList=function(t){var e=this._geoList.length;if(0===e)return-1;for(var r=0,n=e-1,i=void 0;r<=n;){if(i=Math.floor((r+n)/2),this._geoList[i]===t)return i;this._compare(this._geoList[i],t)>0?n=i-1:r=i+1}return-1},e.prototype._onGeometryEvent=function(t){if(t&&t.target){var e=t.type;"idchange"===e?this._onGeometryIdChange(t):"zindexchange"===e?this._onGeometryZIndexChange(t):"positionchange"===e?this._onGeometryPositionChange(t):"shapechange"===e?this._onGeometryShapeChange(t):"symbolchange"===e?this._onGeometrySymbolChange(t):"show"===e?this._onGeometryShow(t):"hide"===e?this._onGeometryHide(t):"propertieschange"===e&&this._onGeometryPropertiesChange(t)}},e.prototype._onGeometryIdChange=function(t){if(t.new!==t.old||!this._geoMap[t.old]||this._geoMap[t.old]!==t.target){if(!y(t.new)){if(this._geoMap[t.new])throw new Error("Duplicate geometry id in layer("+this.getId()+"):"+t.new);this._geoMap[t.new]=t.target}y(t.old)||t.new===t.old||delete this._geoMap[t.old]}},e.prototype._onGeometryZIndexChange=function(t){t.old!==t.new&&(this._updateZIndex(t.new),this._toSort=!0,this._getRenderer()&&this._getRenderer().onGeometryZIndexChange(t))},e.prototype._onGeometryPositionChange=function(t){this._getRenderer()&&this._getRenderer().onGeometryPositionChange(t)},e.prototype._onGeometryShapeChange=function(t){this._getRenderer()&&this._getRenderer().onGeometryShapeChange(t)},e.prototype._onGeometrySymbolChange=function(t){this._getRenderer()&&this._getRenderer().onGeometrySymbolChange(t)},e.prototype._onGeometryShow=function(t){this._getRenderer()&&this._getRenderer().onGeometryShow(t)},e.prototype._onGeometryHide=function(t){this._getRenderer()&&this._getRenderer().onGeometryHide(t)},e.prototype._onGeometryPropertiesChange=function(t){this._getRenderer()&&this._getRenderer().onGeometryPropertiesChange(t)},e}($r);bi.mergeOptions({drawImmediate:!1});var wi={debug:!1,enableSimplify:!0,geometryEvents:!0,defaultIconSize:[20,20],cacheVectorOnCanvas:!0,cacheSvgOnCanvas:ue.gecko,enableAltitude:!1,altitudeProperty:"altitude",drawAltitude:!1},Ti=function(t){function e(r,n,i){d(this,e);var o=m(this,t.call(this,r,n,i)),a=o.options.style;return delete o.options.style,a&&o.setStyle(a),o}return p(e,t),e.prototype.getStyle=function(){return this._style?this._style:null},e.prototype.setStyle=function(t){return this._style=t,this._cookedStyles=yt(t),this.forEach(function(t){this._styleGeometry(t)},this),this.fire("setstyle",{style:t}),this},e.prototype.removeStyle=function(){return this._style?(delete this._style,delete this._cookedStyles,this.forEach(function(t){t._setExternSymbol(null)},this),this.fire("removestyle"),this):this},e.prototype.onAddGeometry=function(t){this.getStyle()&&this._styleGeometry(t)},e.prototype.onConfig=function(e){if(t.prototype.onConfig.call(this,e),e.enableAltitude||e.drawAltitude||e.altitudeProperty){var r=this.getRenderer();r&&r.setToRedraw&&r.setToRedraw()}},e.prototype._styleGeometry=function(t){if(!this._cookedStyles)return!1;for(var e=_t(t),r=0,n=this._cookedStyles.length;r<n;r++)if(!0===this._cookedStyles[r].filter(e))return t._setExternSymbol(this._cookedStyles[r].symbol),!0;return!1},e.prototype.identify=function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=this.getRenderer();return r.onlyVisible&&n&&n.identify?n.identify(e,r):t.prototype.identify.call(this,e,r)},e.prototype.toJSON=function(t){t||(t={});var e={type:this.getJSONType(),id:this.getId(),options:this.config()};if((y(t.style)||t.style)&&this.getStyle()&&(e.style=this.getStyle()),y(t.geometries)||t.geometries){var r=void 0;if(t.clipExtent){var n=this.getMap(),i=n?n.getProjection():null;r=new Er(t.clipExtent,i)}for(var o=[],a=this.getGeometries(),s=0,h=a.length;s<h;s++){var u=a[s],l=u.getExtent();if(l&&(!r||r.intersects(l))){var c=u.toJSON(t.geometries);o.push(c)}}e.geometries=o}return e},e.fromJSON=function(t){if(!t||"VectorLayer"!==t.type)return null;for(var r=new e(t.id,t.options),n=t.geometries,i=[],o=0;o<n.length;o++){var a=On.fromJSON(n[o]);a&&i.push(a)}return r.addGeometry(i),t.style&&r.setStyle(t.style),r},e}(bi);Ti.mergeOptions(wi),Ti.registerJSONType("VectorLayer");var Ei="_map_tool",Ci=function(t){function e(){return d(this,e),m(this,t.apply(this,arguments))}return p(e,t),e.prototype.addTo=function(t){return t?(this._map=t,t[Ei]&&t[Ei].disable(),this.onAdd&&this.onAdd(),this.enable(),t[Ei]=this,this._fireEvent("add"),this):this},e.prototype.getMap=function(){return this._map},e.prototype.enable=function(){return!this._map||this._enabled?this:(this._enabled=!0,this._switchEvents("off"),this._registerEvents(),this.onEnable&&this.onEnable(),this._fireEvent("enable"),this)},e.prototype.disable=function(){return this._enabled&&this._map?(this._enabled=!1,this._switchEvents("off"),this.onDisable&&this.onDisable(),this._fireEvent("disable"),this):this},e.prototype.isEnabled=function(){return!!this._enabled},e.prototype.remove=function(){return this._map?(this.disable(),this._map&&(delete this._map[Ei],delete this._map),this._fireEvent("remove"),this):this},e.prototype._registerEvents=function(){this._switchEvents("on")},e.prototype._switchEvents=function(t){var e=this.getEvents();e&&this._map[t](e,this)},e.prototype._fireEvent=function(t,e){e||(e={}),this.fire(t,e)},e}(cr(pr)),Si={},Ai=function(t){function e(r){d(this,e);var n=m(this,t.call(this,r));return n._checkMode(),n._events={click:n._firstClickHandler,mousemove:n._mouseMoveHandler,dblclick:n._doubleClickHandler,mousedown:n._mouseDownHandler,mouseup:n._mouseUpHandler},n}return p(e,t),e.registerMode=function(t,e){Si[t.toLowerCase()]=e},e.getRegisterMode=function(t){return Si[t.toLowerCase()]},e.prototype.getMode=function(){return this.options.mode?this.options.mode.toLowerCase():null},e.prototype.setMode=function(t){return this._geometry&&(this._geometry.remove(),delete this._geometry),this._clearStage(),this._switchEvents("off"),this.options.mode=t,this._checkMode(),this.isEnabled()&&(this._switchEvents("on"),this._restoreMapCfg(),this._saveMapCfg()),this},e.prototype.getSymbol=function(){var t=this.options.symbol;return zt(t||this.options.symbol)},e.prototype.setSymbol=function(t){return t?(this.options.symbol=t,this._geometry&&this._geometry.setSymbol(t),this):this},e.prototype.getCurrentGeometry=function(){return this._geometry},e.prototype.onAdd=function(){this._checkMode()},e.prototype.onEnable=function(){return this._saveMapCfg(),this._drawToolLayer=this._getDrawLayer(),this._clearStage(),this._loadResources(),this},e.prototype.onDisable=function(){var t=this.getMap();return this._restoreMapCfg(),this.endDraw(),this._map&&t.removeLayer(this._getDrawLayer()),this},e.prototype.undo=function(){var t=this._getRegisterMode(),e=t.action;if(!this._shouldRecordHistory(e)||!this._historyPointer)return this;var r=this._clickCoords.slice(0,--this._historyPointer);return t.update(r,this._geometry),this},e.prototype.redo=function(){var t=this._getRegisterMode(),e=t.action;if(!this._shouldRecordHistory(e)||y(this._historyPointer)||this._historyPointer===this._clickCoords.length)return this;var r=this._clickCoords.slice(0,++this._historyPointer);return t.update(r,this._geometry),this},e.prototype._shouldRecordHistory=function(t){return Array.isArray(t)&&"click"===t[0]&&"mousemove"===t[1]&&"dblclick"===t[2]},e.prototype._checkMode=function(){this._getRegisterMode()},e.prototype._saveMapCfg=function(){var t=this.getMap();if(this._mapDoubleClickZoom=t.options.doubleClickZoom,t.config({doubleClickZoom:this.options.doubleClickZoom}),this._getRegisterMode().action.indexOf("mousedown")>-1){var e=this.getMap();this._mapDraggable=e.options.draggable,e.config({draggable:!1})}},e.prototype._restoreMapCfg=function(){var t=this.getMap();t.config({doubleClickZoom:this._mapDoubleClickZoom}),y(this._mapDraggable)||t.config("draggable",this._mapDraggable),delete this._mapDraggable,delete this._mapDoubleClickZoom},e.prototype._loadResources=function(){var t=kt(this.getSymbol());t.length>0&&this._drawToolLayer._getRenderer().loadResources(t)},e.prototype._getProjection=function(){return this._map.getProjection()},e.prototype._getRegisterMode=function(){var t=this.getMode(),r=e.getRegisterMode(t);if(!r)throw new Error(t+" is not a valid mode of DrawTool.");return r},e.prototype.getEvents=function(){var t=this._getRegisterMode().action,e={};if(Array.isArray(t)){for(var r=0;r<t.length;r++)e[t[r]]=this._events[t[r]];return e}return null},e.prototype._mouseDownHandler=function(t){this._createGeometry(t)},e.prototype._mouseUpHandler=function(t){this.endDraw(t)},e.prototype._firstClickHandler=function(t){var e=this._getRegisterMode(),r=t.coordinate;this._geometry?(y(this._historyPointer)||(this._clickCoords=this._clickCoords.slice(0,this._historyPointer)),this._clickCoords.push(r),this._historyPointer=this._clickCoords.length,e.clickLimit&&e.clickLimit===this._historyPointer?(e.update([r],this._geometry,t),this.endDraw(t)):e.update(this._clickCoords,this._geometry,t),this._fireEvent("drawvertex",t)):this._createGeometry(t)},e.prototype._createGeometry=function(t){var e=this.getMode(),r=this._getRegisterMode(),n=t.coordinate,i=this.getSymbol();this._geometry||(this._clickCoords=[n],this._geometry=r.create(this._clickCoords,t),i&&"point"!==e?this._geometry.setSymbol(i):this.options.hasOwnProperty("symbol")&&this._geometry.setSymbol(this.options.symbol),this._addGeometryToStage(this._geometry),this._fireEvent("drawstart",t)),"point"===e&&this.endDraw(t)},e.prototype._mouseMoveHandler=function(t){var e=this.getMap(),r=t.coordinate;if(this._geometry&&e&&!e.isInteracting()){var n=this._getMouseContainerPoint(t);if(this._isValidContainerPoint(n)){var i=this._getRegisterMode();if(this._shouldRecordHistory(i.action)){var o=this._clickCoords.slice(0,this._historyPointer);if(o&&o.length>0&&r.equals(o[o.length-1]))return;null!==this._historyPointer&&(this._clickCoords=this._clickCoords.slice(0,this._historyPointer)),this._historyPointer=this._clickCoords.length,i.update(o.concat([r]),this._geometry,t)}else i.update([r],this._geometry,t);this._fireEvent("mousemove",t)}}},e.prototype._doubleClickHandler=function(t){if(this._geometry){var e=this._getMouseContainerPoint(t);if(this._isValidContainerPoint(e)){var r=this._getRegisterMode(),n=this._clickCoords;if(!(n.length<2)){for(var i=[n[0]],o=1,a=n.length;o<a;o++)n[o].x===n[o-1].x&&n[o].y===n[o-1].y||i.push(n[o]);i.length<2||this._geometry&&this._geometry instanceof Vn&&i.length<3||(r.update(i,this._geometry,t),this.endDraw(t))}}}},e.prototype._addGeometryToStage=function(t){this._getDrawLayer().addGeometry(t)},e.prototype.endDraw=function(t){if(!this._geometry||this._ending)return this;this._ending=!0;var e=this._geometry;return this._clearStage(),t=t||{},this._geometry=e,this._fireEvent("drawend",t),delete this._geometry,this.options.once&&this.disable(),delete this._ending,this},e.prototype._clearStage=function(){this._getDrawLayer().clear(),delete this._geometry,delete this._clickCoords},e.prototype._getMouseContainerPoint=function(t){return"mousedown"===this._getRegisterMode().action&&He(t.domEvent),t.containerPoint},e.prototype._isValidContainerPoint=function(t){var e=this._map.getSize(),r=e.width,n=e.height;return!(t.x<0||t.y<0)&&!(t.x>r||t.y>n)},e.prototype._getDrawLayer=function(){var t=o+"drawtool",e=this._map.getLayer(t);return e||(e=new Ti(t,{enableSimplify:!1}),this._map.addLayer(e)),e},e.prototype._fireEvent=function(t,e){e||(e={}),this._geometry&&(e.geometry=this._getRegisterMode().generate(this._geometry).copy()),Ci.prototype._fireEvent.call(this,t,e)},e}(Ci);Ai.mergeOptions({symbol:{lineColor:"#000",lineWidth:2,lineOpacity:1,polygonFill:"#fff",polygonOpacity:.3},doubleClickZoom:!1,mode:null,once:!1,ignoreMouseleave:!0});var Mi=function(t){function e(r){d(this,e);var n=m(this,t.call(this,r));return n.drawTool=new Ai({mode:"boxZoom",ignoreMouseleave:!1}),n}return p(e,t),e.prototype.addHooks=function(){this.target.on("_mousedown",this._onMouseDown,this)},e.prototype.removeHooks=function(){this.target.off("_mousedown",this._onMouseDown,this),this.drawTool.isEnabled()&&this.drawTool.remove()},e.prototype._onMouseDown=function(t){this.target.options.boxZoom&&t.domEvent.shiftKey&&this.drawTool.setSymbol(this.target.options.boxZoomSymbol).on("drawend",this._boxZoom,this).addTo(this.target)},e.prototype._boxZoom=function(t){var e=this.target;this.drawTool.remove();var r=t.geometry,n=r.getCenter(),i=r.getSymbol(),o=i.markerWidth,a=i.markerHeight,s=new Er(n,e.locateByPoint(n,o,a),e.getProjection()),h=e.getFitZoom(s);e.animateTo({center:s.getCenter(),zoom:h})},e}(dr);on.mergeOptions({boxZoom:!0,boxZoomSymbol:{markerType:"rectangle",markerLineWidth:3,markerLineColor:"#1bbc9b",markerLineDasharray:[10,5],markerFillOpacity:.1,markerFill:"#1bbc9b",markerWidth:1,markerHeight:1}}),on.addOnLoadHook("addHandler","boxZoom",Mi),on.include({animateTo:function(t){var e=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments[2];this._stopAnim(this._animPlayer),T(r)&&(n=r,r={});var i=this.getProjection(),o=this.getView(),a={},s=!0;for(var h in t)if(C(t,h)&&!y(o[h]))if(s=!1,"center"===h){var u=new br(o[h]).toFixed(7),l=new br(t[h]).toFixed(7);u.equals(l)||(a.center=[u,l])}else o[h]!==t[h]&&"around"!==h&&(a[h]=[o[h],t[h]]);if(s)return null;var c=t.around||new ce(this.width/2,this.height/2),f=this.getView(),d=this._getRenderer(),p=this._animPlayer=Un.animate(a,{easing:r.easing||"out",duration:r.duration||this.options.zoomAnimationDuration,framer:function(t){d.callInNextFrame(t)}},function(t){if(e.isRemoved())p.finish();else{if("running"===p.playState){var o=e.getView();if(!r.continueOnViewChanged&&!function(t,e){for(var r in t)if(C(t,r))if("center"===r){if(t[r][0]!==e[r][0]||t[r][1]!==e[r][1])return!1}else if(t[r]!==e[r])return!1;return!0}(o,f))return void e._stopAnim(p);if(t.styles.center){var s=t.styles.center;e._setPrjCenter(i.project(s)),e.onMoving(e._parseEventFromCoord(e.getCenter()))}y(t.styles.zoom)||e.onZooming(t.styles.zoom,c),y(t.styles.pitch)||e.setPitch(t.styles.pitch),y(t.styles.bearing)||e.setBearing(t.styles.bearing),f=e.getView(),e._fireEvent("animating")}else"finished"===p.playState&&(p._interupted||(a.center&&e._setPrjCenter(i.project(a.center[1])),y(a.pitch)||e.setPitch(a.pitch[1]),y(a.bearing)||e.setBearing(a.bearing[1])),e._endAnim(p,a,c,r),f=e.getView());n&&n(t)}});return this._startAnim(a,c),p},isAnimating:function(){return!!this._animPlayer},isRotating:function(){return this.isDragRotating()||!!this._animRotating},_endAnim:function(t,e,r,n){delete this._animRotating;var i=t._interupted?"animateinterupted":"animateend";if(t===this._animPlayer&&delete this._animPlayer,e.center){var o=void 0;o=t._interupted?this.getCenter():e.center[1],this.onMoveEnd(this._parseEventFromCoord(o))}y(e.zoom)||(t._interupted?this.onZoomEnd(this.getZoom(),r):n.wheelZoom?this.onZooming(e.zoom[1],r):this.onZoomEnd(e.zoom[1],r)),i&&this._fireEvent(i)},_startAnim:function(t,e){this._animPlayer&&(t.center&&this.onMoveStart(),t.zoom&&!this.isZooming()&&this.onZoomStart(t.zoom[1],e),(t.pitch||t.bearing)&&(this._animRotating=!0),this._fireEvent("animatestart"),this._animPlayer.play())},_stopAnim:function(t){t&&"finished"!==t.playState&&(t._interupted=!0,t.finish())}});var Pi="mousedown mouseup mouseover mouseout mouseenter mouseleave mousemove click dblclick contextmenu keypress touchstart touchmove touchend ";function Ri(t,e,r){var n,i,o,a,s,h,u,l,c,f,d,p,m=r[0],g=r[1],_=r[2];return e===t?(t[12]=e[0]*m+e[4]*g+e[8]*_+e[12],t[13]=e[1]*m+e[5]*g+e[9]*_+e[13],t[14]=e[2]*m+e[6]*g+e[10]*_+e[14],t[15]=e[3]*m+e[7]*g+e[11]*_+e[15]):(n=e[0],i=e[1],o=e[2],a=e[3],s=e[4],h=e[5],u=e[6],l=e[7],c=e[8],f=e[9],d=e[10],p=e[11],t[0]=n,t[1]=i,t[2]=o,t[3]=a,t[4]=s,t[5]=h,t[6]=u,t[7]=l,t[8]=c,t[9]=f,t[10]=d,t[11]=p,t[12]=n*m+s*g+c*_+e[12],t[13]=i*m+h*g+f*_+e[13],t[14]=o*m+u*g+d*_+e[14],t[15]=a*m+l*g+p*_+e[15]),t}function Li(t,e,r){var n=r[0],i=r[1],o=r[2];return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*i,t[5]=e[5]*i,t[6]=e[6]*i,t[7]=e[7]*i,t[8]=e[8]*o,t[9]=e[9]*o,t[10]=e[10]*o,t[11]=e[11]*o,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function Oi(t,e,r){var n=e[0],i=e[1],o=e[2],a=e[3],s=e[4],h=e[5],u=e[6],l=e[7],c=e[8],f=e[9],d=e[10],p=e[11],m=e[12],g=e[13],_=e[14],y=e[15],v=r[0],x=r[1],b=r[2],w=r[3];return t[0]=v*n+x*s+b*c+w*m,t[1]=v*i+x*h+b*f+w*g,t[2]=v*o+x*u+b*d+w*_,t[3]=v*a+x*l+b*p+w*y,v=r[4],x=r[5],b=r[6],w=r[7],t[4]=v*n+x*s+b*c+w*m,t[5]=v*i+x*h+b*f+w*g,t[6]=v*o+x*u+b*d+w*_,t[7]=v*a+x*l+b*p+w*y,v=r[8],x=r[9],b=r[10],w=r[11],t[8]=v*n+x*s+b*c+w*m,t[9]=v*i+x*h+b*f+w*g,t[10]=v*o+x*u+b*d+w*_,t[11]=v*a+x*l+b*p+w*y,v=r[12],x=r[13],b=r[14],w=r[15],t[12]=v*n+x*s+b*c+w*m,t[13]=v*i+x*h+b*f+w*g,t[14]=v*o+x*u+b*d+w*_,t[15]=v*a+x*l+b*p+w*y,t}function ki(t,e){var r=e[0],n=e[1],i=e[2],o=e[3],a=e[4],s=e[5],h=e[6],u=e[7],l=e[8],c=e[9],f=e[10],d=e[11],p=e[12],m=e[13],g=e[14],_=e[15],y=r*s-n*a,v=r*h-i*a,x=r*u-o*a,b=n*h-i*s,w=n*u-o*s,T=i*u-o*h,E=l*m-c*p,C=l*g-f*p,S=l*_-d*p,A=c*g-f*m,M=c*_-d*m,P=f*_-d*g,R=y*P-v*M+x*A+b*S-w*C+T*E;return R?(R=1/R,t[0]=(s*P-h*M+u*A)*R,t[1]=(i*M-n*P-o*A)*R,t[2]=(m*T-g*w+_*b)*R,t[3]=(f*w-c*T-d*b)*R,t[4]=(h*S-a*P-u*C)*R,t[5]=(r*P-i*S+o*C)*R,t[6]=(g*x-p*T-_*v)*R,t[7]=(l*T-f*x+d*v)*R,t[8]=(a*M-s*S+u*E)*R,t[9]=(n*S-r*M-o*E)*R,t[10]=(p*w-m*x+_*y)*R,t[11]=(c*x-l*w-d*y)*R,t[12]=(s*C-a*A-h*E)*R,t[13]=(r*A-n*C+i*E)*R,t[14]=(m*v-p*b-g*y)*R,t[15]=(l*b-c*v+f*y)*R,t):null}function Di(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function Ii(t,e,r,n){return t[0]=e,t[1]=r,t[2]=n,t}function Ni(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t}function Fi(t){var e=t[0],r=t[1],n=t[2];return Math.sqrt(e*e+r*r+n*n)}function Bi(t,e){var r=e[0],n=e[1],i=e[2],o=r*r+n*n+i*i;return o>0&&(o=1/Math.sqrt(o),t[0]=e[0]*o,t[1]=e[1]*o,t[2]=e[2]*o),t}function zi(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function Ui(t,e,r){var n=e[0],i=e[1],o=e[2],a=r[0],s=r[1],h=r[2];return t[0]=i*h-o*s,t[1]=o*a-n*h,t[2]=n*s-i*a,t}function Hi(t,e,r){var n=e[0],i=e[1],o=e[2],a=1/(r[3]*n+r[7]*i+r[11]*o+r[15]);return t[0]=(r[0]*n+r[4]*i+r[8]*o+r[12])*a,t[1]=(r[1]*n+r[5]*i+r[9]*o+r[13])*a,t[2]=(r[2]*n+r[6]*i+r[10]*o+r[14])*a,t}on.include({_registerDomEvents:function(){Fe(this._panels.mapWrapper||this._containerDOM,Pi,this._handleDOMEvent,this)},_removeDomEvents:function(){Be(this._panels.mapWrapper||this._containerDOM,Pi,this._handleDOMEvent)},_handleDOMEvent:function(t){var e=t.type;if("contextmenu"===e&&Ue(t),!this._ignoreEvent(t)){var r=!1;if("mousedown"===e||"touchstart"===e&&1===t.touches.length)this._mouseDownTime=g();else if("click"===e||"touchend"===e||"contextmenu"===e){if(!this._mouseDownTime)return;var n=this._mouseDownTime;if(delete this._mouseDownTime,g()-n>300){if("click"===e||"contextmenu"===e)return}else"touchend"===e&&(r=!0)}this._fireDOMEvent(this,t,e),r&&(this._clickTime&&g()-this._clickTime<=300?(delete this._clickTime,this._fireDOMEvent(this,t,"dblclick")):(this._clickTime=g(),this._fireDOMEvent(this,t,"click")))}},_ignoreEvent:function(t){if(!t||!this._panels.control)return!1;if(this._isEventOutMap(t))return!0;var e=t.srcElement||t.target,r=void 0;if(e)for(;e&&e!==this._containerDOM;){if(e.className&&e.className.indexOf&&(e.className.indexOf("maptalks-control")>=0||e.className.indexOf("maptalks-ui")>=0&&!r.eventsPropagation))return!0;r=e,e=e.parentNode}return!1},_isEventOutMap:function(t){if(this.getPitch()>this.options.maxVisualPitch){var e=We(this._getActualEvent(t),this._containerDOM);if(!this.getContainerExtent().contains(e))return!0}return!1},_parseEvent:function(t,e){if(!t)return null;var r={domEvent:t};if("keypress"!==e){var n=this._getActualEvent(t);if(n){var i=We(n,this._containerDOM);r=_(r,{coordinate:this.containerPointToCoord(i),containerPoint:i,viewPoint:this.containerPointToViewPoint(i),point2d:this._containerPointToPoint(i)})}}return r},_parseEventFromCoord:function(t){var e=this.coordToContainerPoint(t);return{coordinate:t,containerPoint:e,viewPoint:this.containerPointToViewPoint(e),point2d:this.coordToPoint(t)}},_getActualEvent:function(t){return t.touches&&t.touches.length>0?t.touches[0]:t.changedTouches&&t.changedTouches.length>0?t.changedTouches[0]:t},_fireDOMEvent:function(t,e,r){if(!this.isRemoved()){var n=this._parseEvent(e,r);this._fireEvent(r,n)}}}),on.addOnLoadHook("_registerDomEvents"),on.include({isFullScreen:function(){return!!(document.webkitIsFullScreen||document.mozFullScreen||document.msFullscreenElement||document.fullscreenElement)},requestFullScreen:function(t){return this._fireEvent("fullscreenstart"),this._requestFullScreen(t||this._containerDOM),this._fireEvent("fullscreenend"),this},cancelFullScreen:function(){return this._cancelFullScreen(),this._fireEvent("cancelfullscreen"),this},_requestFullScreen:function(t){if(t.requestFullScreen)t.requestFullScreen();else if(t.mozRequestFullScreen)t.mozRequestFullScreen();else if(t.webkitRequestFullScreen)t.webkitRequestFullScreen();else if(t.msRequestFullScreen)t.msRequestFullScreen();else{var e="fullscreen=1,status=no,resizable=yes,top=0,left=0,scrollbars=no,titlebar=no,menubar=no,location=no,toolbar=no,z-look=yes,width="+(screen.availWidth-8)+",height="+(screen.availHeight-45);null!==window.open(location.href,"_blank",e)&&(window.opener=null,window.close())}},_cancelFullScreen:function(){if(document.cancelFullScreen)document.cancelFullScreen();else if(document.mozCancelFullScreen)document.mozCancelFullScreen();else if(document.webkitCancelFullScreen)document.webkitCancelFullScreen();else{null!==window.open(location.href,"_blank","fullscreen=no,status=yes,resizable=yes,scrollbars=no,titlebar=no,menubar=yes,location=yes,toolbar=yes,z-look=yes")&&(window.opener=null,window.close())}}}),on.include({panTo:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments[2];return t?(T(e)&&(r=e,e={}),t=new br(t),void 0===e.animation||e.animation?this._panAnimation(t,e.duration,r):(this.setCenter(t),this)):this},panBy:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments[2];if(!t)return this;if(T(e)&&(r=e,e={}),t=new ce(t).multi(-1),this.onMoveStart(),void 0===e.animation||e.animation){var n=this.locateByPoint(this.getCenter(),t.x,t.y);this._panAnimation(n,e.duration,r)}else this._offsetCenterByPixel(t),this.onMoveEnd(this._parseEventFromCoord(this.getCenter()));return this},_panAnimation:function(t,e,r){return this.animateTo({center:t},{duration:e||this.options.panAnimationDuration},r)}}),On.fromJSON=function(t){if(Array.isArray(t)){for(var e=[],r=0,n=t.length;r<n;r++){var i=On.fromJSON(t[r]);Array.isArray(t)?e=e.concat(i):e.push(i)}return e}if(t&&!t.feature)return ni.toGeometry(t);var o=void 0;return t.subType?(o=On.getJSONClass(t.subType).fromJSON(t),y(t.feature.id)||o.setId(t.feature.id)):(o=ni.toGeometry(t.feature),t.options&&o.config(t.options)),t.symbol&&o.setSymbol(t.symbol),t.infoWindow&&o.setInfoWindow(t.infoWindow),o},$r.fromJSON=function(t){if(!t)return null;var e=t.type,r=$r.getJSONClass(e);if(!r||!r.fromJSON)throw new Error("unsupported layer type:"+e);return r.fromJSON(t)},on.include({JSON_VERSION:"1.0",toJSON:function(t){t||(t={});var e={version:this.JSON_VERSION,extent:this.getExtent().toJSON()};e.options=this.config(),e.options.center=this.getCenter(),e.options.zoom=this.getZoom();var r=this.getBaseLayer();(y(t.baseLayer)||t.baseLayer)&&r&&(e.baseLayer=r.toJSON(t.baseLayer));var n={};t.clipExtent&&(!0===t.clipExtent?n.clipExtent=this.getExtent():n.clipExtent=t.clipExtent);var i=[];if(y(t.layers)||t.layers&&!Array.isArray(t.layers)){for(var o=this.getLayers(),a=0,s=o.length;a<s;a++)if(o[a].toJSON){var h=_({},b(t.layers)?t.layers:{},n);i.push(o[a].toJSON(h))}e.layers=i}else if(X(t.layers)){for(var u=t.layers,l=0;l<u.length;l++){var c=u[l],f=this.getLayer(c.id);if(f.toJSON){var d=_({},c.options,n);i.push(f.toJSON(d))}}e.layers=i}else e.layers=[];return e}}),on.fromJSON=function(t,e,r){if(!t||!e)return null;r||(r={});var n=new on(t,e.options);if(y(r.baseLayer)||r.baseLayer){var i=$r.fromJSON(e.baseLayer);i&&n.setBaseLayer(i)}if(y(r.layers)||r.layers){for(var o=[],a=e.layers,s=0;s<a.length;s++){var h=$r.fromJSON(a[s]);o.push(h)}n.addLayer(o)}return n},on.include({computeLength:function(t,e){if(!this.getProjection())return null;var r=new br(t),n=new br(e);return r.equals(n)?0:this.getProjection().measureLength(r,n)},computeGeometryLength:function(t){return t._computeGeodesicLength(this.getProjection())},computeGeometryArea:function(t){return t._computeGeodesicArea(this.getProjection())},identify:function(t,e){if(!t)return this;var r=t.layers;if(!X(r))return this;for(var n=[],i=0,a=r.length;i<a;i++)w(r[i])?n.push(this.getLayer(r[i])):n.push(r[i]);for(var s=new br(t.coordinate),h=_({},t),u=[],l=n.length-1;l>=0&&!(t.count&&u.length>=t.count);l--){var c=n[l];if(c&&c.getMap()&&(t.includeInvisible||c.isVisible())&&(t.includeInternals||!(c.getId().indexOf(o)>=0))){var f=c.identify(s,h);f&&(Array.isArray(f)?B(u,f):u.push(f))}}return e.call(this,u),this}}),on.include({_zoom:function(t,e){this.options.zoomable&&!this.isZooming()&&(e=this._checkZoomOrigin(e),t=this._checkZoom(t),this.onZoomStart(t,e),this._frameZoom=this.getZoom(),this.onZoomEnd(t,e))},_zoomAnimation:function(t,e,r){this.options.zoomable&&!this.isZooming()&&(t=this._checkZoom(t),this.getZoom()!==t&&(e=this._checkZoomOrigin(e),this._startZoomAnim(t,e,r)))},_checkZoomOrigin:function(t){return t&&!this.options.zoomInCenter||(t=new ce(this.width/2,this.height/2)),t},_startZoomAnim:function(t,e,r){y(r)&&(r=1);var n=this._getResolution(this._startZoomVal)/this._getResolution(t),i=this.options.zoomAnimationDuration*Math.abs(n-r)/Math.abs(n-1);this._frameZoom=this._startZoomVal,this.animateTo({zoom:t,around:e},{continueOnViewChanged:!0,duration:i})},onZoomStart:function(t,e){this.options.zoomable&&!this.isZooming()&&(this._zooming=!0,this._startZoomVal=this.getZoom(),this._startZoomCoord=this._containerPointToPrj(e),this._fireEvent("zoomstart",{from:this._startZoomVal,to:t}))},onZooming:function(t,e,r){if(this.options.zoomable&&this._frameZoom!==t){y(r)&&(r=1),this._zoomTo(t,e);var n=this.getResolution(t),i=this.getResolution(this._startZoomVal)/n/r,o=this._prjToContainerPoint(this._startZoomCoord,this._startZoomVal),a=this.getViewPoint();if(!this.isRotating()&&!o.equals(e)&&1!==i){var s=this.getPitch(),h=o._sub(e)._multi(1/(1-i));s&&(h.y/=Math.cos(s*Math.PI/180)),e=e.add(h)}var u={view:[i,0,0,i,(e.x-a.x)*(1-i),(e.y-a.y)*(1-i)]};ue.retina&&(e=e.multi(2)),u.container=[i,0,0,i,e.x*(1-i),e.y*(1-i)],this._fireEvent("zooming",{from:this._startZoomVal,to:t,origin:e,matrix:u}),this._frameZoom=t}},onZoomEnd:function(t,e){if(this.options.zoomable){var r=this._startZoomVal;this._zoomTo(t,e),this._zooming=!1,this._getRenderer().onZoomEnd(),this._fireEvent("zoomend",{from:r,to:t}),this._verifyExtent(this.getCenter())||this.panTo(this.getMaxExtent().getCenter())}},_zoomTo:function(t,e){this._zoomLevel=t,this._calcMatrices(),e&&this._setPrjCoordAtContainerPoint(this._startZoomCoord,e)},_checkZoom:function(t){var e=this.getMaxZoom(),r=this.getMinZoom();return t<r&&(t=r),t>e&&(t=e),t}});var ji,Gi,Vi,Wi,Zi,Xi,qi,Yi,Ji,Ki,Qi,$i,to,eo=Math.PI/180;function ro(){return Di(new Array(16))}on.include({getFov:function(){return this._fov||(this._fov=.6435011087932844),this._fov/eo},setFov:function(t){if(this.isZooming())return this;if(t=Math.max(.01,Math.min(60,t)),this._fov===t)return this;var e=this.getFov();return this._fov=t*eo,this._calcMatrices(),this._renderLayers(),this._fireEvent("fovchange",{from:e,to:this.getFov()}),this},getBearing:function(){return this._angle?-this._angle/eo:0},setBearing:function(t){if(ue.ie9)throw new Error("map can't rotate in IE9.");var e=-W(t,-180,180)*eo;if(this._angle===e)return this;var r=this.getBearing();return this._fireEvent("rotatestart",{from:r,to:e}),this._angle=e,this._calcMatrices(),this._renderLayers(),this._fireEvent("rotate",{from:r,to:e}),this._fireEvent("rotateend",{from:r,to:e}),this},getPitch:function(){return this._pitch?this._pitch/Math.PI*180:0},setPitch:function(t){if(ue.ie9)throw new Error("map can't tilt in IE9.");var e=Z(t,0,this.options.maxPitch)*eo;if(this._pitch===e)return this;var r=this.getPitch();return this._fireEvent("pitchstart",{from:r,to:e}),this._pitch=e,this._calcMatrices(),this._renderLayers(),this._fireEvent("pitch",{from:r,to:e}),this._fireEvent("pitchend",{from:r,to:e}),this},isTransforming:function(){return!(!this._pitch&&!this._angle)},getFrustumAltitude:function(){var t=90-this.getPitch(),e=this.getFov()/2,r=this.cameraPosition?this.cameraPosition[2]:0;if(e<=t)return r;e=Math.PI*e/180;var n=new ce(this.cameraPosition).distanceTo(new ce(this.cameraLookAt)),i=r*Math.tan(2*e);return r+Math.tan(e)*(n+i)},_pointToContainerPoint:(to=[0,0,0],function(t,e){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(t=this._pointToPoint(t,e),this.isTransforming()||r){r*=this.getResolution(e)/this.getResolution();var n=this._glScale;Ii(to,t.x*n,t.y*n,r*n);var i=this._projIfBehindCamera(to,this.cameraPosition,this.cameraForward);Hi(i,i,this.projViewMatrix);var o=this.width/2,a=this.height/2;return i[0]=i[0]*o+o,i[1]=-i[1]*a+a,new ce(i[0],i[1])}var s=this._prjToPoint(this._getPrjCenter());return t._sub(s)._add(this.width/2,this.height/2)}),_projIfBehindCamera:(Ji=new Array(3),Ki=new Array(3),Qi=new Array(3),$i=new Array(3),function(t,e,r){var n,i,o;if(Ni(Ji,t,e),zi(r,Bi(Ki,Ji))<=0){var a=zi(r,Ji);i=r,o=1.01*a,(n=Qi)[0]=i[0]*o,n[1]=i[1]*o,n[2]=i[2]*o,function(t,e,r){t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2]}(t,e,Ni($i,Ji,Qi))}return t}),_containerPointToPoint:(Xi=[0,0,0],qi=[0,0,0,1],Yi=[0,0,0,1],function(t,e){if(this.isTransforming()){var r=this.width/2||1,n=this.height/2||1;Ii(Xi,(t.x-r)/r,(n-t.y)/n,0),Ii(qi,Xi[0],Xi[1],0),Ii(Yi,Xi[0],Xi[1],1),qi[3]=Yi[3]=1,Hi(qi,qi,this.projViewMatrixInverse),Hi(Yi,Yi,this.projViewMatrixInverse);var i=qi[0],o=Yi[0],a=qi[1],s=Yi[1],h=qi[2],u=Yi[2],l=h===u?0:(0-h)/(u-h),c=new ce(V(i,o,l),V(a,s,l))._multi(1/this._glScale);return void 0===e||this.getZoom()===e?c:this._pointToPointAtZoom(c,e)}var f=this._prjToPoint(this._getPrjCenter(),e),d=void 0!==e?this._getResolution()/this._getResolution(e):1,p=d*(t.x-this.width/2),m=d*(t.y-this.height/2);return f._add(p,m)}),_calcMatrices:(Wi=ue.ie9?null:ro(),Zi=ue.ie9?null:ro(),function(){if(!ue.ie9){var t=this.getSize(),e=t.width||1,r=t.height||1;this._glScale=this.getGLScale();var n,i,o,a,s,h,u,l=this.getFov()*Math.PI/180,c=this.getScale(this.getMinZoom())/this.getScale(this.getMaxNativeZoom())*r/2/this._getFovRatio()*1.4,f=this.projMatrix||ro();n=f,i=l,o=e/r,a=.1,s=c,h=1/Math.tan(i/2),u=1/(a-s),n[0]=h/o,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=h,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=(s+a)*u,n[11]=-1,n[12]=0,n[13]=0,n[14]=2*s*a*u,n[15]=0,this.projMatrix=f;var d=this._getCameraWorldMatrix();this.viewMatrix=ki(Wi,d),this.projViewMatrix=Oi(this.projViewMatrix||ro(),f,this.viewMatrix),this.projViewMatrixInverse=Oi(this.projViewMatrixInverse||ro(),d,ki(Zi,f)),this.domCssMatrix=this._calcDomMatrix()}}),_calcDomMatrix:(ji=ue.ie9?null:ro(),Gi=[1,-1,1],Vi=[0,0,0],function(){var t,e,r,n,i,o,a,s,h,u,l,c,f,d=.5/Math.tan(this._fov/2)*this.height;Li(ji,this.projMatrix,Gi),Ri(ji,ji,Ii(Vi,0,0,-d)),this._pitch&&(t=ji,e=ji,r=this._pitch,n=Math.sin(r),i=Math.cos(r),o=e[4],a=e[5],s=e[6],h=e[7],u=e[8],l=e[9],c=e[10],f=e[11],e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=o*i+u*n,t[5]=a*i+l*n,t[6]=s*i+c*n,t[7]=h*i+f*n,t[8]=u*i-o*n,t[9]=l*i-a*n,t[10]=c*i-s*n,t[11]=f*i-h*n),this._angle&&function(t,e,r){var n=Math.sin(r),i=Math.cos(r),o=e[0],a=e[1],s=e[2],h=e[3],u=e[4],l=e[5],c=e[6],f=e[7];e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=o*i+u*n,t[1]=a*i+l*n,t[2]=s*i+c*n,t[3]=h*i+f*n,t[4]=u*i-o*n,t[5]=l*i-a*n,t[6]=c*i-s*n,t[7]=f*i-h*n}(ji,ji,this._angle);var p=ro();return Li(p,p,Ii(Vi,this.width/2,-this.height/2,1)),Oi(this.domCssMatrix||ro(),p,ji)}),_getCameraWorldMatrix:function(){var t={},e=[1,-1,1];return function(){var r=this.getGLZoom(),n=this.getSize(),i=this.getGLScale(),o=this._prjToPoint(this._prjCenter,r);this.cameraLookAt=Ii(this.cameraLookAt||[0,0,0],o.x,o.y,0);var a=this.getPitch()*eo,s=-this.getBearing()*eo,h=this._getFovRatio(),u=i*(n.height||1)/2/h,l=u*Math.cos(a),c=Math.sin(a)*u,f=o.x+c*Math.sin(s),d=o.y+c*Math.cos(s);this.cameraPosition=Ii(this.cameraPosition||[0,0,0],f,d,l);var p=c||1,m=this.cameraUp=Ii(this.cameraUp||[0,0,0],Math.sin(s)*p,Math.cos(s)*p,0),g=this.cameraWorldMatrix=this.cameraWorldMatrix||ro();!function(t,e,r,n){var i=[0,0,0],o=[0,0,0],a=[0,0,0];Ni(a,e,r),0===Fi(a)&&(a[2]=1),Bi(a,a),Ui(i,n,a),0===Fi(a)&&(1===Math.abs(n[2])?a[0]+=1e-4:a[2]+=1e-4,Bi(a,a),Ui(i,n,a)),Bi(i,i),Ui(o,a,i),t[0]=i[0],t[4]=o[0],t[8]=a[0],t[1]=i[1],t[5]=o[1],t[9]=a[1],t[2]=i[2],t[6]=o[2],t[10]=a[2]}(g,this.cameraPosition,this.cameraLookAt,m);var _,y,v,x=this.cameraForward||[0,0,0];return Ni(x,this.cameraLookAt,this.cameraPosition),this.cameraForward=Bi(x,x),function(t,e){var r=e[0],n=e[4],i=e[8],o=e[1],a=e[5],s=e[9],h=e[2],u=e[6],l=e[10],c=r+a+l,f=void 0;c>0?(f=.5/Math.sqrt(c+1),t.w=.25/f,t.x=(u-s)*f,t.y=(i-h)*f,t.z=(o-n)*f):r>a&&r>l?(f=2*Math.sqrt(1+r-a-l),t.w=(u-s)/f,t.x=.25*f,t.y=(n+o)/f,t.z=(i+h)/f):a>l?(f=2*Math.sqrt(1+a-r-l),t.w=(i-h)/f,t.x=(n+o)/f,t.y=.25*f,t.z=(s+u)/f):(f=2*Math.sqrt(1+l-r-a),t.w=(o-n)/f,t.x=(i+h)/f,t.y=(s+u)/f,t.z=.25*f)}(t,g),function(t,e){var r=t,n=e.x,i=e.y,o=e.z,a=e.w,s=n+n,h=i+i,u=o+o,l=n*s,c=n*h,f=n*u,d=i*h,p=i*u,m=o*u,g=a*s,_=a*h,y=a*u;r[0]=1-(d+m),r[4]=c-y,r[8]=f+_,r[1]=c+y,r[5]=1-(l+m),r[9]=p-g,r[2]=f-_,r[6]=p+g,r[10]=1-(l+d),r[3]=0,r[7]=0,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1}(g,t),_=g,y=this.cameraPosition,(v=_)[12]=y[0],v[13]=y[1],v[14]=y[2],Li(g,g,e),g}}(),_getFovRatio:function(){var t=this.getFov();return Math.tan(t/2*eo)},_renderLayers:function(){this.isInteracting()||this._getLayers().forEach(function(t){if(t){var e=t._getRenderer();e&&e.setToRedraw&&e.setToRedraw()}})}}),on.include({_onViewChange:function(t){this._viewHistory||(this._viewHistory=[],this._viewHistoryPointer=0);for(var e=this._getCurrentView(),r=this._viewHistory.length-1;r>=0;r--)if(it(t,this._viewHistory[r]))return this._viewHistoryPointer=r,void this._fireViewChange(e,t);this._viewHistoryPointer<this._viewHistory.length-1&&this._viewHistory.splice(this._viewHistoryPointer+1),this._viewHistory.push(t);var n=this.options.viewHistoryCount;n>0&&this._viewHistory.length>n&&this._viewHistory.splice(0,this._viewHistory.length-n),this._viewHistoryPointer=this._viewHistory.length-1,this._fireViewChange(e,t)},zoomToPreviousView:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!this.hasPreviousView())return null;var e=this._viewHistory[--this._viewHistoryPointer];return this._zoomToView(e,t),e},hasPreviousView:function(){return!(!this._viewHistory||0===this._viewHistoryPointer)},zoomToNextView:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!this.hasNextView())return null;var e=this._viewHistory[++this._viewHistoryPointer];return this._zoomToView(e,t),e},hasNextView:function(){return!(!this._viewHistory||this._viewHistoryPointer===this._viewHistory.length-1)},_zoomToView:function(t,e){var r=this,n=this.getView();e.animation?this.animateTo(t,{duration:e.duration},function(e){"finished"===e.state.playState&&r._fireViewChange(n,t)}):(this.setView(t),this._fireViewChange(n,t))},getViewHistory:function(){return this._viewHistory},_fireViewChange:function(t,e){this._fireEvent("viewchange",{old:t,new:e})},_getCurrentView:function(){return this._viewHistory?this._viewHistory[this._viewHistoryPointer]:null}}),on.mergeOptions({viewHistory:!0,viewHistoryCount:10});var no=function(t){function e(r){d(this,e);var n=m(this,t.call(this,r));return n.on("enable",n._afterEnable,n).on("disable",n._afterDisable,n),n._measureLayers=[],n}return p(e,t),e.prototype.clear=function(){if(X(this._measureLayers))for(var t=0;t<this._measureLayers.length;t++)this._measureLayers[t].remove();return delete this._lastMeasure,delete this._lastVertex,this._measureLayers=[],this},e.prototype.getMeasureLayers=function(){return this._measureLayers},e.prototype.getLastMeasure=function(){return this._lastMeasure?this._lastMeasure:0},e.prototype._measure=function(t){var e=this.getMap(),r=void 0;t instanceof On?r=e.computeGeometryLength(t):Array.isArray(t)&&(r=e.getProjection().measureLength(t)),this._lastMeasure=r;var n=void 0;n="zh-CN"===this.options.language?[" "," "," "," "]:[" m"," km"," feet"," mile"];var i="";return this.options.metric&&(i+=r<1e3?r.toFixed(0)+n[0]:(r/1e3).toFixed(2)+n[1]),this.options.imperial&&(r*=3.2808399,i.length>0&&(i+="\n"),i+=r<5280?r.toFixed(0)+n[2]:(r/5280).toFixed(2)+n[3]),i},e.prototype._registerMeasureEvents=function(){this.on("drawstart",this._msOnDrawStart,this).on("drawvertex",this._msOnDrawVertex,this).on("mousemove",this._msOnMouseMove,this).on("drawend",this._msOnDrawEnd,this)},e.prototype._afterEnable=function(){this._registerMeasureEvents()},e.prototype._afterDisable=function(){this.off("drawstart",this._msOnDrawStart,this).off("drawvertex",this._msOnDrawVertex,this).off("mousemove",this._msOnMouseMove,this).off("drawend",this._msOnDrawEnd,this)},e.prototype._msOnDrawStart=function(t){var e=this.getMap(),r=I(),n="distancetool_"+r,i="distancetool_markers_"+r;e.getLayer(n)?(this._measureLineLayer=e.getLayer(n),this._measureMarkerLayer=e.getLayer(i)):(this._measureLineLayer=new Ti(n).addTo(e),this._measureMarkerLayer=new Ti(i).addTo(e)),this._measureLayers.push(this._measureLineLayer),this._measureLayers.push(this._measureMarkerLayer),new Zn(t.coordinate,{symbol:this.options.vertexSymbol}).addTo(this._measureMarkerLayer);var o="zh-CN"===this.options.language?"":"start",a=new gi(o,t.coordinate,this.options.labelOptions);this._measureMarkerLayer.addGeometry(a)},e.prototype._msOnMouseMove=function(t){var e=this._measure(this._msGetCoordsToMeasure(t));if(!this._tailMarker){var r=zt(this.options.vertexSymbol);r.markerWidth/=2,r.markerHeight/=2,this._tailMarker=new Zn(t.coordinate,{symbol:r}).addTo(this._measureMarkerLayer),this._tailLabel=new gi(e,t.coordinate,this.options.labelOptions).addTo(this._measureMarkerLayer)}this._tailMarker.setCoordinates(t.coordinate),this._tailLabel.setContent(e),this._tailLabel.setCoordinates(t.coordinate)},e.prototype._msGetCoordsToMeasure=function(t){return t.geometry.getCoordinates().concat([t.coordinate])},e.prototype._msOnDrawVertex=function(t){var e=t.geometry;new Zn(t.coordinate,{symbol:this.options.vertexSymbol}).addTo(this._measureMarkerLayer);var r=this._measure(e),n=new gi(r,t.coordinate,this.options.labelOptions);this._measureMarkerLayer.addGeometry(n),this._lastVertex=n},e.prototype._msOnDrawEnd=function(t){this._clearTailMarker();var e=this._lastVertex.getSize();e||(e=new fe(10,10)),this._addClearMarker(this._lastVertex.getCoordinates(),e.width);var r=t.geometry.copy();r.addTo(this._measureLineLayer),this._lastMeasure=r.getLength()},e.prototype._addClearMarker=function(t,e){var r=this.options.clearButtonSymbol,n={markerDx:(r.markerDx||0)+e,textDx:(r.textDx||0)+e};Array.isArray(r)&&(n=r.map(function(t){return t?{markerDx:(t.markerDx||0)+e,textDx:(t.textDx||0)+e}:null})),r=zt(r,n);var i=new Zn(t,{symbol:r}),o=this._measureLineLayer,a=this._measureMarkerLayer;i.on("click",function(){return o.remove(),a.remove(),!1},this),i.addTo(this._measureMarkerLayer)},e.prototype._clearTailMarker=function(){this._tailMarker&&(this._tailMarker.remove(),delete this._tailMarker),this._tailLabel&&(this._tailLabel.remove(),delete this._tailLabel)},e}(Ai);no.mergeOptions({mode:"LineString",language:"zh-CN",metric:!0,imperial:!1,symbol:{lineColor:"#000",lineWidth:3,lineOpacity:1},vertexSymbol:{markerType:"ellipse",markerFill:"#fff",markerLineColor:"#000",markerLineWidth:3,markerWidth:11,markerHeight:11},labelOptions:{textSymbol:{textFaceName:"monospace",textLineSpacing:1,textHorizontalAlignment:"right",textDx:15},boxStyle:{padding:[6,2],symbol:{markerType:"square",markerFill:"#fff",markerFillOpacity:.9,markerLineColor:"#b4b3b3"}}},clearButtonSymbol:[{markerType:"square",markerFill:"#fff",markerLineColor:"#b4b3b3",markerLineWidth:2,markerWidth:15,markerHeight:15,markerDx:20},{markerType:"x",markerWidth:10,markerHeight:10,markerDx:20}]});var io=function(t){function e(r){d(this,e);var n=m(this,t.call(this,r));return n.on("enable",n._afterEnable,n).on("disable",n._afterDisable,n),n._measureLayers=[],n}return p(e,t),e.prototype._measure=function(t){var e=this.getMap(),r=void 0;t instanceof On?r=e.computeGeometryArea(t):Array.isArray(t)&&(r=e.getProjection().measureArea(t)),this._lastMeasure=r;var n=void 0;n="zh-CN"===this.options.language?[" "," "," "," "]:[" sq.m"," sq.km"," sq.ft"," sq.mi"];var i="";if(this.options.metric&&(i+=r<1e6?r.toFixed(0)+n[0]:(r/1e6).toFixed(2)+n[1]),this.options.imperial){r*=3.2808399,i.length>0&&(i+="\n");i+=r<27878400?r.toFixed(0)+n[2]:(r/27878400).toFixed(2)+n[3]}return i},e.prototype._msGetCoordsToMeasure=function(t){return t.geometry.getShell().concat([t.coordinate])},e.prototype._msOnDrawVertex=function(t){var e=new Zn(t.coordinate,{symbol:this.options.vertexSymbol}).addTo(this._measureMarkerLayer);this._measure(t.geometry),this._lastVertex=e},e.prototype._msOnDrawEnd=function(t){this._clearTailMarker();var e=this._measure(t.geometry),r=new gi(e,t.coordinate,this.options.labelOptions).addTo(this._measureMarkerLayer).getSize();r||(r=new fe(10,10)),this._addClearMarker(t.coordinate,r.width);var n=t.geometry.copy();n.addTo(this._measureLineLayer),this._lastMeasure=n.getArea()},e}(no);function oo(t){for(var e=t.tileInfo,r=[e.cols,e.rows],n=[],i=e.lods,o=0,a=i.length;o<a;o++)n.push(i[o].resolution);var s=t.fullExtent,h=e.origin,u=[1,-1,h.x,h.y];return delete s.spatialReference,{spatialReference:{resolutions:n,fullExtent:s},tileSystem:u,tileSize:r}}io.mergeOptions({mode:"Polygon",symbol:{lineColor:"#000000",lineWidth:2,lineOpacity:1,lineDasharray:"",polygonFill:"#ffffff",polygonOpacity:.5}}),Ai.registerMode("circle",{clickLimit:2,action:["click","mousemove","click"],create:function(t){return new ii(t[0],0)},update:function(t,e){var r=e.getMap().computeLength(e.getCenter(),t[t.length-1]);e.setRadius(r)},generate:function(t){return t}}),Ai.registerMode("freeHandCircle",{action:["mousedown","mousemove","mouseup"],create:function(t){return new ii(t[0],0)},update:function(t,e){var r=e.getMap().computeLength(e.getCenter(),t[t.length-1]);e.setRadius(r)},generate:function(t){return t}}),Ai.registerMode("ellipse",{clickLimit:2,action:["click","mousemove","click"],create:function(t){return new oi(t[0],0,0)},update:function(t,e){var r=e.getMap(),n=e.getCenter(),i=r.computeLength(n,new br({x:t[t.length-1].x,y:n.y})),o=r.computeLength(n,new br({x:n.x,y:t[t.length-1].y}));e.setWidth(2*i),e.setHeight(2*o)},generate:function(t){return t}}),Ai.registerMode("freeHandEllipse",{action:["mousedown","mousemove","mouseup"],create:function(t){return new oi(t[0],0,0)},update:function(t,e){var r=e.getMap(),n=e.getCenter(),i=r.computeLength(n,new br({x:t[t.length-1].x,y:n.y})),o=r.computeLength(n,new br({x:n.x,y:t[t.length-1].y}));e.setWidth(2*i),e.setHeight(2*o)},generate:function(t){return t}}),Ai.registerMode("rectangle",{clickLimit:2,action:["click","mousemove","click"],create:function(t){var e=new Vn([]);return e._firstClick=t[0],e},update:function(t,e,r){var n=e.getMap(),i=r.containerPoint,o=n.coordToContainerPoint(e._firstClick),a=[[o.x,o.y],[i.x,o.y],[i.x,i.y],[o.x,i.y]];e.setCoordinates(a.map(function(t){return n.containerPointToCoord(new ce(t))}))},generate:function(t){return t}}),Ai.registerMode("freeHandRectangle",{action:["mousedown","mousemove","mouseup"],create:function(t){var e=new Vn([]);return e._firstClick=t[0],e},update:function(t,e){var r=e._firstClick,n=[[r.x,r.y],[t[0].x,r.y],[t[0].x,t[0].y],[r.x,t[0].y]];e.setCoordinates(n)},generate:function(t){return t}}),Ai.registerMode("point",{clickLimit:1,action:["click"],create:function(t){return new Zn(t[0])},generate:function(t){return t}}),Ai.registerMode("polygon",{action:["click","mousemove","dblclick"],create:function(t){return new qn(t)},update:function(t,e){var r=e.getSymbol();e.setCoordinates(t);var n=e.getLayer();if(n){var i=n.getGeometryById("polygon");if(!i&&t.length>=3){if(i=new Vn([t],{id:"polygon"}),r){var o=zt(r,{lineOpacity:0});i.setSymbol(o)}i.addTo(n)}i&&i.setCoordinates(t)}},generate:function(t){return new Vn(t.getCoordinates(),{symbol:t.getSymbol()})}}),Ai.registerMode("freeHandPolygon",{action:["mousedown","mousemove","mouseup"],create:function(t){return new qn(t)},update:function(t,e){var r=e.getCoordinates(),n=e.getSymbol();e.setCoordinates(r.concat(t));var i=e.getLayer();if(i){var o=i.getGeometryById("polygon");if(!o&&t.length>=3){if(o=new Vn([t],{id:"polygon"}),n){var a=zt(n,{lineOpacity:0});o.setSymbol(a)}o.addTo(i)}o&&o.setCoordinates(t)}},generate:function(t){return new Vn(t.getCoordinates(),{symbol:t.getSymbol()})}}),Ai.registerMode("linestring",{action:["click","mousemove","dblclick"],create:function(t){return new qn(t)},update:function(t,e){e.setCoordinates(t)},generate:function(t){return t}}),Ai.registerMode("freeHandLinestring",{action:["mousedown","mousemove","mouseup"],create:function(t){return new qn(t)},update:function(t,e){var r=e.getCoordinates();e.setCoordinates(r.concat(t))},generate:function(t){return t}}),Ai.registerMode("arccurve",{action:["click","mousemove","dblclick"],create:function(t){return new ui(t)},update:function(t,e){e.setCoordinates(t)},generate:function(t){return t}}),Ai.registerMode("quadbeziercurve",{action:["click","mousemove","dblclick"],create:function(t){return new ci(t)},update:function(t,e){e.setCoordinates(t)},generate:function(t){return t}}),Ai.registerMode("cubicbeziercurve",{action:["click","mousemove","dblclick"],create:function(t){return new li(t)},update:function(t,e){e.setCoordinates(t)},generate:function(t){return t}}),Ai.registerMode("boxZoom",{action:["mousedown","mousemove","mouseup"],create:function(t){var e=new Zn(t[0]);return e._firstClick=t[0],e},update:function(t,e,r){var n=e.getMap(),i=n.coordToContainerPoint(e._firstClick),o=r.containerPoint,a=n.containerPointToCoordinate(new br(Math.min(i.x,o.x),Math.min(i.y,o.y)));e.setCoordinates(a).updateSymbol({markerWidth:Math.abs(i.x-o.x),markerHeight:Math.abs(i.y-o.y)})},generate:function(t){return t}}),rn.loadArcgis=function(t,e){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{jsonp:!0};if(w(t)&&"{"!==t.substring(0,1))ir.getJSON(t,function(t,r){if(t)e(t);else{var n=oo(r);e(null,n)}},r);else{w(t)&&(t=F(t));var n=oo(t);e(null,n)}return this};var ao=function(t){function e(r){return d(this,e),m(this,t.call(this,r))}return p(e,t),e.prototype.addTo=function(t){return this._owner=t,this._switchEvents("on"),this.onAdd&&this.onAdd(),this.fire("add"),this},e.prototype.getMap=function(){return this._owner?this._owner.getBaseLayer?this._owner:this._owner.getMap():null},e.prototype.show=function(t){var e=this.getMap();if(!e)return this;this._mapEventsOn||this._switchMapEvents("on"),t=t||this._coordinate||this._owner.getCenter();var r=this.isVisible();this.fire("showstart");var n=this._getUIContainer();this._coordinate=t,this._removePrevDOM();var i=this.__uiDOM=this.buildOn(e);if(i.eventsPropagation=this.options.eventsPropagation,!i)return this.fire("showend"),this;this._measureSize(i),this._singleton()&&(e[this._uiDomKey()]=i),this._setPosition(),i.style[Oe]=null,n.appendChild(i);var o=this._getAnimation();if(r&&(o.ok=!1),o.ok&&(o.fade&&(i.style.opacity=0),o.scale)){if(this.getTransformOrigin){var a=this.getTransformOrigin();i.style[Le]=a}i.style[Re]=so(this._pos)+" scale(0)"}i.style.display="",this.options.eventsToStop&&er(i,this.options.eventsToStop,He),this.options.autoPan&&this._autoPan();var s=o.transition;return o.ok&&s&&(i.offsetHeight,s&&(i.style[Oe]=s),o.fade&&(i.style.opacity=1),o.scale&&(i.style[Re]=so(this._pos)+" scale(1)")),this.fire("showend"),this},e.prototype.hide=function(){if(!this.getDOM()||!this.getMap())return this;var t=this._getAnimation(),e=this.getDOM();return this.options.animationOnHide||(t.ok=!1),t.ok?(e.offsetHeight,e.style[Oe]=t.transition,setTimeout(function(){e.style.display="none"},this.options.animationDuration)):e.style.display="none",t.fade&&(e.style.opacity=0),t.scale&&(e.style[Re]=so(this._pos)+" scale(0)"),this.fire("hide"),this},e.prototype.isVisible=function(){var t=this.getDOM();return this.getMap()&&t&&t.parentNode&&"none"!==t.style.display},e.prototype.remove=function(){return delete this._mapEventsOn,this._owner?(this.hide(),this._switchEvents("off"),this.onRemove&&this.onRemove(),!this._singleton()&&this.__uiDOM&&this._removePrevDOM(),delete this._owner,this.fire("remove"),this):this},e.prototype.getSize=function(){return this._size?this._size.copy():null},e.prototype.getOwner=function(){return this._owner},e.prototype.getDOM=function(){return this.__uiDOM},e.prototype.getPosition=function(){if(!this.getMap())return null;var t=this._getViewPoint()._round();if(this.getOffset){var e=this.getOffset()._round();e&&t._add(e)}return t},e.prototype._getAnimation=function(){for(var t={fade:!1,scale:!1},e=this.options.animation?this.options.animation.split(","):[],r=0;r<e.length;r++){var n=de(e[r]);"fade"===n?t.fade=!0:"scale"===n&&(t.scale=!0)}var i=null;return t.fade&&(i="opacity "+this.options.animationDuration+"ms"),t.scale&&(i=i?i+",":"",i+=Re+" "+this.options.animationDuration+"ms"),t.transition=i,t.ok=null!==i,t},e.prototype._getViewPoint=function(){return this.getMap().coordToViewPoint(this._coordinate)._add(this.options.dx,this.options.dy)},e.prototype._autoPan=function(){var t=this.getMap(),e=this.getDOM();if(!t.isMoving()){var r=this._pos,n=t.getSize(),i=n.width,o=n.height,a=t.viewPointToContainerPoint(r),s=parseInt(e.clientWidth),h=parseInt(e.clientHeight),u=0,l=0;a.x<0?u=-(a.x-s/2):a.x+s-35>i&&(u=i-(a.x+3*s/2)),a.y<0?l=50-a.y:a.y>o&&(l=o-a.y-h-30),0===l&&0===u||t.panBy(new ce(u,l),{duration:this.options.autoPanDuration})}},e.prototype._measureSize=function(t){var e=this._getUIContainer();t.style.position="absolute",t.style.left="-99999px";var r=t.style.bottom?"bottom":"top";return t.style[r]="-99999px",t.style.display="",e.appendChild(t),this._size=new fe(t.clientWidth,t.clientHeight),t.style.display="none",t.style.left="0px",t.style[r]="0px",this._size},e.prototype._removePrevDOM=function(){this.onDomRemove&&this.onDomRemove();var t=this.options.eventsToStop;if(this._singleton()){var e=this.getMap(),r=this._uiDomKey();e[r]&&(t&&rr(e[r],t,He),Ne(e[r]),delete e[r]),delete this.__uiDOM}else this.__uiDOM&&(t&&rr(this.__uiDOM,t,He),Ne(this.__uiDOM),delete this.__uiDOM)},e.prototype._uiDomKey=function(){return"__ui_"+this._getClassName()},e.prototype._singleton=function(){return this.options.single},e.prototype._getUIContainer=function(){return this.getMap()._panels.ui},e.prototype._getClassName=function(){return"UIComponent"},e.prototype._switchMapEvents=function(t){var e=this.getMap();if(e){this._mapEventsOn="on"===t;var r=this._getDefaultEvents();if(this.getEvents&&_(r,this.getEvents()),r)for(var n in r)r.hasOwnProperty(n)&&e[t](n,r[n],this)}},e.prototype._switchEvents=function(t){this._switchMapEvents(t);var e=this._getOwnerEvents();if(this._owner)for(var r in e)e.hasOwnProperty(r)&&this._owner[t](r,e[r],this)},e.prototype._getDefaultEvents=function(){return{"zooming rotate pitch":this.onEvent,zoomend:this.onZoomEnd,moving:this.onMoving}},e.prototype._getOwnerEvents=function(){var t={};return this._owner&&this._owner instanceof On&&(t.positionchange=this.onGeometryPositionChange),this.getOwnerEvents&&_(t,this.getOwnerEvents()),t},e.prototype.onGeometryPositionChange=function(t){this._owner&&this.isVisible()&&this.show(t.target.getCenter())},e.prototype.onMoving=function(){this.isVisible()&&this.getMap().isTransforming()&&this._updatePosition()},e.prototype.onEvent=function(){this.isVisible()&&this._updatePosition()},e.prototype.onZoomEnd=function(){this.isVisible()&&this._setPosition()},e.prototype._updatePosition=function(){this.getMap()._getRenderer().callInNextFrame(this._setPosition.bind(this))},e.prototype._setPosition=function(){var t=this.getDOM(),e=this.getPosition();this._pos=e,t.style[Oe]=null,t.style[Re]=so(e)+" scale(1)"},e}(cr(pr));function so(t){return t?ue.any3d?"translate3d("+t.x+"px,"+t.y+"px, 0px)":"translate("+t.x+"px,"+t.y+"px)":""}ao.mergeOptions({eventsPropagation:!1,eventsToStop:null,dx:0,dy:0,autoPan:!1,autoPanDuration:600,single:!0,animation:"scale",animationOnHide:!0,animationDuration:500});var ho="mousedown mouseup mouseenter mouseover mouseout mousemove click dblclick contextmenu keypress touchstart touchmove touchend",uo=function(t){function e(r,n){d(this,e);var i=m(this,t.call(this,n));return i._markerCoord=new br(r),i}return p(e,t),e.prototype._getClassName=function(){return"UIMarker"},e.prototype.setCoordinates=function(t){return this._markerCoord=t,this.fire("positionchange"),this.isVisible()&&(this._coordinate=this._markerCoord,this._setPosition()),this},e.prototype.getCoordinates=function(){return this._markerCoord},e.prototype.setContent=function(t){var e=this.options.content;return this.options.content=t,this.fire("contentchange",{old:e,new:t}),this.isVisible()&&this.show(),this},e.prototype.getContent=function(){return this.options.content},e.prototype.onAdd=function(){this.show()},e.prototype.show=function(){return t.prototype.show.call(this,this._markerCoord)},e.prototype.flash=function(t,e,r,n){return at.call(this,t,e,r,n)},e.prototype.buildOn=function(){var t=void 0;return w(this.options.content)?(t=De("div")).innerHTML=this.options.content:t=this.options.content,this._registerDOMEvents(t),t},e.prototype.getOffset=function(){var t=this.getSize();return new ce(-t.width/2,-t.height/2)},e.prototype.getTransformOrigin=function(){return"center center"},e.prototype.onDomRemove=function(){var t=this.getDOM();this._removeDOMEvents(t)},e.prototype.isDragging=function(){return!!this.draggable&&this.draggable.isDragging()},e.prototype._registerDOMEvents=function(t){er(t,ho,this._onDomEvents,this)},e.prototype._onDomEvents=function(t){var e=this.getMap()._parseEvent(t,t.type);this.fire(t.type,e)},e.prototype._removeDOMEvents=function(t){rr(t,ho,this._onDomEvents,this)},e.prototype._getConnectPoints=function(){var t=this.getMap(),e=t.coordToContainerPoint(this.getCoordinates()),r=this.getSize(),n=r.width,i=r.height;return[t.containerPointToCoordinate(e.add(-n/2,0)),t.containerPointToCoordinate(e.add(n/2,0)),t.containerPointToCoordinate(e.add(0,i/2)),t.containerPointToCoordinate(e.add(0,-i/2))]},e}(_r(ao));uo.mergeOptions({eventsPropagation:!0,draggable:!1,single:!1,content:null});var lo=ue.touch?"touchstart mousedown":"mousedown",co=function(t){function e(r){return d(this,e),m(this,t.call(this,r))}return p(e,t),e.prototype.addHooks=function(){this.target.on(lo,this._startDrag,this)},e.prototype.removeHooks=function(){this.target.off(lo,this._startDrag,this)},e.prototype._startDrag=function(t){var e=t.domEvent;e.touches&&e.touches.length>1||2===e.button||this.isDragging()||(this.target.on("click",this._endDrag,this),this._lastCoord=t.coordinate,this._lastPoint=t.containerPoint,this._prepareDragHandler(),this._dragHandler.onMouseDown(t.domEvent),this.target.fire("dragstart",t))},e.prototype._prepareDragHandler=function(){this._dragHandler=new xr(this.target.getDOM(),{cancelOn:this._cancelOn.bind(this),ignoreMouseleave:!0}),this._dragHandler.on("mousedown",this._onMouseDown,this),this._dragHandler.on("dragging",this._dragging,this),this._dragHandler.on("mouseup",this._endDrag,this),this._dragHandler.enable()},e.prototype._cancelOn=function(t){var e=(t.srcElement||t.target).tagName.toLowerCase();return"button"===e||"input"===e||"select"===e||"option"===e||"textarea"===e},e.prototype._onMouseDown=function(t){He(t.domEvent)},e.prototype._dragging=function(t){var e=this.target,r=e.getMap()._parseEvent(t.domEvent),n=r.domEvent;if(!(n.touches&&n.touches.length>1))if(this._isDragging){var i=r.coordinate,o=r.containerPoint;this._lastCoord||(this._lastCoord=i),this._lastPoint||(this._lastPoint=o);var a=i.sub(this._lastCoord),s=o.sub(this._lastPoint);this._lastCoord=i,this._lastPoint=o,this.target.setCoordinates(this.target.getCoordinates().add(a)),r.coordOffset=a,r.pointOffset=s,e.fire("dragging",r)}else this._isDragging=!0},e.prototype._endDrag=function(t){var e=this.target,r=e.getMap();if(this._dragHandler&&(e.off("click",this._endDrag,this),this._dragHandler.disable(),delete this._dragHandler),delete this._lastCoord,delete this._lastPoint,this._isDragging=!1,r){var n=r._parseEvent(t.domEvent);e.fire("dragend",n)}},e.prototype.isDragging=function(){return!!this._isDragging},e}(dr);uo.addInitHook("addHandler","draggable",co);var fo=function(t){function e(){return d(this,e),m(this,t.apply(this,arguments))}return p(e,t),e.prototype._getClassName=function(){return"InfoWindow"},e.prototype.addTo=function(e){return e instanceof On&&(e.getInfoWindow()&&e.getInfoWindow()!==this&&e.removeInfoWindow(),e._infoWindow=this),t.prototype.addTo.call(this,e)},e.prototype.setContent=function(t){var e=this.options.content;return this.options.content=t,this.fire("contentchange",{old:e,new:t}),this.isVisible()&&this.show(this._coordinate),this},e.prototype.getContent=function(){return this.options.content},e.prototype.setTitle=function(t){var e=t;return this.options.title=t,this.fire("contentchange",{old:e,new:t}),this.isVisible()&&this.show(this._coordinate),this},e.prototype.getTitle=function(){return this.options.title},e.prototype.buildOn=function(){if(this.options.custom){if(w(this.options.content)){var t=De("div");return t.innerHTML=this.options.content,t}return this.options.content}var e=De("div");e.className="maptalks-msgBox",e.style.width=this._getWindowWidth()+"px",e.style.bottom="0px";var r='<em class="maptalks-ico"></em>';this.options.title&&(r+="<h2>"+this.options.title+"</h2>");var n="\"this.parentNode.style.display='none';return false;\"";return r+='<a href="javascript:void(0);" onclick='+n+" ontouchend="+n+' class="maptalks-close"></a><div class="maptalks-msgContent">'+this.options.content+"</div>",e.innerHTML=r,e},e.prototype.getTransformOrigin=function(){return this.getSize().width/2+"px bottom"},e.prototype.getOffset=function(){var t=this.getSize(),e=new ce(-t.width/2,0);this.options.custom||e._sub(4,12);var r=this.getOwner();if(r instanceof Zn){var n=r._getPainter();if(n){var i=r.getSize(),o=n.getFixedExtent();e._add(o.xmax-i.width/2,o.ymin)}}return e},e.prototype.show=function(e){return this.getMap()&&this.getMap().options.enableInfoWindow?t.prototype.show.call(this,e):this},e.prototype.getEvents=function(){if(!this.options.autoCloseOn)return null;var t={};return t[this.options.autoCloseOn]=this.hide,t},e.prototype.getOwnerEvents=function(){var t=this.getOwner();if(!this.options.autoOpenOn||!t)return null;var e={};return e[this.options.autoOpenOn]=this._onAutoOpen,e},e.prototype._onAutoOpen=function(t){var e=this,r=this.getOwner();setTimeout(function(){r instanceof Zn?e.show(r.getCoordinates()):e.show(t.coordinate)},1)},e.prototype._getWindowWidth=function(){var t=this.options.width;return t||(t=300),t},e}(ao);fo.mergeOptions({autoPan:!0,autoCloseOn:null,autoOpenOn:"click",width:300,minHeight:120,custom:!1,title:null,content:null});var po={width:0,height:0,animation:"fade",cssName:"maptalks-tooltip",showTimeout:400},mo=function(t){function e(r){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};d(this,e);var i=m(this,t.call(this,n));return i._content=r,i}return p(e,t),e.prototype._getClassName=function(){return"ToolTip"},e.prototype.addTo=function(e){if(e instanceof On)return e.on("mousemove",this.onMouseMove,this),e.on("mouseout",this.onMouseOut,this),t.prototype.addTo.call(this,e);throw new Error("Invalid geometry the tooltip is added to.")},e.prototype.setStyle=function(t){return this.options.cssName=t,this},e.prototype.getStyle=function(){return this.options.cssName},e.prototype.getContent=function(){return this._content},e.prototype.buildOn=function(){var t=De("div");po.height&&(t.style.height=po.height+"px"),po.width&&(t.style.width=po.width+"px");var e=this.options.cssName;return!e&&po.height&&(t.style.lineHeight=po.height+"px"),t.innerHTML='<div class="'+e+'">'+this._content+"</div>",t},e.prototype.onMouseOut=function(){clearTimeout(this._timeout),this.isVisible()&&this._removePrevDOM()},e.prototype.onMouseMove=function(t){var e=this;clearTimeout(this._timeout);var r=this.getMap();if(r){var n=r.locateByPoint(t.coordinate,-5,25);0===this.options.showTimeout?this.show(n):this._timeout=setTimeout(function(){r&&e.show(n)},this.options.showTimeout)}},e.prototype.onRemove=function(){clearTimeout(this._timeout),this._owner&&(this._owner.off("mouseover",this.onMouseOver,this),this._owner.off("mouseout",this.onMouseOut,this))},e}(ao);mo.mergeOptions(po);var go=function(t){function e(r){return d(this,e),m(this,t.call(this,r))}return p(e,t),e.prototype._getClassName=function(){return"Menu"},e.prototype.addTo=function(t){return t._menu&&t._menu!==this&&t.removeMenu(),t._menu=this,ao.prototype.addTo.apply(this,arguments)},e.prototype.setItems=function(t){return this.options.items=t,this},e.prototype.getItems=function(){return this.options.items||[]},e.prototype.buildOn=function(){if(this.options.custom){if(w(this.options.items)){var t=De("div");return t.innerHTML=this.options.items,t}return this.options.items}var e=De("div");qe(e,"maptalks-menu"),e.style.width=this._getMenuWidth()+"px";var r=this._createMenuItemDom();return e.appendChild(r),er(e,"contextmenu",Ue),e},e.prototype.getOffset=function(){if(!this.getMap())return null;var t=this.getMap().getSize(),e=this.getMap().viewPointToContainerPoint(this._getViewPoint()),r=this.getSize(),n=0,i=0;return e.x+r.width>t.width&&(n=-r.width),e.y+r.height>t.height&&(i=-r.height),new ce(n,i)},e.prototype.getTransformOrigin=function(){var t=this.getOffset()._multi(-1);return t.x+"px "+t.y+"px"},e.prototype.getEvents=function(){return{"_zoomstart _zoomend _movestart _dblclick _click":this._removePrevDOM}},e.prototype._createMenuItemDom=function(){var t=this,e=this.getMap(),r=De("ul");qe(r,"maptalks-menu-items");var n=this.getItems();function i(r){return function(n){var i=e._parseEvent(n,"click");i.target=t,i.owner=t._owner,i.index=r,!1!==this._callback(i)&&t.hide()}}for(var o=void 0,a=void 0,s=0,h=n.length;s<h;s++){if("-"===(o=n[s])||"_"===o)qe(a=De("li"),"maptalks-menu-splitter");else{a=De("li");var u=o.item;T(u)&&(u=u({owner:this._owner,index:s})),a.innerHTML=u,a._callback=o.click,er(a,"click",i(s))}r.appendChild(a)}var l=this.options.maxHeight||0;return l>0&&Ze(r,"max-height: "+l+"px; overflow-y: auto;"),r},e.prototype._getMenuWidth=function(){return this.options.width||160},e}(ao);go.mergeOptions({animation:null,animationDelay:10,animationOnHide:!1,autoPan:!1,width:160,maxHeight:0,custom:!1,items:[]});var _o={setMenu:function(t){return this._menuOptions=t,this._menu?this._menu.setOptions(t):this.on("contextmenu",this._defaultOpenMenu,this),this},openMenu:function(t){var e=this instanceof on?this:this.getMap();return t||(t=this.getCenter()),this._menu?this._menu.show(t):this._menuOptions&&e&&(this._bindMenu(this._menuOptions),this._menu.show(t)),this},setMenuItems:function(t){return this._menuOptions||(this._menuOptions={}),Array.isArray(t)&&(this._menuOptions.custom=!1),this._menuOptions.items=t,this.setMenu(this._menuOptions),this},getMenuItems:function(){return this._menu?this._menu.getItems():this._menuOptions&&this._menuOptions.items||[]},closeMenu:function(){return this._menu&&this._menu.hide(),this},removeMenu:function(){return this.off("contextmenu",this._defaultOpenMenu,this),this._unbindMenu(),delete this._menuOptions,this},_bindMenu:function(t){return this._menu=new go(t),this._menu.addTo(this),this},_unbindMenu:function(){return this._menu&&(this.closeMenu(),this._menu.remove(),delete this._menu),this},_defaultOpenMenu:function(t){return this.listens("contextmenu")>1||(this.openMenu(t.coordinate),!1)}};on.include(_o),On.include(_o);var yo=Object.freeze({UIComponent:ao,UIMarker:uo,InfoWindow:fo,ToolTip:mo,Menuable:_o,Menu:go}),vo=function(t){function e(r){return d(this,e),r&&r.position&&!w(r.position)&&(r.position=_({},r.position)),m(this,t.call(this,r))}return p(e,t),e.prototype.addTo=function(t){if(this.remove(),!t.options.control)return this;this._map=t;var e=t._panels.control;return this.__ctrlContainer=De("div"),Ze(this.__ctrlContainer,"position:absolute;overflow:visible;"),this.update(),e.appendChild(this.__ctrlContainer),this.onAdd&&this.onAdd(),this.fire("add",{dom:e}),this},e.prototype.update=function(){return this.__ctrlContainer.innerHTML="",this._controlDom=this.buildOn(this.getMap()),this._controlDom&&(this._updatePosition(),this.__ctrlContainer.appendChild(this._controlDom)),this},e.prototype.getMap=function(){return this._map},e.prototype.getPosition=function(){return _({},this._parse(this.options.position))},e.prototype.setPosition=function(t){return w(t)?this.options.position=t:this.options.position=_({},t),this._updatePosition(),this},e.prototype.getContainerPoint=function(){var t=this.getPosition(),e=this.getMap().getSize(),r=void 0,n=void 0;return y(t.left)?y(t.right)||(r=e.width-parseInt(t.right)):r=parseInt(t.left),y(t.top)?y(t.bottom)||(n=e.height-parseInt(t.bottom)):n=parseInt(t.top),new ce(r,n)},e.prototype.getContainer=function(){return this.__ctrlContainer},e.prototype.getDOM=function(){return this._controlDom},e.prototype.show=function(){return this.__ctrlContainer.style.display="",this},e.prototype.hide=function(){return this.__ctrlContainer.style.display="none",this},e.prototype.isVisible=function(){return this.__ctrlContainer&&""===this.__ctrlContainer.style.display},e.prototype.remove=function(){return this._map?(Ne(this.__ctrlContainer),this.onRemove&&this.onRemove(),delete this._map,delete this.__ctrlContainer,delete this._controlDom,this.fire("remove"),this):this},e.prototype._parse=function(t){var r=t;return w(t)&&(r=e.positions[r]),r},e.prototype._updatePosition=function(){var t=this.getPosition();for(var e in t||(t={top:20,left:20}),t)t.hasOwnProperty(e)&&(t[e]=parseInt(t[e]),this.__ctrlContainer.style[e]=t[e]+"px");this.fire("positionchange",{position:_({},t)})},e}(cr(pr));vo.positions={"top-left":{top:20,left:20},"top-right":{top:20,right:20},"bottom-left":{bottom:20,left:20},"bottom-right":{bottom:20,right:20}},on.mergeOptions({control:!0}),on.include({addControl:function(t){return this._containerDOM.getContext?this:(t.addTo(this),this)},removeControl:function(t){return t&&t.getMap()===this?(t.remove(),this):this}});var xo="addlayer removelayer setbaselayer baselayerremove",bo=function(t){function e(){return d(this,e),m(this,t.apply(this,arguments))}return p(e,t),e.prototype.buildOn=function(){return this._attributionContainer=De("div"),this._attributionContainer.className="maptalks-attribution",this._update(),this._attributionContainer},e.prototype.onAdd=function(){this.getMap().on(xo,this._update,this)},e.prototype.onRemove=function(){this.getMap().off(xo,this._update,this)},e.prototype._update=function(){var t=this.getMap();if(t){var e=t._getLayers(function(t){return t.options.attribution}).reverse().map(function(t){return t.options.attribution}),r=this.options.content+(e.length>0?" - "+e.join(", "):"");this._attributionContainer.innerHTML='<span style="padding:0px 4px">'+r+"</span>"}},e}(vo);bo.mergeOptions({position:{bottom:0,left:0},content:'<a href="http://maptalks.org" target="_blank">maptalks</a>'}),on.mergeOptions({attribution:!0}),on.addOnLoadHook(function(){var t=this.options.attribution||this.options.attributionControl;t&&(this.attributionControl=new bo(t),this.addControl(this.attributionControl))});var wo=function(t){function e(){return d(this,e),m(this,t.apply(this,arguments))}return p(e,t),e.prototype.buildOn=function(){var t=this.container=De("div",this.options.containerClass),e=this.panel=De("div","panel"),r=this.button=De("button");return t.appendChild(r),t.appendChild(e),t},e.prototype.onAdd=function(){er(this.button,"mouseover",this._show,this),er(this.panel,"mouseleave",this._hide,this),er(this.getMap(),"click",this._hide,this)},e.prototype.onRemove=function(){this.panel&&(rr(this.button,"mouseover",this._show,this),rr(this.panel,"mouseleave",this._hide,this),rr(this.getMap(),"click",this._hide,this),Ne(this.panel),Ne(this.button),delete this.panel,delete this.button,delete this.container)},e.prototype._show=function(){Xe(this.container,"shown")||(qe(this.container,"shown"),this._createPanel())},e.prototype._hide=function(t){this.panel.contains(t.toElement||t.relatedTarget)||Ye(this.container,this.options.containerClass)},e.prototype._createPanel=function(){this.panel.innerHTML="";var t=De("ul");this.panel.appendChild(t),this._renderLayers(this.getMap(),t)},e.prototype._renderLayers=function(t,e){var r=t.getBaseLayer(),n=t.getLayers(),i=n.length;if(r){var o=r.layers||[r],a=De("li","group"),s=De("ul"),h=De("label");h.innerHTML=this.options.baseTitle,a.appendChild(h);for(var u=0,l=o.length;u<l;u++){var c=o[u];this._isExcluded(c)&&(s.appendChild(this._renderLayer(o[u],!0)),a.appendChild(s),e.appendChild(a))}}if(i){var f=De("li","group"),d=De("ul"),p=De("label");p.innerHTML=this.options.overlayTitle,f.appendChild(p);for(var m=0;m<i;m++){var g=n[m];this._isExcluded(g)&&d.appendChild(this._renderLayer(g))}f.appendChild(d),e.appendChild(f)}},e.prototype._isExcluded=function(t){var e=t.getId(),r=this.options.excludeLayers;return!(r.length&&r.indexOf(e)>=0)},e.prototype._renderLayer=function(t,e){var r=this,n=De("li","layer"),i=De("label"),o=De("input"),a=this.getMap(),s=t.options.visible;t.options.visible=!0;var h=t.isVisible();return t.options.visible=s,n.className="layer",e?(o.type="radio",o.name="base"):o.type="checkbox",o.checked=s&&h,h||o.setAttribute("disabled","disabled"),o.onchange=function(e){if("radio"===e.target.type){var n=a.getBaseLayer(),i=n.layers;if(i)for(var o=0,s=i.length;o<s;o++){var h=i[o];h[h===t?"show":"hide"]()}else n.isVisible()||n.show();a._fireEvent("setbaselayer")}else t[e.target.checked?"show":"hide"]();r.fire("layerchange",{target:t})},n.appendChild(o),i.innerHTML=t.getId(),n.appendChild(i),n},e}(vo);wo.mergeOptions({position:"top-right",baseTitle:"Base Layers",overlayTitle:"Layers",excludeLayers:[],containerClass:"maptalks-layer-switcher"}),on.mergeOptions({layerSwitcherControl:!1}),on.addOnLoadHook(function(){this.options.layerSwitcherControl&&(this.layerSwitcherControl=new wo(this.options.layerSwitcherControl),this.addControl(this.layerSwitcherControl))});var To=function(t){function e(){return d(this,e),m(this,t.apply(this,arguments))}return p(e,t),e.prototype.buildOn=function(){var t=this.options.size;this.options.maximize||(t=[0,0]);var e=De("div"),r=this.mapContainer=De("div");r.style.width=t[0]+"px",r.style.height=t[1]+"px",r.className=this.options.containerClass;var n=this.button=De("div");return n.className=this.options.buttonClass,e.appendChild(r),e.appendChild(n),e},e.prototype.onAdd=function(){this.options.maximize&&this._createOverview(),this.getMap().on("resize moving zooming rotate dragrotating viewchange",this._update,this).on("setbaselayer",this._updateBaseLayer,this).on("spatialreferencechange",this._updateSpatialReference,this),er(this.button,"click",this._onButtonClick,this),this._updateButtonText()},e.prototype.onRemove=function(){this.getMap().off("resize moving zooming rotate dragrotating viewchange",this._update,this).off("setbaselayer",this._updateBaseLayer,this).off("spatialreferencechange",this._updateSpatialReference,this),this._overview&&(this._overview.remove(),delete this._overview,delete this._perspective),rr(this.button,"click",this._onButtonClick,this)},e.prototype.maxmize=function(){var t=this.options.size,e=this.mapContainer;e.style.width=t[0]+"px",e.style.height=t[1]+"px",this._createOverview()},e.prototype.minimize=function(){this._overview&&this._overview.remove(),delete this._overview,delete this._perspective;var t=this.mapContainer;t.style.width="0px",t.style.height="0px"},e.prototype._onButtonClick=function(){this._overview?this.minimize():this.maxmize(),this._updateButtonText()},e.prototype._updateButtonText=function(){this._overview?this.button.innerHTML="-":this.button.innerHTML="+"},e.prototype._createOverview=function(){var t=this.getMap(),e=this.mapContainer,r=t.config();_(r,{center:t.getCenter(),zoom:this._getOverviewZoom(),zoomAnimationDuration:150,pitch:0,bearing:0,scrollWheelZoom:!1,checkSize:!1,doubleClickZoom:!1,touchZoom:!1,control:!1,draggable:!1,maxExtent:null}),this._overview=new on(e,r),this._updateBaseLayer(),this._perspective=new Vn(this._getPerspectiveCoords(),{draggable:!0,cursor:"move",symbol:this.options.symbol}).on("dragend",this._onDragEnd,this),new Ti("perspective_layer",this._perspective).addTo(this._overview),this.fire("load")},e.prototype._getOverviewZoom=function(){var t=this.getMap(),e=t.getZoom(),r=t.getMinZoom(),n=this.options.level;if(n>0){for(var i=n;i>0;i--)if(e-i>=r)return e-i}else for(var o=n;o<0;o++)if(e-o>=r)return e-o;return e},e.prototype._onDragEnd=function(){var t=this._perspective.getCenter();this._overview.setCenter(t),this.getMap().panTo(t)},e.prototype._getPerspectiveCoords=function(){var t=this.getMap();return t.getContainerExtent().toArray().map(function(e){return t.containerPointToCoordinate(e)})},e.prototype._update=function(){if(this._overview){var t=this._getPerspectiveCoords();this._perspective.setCoordinates(t),this._overview.setCenterAndZoom(this.getMap().getCenter(),this._getOverviewZoom())}},e.prototype._updateSpatialReference=function(){if(this._overview){var t=this.getMap().options.spatialReference;this._overview.setSpatialReference(t)}},e.prototype._updateBaseLayer=function(){if(this._overview){var t=this.getMap().getBaseLayer();if(t){var e=t.layers,r=0;if(e)for(var n=0,i=e.length;n<i;n++){if(e[n].isVisible()){r=n;break}}var o=t.toJSON(),a=null;e?(a=o.layers[r].options).visible=!0:a=o.options,this._overview.setMinZoom(a.minZoom||null).setMaxZoom(a.maxZoom||null),delete a.minZoom,delete a.maxZoom,delete o.options.canvas,o.options.visible=!0,o.options.renderer="canvas";var s=$r.fromJSON(o);for(var h in t)T(t[h])&&t.hasOwnProperty(h)&&t[h]!==t.constructor.prototype[h]&&(s[h]=t[h]);this._overview.setBaseLayer(s)}else this._overview.setBaseLayer(null)}},e}(vo);To.mergeOptions({level:4,position:{right:1,bottom:1},size:[300,200],maximize:!0,symbol:{lineWidth:3,lineColor:"#1bbc9b",polygonFill:"#1bbc9b",polygonOpacity:.4},containerClass:"maptalks-overview",buttonClass:"maptalks-overview-button"}),on.mergeOptions({overviewControl:!1}),on.addOnLoadHook(function(){this.options.overviewControl&&(this.overviewControl=new To(this.options.overviewControl),this.addControl(this.overviewControl))});var Eo=function(t){function e(){return d(this,e),m(this,t.apply(this,arguments))}return p(e,t),e.prototype.buildOn=function(){var t=void 0;if(this.options.custom)w(this.options.content)?(t=De("div")).innerHTML=this.options.content:t=this.options.content;else{if(t=De("div","maptalks-panel"),this.options.closeButton){var e=De("a","maptalks-close");e.href="javascript:;",e.onclick=function(){t.style.display="none"},t.appendChild(e)}var r=De("div","maptalks-panel-content");r.innerHTML=this.options.content,t.appendChild(r)}return this.draggable=new xr(t,{cancelOn:this._cancelOn.bind(this),ignoreMouseleave:!0}),this.draggable.on("dragstart",this._onDragStart,this).on("dragging",this._onDragging,this).on("dragend",this._onDragEnd,this),this.options.draggable&&this.draggable.enable(),t},e.prototype.update=function(){return this.draggable&&(this.draggable.disable(),delete this.draggable),vo.prototype.update.call(this)},e.prototype.setContent=function(t){var e=this.options.content;return this.options.content=t,this.fire("contentchange",{old:e,new:t}),this.isVisible()&&this.update(),this},e.prototype.getContent=function(){return this.options.content},e.prototype._cancelOn=function(t){var e=(t.srcElement||t.target).tagName.toLowerCase();return"button"===e||"input"===e||"select"===e||"option"===e||"textarea"===e},e.prototype._onDragStart=function(t){this._startPos=t.mousePos,this._startPosition=_({},this.getPosition()),this.fire("dragstart",t)},e.prototype._onDragging=function(t){var e=t.mousePos.sub(this._startPos),r=this._startPosition,n=this.getPosition();y(n.top)||(n.top=parseInt(r.top)+e.y),y(n.bottom)||(n.bottom=parseInt(r.bottom)-e.y),y(n.left)||(n.left=parseInt(r.left)+e.x),y(n.right)||(n.right=parseInt(r.right)-e.x),this.setPosition(n),this.fire("dragging",t)},e.prototype._onDragEnd=function(t){delete this._startPos,delete this._startPosition,this.fire("dragend",t)},e.prototype._getConnectPoints=function(){var t=this.getMap(),e=this.getContainerPoint(),r=this.getDOM(),n=parseInt(r.clientWidth),i=parseInt(r.clientHeight);return[t.containerPointToCoordinate(e.add(n/2,0)),t.containerPointToCoordinate(e.add(n,i/2)),t.containerPointToCoordinate(e.add(n/2,i)),t.containerPointToCoordinate(e.add(0,i/2))]},e}(vo);Eo.mergeOptions({position:"top-right",draggable:!0,custom:!1,content:"",closeButton:!0});var Co=function(t){function e(){return d(this,e),m(this,t.apply(this,arguments))}return p(e,t),e.prototype.buildOn=function(t){return this._map=t,this._scaleContainer=De("div"),this._addScales(),t.on("zoomend",this._update,this),this._map._loaded&&this._update(),this._scaleContainer},e.prototype.onRemove=function(){this.getMap().off("zoomend",this._update,this)},e.prototype._addScales=function(){var t="border: 2px solid #000000;border-top: none;line-height: 1.1;padding: 2px 5px 1px;color: #000000;font-size: 11px;text-align:center;white-space: nowrap;overflow: hidden;-moz-box-sizing: content-box;box-sizing: content-box;background: #fff; background: rgba(255, 255, 255, 0);";this.options.metric&&(this._mScale=Ie("div",t,this._scaleContainer)),this.options.imperial&&(this._iScale=Ie("div",t,this._scaleContainer))},e.prototype._update=function(){var t=this._map.pixelToDistance(this.options.maxWidth,0);this._updateScales(t)},e.prototype._updateScales=function(t){this.options.metric&&t&&this._updateMetric(t),this.options.imperial&&t&&this._updateImperial(t)},e.prototype._updateMetric=function(t){var e=this._getRoundNum(t),r=e<1e3?e+" m":e/1e3+" km";this._updateScale(this._mScale,r,e/t)},e.prototype._updateImperial=function(t){var e=3.2808399*t,r=void 0,n=void 0,i=void 0;e>5280?(r=e/5280,n=this._getRoundNum(r),this._updateScale(this._iScale,n+" mile",n/r)):(i=this._getRoundNum(e),this._updateScale(this._iScale,i+" feet",i/e))},e.prototype._updateScale=function(t,e,r){t.style.width=Math.round(this.options.maxWidth*r)+"px",t.innerHTML=e},e.prototype._getRoundNum=function(t){var e=Math.pow(10,(Math.floor(t)+"").length-1),r=t/e;return e*(r=r>=10?10:r>=5?5:r>=3?3:r>=2?2:1)},e}(vo);Co.mergeOptions({position:"bottom-left",maxWidth:100,metric:!0,imperial:!1}),on.mergeOptions({scaleControl:!1}),on.addOnLoadHook(function(){this.options.scaleControl&&(this.scaleControl=new Co(this.options.scaleControl),this.addControl(this.scaleControl))});var So=function(t){function e(){return d(this,e),m(this,t.apply(this,arguments))}return p(e,t),e.prototype.buildOn=function(t){this._map=t;var e=De("div"),r=De("ul","maptalks-toolbar-hx");e.appendChild(r),this.options.vertical?qe(e,"maptalks-toolbar-vertical"):qe(e,"maptalks-toolbar-horizonal");var n=this;function i(t,e,r,i){var o=n._getItems()[e];return function(n){return He(n),t({target:o,index:e,childIndex:r,dom:i})}}var o=this.options.items;if(X(o))for(var a=0,s=o.length;a<s;a++){var h=o[a],u=De("li");if(28!==this.options.height&&(u.style.lineHeight=this.options.height+"px"),u.style.height=this.options.height+"px",u.style.cursor="pointer",Qe(h.item)){u.style.textAlign="center";var l=$e("div",h.item);u.innerHTML='<div style="margin-top:'+(this.options.height-l.height)/2+'px;">'+h.item+"</div>"}else u.innerHTML=h.item;if(h.click&&er(u,"click",i(h.click,a,null,u)),X(h.children)){var c=this._createDropMenu(a);u.appendChild(c),u._menu=c,er(u,"mouseover",function(){this._menu.style.display=""}),er(u,"mouseout",function(){this._menu.style.display="none"})}r.appendChild(u)}return e},e.prototype._createDropMenu=function(t){var e=this;function r(t,r,n){var i=e._getItems()[r].children[n];return function(e){return He(e),t({target:i,index:r,childIndex:n})}}var n=De("div","maptalks-dropMenu"),i=this._getItems(),o=i.length,a=De("ul"),s=i[t].children;t===o-1&&s&&(n.style.cssText="right: 0px;",a.style.cssText="right: 0px;position: absolute;",this.options.reverseMenu&&(a.style.bottom=0)),n.appendChild(De("em","maptalks-ico"));for(var h=0,u=0,l=s.length;u<l;u++){var c=xe(s[u].item,"12px");c.width>h&&(h=c.width)}for(var f=0,d=s.length;f<d;f++){var p=s[f],m=De("li");m.innerHTML='<a href="javascript:;">'+p.item+"</a>",m.style.cursor="pointer",m.style.width=h+24+"px",er(m.childNodes[0],"click",r(p.click,t,f)),a.appendChild(m)}if(this.options.vertical){var g=h<95?95:h;this.options.reverseMenu?n.style.right=-(g+20)+"px":n.style.left=-(g+20)+"px"}else this.options.reverseMenu?n.style.bottom="28px":n.style.top="28px";return n.appendChild(a),n.style.display="none",n},e.prototype._getItems=function(){return this.options.items||[]},e}(vo);So.mergeOptions({height:28,vertical:!1,position:"top-right",reverseMenu:!1,items:{}});var Ao=function(t){function e(){return d(this,e),m(this,t.apply(this,arguments))}return p(e,t),e.prototype.buildOn=function(t){var e=this.options,r=De("div","maptalks-zoom");if(e.zoomLevel){var n=De("span","maptalks-zoom-zoomlevel");r.appendChild(n),this._levelDOM=n}var i=De("div","maptalks-zoom-slider"),o=De("a","maptalks-zoom-zoomin");if(o.href="javascript:;",o.innerHTML="+",i.appendChild(o),this._zoomInButton=o,e.slider){var a=De("div","maptalks-zoom-slider-box"),s=De("div","maptalks-zoom-slider-ruler"),h=De("span","maptalks-zoom-slider-reading"),u=De("span","maptalks-zoom-slider-dot");s.appendChild(h),a.appendChild(s),a.appendChild(u),i.appendChild(a),this._sliderBox=a,this._sliderRuler=s,this._sliderReading=h,this._sliderDot=u}var l=De("a","maptalks-zoom-zoomout");return l.href="javascript:;",l.innerHTML="-",i.appendChild(l),this._zoomOutButton=l,r.appendChild(i),t.on("_zoomend _zoomstart _spatialreferencechange",this._update,this),this._update(),this._registerDomEvents(),r},e.prototype.onRemove=function(){this.getMap().off("_zoomend _zoomstart _spatialreferencechange",this._update,this),this._zoomInButton&&rr(this._zoomInButton,"click",this._onZoomInClick,this),this._zoomOutButton&&rr(this._zoomOutButton,"click",this._onZoomOutClick,this),this._sliderRuler&&(rr(this._sliderRuler,"click",this._onClickRuler,this),this.dotDragger.disable(),delete this.dotDragger)},e.prototype._update=function(){var t=this.getMap();if(this._sliderBox){var e=10*(t.getMaxZoom()-t.getMinZoom());this._sliderBox.style.height=e+16+"px",this._sliderRuler.style.height=e+8+"px",this._sliderRuler.style.cursor="pointer";var r=10*(t.getMaxZoom()-t.getZoom());this._sliderReading.style.height=10*(t.getZoom()-t.getMinZoom()+1)+"px",this._sliderDot.style.top=r+"px"}this._updateText()},e.prototype._updateText=function(){if(this._levelDOM){var t=this.getMap().getZoom();x(t)||(t=t.toFixed(1)),this._levelDOM.innerHTML=t}},e.prototype._registerDomEvents=function(){this._zoomInButton&&er(this._zoomInButton,"click",this._onZoomInClick,this),this._zoomOutButton&&er(this._zoomOutButton,"click",this._onZoomOutClick,this),this._sliderRuler&&(er(this._sliderRuler,"click",this._onClickRuler,this),this.dotDragger=new xr(this._sliderDot,{ignoreMouseleave:!0}),this.dotDragger.on("dragstart",this._onDotDragstart,this).on("dragging dragend",this._onDotDrag,this).enable())},e.prototype._onZoomInClick=function(t){Ue(t),this.getMap().zoomIn()},e.prototype._onZoomOutClick=function(t){Ue(t),this.getMap().zoomOut()},e.prototype._onClickRuler=function(t){Ue(t);var e=this.getMap(),r=We(t,this._sliderRuler).y,n=e.getMaxZoom(),i=Math.floor(n-r/10);e.setZoom(i)},e.prototype._onDotDragstart=function(t){Ue(t.domEvent);var e=this.getMap(),r=e.getSize().toPoint()._multi(.5);e.onZoomStart(e.getZoom(),r)},e.prototype._onDotDrag=function(t){Ue(t.domEvent);var e=this.getMap(),r=e.getSize().toPoint()._multi(.5),n=We(t.domEvent,this._sliderRuler),i=e.getMaxZoom(),o=e.getMinZoom(),a=n.y,s=i-a/10;i<s?(s=i,a=0):o>s&&(s=o,a=10*(i-o)),"dragging"===t.type?e.onZooming(s,r,1):"dragend"===t.type&&(this.options.seamless?e.onZoomEnd(s,r):e.onZoomEnd(Math.round(s),r)),this._sliderDot.style.top=a+"px",this._sliderReading.style.height=10*(e.getZoom()-o+1)+"px",this._updateText()},e}(vo);Ao.mergeOptions({position:"top-left",slider:!0,zoomLevel:!0,seamless:!1}),on.mergeOptions({zoomControl:!1}),on.addOnLoadHook(function(){this.options.zoomControl&&(this.zoomControl=new Ao(this.options.zoomControl),this.addControl(this.zoomControl))});var Mo=Object.freeze({Control:vo,Attribution:bo,LayerSwitcher:wo,Overview:To,Panel:Eo,Scale:Co,Toolbar:So,Zoom:Ao}),Po=function(){function t(e,r,n,i){d(this,t),Array.isArray(e)?(this.scale={x:e[0],y:e[1]},this.origin={x:e[2],y:e[3]}):(this.scale={x:e,y:r},this.origin={x:n,y:i})}return t.getDefault=function(t){return"baidu"===t.code.toLowerCase()?"baidu":t.code.toLowerCase()==="EPSG:4326".toLowerCase()?"tms-global-geodetic":"identity"===t.code.toLowerCase()?[1,-1,0,0]:"web-mercator"},t}(),Ro=6378137*Math.PI;_(Po,{"web-mercator":new Po([1,-1,-Ro,Ro]),"tms-global-mercator":new Po([1,1,-Ro,-Ro]),"tms-global-geodetic":new Po([1,1,-180,-90]),baidu:new Po([1,1,0,0])});var Lo=function(){function t(e,r,n){d(this,t),this.tileSize=n,this.fullExtent=r,this.prepareTileInfo(e,r)}return t.prototype.prepareTileInfo=function(t,e){if(w(t)?t=Po[t.toLowerCase()]:Array.isArray(t)&&(t=new Po(t)),!t)throw new Error("Invalid TileSystem");this.tileSystem=t;var r=e.right>e.left?1:-1,n=e.top>e.bottom?-1:1,i=t.origin.x,o=t.origin.y;this.transformation=new Sr([r,n,i,o])},t.prototype._getTileNum=function(t,e){var r=this.tileSystem,n=this.tileSize,i=Math.floor(1e-7+t.x/(n.width*e)),o=-Math.floor(1e-7+t.y/(n.height*e));return{x:r.scale.x*i,y:r.scale.y*o}},t.prototype.getTileIndex=function(t,e){var r=this.tileSystem,n=this.transformation.transform(t,1),i=this._getTileNum(n,e);return r.scale.x<0&&(i.x-=1),r.scale.y>0&&(i.y-=1),this.getNeighorTileIndex(i.x,i.y,0,0,!0)},t.prototype.getNeighorTileIndex=function(t,e,r,n,i,o){var a=this.tileSystem,s=t+a.scale.x*r,h=e-a.scale.y*n,u=s,l=h;if(o){var c=this._getTileFullIndex(i);s<c.xmin?(s=c.xmax-(c.xmin-s)%(c.xmax-c.xmin))===c.xmax&&(s=c.xmin):s>=c.xmax&&(s=c.xmin+(s-c.xmin)%(c.xmax-c.xmin)),h>=c.ymax?h=c.ymin+(h-c.ymin)%(c.ymax-c.ymin):h<c.ymin&&(h=c.ymax-(c.ymin-h)%(c.ymax-c.ymin))===c.ymax&&(h=c.ymin)}return{x:s,y:h,idx:u,idy:l}},t.prototype._getTileFullIndex=function(t){var e=this.fullExtent,r=this.transformation,n=this._getTileNum(r.transform(new br(e.left,e.top),1),t),i=this._getTileNum(r.transform(new br(e.right,e.bottom),1),t);return new Er(n,i)},t.prototype.getTilePrjNW=function(t,e,r){var n=this.tileSystem,i=this.tileSize,o=n.origin.y+n.scale.y*(e+(1===n.scale.y?1:0))*(r*i.height),a=n.scale.x*(t+(1===n.scale.x?0:1))*r*i.width+n.origin.x;return new br(a,o)},t.prototype.getTilePrjSE=function(t,e,r){var n=this.tileSystem,i=this.tileSize,o=n.origin.y+n.scale.y*(e+(1===n.scale.y?0:1))*(r*i.height),a=n.scale.x*(t+(1===n.scale.x?1:0))*r*i.width+n.origin.x;return new br(a,o)},t.prototype.getTilePrjExtent=function(t,e,r){var n=this.getTilePrjNW(t,e,r),i=this.getTilePrjSE(t,e,r);return new Er(n,i)},t}(),Oo={urlTemplate:null,subdomains:null,repeatWorld:!0,background:!0,backgroundZoomDiff:6,loadingLimitOnInteracting:3,placeholder:!1,crossOrigin:null,tileSize:[256,256],offset:[0,0],tileSystem:null,fadeAnimation:!P,debug:!1,spatialReference:null,maxCacheSize:256,renderer:ue.webgl?"gl":"canvas",clipByPitch:!0,maxAvailableZoom:null,cascadeTiles:!0,minPitchToCascade:35},ko=/\{ *([\w_]+) *\}/g,Do=function(t){function e(){return d(this,e),m(this,t.apply(this,arguments))}return p(e,t),e.fromJSON=function(t){return t&&"TileLayer"===t.type?new e(t.id,t.options):null},e.prototype.getTileSize=function(){return new fe(this.options.tileSize)},e.prototype.getTiles=function(t){var e=this.getMap(),r=e.getContainerExtent(),n=[],i=0,o=this.getMinZoom(),a=this.options.minPitchToCascade,s=y(t)?this._getTileZoom(e.getZoom()):t;if(!y(t)||!this.options.cascadeTiles||e.getPitch()<=a||!y(o)&&s<=o){var h=this._getTiles(s,r);return h&&(i+=h.tiles.length,n.push(h)),{tileGrids:n,count:i}}var u=Math.floor(e._getVisualHeight(a)),l=new Cr(0,e.height-u,e.width,e.height),c=this._getTiles(s,l,0);i+=c?c.tiles.length:0;var f=new Cr(0,r.ymin,e.width,l.ymin),d=e.getSpatialReference().getZoomDirection(),p=this._getTiles(s-d,f,1);return i+=p?p.tiles.length:0,n.push(c,p),{tileGrids:n,count:i}},e.prototype.getTileUrl=function(t,e,r){var n=this.options.urlTemplate,i="";if(this.options.subdomains){var o=this.options.subdomains;if(X(o)){var a=(t+e)%o.length;a<0&&(a=0),i=o[a]}}if(T(n))return n(t,e,r,i);var s={x:t,y:e,z:r,s:i};return n.replace(ko,function(t,e){var r=s[e];if(void 0===r)throw new Error("No value provided for variable "+t);return"function"==typeof r&&(r=r(s)),r})},e.prototype.clear=function(){return this._renderer&&this._renderer.clear(),this.fire("clear"),this},e.prototype.toJSON=function(){return{type:this.getJSONType(),id:this.getId(),options:this.config()}},e.prototype.getSpatialReference=function(){var t=this.getMap();return!t||this.options.spatialReference&&!rn.equals(this.options.spatialReference,t.options.spatialReference)?(this._sr=this._sr||new rn(this.options.spatialReference),this._sr):t.getSpatialReference()},e.prototype._getTileZoom=function(t){var e=this.getMap();x(t)||(t=e.isZooming()?t>e._frameZoom?Math.floor(t):Math.ceil(t):Math.round(t));var r=this.options.maxAvailableZoom;return!y(r)&&t>r&&(t=r),t},e.prototype._getTiles=function(t,e,r){var n=this.getMap();if(!(n&&this.isVisible()&&n.width&&n.height))return null;var i=this.getMinZoom(),o=this.getMaxZoom();if(!y(i)&&t<i||!y(o)&&t>o)return null;var a=this._getTileConfig();if(!a)return null;var s=t,h=this.getSpatialReference(),u=n.getSpatialReference(),l=h.getResolution(s),c={zoom:s,extent:null,tiles:[]},f=this._getTileOffset(s),d=f[0]||f[1],p=e.convertTo(function(t){return n._containerPointToPoint(t)})._add(f),m=this._getInnerExtent(s,e,p),g=this._getMask2DExtent();if(g){var _=g.intersection(p);if(!_)return c;e=_.convertTo(function(t){return n._pointToContainerPoint(t)})}var v=n._containerPointToPrj(e.getCenter()),x=void 0;x=d?this._project(n._pointToPrj(n._prjToPoint(v)._add(f))):this._project(v);for(var b=this._project(n._pointToPrj(p.getMin())),w=this._project(n._pointToPrj(p.getMax())),T=a.getTileIndex(x,l),E=a.getTileIndex(b,l),C=a.getTileIndex(w,l),S=Math.ceil(Math.abs(T.y-E.y)),A=Math.ceil(Math.abs(T.x-E.x)),M=Math.ceil(Math.abs(T.y-C.y)),P=Math.ceil(Math.abs(T.x-C.x)),R=this.getId(),L=this.getRenderer(),O=this.getTileSize(),k=this._getTileConfig().tileSystem.scale,D=[],I=new Cr,N=-A;N<=P;N++)for(var F=-S;F<=M;F++){var B=a.getNeighorTileIndex(T.x,T.y,N,F,l,this.options.repeatWorld),z=a.getTilePrjNW(B.x,B.y,l),U=n._prjToPoint(this._unproject(z),s),H=void 0,j=void 0;if(h===u)H=O.width,j=O.height;else{var G=a.getTilePrjSE(B.x,B.y,l),V=n._prjToPoint(this._unproject(G),s);H=Math.abs(Math.round(V.x-U.x)),j=Math.abs(Math.round(V.y-U.y))}var W=k.x*(B.idx-B.x)*H,Z=-k.y*(B.idy-B.y)*j;(W||Z)&&U._add(W,Z),h!==u&&(H++,j++),d&&U._sub(f);var X=new Cr(U,U.add(H,j)),q={point:U,z:s,x:B.x,y:B.y,extent2d:X,mask:r};(m.intersects(X)||!m.equals(p)&&this._isTileInExtent(q,e))&&(d&&(q.point._add(f),q.extent2d._add(f)),q.size=[H,j],q.dupKey=U.round().toArray().join()+","+H+","+j+","+R,q.id=this._getTileId(B,s),q.layer=R,L&&L.isTileCachedOrLoading(q.id)||(q.url=this.getTileUrl(B.x,B.y,s)),D.push(q),I._combine(X))}var Y=n._containerPointToPoint(e.getCenter(),s)._add(f);return D.sort(function(t,e){return t.point.distanceTo(Y)-e.point.distanceTo(Y)}),{offset:f,zoom:s,extent:I,tiles:D}},e.prototype._getInnerExtent=function(t,e,r){var n=this.getMap(),i=n.getResolution(t),o=n.getResolution()/i,a=r.getCenter()._multi(o),s=n.getBearing()*Math.PI/180,h=e.getHeight()/2*o,u=e.getWidth()/2*o,l=Math.abs(Math.cos(s)*h)||h,c=Math.abs(Math.sin(s)*h)||u;return new Cr(a.sub(c,l),a.add(c,l))},e.prototype._getTileOffset=function(t){var e=this.getMap(),r=e._getResolution()/e._getResolution(t),n=this.options.offset;return T(n)&&(n=n(this)),n[0]*=r,n[1]*=r,n},e.prototype._getTileId=function(t,e,r){return[r||this.getId(),t.idy,t.idx,e].join("__")},e.prototype._project=function(t){var e=this.getMap(),r=this.getSpatialReference();return r!==e.getSpatialReference()?r.getProjection().project(e.getProjection().unproject(t)):t},e.prototype._unproject=function(t){var e=this.getMap(),r=this.getSpatialReference();return r!==e.getSpatialReference()?e.getProjection().project(r.getProjection().unproject(t)):t},e.prototype._initTileConfig=function(){var t=this.getMap(),e=this.getTileSize(),r=this.getSpatialReference(),n=r.getProjection(),i=r.getFullExtent();if(this._defaultTileConfig=new Lo(Po.getDefault(n),i,e),this.options.tileSystem&&(this._tileConfig=new Lo(this.options.tileSystem,i,e)),t&&!this._tileConfig&&t.getSpatialReference()===r&&t.getBaseLayer()&&t.getBaseLayer()!==this&&t.getBaseLayer()._getTileConfig){var o=t.getBaseLayer()._getTileConfig();this._tileConfig=new Lo(o.tileSystem,o.fullExtent,e)}},e.prototype._getTileConfig=function(){return this._defaultTileConfig||this._initTileConfig(),this._tileConfig||this._defaultTileConfig},e.prototype._bindMap=function(e){var r=e.getBaseLayer();return r===this&&(r.options.hasOwnProperty("forceRenderOnMoving")||this.config({forceRenderOnMoving:!0})),t.prototype._bindMap.apply(this,arguments)},e.prototype._isTileInExtent=function(t,e){var r=this.getMap();if(!r)return!1;var n=t.z,i=t.extent2d.convertTo(function(t){return r._pointToContainerPoint(t,n)});return!(i.getWidth()<5||i.getHeight()<5)&&e.intersects(i)},e.prototype.getEvents=function(){return{spatialreferencechange:this._onSpatialReferenceChange}},e.prototype._onSpatialReferenceChange=function(){delete this._tileConfig,delete this._defaultTileConfig,delete this._sr},e}($r);Do.registerJSONType("TileLayer"),Do.mergeOptions(Oo);var Io=function(t){function e(r,n,i){d(this,e);var o=m(this,t.call(this,r,i));return o.layers=n||[],o._checkChildren(),o.layerMap={},o._groupChildren=[],o}return p(e,t),e.fromJSON=function(t){if(!t||"GroupTileLayer"!==t.type)return null;var r=t.layers.map(function(t){return $r.fromJSON(t)});return new e(t.id,r,t.options)},e.prototype.getLayers=function(){return this.layers},e.prototype.toJSON=function(){return{type:this.getJSONType(),id:this.getId(),layers:this.layers.map(function(t){return t.toJSON()}),options:this.config()}},e.prototype.getTiles=function(t){for(var e=this.layers,r=[],n=0,i=0,o=e.length;i<o;i++){var a=e[i];if(a.options.visible){var s=a.getTiles(t);s&&0!==s.count&&(n+=s.count,B(r,s.tileGrids))}}return{count:n,tileGrids:r}},e.prototype.onAdd=function(){var e=this,r=this.getMap();this.layers.forEach(function(t){e.layerMap[t.getId()]=t,t.getChildLayer&&e._groupChildren.push(t),t._bindMap(r),t.on("show hide",e._onLayerShowHide,e)}),t.prototype.onAdd.call(this)},e.prototype.onRemove=function(){var e=this;this.layers.forEach(function(t){t._doRemove(),t.off("show hide",e._onLayerShowHide,e)}),delete this.layerMap,delete this._groupChildren,t.prototype.onRemove.call(this)},e.prototype.getChildLayer=function(t){var e=this.layerMap[t];if(e)return e;for(var r=0;r<this._groupChildren.length;r++){var n=this._groupChildren[r].getChildLayer(t);if(n)return n}return null},e.prototype._onLayerShowHide=function(){var t=this.getRenderer();t&&t.setToRedraw()},e.prototype.isVisible=function(){if(!t.prototype.isVisible.call(this))return!1;for(var e=this.layers,r=0,n=e.length;r<n;r++)if(e[r].isVisible())return!0;return!1},e.prototype._checkChildren=function(){var t=this,e={};this.layers.forEach(function(r){var n=r.getId();if(e[n])throw new Error("Duplicate child layer id ("+n+") in the GroupTileLayer ("+t.getId()+")");e[n]=1})},e}(Do);Io.registerJSONType("GroupTileLayer");var No={service:"WMS",request:"GetMap",layers:"",styles:"",format:"image/jpeg",transparent:!1,version:"1.1.1"},Fo=function(t){function e(r,n){d(this,e);var i=m(this,t.call(this,r)),o=_({},No);for(var a in n)a in i.options||(o[a]=n[a]);i.setOptions(n);var s=n.detectRetina&&ue.retina?2:1,h=i.getTileSize();return o.width=h.width*s,o.height=h.height*s,i.wmsParams=o,i._wmsVersion=parseFloat(o.version),i}return p(e,t),e.prototype.onAdd=function(){var e=this.options.crs||this.getMap().getProjection().code,r=this._wmsVersion>=1.3?"crs":"srs";this.wmsParams[r]=e,t.prototype.onAdd.call(this)},e.prototype.getTileUrl=function(e,r,n){var i=this.getMap()._getResolution(n),o=this._getTileConfig().getTilePrjExtent(e,r,i),a=o.getMax(),s=o.getMin(),h=(this._wmsVersion>=1.3&&"EPSG:4326"===this.wmsParams.crs?[s.y,s.x,a.y,a.x]:[s.x,s.y,a.x,a.y]).join(","),u=t.prototype.getTileUrl.call(this,e,r,n);return u+function(t,e,r){var n=[];for(var i in t)n.push(encodeURIComponent(r?i.toUpperCase():i)+"="+encodeURIComponent(t[i]));return(e&&-1!==e.indexOf("?")?"&":"?")+n.join("&")}(this.wmsParams,u,this.options.uppercase)+(this.options.uppercase?"&BBOX=":"&bbox=")+h},e.prototype.toJSON=function(){return{type:"WMSTileLayer",id:this.getId(),options:this.config()}},e.fromJSON=function(t){return t&&"WMSTileLayer"===t.type?new e(t.id,t.options):null},e}(Do);Fo.registerJSONType("WMSTileLayer"),Fo.mergeOptions({crs:null,uppercase:!1,detectRetina:!1});var Bo=function(t){function e(r,n){d(this,e);var i=m(this,t.call(this,r,n));return i.options.hasOwnProperty("forceRenderOnMoving")||(i.options.forceRenderOnMoving=!1),i}return p(e,t),e.prototype.drawTile=function(){},e.prototype.toJSON=function(){return{type:"CanvasTileLayer",id:this.getId(),options:this.config()}},e.fromJSON=function(t){return t&&"CanvasTileLayer"===t.type?new e(t.id,t.options):null},e}(Do);function zo(t,e,r){var n=t.createShader(e);if(t.shaderSource(n,r),t.compileShader(n),!t.getShaderParameter(n,t.COMPILE_STATUS)){var i=t.getShaderInfoLog(n);throw t.deleteShader(n),new Error("Failed to compile shader: "+i)}return n}Bo.registerJSONType("CanvasTileLayer");var Uo="\n        attribute vec3 a_position;\n\n        attribute vec2 a_texCoord;\n\n        uniform mat4 u_matrix;\n\n        varying vec2 v_texCoord;\n\n        void main() {\n            gl_Position = u_matrix * vec4(a_position, 1.0);\n\n            v_texCoord = a_texCoord;\n        }\n    ",Ho="\n        precision mediump float;\n\n        uniform sampler2D u_image;\n\n        uniform float u_opacity;\n\n        varying vec2 v_texCoord;\n\n        void main() {\n\n            gl_FragColor = texture2D(u_image, v_texCoord) * u_opacity;\n\n        }\n    ",jo=[0,0],Go=[0,0,0],Vo=new Array(16),Wo=function(t){var e,r=function(t){function e(){return d(this,e),m(this,t.apply(this,arguments))}return p(e,t),e.prototype.drawGLImage=function(t,e,r,n,i,o){var a=this.gl;this.loadTexture(t),Go[0]=e||0,Go[1]=r||0;var s=Di(Vo);Ri(s,s,Go),Oi(s,this.getMap().projViewMatrix,s),a.uniformMatrix4fv(this.program.u_matrix,!1,s),a.uniform1f(this.program.u_opacity,o),t.glBuffer?a.bindBuffer(a.ARRAY_BUFFER,t.glBuffer):t.glBuffer=this.bufferTileData(0,0,n,i),jo[0]="a_position",jo[1]=3,this.enableVertexAttrib(jo),a.drawArrays(a.TRIANGLE_STRIP,0,4)},e.prototype.bufferTileData=function(t,e,r,n,i){var o=t,a=t+r,s=e,h=e+n;return this.loadImageBuffer(this.set12(o,s,0,o,h,0,a,s,0,a,h,0),i)},e.prototype.drawTinImage=function(t,e,r,n,i){var o=this.gl;this.loadTexture(t),o.uniformMatrix4fv(this.program.u_matrix,!1,this.getMap().projViewMatrix),o.uniform1f(this.program.u_opacity,i),o.bindBuffer(o.ARRAY_BUFFER,this.posBuffer),this.enableVertexAttrib(["a_position",3]),o.bufferData(o.ARRAY_BUFFER,new Float32Array(e),o.DYNAMIC_DRAW),o.bindBuffer(o.ARRAY_BUFFER,this.texBuffer),this.enableVertexAttrib(["a_texCoord",2]),o.bufferData(o.ARRAY_BUFFER,new Float32Array(r),o.DYNAMIC_DRAW),o.bufferData(o.ELEMENT_ARRAY_BUFFER,new Uint16Array(n),o.DYNAMIC_DRAW),o.drawElements(o.TRIANGLES,n.length,o.UNSIGNED_SHORT,0)},e.prototype.createCanvas2=function(){this.canvas2=ar.createCanvas(this.canvas.width,this.canvas.height)},e.prototype.createGLContext=function(){var t=this.gl=function(t,e){for(var r={alpha:!0,stencil:!0,preserveDrawingBuffer:!0,antialias:!1},n=["webgl","experimental-webgl"],i=null,o=0;o<n.length;++o){try{i=t.getContext(n[o],e||r)}catch(t){}if(i)break}return i}(this.canvas2||this.canvas,this.layer.options.glOptions);t.clearColor(0,0,0,0),t.disable(t.DEPTH_TEST),t.enable(t.STENCIL_TEST),t.enable(t.BLEND),t.blendFunc(t.ONE,t.ONE_MINUS_SRC_ALPHA),this.program=this.createProgram(Uo,this.layer.options.fragmentShader||Ho,["u_matrix","u_image","u_opacity"]),this.useProgram(this.program),this.texBuffer=this.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.texBuffer),this.enableVertexAttrib(["a_texCoord",2]),t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,1]),t.STATIC_DRAW),this.enableSampler("u_image"),t.activeTexture(t.TEXTURE0),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),this.posBuffer=this.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.posBuffer),this.enableVertexAttrib(["a_position",3]),this.indicesBuffer=this.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.indicesBuffer)},e.prototype.resizeGLCanvas=function(){this.gl&&this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.canvas2&&(this.canvas2.width===this.canvas.width&&this.canvas2.height===this.canvas.height||(this.canvas2.width=this.canvas.width,this.canvas2.height=this.canvas.height))},e.prototype.clearGLCanvas=function(){this.gl&&this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.STENCIL_BUFFER_BIT)},e.prototype.disposeImage=function(t){t&&(t.texture&&this.saveTexture(t.texture),t.glBuffer&&this.saveImageBuffer(t.glBuffer),delete t.texture,delete t.glBuffer)},e.prototype._createTexture=function(t){var e=this.gl,r=this.getTexture()||e.createTexture();return e.bindTexture(e.TEXTURE_2D,r),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),x(G(t.width))&&x(G(t.width))&&e.generateMipmap(e.TEXTURE_2D),r},e.prototype.getTexture=function(){this._textures||(this._textures=[]);var t=this._textures;return t&&t.length>0?t.pop():null},e.prototype.saveTexture=function(t){this._textures.push(t)},e.prototype.loadTexture=function(t){var e=this.gl,r=t.texture;return r||(r=this._createTexture(t),t.texture=r),e.bindTexture(e.TEXTURE_2D,r),r},e.prototype.getImageBuffer=function(){this._imageBuffers||(this._imageBuffers=[]);var t=this._imageBuffers;return t&&t.length>0?t.pop():null},e.prototype.saveImageBuffer=function(t){this._imageBuffers.push(t)},e.prototype.loadImageBuffer=function(t,e){var r=this.gl,n=e||this.createImageBuffer();return r.bindBuffer(r.ARRAY_BUFFER,n),r.bufferData(r.ARRAY_BUFFER,t,r.STATIC_DRAW),n},e.prototype.createImageBuffer=function(){return this.getImageBuffer()||this.createBuffer()},e.prototype.removeGLCanvas=function(){var t=this.gl;if(t){this._buffers&&(this._buffers.forEach(function(e){t.deleteBuffer(e)}),delete this._buffers),this._textures&&(this._textures.forEach(function(e){return t.deleteTexture(e)}),delete this._textures),delete this.posBuffer;var e=t.program;t.deleteShader(e.fragmentShader),t.deleteShader(e.vertexShader),t.deleteProgram(e),delete this.gl,delete this.canvas2}},e.prototype.createBuffer=function(){var t=this.gl.createBuffer();if(!t)throw new Error("Failed to create the buffer object");return this._buffers||(this._buffers=[]),this._buffers.push(t),t},e.prototype.enableVertexAttrib=function(t){!function(t,e,r){if(Array.isArray(r[0])){for(var n=Float32Array.BYTES_PER_ELEMENT,i=0,o=0;o<r.length;o++)i+=r[o][1]||0;for(var a=0,s=0;s<r.length;s++){var h=t.getAttribLocation(e,r[s][0]);if(h<0)throw new Error("Failed to get the storage location of "+r[s][0]);t.vertexAttribPointer(h,r[s][1],t[r[s][2]||"FLOAT"],!1,n*i,n*a),a+=r[s][1]||0,t.enableVertexAttribArray(h)}}else{var u=t.getAttribLocation(e,r[0]);t.vertexAttribPointer(u,r[1],t[r[2]||"FLOAT"],!1,0,0),t.enableVertexAttribArray(u)}}(this.gl,this.gl.program,t)},e.prototype.createProgram=function(t,e,r){var n=function(t,e,r){var n=zo(t,t.VERTEX_SHADER,e),i=zo(t,t.FRAGMENT_SHADER,r);if(!n||!i)return null;var o=t.createProgram();return o?(t.attachShader(o,n),t.attachShader(o,i),t.linkProgram(o),{program:o,vertexShader:n,fragmentShader:i}):null}(this.gl,t,e),i=n.program,o=n.vertexShader,a=n.fragmentShader;return i.vertexShader=o,i.fragmentShader=a,this._initUniforms(i,r),i},e.prototype.useProgram=function(t){var e=this.gl;return e.useProgram(t),e.program=t,this},e.prototype.enableSampler=function(t,e){var r=this.gl,n=this._getUniform(r.program,t);return e||(e=0),r.uniform1i(n,e),n},e.prototype._initUniforms=function(t,e){for(var r=0;r<e.length;r++){var n=e[r],i=e[r],o=n.indexOf("[");o>=0&&(n=n.substring(0,o),P||(i=i.substring(0,o))),t[n]=this._getUniform(t,i)}},e.prototype._getUniform=function(t,e){var r=this.gl.getUniformLocation(t,e);if(!r)throw new Error("Failed to get the storage location of "+e);return r},e}(t);return _(r.prototype,{set12:(e=ue.ie9?null:new Float32Array(12),function(t,r,n,i,o,a,s,h,u,l,c,f){return e[0]=t,e[1]=r,e[2]=n,e[3]=i,e[4]=o,e[5]=a,e[6]=s,e[7]=h,e[8]=u,e[9]=l,e[10]=c,e[11]=f,e})}),r},Zo={renderer:ue.webgl?"gl":"canvas",crossOrigin:null},Xo=function(t){function e(r,n,i){d(this,e),Array.isArray(n)||n.url||(i=n,n=null);var o=m(this,t.call(this,r,i));return o._prepareImages(n),o}return p(e,t),e.prototype.setImages=function(t){return this._images=t,this._prepareImages(t),this},e.prototype.getImages=function(){return this._images},e.prototype._prepareImages=function(t){t=t||[],Array.isArray(t)||(t=[t]),this._imageData=t.map(function(t){return _({},t,{extent:new Er(t.extent)})}),this._images=t;var e=this.getRenderer();e&&e.refreshImages()},e}($r);Xo.mergeOptions(Zo);var qo=[],Yo=function(t){function e(){return d(this,e),m(this,t.apply(this,arguments))}return p(e,t),e.prototype.isDrawable=function(){return!this.getMap().getPitch()||(console&&console.warn("ImageLayer with canvas renderer can't be pitched, use gl renderer ('renderer' : 'gl') instead."),!1)},e.prototype.checkResources=function(){var t=this;if(this._imageLoaded)return qo;var e=this.layer._imageData.map(function(t){return[t.url,null,null]});if(this.resources){var r=[],n=new Qr;e.forEach(function(e){if(t.resources.isResourceLoaded(e)){var i=t.resources.getImage(e);n.addResource(e,i)}else r.push(e)}),this.resources.forEach(function(e,r){n.isResourceLoaded(e)||t.retireImage(r.image)}),this.resources=n,e=r}return this._imageLoaded=!0,e},e.prototype.retireImage=function(){},e.prototype.refreshImages=function(){this._imageLoaded=!1,this.setToRedraw()},e.prototype.needToRedraw=function(){var e=this.getMap();return!(e.isZooming()&&!e.getPitch())&&t.prototype.needToRedraw.call(this)},e.prototype.draw=function(){this.isDrawable()&&(this.prepareCanvas(),this._painted=!1,this._drawImages(),this.completeRender())},e.prototype._drawImages=function(){var t=this.layer._imageData,e=this.getMap().getExtent();if(t&&t.length)for(var r=0;r<t.length;r++){var n=t[r].extent,i=this.resources&&this.resources.getImage(t[r].url);i&&e.intersects(n)&&(this._painted=!0,this._drawImage(i,n,t[r].opacity||1))}},e.prototype._drawImage=function(t,e,r){var n=0,i=this.context;r<1&&(n=i.globalAlpha,i.globalAlpha=r);var o=this.getMap(),a=o.coordToPoint(e.getMin()),s=o.coordToPoint(e.getMax()),h=o._pointToContainerPoint(a),u=h.x,l=h.y,c=o.getBearing();c&&(i.save(),i.translate(u,l),c&&i.rotate(-c*Math.PI/180),u=l=0),i.drawImage(t,u,l,s.x-a.x,s.y-a.y),c&&i.restore(),n&&(i.globalAlpha=n)},e.prototype.drawOnInteracting=function(){this.draw()},e}(Kr),Jo=function(t){function e(){return d(this,e),m(this,t.apply(this,arguments))}return p(e,t),e.prototype.isDrawable=function(){return!0},e.prototype._drawImage=function(t,e,r){var n=this.getMap(),i=e.__imagelayerposition;i||(i=e.__imagelayerposition=e.convertTo(function(t){return n.coordToPoint(t,n.getGLZoom())})),this.drawGLImage(t,i.xmin,i.ymin,i.getWidth(),i.getHeight(),r)},e.prototype.createContext=function(){this.createGLContext()},e.prototype.resizeCanvas=function(e){this.canvas&&(t.prototype.resizeCanvas.call(this,e),this.resizeGLCanvas())},e.prototype.clearCanvas=function(){this.canvas&&(t.prototype.clearCanvas.call(this),this.clearGLCanvas())},e.prototype.retireImage=function(t){this.disposeImage(t)},e.prototype.onRemove=function(){this.removeGLCanvas(),t.prototype.onRemove.call(this)},e}(Wo(Yo));Xo.registerRenderer("canvas",Yo),Xo.registerRenderer("gl",Jo);var Ko=function(t){function e(){return d(this,e),m(this,t.apply(this,arguments))}return p(e,t),e.prototype.getPrepareParams=function(){return[]},e.prototype.getDrawParams=function(){return[]},e.prototype.onCanvasCreate=function(){this.canvas&&this.layer.options.doubleBuffer&&(this.buffer=ar.createCanvas(this.canvas.width,this.canvas.height,this.getMap().CanvasClass))},e.prototype.needToRedraw=function(){return!!this.layer.options.animation||!(this.getMap().isInteracting()&&!this.layer.drawOnInteracting)&&t.prototype.needToRedraw.call(this)},e.prototype.draw=function(){this.prepareCanvas(),this.prepareDrawContext(),this._drawLayer()},e.prototype.drawOnInteracting=function(){this._drawLayerOnInteracting()},e.prototype.getCanvasImage=function(){var e=t.prototype.getCanvasImage.call(this);if(e&&e.image&&this.layer.options.doubleBuffer){var r=e.image;this.buffer.width===r.width&&this.buffer.height===r.height||(this.buffer.width=r.width,this.buffer.height=r.height);var n=this.buffer.getContext("2d"),i=this.layer.doubleBuffer(n,this.context);(void 0===i||i)&&(ar.image(n,r,0,0),e.image=this.buffer)}return e},e.prototype.remove=function(){return delete this._drawContext,t.prototype.remove.call(this)},e.prototype.onZoomStart=function(e){this.layer.onZoomStart(e),t.prototype.onZoomStart.call(this,e)},e.prototype.onZooming=function(e){this.layer.onZooming(e),t.prototype.onZooming.call(this,e)},e.prototype.onZoomEnd=function(e){this.layer.onZoomEnd(e),t.prototype.onZoomEnd.call(this,e)},e.prototype.onMoveStart=function(e){this.layer.onMoveStart(e),t.prototype.onMoveStart.call(this,e)},e.prototype.onMoving=function(e){this.layer.onMoving(e),t.prototype.onMoving.call(this,e)},e.prototype.onMoveEnd=function(e){this.layer.onMoveEnd(e),t.prototype.onMoveEnd.call(this,e)},e.prototype.onResize=function(e){this.layer.onResize(e),t.prototype.onResize.call(this,e)},e.prototype.prepareDrawContext=function(){if(!this._predrawed){var t=Qo(this.getPrepareParams());this._drawContext=this.layer.prepareToDraw.apply(this.layer,[this.context].concat(t)),this._drawContext||(this._drawContext=[]),Array.isArray(this._drawContext)||(this._drawContext=[this._drawContext]),this._predrawed=!0}},e.prototype._prepareDrawParams=function(){if(!this.getMap())return null;var t=this.getViewExtent();if(t.maskExtent&&!t.extent.intersects(t.maskExtent))return this.completeRender(),null;var e=[this.context,t],r=Qo(this.getDrawParams());return e.push.apply(e,r),e.push.apply(e,this._drawContext),e},e.prototype._drawLayer=function(){var t=this._prepareDrawParams();t&&(this.layer.draw.apply(this.layer,t),this.completeRender())},e.prototype._drawLayerOnInteracting=function(){if(this.layer.drawOnInteracting){var t=this._prepareDrawParams();t&&(this.layer.drawOnInteracting.apply(this.layer,t),this.completeRender())}},e}(Kr);function Qo(t){return t||(t=[]),Array.isArray(t)||(t=[t]),t}var $o=function(t){function e(){return d(this,e),m(this,t.apply(this,arguments))}return p(e,t),e.prototype.isCanvasRender=function(){return!0},e.prototype.prepareToDraw=function(){},e.prototype.draw=function(){},e.prototype.redraw=function(){return this._getRenderer()&&this._getRenderer().setToRedraw(),this},e.prototype.play=function(){return this.config("animation",!0),this},e.prototype.pause=function(){return this.config("animation",!1),this},e.prototype.isPlaying=function(){return this.options.animation},e.prototype.clearCanvas=function(){return this._getRenderer()&&this._getRenderer().clearCanvas(),this},e.prototype.requestMapToRender=function(){return this._getRenderer()&&this._getRenderer().requestMapToRender(),this},e.prototype.completeRender=function(){return this._getRenderer()&&this._getRenderer().completeRender(),this},e.prototype.onCanvasCreate=function(){return this},e.prototype.onZoomStart=function(){},e.prototype.onZooming=function(){},e.prototype.onZoomEnd=function(){},e.prototype.onMoveStart=function(){},e.prototype.onMoving=function(){},e.prototype.onMoveEnd=function(){},e.prototype.onResize=function(){},e.prototype.doubleBuffer=function(t){return t.clearRect(0,0,t.canvas.width,t.canvas.height),this},e}($r);$o.mergeOptions({doubleBuffer:!1,animation:!1}),$o.registerRenderer("canvas",Ko);var ta=function(t){function e(){return d(this,e),m(this,t.apply(this,arguments))}return p(e,t),e.prototype.getParticles=function(){},e.prototype.draw=function(t,e){var r=this.getParticles(g());if(r&&0!==r.length){var n=this.getMap(),i=e.extent;e.maskExtent&&(i=e.extent.intersection(e.maskExtent)),i=i.convertTo(function(t){return n._pointToContainerPoint(t)});for(var o=2*Math.PI,a=0,s=r.length;a<s;a++){var h=r[a].point;if(i.contains(h)){var u=r[a].color||this.options.lineColor||"#fff",l=r[a].r;t.fillStyle!==u&&(t.fillStyle=u),l<=2?t.fillRect(h.x-l/2,h.y-l/2,l,l):(t.beginPath(),t.arc(h.x,h.y,l/2,0,o),t.fill())}}this._fillCanvas(t)}else{this._getRenderer()&&(this._getRenderer()._shouldClear=!0)}},e.prototype._fillCanvas=function(t){var e=t.globalCompositeOperation;t.globalCompositeOperation="destination-out";var r=this.options.trail||30;t.fillStyle="rgba(0, 0, 0, "+1/r+")",t.fillRect(0,0,t.canvas.width,t.canvas.height),t.globalCompositeOperation=e},e}($o);ta.mergeOptions({animation:!0}),ta.registerRenderer("canvas",function(t){function e(){return d(this,e),m(this,t.apply(this,arguments))}return p(e,t),e.prototype.draw=function(){this.canvas&&this.layer.options.animation&&!this._shouldClear||(this.prepareCanvas(),this._shouldClear=!1),this.prepareDrawContext(),this._drawLayer()},e.prototype.drawOnInteracting=function(){this.draw(),this._shouldClear=!1},e.prototype.onSkipDrawOnInteracting=function(){this._shouldClear=!0},e}(Ko));var ea=o+"_edit_stage_";function ra(t,e){return{markerType:t,markerFill:"#fff",markerLineColor:"#000",markerLineWidth:2,markerWidth:10,markerHeight:10,opacity:e}}var na={fixAspectRatio:!1,symbol:null,removeVertexOn:"contextmenu",centerHandleSymbol:ra("ellipse",1),vertexHandleSymbol:ra("square",1),newVertexHandleSymbol:ra("square",.4)},ia=function(t){function e(r,n){d(this,e);var i=m(this,t.call(this,n));return i._geometry=r,i._geometry?i:m(i)}return p(e,t),e.prototype.getMap=function(){return this._geometry.getMap()},e.prototype.prepare=function(){this.getMap()&&(this.options.symbol&&(this._originalSymbol=this._geometry.getSymbol(),this._geometry.setSymbol(this.options.symbol)),this._prepareEditStageLayer())},e.prototype._prepareEditStageLayer=function(){var t=this.getMap(),e=I(),r=ea+e,n=ea+e+"_shadow";this._editStageLayer=t.getLayer(r),this._shadowLayer=t.getLayer(n),this._editStageLayer||(this._editStageLayer=new Ti(r),t.addLayer(this._editStageLayer)),this._shadowLayer||(this._shadowLayer=new Ti(n),t.addLayer(this._shadowLayer))},e.prototype.start=function(){var t=this;if(this._geometry&&this._geometry.getMap()&&!this._geometry.editing){var e=this.getMap();this.editing=!0;var r=this._geometry;this._geometryDraggble=r.options.draggable,r.config("draggable",!1),this.prepare();var n=r.copy();n.setSymbol(r._getInternalSymbol()),n.copyEventListeners(r),r._getParent()&&n.copyEventListeners(r._getParent()),n.setId(null).config({draggable:!1}),this._shadow=n,this._switchGeometryEvents("on"),r.hide(),(r instanceof Zn||r instanceof ii||r instanceof ai||r instanceof oi)&&this._createOrRefreshOutline(),this._shadowLayer.bringToFront().addGeometry(n),this._editStageLayer.bringToFront(),this._addListener([e,"zoomstart",function(){t._editStageLayer.hide()}]),this._addListener([e,"zoomend",function(){t._editStageLayer.show()}]),r instanceof Zn?(n.config("draggable",!0),n.on("dragend",this._onMarkerDragEnd,this)):this._createCenterHandle(),r instanceof Zn?this.createMarkerEditor():r instanceof ii?this.createCircleEditor():r instanceof ai?this.createEllipseOrRectEditor():r instanceof oi?this.createEllipseOrRectEditor():r instanceof si||(r instanceof Vn||r instanceof qn)&&this.createPolygonEditor()}},e.prototype.stop=function(){delete this._history,delete this._historyPointer,delete this._editOutline,this._switchGeometryEvents("off"),this.getMap()&&(delete this._shadow,this._geometry.config("draggable",this._geometryDraggble),delete this._geometryDraggble,this._geometry.show(),this._editStageLayer.remove(),this._shadowLayer.remove(),this._clearAllListeners(),this._refreshHooks=[],this.options.symbol&&(this._geometry.setSymbol(this._originalSymbol),delete this._originalSymbol),this.editing=!1)},e.prototype.isEditing=function(){return!y(this.editing)&&this.editing},e.prototype._getGeometryEvents=function(){return{symbolchange:this._onGeoSymbolChange,"positionchange shapechange":this._exeAndReset}},e.prototype._switchGeometryEvents=function(t){if(this._geometry){var e=this._getGeometryEvents();for(var r in e)this._geometry[t](r,e[r],this)}},e.prototype._onGeoSymbolChange=function(t){this._shadow&&this._shadow.setSymbol(t.target._getInternalSymbol())},e.prototype._onMarkerDragEnd=function(){this._update("setCoordinates",this._shadow.getCoordinates().toArray()),this._refresh()},e.prototype._createOrRefreshOutline=function(){var t=this._geometry,e=this._editOutline;return e?(e.remove(),this._editOutline=e=t.getOutline(),this._editStageLayer.addGeometry(e)):(e=t.getOutline(),this._editStageLayer.addGeometry(e),this._editOutline=e,this._addRefreshHook(this._createOrRefreshOutline)),e},e.prototype._createCenterHandle=function(){var t=this,e=this._shadow.getCenter(),r=this.options.centerHandleSymbol,n=void 0,i=this.createHandle(e,{symbol:r,cursor:"move",onDown:function(){var e=Bt((n=t._shadow.copy())._getInternalSymbol(),.5);n.setSymbol(e).addTo(t._editStageLayer)},onMove:function(t,e){var r=e.coordOffset;n.translate(r)},onUp:function(){t._update("setCoordinates",br.toNumberArrays(n.getCoordinates())),n.remove(),t._refresh()}});this._addRefreshHook(function(){var e=t._shadow.getCenter();i.setCoordinates(e)})},e.prototype._createHandleInstance=function(t,e){var r=e.symbol;return new Zn(t,{draggable:!0,dragShadow:!1,dragOnAxis:e.axis,cursor:e.cursor,symbol:r})},e.prototype.createHandle=function(t,e){e||(e={});var r=this.getMap(),n=this._createHandleInstance(t,e),i=this;function o(t){return e.onDown&&e.onDown.call(i,t.viewPoint,t),!1}function a(t){i._hideContext();var o=r._prjToViewPoint(n._getPrjCoordinates());return e.onMove&&e.onMove.call(i,o,t),!1}function s(t){return e.onUp&&e.onUp.call(i,t),!1}return n.on("dragstart",o,this),n.on("dragging",a,this),n.on("dragend",s,this),n.on("removestart",function t(){n.config("draggable",!1),n.off("dragstart",o,i),n.off("dragging",a,i),n.off("dragend",s,i),n.off("removestart",t,i),delete n["maptalks--editor-refresh-fn"]},this),e.onRefresh&&(n["maptalks--editor-refresh-fn"]=e.onRefresh),this._editStageLayer.addGeometry(n),n},e.prototype._createResizeHandles=function(t,e,r){var n=this,i=["nw-resize","n-resize","ne-resize","w-resize","e-resize","sw-resize","s-resize","se-resize"],o=[null,"y",null,"x","x",null,"y",null],a=this._geometry;t||(t=[]);var s=this,h=[],u={},l=this.getMap(),c=this.options.vertexHandleSymbol,f=function(){for(var f,d=a._getPainter().get2DExtent(),p=[(f=d).getMin(),new ce((f.xmax+f.xmin)/2,f.ymin),new ce(f.xmax,f.ymin),new ce(f.xmin,(f.ymax+f.ymin)/2),new ce(f.xmax,(f.ymax+f.ymin)/2),new ce(f.xmin,f.ymax),new ce((f.xmax+f.xmin)/2,f.ymax),f.getMax()],m=function(f){if(Array.isArray(t)&&t.some(function(t){return t===f}))return"continue";var d,m=p[f],g=l.pointToCoordinate(m);if(h.length<p.length-t.length){var _=n.createHandle(g,{symbol:c,cursor:i[f],axis:o[f],onMove:(d=f,function(t){s._updating=!0,e(t,d),a.fire("resizing")}),onUp:function(){s._updating=!1,r(),n._refresh()}});_.setId(f),u[f]=h.length,h.push(_)}else h[u[f]].setCoordinates(g)},g=0;g<p.length;g++)m(g)};return f(),this._addRefreshHook(f),h},e.prototype.createMarkerEditor=function(){var t=this,e=this._geometry,r=this._shadow,n=this.getMap();if(r._canEdit()){this._history||this._recordHistory(c());var i=r._getInternalSymbol(),o=new ce(0,0);v(i.markerDx)&&(o.x=i.markerDx),v(i.markerDy)&&(o.y=i.markerDy);var a=null;yn.test(i)?"pin"!==i.markerType&&"pie"!==i.markerType&&"bar"!==i.markerType||(a=[5,6,7]):(xn.test(i)||En.test(i))&&(a=[5,6,7]);var s=[2,1,2,0,0,2,1,2],h=void 0;if(this.options.fixAspectRatio){var u=r.getSize();h=u.width/u.height}var l=this._createResizeHandles(null,function(i,u){if(a&&a.indexOf(u)>=0){var c=n.viewPointToCoordinate(i.sub(o)),f=r.getCoordinates();c.x=f.x,r.setCoordinates(c),t._updateCoordFromShadow(!0);var d=l[l.length-1-u];i=n.coordToViewPoint(d.getCoordinates())}var p=n._pointToViewPoint(r._getCenter2DPoint()).add(o),m=r._getInternalSymbol(),g=i.sub(p);a&&i.y>p.y&&(g.y=0);var _=a?1:2,y=2*Math.abs(g.x),v=Math.abs(g.y)*_;h&&(v=(y=Math.max(y,v*h))/h);var x=s[u];r instanceof mi?((h||0===x||2===x)&&(r.setWidth(y),e.setWidth(y)),(h||1===x||2===x)&&(r.setHeight(v),e.setHeight(v))):((h||0===x||2===x)&&(m.markerWidth=y),(h||1===x||2===x)&&(m.markerHeight=v),r.setSymbol(m),e.setSymbol(m))},function(){t._update(c())});this._addListener([n,"zoomend",function(){this._refresh()}])}else console&&console.warn("A marker can't be resized with symbol:",r.getSymbol());function c(){var t=[["setCoordinates",r.getCoordinates().toArray()]];return r instanceof mi?(t.push(["setWidth",r.getWidth()]),t.push(["setHeight",r.getHeight()])):t.push(["setSymbol",r.getSymbol()]),t}},e.prototype.createCircleEditor=function(){var t=this,e=this._geometry,r=this._shadow,n=this.getMap();this._history||this._recordHistory([["setCoordinates",r.getCoordinates().toArray()],["setRadius",r.getRadius()]]),this._createResizeHandles(null,function(t){var i=n._pointToViewPoint(r._getCenter2DPoint()),o=t.sub(i),a=Math.abs(o.x),s=Math.abs(o.y),h=void 0;h=a>s?n.pixelToDistance(a,0):n.pixelToDistance(0,s),r.setRadius(h),e.setRadius(h)},function(){t._update("setRadius",r.getRadius())})},e.prototype.createEllipseOrRectEditor=function(){var t=this,e=[2,1,2,0,0,2,1,2],r=this._geometry,n=this._shadow;this._history||this._recordHistory(h());var i=this.getMap(),o=this._geometry instanceof ai,a=void 0;this.options.fixAspectRatio&&(a=r.getWidth()/r.getHeight());var s=this._createResizeHandles(null,function(h,u){var l=o?1:2,c=void 0,f=void 0,d=void 0,p=h,m=e[u];if(o){var g=s[7-u],_=i.coordToViewPoint(g.getCoordinates()),y=(c=p.sub(_)).abs();f=i.pixelToDistance(y.x,0),d=i.pixelToDistance(0,y.y);var v=r.getSize();0===m?(a&&(y.y=y.x/a,v.height=Math.abs(y.y),d=f/a),p.y=_.y-v.height/2):1===m?(a&&(y.x=y.y*a,v.width=Math.abs(y.x),f=d*a),p.x=_.x-v.width/2):a&&(f>d*a?(d=f/a,p.y=_.y+y.x*j(c.y)/a):(f=d*a,p.x=_.x+y.y*j(c.x)*a));var x=i.viewPointToCoordinate(new ce(Math.min(p.x,_.x),Math.min(p.y,_.y)));n.setCoordinates(x),t._updateCoordFromShadow(!0)}else{c=i.coordToViewPoint(r.getCenter()).sub(p)._abs(),f=i.pixelToDistance(c.x,0),d=i.pixelToDistance(0,c.y),a&&(d=(f=Math.max(f,d*a))/a)}(a||0===m||2===m)&&(n.setWidth(f*l),r.setWidth(f*l)),(a||1===m||2===m)&&(n.setHeight(d*l),r.setHeight(d*l))},function(){t._update(h())});function h(){return[["setCoordinates",n.getCoordinates().toArray()],["setWidth",n.getWidth()],["setHeight",n.getHeight()]]}},e.prototype.createPolygonEditor=function(){var t=this.getMap(),e=this._shadow,r=this,n=t.getProjection();this._history||this._recordHistory("setCoordinates",br.toNumberArrays(e.getCoordinates()));var i=e instanceof Vn?3:2,o="maptalks--editor-refresh-fn",a="maptalks--editor-vertex-index",s=[],h=[];function u(){if(e instanceof Vn){var t=e.getCoordinates()[0];return t.slice(0,t.length-1)}return e.getCoordinates()}function l(){return e._getPrjCoordinates()}function c(){for(var t=s.length-1;t>=0;t--)s[t][a]=t;for(var e=h.length-1;e>=0;e--)h[e][a]=e;r._updateCoordFromShadow()}function f(t){var n=t.target[a],o=l();if(!(o.length<=i)){o.splice(n,1),e._setPrjCoordinates(o),e._updateCache(),s.splice(n,1)[0].remove(),n<h.length&&h.splice(n,1)[0].remove();var u=void 0;u=0===n?h.length-1:n-1,h.splice(u,1)[0].remove(),h.splice(u,0,m.call(r,u)),c(),r._refresh()}}function d(n,i){var a=l(),s=t._viewPointToPrj(n),u=a[i];u.x=s.x,u.y=s.y,e._updateCache(),e.onShapeChanged(),r._updateCoordFromShadow(!0);var c=void 0;c=0===i?h.length-1:i-1,h[i]&&h[i][o](),h[c]&&h[c][o]()}function p(t){var e=u()[t],n=r.createHandle(e,{symbol:r.options.vertexHandleSymbol,cursor:"pointer",axis:null,onMove:function(t){d(t,n[a])},onRefresh:function(){e=u()[n[a]],n.setCoordinates(e)},onUp:function(){r._refresh(),r._updateCoordFromShadow()}});return n[a]=t,n.on(r.options.removeVertexOn,f),n}function m(t){var i=u(),o=void 0;o=t+1>=i.length?i[0]:i[t+1];var f=i[t].add(o).multi(.5),g=r.createHandle(f,{symbol:r.options.newVertexHandleSymbol,cursor:"pointer",axis:null,onDown:function(t,i){if(!i||!i.domEvent||2!==i.domEvent.button){var o=l(),s=g[a],u=n.project(g.getCoordinates());o.splice(s+1,0,u),e._setPrjCoordinates(o),e._updateCache();var c=g.getSymbol();delete c.opacity,g.setSymbol(c),h.splice(s,0,m.call(r,s),m.call(r,s+1))}},onMove:function(t){d(t,g[a]+1)},onUp:function(t){if(!t||!t.domEvent||2!==t.domEvent.button){var e=g[a];z(g,h),g.remove(),s.splice(e+1,0,p.call(r,e+1)),c(),r._updateCoordFromShadow(),r._refresh()}},onRefresh:function(){i=u();var t=g[a],e=void 0;e=t===i.length-1?0:t+1;var r=i[t].add(i[e]).multi(.5);g.setCoordinates(r)}});return g[a]=t,g}for(var g=u(),_=0,y=g.length;_<y;_++)s.push(p.call(this,_)),_<y-1&&h.push(m.call(this,_));e instanceof Vn&&h.push(m.call(this,g.length-1)),this._addRefreshHook(function(){for(var t=h.length-1;t>=0;t--)h[t][o]();for(var e=s.length-1;e>=0;e--)s[e][o]()})},e.prototype._refresh=function(){if(this._refreshHooks)for(var t=this._refreshHooks.length-1;t>=0;t--)this._refreshHooks[t].call(this)},e.prototype._hideContext=function(){this._geometry&&(this._geometry.closeMenu(),this._geometry.closeInfoWindow())},e.prototype._addListener=function(t){this._eventListeners||(this._eventListeners=[]),this._eventListeners.push(t),t[0].on(t[1],t[2],this)},e.prototype._clearAllListeners=function(){if(this._eventListeners&&this._eventListeners.length>0){for(var t=this._eventListeners.length-1;t>=0;t--){var e=this._eventListeners[t];e[0].off(e[1],e[2],this)}this._eventListeners=[]}},e.prototype._addRefreshHook=function(t){t&&(this._refreshHooks||(this._refreshHooks=[]),this._refreshHooks.push(t))},e.prototype._update=function(t){for(var e=arguments.length,r=Array(e>1?e-1:0),n=1;n<e;n++)r[n-1]=arguments[n];this._exeHistory([t,r]),this._recordHistory.apply(this,[t].concat(r))},e.prototype._updateCoordFromShadow=function(t){if(this._shadow){var e=this._shadow.getCoordinates(),r=this._geometry,n=this._updating;this._updating=!0,r.setCoordinates(e),t||this._recordHistory("setCoordinates",br.toNumberArrays(r.getCoordinates())),this._updating=n}},e.prototype._recordHistory=function(t){this._history||(this._history=[],this._historyPointer=0),this._historyPointer<this._history.length-1&&this._history.splice(this._historyPointer+1);for(var e=arguments.length,r=Array(e>1?e-1:0),n=1;n<e;n++)r[n-1]=arguments[n];this._history.push([t,r]),this._historyPointer=this._history.length-1,this._geometry.fire("editrecord")},e.prototype.undo=function(){if(!this._history||0===this._historyPointer)return this;var t=this._history[--this._historyPointer];return this._exeAndReset(t),this},e.prototype.redo=function(){if(!this._history||this._historyPointer===this._history.length-1)return null;var t=this._history[++this._historyPointer];return this._exeAndReset(t),this},e.prototype._exeAndReset=function(t){if(!this._updating){this._exeHistory(t);var e=this._history,r=this._historyPointer;this.stop(),this._history=e,this._historyPointer=r,this.start()}},e.prototype._exeHistory=function(t){var e=this;if(Array.isArray(t)){var r=this._updating;this._updating=!0;var n=this._geometry;Array.isArray(t[0])?t[0].forEach(function(t){var r=t[0],i=t.slice(1);e._shadow[r].apply(e._shadow,i),n[r].apply(n,i)}):(this._shadow[t[0]].apply(this._shadow,t[1]),n[t[0]].apply(n,t[1])),this._updating=r}},e}(cr(pr));ia.mergeOptions(na);var oa={startEditText:function(){return this.getMap()?(this.hide(),this.endEditText(),this._prepareEditor(),this._fireEvent("edittextstart"),this):this},endEditText:function(){if(this._textEditor){var t=this._textEditor.innerHTML;t=t.replace(/<p>/gi,"").replace(/<\/p>/gi,"<br/>"),this._textEditor.innerHTML=t;var e=this._textEditor.innerText.replace(/[\r\n]+$/gi,"");this.setContent(e),rr(this._textEditor,"mousedown dblclick",He),this.getMap().off("mousedown",this.endEditText,this),this._editUIMarker.remove(),delete this._editUIMarker,this._textEditor.onkeyup=null,delete this._textEditor,this.show(),this._fireEvent("edittextend")}return this},isEditingText:function(){return!!this._textEditor},getTextEditor:function(){return this._editUIMarker},_prepareEditor:function(){var t=this.getMap(),e=this._createEditor();this._textEditor=e,t.on("mousedown",this.endEditText,this);var r=this._getEditorOffset();this._editUIMarker=new uo(this.getCoordinates(),{animation:null,content:e,dx:r.dx,dy:r.dy}).addTo(t),this._setCursorToLast(this._textEditor)},_getEditorOffset:function(){var t=this._getInternalSymbol()||{},e=0,r=0,n=t.textHorizontalAlignment;return"middle"===n||y(n)?(e=(t.textDx||0)-2,r=(t.textDy||0)-2):(e=(t.markerDx||0)-2,r=(t.markerDy||0)-2),{dx:e,dy:r}},_createEditor:function(){var t=this.getContent(),e=this.getSize(),r=this._getInternalSymbol()||{},n=e.width,i=r.textFill||"#000000",o=r.textSize||12,a=e.height,s=r.markerLineColor||"#000",h=r.markerFill||"#3398CC",u=r.textLineSpacing||0,l=De("div");return l.contentEditable=!0,l.style.cssText="background:"+h+"; border:1px solid "+s+";\n            color:"+i+";font-size:"+o+"px;width:"+(n-2)+"px;height:"+(a-2)+"px;margin: auto;\n            line-height:"+(o+u)+"px;outline: 0; padding:0; margin:0;word-wrap: break-word;\n            overflow: hidden;-webkit-user-modify: read-write-plaintext-only;",l.innerText=t,er(l,"mousedown dblclick",He),l.onkeyup=function(t){var e=l.style.height||0;13===t.keyCode&&(l.style.height=parseInt(e)+o/2+"px")},l},_setCursorToLast:function(t){var e=void 0;window.getSelection?(t.focus(),(e=window.getSelection()).selectAllChildren(t),e.collapseToEnd()):document.selection&&((e=document.selection.createRange()).moveToElementText(t),e.collapse(!1),e.select())}};pi.include(oa),On.include({animate:function(t,e,r){var n=this;this._animPlayer&&this._animPlayer.finish(),T(e)&&(r=e),e||(e={});var i=this.getMap(),o=this._getProjection(),a=this.getSymbol()||{},s=this._prepareAnimationStyles(t),h=void 0,u=e.focus;if(delete this._animationStarted,i){var l=i._getRenderer();e.framer=function(t){l.callInNextFrame(t)}}var c=Un.animate(s,e,function(t){if(i&&i.isRemoved())c.finish();else{i&&!n._animationStarted&&u&&i.onMoveStart();var e=t.styles;for(var s in e)if("symbol"!==s&&"translate"!==s&&e.hasOwnProperty(s)){var l="set"+s[0].toUpperCase()+s.slice(1);n[l](e[s])}var f=e.translate;if(f){var d=f;h&&(d=f.sub(h)),h=f,n.translate(d)}var p=e.symbol;if(p&&n.setSymbol(zt(a,p)),i&&u){var m=o.project(n.getCenter());i._setPrjCenter(m);var g=i._parseEventFromCoord(o.unproject(m));"running"!==c.playState?i.onMoveEnd(g):i.onMoving(g)}n._fireAnimateEvent(c.playState),r&&r(t)}});return this._animPlayer=c,this._animPlayer.play()},_prepareAnimationStyles:function(t){var e=this._getInternalSymbol(),r={};for(var n in t)if(t.hasOwnProperty(n)){var i=t[n];if("translate"!==n&&"symbol"!==n){var o=this["get"+n[0].toUpperCase()+n.substring(1)]();r[n]=[o,i]}else if("symbol"===n){var a=void 0;if(Array.isArray(t.symbol)){if(!Array.isArray(e))throw new Error("geometry'symbol isn't a composite symbol, while the symbol in styles is.");a=[];for(var s=t.symbol,h=0;h<s.length;h++)if(s[h]){var u={};for(var l in s[h])s[h].hasOwnProperty(l)&&(u[l]=[e[h][l],s[h][l]]);a.push(u)}else a.push(null)}else{if(Array.isArray(e))throw new Error("geometry'symbol is a composite symbol, while the symbol in styles isn't.");for(var c in a={},i)i.hasOwnProperty(c)&&(a[c]=[e[c],i[c]])}r.symbol=a}else"translate"===n&&(r.translate=new br(i))}return r},_fireAnimateEvent:function(t){"finished"===t?(delete this._animationStarted,this._fireEvent("animateend")):"running"===t&&(this._animationStarted?this._fireEvent("animating"):(this._fireEvent("animatestart"),this._animationStarted=!0))}});var aa=o+"_drag_stage",sa=ue.touch?"touchstart mousedown":"mousedown",ha=function(t){function e(r){return d(this,e),m(this,t.call(this,r))}return p(e,t),e.prototype.addHooks=function(){this.target.on(sa,this._startDrag,this)},e.prototype.removeHooks=function(){this._endDrag(),this.target.off(sa,this._startDrag,this),delete this.container},e.prototype._prepareDragHandler=function(){this._dragHandler=new xr(this.container),this._dragHandler.on("dragging",this._dragging,this).on("mouseup",this._endDrag,this).enable()},e.prototype._prepareShadow=function(){var t=this.target;this._prepareDragStageLayer(),this._shadow&&this._shadow.remove();var e=this._shadow=t.copy();if(this._shadow.setSymbol(t._getInternalSymbol()),t.options.dragShadow){var r=Bt(e._getInternalSymbol(),.5);e.setSymbol(r)}e.setId(null),this._prepareShadowConnectors()},e.prototype._prepareShadowConnectors=function(){var t=this.target,e=this._shadow,r=this._dragStageLayer._getRenderer().resources,n=[];if(vi._hasConnectors(t))for(var i=vi._getConnectors(t),o=0,a=i.length;o<a;o++){var s=i[o],h=s.config(),u=s._getInternalSymbol();h.symbol=Bt(u,.5);var l=void 0;l=s.getConnectSource()===t?new s.constructor(e,s.getConnectTarget(),h):new s.constructor(s.getConnectSource(),e,h),n.push(l),s.getLayer()&&s.getLayer()._getRenderer()&&r.merge(s.getLayer()._getRenderer().resources)}this._shadowConnectors=n,n.push(e),this._dragStageLayer.bringToFront().addGeometry(n)},e.prototype._onTargetUpdated=function(){this._shadow&&this._shadow.setSymbol(this.target._getSymbol())},e.prototype._prepareDragStageLayer=function(){var t=this.target.getMap(),e=this.target.getLayer();this._dragStageLayer=t.getLayer(aa),this._dragStageLayer||(this._dragStageLayer=new Ti(aa,{enableAltitude:e.options.enableAltitude,altitudeProperty:e.options.altitudeProperty}),t.addLayer(this._dragStageLayer));var r=new Qr;r.merge(e._getRenderer().resources),this._dragStageLayer._getRenderer().resources=r},e.prototype._startDrag=function(t){var e=this.target.getMap();if(e&&(!this.target._getParent()&&!this.isDragging())){var r=t.domEvent;r.touches&&r.touches.length>1||2===r.button||(this.container=e._panels.mapWrapper||e._containerDOM,this.target.on("click",this._endDrag,this),this._lastCoord=this._correctCoord(t.coordinate),this._lastPoint=t.containerPoint,this._prepareDragHandler(),this._dragHandler.onMouseDown(t.domEvent),er(this.container,"mouseleave",this._endDrag,this),this._startParam=t,this._moved=!1)}},e.prototype._dragging=function(t){var e=this.target,r=e.getMap()._parseEvent(t.domEvent),n=r.domEvent;if(!(n.touches&&n.touches.length>1)){if(!this._moved)return this._moved=!0,e.on("symbolchange",this._onTargetUpdated,this),this._isDragging=!0,this._prepareShadow(),e.options.dragShadow||e.hide(),this._shadow._fireEvent("dragstart",r),this.target._fireEvent("dragstart",this._startParam||r),void delete this._startParam;if(this._shadow){var i=this._shadow.options.dragOnAxis,o=this._correctCoord(r.coordinate),a=r.containerPoint;this._lastPoint=this._lastPoint||a,this._lastCoord=this._lastCoord||o;var s=a.sub(this._lastPoint),h=o.sub(this._lastCoord);"x"===i?s.y=h.y=0:"y"===i&&(s.x=h.x=0),this._lastPoint=a,this._lastCoord=o,this._shadow.translate(h),e.options.dragShadow||e.translate(h),r.coordOffset=h,r.pointOffset=s,this._shadow._fireEvent("dragging",r),e._fireEvent("dragging",r)}}},e.prototype._endDrag=function(t){if(this._dragHandler&&(this._dragHandler.disable(),delete this._dragHandler),this.container&&rr(this.container,"mouseleave",this._endDrag,this),this.target){var e=this.target;e.off("click",this._endDrag,this),e.off("symbolchange",this._onTargetUpdated,this),delete this._lastCoord,delete this._lastPoint,this._isDragging=!1;var r=e.getMap();if(this.enabled()&&r){var n=r._parseEvent(t?t.domEvent:null);this._updateTargetAndRemoveShadow(n),this._moved&&e._fireEvent("dragend",n)}}},e.prototype.isDragging=function(){return!!this._isDragging},e.prototype._updateTargetAndRemoveShadow=function(t){var e=this.target,r=e.getMap();e.options.dragShadow||e.show();var n=this._shadow;n&&(e.options.dragShadow&&e.setCoordinates(n.getCoordinates()),n._fireEvent("dragend",t),n.remove(),delete this._shadow),this._shadowConnectors&&(r.getLayer(aa).removeGeometry(this._shadowConnectors),delete this._shadowConnectors),this._dragStageLayer&&this._dragStageLayer.remove()},e.prototype._correctCoord=function(t){var e=this.target.getMap();if(!e.getPitch())return t;var r=this.target._getPainter();if(!r.getMinAltitude())return t;var n=(r.getMinAltitude()+r.getMaxAltitude())/2;return e.locateByPoint(t,0,-n)},e}(dr);On.mergeOptions({draggable:!1,dragShadow:!0,dragOnAxis:null}),On.addInitHook("addHandler","draggable",ha),On.include({isDragging:function(){return this._getParent()?this._getParent().isDragging():!!this.draggable&&this.draggable.isDragging()}}),On.include({startEdit:function(t){return this.getMap()&&this.options.editable?(this.endEdit(),this._editor=new ia(this,t),this._editor.start(),this.fire("editstart"),this):this},endEdit:function(){return this._editor&&(this._editor.stop(),delete this._editor,this.fire("editend")),this},redoEdit:function(){return this.isEditing()?(this._editor.redo(),this.fire("redoedit"),this):this},undoEdit:function(){return this.isEditing()?(this._editor.undo(),this.fire("undoedit"),this):this},isEditing:function(){return!!this._editor&&this._editor.isEditing()}}),On.include({_onEvent:function(t,e){if(this.getMap()){var r=e||this._getEventTypeToFire(t);"contextmenu"===r&&this.listens("contextmenu")&&(He(t),Ue(t));var n=this._getEventParams(t);this._fireEvent(r,n)}},_getEventTypeToFire:function(t){return t.type},_getEventParams:function(t){var e=this.getMap(),r={domEvent:t},n=t.touches&&t.touches.length>0?t.touches[0]:t.changedTouches&&t.changedTouches.length>0?t.changedTouches[0]:t;if(n){var i=We(n,e._containerDOM);r.coordinate=e.containerPointToCoordinate(i),r.containerPoint=i,r.viewPoint=e.containerPointToViewPoint(i),r.pont2d=e._containerPointToPoint(i)}return r}}),On.include({setInfoWindow:function(t){return this.removeInfoWindow(),t instanceof fo?(this._infoWindow=t,this._infoWinOptions=_({},this._infoWindow.options),this._infoWindow.addTo(this),this):(this._infoWinOptions=_({},t),this._infoWindow?this._infoWindow.setOptions(t):this.getMap()&&this._bindInfoWindow(this._infoWinOptions),this)},getInfoWindow:function(){return this._infoWindow?this._infoWindow:null},openInfoWindow:function(t){return this.getMap()?(t||(t=this.getCenter()),this._infoWindow?this._infoWindow.show(t):this._infoWinOptions&&this.getMap()&&(this._bindInfoWindow(this._infoWinOptions),this._infoWindow.show(t)),this):this},closeInfoWindow:function(){return this._infoWindow&&this._infoWindow.hide(),this},removeInfoWindow:function(){return this._unbindInfoWindow(),delete this._infoWinOptions,delete this._infoWindow,this},_bindInfoWindow:function(t){return this._infoWindow=new fo(t),this._infoWindow.addTo(this),this},_unbindInfoWindow:function(){return this._infoWindow&&(this.closeInfoWindow(),this._infoWindow.remove(),delete this._infoWindow),this}});var ua=function(){function t(e,r){d(this,t),this.max=e,this.onRemove=r,this.reset()}return t.prototype.reset=function(){for(var t in this.data)this.onRemove(this.data[t]);return this.data={},this.order=[],this},t.prototype.clear=function(){this.reset(),delete this.onRemove},t.prototype.add=function(t,e){if(this.has(t))this.order.splice(this.order.indexOf(t),1),this.data[t]=e,this.order.push(t);else if(this.data[t]=e,this.order.push(t),this.order.length>this.max){var r=this.getAndRemove(this.order[0]);r&&this.onRemove(r)}return this},t.prototype.has=function(t){return t in this.data},t.prototype.keys=function(){return this.order},t.prototype.getAndRemove=function(t){if(!this.has(t))return null;var e=this.data[t];return delete this.data[t],this.order.splice(this.order.indexOf(t),1),e},t.prototype.get=function(t){return this.has(t)?this.data[t]:null},t.prototype.remove=function(t){if(!this.has(t))return this;var e=this.data[t];return delete this.data[t],this.onRemove(e),this.order.splice(this.order.indexOf(t),1),this},t.prototype.setMaxSize=function(t){for(this.max=t;this.order.length>this.max;){var e=this.getAndRemove(this.order[0]);e&&this.onRemove(e)}return this},t}(),la=function(t){function e(r){d(this,e);var n=m(this,t.call(this,r));return n.tilesInView={},n.tilesLoading={},n._parentTiles=[],n._childTiles=[],n.tileCache=new ua(r.options.maxCacheSize,n.deleteTile.bind(n)),n}return p(e,t),e.prototype.draw=function(){var t=this.getMap();if(this.isDrawable()){var e=this.prepareCanvas();if(!e||e.intersects(this.canvasExtent2D)){var r=this.layer.getTiles().tileGrids;if(r&&r.length){var n=0,i=!1,o={},a=[],s=[],h={},u=[],l={},c=[],f={},d={},p=this._markTiles(),m=this._getLoadLimit(),g=r.length;this._tileZoom=r[0].zoom,this._tileOffset=r[0].offset;for(var _=0;_<g;_++)for(var y=r[_],v=y.tiles,x=this._generatePlaceHolder(y.zoom),b=0,w=v.length;b<w;b++){var T=v[b],E=T.id,C=this._getCachedTile(E),S=!1;if(this._isLoadingTile(E))S=i=!0,this.tilesLoading[E].current=!0;else if(C)this.getTileOpacity(C.image)<1&&(S=i=!0),a.push(C);else{S=i=!0,m&&n+p[0]>m||t.isInteracting()&&!t.isMoving()&&!t.isRotating()||(n++,d[E+"@"+T.point.toArray().join()]=T)}if(S&&!o[T.dupKey]){o[T.dupKey]=1,x&&!f[T.dupKey]&&(T.cache=!1,c.push({image:x,info:T}),f[T.dupKey]=1);var A=this._findParentTile(T);if(A){var M=A.info.dupKey;void 0===h[M]&&(h[M]=s.length,s.push(A))}else{var P=this._findChildTiles(T);P.length&&P.forEach(function(t){l[t.info.dupKey]||(u.push(t),l[t.info.dupKey]=1)})}}}this._drawTiles(a,s,u,c),n?this.loadTileQueue(d):i||(!t.isAnimating()&&this._parentTiles.length>0&&(this._parentTiles=[],this._childTiles=[],this.setToRedraw()),this.completeRender()),this._retireTiles()}else this.completeRender()}else this.completeRender()}},e.prototype.isTileCachedOrLoading=function(t){return this.tilesLoading[t]||this.tilesInView[t]||this.tileCache.has(t)},e.prototype._drawTiles=function(t,e,r,n){var i=this;e.length&&(e.sort(function(t,e){return Math.abs(e.info.z-i._tileZoom)-Math.abs(t.info.z-i._tileZoom)}),this._parentTiles=e),r.length&&(this._childTiles=r);var o={tiles:t,parentTiles:e,childTiles:r};this.onDrawTileStart(o),this._parentTiles.forEach(function(t){return i._drawTileAndCache(t)}),this._childTiles.forEach(function(t){return i._drawTileOffset(t.info,t.image)}),n.forEach(function(t){return i._drawTileOffset(t.info,t.image)});var a=this.layer,s=this.getMap();if(!a.options.cascadeTiles||s.getPitch()<=a.options.minPitchToCascade)t.forEach(function(t){return i._drawTileAndCache(t)});else{this.writeZoomStencil();for(var h=!1,u=0,l=t.length;u<l;u++)t[u].info.z!==this._tileZoom?h?this.resumeZoomStencilTest():(this.startZoomStencilTest(),h=!0):h&&this.pauseZoomStencilTest(),this._drawTileAndCache(t[u]);this.endZoomStencilTest()}this.onDrawTileEnd(o)},e.prototype.writeZoomStencil=function(){},e.prototype.startZoomStencilTest=function(){},e.prototype.endZoomStencilTest=function(){},e.prototype.pauseZoomStencilTest=function(){},e.prototype.resumeZoomStencilTest=function(){},e.prototype.onDrawTileStart=function(){},e.prototype.onDrawTileEnd=function(){},e.prototype._drawTileOffset=function(t,e){var r=this._tileOffset;if(r[0]||r[1]){var n=this.getMap(),i=n._getResolution(this._tileZoom)/n._getResolution(t.z);r[0]*=i,r[1]*=i,t.point._sub(r),t.extent2d._sub(r),this.drawTile(t,e),t.point._add(r),t.extent2d._add(r),r[0]/=i,r[1]/=i}else this.drawTile(t,e)},e.prototype._drawTileAndCache=function(t){t.current=!0,this.tilesInView[t.info.id]=t,this._drawTileOffset(t.info,t.image),this.tileCache.add(t.info.id,t)},e.prototype.drawOnInteracting=function(){this.draw()},e.prototype.needToRedraw=function(){var e=this.getMap();return e.getPitch()?t.prototype.needToRedraw.call(this):!(!e.isRotating()&&!e.isZooming())||(e.isMoving()?!!this.layer.options.forceRenderOnMoving:t.prototype.needToRedraw.call(this))},e.prototype.hitDetect=function(){return!1},e.prototype._getLoadLimit=function(){return this.getMap().isInteracting()?this.layer.options.loadingLimitOnInteracting:0},e.prototype.isDrawable=function(){return!this.getMap().getPitch()||(console&&console.warn("TileLayer with canvas renderer can't be pitched, use gl renderer ('renderer' : 'gl') instead."),this.clear(),!1)},e.prototype.clear=function(){this._retireTiles(!0),this.tileCache.reset(),this.tilesInView={},this.tilesLoading={},this._parentTiles=[],this._childTiles=[],t.prototype.clear.call(this)},e.prototype._isLoadingTile=function(t){return!!this.tilesLoading[t]},e.prototype.clipCanvas=function(e){return this.layer.getMask()?t.prototype.clipCanvas.call(this,e):this._clipByPitch(e)},e.prototype._clipByPitch=function(t){var e=this.getMap();if(e.getPitch()<=e.options.maxVisualPitch)return!1;if(!this.layer.options.clipByPitch)return!1;var r=e.getContainerExtent(),n=ue.retina?2:1;return t.save(),t.strokeStyle="rgba(0, 0, 0, 0)",t.beginPath(),t.rect(0,Math.ceil(r.ymin)*n,Math.ceil(r.getWidth())*n,Math.ceil(r.getHeight())*n),t.stroke(),t.clip(),!0},e.prototype.loadTileQueue=function(t){for(var e in t)if(t.hasOwnProperty(e)){var r=t[e],n=this.loadTile(r);void 0===n.loadTime&&(this.tilesLoading[r.id]={image:n,current:!0,info:r})}},e.prototype.loadTile=function(t){var e=this.layer.getTileSize(),r=new Image;r.width=e.width,r.height=e.height,r.onload=this.onTileLoad.bind(this,r,t),r.onerror=this.onTileError.bind(this,r,t);var n=this.layer.options.crossOrigin;return y(n)||(r.crossOrigin=n),this.loadTileImage(r,t.url),r},e.prototype.loadTileImage=function(t,e){return k(t,[e])},e.prototype.abortTileLoading=function(t){t&&(t.onload=ca,t.onerror=ca,t.src=nt)},e.prototype.onTileLoad=function(t,e){if(this.layer){var r=e.id;this.tilesInView&&(t.loadTime=g(),delete this.tilesLoading[r],this._addTileToCache(e,t),this.setToRedraw(),this.layer.fire("tileload",{tile:e,tileImage:t}))}},e.prototype.onTileError=function(t,e){this.layer&&(t instanceof Image&&this.abortTileLoading(t),t.loadTime=0,delete this.tilesLoading[e.id],this._addTileToCache(e,t),this.setToRedraw(),this.layer.fire("tileerror",{tile:e}))},e.prototype.drawTile=function(t,e){if(e&&this.getMap()){var r=t.point,n=t.z,i=t.id,o=this.getMap(),a=t.size,s=o.getZoom(),h=this.context,u=o._pointToContainerPoint(r,n),l=o.getBearing(),c=l||s!==n,f=this.getTileOpacity(e),d=h.globalAlpha;f<1&&(h.globalAlpha=f,this.setToRedraw()),c||u._round();var p=u.x,m=u.y,g=a[0],_=a[1];if(c){if(g++,_++,h.save(),h.translate(p,m),l&&h.rotate(-l*Math.PI/180),s!==n){var y=o._getResolution(n)/o._getResolution();h.scale(y,y)}p=m=0}if(ar.image(h,e,p,m,g,_),this.layer.options.debug){var v=new ce(p,m),x=this.layer.options.debugOutline,b=i.split("__");h.save(),h.strokeStyle=x,h.fillStyle=x,h.strokeWidth=10,h.font="15px monospace",ar.rectangle(h,v,a,1,0),ar.fillText(h,"x:"+b[2]+", y:"+b[1]+", z:"+b[3],v.add(10,20),x),ar.drawCross(h,v.add(g/2,_/2),2,x),h.restore()}c&&h.restore(),h.globalAlpha!==d&&(h.globalAlpha=d),this.setCanvasUpdated()}},e.prototype._findChildTiles=function(t){var e=this._getLayerOfTile(t.layer);if(!e.options.background)return[];for(var r=this.getMap(),n=[],i=t.extent2d.getMin(),o=t.extent2d.getMax(),a=e._project(r._pointToPrj(i,t.z)),s=e._project(r._pointToPrj(o,t.z)),h=1;h<3;h++)this._findChildTilesAt(n,a,s,e,t.z+h);return n},e.prototype._findChildTilesAt=function(t,e,r,n,i){for(var o=n.getId(),a=n.getSpatialReference().getResolution(i),s=n._getTileConfig().getTileIndex(e,a),h=n._getTileConfig().getTileIndex(r,a),u=Math.min(s.idx,h.idx),l=Math.max(s.idx,h.idx),c=Math.min(s.idy,h.idy),f=Math.max(s.idy,h.idy),d=void 0,p=void 0,m=u;m<l;m++)for(var g=c;g<f;g++)d=n._getTileId({idx:m,idy:g},i,o),this.tileCache.has(d)&&(p=this.tileCache.getAndRemove(d),t.push(p),this.tileCache.add(d,p))},e.prototype._findParentTile=function(t){var e=this.getMap(),r=this._getLayerOfTile(t.layer);if(!r.options.background)return null;for(var n=r.getSpatialReference(),i=n.getZoomDirection(),o=r.options.backgroundZoomDiff,a=t.extent2d.getCenter(),s=r._project(e._pointToPrj(a,t.z)),h=1;h<=o;h++){var u=t.z-i*h,l=n.getResolution(u),c=r._getTileConfig().getTileIndex(s,l),f=r._getTileId(c,u,t.layer);if(this.tileCache.has(f)){var d=this.tileCache.getAndRemove(f);return this.tileCache.add(f,d),d}}return null},e.prototype._getLayerOfTile=function(t){return this.layer.getChildLayer?this.layer.getChildLayer(t):this.layer},e.prototype._getCachedTile=function(t){var e=this.tilesInView,r=this.tileCache.getAndRemove(t);if(r){e[t]=r;var n=this.tilesLoading;n&&n[t]&&(n[t].current=!1,this.abortTileLoading(n[t]),delete n[t])}else r=e[t];return r},e.prototype._addTileToCache=function(t,e){this.tilesInView[t.id]={image:e,current:!0,info:t}},e.prototype.getTileOpacity=function(t){return this.layer.options.fadeAnimation&&t.loadTime?Math.min(1,(g()-t.loadTime)/(1e3/60*10)):1},e.prototype.onRemove=function(){this.clear(),delete this.tileCache,delete this._tilePlaceHolder,t.prototype.onRemove.call(this)},e.prototype._markTiles=function(){var t=0,e=0;if(this.tilesLoading)for(var r in this.tilesLoading)this.tilesLoading[r].current=!1,t++;if(this.tilesInView)for(var n in this.tilesInView)this.tilesInView[n].current=!1,e++;return[t,e]},e.prototype._retireTiles=function(t){for(var e in this.tilesLoading){var r=this.tilesLoading[e];!t&&r.current||(r.image&&this.abortTileLoading(r.image),this.deleteTile(r),delete this.tilesLoading[e])}for(var n in this.tilesInView){var i=this.tilesInView[n];i.current||(delete this.tilesInView[n],this.tileCache.has(n)||this.deleteTile(i))}},e.prototype.deleteTile=function(t){t&&t.image&&(t.image.onload=null,t.image.onerror=null)},e.prototype._generatePlaceHolder=function(t){var e=this.getMap(),r=this.layer.options.placeholder;if(!r||e.getPitch())return null;var n=this.layer.getTileSize(),i=e._getResolution(t)/e._getResolution(),o=this._tilePlaceHolder=this._tilePlaceHolder||ar.createCanvas(1,1);return o.width=n.width*i,o.height=n.height*i,T(r)?r(o):function(t){var e=t.getContext("2d"),r=t.width,n=t.height,i=r/16,o=n/16;e.beginPath();for(var a=0;a<16;a++)e.moveTo(0,a*o),e.lineTo(r,a*o),e.moveTo(a*i,0),e.lineTo(a*i,n);e.strokeStyle="rgba(180, 180, 180, 0.1)",e.lineWidth=1,e.stroke(),e.beginPath();for(var s=[[0,0],[r,0],[0,n],[r,n],[0,0],[0,n],[r,0],[r,n],[0,n/2],[r,n/2],[r/2,0],[r/2,n]],h=1;h<s.length;h+=2)e.moveTo(s[h-1][0],s[h-1][1]),e.lineTo(s[h][0],s[h][1]);e.lineWidth=4,e.stroke()}(o),o},e}(Kr);function ca(){return!1}Do.registerRenderer("canvas",la);var fa=function(t){function e(){return d(this,e),m(this,t.apply(this,arguments))}return p(e,t),e.prototype.isDrawable=function(){return!0},e.prototype.needToRedraw=function(){var e=this.getMap();return!(!this._gl()||e.getPitch()||!e.isZooming()||e.isMoving()||e.isRotating())||t.prototype.needToRedraw.call(this)},e.prototype.drawTile=function(e,r){var n=this.getMap();if(e&&n&&r.src!==nt){var i=n.getGLScale(e.z),o=e.size[0]*i,a=e.size[1]*i;if(!1!==e.cache&&this._bindGLBuffer(r,o,a),this._gl()){var s=e.point,h=s.x*i,u=s.y*i,l=this.getTileOpacity(r);this.drawGLImage(r,h,u,o,a,l),l<1?this.setToRedraw():this.setCanvasUpdated()}else t.prototype.drawTile.call(this,e,r)}},e.prototype.writeZoomStencil=function(){var t=this.gl;t.stencilFunc(t.ALWAYS,1,255),t.stencilOp(t.KEEP,t.KEEP,t.REPLACE)},e.prototype.startZoomStencilTest=function(){var t=this.gl;t.stencilOp(t.KEEP,t.KEEP,t.KEEP),t.stencilFunc(t.EQUAL,0,255)},e.prototype.endZoomStencilTest=function(){this.pauseZoomStencilTest()},e.prototype.pauseZoomStencilTest=function(){var t=this.gl;t.stencilFunc(t.ALWAYS,1,255)},e.prototype.resumeZoomStencilTest=function(){var t=this.gl;t.stencilFunc(t.EQUAL,0,255)},e.prototype._bindGLBuffer=function(t,e,r){t.glBuffer||(t.glBuffer=this.bufferTileData(0,0,e,r))},e.prototype.loadTileImage=function(t,e){t.crossOrigin=this.layer.options.crossOrigin||"",t.src=e},e.prototype.onCanvasCreate=function(){this.createCanvas2()},e.prototype.createContext=function(){t.prototype.createContext.call(this),this.createGLContext()},e.prototype.resizeCanvas=function(e){this.canvas&&(t.prototype.resizeCanvas.call(this,e),this.resizeGLCanvas())},e.prototype.clearCanvas=function(){this.canvas&&(t.prototype.clearCanvas.call(this),this.clearGLCanvas())},e.prototype.getCanvasImage=function(){if(!this._gl())return t.prototype.getCanvasImage.call(this);var e=t.prototype.getCanvasImage.call(this);return e&&(e.image=this.canvas2),e},e.prototype._gl=function(){return this.getMap()&&!!this.getMap().getPitch()||this.layer&&!!this.layer.options.fragmentShader},e.prototype.deleteTile=function(e){t.prototype.deleteTile.call(this,e),e&&e.image&&this.disposeImage(e.image)},e.prototype.onRemove=function(){this.removeGLCanvas()},e}(Wo(la));function da(t){var e=this.layer.getTileSize(),r=this.canvas.constructor,n=this.getMap(),i=ue.retina?2:1,o=ar.createCanvas(e.width*i,e.height*i,r);o.layer=this.layer;var a=this,s=new Er(n.pointToCoordinate(t.point),n.pointToCoordinate(t.point.add(e.toPoint())),n.getProjection());return this.layer.drawTile(o,{url:t.url,point:t.point,center:n.pointToCoordinate(t.point.add(e.width/2,e.height/2)),extent:s,z:t.z,x:t.x,y:t.y},function(e){e?a.onTileError(o,t):a.onTileLoad(o,t)}),o}Do.registerRenderer("gl",fa);var pa=function(t){function e(){return d(this,e),m(this,t.apply(this,arguments))}return p(e,t),e.prototype.loadTile=function(){return da.apply(this,arguments)},e}(la),ma=function(t){function e(){return d(this,e),m(this,t.apply(this,arguments))}return p(e,t),e.prototype.loadTile=function(){return da.apply(this,arguments)},e}(la);Bo.registerRenderer("canvas",pa),Bo.registerRenderer("gl",ma);var ga=function(t){function e(){return d(this,e),m(this,t.apply(this,arguments))}return p(e,t),e.prototype.checkResources=function(){var t=this._geosToCheck;if(this._resourceChecked||t||(t=this.layer._geoList),!X(t))return[];for(var e=[],r={},n=t.length-1;n>=0;n--){var i=t[n]._getExternalResources();if(i.length)if(this.resources)for(var o=0;o<i.length;o++){var a=i[o][0];this.resources.isResourceLoaded(i[o])||r[a]||(e.push(i[o]),r[a]=1)}else e.push.apply(e,i)}return this._resourceChecked=!0,delete this._geosToCheck,e},e.prototype.render=function(){return this.layer._sortGeometries(),t.prototype.render.apply(this,arguments)},e.prototype._addGeoToCheckRes=function(t){t&&(Array.isArray(t)||(t=[t]),this._geosToCheck||(this._geosToCheck=[]),B(this._geosToCheck,t))},e.prototype.onGeometryAdd=function(t){this._addGeoToCheckRes(t),_a(this)},e.prototype.onGeometryRemove=function(){_a(this)},e.prototype.onGeometrySymbolChange=function(t){this._addGeoToCheckRes(t.target),_a(this)},e.prototype.onGeometryShapeChange=function(){_a(this)},e.prototype.onGeometryPositionChange=function(){_a(this)},e.prototype.onGeometryZIndexChange=function(){_a(this)},e.prototype.onGeometryShow=function(){_a(this)},e.prototype.onGeometryHide=function(){_a(this)},e.prototype.onGeometryPropertiesChange=function(){_a(this)},e}(Kr);function _a(t){t.layer.options.drawImmediate&&t.render(),t.setToRedraw()}var ya=function(t){function e(){return d(this,e),m(this,t.apply(this,arguments))}return p(e,t),e.prototype.checkResources=function(){var e=this,r=t.prototype.checkResources.apply(this,arguments),n=this.layer.getStyle();return n&&(Array.isArray(n)||(n=[n]),n.forEach(function(t){for(var n=kt(t.symbol,!0),i=0,o=n.length;i<o;i++)e.resources.isResourceLoaded(n[i])||r.push(n[i])})),r},e.prototype.needToRedraw=function(){var e=this.getMap();return!(!e.isInteracting()||!this.layer.options.enableAltitude)||!(e.isZooming()&&!e.isRotating()&&!e.getPitch()&&!this._hasPoint&&this.layer.constructor===Ti)&&t.prototype.needToRedraw.call(this)},e.prototype.draw=function(){if(this.getMap()){if(!this.layer.isVisible()||this.layer.isEmpty())return this.clearCanvas(),void this.completeRender();this.prepareCanvas(),this.drawGeos(),this.completeRender()}},e.prototype.isBlank=function(){return!!this.context&&!this.context.canvas._drawn},e.prototype.drawOnInteracting=function(){if(this._geosToDraw){this._updateDisplayExtent();for(var t=0,e=this._geosToDraw.length;t<e;t++)this._geosToDraw[t].isVisible()&&this._geosToDraw[t]._paint(this._displayExtent)}},e.prototype.show=function(){this.layer.forEach(function(t){t._repaint()}),t.prototype.show.apply(this,arguments)},e.prototype.forEachGeo=function(t,e){this.layer.forEach(t,e)},e.prototype.drawGeos=function(){this._updateDisplayExtent(),this.prepareToDraw(),this.forEachGeo(this.checkGeo,this);for(var t=0,e=this._geosToDraw.length;t<e;t++)this._geosToDraw[t]._paint()},e.prototype.prepareToDraw=function(){this._hasPoint=!1,this._geosToDraw=[]},e.prototype.checkGeo=function(t){if(t&&t.isVisible()&&t.getMap()&&t.getLayer()&&t.getLayer().isCanvasRender()){var e=t._getPainter(),r=e.get2DExtent(this.resources);r&&r.intersects(this._displayExtent)&&(e.hasPoint()&&(this._hasPoint=!0),this._geosToDraw.push(t))}},e.prototype.onZoomEnd=function(){delete this.canvasExtent2D,t.prototype.onZoomEnd.apply(this,arguments)},e.prototype.onRemove=function(){this.forEachGeo(function(t){t.onHide()}),delete this._geosToDraw},e.prototype.onGeometryPropertiesChange=function(e){e&&this.layer._styleGeometry(e.target),t.prototype.onGeometryPropertiesChange.call(this,e)},e.prototype._updateDisplayExtent=function(){var t=this.canvasExtent2D;if(this._maskExtent){if(!this._maskExtent.intersects(t))return void this.completeRender();t=t.intersection(this._maskExtent)}this._displayExtent=t},e.prototype.identify=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=this._geosToDraw;return r?this.layer._hitGeos(r,t,e):[]},e}(ga);Ti.registerRenderer("canvas",ya);var va=function(t){function e(r){d(this,e);var n=m(this,t.call(this));return n.map=r,n._handlerQueue={},n}return p(e,t),e.prototype.callInNextFrame=function(t){this._handlerQueue.push(t)},e.prototype.executeFrameCallbacks=function(){var t=this._handlerQueue;this._handlerQueue=[];for(var e=0,r=t.length;e<r;e++)t[e]()},e.prototype.offsetPlatform=function(t){if(!this.map._panels.front)return this;if(0===t.x&&0===t.y)return this;var e=this.map.offsetPlatform().add(t)._round(),r=this.map._panels;return Ge(r.back,e),Ge(r.front,e),this},e.prototype.resetContainer=function(){if(this.map&&(this.map._resetMapViewPoint(),this.map._panels.front)){var t=new ce(0,0);Ge(this.map._panels.back,t),Ge(this.map._panels.front,t)}},e.prototype.onZoomEnd=function(){this.resetContainer()},e.prototype.onLoad=function(){this._frameLoop()},e}(pr),xa=function(t){function e(r){d(this,e);var n=m(this,t.call(this,r));return n._containerIsCanvas=!!r._containerDOM.getContext,n._registerEvents(),n._loopTime=0,n}return p(e,t),e.prototype.load=function(){this.initContainer()},e.prototype.renderFrame=function(t){if(!this.map)return!1;var e=this.map;e._fireEvent("framestart"),this.updateMapDOM();var r=this._getAllLayerToRender();return this.drawLayers(r,t),this.drawLayerCanvas(r),e._fireEvent("frameend"),this._recordView(),this._mapview=this._getMapView(),delete this._spatialRefChanged,this._fireLayerLoadEvents(),this.executeFrameCallbacks(),this._needRedraw=!1,!0},e.prototype.updateMapDOM=function(){var t=this.map;if(!t.isZooming()){var e=t._getViewPointFrameOffset();e&&t.offsetPlatform(e)}},e.prototype.drawLayers=function(t,e){for(var r=this.map,n=r.isInteracting(),i=[],o=[],a=r.options.fpsOnInteracting||0,s=0===a?0:1e3/a,h=this.map.options.layerCanvasLimitOnInteracting,u=t.length,l=r.getBaseLayer(),c=0,f=0;f<u;f++){var d=t[f];if(d.isVisible()){var p=d.isCanvasRender();p&&i.push(d.getId());var m=d._getRenderer();if(m){var g=this._checkLayerRedraw(d);if(p&&m.isCanvasUpdated()&&(g||o.push(d.getId()),this.setToRedraw()),delete m.__shouldZoomTransform,g){if(n&&p){if(h>0&&u-1-f>h&&d!==l){d._getRenderer().clearCanvas();continue}c+=this._drawCanvasLayerOnInteracting(d,c,s,e)}else n&&m.drawOnInteracting?(m.prepareRender&&m.prepareRender(),m.drawOnInteracting(this._eventParam,e)):m.render(e);p&&(o.push(d.getId()),this.setToRedraw())}else p&&n&&(r.isZooming()&&!r.getPitch()?(m.prepareRender(),m.__shouldZoomTransform=!0):(r.getPitch()||r.isRotating())&&m.clearCanvas())}}}var _=this._canvasIds||[],y=this._updatedIds||[];if(this._canvasIds=i,this._updatedIds=o,!this._needToRedraw()){_.join("---")===i.join("---")&&y.join("---")===o.join("---")||this.setToRedraw()}},e.prototype._checkLayerRedraw=function(t){if(this.isSpatialReferenceChanged())return!0;var e=this.map,r=t._getRenderer();return t.isCanvasRender()?r.testIfNeedRedraw():!(!r.needToRedraw||!r.needToRedraw())||(e.isInteracting()||this.isViewChanged())},e.prototype._drawCanvasLayerOnInteracting=function(t,e,r,n){var i=this.map,o=t._getRenderer(),a=o.getDrawTime(),s=0===r||r>0&&e+a<=r;if(o.mustRenderOnInteracting&&o.mustRenderOnInteracting())o.render(n);else{if(o.drawOnInteracting&&(t===i.getBaseLayer()||s||i.isZooming()&&t.options.forceRenderOnZooming||i.isMoving()&&t.options.forceRenderOnMoving||i.isRotating()&&t.options.forceRenderOnRotating))return o.prepareRender(),o.prepareCanvas(),o.drawOnInteracting(this._eventParam,n),a;!i.isZooming()||i.getPitch()||i.isRotating()?(i.getPitch()||i.isRotating())&&o.clearCanvas():(o.prepareRender(),o.__shouldZoomTransform=!0)}return o.drawOnInteracting&&!s&&o.onSkipDrawOnInteracting(this._eventParam,n),0},e.prototype._fireLayerLoadEvents=function(){if(this._updatedIds&&this._updatedIds.length>0){var t=this.map;this._updatedIds.reverse().forEach(function(e){var r=t.getLayer(e);if(r){var n=r._getRenderer();n&&n.isRenderComplete()&&r.fire("layerload")}})}},e.prototype._needToRedraw=function(){return this._needRedraw},e.prototype.setToRedraw=function(){this._needRedraw=!0},e.prototype.drawLayerCanvas=function(t){var e=this.map;if(e&&(this._needToRedraw()||this.isViewChanged())){this.canvas||this.createCanvas(),e._fireEvent("renderstart",{context:this.context}),this._updateCanvasSize()||this.clearCanvas();for(var r=e.isInteracting(),n=e.options.layerCanvasLimitOnInteracting,i=t.length,o=void 0,a=[],s=0;s<i;s++){if(t[s].isVisible()&&t[s].isCanvasRender())if(t[s]._getRenderer()){var h=this._getLayerImage(t[s]);h&&h.image&&(t[s]===e.getBaseLayer()?o=[t[s],h]:a.push([t[s],h]))}}o&&(this._drawLayerCanvasImage(o[0],o[1]),this._drawFog()),i=a.length;for(var u=r&&n>=0&&i>n?i-n:0;u<i;u++)this._drawLayerCanvasImage(a[u][0],a[u][1]);this._drawCenterCross(),e._fireEvent("renderend",{context:this.context})}},e.prototype.updateMapSize=function(t){if(t&&!this._containerIsCanvas){var e=t.width+"px",r=t.height+"px",n=this.map._panels;n.mapWrapper.style.width=e,n.mapWrapper.style.height=r,this._updateCanvasSize()}},e.prototype.getMainPanel=function(){return this.map?this._containerIsCanvas?this.map._containerDOM:this.map._panels?this.map._panels.mapWrapper:null:null},e.prototype.toDataURL=function(t){return this.canvas?this.canvas.toDataURL(t):null},e.prototype.remove=function(){ue.webgl&&"undefined"!=typeof document&&Be(document,"visibilitychange",this._onVisibilitychange),this._resizeInterval&&clearInterval(this._resizeInterval),delete this.context,delete this.canvas,delete this.map,delete this._spatialRefChanged,this._cancelFrameLoop()},e.prototype.hitDetect=function(t){var e=this.map;if(e&&e.options.hitDetect&&!e.isInteracting()){for(var r=e._getLayers(),n="default",i=e.options.hitDetectLimit||0,o=0,a=r.length-1;a>=0;a--){var s=r[a];if(!s.isEmpty||!s.isEmpty()){var h=s._getRenderer();if(h&&h.hitDetect&&(!h.isBlank||!h.isBlank())){if("default"!==s.options.cursor&&h.hitDetect(t)){n=s.options.cursor||"pointer";break}if(i>0&&++o>i)break}}}e._trySetCursor(n)}},e.prototype._getLayerImage=function(t){var e=t._getRenderer();return e.getCanvasImage?e.getCanvasImage():null},e.prototype.initContainer=function(){var t=this.map._panels;function e(e,r,n,i){var o=De("div",r);return n&&(o.style.cssText=n),t[e]=o,i||je(o),o}var r=this.map._containerDOM;if(!this._containerIsCanvas){r.innerHTML="";var n="position:absolute;top:0px;left:0px;",i=e("mapWrapper","maptalks-wrapper","position:absolute;overflow:hidden;",!0),o=e("allLayers","maptalks-all-layers",n+"padding:0px;margin:0px;z-index:0;overflow:visible;",!0),a=e("backStatic","maptalks-back-static",n+"z-index:0;",!0),s=e("back","maptalks-back",n+"z-index:1;"),h=e("backLayer","maptalks-back-layer",n),u=e("canvasContainer","maptalks-canvas-layer",n+"border:none;z-index:2;"),l=e("frontStatic","maptalks-front-static",n+"z-index:3;",!0),c=e("front","maptalks-front",n+"z-index:4;",!0),f=e("frontLayer","maptalks-front-layer",n+"z-index:0;"),d=e("ui","maptalks-ui",n+"border:none;z-index:1;",!0),p=e("control","maptalks-control","z-index:1",!0);r.appendChild(i),o.appendChild(a),s.appendChild(h),o.appendChild(s),o.appendChild(u),c.appendChild(f),o.appendChild(l),o.appendChild(c),c.appendChild(d),i.appendChild(o),i.appendChild(p),this.createCanvas(),this.resetContainer();var m=this.map._getContainerDomSize();this.updateMapSize(m)}},e.prototype.isViewChanged=function(){var t=this._mapview,e=this._getMapView();return!t||!it(t,e)},e.prototype._recordView=function(){var t=this.map;!t._onViewChange||t.isInteracting()||t.isAnimating()||it(t.getView(),t._getCurrentView())||t._onViewChange(t.getView())},e.prototype.isSpatialReferenceChanged=function(){return this._spatialRefChanged},e.prototype._getMapView=function(){var t=this.map,e=t._getPrjCenter();return{x:e.x,y:e.y,zoom:t.getZoom(),pitch:t.getPitch(),bearing:t.getBearing(),width:t.width,height:t.height}},e.prototype._frameLoop=function(t){var e=this;this.map?(this.renderFrame(t),this._animationFrame=R(function(t){e._frameLoop(t)})):this._cancelFrameLoop()},e.prototype._cancelFrameLoop=function(){this._animationFrame&&L(this._animationFrame)},e.prototype._drawLayerCanvasImage=function(t,e){var r=this.context,n=e.point.round();ue.retina&&n._multi(2);var i=e.image;if(!(n.x+i.width<=0||n.y+i.height<=0)){var o=t.options.opacity;if(v(o)||(o=1),!(o<=0)){var a=e.opacity;if(v(a)||(a=1),!(a<=0)){var s=r.globalAlpha;o<1&&(r.globalAlpha*=o),a<1&&(r.globalAlpha*=a),t.options.cssFilter&&(r.filter=t.options.cssFilter);var h=this._zoomMatrix,u=!!t._getRenderer().__shouldZoomTransform,l=t.getRenderer().clipCanvas(this.context);h&&u&&(r.save(),r.setTransform.apply(r,h)),r.drawImage(i,n.x,n.y),h&&u&&r.restore(),l&&r.restore(),"none"!==r.filter&&(r.filter="none"),r.globalAlpha=s}}}},e.prototype._drawCenterCross=function(){var t=this.map.options.centerCross;if(t){var e=this.context,r=new ce(this.canvas.width/2,this.canvas.height/2);T(t)?t(e,r):ar.drawCross(this.context,r,2,"#f00")}},e.prototype._drawFog=function(){var t=this.map;if(!(t.getPitch()<=t.options.maxVisualPitch)&&t.options.fog){var e=ue.retina?2:1,r=this.context,n=t.getContainerExtent(),i=(t.height-t._getVisualHeight(75))*e;i<0&&(i=0);var o=n.ymin*e,a=Math.ceil(o-i),s=t.options.fogColor.join(),h=r.createLinearGradient(0,i,0,o+30),u=1-30/(a+30);h.addColorStop(0,"rgba("+s+", 0)"),h.addColorStop(.3,"rgba("+s+", 0.3)"),h.addColorStop(u,"rgba("+s+", 1)"),h.addColorStop(1,"rgba("+s+", 0)"),r.beginPath(),r.fillStyle=h,r.fillRect(0,i,Math.ceil(n.getWidth())*e,Math.ceil(a+30))}},e.prototype._getAllLayerToRender=function(){return this.map._getLayers()},e.prototype.clearCanvas=function(){this.canvas&&ar.clearRect(this.context,0,0,this.canvas.width,this.canvas.height)},e.prototype._updateCanvasSize=function(){if(!this.canvas||this._containerIsCanvas)return!1;var t=this.map.getSize(),e=this.canvas,r=ue.retina?2:1;return(t.width*r!==e.width||t.height*r!==e.height)&&(e.height=r*t.height,e.width=r*t.width,e.style&&(e.style.width=t.width+"px",e.style.height=t.height+"px"),!0)},e.prototype.createCanvas=function(){this._containerIsCanvas?this.canvas=this.map._containerDOM:(this.canvas=De("canvas"),this._updateCanvasSize(),this.map._panels.canvasContainer.appendChild(this.canvas)),this.context=this.canvas.getContext("2d")},e.prototype._checkSize=function(){this.map&&!this.map.isInteracting()&&(Ve(this.map._containerDOM),this.map.checkSize())},e.prototype._setCheckSizeInterval=function(t){var e=this;clearInterval(this._resizeInterval),this._checkSizeInterval=t,this._resizeInterval=setInterval(function(){!e.map||e.map.isRemoved()?clearInterval(e._resizeInterval):e._checkSize()},this._checkSizeInterval)},e.prototype._registerEvents=function(){var t=this,e=this.map;e.options.checkSize&&!P&&"undefined"!=typeof window&&this._setCheckSizeInterval(1e3),ue.mobile||e.on("_mousemove",this._onMapMouseMove,this),e.on("_dragrotatestart _dragrotating _dragrotateend _movestart _moving _moveend _zoomstart",function(e){t._eventParam=e}),e.on("_zooming",function(r){e.getPitch()||(t._zoomMatrix=r.matrix.container),t._eventParam=r}),e.on("_zoomend",function(e){t._eventParam=e,delete t._zoomMatrix}),e.on("_spatialreferencechange",function(){t._spatialRefChanged=!0}),ue.webgl&&"undefined"!=typeof document&&Fe(document,"visibilitychange",this._onVisibilitychange,this)},e.prototype._onMapMouseMove=function(t){var e=this,r=this.map;!r.isInteracting()&&r.options.hitDetect&&(this._hitDetectFrame&&L(this._hitDetectFrame),this._hitDetectFrame=R(function(){e.hitDetect(t.containerPoint)}))},e.prototype._getCanvasLayers=function(){return this.map._getLayers(function(t){return t.isCanvasRender()})},e.prototype._onVisibilitychange=function(){if("visible"===document.visibilityState)for(var t=this._getAllLayerToRender(),e=0,r=t.length;e<r;e++){var n=t[e].getRenderer();n&&n.canvas&&n.setToRedraw&&n.setToRedraw()}},e}(va);on.registerRenderer("canvas",xa),on.mergeOptions({fog:!0,fogColor:[233,233,233]});var ba=Object.freeze({ResourceCache:Qr,CanvasRenderer:Kr,ImageGLRenderable:Wo,MapRenderer:va,MapCanvasRenderer:xa,Renderable:Zr,ImageLayerCanvasRenderer:Yo,ImageLayerGLRenderer:Jo,TileLayerCanvasRenderer:la,TileLayerGLRenderer:fa,CanvasTileLayerCanvasRenderer:pa,CanvasTileLayerGLRenderer:ma,OverlayLayerCanvasRenderer:ga,VectorLayerCanvasRenderer:ya,CanvasLayerRenderer:Ko}),wa={_getRenderPoints:function(){return[[this._getCenter2DPoint(this.getMap().getGLZoom())],null]}};Zn.include(wa),oi.include(wa),ii.include(wa),si.include(wa),ai.include({_getRenderPoints:function(t){var e=this.getMap();if("vertex"===t){for(var r=this._trimRing(this.getShell()),n=[],i=0,o=r.length;i<o;i++)n.push(e.coordToPoint(r[i],e.getGLZoom()));return[n,null]}return[[e.coordToPoint(this.getCenter(),e.getGLZoom())],null]}});var Ta={_getRenderPoints:function(t){var e=this.getMap(),r=e.getGLZoom(),n=void 0,i=null;if("point"===t)(n=this._getPath2DPoints(this._getPrjCoordinates(),!1,r))&&n.length>0&&Array.isArray(n[0])&&(n=n[0].concat(n[1]));else if("vertex"===t)if(i=[],(n=this._getPath2DPoints(this._getPrjCoordinates(),!1,r))&&n.length>0&&Array.isArray(n[0])){for(var o=0,a=n.length;o<a;o++)for(var s=0,h=n[o].length;s<h;s++)0===s?i.push([n[o][s],n[o][s+1]]):i.push([n[o][s-1],n[o][s]]);n=n[0].concat(n[1])}else for(var u=0,l=n.length;u<l;u++)0===u?i.push([n[u],n[u+1]]):i.push([n[u-1],n[u]]);else if("line"===t){n=[],i=[];var c=this._getPath2DPoints(this._getPrjCoordinates(),!1,r);if(c.length>0&&Array.isArray(c[0]))for(var f=void 0,d=1,p=c.length;d<p;d++){f=c[d],this instanceof Vn&&f.length>0&&!f[0].equals(f[f.length-1])&&f.push(f[0]);for(var m=1,g=f.length;m<g;m++)n.push(f[m].add(f[m-1])._multi(.5)),i.push([f[m-1],f[m]])}else{this instanceof Vn&&c.length>0&&!c[0].equals(c[c.length-1])&&c.push(c[0]);for(var _=1,y=c.length;_<y;_++)n.push(c[_].add(c[_-1])._multi(.5)),i.push([c[_-1],c[_]])}}else if("vertex-first"===t){var v=this._getPrjCoordinates();n=[e._prjToPoint(v[0],r)],i=[[e._prjToPoint(v[0],r),e._prjToPoint(v[1],r)]]}else if("vertex-last"===t){var x=this._getPrjCoordinates(),b=x.length;n=[e._prjToPoint(x[b-1],r)],i=[[e._prjToPoint(x[b-2],r),e._prjToPoint(x[b-1],r)]]}else{var w=this._getProjection().project(this.getCenter());n=[e._prjToPoint(w,r)]}return[n,i]}};qn.include(Ta),Vn.include(Ta),On.include({_redrawWhenPitch:function(){return!1},_redrawWhenRotate:function(){return!1}});var Ea={_redrawWhenPitch:function(){return!0},_redrawWhenRotate:function(){return this instanceof oi||this instanceof si},_paintAsPath:function(){var t=this.getMap();return this._getPainter().getAltitude()>0||t.getPitch()||this instanceof oi&&t.getBearing()},_getPaintParams:function(){var t=this.getMap();if(this._paintAsPath())return Vn.prototype._getPaintParams.call(this,!0);var e=this._getPrjCoordinates(),r=t._prjToPoint(e,t.getGLZoom()),n=this._getRenderSize();return[r,n.width,n.height]},_paintOn:function(){return this._paintAsPath()?ar.polygon.apply(ar,arguments):ar.ellipse.apply(ar,arguments)},_getRenderSize:function(){var t=this.getMap(),e=t.getGLZoom(),r=this._getPrjExtent(),n=t._prjToPoint(r.getMin(),e),i=t._prjToPoint(r.getMax(),e);return new fe(Math.abs(i.x-n.x)/2,Math.abs(i.y-n.y)/2)}};oi.include(Ea),ii.include(Ea),ai.include({_getPaintParams:function(){var t=this.getMap().getGLZoom(),e=this._getPrjShell();return[this._getPath2DPoints(e,!1,t)]},_paintOn:ar.polygon}),si.include(Ea,{_redrawWhenPitch:function(){return!0},_getPaintParams:function(){if(this._paintAsPath())return Vn.prototype._getPaintParams.call(this,!0);var t=this.getMap();return[t._prjToPoint(this._getPrjCoordinates(),t.getGLZoom()),this._getRenderSize().width,[this.getStartAngle(),this.getEndAngle()]]},_paintOn:function(){if(this._paintAsPath())return ar.polygon.apply(ar,arguments);var t=this.getMap().getBearing(),e=arguments;return t&&(e[3]=e[3].slice(0),e[3][0]+=t,e[3][1]+=t),ar.sector.apply(ar,e)}}),Gn.include({_paintAsPath:function(){return!0}}),qn.include({arrowStyles:{classic:[3,4]},_getArrowShape:function(t,e,r,n,i){i||(i=0);var o=r*n[0],a=r*n[1]+i,s=o/2+i,h=void 0;(h=e.nextCtrlPoint||e.prevCtrlPoint?e.prevCtrlPoint?e.sub(new ce(e.prevCtrlPoint)):e.sub(new ce(e.nextCtrlPoint)):e.sub(t))._unit();var u=e.sub(h.multi(a));h._perp();var l=u.add(h.multi(s));return h._multi(-1),[l,e,u.add(h.multi(s)),l]},_getPaintParams:function(){var t=this._getPrjCoordinates();return[this._getPath2DPoints(t,!1,this.getMap().getGLZoom())]},_paintOn:function(t,e,r,n,i){this.options.smoothness?ar.paintSmoothLine(t,e,r,this.options.smoothness,!1,this._animIdx,this._animTailRatio):ar.path(t,e,r,null,i),this._paintArrow(t,e,r)},_getArrowPlacement:function(){return this.options.arrowPlacement},_getArrowStyle:function(){var t=this.options.arrowStyle;return t?Array.isArray(t)?t:this.arrowStyles[t]:null},_getArrows:function(t,e,r){var n=this._getArrowStyle();if(!n||t.length<2)return[];for(var i=t.length>0&&Array.isArray(t[0])?t:[t],o=this._getArrowPlacement(),a=[],s=this.getMap(),h=s.coordToContainerPoint(this.getFirstCoordinate()),u=s.coordToContainerPoint(this.getLastCoordinate()),l=i.length-1;l>=0;l--)("vertex-first"===o||"vertex-firstlast"===o&&i[l][0].closeTo(h,.01))&&a.push(this._getArrowShape(i[l][1],i[l][0],e,n,r)),"vertex-last"===o||"vertex-firstlast"===o&&i[l][i[l].length-1].closeTo(u,.01)?a.push(this._getArrowShape(i[l][i[l].length-2],i[l][i[l].length-1],e,n,r)):"point"===o&&this._getArrowPoints(a,i[l],e,n,r);return a},_getArrowPoints:function(t,e,r,n,i){for(var o=0,a=e.length-1;o<a;o++)t.push(this._getArrowShape(e[o],e[o+1],r,n,i))},_paintArrow:function(t,e,r){var n=this._getInternalSymbol().lineWidth;(!v(n)||n<3)&&(n=3);var i=this._getArrows(e,n);if(i.length){t.setLineDash&&t.setLineDash([]);for(var o=i.length-1;o>=0;o--)t.fillStyle=t.strokeStyle,ar.polygon(t,i[o],r,r)}}}),Vn.include({_getPaintParams:function(t){var e=this.getMap().getGLZoom(),r=this._getPrjShell(),n=this._getPath2DPoints(r,t,e),i=n.length>0&&Array.isArray(n[0]);i&&(n=[[n[0]],[n[1]]]);var o=this._getPrjHoles(),a=[];if(o&&o.length>0)for(var s=0;s<o.length;s++){var h=this._getPath2DPoints(o[s],t,e);Array.isArray(h)&&i?Array.isArray(h[0])?(n[0].push(h[0]),n[1].push(h[1])):n[0].push(h):a.push(h)}return i||B(n=[n],a),[n]},_paintOn:function(t,e,r,n,i){ar.polygon(t,e,r,n,i,this.options.smoothness)}}),"undefined"!=typeof console&&console.log("maptalks v0.40.5")}.call(this,r(6),r(3),r(52).setImmediate)},function(t,e,r){"use strict";var n=r(32),i=r(1),o=r(20),a=r(19),s=r(9),h=r(39),u=r(5);function l(t,e){this.options=t,this.loadOptions=e}l.prototype={isEncrypted:function(){return 1==(1&this.bitFlag)},useUTF8:function(){return 2048==(2048&this.bitFlag)},readLocalPart:function(t){var e,r;if(t.skip(22),this.fileNameLength=t.readInt(2),r=t.readInt(2),this.fileName=t.readData(this.fileNameLength),t.skip(r),-1===this.compressedSize||-1===this.uncompressedSize)throw new Error("Bug or corrupted zip : didn't get enough informations from the central directory (compressedSize === -1 || uncompressedSize === -1)");if(null===(e=function(t){for(var e in h)if(h.hasOwnProperty(e)&&h[e].magic===t)return h[e];return null}(this.compressionMethod)))throw new Error("Corrupted zip : compression "+i.pretty(this.compressionMethod)+" unknown (inner file : "+i.transformTo("string",this.fileName)+")");this.decompressed=new o(this.compressedSize,this.uncompressedSize,this.crc32,e,t.readData(this.compressedSize))},readCentralPart:function(t){this.versionMadeBy=t.readInt(2),t.skip(2),this.bitFlag=t.readInt(2),this.compressionMethod=t.readString(2),this.date=t.readDate(),this.crc32=t.readInt(4),this.compressedSize=t.readInt(4),this.uncompressedSize=t.readInt(4);var e=t.readInt(2);if(this.extraFieldsLength=t.readInt(2),this.fileCommentLength=t.readInt(2),this.diskNumberStart=t.readInt(2),this.internalFileAttributes=t.readInt(2),this.externalFileAttributes=t.readInt(4),this.localHeaderOffset=t.readInt(4),this.isEncrypted())throw new Error("Encrypted zip are not supported");t.skip(e),this.readExtraFields(t),this.parseZIP64ExtraField(t),this.fileComment=t.readData(this.fileCommentLength)},processAttributes:function(){this.unixPermissions=null,this.dosPermissions=null;var t=this.versionMadeBy>>8;this.dir=!!(16&this.externalFileAttributes),0===t&&(this.dosPermissions=63&this.externalFileAttributes),3===t&&(this.unixPermissions=this.externalFileAttributes>>16&65535),this.dir||"/"!==this.fileNameStr.slice(-1)||(this.dir=!0)},parseZIP64ExtraField:function(t){if(this.extraFields[1]){var e=n(this.extraFields[1].value);this.uncompressedSize===i.MAX_VALUE_32BITS&&(this.uncompressedSize=e.readInt(8)),this.compressedSize===i.MAX_VALUE_32BITS&&(this.compressedSize=e.readInt(8)),this.localHeaderOffset===i.MAX_VALUE_32BITS&&(this.localHeaderOffset=e.readInt(8)),this.diskNumberStart===i.MAX_VALUE_32BITS&&(this.diskNumberStart=e.readInt(4))}},readExtraFields:function(t){var e,r,n,i=t.index+this.extraFieldsLength;for(this.extraFields||(this.extraFields={});t.index<i;)e=t.readInt(2),r=t.readInt(2),n=t.readData(r),this.extraFields[e]={id:e,length:r,value:n}},handleUTF8:function(){var t=u.uint8array?"uint8array":"array";if(this.useUTF8())this.fileNameStr=s.utf8decode(this.fileName),this.fileCommentStr=s.utf8decode(this.fileComment);else{var e=this.findExtraFieldUnicodePath();if(null!==e)this.fileNameStr=e;else{var r=i.transformTo(t,this.fileName);this.fileNameStr=this.loadOptions.decodeFileName(r)}var n=this.findExtraFieldUnicodeComment();if(null!==n)this.fileCommentStr=n;else{var o=i.transformTo(t,this.fileComment);this.fileCommentStr=this.loadOptions.decodeFileName(o)}}},findExtraFieldUnicodePath:function(){var t=this.extraFields[28789];if(t){var e=n(t.value);return 1!==e.readInt(1)?null:a(this.fileName)!==e.readInt(4)?null:s.utf8decode(e.readData(t.length-5))}return null},findExtraFieldUnicodeComment:function(){var t=this.extraFields[25461];if(t){var e=n(t.value);return 1!==e.readInt(1)?null:a(this.fileComment)!==e.readInt(4)?null:s.utf8decode(e.readData(t.length-5))}return null}},t.exports=l},function(t,e,r){"use strict";var n=r(29);function i(t){n.call(this,t)}r(1).inherits(i,n),i.prototype.readData=function(t){this.checkOffset(t);var e=this.data.slice(this.zero+this.index,this.zero+this.index+t);return this.index+=t,e},t.exports=i},function(t,e,r){"use strict";var n=r(30);function i(t){n.call(this,t)}r(1).inherits(i,n),i.prototype.byteAt=function(t){return this.data.charCodeAt(this.zero+t)},i.prototype.lastIndexOfSignature=function(t){return this.data.lastIndexOf(t)-this.zero},i.prototype.readAndCheckSignature=function(t){return t===this.readData(4)},i.prototype.readData=function(t){this.checkOffset(t);var e=this.data.slice(this.zero+this.index,this.zero+this.index+t);return this.index+=t,e},t.exports=i},function(t,e,r){"use strict";var n=r(32),i=r(1),o=r(33),a=r(70),s=(r(9),r(5));function h(t){this.files=[],this.loadOptions=t}h.prototype={checkSignature:function(t){if(!this.reader.readAndCheckSignature(t)){this.reader.index-=4;var e=this.reader.readString(4);throw new Error("Corrupted zip or bug: unexpected signature ("+i.pretty(e)+", expected "+i.pretty(t)+")")}},isSignature:function(t,e){var r=this.reader.index;this.reader.setIndex(t);var n=this.reader.readString(4)===e;return this.reader.setIndex(r),n},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2),this.diskWithCentralDirStart=this.reader.readInt(2),this.centralDirRecordsOnThisDisk=this.reader.readInt(2),this.centralDirRecords=this.reader.readInt(2),this.centralDirSize=this.reader.readInt(4),this.centralDirOffset=this.reader.readInt(4),this.zipCommentLength=this.reader.readInt(2);var t=this.reader.readData(this.zipCommentLength),e=s.uint8array?"uint8array":"array",r=i.transformTo(e,t);this.zipComment=this.loadOptions.decodeFileName(r)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8),this.reader.skip(4),this.diskNumber=this.reader.readInt(4),this.diskWithCentralDirStart=this.reader.readInt(4),this.centralDirRecordsOnThisDisk=this.reader.readInt(8),this.centralDirRecords=this.reader.readInt(8),this.centralDirSize=this.reader.readInt(8),this.centralDirOffset=this.reader.readInt(8),this.zip64ExtensibleData={};for(var t,e,r,n=this.zip64EndOfCentralSize-44;0<n;)t=this.reader.readInt(2),e=this.reader.readInt(4),r=this.reader.readData(e),this.zip64ExtensibleData[t]={id:t,length:e,value:r}},readBlockZip64EndOfCentralLocator:function(){if(this.diskWithZip64CentralDirStart=this.reader.readInt(4),this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8),this.disksCount=this.reader.readInt(4),this.disksCount>1)throw new Error("Multi-volumes zip are not supported")},readLocalFiles:function(){var t,e;for(t=0;t<this.files.length;t++)e=this.files[t],this.reader.setIndex(e.localHeaderOffset),this.checkSignature(o.LOCAL_FILE_HEADER),e.readLocalPart(this.reader),e.handleUTF8(),e.processAttributes()},readCentralDir:function(){var t;for(this.reader.setIndex(this.centralDirOffset);this.reader.readAndCheckSignature(o.CENTRAL_FILE_HEADER);)(t=new a({zip64:this.zip64},this.loadOptions)).readCentralPart(this.reader),this.files.push(t);if(this.centralDirRecords!==this.files.length&&0!==this.centralDirRecords&&0===this.files.length)throw new Error("Corrupted zip or bug: expected "+this.centralDirRecords+" records in central dir, got "+this.files.length)},readEndOfCentral:function(){var t=this.reader.lastIndexOfSignature(o.CENTRAL_DIRECTORY_END);if(t<0)throw!this.isSignature(0,o.LOCAL_FILE_HEADER)?new Error("Can't find end of central directory : is this a zip file ? If it is, see https://stuk.github.io/jszip/documentation/howto/read_zip.html"):new Error("Corrupted zip: can't find end of central directory");this.reader.setIndex(t);var e=t;if(this.checkSignature(o.CENTRAL_DIRECTORY_END),this.readBlockEndOfCentral(),this.diskNumber===i.MAX_VALUE_16BITS||this.diskWithCentralDirStart===i.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===i.MAX_VALUE_16BITS||this.centralDirRecords===i.MAX_VALUE_16BITS||this.centralDirSize===i.MAX_VALUE_32BITS||this.centralDirOffset===i.MAX_VALUE_32BITS){if(this.zip64=!0,(t=this.reader.lastIndexOfSignature(o.ZIP64_CENTRAL_DIRECTORY_LOCATOR))<0)throw new Error("Corrupted zip: can't find the ZIP64 end of central directory locator");if(this.reader.setIndex(t),this.checkSignature(o.ZIP64_CENTRAL_DIRECTORY_LOCATOR),this.readBlockZip64EndOfCentralLocator(),!this.isSignature(this.relativeOffsetEndOfZip64CentralDir,o.ZIP64_CENTRAL_DIRECTORY_END)&&(this.relativeOffsetEndOfZip64CentralDir=this.reader.lastIndexOfSignature(o.ZIP64_CENTRAL_DIRECTORY_END),this.relativeOffsetEndOfZip64CentralDir<0))throw new Error("Corrupted zip: can't find the ZIP64 end of central directory");this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir),this.checkSignature(o.ZIP64_CENTRAL_DIRECTORY_END),this.readBlockZip64EndOfCentral()}var r=this.centralDirOffset+this.centralDirSize;this.zip64&&(r+=20,r+=12+this.zip64EndOfCentralSize);var n=e-r;if(n>0)this.isSignature(e,o.CENTRAL_FILE_HEADER)||(this.reader.zero=n);else if(n<0)throw new Error("Corrupted zip: missing "+Math.abs(n)+" bytes.")},prepareReader:function(t){this.reader=n(t)},load:function(t){this.prepareReader(t),this.readEndOfCentral(),this.readCentralDir(),this.readLocalFiles()}},t.exports=h},function(t,e,r){"use strict";var n=r(1),i=r(10),o=r(9),a=(n=r(1),r(73)),s=r(40),h=r(14);function u(t){return new i.Promise(function(e,r){var n=t.decompressed.getContentWorker().pipe(new s);n.on("error",function(t){r(t)}).on("end",function(){n.streamInfo.crc32!==t.decompressed.crc32?r(new Error("Corrupted zip : CRC32 mismatch")):e()}).resume()})}t.exports=function(t,e){var r=this;return e=n.extend(e||{},{base64:!1,checkCRC32:!1,optimizedBinaryString:!1,createFolders:!1,decodeFileName:o.utf8decode}),h.isNode&&h.isStream(t)?i.Promise.reject(new Error("JSZip can't accept a stream when loading a zip file.")):n.prepareContent("the loaded zip file",t,!0,e.optimizedBinaryString,e.base64).then(function(t){var r=new a(e);return r.load(t),r}).then(function(t){var r=[i.Promise.resolve(t)],n=t.files;if(e.checkCRC32)for(var o=0;o<n.length;o++)r.push(u(n[o]));return i.Promise.all(r)}).then(function(t){for(var n=t.shift(),i=n.files,o=0;o<i.length;o++){var a=i[o];r.file(a.fileNameStr,a.decompressed,{binary:!0,optimizedBinaryString:!0,date:a.date,dir:a.dir,comment:a.fileCommentStr.length?a.fileCommentStr:null,unixPermissions:a.unixPermissions,dosPermissions:a.dosPermissions,createFolders:e.createFolders})}return n.zipComment.length&&(r.comment=n.zipComment),r})}},function(t,e,r){"use strict";var n=r(1),i=r(2);function o(t,e){i.call(this,"Nodejs stream input adapter for "+t),this._upstreamEnded=!1,this._bindStream(e)}n.inherits(o,i),o.prototype._bindStream=function(t){var e=this;this._stream=t,t.pause(),t.on("data",function(t){e.push({data:t,meta:{percent:0}})}).on("error",function(t){e.isPaused?this.generatedError=t:e.error(t)}).on("end",function(){e.isPaused?e._upstreamEnded=!0:e.end()})},o.prototype.pause=function(){return!!i.prototype.pause.call(this)&&(this._stream.pause(),!0)},o.prototype.resume=function(){return!!i.prototype.resume.call(this)&&(this._upstreamEnded?this.end():this._stream.resume(),!0)},t.exports=o},function(t,e,r){"use strict";var n=r(1),i=r(2),o=r(9),a=r(19),s=r(33),h=function(t,e){var r,n="";for(r=0;r<e;r++)n+=String.fromCharCode(255&t),t>>>=8;return n},u=function(t,e,r,i,u,l){var c,f,d=t.file,p=t.compression,m=l!==o.utf8encode,g=n.transformTo("string",l(d.name)),_=n.transformTo("string",o.utf8encode(d.name)),y=d.comment,v=n.transformTo("string",l(y)),x=n.transformTo("string",o.utf8encode(y)),b=_.length!==d.name.length,w=x.length!==y.length,T="",E="",C="",S=d.dir,A=d.date,M={crc32:0,compressedSize:0,uncompressedSize:0};e&&!r||(M.crc32=t.crc32,M.compressedSize=t.compressedSize,M.uncompressedSize=t.uncompressedSize);var P=0;e&&(P|=8),m||!b&&!w||(P|=2048);var R,L,O=0,k=0;S&&(O|=16),"UNIX"===u?(k=798,O|=(R=d.unixPermissions,L=R,R||(L=S?16893:33204),(65535&L)<<16)):(k=20,O|=63&(d.dosPermissions||0)),c=A.getUTCHours(),c<<=6,c|=A.getUTCMinutes(),c<<=5,c|=A.getUTCSeconds()/2,f=A.getUTCFullYear()-1980,f<<=4,f|=A.getUTCMonth()+1,f<<=5,f|=A.getUTCDate(),b&&(E=h(1,1)+h(a(g),4)+_,T+="up"+h(E.length,2)+E),w&&(C=h(1,1)+h(a(v),4)+x,T+="uc"+h(C.length,2)+C);var D="";return D+="\n\0",D+=h(P,2),D+=p.magic,D+=h(c,2),D+=h(f,2),D+=h(M.crc32,4),D+=h(M.compressedSize,4),D+=h(M.uncompressedSize,4),D+=h(g.length,2),D+=h(T.length,2),{fileRecord:s.LOCAL_FILE_HEADER+D+g+T,dirRecord:s.CENTRAL_FILE_HEADER+h(k,2)+D+h(v.length,2)+"\0\0\0\0"+h(O,4)+h(i,4)+g+T+v}};function l(t,e,r,n){i.call(this,"ZipFileWorker"),this.bytesWritten=0,this.zipComment=e,this.zipPlatform=r,this.encodeFileName=n,this.streamFiles=t,this.accumulate=!1,this.contentBuffer=[],this.dirRecords=[],this.currentSourceOffset=0,this.entriesCount=0,this.currentFile=null,this._sources=[]}n.inherits(l,i),l.prototype.push=function(t){var e=t.meta.percent||0,r=this.entriesCount,n=this._sources.length;this.accumulate?this.contentBuffer.push(t):(this.bytesWritten+=t.data.length,i.prototype.push.call(this,{data:t.data,meta:{currentFile:this.currentFile,percent:r?(e+100*(r-n-1))/r:100}}))},l.prototype.openedSource=function(t){this.currentSourceOffset=this.bytesWritten,this.currentFile=t.file.name;var e=this.streamFiles&&!t.file.dir;if(e){var r=u(t,e,!1,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);this.push({data:r.fileRecord,meta:{percent:0}})}else this.accumulate=!0},l.prototype.closedSource=function(t){this.accumulate=!1;var e=this.streamFiles&&!t.file.dir,r=u(t,e,!0,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);if(this.dirRecords.push(r.dirRecord),e)this.push({data:function(t){return s.DATA_DESCRIPTOR+h(t.crc32,4)+h(t.compressedSize,4)+h(t.uncompressedSize,4)}(t),meta:{percent:100}});else for(this.push({data:r.fileRecord,meta:{percent:0}});this.contentBuffer.length;)this.push(this.contentBuffer.shift());this.currentFile=null},l.prototype.flush=function(){for(var t=this.bytesWritten,e=0;e<this.dirRecords.length;e++)this.push({data:this.dirRecords[e],meta:{percent:100}});var r=this.bytesWritten-t,i=function(t,e,r,i,o){var a=n.transformTo("string",o(i));return s.CENTRAL_DIRECTORY_END+"\0\0\0\0"+h(t,2)+h(t,2)+h(e,4)+h(r,4)+h(a.length,2)+a}(this.dirRecords.length,r,t,this.zipComment,this.encodeFileName);this.push({data:i,meta:{percent:100}})},l.prototype.prepareNextSource=function(){this.previous=this._sources.shift(),this.openedSource(this.previous.streamInfo),this.isPaused?this.previous.pause():this.previous.resume()},l.prototype.registerPrevious=function(t){this._sources.push(t);var e=this;return t.on("data",function(t){e.processChunk(t)}),t.on("end",function(){e.closedSource(e.previous.streamInfo),e._sources.length?e.prepareNextSource():e.end()}),t.on("error",function(t){e.error(t)}),this},l.prototype.resume=function(){return!!i.prototype.resume.call(this)&&(!this.previous&&this._sources.length?(this.prepareNextSource(),!0):this.previous||this._sources.length||this.generatedError?void 0:(this.end(),!0))},l.prototype.error=function(t){var e=this._sources;if(!i.prototype.error.call(this,t))return!1;for(var r=0;r<e.length;r++)try{e[r].error(t)}catch(t){}return!0},l.prototype.lock=function(){i.prototype.lock.call(this);for(var t=this._sources,e=0;e<t.length;e++)t[e].lock()},t.exports=l},function(t,e,r){"use strict";t.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},function(t,e,r){"use strict";var n=r(4),i=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],o=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],a=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],s=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];t.exports=function(t,e,r,h,u,l,c,f){var d,p,m,g,_,y,v,x,b,w=f.bits,T=0,E=0,C=0,S=0,A=0,M=0,P=0,R=0,L=0,O=0,k=null,D=0,I=new n.Buf16(16),N=new n.Buf16(16),F=null,B=0;for(T=0;T<=15;T++)I[T]=0;for(E=0;E<h;E++)I[e[r+E]]++;for(A=w,S=15;S>=1&&0===I[S];S--);if(A>S&&(A=S),0===S)return u[l++]=20971520,u[l++]=20971520,f.bits=1,0;for(C=1;C<S&&0===I[C];C++);for(A<C&&(A=C),R=1,T=1;T<=15;T++)if(R<<=1,(R-=I[T])<0)return-1;if(R>0&&(0===t||1!==S))return-1;for(N[1]=0,T=1;T<15;T++)N[T+1]=N[T]+I[T];for(E=0;E<h;E++)0!==e[r+E]&&(c[N[e[r+E]]++]=E);if(0===t?(k=F=c,y=19):1===t?(k=i,D-=257,F=o,B-=257,y=256):(k=a,F=s,y=-1),O=0,E=0,T=C,_=l,M=A,P=0,m=-1,g=(L=1<<A)-1,1===t&&L>852||2===t&&L>592)return 1;for(;;){v=T-P,c[E]<y?(x=0,b=c[E]):c[E]>y?(x=F[B+c[E]],b=k[D+c[E]]):(x=96,b=0),d=1<<T-P,C=p=1<<M;do{u[_+(O>>P)+(p-=d)]=v<<24|x<<16|b|0}while(0!==p);for(d=1<<T-1;O&d;)d>>=1;if(0!==d?(O&=d-1,O+=d):O=0,E++,0==--I[T]){if(T===S)break;T=e[r+c[E]]}if(T>A&&(O&g)!==m){for(0===P&&(P=A),_+=C,R=1<<(M=T-P);M+P<S&&!((R-=I[M+P])<=0);)M++,R<<=1;if(L+=1<<M,1===t&&L>852||2===t&&L>592)return 1;u[m=O&g]=A<<24|M<<16|_-l|0}}return 0!==O&&(u[_+O]=T-P<<24|64<<16|0),f.bits=A,0}},function(t,e,r){"use strict";t.exports=function(t,e){var r,n,i,o,a,s,h,u,l,c,f,d,p,m,g,_,y,v,x,b,w,T,E,C,S;r=t.state,n=t.next_in,C=t.input,i=n+(t.avail_in-5),o=t.next_out,S=t.output,a=o-(e-t.avail_out),s=o+(t.avail_out-257),h=r.dmax,u=r.wsize,l=r.whave,c=r.wnext,f=r.window,d=r.hold,p=r.bits,m=r.lencode,g=r.distcode,_=(1<<r.lenbits)-1,y=(1<<r.distbits)-1;t:do{p<15&&(d+=C[n++]<<p,p+=8,d+=C[n++]<<p,p+=8),v=m[d&_];e:for(;;){if(d>>>=x=v>>>24,p-=x,0===(x=v>>>16&255))S[o++]=65535&v;else{if(!(16&x)){if(0==(64&x)){v=m[(65535&v)+(d&(1<<x)-1)];continue e}if(32&x){r.mode=12;break t}t.msg="invalid literal/length code",r.mode=30;break t}b=65535&v,(x&=15)&&(p<x&&(d+=C[n++]<<p,p+=8),b+=d&(1<<x)-1,d>>>=x,p-=x),p<15&&(d+=C[n++]<<p,p+=8,d+=C[n++]<<p,p+=8),v=g[d&y];r:for(;;){if(d>>>=x=v>>>24,p-=x,!(16&(x=v>>>16&255))){if(0==(64&x)){v=g[(65535&v)+(d&(1<<x)-1)];continue r}t.msg="invalid distance code",r.mode=30;break t}if(w=65535&v,p<(x&=15)&&(d+=C[n++]<<p,(p+=8)<x&&(d+=C[n++]<<p,p+=8)),(w+=d&(1<<x)-1)>h){t.msg="invalid distance too far back",r.mode=30;break t}if(d>>>=x,p-=x,w>(x=o-a)){if((x=w-x)>l&&r.sane){t.msg="invalid distance too far back",r.mode=30;break t}if(T=0,E=f,0===c){if(T+=u-x,x<b){b-=x;do{S[o++]=f[T++]}while(--x);T=o-w,E=S}}else if(c<x){if(T+=u+c-x,(x-=c)<b){b-=x;do{S[o++]=f[T++]}while(--x);if(T=0,c<b){b-=x=c;do{S[o++]=f[T++]}while(--x);T=o-w,E=S}}}else if(T+=c-x,x<b){b-=x;do{S[o++]=f[T++]}while(--x);T=o-w,E=S}for(;b>2;)S[o++]=E[T++],S[o++]=E[T++],S[o++]=E[T++],b-=3;b&&(S[o++]=E[T++],b>1&&(S[o++]=E[T++]))}else{T=o-w;do{S[o++]=S[T++],S[o++]=S[T++],S[o++]=S[T++],b-=3}while(b>2);b&&(S[o++]=S[T++],b>1&&(S[o++]=S[T++]))}break}}break}}while(n<i&&o<s);n-=b=p>>3,d&=(1<<(p-=b<<3))-1,t.next_in=n,t.next_out=o,t.avail_in=n<i?i-n+5:5-(n-i),t.avail_out=o<s?s-o+257:257-(o-s),r.hold=d,r.bits=p}},function(t,e,r){"use strict";var n=r(4),i=r(38),o=r(37),a=r(79),s=r(78),h=0,u=1,l=2,c=4,f=5,d=6,p=0,m=1,g=2,_=-2,y=-3,v=-4,x=-5,b=8,w=1,T=2,E=3,C=4,S=5,A=6,M=7,P=8,R=9,L=10,O=11,k=12,D=13,I=14,N=15,F=16,B=17,z=18,U=19,H=20,j=21,G=22,V=23,W=24,Z=25,X=26,q=27,Y=28,J=29,K=30,Q=31,$=32,tt=852,et=592,rt=15;function nt(t){return(t>>>24&255)+(t>>>8&65280)+((65280&t)<<8)+((255&t)<<24)}function it(t){var e;return t&&t.state?(e=t.state,t.total_in=t.total_out=e.total=0,t.msg="",e.wrap&&(t.adler=1&e.wrap),e.mode=w,e.last=0,e.havedict=0,e.dmax=32768,e.head=null,e.hold=0,e.bits=0,e.lencode=e.lendyn=new n.Buf32(tt),e.distcode=e.distdyn=new n.Buf32(et),e.sane=1,e.back=-1,p):_}function ot(t){var e;return t&&t.state?((e=t.state).wsize=0,e.whave=0,e.wnext=0,it(t)):_}function at(t,e){var r,n;return t&&t.state?(n=t.state,e<0?(r=0,e=-e):(r=1+(e>>4),e<48&&(e&=15)),e&&(e<8||e>15)?_:(null!==n.window&&n.wbits!==e&&(n.window=null),n.wrap=r,n.wbits=e,ot(t))):_}function st(t,e){var r,i;return t?(i=new function(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new n.Buf16(320),this.work=new n.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0},t.state=i,i.window=null,(r=at(t,e))!==p&&(t.state=null),r):_}var ht,ut,lt=!0;function ct(t){if(lt){var e;for(ht=new n.Buf32(512),ut=new n.Buf32(32),e=0;e<144;)t.lens[e++]=8;for(;e<256;)t.lens[e++]=9;for(;e<280;)t.lens[e++]=7;for(;e<288;)t.lens[e++]=8;for(s(u,t.lens,0,288,ht,0,t.work,{bits:9}),e=0;e<32;)t.lens[e++]=5;s(l,t.lens,0,32,ut,0,t.work,{bits:5}),lt=!1}t.lencode=ht,t.lenbits=9,t.distcode=ut,t.distbits=5}function ft(t,e,r,i){var o,a=t.state;return null===a.window&&(a.wsize=1<<a.wbits,a.wnext=0,a.whave=0,a.window=new n.Buf8(a.wsize)),i>=a.wsize?(n.arraySet(a.window,e,r-a.wsize,a.wsize,0),a.wnext=0,a.whave=a.wsize):((o=a.wsize-a.wnext)>i&&(o=i),n.arraySet(a.window,e,r-i,o,a.wnext),(i-=o)?(n.arraySet(a.window,e,r-i,i,0),a.wnext=i,a.whave=a.wsize):(a.wnext+=o,a.wnext===a.wsize&&(a.wnext=0),a.whave<a.wsize&&(a.whave+=o))),0}e.inflateReset=ot,e.inflateReset2=at,e.inflateResetKeep=it,e.inflateInit=function(t){return st(t,rt)},e.inflateInit2=st,e.inflate=function(t,e){var r,tt,et,rt,it,ot,at,st,ht,ut,lt,dt,pt,mt,gt,_t,yt,vt,xt,bt,wt,Tt,Et,Ct,St=0,At=new n.Buf8(4),Mt=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!t||!t.state||!t.output||!t.input&&0!==t.avail_in)return _;(r=t.state).mode===k&&(r.mode=D),it=t.next_out,et=t.output,at=t.avail_out,rt=t.next_in,tt=t.input,ot=t.avail_in,st=r.hold,ht=r.bits,ut=ot,lt=at,Tt=p;t:for(;;)switch(r.mode){case w:if(0===r.wrap){r.mode=D;break}for(;ht<16;){if(0===ot)break t;ot--,st+=tt[rt++]<<ht,ht+=8}if(2&r.wrap&&35615===st){r.check=0,At[0]=255&st,At[1]=st>>>8&255,r.check=o(r.check,At,2,0),st=0,ht=0,r.mode=T;break}if(r.flags=0,r.head&&(r.head.done=!1),!(1&r.wrap)||(((255&st)<<8)+(st>>8))%31){t.msg="incorrect header check",r.mode=K;break}if((15&st)!==b){t.msg="unknown compression method",r.mode=K;break}if(ht-=4,wt=8+(15&(st>>>=4)),0===r.wbits)r.wbits=wt;else if(wt>r.wbits){t.msg="invalid window size",r.mode=K;break}r.dmax=1<<wt,t.adler=r.check=1,r.mode=512&st?L:k,st=0,ht=0;break;case T:for(;ht<16;){if(0===ot)break t;ot--,st+=tt[rt++]<<ht,ht+=8}if(r.flags=st,(255&r.flags)!==b){t.msg="unknown compression method",r.mode=K;break}if(57344&r.flags){t.msg="unknown header flags set",r.mode=K;break}r.head&&(r.head.text=st>>8&1),512&r.flags&&(At[0]=255&st,At[1]=st>>>8&255,r.check=o(r.check,At,2,0)),st=0,ht=0,r.mode=E;case E:for(;ht<32;){if(0===ot)break t;ot--,st+=tt[rt++]<<ht,ht+=8}r.head&&(r.head.time=st),512&r.flags&&(At[0]=255&st,At[1]=st>>>8&255,At[2]=st>>>16&255,At[3]=st>>>24&255,r.check=o(r.check,At,4,0)),st=0,ht=0,r.mode=C;case C:for(;ht<16;){if(0===ot)break t;ot--,st+=tt[rt++]<<ht,ht+=8}r.head&&(r.head.xflags=255&st,r.head.os=st>>8),512&r.flags&&(At[0]=255&st,At[1]=st>>>8&255,r.check=o(r.check,At,2,0)),st=0,ht=0,r.mode=S;case S:if(1024&r.flags){for(;ht<16;){if(0===ot)break t;ot--,st+=tt[rt++]<<ht,ht+=8}r.length=st,r.head&&(r.head.extra_len=st),512&r.flags&&(At[0]=255&st,At[1]=st>>>8&255,r.check=o(r.check,At,2,0)),st=0,ht=0}else r.head&&(r.head.extra=null);r.mode=A;case A:if(1024&r.flags&&((dt=r.length)>ot&&(dt=ot),dt&&(r.head&&(wt=r.head.extra_len-r.length,r.head.extra||(r.head.extra=new Array(r.head.extra_len)),n.arraySet(r.head.extra,tt,rt,dt,wt)),512&r.flags&&(r.check=o(r.check,tt,dt,rt)),ot-=dt,rt+=dt,r.length-=dt),r.length))break t;r.length=0,r.mode=M;case M:if(2048&r.flags){if(0===ot)break t;dt=0;do{wt=tt[rt+dt++],r.head&&wt&&r.length<65536&&(r.head.name+=String.fromCharCode(wt))}while(wt&&dt<ot);if(512&r.flags&&(r.check=o(r.check,tt,dt,rt)),ot-=dt,rt+=dt,wt)break t}else r.head&&(r.head.name=null);r.length=0,r.mode=P;case P:if(4096&r.flags){if(0===ot)break t;dt=0;do{wt=tt[rt+dt++],r.head&&wt&&r.length<65536&&(r.head.comment+=String.fromCharCode(wt))}while(wt&&dt<ot);if(512&r.flags&&(r.check=o(r.check,tt,dt,rt)),ot-=dt,rt+=dt,wt)break t}else r.head&&(r.head.comment=null);r.mode=R;case R:if(512&r.flags){for(;ht<16;){if(0===ot)break t;ot--,st+=tt[rt++]<<ht,ht+=8}if(st!==(65535&r.check)){t.msg="header crc mismatch",r.mode=K;break}st=0,ht=0}r.head&&(r.head.hcrc=r.flags>>9&1,r.head.done=!0),t.adler=r.check=0,r.mode=k;break;case L:for(;ht<32;){if(0===ot)break t;ot--,st+=tt[rt++]<<ht,ht+=8}t.adler=r.check=nt(st),st=0,ht=0,r.mode=O;case O:if(0===r.havedict)return t.next_out=it,t.avail_out=at,t.next_in=rt,t.avail_in=ot,r.hold=st,r.bits=ht,g;t.adler=r.check=1,r.mode=k;case k:if(e===f||e===d)break t;case D:if(r.last){st>>>=7&ht,ht-=7&ht,r.mode=q;break}for(;ht<3;){if(0===ot)break t;ot--,st+=tt[rt++]<<ht,ht+=8}switch(r.last=1&st,ht-=1,3&(st>>>=1)){case 0:r.mode=I;break;case 1:if(ct(r),r.mode=H,e===d){st>>>=2,ht-=2;break t}break;case 2:r.mode=B;break;case 3:t.msg="invalid block type",r.mode=K}st>>>=2,ht-=2;break;case I:for(st>>>=7&ht,ht-=7&ht;ht<32;){if(0===ot)break t;ot--,st+=tt[rt++]<<ht,ht+=8}if((65535&st)!=(st>>>16^65535)){t.msg="invalid stored block lengths",r.mode=K;break}if(r.length=65535&st,st=0,ht=0,r.mode=N,e===d)break t;case N:r.mode=F;case F:if(dt=r.length){if(dt>ot&&(dt=ot),dt>at&&(dt=at),0===dt)break t;n.arraySet(et,tt,rt,dt,it),ot-=dt,rt+=dt,at-=dt,it+=dt,r.length-=dt;break}r.mode=k;break;case B:for(;ht<14;){if(0===ot)break t;ot--,st+=tt[rt++]<<ht,ht+=8}if(r.nlen=257+(31&st),st>>>=5,ht-=5,r.ndist=1+(31&st),st>>>=5,ht-=5,r.ncode=4+(15&st),st>>>=4,ht-=4,r.nlen>286||r.ndist>30){t.msg="too many length or distance symbols",r.mode=K;break}r.have=0,r.mode=z;case z:for(;r.have<r.ncode;){for(;ht<3;){if(0===ot)break t;ot--,st+=tt[rt++]<<ht,ht+=8}r.lens[Mt[r.have++]]=7&st,st>>>=3,ht-=3}for(;r.have<19;)r.lens[Mt[r.have++]]=0;if(r.lencode=r.lendyn,r.lenbits=7,Et={bits:r.lenbits},Tt=s(h,r.lens,0,19,r.lencode,0,r.work,Et),r.lenbits=Et.bits,Tt){t.msg="invalid code lengths set",r.mode=K;break}r.have=0,r.mode=U;case U:for(;r.have<r.nlen+r.ndist;){for(;_t=(St=r.lencode[st&(1<<r.lenbits)-1])>>>16&255,yt=65535&St,!((gt=St>>>24)<=ht);){if(0===ot)break t;ot--,st+=tt[rt++]<<ht,ht+=8}if(yt<16)st>>>=gt,ht-=gt,r.lens[r.have++]=yt;else{if(16===yt){for(Ct=gt+2;ht<Ct;){if(0===ot)break t;ot--,st+=tt[rt++]<<ht,ht+=8}if(st>>>=gt,ht-=gt,0===r.have){t.msg="invalid bit length repeat",r.mode=K;break}wt=r.lens[r.have-1],dt=3+(3&st),st>>>=2,ht-=2}else if(17===yt){for(Ct=gt+3;ht<Ct;){if(0===ot)break t;ot--,st+=tt[rt++]<<ht,ht+=8}ht-=gt,wt=0,dt=3+(7&(st>>>=gt)),st>>>=3,ht-=3}else{for(Ct=gt+7;ht<Ct;){if(0===ot)break t;ot--,st+=tt[rt++]<<ht,ht+=8}ht-=gt,wt=0,dt=11+(127&(st>>>=gt)),st>>>=7,ht-=7}if(r.have+dt>r.nlen+r.ndist){t.msg="invalid bit length repeat",r.mode=K;break}for(;dt--;)r.lens[r.have++]=wt}}if(r.mode===K)break;if(0===r.lens[256]){t.msg="invalid code -- missing end-of-block",r.mode=K;break}if(r.lenbits=9,Et={bits:r.lenbits},Tt=s(u,r.lens,0,r.nlen,r.lencode,0,r.work,Et),r.lenbits=Et.bits,Tt){t.msg="invalid literal/lengths set",r.mode=K;break}if(r.distbits=6,r.distcode=r.distdyn,Et={bits:r.distbits},Tt=s(l,r.lens,r.nlen,r.ndist,r.distcode,0,r.work,Et),r.distbits=Et.bits,Tt){t.msg="invalid distances set",r.mode=K;break}if(r.mode=H,e===d)break t;case H:r.mode=j;case j:if(ot>=6&&at>=258){t.next_out=it,t.avail_out=at,t.next_in=rt,t.avail_in=ot,r.hold=st,r.bits=ht,a(t,lt),it=t.next_out,et=t.output,at=t.avail_out,rt=t.next_in,tt=t.input,ot=t.avail_in,st=r.hold,ht=r.bits,r.mode===k&&(r.back=-1);break}for(r.back=0;_t=(St=r.lencode[st&(1<<r.lenbits)-1])>>>16&255,yt=65535&St,!((gt=St>>>24)<=ht);){if(0===ot)break t;ot--,st+=tt[rt++]<<ht,ht+=8}if(_t&&0==(240&_t)){for(vt=gt,xt=_t,bt=yt;_t=(St=r.lencode[bt+((st&(1<<vt+xt)-1)>>vt)])>>>16&255,yt=65535&St,!(vt+(gt=St>>>24)<=ht);){if(0===ot)break t;ot--,st+=tt[rt++]<<ht,ht+=8}st>>>=vt,ht-=vt,r.back+=vt}if(st>>>=gt,ht-=gt,r.back+=gt,r.length=yt,0===_t){r.mode=X;break}if(32&_t){r.back=-1,r.mode=k;break}if(64&_t){t.msg="invalid literal/length code",r.mode=K;break}r.extra=15&_t,r.mode=G;case G:if(r.extra){for(Ct=r.extra;ht<Ct;){if(0===ot)break t;ot--,st+=tt[rt++]<<ht,ht+=8}r.length+=st&(1<<r.extra)-1,st>>>=r.extra,ht-=r.extra,r.back+=r.extra}r.was=r.length,r.mode=V;case V:for(;_t=(St=r.distcode[st&(1<<r.distbits)-1])>>>16&255,yt=65535&St,!((gt=St>>>24)<=ht);){if(0===ot)break t;ot--,st+=tt[rt++]<<ht,ht+=8}if(0==(240&_t)){for(vt=gt,xt=_t,bt=yt;_t=(St=r.distcode[bt+((st&(1<<vt+xt)-1)>>vt)])>>>16&255,yt=65535&St,!(vt+(gt=St>>>24)<=ht);){if(0===ot)break t;ot--,st+=tt[rt++]<<ht,ht+=8}st>>>=vt,ht-=vt,r.back+=vt}if(st>>>=gt,ht-=gt,r.back+=gt,64&_t){t.msg="invalid distance code",r.mode=K;break}r.offset=yt,r.extra=15&_t,r.mode=W;case W:if(r.extra){for(Ct=r.extra;ht<Ct;){if(0===ot)break t;ot--,st+=tt[rt++]<<ht,ht+=8}r.offset+=st&(1<<r.extra)-1,st>>>=r.extra,ht-=r.extra,r.back+=r.extra}if(r.offset>r.dmax){t.msg="invalid distance too far back",r.mode=K;break}r.mode=Z;case Z:if(0===at)break t;if(dt=lt-at,r.offset>dt){if((dt=r.offset-dt)>r.whave&&r.sane){t.msg="invalid distance too far back",r.mode=K;break}dt>r.wnext?(dt-=r.wnext,pt=r.wsize-dt):pt=r.wnext-dt,dt>r.length&&(dt=r.length),mt=r.window}else mt=et,pt=it-r.offset,dt=r.length;dt>at&&(dt=at),at-=dt,r.length-=dt;do{et[it++]=mt[pt++]}while(--dt);0===r.length&&(r.mode=j);break;case X:if(0===at)break t;et[it++]=r.length,at--,r.mode=j;break;case q:if(r.wrap){for(;ht<32;){if(0===ot)break t;ot--,st|=tt[rt++]<<ht,ht+=8}if(lt-=at,t.total_out+=lt,r.total+=lt,lt&&(t.adler=r.check=r.flags?o(r.check,et,lt,it-lt):i(r.check,et,lt,it-lt)),lt=at,(r.flags?st:nt(st))!==r.check){t.msg="incorrect data check",r.mode=K;break}st=0,ht=0}r.mode=Y;case Y:if(r.wrap&&r.flags){for(;ht<32;){if(0===ot)break t;ot--,st+=tt[rt++]<<ht,ht+=8}if(st!==(4294967295&r.total)){t.msg="incorrect length check",r.mode=K;break}st=0,ht=0}r.mode=J;case J:Tt=m;break t;case K:Tt=y;break t;case Q:return v;case $:default:return _}return t.next_out=it,t.avail_out=at,t.next_in=rt,t.avail_in=ot,r.hold=st,r.bits=ht,(r.wsize||lt!==t.avail_out&&r.mode<K&&(r.mode<q||e!==c))&&ft(t,t.output,t.next_out,lt-t.avail_out)?(r.mode=Q,v):(ut-=t.avail_in,lt-=t.avail_out,t.total_in+=ut,t.total_out+=lt,r.total+=lt,r.wrap&&lt&&(t.adler=r.check=r.flags?o(r.check,et,lt,t.next_out-lt):i(r.check,et,lt,t.next_out-lt)),t.data_type=r.bits+(r.last?64:0)+(r.mode===k?128:0)+(r.mode===H||r.mode===N?256:0),(0===ut&&0===lt||e===c)&&Tt===p&&(Tt=x),Tt)},e.inflateEnd=function(t){if(!t||!t.state)return _;var e=t.state;return e.window&&(e.window=null),t.state=null,p},e.inflateGetHeader=function(t,e){var r;return t&&t.state?0==(2&(r=t.state).wrap)?_:(r.head=e,e.done=!1,p):_},e.inflateSetDictionary=function(t,e){var r,n=e.length;return t&&t.state?0!==(r=t.state).wrap&&r.mode!==O?_:r.mode===O&&i(1,e,n,0)!==r.check?y:ft(t,e,n,n)?(r.mode=Q,v):(r.havedict=1,p):_},e.inflateInfo="pako inflate (from Nodeca project)"},function(t,e,r){"use strict";var n=r(80),i=r(4),o=r(36),a=r(34),s=r(18),h=r(35),u=r(77),l=Object.prototype.toString;function c(t){if(!(this instanceof c))return new c(t);this.options=i.assign({chunkSize:16384,windowBits:0,to:""},t||{});var e=this.options;e.raw&&e.windowBits>=0&&e.windowBits<16&&(e.windowBits=-e.windowBits,0===e.windowBits&&(e.windowBits=-15)),!(e.windowBits>=0&&e.windowBits<16)||t&&t.windowBits||(e.windowBits+=32),e.windowBits>15&&e.windowBits<48&&0==(15&e.windowBits)&&(e.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new h,this.strm.avail_out=0;var r=n.inflateInit2(this.strm,e.windowBits);if(r!==a.Z_OK)throw new Error(s[r]);this.header=new u,n.inflateGetHeader(this.strm,this.header)}function f(t,e){var r=new c(e);if(r.push(t,!0),r.err)throw r.msg||s[r.err];return r.result}c.prototype.push=function(t,e){var r,s,h,u,c,f,d=this.strm,p=this.options.chunkSize,m=this.options.dictionary,g=!1;if(this.ended)return!1;s=e===~~e?e:!0===e?a.Z_FINISH:a.Z_NO_FLUSH,"string"==typeof t?d.input=o.binstring2buf(t):"[object ArrayBuffer]"===l.call(t)?d.input=new Uint8Array(t):d.input=t,d.next_in=0,d.avail_in=d.input.length;do{if(0===d.avail_out&&(d.output=new i.Buf8(p),d.next_out=0,d.avail_out=p),(r=n.inflate(d,a.Z_NO_FLUSH))===a.Z_NEED_DICT&&m&&(f="string"==typeof m?o.string2buf(m):"[object ArrayBuffer]"===l.call(m)?new Uint8Array(m):m,r=n.inflateSetDictionary(this.strm,f)),r===a.Z_BUF_ERROR&&!0===g&&(r=a.Z_OK,g=!1),r!==a.Z_STREAM_END&&r!==a.Z_OK)return this.onEnd(r),this.ended=!0,!1;d.next_out&&(0!==d.avail_out&&r!==a.Z_STREAM_END&&(0!==d.avail_in||s!==a.Z_FINISH&&s!==a.Z_SYNC_FLUSH)||("string"===this.options.to?(h=o.utf8border(d.output,d.next_out),u=d.next_out-h,c=o.buf2string(d.output,h),d.next_out=u,d.avail_out=p-u,u&&i.arraySet(d.output,d.output,h,u,0),this.onData(c)):this.onData(i.shrinkBuf(d.output,d.next_out)))),0===d.avail_in&&0===d.avail_out&&(g=!0)}while((d.avail_in>0||0===d.avail_out)&&r!==a.Z_STREAM_END);return r===a.Z_STREAM_END&&(s=a.Z_FINISH),s===a.Z_FINISH?(r=n.inflateEnd(this.strm),this.onEnd(r),this.ended=!0,r===a.Z_OK):s!==a.Z_SYNC_FLUSH||(this.onEnd(a.Z_OK),d.avail_out=0,!0)},c.prototype.onData=function(t){this.chunks.push(t)},c.prototype.onEnd=function(t){t===a.Z_OK&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=i.flattenChunks(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg},e.Inflate=c,e.inflate=f,e.inflateRaw=function(t,e){return(e=e||{}).raw=!0,f(t,e)},e.ungzip=f},function(t,e,r){"use strict";var n=r(4),i=4,o=0,a=1,s=2;function h(t){for(var e=t.length;--e>=0;)t[e]=0}var u=0,l=1,c=2,f=29,d=256,p=d+1+f,m=30,g=19,_=2*p+1,y=15,v=16,x=7,b=256,w=16,T=17,E=18,C=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],S=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],A=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],M=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],P=new Array(2*(p+2));h(P);var R=new Array(2*m);h(R);var L=new Array(512);h(L);var O=new Array(256);h(O);var k=new Array(f);h(k);var D,I,N,F=new Array(m);function B(t,e,r,n,i){this.static_tree=t,this.extra_bits=e,this.extra_base=r,this.elems=n,this.max_length=i,this.has_stree=t&&t.length}function z(t,e){this.dyn_tree=t,this.max_code=0,this.stat_desc=e}function U(t){return t<256?L[t]:L[256+(t>>>7)]}function H(t,e){t.pending_buf[t.pending++]=255&e,t.pending_buf[t.pending++]=e>>>8&255}function j(t,e,r){t.bi_valid>v-r?(t.bi_buf|=e<<t.bi_valid&65535,H(t,t.bi_buf),t.bi_buf=e>>v-t.bi_valid,t.bi_valid+=r-v):(t.bi_buf|=e<<t.bi_valid&65535,t.bi_valid+=r)}function G(t,e,r){j(t,r[2*e],r[2*e+1])}function V(t,e){var r=0;do{r|=1&t,t>>>=1,r<<=1}while(--e>0);return r>>>1}function W(t,e,r){var n,i,o=new Array(y+1),a=0;for(n=1;n<=y;n++)o[n]=a=a+r[n-1]<<1;for(i=0;i<=e;i++){var s=t[2*i+1];0!==s&&(t[2*i]=V(o[s]++,s))}}function Z(t){var e;for(e=0;e<p;e++)t.dyn_ltree[2*e]=0;for(e=0;e<m;e++)t.dyn_dtree[2*e]=0;for(e=0;e<g;e++)t.bl_tree[2*e]=0;t.dyn_ltree[2*b]=1,t.opt_len=t.static_len=0,t.last_lit=t.matches=0}function X(t){t.bi_valid>8?H(t,t.bi_buf):t.bi_valid>0&&(t.pending_buf[t.pending++]=t.bi_buf),t.bi_buf=0,t.bi_valid=0}function q(t,e,r,n){var i=2*e,o=2*r;return t[i]<t[o]||t[i]===t[o]&&n[e]<=n[r]}function Y(t,e,r){for(var n=t.heap[r],i=r<<1;i<=t.heap_len&&(i<t.heap_len&&q(e,t.heap[i+1],t.heap[i],t.depth)&&i++,!q(e,n,t.heap[i],t.depth));)t.heap[r]=t.heap[i],r=i,i<<=1;t.heap[r]=n}function J(t,e,r){var n,i,o,a,s=0;if(0!==t.last_lit)do{n=t.pending_buf[t.d_buf+2*s]<<8|t.pending_buf[t.d_buf+2*s+1],i=t.pending_buf[t.l_buf+s],s++,0===n?G(t,i,e):(G(t,(o=O[i])+d+1,e),0!==(a=C[o])&&j(t,i-=k[o],a),G(t,o=U(--n),r),0!==(a=S[o])&&j(t,n-=F[o],a))}while(s<t.last_lit);G(t,b,e)}function K(t,e){var r,n,i,o=e.dyn_tree,a=e.stat_desc.static_tree,s=e.stat_desc.has_stree,h=e.stat_desc.elems,u=-1;for(t.heap_len=0,t.heap_max=_,r=0;r<h;r++)0!==o[2*r]?(t.heap[++t.heap_len]=u=r,t.depth[r]=0):o[2*r+1]=0;for(;t.heap_len<2;)o[2*(i=t.heap[++t.heap_len]=u<2?++u:0)]=1,t.depth[i]=0,t.opt_len--,s&&(t.static_len-=a[2*i+1]);for(e.max_code=u,r=t.heap_len>>1;r>=1;r--)Y(t,o,r);i=h;do{r=t.heap[1],t.heap[1]=t.heap[t.heap_len--],Y(t,o,1),n=t.heap[1],t.heap[--t.heap_max]=r,t.heap[--t.heap_max]=n,o[2*i]=o[2*r]+o[2*n],t.depth[i]=(t.depth[r]>=t.depth[n]?t.depth[r]:t.depth[n])+1,o[2*r+1]=o[2*n+1]=i,t.heap[1]=i++,Y(t,o,1)}while(t.heap_len>=2);t.heap[--t.heap_max]=t.heap[1],function(t,e){var r,n,i,o,a,s,h=e.dyn_tree,u=e.max_code,l=e.stat_desc.static_tree,c=e.stat_desc.has_stree,f=e.stat_desc.extra_bits,d=e.stat_desc.extra_base,p=e.stat_desc.max_length,m=0;for(o=0;o<=y;o++)t.bl_count[o]=0;for(h[2*t.heap[t.heap_max]+1]=0,r=t.heap_max+1;r<_;r++)(o=h[2*h[2*(n=t.heap[r])+1]+1]+1)>p&&(o=p,m++),h[2*n+1]=o,n>u||(t.bl_count[o]++,a=0,n>=d&&(a=f[n-d]),s=h[2*n],t.opt_len+=s*(o+a),c&&(t.static_len+=s*(l[2*n+1]+a)));if(0!==m){do{for(o=p-1;0===t.bl_count[o];)o--;t.bl_count[o]--,t.bl_count[o+1]+=2,t.bl_count[p]--,m-=2}while(m>0);for(o=p;0!==o;o--)for(n=t.bl_count[o];0!==n;)(i=t.heap[--r])>u||(h[2*i+1]!==o&&(t.opt_len+=(o-h[2*i+1])*h[2*i],h[2*i+1]=o),n--)}}(t,e),W(o,u,t.bl_count)}function Q(t,e,r){var n,i,o=-1,a=e[1],s=0,h=7,u=4;for(0===a&&(h=138,u=3),e[2*(r+1)+1]=65535,n=0;n<=r;n++)i=a,a=e[2*(n+1)+1],++s<h&&i===a||(s<u?t.bl_tree[2*i]+=s:0!==i?(i!==o&&t.bl_tree[2*i]++,t.bl_tree[2*w]++):s<=10?t.bl_tree[2*T]++:t.bl_tree[2*E]++,s=0,o=i,0===a?(h=138,u=3):i===a?(h=6,u=3):(h=7,u=4))}function $(t,e,r){var n,i,o=-1,a=e[1],s=0,h=7,u=4;for(0===a&&(h=138,u=3),n=0;n<=r;n++)if(i=a,a=e[2*(n+1)+1],!(++s<h&&i===a)){if(s<u)do{G(t,i,t.bl_tree)}while(0!=--s);else 0!==i?(i!==o&&(G(t,i,t.bl_tree),s--),G(t,w,t.bl_tree),j(t,s-3,2)):s<=10?(G(t,T,t.bl_tree),j(t,s-3,3)):(G(t,E,t.bl_tree),j(t,s-11,7));s=0,o=i,0===a?(h=138,u=3):i===a?(h=6,u=3):(h=7,u=4)}}h(F);var tt=!1;function et(t,e,r,i){j(t,(u<<1)+(i?1:0),3),function(t,e,r,i){X(t),i&&(H(t,r),H(t,~r)),n.arraySet(t.pending_buf,t.window,e,r,t.pending),t.pending+=r}(t,e,r,!0)}e._tr_init=function(t){tt||(function(){var t,e,r,n,i,o=new Array(y+1);for(r=0,n=0;n<f-1;n++)for(k[n]=r,t=0;t<1<<C[n];t++)O[r++]=n;for(O[r-1]=n,i=0,n=0;n<16;n++)for(F[n]=i,t=0;t<1<<S[n];t++)L[i++]=n;for(i>>=7;n<m;n++)for(F[n]=i<<7,t=0;t<1<<S[n]-7;t++)L[256+i++]=n;for(e=0;e<=y;e++)o[e]=0;for(t=0;t<=143;)P[2*t+1]=8,t++,o[8]++;for(;t<=255;)P[2*t+1]=9,t++,o[9]++;for(;t<=279;)P[2*t+1]=7,t++,o[7]++;for(;t<=287;)P[2*t+1]=8,t++,o[8]++;for(W(P,p+1,o),t=0;t<m;t++)R[2*t+1]=5,R[2*t]=V(t,5);D=new B(P,C,d+1,p,y),I=new B(R,S,0,m,y),N=new B(new Array(0),A,0,g,x)}(),tt=!0),t.l_desc=new z(t.dyn_ltree,D),t.d_desc=new z(t.dyn_dtree,I),t.bl_desc=new z(t.bl_tree,N),t.bi_buf=0,t.bi_valid=0,Z(t)},e._tr_stored_block=et,e._tr_flush_block=function(t,e,r,n){var h,u,f=0;t.level>0?(t.strm.data_type===s&&(t.strm.data_type=function(t){var e,r=4093624447;for(e=0;e<=31;e++,r>>>=1)if(1&r&&0!==t.dyn_ltree[2*e])return o;if(0!==t.dyn_ltree[18]||0!==t.dyn_ltree[20]||0!==t.dyn_ltree[26])return a;for(e=32;e<d;e++)if(0!==t.dyn_ltree[2*e])return a;return o}(t)),K(t,t.l_desc),K(t,t.d_desc),f=function(t){var e;for(Q(t,t.dyn_ltree,t.l_desc.max_code),Q(t,t.dyn_dtree,t.d_desc.max_code),K(t,t.bl_desc),e=g-1;e>=3&&0===t.bl_tree[2*M[e]+1];e--);return t.opt_len+=3*(e+1)+5+5+4,e}(t),h=t.opt_len+3+7>>>3,(u=t.static_len+3+7>>>3)<=h&&(h=u)):h=u=r+5,r+4<=h&&-1!==e?et(t,e,r,n):t.strategy===i||u===h?(j(t,(l<<1)+(n?1:0),3),J(t,P,R)):(j(t,(c<<1)+(n?1:0),3),function(t,e,r,n){var i;for(j(t,e-257,5),j(t,r-1,5),j(t,n-4,4),i=0;i<n;i++)j(t,t.bl_tree[2*M[i]+1],3);$(t,t.dyn_ltree,e-1),$(t,t.dyn_dtree,r-1)}(t,t.l_desc.max_code+1,t.d_desc.max_code+1,f+1),J(t,t.dyn_ltree,t.dyn_dtree)),Z(t),n&&X(t)},e._tr_tally=function(t,e,r){return t.pending_buf[t.d_buf+2*t.last_lit]=e>>>8&255,t.pending_buf[t.d_buf+2*t.last_lit+1]=255&e,t.pending_buf[t.l_buf+t.last_lit]=255&r,t.last_lit++,0===e?t.dyn_ltree[2*r]++:(t.matches++,e--,t.dyn_ltree[2*(O[r]+d+1)]++,t.dyn_dtree[2*U(e)]++),t.last_lit===t.lit_bufsize-1},e._tr_align=function(t){j(t,l<<1,3),G(t,b,P),function(t){16===t.bi_valid?(H(t,t.bi_buf),t.bi_buf=0,t.bi_valid=0):t.bi_valid>=8&&(t.pending_buf[t.pending++]=255&t.bi_buf,t.bi_buf>>=8,t.bi_valid-=8)}(t)}},function(t,e,r){"use strict";var n,i=r(4),o=r(82),a=r(38),s=r(37),h=r(18),u=0,l=1,c=3,f=4,d=5,p=0,m=1,g=-2,_=-3,y=-5,v=-1,x=1,b=2,w=3,T=4,E=0,C=2,S=8,A=9,M=15,P=8,R=286,L=30,O=19,k=2*R+1,D=15,I=3,N=258,F=N+I+1,B=32,z=42,U=69,H=73,j=91,G=103,V=113,W=666,Z=1,X=2,q=3,Y=4,J=3;function K(t,e){return t.msg=h[e],e}function Q(t){return(t<<1)-(t>4?9:0)}function $(t){for(var e=t.length;--e>=0;)t[e]=0}function tt(t){var e=t.state,r=e.pending;r>t.avail_out&&(r=t.avail_out),0!==r&&(i.arraySet(t.output,e.pending_buf,e.pending_out,r,t.next_out),t.next_out+=r,e.pending_out+=r,t.total_out+=r,t.avail_out-=r,e.pending-=r,0===e.pending&&(e.pending_out=0))}function et(t,e){o._tr_flush_block(t,t.block_start>=0?t.block_start:-1,t.strstart-t.block_start,e),t.block_start=t.strstart,tt(t.strm)}function rt(t,e){t.pending_buf[t.pending++]=e}function nt(t,e){t.pending_buf[t.pending++]=e>>>8&255,t.pending_buf[t.pending++]=255&e}function it(t,e){var r,n,i=t.max_chain_length,o=t.strstart,a=t.prev_length,s=t.nice_match,h=t.strstart>t.w_size-F?t.strstart-(t.w_size-F):0,u=t.window,l=t.w_mask,c=t.prev,f=t.strstart+N,d=u[o+a-1],p=u[o+a];t.prev_length>=t.good_match&&(i>>=2),s>t.lookahead&&(s=t.lookahead);do{if(u[(r=e)+a]===p&&u[r+a-1]===d&&u[r]===u[o]&&u[++r]===u[o+1]){o+=2,r++;do{}while(u[++o]===u[++r]&&u[++o]===u[++r]&&u[++o]===u[++r]&&u[++o]===u[++r]&&u[++o]===u[++r]&&u[++o]===u[++r]&&u[++o]===u[++r]&&u[++o]===u[++r]&&o<f);if(n=N-(f-o),o=f-N,n>a){if(t.match_start=e,a=n,n>=s)break;d=u[o+a-1],p=u[o+a]}}}while((e=c[e&l])>h&&0!=--i);return a<=t.lookahead?a:t.lookahead}function ot(t){var e,r,n,o,h,u,l,c,f,d,p=t.w_size;do{if(o=t.window_size-t.lookahead-t.strstart,t.strstart>=p+(p-F)){i.arraySet(t.window,t.window,p,p,0),t.match_start-=p,t.strstart-=p,t.block_start-=p,e=r=t.hash_size;do{n=t.head[--e],t.head[e]=n>=p?n-p:0}while(--r);e=r=p;do{n=t.prev[--e],t.prev[e]=n>=p?n-p:0}while(--r);o+=p}if(0===t.strm.avail_in)break;if(u=t.strm,l=t.window,c=t.strstart+t.lookahead,f=o,d=void 0,(d=u.avail_in)>f&&(d=f),r=0===d?0:(u.avail_in-=d,i.arraySet(l,u.input,u.next_in,d,c),1===u.state.wrap?u.adler=a(u.adler,l,d,c):2===u.state.wrap&&(u.adler=s(u.adler,l,d,c)),u.next_in+=d,u.total_in+=d,d),t.lookahead+=r,t.lookahead+t.insert>=I)for(h=t.strstart-t.insert,t.ins_h=t.window[h],t.ins_h=(t.ins_h<<t.hash_shift^t.window[h+1])&t.hash_mask;t.insert&&(t.ins_h=(t.ins_h<<t.hash_shift^t.window[h+I-1])&t.hash_mask,t.prev[h&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=h,h++,t.insert--,!(t.lookahead+t.insert<I)););}while(t.lookahead<F&&0!==t.strm.avail_in)}function at(t,e){for(var r,n;;){if(t.lookahead<F){if(ot(t),t.lookahead<F&&e===u)return Z;if(0===t.lookahead)break}if(r=0,t.lookahead>=I&&(t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+I-1])&t.hash_mask,r=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),0!==r&&t.strstart-r<=t.w_size-F&&(t.match_length=it(t,r)),t.match_length>=I)if(n=o._tr_tally(t,t.strstart-t.match_start,t.match_length-I),t.lookahead-=t.match_length,t.match_length<=t.max_lazy_match&&t.lookahead>=I){t.match_length--;do{t.strstart++,t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+I-1])&t.hash_mask,r=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart}while(0!=--t.match_length);t.strstart++}else t.strstart+=t.match_length,t.match_length=0,t.ins_h=t.window[t.strstart],t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+1])&t.hash_mask;else n=o._tr_tally(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++;if(n&&(et(t,!1),0===t.strm.avail_out))return Z}return t.insert=t.strstart<I-1?t.strstart:I-1,e===f?(et(t,!0),0===t.strm.avail_out?q:Y):t.last_lit&&(et(t,!1),0===t.strm.avail_out)?Z:X}function st(t,e){for(var r,n,i;;){if(t.lookahead<F){if(ot(t),t.lookahead<F&&e===u)return Z;if(0===t.lookahead)break}if(r=0,t.lookahead>=I&&(t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+I-1])&t.hash_mask,r=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),t.prev_length=t.match_length,t.prev_match=t.match_start,t.match_length=I-1,0!==r&&t.prev_length<t.max_lazy_match&&t.strstart-r<=t.w_size-F&&(t.match_length=it(t,r),t.match_length<=5&&(t.strategy===x||t.match_length===I&&t.strstart-t.match_start>4096)&&(t.match_length=I-1)),t.prev_length>=I&&t.match_length<=t.prev_length){i=t.strstart+t.lookahead-I,n=o._tr_tally(t,t.strstart-1-t.prev_match,t.prev_length-I),t.lookahead-=t.prev_length-1,t.prev_length-=2;do{++t.strstart<=i&&(t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+I-1])&t.hash_mask,r=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart)}while(0!=--t.prev_length);if(t.match_available=0,t.match_length=I-1,t.strstart++,n&&(et(t,!1),0===t.strm.avail_out))return Z}else if(t.match_available){if((n=o._tr_tally(t,0,t.window[t.strstart-1]))&&et(t,!1),t.strstart++,t.lookahead--,0===t.strm.avail_out)return Z}else t.match_available=1,t.strstart++,t.lookahead--}return t.match_available&&(n=o._tr_tally(t,0,t.window[t.strstart-1]),t.match_available=0),t.insert=t.strstart<I-1?t.strstart:I-1,e===f?(et(t,!0),0===t.strm.avail_out?q:Y):t.last_lit&&(et(t,!1),0===t.strm.avail_out)?Z:X}function ht(t,e,r,n,i){this.good_length=t,this.max_lazy=e,this.nice_length=r,this.max_chain=n,this.func=i}function ut(t){var e;return t&&t.state?(t.total_in=t.total_out=0,t.data_type=C,(e=t.state).pending=0,e.pending_out=0,e.wrap<0&&(e.wrap=-e.wrap),e.status=e.wrap?z:V,t.adler=2===e.wrap?0:1,e.last_flush=u,o._tr_init(e),p):K(t,g)}function lt(t){var e,r=ut(t);return r===p&&((e=t.state).window_size=2*e.w_size,$(e.head),e.max_lazy_match=n[e.level].max_lazy,e.good_match=n[e.level].good_length,e.nice_match=n[e.level].nice_length,e.max_chain_length=n[e.level].max_chain,e.strstart=0,e.block_start=0,e.lookahead=0,e.insert=0,e.match_length=e.prev_length=I-1,e.match_available=0,e.ins_h=0),r}function ct(t,e,r,n,o,a){if(!t)return g;var s=1;if(e===v&&(e=6),n<0?(s=0,n=-n):n>15&&(s=2,n-=16),o<1||o>A||r!==S||n<8||n>15||e<0||e>9||a<0||a>T)return K(t,g);8===n&&(n=9);var h=new function(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=S,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new i.Buf16(2*k),this.dyn_dtree=new i.Buf16(2*(2*L+1)),this.bl_tree=new i.Buf16(2*(2*O+1)),$(this.dyn_ltree),$(this.dyn_dtree),$(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new i.Buf16(D+1),this.heap=new i.Buf16(2*R+1),$(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new i.Buf16(2*R+1),$(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0};return t.state=h,h.strm=t,h.wrap=s,h.gzhead=null,h.w_bits=n,h.w_size=1<<h.w_bits,h.w_mask=h.w_size-1,h.hash_bits=o+7,h.hash_size=1<<h.hash_bits,h.hash_mask=h.hash_size-1,h.hash_shift=~~((h.hash_bits+I-1)/I),h.window=new i.Buf8(2*h.w_size),h.head=new i.Buf16(h.hash_size),h.prev=new i.Buf16(h.w_size),h.lit_bufsize=1<<o+6,h.pending_buf_size=4*h.lit_bufsize,h.pending_buf=new i.Buf8(h.pending_buf_size),h.d_buf=1*h.lit_bufsize,h.l_buf=3*h.lit_bufsize,h.level=e,h.strategy=a,h.method=r,lt(t)}n=[new ht(0,0,0,0,function(t,e){var r=65535;for(r>t.pending_buf_size-5&&(r=t.pending_buf_size-5);;){if(t.lookahead<=1){if(ot(t),0===t.lookahead&&e===u)return Z;if(0===t.lookahead)break}t.strstart+=t.lookahead,t.lookahead=0;var n=t.block_start+r;if((0===t.strstart||t.strstart>=n)&&(t.lookahead=t.strstart-n,t.strstart=n,et(t,!1),0===t.strm.avail_out))return Z;if(t.strstart-t.block_start>=t.w_size-F&&(et(t,!1),0===t.strm.avail_out))return Z}return t.insert=0,e===f?(et(t,!0),0===t.strm.avail_out?q:Y):(t.strstart>t.block_start&&(et(t,!1),t.strm.avail_out),Z)}),new ht(4,4,8,4,at),new ht(4,5,16,8,at),new ht(4,6,32,32,at),new ht(4,4,16,16,st),new ht(8,16,32,32,st),new ht(8,16,128,128,st),new ht(8,32,128,256,st),new ht(32,128,258,1024,st),new ht(32,258,258,4096,st)],e.deflateInit=function(t,e){return ct(t,e,S,M,P,E)},e.deflateInit2=ct,e.deflateReset=lt,e.deflateResetKeep=ut,e.deflateSetHeader=function(t,e){return t&&t.state?2!==t.state.wrap?g:(t.state.gzhead=e,p):g},e.deflate=function(t,e){var r,i,a,h;if(!t||!t.state||e>d||e<0)return t?K(t,g):g;if(i=t.state,!t.output||!t.input&&0!==t.avail_in||i.status===W&&e!==f)return K(t,0===t.avail_out?y:g);if(i.strm=t,r=i.last_flush,i.last_flush=e,i.status===z)if(2===i.wrap)t.adler=0,rt(i,31),rt(i,139),rt(i,8),i.gzhead?(rt(i,(i.gzhead.text?1:0)+(i.gzhead.hcrc?2:0)+(i.gzhead.extra?4:0)+(i.gzhead.name?8:0)+(i.gzhead.comment?16:0)),rt(i,255&i.gzhead.time),rt(i,i.gzhead.time>>8&255),rt(i,i.gzhead.time>>16&255),rt(i,i.gzhead.time>>24&255),rt(i,9===i.level?2:i.strategy>=b||i.level<2?4:0),rt(i,255&i.gzhead.os),i.gzhead.extra&&i.gzhead.extra.length&&(rt(i,255&i.gzhead.extra.length),rt(i,i.gzhead.extra.length>>8&255)),i.gzhead.hcrc&&(t.adler=s(t.adler,i.pending_buf,i.pending,0)),i.gzindex=0,i.status=U):(rt(i,0),rt(i,0),rt(i,0),rt(i,0),rt(i,0),rt(i,9===i.level?2:i.strategy>=b||i.level<2?4:0),rt(i,J),i.status=V);else{var _=S+(i.w_bits-8<<4)<<8;_|=(i.strategy>=b||i.level<2?0:i.level<6?1:6===i.level?2:3)<<6,0!==i.strstart&&(_|=B),_+=31-_%31,i.status=V,nt(i,_),0!==i.strstart&&(nt(i,t.adler>>>16),nt(i,65535&t.adler)),t.adler=1}if(i.status===U)if(i.gzhead.extra){for(a=i.pending;i.gzindex<(65535&i.gzhead.extra.length)&&(i.pending!==i.pending_buf_size||(i.gzhead.hcrc&&i.pending>a&&(t.adler=s(t.adler,i.pending_buf,i.pending-a,a)),tt(t),a=i.pending,i.pending!==i.pending_buf_size));)rt(i,255&i.gzhead.extra[i.gzindex]),i.gzindex++;i.gzhead.hcrc&&i.pending>a&&(t.adler=s(t.adler,i.pending_buf,i.pending-a,a)),i.gzindex===i.gzhead.extra.length&&(i.gzindex=0,i.status=H)}else i.status=H;if(i.status===H)if(i.gzhead.name){a=i.pending;do{if(i.pending===i.pending_buf_size&&(i.gzhead.hcrc&&i.pending>a&&(t.adler=s(t.adler,i.pending_buf,i.pending-a,a)),tt(t),a=i.pending,i.pending===i.pending_buf_size)){h=1;break}h=i.gzindex<i.gzhead.name.length?255&i.gzhead.name.charCodeAt(i.gzindex++):0,rt(i,h)}while(0!==h);i.gzhead.hcrc&&i.pending>a&&(t.adler=s(t.adler,i.pending_buf,i.pending-a,a)),0===h&&(i.gzindex=0,i.status=j)}else i.status=j;if(i.status===j)if(i.gzhead.comment){a=i.pending;do{if(i.pending===i.pending_buf_size&&(i.gzhead.hcrc&&i.pending>a&&(t.adler=s(t.adler,i.pending_buf,i.pending-a,a)),tt(t),a=i.pending,i.pending===i.pending_buf_size)){h=1;break}h=i.gzindex<i.gzhead.comment.length?255&i.gzhead.comment.charCodeAt(i.gzindex++):0,rt(i,h)}while(0!==h);i.gzhead.hcrc&&i.pending>a&&(t.adler=s(t.adler,i.pending_buf,i.pending-a,a)),0===h&&(i.status=G)}else i.status=G;if(i.status===G&&(i.gzhead.hcrc?(i.pending+2>i.pending_buf_size&&tt(t),i.pending+2<=i.pending_buf_size&&(rt(i,255&t.adler),rt(i,t.adler>>8&255),t.adler=0,i.status=V)):i.status=V),0!==i.pending){if(tt(t),0===t.avail_out)return i.last_flush=-1,p}else if(0===t.avail_in&&Q(e)<=Q(r)&&e!==f)return K(t,y);if(i.status===W&&0!==t.avail_in)return K(t,y);if(0!==t.avail_in||0!==i.lookahead||e!==u&&i.status!==W){var v=i.strategy===b?function(t,e){for(var r;;){if(0===t.lookahead&&(ot(t),0===t.lookahead)){if(e===u)return Z;break}if(t.match_length=0,r=o._tr_tally(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++,r&&(et(t,!1),0===t.strm.avail_out))return Z}return t.insert=0,e===f?(et(t,!0),0===t.strm.avail_out?q:Y):t.last_lit&&(et(t,!1),0===t.strm.avail_out)?Z:X}(i,e):i.strategy===w?function(t,e){for(var r,n,i,a,s=t.window;;){if(t.lookahead<=N){if(ot(t),t.lookahead<=N&&e===u)return Z;if(0===t.lookahead)break}if(t.match_length=0,t.lookahead>=I&&t.strstart>0&&(n=s[i=t.strstart-1])===s[++i]&&n===s[++i]&&n===s[++i]){a=t.strstart+N;do{}while(n===s[++i]&&n===s[++i]&&n===s[++i]&&n===s[++i]&&n===s[++i]&&n===s[++i]&&n===s[++i]&&n===s[++i]&&i<a);t.match_length=N-(a-i),t.match_length>t.lookahead&&(t.match_length=t.lookahead)}if(t.match_length>=I?(r=o._tr_tally(t,1,t.match_length-I),t.lookahead-=t.match_length,t.strstart+=t.match_length,t.match_length=0):(r=o._tr_tally(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++),r&&(et(t,!1),0===t.strm.avail_out))return Z}return t.insert=0,e===f?(et(t,!0),0===t.strm.avail_out?q:Y):t.last_lit&&(et(t,!1),0===t.strm.avail_out)?Z:X}(i,e):n[i.level].func(i,e);if(v!==q&&v!==Y||(i.status=W),v===Z||v===q)return 0===t.avail_out&&(i.last_flush=-1),p;if(v===X&&(e===l?o._tr_align(i):e!==d&&(o._tr_stored_block(i,0,0,!1),e===c&&($(i.head),0===i.lookahead&&(i.strstart=0,i.block_start=0,i.insert=0))),tt(t),0===t.avail_out))return i.last_flush=-1,p}return e!==f?p:i.wrap<=0?m:(2===i.wrap?(rt(i,255&t.adler),rt(i,t.adler>>8&255),rt(i,t.adler>>16&255),rt(i,t.adler>>24&255),rt(i,255&t.total_in),rt(i,t.total_in>>8&255),rt(i,t.total_in>>16&255),rt(i,t.total_in>>24&255)):(nt(i,t.adler>>>16),nt(i,65535&t.adler)),tt(t),i.wrap>0&&(i.wrap=-i.wrap),0!==i.pending?p:m)},e.deflateEnd=function(t){var e;return t&&t.state?(e=t.state.status)!==z&&e!==U&&e!==H&&e!==j&&e!==G&&e!==V&&e!==W?K(t,g):(t.state=null,e===V?K(t,_):p):g},e.deflateSetDictionary=function(t,e){var r,n,o,s,h,u,l,c,f=e.length;if(!t||!t.state)return g;if(2===(s=(r=t.state).wrap)||1===s&&r.status!==z||r.lookahead)return g;for(1===s&&(t.adler=a(t.adler,e,f,0)),r.wrap=0,f>=r.w_size&&(0===s&&($(r.head),r.strstart=0,r.block_start=0,r.insert=0),c=new i.Buf8(r.w_size),i.arraySet(c,e,f-r.w_size,r.w_size,0),e=c,f=r.w_size),h=t.avail_in,u=t.next_in,l=t.input,t.avail_in=f,t.next_in=0,t.input=e,ot(r);r.lookahead>=I;){n=r.strstart,o=r.lookahead-(I-1);do{r.ins_h=(r.ins_h<<r.hash_shift^r.window[n+I-1])&r.hash_mask,r.prev[n&r.w_mask]=r.head[r.ins_h],r.head[r.ins_h]=n,n++}while(--o);r.strstart=n,r.lookahead=I-1,ot(r)}return r.strstart+=r.lookahead,r.block_start=r.strstart,r.insert=r.lookahead,r.lookahead=0,r.match_length=r.prev_length=I-1,r.match_available=0,t.next_in=u,t.input=l,t.avail_in=h,r.wrap=s,p},e.deflateInfo="pako deflate (from Nodeca project)"},function(t,e,r){"use strict";var n=r(83),i=r(4),o=r(36),a=r(18),s=r(35),h=Object.prototype.toString,u=0,l=-1,c=0,f=8;function d(t){if(!(this instanceof d))return new d(t);this.options=i.assign({level:l,method:f,chunkSize:16384,windowBits:15,memLevel:8,strategy:c,to:""},t||{});var e=this.options;e.raw&&e.windowBits>0?e.windowBits=-e.windowBits:e.gzip&&e.windowBits>0&&e.windowBits<16&&(e.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new s,this.strm.avail_out=0;var r=n.deflateInit2(this.strm,e.level,e.method,e.windowBits,e.memLevel,e.strategy);if(r!==u)throw new Error(a[r]);if(e.header&&n.deflateSetHeader(this.strm,e.header),e.dictionary){var p;if(p="string"==typeof e.dictionary?o.string2buf(e.dictionary):"[object ArrayBuffer]"===h.call(e.dictionary)?new Uint8Array(e.dictionary):e.dictionary,(r=n.deflateSetDictionary(this.strm,p))!==u)throw new Error(a[r]);this._dict_set=!0}}function p(t,e){var r=new d(e);if(r.push(t,!0),r.err)throw r.msg||a[r.err];return r.result}d.prototype.push=function(t,e){var r,a,s=this.strm,l=this.options.chunkSize;if(this.ended)return!1;a=e===~~e?e:!0===e?4:0,"string"==typeof t?s.input=o.string2buf(t):"[object ArrayBuffer]"===h.call(t)?s.input=new Uint8Array(t):s.input=t,s.next_in=0,s.avail_in=s.input.length;do{if(0===s.avail_out&&(s.output=new i.Buf8(l),s.next_out=0,s.avail_out=l),1!==(r=n.deflate(s,a))&&r!==u)return this.onEnd(r),this.ended=!0,!1;0!==s.avail_out&&(0!==s.avail_in||4!==a&&2!==a)||("string"===this.options.to?this.onData(o.buf2binstring(i.shrinkBuf(s.output,s.next_out))):this.onData(i.shrinkBuf(s.output,s.next_out)))}while((s.avail_in>0||0===s.avail_out)&&1!==r);return 4===a?(r=n.deflateEnd(this.strm),this.onEnd(r),this.ended=!0,r===u):2!==a||(this.onEnd(u),s.avail_out=0,!0)},d.prototype.onData=function(t){this.chunks.push(t)},d.prototype.onEnd=function(t){t===u&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=i.flattenChunks(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg},e.Deflate=d,e.deflate=p,e.deflateRaw=function(t,e){return(e=e||{}).raw=!0,p(t,e)},e.gzip=function(t,e){return(e=e||{}).gzip=!0,p(t,e)}},function(t,e,r){"use strict";var n={};(0,r(4).assign)(n,r(84),r(81),r(34)),t.exports=n},function(t,e,r){"use strict";var n="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Uint32Array,i=r(85),o=r(1),a=r(2),s=n?"uint8array":"array";function h(t,e){a.call(this,"FlateWorker/"+t),this._pako=null,this._pakoAction=t,this._pakoOptions=e,this.meta={}}e.magic="\b\0",o.inherits(h,a),h.prototype.processChunk=function(t){this.meta=t.meta,null===this._pako&&this._createPako(),this._pako.push(o.transformTo(s,t.data),!1)},h.prototype.flush=function(){a.prototype.flush.call(this),null===this._pako&&this._createPako(),this._pako.push([],!0)},h.prototype.cleanUp=function(){a.prototype.cleanUp.call(this),this._pako=null},h.prototype._createPako=function(){this._pako=new i[this._pakoAction]({raw:!0,level:this._pakoOptions.level||-1});var t=this;this._pako.onData=function(e){t.push({data:e,meta:t.meta})}},e.compressWorker=function(t){return new h("Deflate",t)},e.uncompressWorker=function(){return new h("Inflate",{})}},function(t,e,r){"use strict";var n=r(39),i=r(76);e.generateWorker=function(t,e,r){var o=new i(e.streamFiles,r,e.platform,e.encodeFileName),a=0;try{t.forEach(function(t,r){a++;var i=function(t,e){var r=t||e,i=n[r];if(!i)throw new Error(r+" is not a valid compression method !");return i}(r.options.compression,e.compression),s=r.options.compressionOptions||e.compressionOptions||{},h=r.dir,u=r.date;r._compressWorker(i,s).withStreamInfo("file",{name:t,dir:h,date:u,comment:r.comment||"",unixPermissions:r.unixPermissions,dosPermissions:r.dosPermissions}).pipe(o)}),o.entriesCount=a}catch(t){o.error(t)}return o}},function(t,e,r){"use strict";var n=r(44),i=r(42),o=r(9),a=r(20),s=r(2),h=function(t,e,r){this.name=t,this.dir=r.dir,this.date=r.date,this.comment=r.comment,this.unixPermissions=r.unixPermissions,this.dosPermissions=r.dosPermissions,this._data=e,this._dataBinary=r.binary,this.options={compression:r.compression,compressionOptions:r.compressionOptions}};h.prototype={internalStream:function(t){var e=null,r="string";try{if(!t)throw new Error("No output type specified.");var i="string"===(r=t.toLowerCase())||"text"===r;"binarystring"!==r&&"text"!==r||(r="string"),e=this._decompressWorker();var a=!this._dataBinary;a&&!i&&(e=e.pipe(new o.Utf8EncodeWorker)),!a&&i&&(e=e.pipe(new o.Utf8DecodeWorker))}catch(t){(e=new s("error")).error(t)}return new n(e,r,"")},async:function(t,e){return this.internalStream(t).accumulate(e)},nodeStream:function(t,e){return this.internalStream(t||"nodebuffer").toNodejsStream(e)},_compressWorker:function(t,e){if(this._data instanceof a&&this._data.compression.magic===t.magic)return this._data.getCompressedWorker();var r=this._decompressWorker();return this._dataBinary||(r=r.pipe(new o.Utf8EncodeWorker)),a.createWorkerFrom(r,t,e)},_decompressWorker:function(){return this._data instanceof a?this._data.getContentWorker():this._data instanceof s?this._data:new i(this._data)}};for(var u=["asText","asBinary","asNodeBuffer","asUint8Array","asArrayBuffer"],l=function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},c=0;c<u.length;c++)h.prototype[u[c]]=l;t.exports=h},function(t,e,r){"use strict";var n=r(56).Readable;function i(t,e,r){n.call(this,e),this._helper=t;var i=this;t.on("data",function(t,e){i.push(t)||i._helper.pause(),r&&r(e)}).on("error",function(t){i.emit("error",t)}).on("end",function(){i.push(null)})}r(1).inherits(i,n),i.prototype._read=function(){this._helper.resume()},t.exports=i},function(t,e,r){"use strict";var n=r(2),i=r(1);function o(t){n.call(this,"ConvertWorker to "+t),this.destType=t}i.inherits(o,n),o.prototype.processChunk=function(t){this.push({data:i.transformTo(this.destType,t.data),meta:t.meta})},t.exports=o},function(t,e,r){"use strict";(function(e){var r,n,i=e.MutationObserver||e.WebKitMutationObserver;if(i){var o=0,a=new i(l),s=e.document.createTextNode("");a.observe(s,{characterData:!0}),r=function(){s.data=o=++o%2}}else if(e.setImmediate||void 0===e.MessageChannel)r="document"in e&&"onreadystatechange"in e.document.createElement("script")?function(){var t=e.document.createElement("script");t.onreadystatechange=function(){l(),t.onreadystatechange=null,t.parentNode.removeChild(t),t=null},e.document.documentElement.appendChild(t)}:function(){setTimeout(l,0)};else{var h=new e.MessageChannel;h.port1.onmessage=l,r=function(){h.port2.postMessage(0)}}var u=[];function l(){var t,e;n=!0;for(var r=u.length;r;){for(e=u,u=[],t=-1;++t<r;)e[t]();r=u.length}n=!1}t.exports=function(t){1!==u.push(t)||n||r()}}).call(this,r(3))},function(t,e,r){"use strict";var n=r(91);function i(){}var o={},a=["REJECTED"],s=["FULFILLED"],h=["PENDING"];function u(t){if("function"!=typeof t)throw new TypeError("resolver must be a function");this.state=h,this.queue=[],this.outcome=void 0,t!==i&&d(this,t)}function l(t,e,r){this.promise=t,"function"==typeof e&&(this.onFulfilled=e,this.callFulfilled=this.otherCallFulfilled),"function"==typeof r&&(this.onRejected=r,this.callRejected=this.otherCallRejected)}function c(t,e,r){n(function(){var n;try{n=e(r)}catch(e){return o.reject(t,e)}n===t?o.reject(t,new TypeError("Cannot resolve promise with itself")):o.resolve(t,n)})}function f(t){var e=t&&t.then;if(t&&("object"==typeof t||"function"==typeof t)&&"function"==typeof e)return function(){e.apply(t,arguments)}}function d(t,e){var r=!1;function n(e){r||(r=!0,o.reject(t,e))}function i(e){r||(r=!0,o.resolve(t,e))}var a=p(function(){e(i,n)});"error"===a.status&&n(a.value)}function p(t,e){var r={};try{r.value=t(e),r.status="success"}catch(t){r.status="error",r.value=t}return r}t.exports=u,u.prototype.catch=function(t){return this.then(null,t)},u.prototype.then=function(t,e){if("function"!=typeof t&&this.state===s||"function"!=typeof e&&this.state===a)return this;var r=new this.constructor(i);this.state!==h?c(r,this.state===s?t:e,this.outcome):this.queue.push(new l(r,t,e));return r},l.prototype.callFulfilled=function(t){o.resolve(this.promise,t)},l.prototype.otherCallFulfilled=function(t){c(this.promise,this.onFulfilled,t)},l.prototype.callRejected=function(t){o.reject(this.promise,t)},l.prototype.otherCallRejected=function(t){c(this.promise,this.onRejected,t)},o.resolve=function(t,e){var r=p(f,e);if("error"===r.status)return o.reject(t,r.value);var n=r.value;if(n)d(t,n);else{t.state=s,t.outcome=e;for(var i=-1,a=t.queue.length;++i<a;)t.queue[i].callFulfilled(e)}return t},o.reject=function(t,e){t.state=a,t.outcome=e;for(var r=-1,n=t.queue.length;++r<n;)t.queue[r].callRejected(e);return t},u.resolve=function(t){if(t instanceof this)return t;return o.resolve(new this(i),t)},u.reject=function(t){var e=new this(i);return o.reject(e,t)},u.all=function(t){var e=this;if("[object Array]"!==Object.prototype.toString.call(t))return this.reject(new TypeError("must be an array"));var r=t.length,n=!1;if(!r)return this.resolve([]);var a=new Array(r),s=0,h=-1,u=new this(i);for(;++h<r;)l(t[h],h);return u;function l(t,i){e.resolve(t).then(function(t){a[i]=t,++s!==r||n||(n=!0,o.resolve(u,a))},function(t){n||(n=!0,o.reject(u,t))})}},u.race=function(t){var e=this;if("[object Array]"!==Object.prototype.toString.call(t))return this.reject(new TypeError("must be an array"));var r=t.length,n=!1;if(!r)return this.resolve([]);var a=-1,s=new this(i);for(;++a<r;)h=t[a],e.resolve(h).then(function(t){n||(n=!0,o.resolve(s,t))},function(t){n||(n=!0,o.reject(s,t))});var h;return s}},function(t,e){var r={}.toString;t.exports=function(t){return r.call(t).slice(8,-1)}},function(t,e,r){t.exports=r(13).document&&document.documentElement},function(t,e){t.exports=function(t,e,r){var n=void 0===r;switch(e.length){case 0:return n?t():t.call(r);case 1:return n?t(e[0]):t.call(r,e[0]);case 2:return n?t(e[0],e[1]):t.call(r,e[0],e[1]);case 3:return n?t(e[0],e[1],e[2]):t.call(r,e[0],e[1],e[2]);case 4:return n?t(e[0],e[1],e[2],e[3]):t.call(r,e[0],e[1],e[2],e[3])}return t.apply(r,e)}},function(t,e,r){var n,i,o,a=r(47),s=r(95),h=r(94),u=r(45),l=r(13),c=l.process,f=l.setImmediate,d=l.clearImmediate,p=l.MessageChannel,m=0,g={},_=function(){var t=+this;if(g.hasOwnProperty(t)){var e=g[t];delete g[t],e()}},y=function(t){_.call(t.data)};f&&d||(f=function(t){for(var e=[],r=1;arguments.length>r;)e.push(arguments[r++]);return g[++m]=function(){s("function"==typeof t?t:Function(t),e)},n(m),m},d=function(t){delete g[t]},"process"==r(93)(c)?n=function(t){c.nextTick(a(_,t,1))}:p?(o=(i=new p).port2,i.port1.onmessage=y,n=a(o.postMessage,o,1)):l.addEventListener&&"function"==typeof postMessage&&!l.importScripts?(n=function(t){l.postMessage(t+"","*")},l.addEventListener("message",y,!1)):n="onreadystatechange"in u("script")?function(t){h.appendChild(u("script")).onreadystatechange=function(){h.removeChild(this),_.call(t)}}:function(t){setTimeout(a(_,t,1),0)}),t.exports={set:f,clear:d}},function(t,e){t.exports=function(t,e){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:e}}},function(t,e,r){var n=r(22);t.exports=function(t,e){if(!n(t))return t;var r,i;if(e&&"function"==typeof(r=t.toString)&&!n(i=r.call(t)))return i;if("function"==typeof(r=t.valueOf)&&!n(i=r.call(t)))return i;if(!e&&"function"==typeof(r=t.toString)&&!n(i=r.call(t)))return i;throw TypeError("Can't convert object to primitive value")}},function(t,e,r){t.exports=!r(21)&&!r(46)(function(){return 7!=Object.defineProperty(r(45)("div"),"a",{get:function(){return 7}}).a})},function(t,e,r){var n=r(22);t.exports=function(t){if(!n(t))throw TypeError(t+" is not an object!");return t}},function(t,e,r){var n=r(100),i=r(99),o=r(98),a=Object.defineProperty;e.f=r(21)?Object.defineProperty:function(t,e,r){if(n(t),e=o(e,!0),n(r),i)try{return a(t,e,r)}catch(t){}if("get"in r||"set"in r)throw TypeError("Accessors not supported!");return"value"in r&&(t[e]=r.value),t}},function(t,e,r){var n=r(101),i=r(97);t.exports=r(21)?function(t,e,r){return n.f(t,e,i(1,r))}:function(t,e,r){return t[e]=r,t}},function(t,e){t.exports=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t}},function(t,e,r){var n=r(13),i=r(48),o=r(47),a=r(102),s=function(t,e,r){var h,u,l,c=t&s.F,f=t&s.G,d=t&s.S,p=t&s.P,m=t&s.B,g=t&s.W,_=f?i:i[e]||(i[e]={}),y=_.prototype,v=f?n:d?n[e]:(n[e]||{}).prototype;for(h in f&&(r=e),r)(u=!c&&v&&void 0!==v[h])&&h in _||(l=u?v[h]:r[h],_[h]=f&&"function"!=typeof v[h]?r[h]:m&&u?o(l,n):g&&v[h]==l?function(t){var e=function(e,r,n){if(this instanceof t){switch(arguments.length){case 0:return new t;case 1:return new t(e);case 2:return new t(e,r)}return new t(e,r,n)}return t.apply(this,arguments)};return e.prototype=t.prototype,e}(l):p&&"function"==typeof l?o(Function.call,l):l,p&&((_.virtual||(_.virtual={}))[h]=l,t&s.R&&y&&!y[h]&&a(y,h,l)))};s.F=1,s.G=2,s.S=4,s.P=8,s.B=16,s.W=32,s.U=64,s.R=128,t.exports=s},function(t,e,r){var n=r(104),i=r(96);n(n.G+n.B,{setImmediate:i.set,clearImmediate:i.clear})},function(t,e,r){r(105),t.exports=r(48).setImmediate},function(t,e,r){t.exports=r(24).PassThrough},function(t,e,r){t.exports=r(24).Transform},function(t,e,r){t.exports=r(7)},function(t,e,r){t.exports=r(23)},function(t,e,r){"use strict";t.exports=o;var n=r(50),i=r(11);function o(t){if(!(this instanceof o))return new o(t);n.call(this,t)}i.inherits=r(8),i.inherits(o,n),o.prototype._transform=function(t,e,r){r(null,t)}},function(t,e,r){(function(e){function r(t){try{if(!e.localStorage)return!1}catch(t){return!1}var r=e.localStorage[t];return null!=r&&"true"===String(r).toLowerCase()}t.exports=function(t,e){if(r("noDeprecation"))return t;var n=!1;return function(){if(!n){if(r("throwDeprecation"))throw new Error(e);r("traceDeprecation")?console.trace(e):console.warn(e),n=!0}return t.apply(this,arguments)}}}).call(this,r(3))},function(t,e,r){(function(t,e){!function(t,r){"use strict";if(!t.setImmediate){var n,i,o,a,s,h=1,u={},l=!1,c=t.document,f=Object.getPrototypeOf&&Object.getPrototypeOf(t);f=f&&f.setTimeout?f:t,"[object process]"==={}.toString.call(t.process)?n=function(t){e.nextTick(function(){p(t)})}:!function(){if(t.postMessage&&!t.importScripts){var e=!0,r=t.onmessage;return t.onmessage=function(){e=!1},t.postMessage("","*"),t.onmessage=r,e}}()?t.MessageChannel?((o=new MessageChannel).port1.onmessage=function(t){p(t.data)},n=function(t){o.port2.postMessage(t)}):c&&"onreadystatechange"in c.createElement("script")?(i=c.documentElement,n=function(t){var e=c.createElement("script");e.onreadystatechange=function(){p(t),e.onreadystatechange=null,i.removeChild(e),e=null},i.appendChild(e)}):n=function(t){setTimeout(p,0,t)}:(a="setImmediate$"+Math.random()+"$",s=function(e){e.source===t&&"string"==typeof e.data&&0===e.data.indexOf(a)&&p(+e.data.slice(a.length))},t.addEventListener?t.addEventListener("message",s,!1):t.attachEvent("onmessage",s),n=function(e){t.postMessage(a+e,"*")}),f.setImmediate=function(t){"function"!=typeof t&&(t=new Function(""+t));for(var e=new Array(arguments.length-1),r=0;r<e.length;r++)e[r]=arguments[r+1];var i={callback:t,args:e};return u[h]=i,n(h),h++},f.clearImmediate=d}function d(t){delete u[t]}function p(t){if(l)setTimeout(p,0,t);else{var e=u[t];if(e){l=!0;try{!function(t){var e=t.callback,n=t.args;switch(n.length){case 0:e();break;case 1:e(n[0]);break;case 2:e(n[0],n[1]);break;case 3:e(n[0],n[1],n[2]);break;default:e.apply(r,n)}}(e)}finally{d(t),l=!1}}}}}("undefined"==typeof self?void 0===t?this:t:self)}).call(this,r(3),r(6))},function(t,e){},function(t,e,r){"use strict";var n=r(15).Buffer,i=r(114);t.exports=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.head=null,this.tail=null,this.length=0}return t.prototype.push=function(t){var e={data:t,next:null};this.length>0?this.tail.next=e:this.head=e,this.tail=e,++this.length},t.prototype.unshift=function(t){var e={data:t,next:this.head};0===this.length&&(this.tail=e),this.head=e,++this.length},t.prototype.shift=function(){if(0!==this.length){var t=this.head.data;return 1===this.length?this.head=this.tail=null:this.head=this.head.next,--this.length,t}},t.prototype.clear=function(){this.head=this.tail=null,this.length=0},t.prototype.join=function(t){if(0===this.length)return"";for(var e=this.head,r=""+e.data;e=e.next;)r+=t+e.data;return r},t.prototype.concat=function(t){if(0===this.length)return n.alloc(0);if(1===this.length)return this.head.data;for(var e,r,i,o=n.allocUnsafe(t>>>0),a=this.head,s=0;a;)e=a.data,r=o,i=s,e.copy(r,i),s+=a.data.length,a=a.next;return o},t}(),i&&i.inspect&&i.inspect.custom&&(t.exports.prototype[i.inspect.custom]=function(){var t=i.inspect({length:this.length});return this.constructor.name+" "+t})},function(t,e){},function(t,e,r){t.exports=i;var n=r(25).EventEmitter;function i(){n.call(this)}r(8)(i,n),i.Readable=r(24),i.Writable=r(110),i.Duplex=r(109),i.Transform=r(108),i.PassThrough=r(107),i.Stream=i,i.prototype.pipe=function(t,e){var r=this;function i(e){t.writable&&!1===t.write(e)&&r.pause&&r.pause()}function o(){r.readable&&r.resume&&r.resume()}r.on("data",i),t.on("drain",o),t._isStdio||e&&!1===e.end||(r.on("end",s),r.on("close",h));var a=!1;function s(){a||(a=!0,t.end())}function h(){a||(a=!0,"function"==typeof t.destroy&&t.destroy())}function u(t){if(l(),0===n.listenerCount(this,"error"))throw t}function l(){r.removeListener("data",i),t.removeListener("drain",o),r.removeListener("end",s),r.removeListener("close",h),r.removeListener("error",u),t.removeListener("error",u),r.removeListener("end",l),r.removeListener("close",l),t.removeListener("close",l)}return r.on("error",u),t.on("error",u),r.on("end",l),r.on("close",l),t.on("close",l),t.emit("pipe",r),t}},function(t,e){e.read=function(t,e,r,n,i){var o,a,s=8*i-n-1,h=(1<<s)-1,u=h>>1,l=-7,c=r?i-1:0,f=r?-1:1,d=t[e+c];for(c+=f,o=d&(1<<-l)-1,d>>=-l,l+=s;l>0;o=256*o+t[e+c],c+=f,l-=8);for(a=o&(1<<-l)-1,o>>=-l,l+=n;l>0;a=256*a+t[e+c],c+=f,l-=8);if(0===o)o=1-u;else{if(o===h)return a?NaN:1/0*(d?-1:1);a+=Math.pow(2,n),o-=u}return(d?-1:1)*a*Math.pow(2,o-n)},e.write=function(t,e,r,n,i,o){var a,s,h,u=8*o-i-1,l=(1<<u)-1,c=l>>1,f=23===i?Math.pow(2,-24)-Math.pow(2,-77):0,d=n?0:o-1,p=n?1:-1,m=e<0||0===e&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(s=isNaN(e)?1:0,a=l):(a=Math.floor(Math.log(e)/Math.LN2),e*(h=Math.pow(2,-a))<1&&(a--,h*=2),(e+=a+c>=1?f/h:f*Math.pow(2,1-c))*h>=2&&(a++,h/=2),a+c>=l?(s=0,a=l):a+c>=1?(s=(e*h-1)*Math.pow(2,i),a+=c):(s=e*Math.pow(2,c-1)*Math.pow(2,i),a=0));i>=8;t[r+d]=255&s,d+=p,s/=256,i-=8);for(a=a<<i|s,u+=i;u>0;t[r+d]=255&a,d+=p,a/=256,u-=8);t[r+d-p]|=128*m}},function(t,e,r){"use strict";e.byteLength=function(t){return 3*t.length/4-u(t)},e.toByteArray=function(t){var e,r,n,a,s,h=t.length;a=u(t),s=new o(3*h/4-a),r=a>0?h-4:h;var l=0;for(e=0;e<r;e+=4)n=i[t.charCodeAt(e)]<<18|i[t.charCodeAt(e+1)]<<12|i[t.charCodeAt(e+2)]<<6|i[t.charCodeAt(e+3)],s[l++]=n>>16&255,s[l++]=n>>8&255,s[l++]=255&n;2===a?(n=i[t.charCodeAt(e)]<<2|i[t.charCodeAt(e+1)]>>4,s[l++]=255&n):1===a&&(n=i[t.charCodeAt(e)]<<10|i[t.charCodeAt(e+1)]<<4|i[t.charCodeAt(e+2)]>>2,s[l++]=n>>8&255,s[l++]=255&n);return s},e.fromByteArray=function(t){for(var e,r=t.length,i=r%3,o="",a=[],s=0,h=r-i;s<h;s+=16383)a.push(l(t,s,s+16383>h?h:s+16383));1===i?(e=t[r-1],o+=n[e>>2],o+=n[e<<4&63],o+="=="):2===i&&(e=(t[r-2]<<8)+t[r-1],o+=n[e>>10],o+=n[e>>4&63],o+=n[e<<2&63],o+="=");return a.push(o),a.join("")};for(var n=[],i=[],o="undefined"!=typeof Uint8Array?Uint8Array:Array,a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",s=0,h=a.length;s<h;++s)n[s]=a[s],i[a.charCodeAt(s)]=s;function u(t){var e=t.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");return"="===t[e-2]?2:"="===t[e-1]?1:0}function l(t,e,r){for(var i,o,a=[],s=e;s<r;s+=3)i=(t[s]<<16&16711680)+(t[s+1]<<8&65280)+(255&t[s+2]),a.push(n[(o=i)>>18&63]+n[o>>12&63]+n[o>>6&63]+n[63&o]);return a.join("")}i["-".charCodeAt(0)]=62,i["_".charCodeAt(0)]=63},function(t,e,r){"use strict";var n=r(9),i=r(1),o=r(2),a=r(44),s=r(43),h=r(20),u=r(88),l=r(87),c=r(14),f=r(75),d=function(t,e,r){var n,a=i.getTypeOf(e),l=i.extend(r||{},s);l.date=l.date||new Date,null!==l.compression&&(l.compression=l.compression.toUpperCase()),"string"==typeof l.unixPermissions&&(l.unixPermissions=parseInt(l.unixPermissions,8)),l.unixPermissions&&16384&l.unixPermissions&&(l.dir=!0),l.dosPermissions&&16&l.dosPermissions&&(l.dir=!0),l.dir&&(t=m(t)),l.createFolders&&(n=p(t))&&g.call(this,n,!0);var d="string"===a&&!1===l.binary&&!1===l.base64;r&&void 0!==r.binary||(l.binary=!d),(e instanceof h&&0===e.uncompressedSize||l.dir||!e||0===e.length)&&(l.base64=!1,l.binary=!0,e="",l.compression="STORE",a="string");var _=null;_=e instanceof h||e instanceof o?e:c.isNode&&c.isStream(e)?new f(t,e):i.prepareContent(t,e,l.binary,l.optimizedBinaryString,l.base64);var y=new u(t,_,l);this.files[t]=y},p=function(t){"/"===t.slice(-1)&&(t=t.substring(0,t.length-1));var e=t.lastIndexOf("/");return e>0?t.substring(0,e):""},m=function(t){return"/"!==t.slice(-1)&&(t+="/"),t},g=function(t,e){return e=void 0!==e?e:s.createFolders,t=m(t),this.files[t]||d.call(this,t,null,{dir:!0,createFolders:e}),this.files[t]};function _(t){return"[object RegExp]"===Object.prototype.toString.call(t)}var y={load:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},forEach:function(t){var e,r,n;for(e in this.files)this.files.hasOwnProperty(e)&&(n=this.files[e],(r=e.slice(this.root.length,e.length))&&e.slice(0,this.root.length)===this.root&&t(r,n))},filter:function(t){var e=[];return this.forEach(function(r,n){t(r,n)&&e.push(n)}),e},file:function(t,e,r){if(1===arguments.length){if(_(t)){var n=t;return this.filter(function(t,e){return!e.dir&&n.test(t)})}var i=this.files[this.root+t];return i&&!i.dir?i:null}return t=this.root+t,d.call(this,t,e,r),this},folder:function(t){if(!t)return this;if(_(t))return this.filter(function(e,r){return r.dir&&t.test(e)});var e=this.root+t,r=g.call(this,e),n=this.clone();return n.root=r.name,n},remove:function(t){t=this.root+t;var e=this.files[t];if(e||("/"!==t.slice(-1)&&(t+="/"),e=this.files[t]),e&&!e.dir)delete this.files[t];else for(var r=this.filter(function(e,r){return r.name.slice(0,t.length)===t}),n=0;n<r.length;n++)delete this.files[r[n].name];return this},generate:function(t){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},generateInternalStream:function(t){var e,r={};try{if((r=i.extend(t||{},{streamFiles:!1,compression:"STORE",compressionOptions:null,type:"",platform:"DOS",comment:null,mimeType:"application/zip",encodeFileName:n.utf8encode})).type=r.type.toLowerCase(),r.compression=r.compression.toUpperCase(),"binarystring"===r.type&&(r.type="string"),!r.type)throw new Error("No output type specified.");i.checkSupport(r.type),"darwin"!==r.platform&&"freebsd"!==r.platform&&"linux"!==r.platform&&"sunos"!==r.platform||(r.platform="UNIX"),"win32"===r.platform&&(r.platform="DOS");var s=r.comment||this.comment||"";e=l.generateWorker(this,r,s)}catch(t){(e=new o("error")).error(t)}return new a(e,r.type||"string",r.mimeType)},generateAsync:function(t,e){return this.generateInternalStream(t).accumulate(e)},generateNodeStream:function(t,e){return(t=t||{}).type||(t.type="nodebuffer"),this.generateInternalStream(t).toNodejsStream(e)}};t.exports=y},function(t,e){var r=1e3,n=60*r,i=60*n,o=24*i,a=365.25*o;function s(t,e,r){if(!(t<e))return t<1.5*e?Math.floor(t/e)+" "+r:Math.ceil(t/e)+" "+r+"s"}t.exports=function(t,e){e=e||{};var h,u=typeof t;if("string"===u&&t.length>0)return function(t){if((t=String(t)).length>100)return;var e=/^((?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|years?|yrs?|y)?$/i.exec(t);if(!e)return;var s=parseFloat(e[1]);switch((e[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return s*a;case"days":case"day":case"d":return s*o;case"hours":case"hour":case"hrs":case"hr":case"h":return s*i;case"minutes":case"minute":case"mins":case"min":case"m":return s*n;case"seconds":case"second":case"secs":case"sec":case"s":return s*r;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return s;default:return}}(t);if("number"===u&&!1===isNaN(t))return e.long?s(h=t,o,"day")||s(h,i,"hour")||s(h,n,"minute")||s(h,r,"second")||h+" ms":function(t){if(t>=o)return Math.round(t/o)+"d";if(t>=i)return Math.round(t/i)+"h";if(t>=n)return Math.round(t/n)+"m";if(t>=r)return Math.round(t/r)+"s";return t+"ms"}(t);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(t))}},function(t,e,r){function n(t){var r;function n(){if(n.enabled){var t=n,i=+new Date,o=i-(r||i);t.diff=o,t.prev=r,t.curr=i,r=i;for(var a=new Array(arguments.length),s=0;s<a.length;s++)a[s]=arguments[s];a[0]=e.coerce(a[0]),"string"!=typeof a[0]&&a.unshift("%O");var h=0;a[0]=a[0].replace(/%([a-zA-Z%])/g,function(r,n){if("%%"===r)return r;h++;var i=e.formatters[n];if("function"==typeof i){var o=a[h];r=i.call(t,o),a.splice(h,1),h--}return r}),e.formatArgs.call(t,a),(n.log||e.log||console.log.bind(console)).apply(t,a)}}return n.namespace=t,n.enabled=e.enabled(t),n.useColors=e.useColors(),n.color=function(t){var r,n=0;for(r in t)n=(n<<5)-n+t.charCodeAt(r),n|=0;return e.colors[Math.abs(n)%e.colors.length]}(t),n.destroy=i,"function"==typeof e.init&&e.init(n),e.instances.push(n),n}function i(){var t=e.instances.indexOf(this);return-1!==t&&(e.instances.splice(t,1),!0)}(e=t.exports=n.debug=n.default=n).coerce=function(t){return t instanceof Error?t.stack||t.message:t},e.disable=function(){e.enable("")},e.enable=function(t){var r;e.save(t),e.names=[],e.skips=[];var n=("string"==typeof t?t:"").split(/[\s,]+/),i=n.length;for(r=0;r<i;r++)n[r]&&("-"===(t=n[r].replace(/\*/g,".*?"))[0]?e.skips.push(new RegExp("^"+t.substr(1)+"$")):e.names.push(new RegExp("^"+t+"$")));for(r=0;r<e.instances.length;r++){var o=e.instances[r];o.enabled=e.enabled(o.namespace)}},e.enabled=function(t){if("*"===t[t.length-1])return!0;var r,n;for(r=0,n=e.skips.length;r<n;r++)if(e.skips[r].test(t))return!1;for(r=0,n=e.names.length;r<n;r++)if(e.names[r].test(t))return!0;return!1},e.humanize=r(121),e.instances=[],e.names=[],e.skips=[],e.formatters={}},function(t,e){t.exports=function(t,e){var r=e[0]-t[0],n=e[1]-t[1],i=e[2]-t[2];return r*r+n*n+i*i}},function(t,e){t.exports=function(t,e){var r=e[0]-t[0],n=e[1]-t[1],i=e[2]-t[2];return Math.sqrt(r*r+n*n+i*i)}},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,r,n){return r&&t(e.prototype,r),n&&t(e,n),e}}(),i=a(r(124)),o=a(r(123));function a(t){return t&&t.__esModule?t:{default:t}}var s=r(26)("halfedge"),h=function(){function t(e,r){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.vertex=e,this.face=r,this.next=null,this.prev=null,this.opposite=null}return n(t,[{key:"head",value:function(){return this.vertex}},{key:"tail",value:function(){return this.prev?this.prev.vertex:null}},{key:"length",value:function(){return this.tail()?(0,i.default)(this.tail().point,this.head().point):-1}},{key:"lengthSquared",value:function(){return this.tail()?(0,o.default)(this.tail().point,this.head().point):-1}},{key:"setOpposite",value:function(t){s.enabled&&s("opposite "+this.tail().index+" <--\x3e "+this.head().index+" between "+this.face.collectIndices()+", "+t.face.collectIndices()),this.opposite=t,t.opposite=this}}]),t}();e.default=h,t.exports=e.default},function(t,e){t.exports=function(t,e,r,n){return t[0]=e[0]+r[0]*n,t[1]=e[1]+r[1]*n,t[2]=e[2]+r[2]*n,t}},function(t,e){t.exports=function(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t}},function(t,e){t.exports=function(t){var e=t[0],r=t[1],n=t[2];return Math.sqrt(e*e+r*r+n*n)}},function(t,e){t.exports=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}},function(t,e){t.exports=function(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t}},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.DELETED=e.NON_CONVEX=e.VISIBLE=void 0;var n=function(){function t(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,r,n){return r&&t(e.prototype,r),n&&t(e,n),e}}(),i=p(r(58)),o=p(r(130)),a=p(r(28)),s=p(r(27)),h=p(r(129)),u=p(r(128)),l=p(r(127)),c=p(r(126)),f=p(r(59)),d=p(r(125));function p(t){return t&&t.__esModule?t:{default:t}}var m=r(26)("face"),g=e.VISIBLE=0,_=(e.NON_CONVEX=1,e.DELETED=2),y=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.normal=[],this.centroid=[],this.offset=0,this.outside=null,this.mark=g,this.edge=null,this.nVertices=0}return n(t,[{key:"getEdge",value:function(t){if("number"!=typeof t)throw Error("requires a number");for(var e=this.edge;t>0;)e=e.next,t-=1;for(;t<0;)e=e.prev,t+=1;return e}},{key:"computeNormal",value:function(){var t=this.edge,e=t.next,r=e.next,n=(0,a.default)([],e.head().point,t.head().point),i=[],c=[];for(this.nVertices=2,this.normal=[0,0,0];r!==t;)(0,h.default)(c,n),(0,a.default)(n,r.head().point,t.head().point),(0,o.default)(this.normal,this.normal,(0,s.default)(i,c,n)),r=r.next,this.nVertices+=1;this.area=(0,u.default)(this.normal),this.normal=(0,l.default)(this.normal,this.normal,1/this.area)}},{key:"computeNormalMinArea",value:function(t){if(this.computeNormal(),this.area<t){var e=void 0,r=0,n=this.edge;do{var o=n.lengthSquared();o>r&&(e=n,r=o),n=n.next}while(n!==this.edge);var s=e.tail().point,h=e.head().point,u=(0,a.default)([],h,s),d=Math.sqrt(r);(0,l.default)(u,u,1/d);var p=(0,i.default)(this.normal,u);(0,c.default)(this.normal,this.normal,u,-p),(0,f.default)(this.normal,this.normal)}}},{key:"computeCentroid",value:function(){this.centroid=[0,0,0];var t=this.edge;do{(0,o.default)(this.centroid,this.centroid,t.head().point),t=t.next}while(t!==this.edge);(0,l.default)(this.centroid,this.centroid,1/this.nVertices)}},{key:"computeNormalAndCentroid",value:function(t){void 0!==t?this.computeNormalMinArea(t):this.computeNormal(),this.computeCentroid(),this.offset=(0,i.default)(this.normal,this.centroid)}},{key:"distanceToPlane",value:function(t){return(0,i.default)(this.normal,t)-this.offset}},{key:"connectHalfEdges",value:function(t,e){var r=void 0;if(t.opposite.face===e.opposite.face){var n=e.opposite.face,i=void 0;t===this.edge&&(this.edge=e),3===n.nVertices?(i=e.opposite.prev.opposite,n.mark=_,r=n):(i=e.opposite.next,n.edge===i.prev&&(n.edge=i),i.prev=i.prev.prev,i.prev.next=i),e.prev=t.prev,e.prev.next=e,e.setOpposite(i),n.computeNormalAndCentroid()}else t.next=e,e.prev=t;return r}},{key:"mergeAdjacentFaces",value:function(t,e){var r=t.opposite,n=r.face;e.push(n),n.mark=_;for(var i=t.prev,o=t.next,a=r.prev,s=r.next;i.opposite.face===n;)i=i.prev,s=s.next;for(;o.opposite.face===n;)o=o.next,a=a.prev;var h=void 0;for(h=s;h!==a.next;h=h.next)h.face=this;this.edge=o;var u=void 0;return(u=this.connectHalfEdges(a,o))&&e.push(u),(u=this.connectHalfEdges(i,s))&&e.push(u),this.computeNormalAndCentroid(),e}},{key:"collectIndices",value:function(){var t=[],e=this.edge;do{t.push(e.head().index),e=e.next}while(e!==this.edge);return t}}],[{key:"createTriangle",value:function(e,r,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,o=new t,a=new d.default(e,o),s=new d.default(r,o),h=new d.default(n,o);return a.next=h.prev=s,s.next=a.prev=h,h.next=s.prev=a,o.edge=a,o.computeNormalAndCentroid(i),m.enabled&&m("face created %j",o.collectIndices()),o}}]),t}();e.default=y},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});e.default=function t(e,r){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.point=e,this.index=r,this.next=null,this.prev=null,this.face=null},t.exports=e.default},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,r,n){return r&&t(e.prototype,r),n&&t(e,n),e}}();var i=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.head=null,this.tail=null}return n(t,[{key:"clear",value:function(){this.head=this.tail=null}},{key:"insertBefore",value:function(t,e){e.prev=t.prev,e.next=t,e.prev?e.prev.next=e:this.head=e,t.prev=e}},{key:"insertAfter",value:function(t,e){e.prev=t,e.next=t.next,e.next?e.next.prev=e:this.tail=e,t.next=e}},{key:"add",value:function(t){this.head?this.tail.next=t:this.head=t,t.prev=this.tail,t.next=null,this.tail=t}},{key:"addAll",value:function(t){for(this.head?this.tail.next=t:this.head=t,t.prev=this.tail;t.next;)t=t.next;this.tail=t}},{key:"remove",value:function(t){t.prev?t.prev.next=t.next:this.head=t.next,t.next?t.next.prev=t.prev:this.tail=t.prev}},{key:"removeChain",value:function(t,e){t.prev?t.prev.next=e.next:this.head=e.next,e.next?e.next.prev=t.prev:this.tail=t.prev}},{key:"first",value:function(){return this.head}},{key:"isEmpty",value:function(){return!this.head}}]),t}();e.default=i,t.exports=e.default},function(t,e,r){var n=r(59),i=r(28),o=r(27),a=[0,0,0];t.exports=function(t,e,r,s){return i(t,e,r),i(a,r,s),o(t,t,a),n(t,t)}},function(t,e){t.exports=function(t){var e=t[0],r=t[1],n=t[2];return e*e+r*r+n*n}},function(t,e,r){var n=r(28),i=r(27),o=r(135),a=[],s=[],h=[];t.exports=function(t,e,r){n(a,r,e),n(s,t,e);var u=o(i(h,s,a)),l=o(a);if(0===l)throw Error("a and b are the same point");return u/l}},function(t,e,r){"use strict";var n=r(136);t.exports=function(t,e,r){return Math.sqrt(n(t,e,r))}},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=function(){return function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var r=[],n=!0,i=!1,o=void 0;try{for(var a,s=t[Symbol.iterator]();!(n=(a=s.next()).done)&&(r.push(a.value),!e||r.length!==e);n=!0);}catch(t){i=!0,o=t}finally{try{!n&&s.return&&s.return()}finally{if(i)throw o}}return r}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),i=function(){function t(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,r,n){return r&&t(e.prototype,r),n&&t(e,n),e}}(),o=f(r(137)),a=f(r(134)),s=f(r(58)),h=f(r(133)),u=f(r(132)),l=r(131),c=f(l);function f(t){return t&&t.__esModule?t:{default:t}}var d=r(26)("quickhull"),p=function(){function t(e){if(function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),!Array.isArray(e))throw TypeError("input is not a valid array");if(e.length<4)throw Error("cannot build a simplex out of <4 points");this.tolerance=-1,this.nFaces=0,this.nPoints=e.length,this.faces=[],this.newFaces=[],this.claimed=new h.default,this.unclaimed=new h.default,this.vertices=[];for(var r=0;r<e.length;r+=1)this.vertices.push(new u.default(e[r],r));this.discardedFaces=[],this.vertexPointIndices=[]}return i(t,[{key:"addVertexToFace",value:function(t,e){t.face=e,e.outside?this.claimed.insertBefore(e.outside,t):this.claimed.add(t),e.outside=t}},{key:"removeVertexFromFace",value:function(t,e){t===e.outside&&(t.next&&t.next.face===e?e.outside=t.next:e.outside=null),this.claimed.remove(t)}},{key:"removeAllVerticesFromFace",value:function(t){if(t.outside){for(var e=t.outside;e.next&&e.next.face===t;)e=e.next;return this.claimed.removeChain(t.outside,e),e.next=null,t.outside}}},{key:"deleteFaceVertices",value:function(t,e){var r=this.removeAllVerticesFromFace(t);if(r)if(e)for(var n=void 0,i=r;i;i=n){n=i.next,e.distanceToPlane(i.point)>this.tolerance?this.addVertexToFace(i,e):this.unclaimed.add(i)}else this.unclaimed.addAll(r)}},{key:"resolveUnclaimedPoints",value:function(t){for(var e=this.unclaimed.first(),r=e;r;r=e){e=r.next;for(var n=this.tolerance,i=void 0,o=0;o<t.length;o+=1){var a=t[o];if(a.mark===l.VISIBLE){var s=a.distanceToPlane(r.point);if(s>n&&(n=s,i=a),n>1e3*this.tolerance)break}}i&&this.addVertexToFace(r,i)}}},{key:"computeExtremes",value:function(){var t=[],e=[],r=[],n=[],i=void 0,o=void 0;for(i=0;i<3;i+=1)r[i]=n[i]=this.vertices[0];for(i=0;i<3;i+=1)t[i]=e[i]=this.vertices[0].point[i];for(i=1;i<this.vertices.length;i+=1){var a=this.vertices[i],s=a.point;for(o=0;o<3;o+=1)s[o]<t[o]&&(t[o]=s[o],r[o]=a);for(o=0;o<3;o+=1)s[o]>e[o]&&(e[o]=s[o],n[o]=a)}return this.tolerance=3*Number.EPSILON*(Math.max(Math.abs(t[0]),Math.abs(e[0]))+Math.max(Math.abs(t[1]),Math.abs(e[1]))+Math.max(Math.abs(t[2]),Math.abs(e[2]))),d.enabled&&d("tolerance %d",this.tolerance),[r,n]}},{key:"createInitialSimplex",value:function(){var t,e,r=this.vertices,i=this.computeExtremes(),h=n(i,2),u=h[0],l=h[1],f=void 0,d=void 0,p=void 0,m=void 0,g=0,_=0;for(p=0;p<3;p+=1){var y=l[p].point[p]-u[p].point[p];y>g&&(g=y,_=p)}for(t=u[_],e=l[_],g=0,p=0;p<this.vertices.length;p+=1){var v=this.vertices[p];if(v!==t&&v!==e){var x=(0,o.default)(v.point,t.point,e.point);x>g&&(g=x,f=v)}}var b=(0,a.default)([],t.point,e.point,f.point),w=(0,s.default)(t.point,b);for(g=-1,p=0;p<this.vertices.length;p+=1){var T=this.vertices[p];if(T!==t&&T!==e&&T!==f){var E=Math.abs((0,s.default)(b,T.point)-w);E>g&&(g=E,d=T)}}var C=[];if((0,s.default)(d.point,b)-w<0)for(C.push(c.default.createTriangle(t,e,f),c.default.createTriangle(d,e,t),c.default.createTriangle(d,f,e),c.default.createTriangle(d,t,f)),p=0;p<3;p+=1){var S=(p+1)%3;C[p+1].getEdge(2).setOpposite(C[0].getEdge(S)),C[p+1].getEdge(1).setOpposite(C[S+1].getEdge(0))}else for(C.push(c.default.createTriangle(t,f,e),c.default.createTriangle(d,t,e),c.default.createTriangle(d,e,f),c.default.createTriangle(d,f,t)),p=0;p<3;p+=1){var A=(p+1)%3;C[p+1].getEdge(2).setOpposite(C[0].getEdge((3-p)%3)),C[p+1].getEdge(0).setOpposite(C[A+1].getEdge(1))}for(p=0;p<4;p+=1)this.faces.push(C[p]);for(p=0;p<r.length;p+=1){var M=r[p];if(M!==t&&M!==e&&M!==f&&M!==d){g=this.tolerance;var P=void 0;for(m=0;m<4;m+=1){var R=C[m].distanceToPlane(M.point);R>g&&(g=R,P=C[m])}P&&this.addVertexToFace(M,P)}}}},{key:"reindexFaceAndVertices",value:function(){for(var t=[],e=0;e<this.faces.length;e+=1){var r=this.faces[e];r.mark===l.VISIBLE&&t.push(r)}this.faces=t}},{key:"collectFaces",value:function(t){for(var e=[],r=0;r<this.faces.length;r+=1){if(this.faces[r].mark!==l.VISIBLE)throw Error("attempt to include a destroyed face in the hull");var n=this.faces[r].collectIndices();if(t)e.push(n);else for(var i=0;i<n.length-2;i+=1)e.push([n[0],n[i+1],n[i+2]])}return e}},{key:"nextVertexToAdd",value:function(){if(!this.claimed.isEmpty()){var t=void 0,e=void 0,r=0,n=this.claimed.first().face;for(e=n.outside;e&&e.face===n;e=e.next){var i=n.distanceToPlane(e.point);i>r&&(r=i,t=e)}return t}}},{key:"computeHorizon",value:function(t,e,r,n){this.deleteFaceVertices(r),r.mark=l.DELETED;var i=void 0;i=e?e.next:e=r.getEdge(0);do{var o=i.opposite,a=o.face;a.mark===l.VISIBLE&&(a.distanceToPlane(t)>this.tolerance?this.computeHorizon(t,o,a,n):n.push(i)),i=i.next}while(i!==e)}},{key:"addAdjoiningFace",value:function(t,e){var r=c.default.createTriangle(t,e.tail(),e.head());return this.faces.push(r),r.getEdge(-1).setOpposite(e.opposite),r.getEdge(0)}},{key:"addNewFaces",value:function(t,e){this.newFaces=[];for(var r=void 0,n=void 0,i=0;i<e.length;i+=1){var o=e[i],a=this.addAdjoiningFace(t,o);r?a.next.setOpposite(n):r=a,this.newFaces.push(a.face),n=a}r.next.setOpposite(n)}},{key:"oppositeFaceDistance",value:function(t){return t.face.distanceToPlane(t.opposite.face.centroid)}},{key:"doAdjacentMerge",value:function(t,e){var r=t.edge,n=!0,i=0;do{if(i>=t.nVertices)throw Error("merge recursion limit exceeded");var o=r.opposite.face,a=!1;if(2===e)(this.oppositeFaceDistance(r)>-this.tolerance||this.oppositeFaceDistance(r.opposite)>-this.tolerance)&&(a=!0);else if(t.area>o.area?this.oppositeFaceDistance(r)>-this.tolerance?a=!0:this.oppositeFaceDistance(r.opposite)>-this.tolerance&&(n=!1):this.oppositeFaceDistance(r.opposite)>-this.tolerance?a=!0:this.oppositeFaceDistance(r)>-this.tolerance&&(n=!1),a){d("face merge");for(var s=t.mergeAdjacentFaces(r,[]),h=0;h<s.length;h+=1)this.deleteFaceVertices(s[h],t);return!0}r=r.next,i+=1}while(r!==t.edge);return n||(t.mark=l.NON_CONVEX),!1}},{key:"addVertexToHull",value:function(t){var e=[];this.unclaimed.clear(),this.removeVertexFromFace(t,t.face),this.computeHorizon(t.point,null,t.face,e),d.enabled&&d("horizon %j",e.map(function(t){return t.head().index})),this.addNewFaces(t,e),d("first merge");for(var r=0;r<this.newFaces.length;r+=1){var n=this.newFaces[r];if(n.mark===l.VISIBLE)for(;this.doAdjacentMerge(n,1););}d("second merge");for(var i=0;i<this.newFaces.length;i+=1){var o=this.newFaces[i];if(o.mark===l.NON_CONVEX)for(o.mark=l.VISIBLE;this.doAdjacentMerge(o,2););}d("reassigning points to newFaces"),this.resolveUnclaimedPoints(this.newFaces)}},{key:"build",value:function(){var t=0,e=void 0;for(this.createInitialSimplex();e=this.nextVertexToAdd();)d("== iteration %j ==",t+=1),d("next vertex to add = %d %j",e.index,e.point),this.addVertexToHull(e),d("end");this.reindexFaceAndVertices()}}]),t}();e.default=p,t.exports=e.default},function(t,e){function r(t){var e=this;if(e instanceof r||(e=new r),e.tail=null,e.head=null,e.length=0,t&&"function"==typeof t.forEach)t.forEach(function(t){e.push(t)});else if(arguments.length>0)for(var n=0,i=arguments.length;n<i;n++)e.push(arguments[n]);return e}function n(t,e){t.tail=new o(e,t.tail,null,t),t.head||(t.head=t.tail),t.length++}function i(t,e){t.head=new o(e,null,t.head,t),t.tail||(t.tail=t.head),t.length++}function o(t,e,r,n){if(!(this instanceof o))return new o(t,e,r,n);this.list=n,this.value=t,e?(e.next=this,this.prev=e):this.prev=null,r?(r.prev=this,this.next=r):this.next=null}t.exports=r,r.Node=o,r.create=r,r.prototype.removeNode=function(t){if(t.list!==this)throw new Error("removing node which does not belong to this list");var e=t.next,r=t.prev;e&&(e.prev=r),r&&(r.next=e),t===this.head&&(this.head=e),t===this.tail&&(this.tail=r),t.list.length--,t.next=null,t.prev=null,t.list=null},r.prototype.unshiftNode=function(t){if(t!==this.head){t.list&&t.list.removeNode(t);var e=this.head;t.list=this,t.next=e,e&&(e.prev=t),this.head=t,this.tail||(this.tail=t),this.length++}},r.prototype.pushNode=function(t){if(t!==this.tail){t.list&&t.list.removeNode(t);var e=this.tail;t.list=this,t.prev=e,e&&(e.next=t),this.tail=t,this.head||(this.head=t),this.length++}},r.prototype.push=function(){for(var t=0,e=arguments.length;t<e;t++)n(this,arguments[t]);return this.length},r.prototype.unshift=function(){for(var t=0,e=arguments.length;t<e;t++)i(this,arguments[t]);return this.length},r.prototype.pop=function(){if(this.tail){var t=this.tail.value;return this.tail=this.tail.prev,this.tail?this.tail.next=null:this.head=null,this.length--,t}},r.prototype.shift=function(){if(this.head){var t=this.head.value;return this.head=this.head.next,this.head?this.head.prev=null:this.tail=null,this.length--,t}},r.prototype.forEach=function(t,e){e=e||this;for(var r=this.head,n=0;null!==r;n++)t.call(e,r.value,n,this),r=r.next},r.prototype.forEachReverse=function(t,e){e=e||this;for(var r=this.tail,n=this.length-1;null!==r;n--)t.call(e,r.value,n,this),r=r.prev},r.prototype.get=function(t){for(var e=0,r=this.head;null!==r&&e<t;e++)r=r.next;if(e===t&&null!==r)return r.value},r.prototype.getReverse=function(t){for(var e=0,r=this.tail;null!==r&&e<t;e++)r=r.prev;if(e===t&&null!==r)return r.value},r.prototype.map=function(t,e){e=e||this;for(var n=new r,i=this.head;null!==i;)n.push(t.call(e,i.value,this)),i=i.next;return n},r.prototype.mapReverse=function(t,e){e=e||this;for(var n=new r,i=this.tail;null!==i;)n.push(t.call(e,i.value,this)),i=i.prev;return n},r.prototype.reduce=function(t,e){var r,n=this.head;if(arguments.length>1)r=e;else{if(!this.head)throw new TypeError("Reduce of empty list with no initial value");n=this.head.next,r=this.head.value}for(var i=0;null!==n;i++)r=t(r,n.value,i),n=n.next;return r},r.prototype.reduceReverse=function(t,e){var r,n=this.tail;if(arguments.length>1)r=e;else{if(!this.tail)throw new TypeError("Reduce of empty list with no initial value");n=this.tail.prev,r=this.tail.value}for(var i=this.length-1;null!==n;i--)r=t(r,n.value,i),n=n.prev;return r},r.prototype.toArray=function(){for(var t=new Array(this.length),e=0,r=this.head;null!==r;e++)t[e]=r.value,r=r.next;return t},r.prototype.toArrayReverse=function(){for(var t=new Array(this.length),e=0,r=this.tail;null!==r;e++)t[e]=r.value,r=r.prev;return t},r.prototype.slice=function(t,e){(e=e||this.length)<0&&(e+=this.length),(t=t||0)<0&&(t+=this.length);var n=new r;if(e<t||e<0)return n;t<0&&(t=0),e>this.length&&(e=this.length);for(var i=0,o=this.head;null!==o&&i<t;i++)o=o.next;for(;null!==o&&i<e;i++,o=o.next)n.push(o.value);return n},r.prototype.sliceReverse=function(t,e){(e=e||this.length)<0&&(e+=this.length),(t=t||0)<0&&(t+=this.length);var n=new r;if(e<t||e<0)return n;t<0&&(t=0),e>this.length&&(e=this.length);for(var i=this.length,o=this.tail;null!==o&&i>e;i--)o=o.prev;for(;null!==o&&i>t;i--,o=o.prev)n.push(o.value);return n},r.prototype.reverse=function(){for(var t=this.head,e=this.tail,r=t;null!==r;r=r.prev){var n=r.prev;r.prev=r.next,r.next=n}return this.head=e,this.tail=t,this}},function(t,e){"function"==typeof Object.create?t.exports=function(t,e){t.super_=e,t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}})}:t.exports=function(t,e){t.super_=e;var r=function(){};r.prototype=e.prototype,t.prototype=new r,t.prototype.constructor=t}},function(t,e){t.exports=function(t){return t&&"object"==typeof t&&"function"==typeof t.copy&&"function"==typeof t.fill&&"function"==typeof t.readUInt8}},function(t,e,r){(function(t,n){var i=/%[sdj%]/g;e.format=function(t){if(!_(t)){for(var e=[],r=0;r<arguments.length;r++)e.push(s(arguments[r]));return e.join(" ")}r=1;for(var n=arguments,o=n.length,a=String(t).replace(i,function(t){if("%%"===t)return"%";if(r>=o)return t;switch(t){case"%s":return String(n[r++]);case"%d":return Number(n[r++]);case"%j":try{return JSON.stringify(n[r++])}catch(t){return"[Circular]"}default:return t}}),h=n[r];r<o;h=n[++r])m(h)||!x(h)?a+=" "+h:a+=" "+s(h);return a},e.deprecate=function(r,i){if(y(t.process))return function(){return e.deprecate(r,i).apply(this,arguments)};if(!0===n.noDeprecation)return r;var o=!1;return function(){if(!o){if(n.throwDeprecation)throw new Error(i);n.traceDeprecation?console.trace(i):console.error(i),o=!0}return r.apply(this,arguments)}};var o,a={};function s(t,r){var n={seen:[],stylize:u};return arguments.length>=3&&(n.depth=arguments[2]),arguments.length>=4&&(n.colors=arguments[3]),p(r)?n.showHidden=r:r&&e._extend(n,r),y(n.showHidden)&&(n.showHidden=!1),y(n.depth)&&(n.depth=2),y(n.colors)&&(n.colors=!1),y(n.customInspect)&&(n.customInspect=!0),n.colors&&(n.stylize=h),l(n,t,n.depth)}function h(t,e){var r=s.styles[e];return r?"["+s.colors[r][0]+"m"+t+"["+s.colors[r][1]+"m":t}function u(t,e){return t}function l(t,r,n){if(t.customInspect&&r&&T(r.inspect)&&r.inspect!==e.inspect&&(!r.constructor||r.constructor.prototype!==r)){var i=r.inspect(n,t);return _(i)||(i=l(t,i,n)),i}var o=function(t,e){if(y(e))return t.stylize("undefined","undefined");if(_(e)){var r="'"+JSON.stringify(e).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return t.stylize(r,"string")}if(g(e))return t.stylize(""+e,"number");if(p(e))return t.stylize(""+e,"boolean");if(m(e))return t.stylize("null","null")}(t,r);if(o)return o;var a=Object.keys(r),s=function(t){var e={};return t.forEach(function(t,r){e[t]=!0}),e}(a);if(t.showHidden&&(a=Object.getOwnPropertyNames(r)),w(r)&&(a.indexOf("message")>=0||a.indexOf("description")>=0))return c(r);if(0===a.length){if(T(r)){var h=r.name?": "+r.name:"";return t.stylize("[Function"+h+"]","special")}if(v(r))return t.stylize(RegExp.prototype.toString.call(r),"regexp");if(b(r))return t.stylize(Date.prototype.toString.call(r),"date");if(w(r))return c(r)}var u,x="",E=!1,C=["{","}"];(d(r)&&(E=!0,C=["[","]"]),T(r))&&(x=" [Function"+(r.name?": "+r.name:"")+"]");return v(r)&&(x=" "+RegExp.prototype.toString.call(r)),b(r)&&(x=" "+Date.prototype.toUTCString.call(r)),w(r)&&(x=" "+c(r)),0!==a.length||E&&0!=r.length?n<0?v(r)?t.stylize(RegExp.prototype.toString.call(r),"regexp"):t.stylize("[Object]","special"):(t.seen.push(r),u=E?function(t,e,r,n,i){for(var o=[],a=0,s=e.length;a<s;++a)A(e,String(a))?o.push(f(t,e,r,n,String(a),!0)):o.push("");return i.forEach(function(i){i.match(/^\d+$/)||o.push(f(t,e,r,n,i,!0))}),o}(t,r,n,s,a):a.map(function(e){return f(t,r,n,s,e,E)}),t.seen.pop(),function(t,e,r){if(t.reduce(function(t,e){return 0,e.indexOf("\n")>=0&&0,t+e.replace(/\u001b\[\d\d?m/g,"").length+1},0)>60)return r[0]+(""===e?"":e+"\n ")+" "+t.join(",\n  ")+" "+r[1];return r[0]+e+" "+t.join(", ")+" "+r[1]}(u,x,C)):C[0]+x+C[1]}function c(t){return"["+Error.prototype.toString.call(t)+"]"}function f(t,e,r,n,i,o){var a,s,h;if((h=Object.getOwnPropertyDescriptor(e,i)||{value:e[i]}).get?s=h.set?t.stylize("[Getter/Setter]","special"):t.stylize("[Getter]","special"):h.set&&(s=t.stylize("[Setter]","special")),A(n,i)||(a="["+i+"]"),s||(t.seen.indexOf(h.value)<0?(s=m(r)?l(t,h.value,null):l(t,h.value,r-1)).indexOf("\n")>-1&&(s=o?s.split("\n").map(function(t){return"  "+t}).join("\n").substr(2):"\n"+s.split("\n").map(function(t){return"   "+t}).join("\n")):s=t.stylize("[Circular]","special")),y(a)){if(o&&i.match(/^\d+$/))return s;(a=JSON.stringify(""+i)).match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(a=a.substr(1,a.length-2),a=t.stylize(a,"name")):(a=a.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),a=t.stylize(a,"string"))}return a+": "+s}function d(t){return Array.isArray(t)}function p(t){return"boolean"==typeof t}function m(t){return null===t}function g(t){return"number"==typeof t}function _(t){return"string"==typeof t}function y(t){return void 0===t}function v(t){return x(t)&&"[object RegExp]"===E(t)}function x(t){return"object"==typeof t&&null!==t}function b(t){return x(t)&&"[object Date]"===E(t)}function w(t){return x(t)&&("[object Error]"===E(t)||t instanceof Error)}function T(t){return"function"==typeof t}function E(t){return Object.prototype.toString.call(t)}function C(t){return t<10?"0"+t.toString(10):t.toString(10)}e.debuglog=function(t){if(y(o)&&(o=n.env.NODE_DEBUG||""),t=t.toUpperCase(),!a[t])if(new RegExp("\\b"+t+"\\b","i").test(o)){var r=n.pid;a[t]=function(){var n=e.format.apply(e,arguments);console.error("%s %d: %s",t,r,n)}}else a[t]=function(){};return a[t]},e.inspect=s,s.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},s.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"},e.isArray=d,e.isBoolean=p,e.isNull=m,e.isNullOrUndefined=function(t){return null==t},e.isNumber=g,e.isString=_,e.isSymbol=function(t){return"symbol"==typeof t},e.isUndefined=y,e.isRegExp=v,e.isObject=x,e.isDate=b,e.isError=w,e.isFunction=T,e.isPrimitive=function(t){return null===t||"boolean"==typeof t||"number"==typeof t||"string"==typeof t||"symbol"==typeof t||void 0===t},e.isBuffer=r(141);var S=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function A(t,e){return Object.prototype.hasOwnProperty.call(t,e)}e.log=function(){var t,r;console.log("%s - %s",(t=new Date,r=[C(t.getHours()),C(t.getMinutes()),C(t.getSeconds())].join(":"),[t.getDate(),S[t.getMonth()],r].join(" ")),e.format.apply(e,arguments))},e.inherits=r(140),e._extend=function(t,e){if(!e||!x(e))return t;for(var r=Object.keys(e),n=r.length;n--;)t[r[n]]=e[r[n]];return t}}).call(this,r(3),r(6))},function(t,e){var r=Object.prototype.hasOwnProperty;function n(t){if(!(this instanceof n))throw new TypeError("Constructor PseudoMap requires 'new'");if(this.clear(),t)if(t instanceof n||"function"==typeof Map&&t instanceof Map)t.forEach(function(t,e){this.set(e,t)},this);else{if(!Array.isArray(t))throw new TypeError("invalid argument");t.forEach(function(t){this.set(t[0],t[1])},this)}}function i(t,e){return t===e||t!=t&&e!=e}function o(t,e){for(var n=0,o="_"+e,a=o;r.call(t,a);a=o+n++)if(i(t[a].key,e))return t[a]}t.exports=n,n.prototype.forEach=function(t,e){e=e||this,Object.keys(this._data).forEach(function(r){"size"!==r&&t.call(e,this._data[r].value,this._data[r].key)},this)},n.prototype.has=function(t){return!!o(this._data,t)},n.prototype.get=function(t){var e=o(this._data,t);return e&&e.value},n.prototype.set=function(t,e){!function(t,e,n){for(var o=0,a="_"+e,s=a;r.call(t,s);s=a+o++)if(i(t[s].key,e))return void(t[s].value=n);t.size++,t[s]=new function(t,e,r){this.key=t,this.value=e,this._index=r}(e,n,s)}(this._data,t,e)},n.prototype.delete=function(t){var e=o(this._data,t);e&&(delete this._data[e._index],this._data.size--)},n.prototype.clear=function(){var t=Object.create(null);t.size=0,Object.defineProperty(this,"_data",{value:t,enumerable:!1,configurable:!0,writable:!1})},Object.defineProperty(n.prototype,"size",{get:function(){return this._data.size},set:function(t){},enumerable:!0,configurable:!0}),n.prototype.values=n.prototype.keys=n.prototype.entries=function(){throw new Error("iterators are not implemented in this version")}},function(t,e,r){(function(e){"pseudomap"===e.env.npm_package_name&&"test"===e.env.npm_lifecycle_script&&(e.env.TEST_PSEUDOMAP="true"),"function"!=typeof Map||e.env.TEST_PSEUDOMAP?t.exports=r(143):t.exports=Map}).call(this,r(6))},function(t,e,r){"use strict";r.r(e),e.default="1.2.3"},function(t,e,r){"use strict";r.r(e);var n=r(null).a.extend({dynamic:!1});e.default=n},function(t,e){e.read=function(t,e,r,n,i){var o,a,s=8*i-n-1,h=(1<<s)-1,u=h>>1,l=-7,c=r?i-1:0,f=r?-1:1,d=t[e+c];for(c+=f,o=d&(1<<-l)-1,d>>=-l,l+=s;l>0;o=256*o+t[e+c],c+=f,l-=8);for(a=o&(1<<-l)-1,o>>=-l,l+=n;l>0;a=256*a+t[e+c],c+=f,l-=8);if(0===o)o=1-u;else{if(o===h)return a?NaN:1/0*(d?-1:1);a+=Math.pow(2,n),o-=u}return(d?-1:1)*a*Math.pow(2,o-n)},e.write=function(t,e,r,n,i,o){var a,s,h,u=8*o-i-1,l=(1<<u)-1,c=l>>1,f=23===i?Math.pow(2,-24)-Math.pow(2,-77):0,d=n?0:o-1,p=n?1:-1,m=e<0||0===e&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(s=isNaN(e)?1:0,a=l):(a=Math.floor(Math.log(e)/Math.LN2),e*(h=Math.pow(2,-a))<1&&(a--,h*=2),(e+=a+c>=1?f/h:f*Math.pow(2,1-c))*h>=2&&(a++,h/=2),a+c>=l?(s=0,a=l):a+c>=1?(s=(e*h-1)*Math.pow(2,i),a+=c):(s=e*Math.pow(2,c-1)*Math.pow(2,i),a=0));i>=8;t[r+d]=255&s,d+=p,s/=256,i-=8);for(a=a<<i|s,u+=i;u>0;t[r+d]=255&a,d+=p,a/=256,u-=8);t[r+d-p]|=128*m}},function(t,e,r){"use strict";function n(t,e){this.x=t,this.y=e}t.exports=n,n.prototype={clone:function(){return new n(this.x,this.y)},add:function(t){return this.clone()._add(t)},sub:function(t){return this.clone()._sub(t)},multByPoint:function(t){return this.clone()._multByPoint(t)},divByPoint:function(t){return this.clone()._divByPoint(t)},mult:function(t){return this.clone()._mult(t)},div:function(t){return this.clone()._div(t)},rotate:function(t){return this.clone()._rotate(t)},rotateAround:function(t,e){return this.clone()._rotateAround(t,e)},matMult:function(t){return this.clone()._matMult(t)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(t){return this.x===t.x&&this.y===t.y},dist:function(t){return Math.sqrt(this.distSqr(t))},distSqr:function(t){var e=t.x-this.x,r=t.y-this.y;return e*e+r*r},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(t){return Math.atan2(this.y-t.y,this.x-t.x)},angleWith:function(t){return this.angleWithSep(t.x,t.y)},angleWithSep:function(t,e){return Math.atan2(this.x*e-this.y*t,this.x*t+this.y*e)},_matMult:function(t){var e=t[0]*this.x+t[1]*this.y,r=t[2]*this.x+t[3]*this.y;return this.x=e,this.y=r,this},_add:function(t){return this.x+=t.x,this.y+=t.y,this},_sub:function(t){return this.x-=t.x,this.y-=t.y,this},_mult:function(t){return this.x*=t,this.y*=t,this},_div:function(t){return this.x/=t,this.y/=t,this},_multByPoint:function(t){return this.x*=t.x,this.y*=t.y,this},_divByPoint:function(t){return this.x/=t.x,this.y/=t.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var t=this.y;return this.y=this.x,this.x=-t,this},_rotate:function(t){var e=Math.cos(t),r=Math.sin(t),n=e*this.x-r*this.y,i=r*this.x+e*this.y;return this.x=n,this.y=i,this},_rotateAround:function(t,e){var r=Math.cos(t),n=Math.sin(t),i=e.x+r*(this.x-e.x)-n*(this.y-e.y),o=e.y+n*(this.x-e.x)+r*(this.y-e.y);return this.x=i,this.y=o,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},n.convert=function(t){return t instanceof n?t:Array.isArray(t)?new n(t[0],t[1]):t}},function(t,e,r){"use strict";var n=r(61);function i(t,e,r){if(3===t){var i=new n(r,r.readVarint()+r.pos);i.length&&(e[i.name]=i)}}t.exports=function(t,e){this.layers=t.readFields(i,{},e)}}]);
//# sourceMappingURL=bundle.js.map